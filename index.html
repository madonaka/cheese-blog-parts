<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Cheese Quiz Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS -->
  <link rel="stylesheet" href="./admin/admin.css" />  
</head>
<body>
  <div class="admin-shell">
    <!-- 상단 헤더 -->
    <header class="admin-header">
      <div class="admin-logo">
        Cheese Quiz Admin
        <span>퀴즈·DB 관리용 관리자 페이지</span>
      </div>
      <div class="admin-badge">
        v0.1 · frontend only
      </div>
    </header>

    <div class="admin-main">
      <!-- 좌측 네비게이션 -->
      <aside class="admin-nav">
        <div class="admin-nav-group-title">메뉴</div>
        <ul class="admin-nav-list">
          <li class="admin-nav-item">
            <button
              class="admin-nav-button active"
              data-target="dashboard"
            >
              <span class="icon">📊</span>
              <span>대시보드</span>
            </button>
          </li>
          <li class="admin-nav-item">
            <button
              class="admin-nav-button"
              data-target="quizzes"
            >
              <span class="icon">📝</span>
              <span>퀴즈 세트 관리</span>
            </button>
          </li>
          <li class="admin-nav-item">
            <button
              class="admin-nav-button"
              data-target="tools"
            >
              <span class="icon">🧩</span>
              <span>도구 · 설정</span>
            </button>
          </li>
        </ul>
      </aside>

      <!-- 오른쪽 컨텐츠 영역 -->
      <main>
        <!-- 1) 대시보드 -->
        <section
          id="section-dashboard"
          class="admin-section active"
          data-section="dashboard"
        >
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">요약</div>
                <div class="card-subtitle">
                  구글 시트에서 불러온 퀴즈 세트 통계와 최근 기록을 한눈에 보는 화면
                </div>
              </div>
              <button class="btn btn-primary" id="btn-refresh-all">
                🔄 전체 새로고침
              </button>
            </div>

            <div class="dashboard-grid" id="dashboard-stats">
              <!-- JS에서 채워 넣음 -->
            </div>
            <div class="small-help">
              ※ 지금은 더미 데이터 기준으로 표시되고 있음.  
              Apps Script 웹앱 연결 후, 실제 시험 통계로 바꿀 예정.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">최근 등록된 examKey</div>
                <div class="card-subtitle">
                  자주 사용하는 연습문제 세트만 간단히 확인
                </div>
              </div>
              <button
                class="btn btn-ghost"
                data-target="quizzes"
                data-jump-nav
              >
                ➜ 퀴즈 세트 관리로 이동
              </button>
            </div>

            <div class="table-wrapper">
              <table class="admin-table" id="dashboard-recent-table">
                <thead>
                  <tr>
                    <th>examKey</th>
                    <th>제목</th>
                    <th>분류</th>
                    <th>문항 수</th>
                    <th>최근 수정</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS에서 채움 -->
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 2) 퀴즈 세트 관리 -->
        <section
          id="section-quizzes"
          class="admin-section"
          data-section="quizzes"
        >
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">퀴즈 세트 목록</div>
                <div class="card-subtitle">
                  구글 시트에 있는 examKey / 제목 / 시트 탭 등을 한눈에 관리
                </div>
              </div>
              <button class="btn btn-primary" id="btn-reload-quizzes">
                🔄 목록 새로고침
              </button>
            </div>

            <div class="field-row">
              <div class="field">
                <label for="filter-period">시대 / 카테고리 필터</label>
                <select id="filter-period">
                  <option value="">전체</option>
                  <option value="한국사-통사">한국사 통사</option>
                  <option value="한국사-근현대">한국사 근현대</option>
                  <option value="일본사">일본사</option>
                  <!-- 필요하면 여기 계속 추가 -->
                </select>
              </div>
              <div class="field">
                <label for="filter-search">검색 (examKey / 제목)</label>
                <input
                  type="text"
                  id="filter-search"
                  placeholder="예: khs-era-01 / 시대 순서"
                />
              </div>
            </div>

            <div class="table-wrapper">
              <table class="admin-table" id="quiz-table">
                <thead>
                  <tr>
                    <th style="min-width: 120px;">examKey</th>
                    <th style="min-width: 180px;">제목</th>
                    <th>시대·분류</th>
                    <th>출제 개수</th>
                    <th>시트 탭 이름</th>
                    <th>비고</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS에서 렌더링 -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">선택한 examKey 빠른 복붙용</div>
                <div class="card-subtitle">
                  블로그 포스트용 `.cheese-quiz` HTML 코드를 바로 복사해서 사용
                </div>
              </div>
              <button class="btn" id="btn-copy-snippet">
                📋 코드 복사
              </button>
            </div>

            <div class="field">
              <label for="snippet-output">삽입용 HTML 코드</label>
              <textarea
                id="snippet-output"
                spellcheck="false"
              ></textarea>
              <div class="small-help">
                시험 세트 행을 클릭하면 위 코드가 자동으로 갱신됨.  
                필요에 따라 `data-limit`, `data-period` 속성을 수정해서 사용.
              </div>
            </div>
          </div>
        </section>

        <!-- 3) 도구/설정 화면 -->
        <section
          id="section-tools"
          class="admin-section"
          data-section="tools"
        >
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">연결 정보</div>
                <div class="card-subtitle">
                  Apps Script 웹앱 / 스프레드시트 ID 등 관리자용 메모 공간
                </div>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label>퀴즈 조회용 Apps Script URL</label>
                <input
                  type="text"
                  id="config-api-base"
                  placeholder="https://script.google.com/macros/s/XXXXX/exec"
                />
                <div class="small-help">
                  실제로는 코드 안의 <code>CHEESE_ADMIN_API_BASE</code> 상수와
                  일치해야 함.  
                  <br />여기는 메모/참고용 입력 필드.
                </div>
              </div>
            </div>

            <p class="danger-text">
              ※ 이 페이지는 순수 프론트엔드이기 때문에,
              <strong>시트 수정/삭제 같은 기능은 현재 포함되어 있지 않음</strong>.  
              수정/삭제는 스프레드시트 자체에서 하거나,  
              나중에 별도 보호된 웹앱(인증 포함)을 만든 뒤 연결하는 편이 안전함.
            </p>
          </div>
        </section>
        <section class="admin-section" data-section="tools">
  <h2 class="admin-section-title">도구 · 설정</h2>

  <div class="admin-card">
    <div class="admin-card-header">
      <h3 class="admin-card-title">퀴즈 API 테스트</h3>
      <p class="admin-card-desc">
        Apps Script 웹앱 URL과 파라미터를 넣고 실제로 어떤 JSON이 나오는지 확인하는 도구입니다.
      </p>
    </div>

    <form id="quiz-test-form" class="admin-form-grid">
      <label class="admin-field">
        <span class="admin-label">API URL</span>
        <input
          id="quiz-api-url"
          type="text"
          class="admin-input"
          value="https://script.google.com/macros/s/AKfycbwuvooqtlk6c_Nv2_VgforohP5twqTLWGu5j8uf56D3qvKsUnioAhfbkNdTKIsQaaQF/exec"
        />
      </label>

      <label class="admin-field">
        <span class="admin-label">limit</span>
        <input
          id="quiz-limit"
          type="number"
          class="admin-input"
          value="5"
          min="1"
          max="50"
        />
      </label>

      <label class="admin-field">
        <span class="admin-label">period</span>
        <input
          id="quiz-period"
          type="text"
          class="admin-input"
          placeholder="예: 한국사-통사"
        />
      </label>

      <label class="admin-field">
        <span class="admin-label">topic</span>
        <input
          id="quiz-topic"
          type="text"
          class="admin-input"
          placeholder="예: 시대순서"
        />
      </label>

      <div class="admin-field admin-field-full">
        <button type="submit" class="admin-button primary">
          테스트 호출
        </button>
      </div>
    </form>

    <pre id="quiz-test-result" class="admin-code-preview">
// 위에서 '테스트 호출'을 누르면
// 여기 JSON 결과가 표시됩니다.
    </pre>
  </div>
</section>
      </main>
    </div>
  </div>


  <!-- 관리자 페이지 전용 JS -->
  <script>
    /************************************************************
     * 1) 여기만 네 웹앱 주소로 바꿔주면 됨
     *    예) const CHEESE_ADMIN_API_BASE = 'https://script.google.com/macros/s/XXXX/exec';
     ************************************************************/
    const CHEESE_ADMIN_API_BASE = 'https://script.google.com/macros/s/AKfycbwuvooqtlk6c_Nv2_VgforohP5twqTLWGu5j8uf56D3qvKsUnioAhfbkNdTKIsQaaQF/exec'; 

    // exam_sets 시트에서 불러온 실제 데이터가 담길 배열
    let examSets = [];

    // 혹시 실패했을 때 쓸 샘플 데이터(지금 화면에 보이는 더미랑 같음)
    const fallbackExamSets = [
      {
        examKey: "khs-era-01",
        title: "한국사 시대 순서 연습문제 ①",
        period: "한국사-통사",
        topic: "시대순서",
        limit: 5,
        sheetTab: "khs-era-01",
        updatedAt: "2025-12-05",
      },
      {
        examKey: "khs-era-02",
        title: "한국사 시대 순서 연습문제 ②",
        period: "한국사-통사",
        topic: "시대순서",
        limit: 5,
        sheetTab: "khs-era-02",
        updatedAt: "2025-12-05",
      },
      {
        examKey: "jhs-era-01",
        title: "일본사 주요 시대 순서",
        period: "일본사-통사",
        topic: "시대순서",
        limit: 5,
        sheetTab: "jhs-era-01",
        updatedAt: "2025-12-04",
      },
    ];

    /************************************************************
     * 2) exam_sets 시트에서 실데이터 불러오기
     *    (Apps Script: ?mode=examSets 로 JSON 내려주는 부분이랑 연결)
     ************************************************************/
    async function loadExamSetsFromSheet() {
      if (!CHEESE_ADMIN_API_BASE) {
        console.warn('CHEESE_ADMIN_API_BASE가 비어 있어서 더미 데이터로 표시합니다.');
        examSets = fallbackExamSets;
        renderDashboard();
        renderQuizTable();
        return;
      }

      try {
        const url = CHEESE_ADMIN_API_BASE + '?mode=examSets';
        const res = await fetch(url);
        const json = await res.json();

        // 내가 안내했던 형태: { examSets: [...] } or 그냥 [...]
        if (Array.isArray(json.examSets)) {
          examSets = json.examSets;
        } else if (Array.isArray(json)) {
          examSets = json;
        } else {
          throw new Error('응답 형식이 examSets 배열이 아님');
        }

        // 정상적으로 불러왔으면 화면 렌더
        renderDashboard();
        renderQuizTable();
      } catch (err) {
        console.error('exam_sets 불러오기 실패, 더미 데이터 사용', err);
        examSets = fallbackExamSets;
        renderDashboard();
        renderQuizTable();
      }
    }

    /***********************
     * 네비게이션 전환
     ***********************/
    function showSection(name) {
      document
        .querySelectorAll(".admin-section")
        .forEach((sec) => {
          sec.classList.toggle("active", sec.dataset.section === name);
        });

      document
        .querySelectorAll(".admin-nav-button")
        .forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.target === name);
        });
    }

    /***********************
     * 대시보드 렌더링
     ***********************/
    function renderDashboard() {
      const statsEl = document.getElementById("dashboard-stats");
      const recentTbody = document.querySelector(
        "#dashboard-recent-table tbody"
      );
      if (!statsEl || !recentTbody) return;

      const totalSets = examSets.length;
      const koreaSets = examSets.filter(
        (x) => String(x.period || '').indexOf("한국사") === 0
      ).length;

      statsEl.innerHTML = `
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">등록된 examKey</div>
          <div class="dashboard-stat-value">${totalSets}개</div>
          <div class="dashboard-stat-note">시트 기준 연습문제 세트 수</div>
        </div>
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">한국사 세트</div>
          <div class="dashboard-stat-value">${koreaSets}개</div>
          <div class="dashboard-stat-note">period가 "한국사-"로 시작하는 세트</div>
        </div>
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">샘플 통계</div>
          <div class="dashboard-stat-value">준비 중</div>
          <div class="dashboard-stat-note">Apps Script 연결 후 실제 통계로 교체 예정</div>
        </div>
      `;

      const recent = [...examSets]
        .sort((a, b) =>
          String(b.updatedAt || "").localeCompare(String(a.updatedAt || ""))
        )
        .slice(0, 5);

      recentTbody.innerHTML = recent
        .map(
          (row) => `
        <tr>
          <td><span class="badge-key">${row.examKey}</span></td>
          <td>${row.title || ""}</td>
          <td>${row.period || ""}</td>
          <td>${row.limit || ""}</td>
          <td>${row.updatedAt || "-"}</td>
        </tr>
      `
        )
        .join("");
    }

    /***********************
     * 퀴즈 세트 테이블 렌더링
     ***********************/
    function renderQuizTable() {
      const tbody = document.querySelector("#quiz-table tbody");
      if (!tbody) return;

      const periodFilter = document.getElementById("filter-period").value;
      const searchKeyword = document
        .getElementById("filter-search")
        .value.trim()
        .toLowerCase();

      const filtered = examSets.filter((row) => {
        if (periodFilter && row.period !== periodFilter) return false;

        if (searchKeyword) {
          const target =
            (String(row.examKey || "") + " " + String(row.title || "")).toLowerCase();
          if (!target.includes(searchKeyword)) return false;
        }
        return true;
      });

      tbody.innerHTML = filtered
        .map(
          (row, idx) => `
        <tr data-exam-key="${row.examKey}" data-idx="${idx}">
          <td><span class="badge-key">${row.examKey}</span></td>
          <td>${row.title || ""}</td>
          <td>${row.period || ""}</td>
          <td>${row.limit || ""}</td>
          <td>${row.sheetTab || ""}</td>
          <td class="text-muted">행 클릭 시 삽입 코드 생성</td>
        </tr>
      `
        )
        .join("");
    }

    /***********************
     * 선택한 examKey → 블로그 삽입용 코드
     ***********************/
    function updateSnippet(examKey) {
      const textArea = document.getElementById("snippet-output");
      if (!textArea) return;

      const set = examSets.find((x) => x.examKey === examKey);
      if (!set) {
        textArea.value = "";
        return;
      }

      const snippet = [
        '<div',
        '  class="cheese-quiz"',
        `  data-exam-key="${set.examKey}"`,
        '  data-source="sheet"',
        `  data-limit="${set.limit || 5}"`,
        set.period ? `  data-period="${set.period}"` : '',
        set.topic  ? `  data-topic="${set.topic}"`   : '',
        '>',
        `  <h3>${set.title || '연습문제'}</h3>`,
        '  <ol class="cheese-quiz-list"></ol>',
        '  <div class="cheese-quiz-buttons">',
        '    <button type="button" class="cheese-quiz-check">채점하기</button>',
        '    <button type="button" class="cheese-quiz-reset">다시 풀기</button>',
        '  </div>',
        '  <div class="cheese-quiz-result"></div>',
        '</div>',
      ]
        .filter(Boolean) // 빈 줄 제거
        .join("\n");

      textArea.value = snippet;
    }

    /***********************
     * 초기화
     ***********************/
    document.addEventListener("DOMContentLoaded", () => {
      // 네비 버튼
      document
        .querySelectorAll(".admin-nav-button")
        .forEach((btn) => {
          btn.addEventListener("click", () =>
            showSection(btn.dataset.target)
          );
        });

      // "퀴즈 세트 관리로 이동" 버튼
      document
        .querySelectorAll("[data-jump-nav]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-target");
            if (target) showSection(target);
          });
        });

      // 필터 이벤트
      const periodSel = document.getElementById("filter-period");
      const searchInput = document.getElementById("filter-search");
      if (periodSel) {
        periodSel.addEventListener("change", renderQuizTable);
      }
      if (searchInput) {
        searchInput.addEventListener("input", renderQuizTable);
      }

      // 테이블 행 클릭 → 코드 생성
      const quizTable = document.getElementById("quiz-table");
      if (quizTable) {
        quizTable.addEventListener("click", (e) => {
          const tr = e.target.closest("tr[data-exam-key]");
          if (!tr) return;
          const key = tr.dataset.examKey;
          updateSnippet(key);
        });
      }

      // 코드 복사 버튼
      const copyBtn = document.getElementById("btn-copy-snippet");
      if (copyBtn) {
        copyBtn.addEventListener("click", () => {
          const ta = document.getElementById("snippet-output");
          if (!ta || !ta.value.trim()) return;
          ta.select();
          document.execCommand("copy");
          copyBtn.textContent = "✅ 복사됨";
          setTimeout(() => {
            copyBtn.textContent = "📋 코드 복사";
          }, 1200);
        });
      }

      // 대시보드/테이블 초기 데이터 로드
      loadExamSetsFromSheet();
    });
  </script>

</body>
</html>
