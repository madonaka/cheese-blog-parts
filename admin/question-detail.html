<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¬¸ì œ ìƒì„¸ Â· Cheese Lab Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />
</head>
<body>
  <!-- ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ -->
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "ADMIN"];
  </script>
  <div class="admin-shell">
    <!-- ìƒë‹¨ í—¤ë” -->
   <!-- í—¤ë”ê°€ ë“¤ì–´ê°ˆ ìë¦¬ -->
    <div id="admin-header-slot"></div>

    <!-- ë‹¨ì¼ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ -->
    <main class="admin-main" style="grid-template-columns: minmax(0, 1fr);">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">ë¬¸ì œ ìƒì„¸</div>
            <div class="card-subtitle">
              ID: <span id="detail-qid">-</span>
            </div>
          </div>
          <button type="button" class="btn btn-ghost" id="btn-back-list">
            â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>

        <!-- âœ… ì‹¤ì œ ì…ë ¥ í¼ -->
        <form id="question-form">
          <!-- 1) ë©”íƒ€ ì •ë³´ -->
          <div class="field-row">
            <div class="field">
              <label for="q-id">ë‚´ë¶€ ID (ì½ê¸° ì „ìš©)</label>
              <input id="q-id" name="id" type="text" readonly />
            </div>
            <div class="field">
              <label for="q-period">ì‹œëŒ€ (period)</label>
              <input id="q-period" name="period" type="text" />
            </div>
            <div class="field">
              <label for="q-topic">ì£¼ì œ (topic)</label>
              <input id="q-topic" name="topic" type="text" />
            </div>
            <div class="field">
              <label for="q-difficulty">ë‚œì´ë„ (difficulty)</label>
              <input id="q-difficulty" name="difficulty" type="number" min="1" max="5" />
            </div>
          </div>

          <!-- 2) ë³¸ë¬¸/ì„ íƒì§€ -->
          <div class="field">
            <label for="q-question">ë¬¸ì œ ë¬¸ì¥ (question)</label>
            <textarea id="q-question" name="question"></textarea>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="q-choice1">ë³´ê¸° 1</label>
              <input id="q-choice1" name="choice1" type="text" />
            </div>
            <div class="field">
              <label for="q-choice2">ë³´ê¸° 2</label>
              <input id="q-choice2" name="choice2" type="text" />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="q-choice3">ë³´ê¸° 3</label>
              <input id="q-choice3" name="choice3" type="text" />
            </div>
            <div class="field">
              <label for="q-choice4">ë³´ê¸° 4</label>
              <input id="q-choice4" name="choice4" type="text" />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="q-answer">ì •ë‹µ (answer)</label>
              <input id="q-answer" name="answer" type="text" />
            </div>
            <div class="field">
              <label for="q-active">í™œì„± ì—¬ë¶€ (active, 1/0)</label>
              <input id="q-active" name="active" type="number" min="0" max="1" />
            </div>
          </div>

          <div class="field">
            <label for="q-explanation">í•´ì„¤ (explanation)</label>
            <textarea id="q-explanation" name="explanation"></textarea>
          </div>

          <div class="field">
            <label for="q-hint">íŒíŠ¸ (hint)</label>
            <textarea id="q-hint" name="hint"></textarea>
          </div>

          <!-- ë²„íŠ¼ ì˜ì—­ -->
          <div class="field-row" style="margin-top: 1rem;">
            <button type="button" class="btn btn-primary" id="btn-save">
              ğŸ’¾ ìˆ˜ì • ë‚´ìš© ì €ì¥
            </button>
            <button type="button" class="btn" id="btn-reset">
              â†© ë¶ˆëŸ¬ì˜¨ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
            </button>
          </div>

          <p class="small-help" id="save-message"></p>
        </form>
      </div>
    </main>
  </div>


<!-- í˜ì´ì§€ë³„ ì œëª©/ë±ƒì§€ ì„¤ì • -->
<script>
  window.CHEESE_ADMIN_PAGE_SUBTITLE = "ë¬¸ì œ ìƒì„¸ ë³´ê¸° / ìˆ˜ì •";
  window.CHEESE_ADMIN_PAGE_BADGE    = "questions detail";
</script>
  
<!-- ê³µí†µ JS (API ë² ì´ìŠ¤ URL ë“±ì´ ì—¬ê¸° ìˆë‹¤ê³  ê°€ì •) -->
<script>
  window.CHEESE_ADMIN_API_BASE =
    "https://script.google.com/macros/s/AKfycbwuvooqtlk6c_Nv2_VgforohP5twqTLWGu5j8uf56D3qvKsUnioAhfbkNdTKIsQaaQF/exec";
</script>
  
<script src="./admin-common.js"></script>

  
<script>
  (function () {
    /**********************************************************
     * 1. ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ id ì½ê¸°
     **********************************************************/
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const qid = getQueryParam("id");
    // â­ idê°€ ì—†ê±°ë‚˜ id=new ì´ë©´ "ìƒˆ ë¬¸ì œ ì…ë ¥ ëª¨ë“œ"
    const isCreateMode = !qid || qid === "new";
    
    let originalData = null; // reset & ë³€ê²½ê°ì§€ìš©

    /**********************************************************
     * 2. í¼ì— ê°’ ì±„ì›Œ ë„£ê¸° / í˜„ì¬ ê°’ ëª¨ìœ¼ê¸°
     **********************************************************/
    function fillForm(data) {
      if (!data) return;

      document.getElementById("detail-qid").textContent = data.id || "";
      document.getElementById("q-id").value = data.id || "";
      document.getElementById("q-period").value = data.period || "";
      document.getElementById("q-topic").value = data.topic || "";
      document.getElementById("q-difficulty").value = data.difficulty || "";
      document.getElementById("q-question").value = data.question || "";

      document.getElementById("q-choice1").value = data.choice1 || "";
      document.getElementById("q-choice2").value = data.choice2 || "";
      document.getElementById("q-choice3").value = data.choice3 || "";
      document.getElementById("q-choice4").value = data.choice4 || "";

      document.getElementById("q-answer").value = data.answer || "";
      document.getElementById("q-explanation").value = data.explanation || "";
      document.getElementById("q-hint").value = data.hint || "";
      document.getElementById("q-active").value =
        data.active !== undefined && data.active !== null
          ? String(data.active)
          : "";
    }

    function collectForm() {
      return {
        id: document.getElementById("q-id").value.trim(),
        period: document.getElementById("q-period").value.trim(),
        topic: document.getElementById("q-topic").value.trim(),
        difficulty: document.getElementById("q-difficulty").value.trim(),
        question: document.getElementById("q-question").value.trim(),
        choice1: document.getElementById("q-choice1").value.trim(),
        choice2: document.getElementById("q-choice2").value.trim(),
        choice3: document.getElementById("q-choice3").value.trim(),
        choice4: document.getElementById("q-choice4").value.trim(),
        answer: document.getElementById("q-answer").value.trim(),
        explanation: document.getElementById("q-explanation").value.trim(),
        hint: document.getElementById("q-hint").value.trim(),
        active: document.getElementById("q-active").value.trim(),
      };
    }

    /**********************************************************
     * 3. ë‹¨ì¼ ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° (GET: mode=getQuestion&id=...)
     **********************************************************/
    async function loadQuestionDetail() {
      const msgEl = document.getElementById("save-message");

      if (!qid) {
        msgEl.textContent = "URLì— id íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        msgEl.classList.add("danger-text");
        return;
      }

      try {
        const base = window.CHEESE_ADMIN_API_BASE || "";
        const url =
          base + "?mode=getQuestion&id=" + encodeURIComponent(qid);

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP ì—ëŸ¬: " + res.status);
        }

        const rawText = await res.text();
        console.log("getQuestion ì‘ë‹µ:", rawText);

        let json;
        try {
          json = JSON.parse(rawText);
        } catch (parseErr) {
          console.error("getQuestion ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:", parseErr);
          msgEl.textContent =
            "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì„œë²„ì—ì„œ JSON ëŒ€ì‹  ë‹¤ë¥¸ í˜•ì‹ì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
          msgEl.classList.add("danger-text");
          return;
        }

        if (json.error) {
          msgEl.textContent =
            "ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: " + (json.error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬");
          msgEl.classList.add("danger-text");
          return;
        }

        // Apps Script ìª½ í˜•ì‹:
        // { ok: true, question: { id, period, topic, difficulty, question, choices[4], answer, explanation, active, hint } }
        const q = json.question || json;

        originalData = {
          id: q.id || "",
          period: q.period || "",
          topic: q.topic || "",
          difficulty: q.difficulty || "",
          question: q.question || "",
          choice1:
            (q.choices && q.choices[0]) !== undefined
              ? q.choices[0]
              : q.choice1 || "",
          choice2:
            (q.choices && q.choices[1]) !== undefined
              ? q.choices[1]
              : q.choice2 || "",
          choice3:
            (q.choices && q.choices[2]) !== undefined
              ? q.choices[2]
              : q.choice3 || "",
          choice4:
            (q.choices && q.choices[3]) !== undefined
              ? q.choices[3]
              : q.choice4 || "",
          answer: q.answer || "",
          explanation: q.explanation || "",
          hint: q.hint || "",
          active: q.active,
        };

        fillForm(originalData);
        msgEl.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ";
        msgEl.classList.remove("danger-text");
      } catch (err) {
        console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì—ëŸ¬:", err);
        const msgEl = document.getElementById("save-message");
        msgEl.textContent =
          "ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì—ëŸ¬: " + (err.message || String(err));
        msgEl.classList.add("danger-text");
      }
    }

    /**********************************************************
     * 4. ìˆ˜ì • ë‚´ìš© ì €ì¥ (POST: mode=updateQuestion)
     **********************************************************/
    async function saveQuestion() {
      const msgEl = document.getElementById("save-message");
      msgEl.textContent = "ì €ì¥ ì¤‘...";
      msgEl.classList.remove("danger-text");
    
      const payload = collectForm();
    
      // â­ ìˆ˜ì • ëª¨ë“œì—ì„œë§Œ ID í•„ìˆ˜ ì²´í¬
      if (!isCreateMode && !payload.id) {
        msgEl.textContent = "IDê°€ ì—†ìŠµë‹ˆë‹¤. ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        msgEl.classList.add("danger-text");
        return;
      }
    
      try {
        const base = window.CHEESE_ADMIN_API_BASE;
        if (!base) {
          msgEl.textContent = "API BASE URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
          msgEl.classList.add("danger-text");
          return;
        }
    
        // â­ ì‹ ê·œ/ìˆ˜ì • ëª¨ë“œì— ë”°ë¼ Apps Script mode ë¶„ê¸°
        const mode = isCreateMode ? "addQuestion" : "updateQuestion";
        const url = base + "?mode=" + mode;
    
        const res = await fetch(url, {
          method: "POST",
          // CORS ë•Œë¬¸ì— Content-Typeì€ ì•ˆ ë¶™ì´ëŠ” ë°©ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€
          body: JSON.stringify(payload),
        });
    
        if (!res.ok) {
          throw new Error("HTTP ì—ëŸ¬: " + res.status);
        }
    
        const rawText = await res.text();
        console.log("add/update Question ì‘ë‹µ:", rawText);
    
        let json;
        try {
          json = JSON.parse(rawText);
        } catch (parseErr) {
          console.error("ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:", parseErr);
          msgEl.textContent =
            "ì €ì¥ ì‹¤íŒ¨: ì„œë²„ì—ì„œ JSON ëŒ€ì‹  ë‹¤ë¥¸ í˜•ì‹ì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.";
          msgEl.classList.add("danger-text");
          return;
        }
    
        if (json.error) {
          msgEl.textContent =
            "ì €ì¥ ì‹¤íŒ¨: " + (json.error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
          msgEl.classList.add("danger-text");
          return;
        }
    
        // â­ addQuestionì¼ ë•Œ, ì„œë²„ê°€ ìƒˆ IDë¥¼ ëŒë ¤ì¤¬ë‹¤ë©´ í¼ì— ë°˜ì˜
        if (isCreateMode && json.question && json.question.id) {
          payload.id = json.question.id;
    
          const idInput = document.getElementById("q-id");
          const idSpan = document.getElementById("detail-qid");
          if (idInput) idInput.value = payload.id;
          if (idSpan) idSpan.textContent = payload.id;
        }
    
        originalData = payload;
        msgEl.textContent = isCreateMode ? "ìƒˆ ë¬¸ì œ ë“±ë¡ ì™„ë£Œ!" : "ì €ì¥ ì™„ë£Œ!";
        msgEl.classList.remove("danger-text");
      } catch (err) {
        console.error("ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ", err);
        msgEl.textContent =
          "ì €ì¥ ì¤‘ ì—ëŸ¬: " + (err.message || String(err));
        msgEl.classList.add("danger-text");
      }
    }
    /**********************************************************
     * 5. ì´ë²¤íŠ¸ ë°”ì¸ë”©
     **********************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      const msgEl = document.getElementById("save-message");

      // ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
      const backBtn = document.getElementById("btn-back-list");
      if (backBtn) {
        backBtn.addEventListener("click", () => {
          // í•„ìš”í•˜ë©´ ê²½ë¡œ ìˆ˜ì •
          window.location.href = "./questions.html";
        });
      }

      // ì €ì¥ ë²„íŠ¼
      const saveBtn = document.getElementById("btn-save");
      if (saveBtn) {
        saveBtn.addEventListener("click", saveQuestion);
      }

      // ë¦¬ì…‹ ë²„íŠ¼ (ë¶ˆëŸ¬ì˜¨ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°)
      const resetBtn = document.getElementById("btn-reset");
      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          if (!originalData) return;
          fillForm(originalData);
          msgEl.textContent = "ë¶ˆëŸ¬ì˜¨ ê°’ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.";
          msgEl.classList.remove("danger-text");
        });
      }

      // â­ ìµœì´ˆ ë¡œë”©: ì‹ ê·œ ëª¨ë“œ vs ìˆ˜ì • ëª¨ë“œ ë¶„ê¸°
      if (isCreateMode) {
        // ìƒˆ ë¬¸ì œ ê¸°ë³¸ê°’
        originalData = {
          id: "",
          period: "",
          topic: "",
          difficulty: "",
          question: "",
          choice1: "",
          choice2: "",
          choice3: "",
          choice4: "",
          answer: "",
          explanation: "",
          hint: "",
          active: 1,
        };
        fillForm(originalData);
    
        // í™”ë©´ í…ìŠ¤íŠ¸ë„ ì‹ ê·œ ì…ë ¥ìš©ìœ¼ë¡œ ë°”ê¿”ì£¼ê¸°
        const titleEl = document.querySelector(".card-title");
        const subtitleEl = document.querySelector(".card-subtitle");
        if (titleEl) titleEl.textContent = "ìƒˆ ë¬¸ì œ ì…ë ¥";
        if (subtitleEl) subtitleEl.textContent = "ìƒˆ ë¬¸ì œë¥¼ ì…ë ¥í•œ ë’¤ ì €ì¥ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
    
        const idSpan = document.getElementById("detail-qid");
        if (idSpan) idSpan.textContent = "ìƒˆ ë¬¸ì œ";
    
        msgEl.textContent = "ìƒˆ ë¬¸ì œ ì…ë ¥ ëª¨ë“œì…ë‹ˆë‹¤.";
        msgEl.classList.remove("danger-text");
      } else {
        // ê¸°ì¡´ ë¡œì§ (ìˆ˜ì • ëª¨ë“œ)
        if (!qid) {
          msgEl.textContent = "URLì— id íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          msgEl.classList.add("danger-text");
          return;
        }
        loadQuestionDetail();
      }
    });
  })();
</script>

</body>
</html>
