<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>E-Book ë·°ì–´ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* ... (ê¸°ì¡´ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
    .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .dash-title .t { font-size: 1.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em; line-height: 1.2; }
    .dash-title .s { font-size: 0.85rem; color: var(--text-sub); margin-top: 0.25rem; font-weight: 500; }
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #fff; border: 1px solid var(--border); color: var(--text-sub); }

    /* ë·°ì–´ ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒ (ëª¨ë°”ì¼ ëŒ€ì‘) */
    .ebook-layout { display: flex; flex-direction: column; height: calc(100vh - 160px); min-height: 500px; background: #fff; border-radius: 1rem; border: 1px solid var(--border); overflow: hidden; }
    
    /* ìƒë‹¨ íˆ´ë°” (ëª¨ë°”ì¼ì—ì„œ ìë™ ì¤„ë°”ê¿ˆ) */
    .ebook-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
    .toolbar-group { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    
    .tool-btn { padding: 0.5rem 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background: #fff; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #475569; transition: all 0.2s; }
    .tool-btn:hover { background: #f1f5f9; }
    .tool-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }
    
    .book-meta { display: flex; flex-direction: column; min-width: 120px; }
    .book-title { font-size: 0.95rem; font-weight: 700; color: #0f172a; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
    .book-author { font-size: 0.75rem; color: #64748b; margin: 0; }

    /* ë©”ì¸ ë·°ì–´ ì˜ì—­ */
    .ebook-body { flex: 1; display: flex; position: relative; background: #f1f5f9; transition: background 0.3s; overflow: hidden; }
    
    /* ëª¨ë°”ì¼ì—ì„œëŠ” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì„ ì‘ê²Œ í•˜ê±°ë‚˜ ìˆ¨ê¸°ê³  ìŠ¤ì™€ì´í”„ë¥¼ ìœ ë„ */
    .nav-btn { width: 40px; background: transparent; border: none; font-size: 2rem; color: #94a3b8; cursor: pointer; z-index: 10; touch-action: manipulation; }
    @media (max-width: 768px) {
        .nav-btn { display: none; } /* ëª¨ë°”ì¼ì—ì„œëŠ” ë²„íŠ¼ ìˆ¨ê¹€ (ìŠ¤ì™€ì´í”„ë¡œ ëŒ€ì²´) */
        .ebook-layout { height: calc(100vh - 120px); border-radius: 0; border-left: none; border-right: none; }
        .book-title { max-width: 150px; }
    }
    
    #viewer { flex: 1; height: 100%; position: relative; overflow: hidden; padding: 0 10px; }
    #loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: #64748b; }

    /* ë‹¤í¬ ëª¨ë“œ */
    .ebook-body.dark-theme { background: #1e293b; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main style="position: relative; padding: 1rem;">
        <header class="dash-header">
          <div class="dash-title">
            <h1 class="t">E-Book ë·°ì–´</h1>
            <p class="s">EPUB í‘œì¤€ ê·œê²©ì˜ ì „ìì±… ë°ì´í„°ë¥¼ ì½ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
          </div>
          <div class="status-pill">
            <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%;"></span>
            <span id="nowPill">ìµœê·¼ ë™ê¸°í™”: -</span>
          </div>
        </header>

        <section class="ebook-layout">
          <div class="ebook-toolbar">
            <div class="toolbar-group">
              <button class="tool-btn" onclick="loadDefaultBook()">ğŸ“š ê¸°ë³¸ ì±… ë¡œë“œ</button>
              <div class="book-meta">
                <div class="book-title" id="meta-title">ë¡œë”© ì¤‘...</div>
                <div class="book-author" id="meta-author">-</div>
              </div>
            </div>

            <div class="toolbar-group">
              <button class="tool-btn" id="btn-zoom-out">A-</button>
              <button class="tool-btn" id="btn-zoom-in">A+</button>
              <button class="tool-btn" id="btn-theme">ğŸŒ™ ëª¨ë“œ</button>
            </div>
          </div>

          <div class="ebook-body" id="ebook-body">
            <button class="nav-btn" id="prev-btn">â€¹</button>
            <div id="viewer">
                <div id="loading-indicator">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
            <button class="nav-btn" id="next-btn">â€º</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    // ê³µí†µ ìœ í‹¸ë¦¬í‹°
    function pad2(n){ return String(n).padStart(2,'0'); }
    function hm(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
    function setNow(){ document.getElementById('nowPill').innerHTML = `ìµœê·¼ ë™ê¸°í™”: ${hm(new Date())}`; }
    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'E-Book', subtitle:'ë„ì„œ ì—´ëŒ' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'ebook' });
    }

    // --- Epub.js ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜ ---
    let book = null;
    let rendition = null;
    let currentTheme = 'light';
    let currentFontSize = 100;

    // ğŸ’¡ 1. ì—¬ê¸°ì— ì½ì–´ì˜¬ EPUB íŒŒì¼ì˜ URL ê²½ë¡œë¥¼ ì ì–´ì£¼ì„¸ìš”.
    // ê°™ì€ ì„œë²„ì— ìˆëŠ” íŒŒì¼ì´ë¼ë©´ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© (ì˜ˆ: './books/history-vol1.epub')
    const DEFAULT_EPUB_URL = "https://s3.amazonaws.com/moby-dick/moby-dick.epub"; // ì˜ˆì‹œìš© ê³µê°œ íŒŒì¼ì…ë‹ˆë‹¤. ë‚˜ì¤‘ì— ë³¸ì¸ íŒŒì¼ ê²½ë¡œë¡œ ë°”ê¾¸ì„¸ìš”.

    // ë·°ì–´ ì´ˆê¸°í™”
    function initViewer() {
        if (book) { book.destroy(); }
        document.getElementById('viewer').innerHTML = '<div id="loading-indicator">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
    }

    // URLì—ì„œ EPUB ë¶ˆëŸ¬ì˜¤ê¸° (í•µì‹¬ ê¸°ëŠ¥)
    function loadEpubFromUrl(url) {
        initViewer();

        // URLì„ í†µí•´ íŒŒì¼ ë¡œë“œ
        book = ePub(url);
        
        book.loaded.metadata.then(function(meta){
            document.getElementById('meta-title').textContent = meta.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('meta-author').textContent = meta.creator || 'ì‘ì ë¯¸ìƒ';
        }).catch(err => {
            document.getElementById('meta-title').textContent = 'íŒŒì¼ ë¡œë“œ ì—ëŸ¬';
            console.error(err);
        });

        // ë Œë”ë§ ë°©ì‹ ì„¤ì • (ëª¨ë°”ì¼ì— ë§ê²Œ spread: 'none' ì²˜ë¦¬)
        rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            spread: "none", // í™”ë©´ì„ ë°˜ìœ¼ë¡œ ë‚˜ëˆ„ì§€ ì•Šê³  í•œ ë©´ì”© ì¶œë ¥
            manager: "continuous",
            flow: "paginated"
        });

        // í…Œë§ˆ ì„¤ì •
        rendition.themes.register("light", { "body": { "background": "transparent", "color": "#333", "padding": "10px" }});
        rendition.themes.register("dark", { "body": { "background": "transparent", "color": "#cbd5e1", "padding": "10px" }});
        
        rendition.themes.select(currentTheme);
        rendition.themes.fontSize(`${currentFontSize}%`);

        rendition.display().then(() => {
            const indicator = document.getElementById('loading-indicator');
            if(indicator) indicator.style.display = 'none';
            setupSwipeEvents(); // ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤ì™€ì´í”„ ì´ë²¤íŠ¸ ë¶€ì°©
        });

        // PC ë°©í–¥í‚¤ ì§€ì›
        rendition.on("keyup", function(e) {
            if(e.keyCode == 37) rendition.prev();
            if(e.keyCode == 39) rendition.next();
        });
    }

    // ê¸°ë³¸ ì±… ë¡œë“œ í•¨ìˆ˜
    function loadDefaultBook() {
        loadEpubFromUrl(DEFAULT_EPUB_URL);
    }

    // --- ğŸ’¡ ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ (í„°ì¹˜) ê¸°ëŠ¥ êµ¬í˜„ ---
    function setupSwipeEvents() {
        let touchStartX = 0;
        let touchEndX = 0;

        // Epub.js ë‚´ë¶€ì— ìƒì„±ëœ iframeì— í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ê±¸ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
        rendition.on('touchstart', function(event) {
            touchStartX = event.changedTouches[0].screenX;
        });

        rendition.on('touchend', function(event) {
            touchEndX = event.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const threshold = 50; // ì´ í”½ì…€ ì´ìƒ ì›€ì§ì—¬ì•¼ ë„˜ì–´ê°
            if (touchEndX < touchStartX - threshold) {
                // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ í˜ì´ì§€
                rendition.next();
            }
            if (touchEndX > touchStartX + threshold) {
                // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ì´ì „ í˜ì´ì§€
                rendition.prev();
            }
        }
    }

    // --- UI ë²„íŠ¼ ì´ë²¤íŠ¸ ---
    document.getElementById("prev-btn").addEventListener("click", () => { if(rendition) rendition.prev(); });
    document.getElementById("next-btn").addEventListener("click", () => { if(rendition) rendition.next(); });

    document.getElementById("btn-zoom-in").addEventListener("click", () => {
        if(!rendition) return;
        currentFontSize += 10;
        rendition.themes.fontSize(`${currentFontSize}%`);
    });

    document.getElementById("btn-zoom-out").addEventListener("click", () => {
        if(!rendition) return;
        currentFontSize = Math.max(70, currentFontSize - 10);
        rendition.themes.fontSize(`${currentFontSize}%`);
    });

    document.getElementById("btn-theme").addEventListener("click", function() {
        const bodyEl = document.getElementById("ebook-body");
        if (currentTheme === 'light') {
            currentTheme = 'dark';
            this.innerHTML = 'â˜€ï¸ ëª¨ë“œ';
            this.classList.add('active');
            bodyEl.classList.add('dark-theme');
        } else {
            currentTheme = 'light';
            this.innerHTML = 'ğŸŒ™ ëª¨ë“œ';
            this.classList.remove('active');
            bodyEl.classList.remove('dark-theme');
        }
        if(rendition) rendition.themes.select(currentTheme);
    });

    // --- ì´ˆê¸° ì‹¤í–‰ ---
    (function init(){
      setNow(); 
      setInterval(setNow, 1000*60);
      mountShell();
      
      // í˜ì´ì§€ ë¡œë“œê°€ ëë‚˜ë©´ ê¸°ë³¸ íŒŒì¼(.epub)ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      setTimeout(loadDefaultBook, 300); 
    })();
  </script>
</body>
</html>
