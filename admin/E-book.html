<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í…ìŠ¤íŠ¸ E-Book ê´€ë¦¬ì Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

  <style>
    /* =========================================
       E-Book Viewer & Editor Styles
    ========================================= */
    .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .dash-title .t { font-size: 1.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em; line-height: 1.2; }
    .dash-title .s { font-size: 0.85rem; color: var(--text-sub); margin-top: 0.25rem; font-weight: 500; }
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #fff; border: 1px solid var(--border); color: var(--text-sub); }

    /* ë·°ì–´ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    .ebook-layout { display: flex; flex-direction: column; height: calc(100vh - 160px); min-height: 500px; background: #fff; border-radius: 1rem; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); position: relative; transition: background 0.3s, border-color 0.3s; }
    
    /* â­ ì „ì²´í™”ë©´ ì§‘ì¤‘ ëª¨ë“œ */
    .ebook-layout.fullscreen { position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 9999; border-radius: 0; border: none; margin: 0; box-shadow: none; }
    body.fullscreen-active { overflow: hidden; }

    /* íˆ´ë°” */
    .ebook-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; transition: background 0.3s, border-color 0.3s; }
    .toolbar-group { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    
    .tool-btn { padding: 0.5rem 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background: #fff; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #475569; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; }
    .tool-btn:hover { background: #f1f5f9; }
    .tool-btn.primary { background: var(--primary, #3b82f6); color: #fff; border-color: var(--primary, #3b82f6); }
    .tool-btn.primary:hover { background: #2563eb; }
    .tool-btn.danger { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
    .tool-btn.danger:hover { background: #fca5a5; color: #991b1b; }

    .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; }

    .book-meta { font-size: 1rem; font-weight: 700; color: #0f172a; border: none; background: transparent; padding: 0.2rem 0.5rem; outline: none; border-bottom: 2px solid transparent; transition: all 0.2s; border-radius: 4px; }
    .book-meta:focus { border-bottom: 2px solid var(--primary, #3b82f6); background: rgba(0,0,0,0.03); }

    /* â­ ë³¸ë¬¸ ì˜ì—­ (ë²„íŠ¼ ë°€ë¦¼ ë°©ì§€ ê°•í™”) */
    .ebook-body { 
        flex: 1; 
        display: flex; 
        position: relative; 
        background: #fdfdfd; 
        transition: background 0.3s; 
        align-items: center; 
        min-height: 0; /* Flexbox ìì‹ íŒ½ì°½ ë°©ì§€ í•µì‹¬ì½”ë“œ */
        overflow: hidden; 
    }
    
    /* â­ ì¢Œìš° ë„˜ê¹€ ë²„íŠ¼ (í¬ê¸° ê³ ì •) */
    .nav-btn { 
        width: 50px; 
        height: 100%; 
        flex-shrink: 0; /* ê¸€ìê°€ ì»¤ì ¸ë„ ë²„íŠ¼ í¬ê¸° ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
        background: transparent; 
        border: none; 
        font-size: 2rem; 
        color: #94a3b8; 
        cursor: pointer; 
        z-index: 10; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        transition: color 0.2s, background 0.2s; 
    }
    .nav-btn:hover { background: rgba(0,0,0,0.03); color: var(--primary, #3b82f6); }
    
    /* â­ ë·°ì–´ ì°½ ë° í˜ì´ì§• ì—”ì§„ ê°œì„  */
    .viewer-window { 
        flex: 1; 
        height: calc(100% - 40px); 
        margin: 20px 0; 
        overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ì™„ì „íˆ ìˆ¨ê¹€ */
        position: relative; 
        min-width: 0; 
    }
    .viewer-content { 
        height: 100%; 
        box-sizing: border-box; 
        column-width: 100%; 
        column-fill: auto; 
        font-size: 16px; 
        line-height: 1.8; 
        font-family: 'Gowun Batang', serif; 
        color: #333; 
        padding-bottom: 10px; 
        transition: transform 0.3s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ í˜ì´ì§€ ìŠ¬ë¼ì´ë”© */
        word-break: keep-all; 
    }
    .viewer-content p { margin-bottom: 1em; }
    .viewer-content h1, .viewer-content h2, .viewer-content h3 { break-inside: avoid; }
    .page-indicator { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 0.8rem; color: #94a3b8; pointer-events: none; font-family: monospace; }

    /* í¸ì§‘ ëª¨ë“œ */
    .editor-window { flex: 1; height: 100%; padding: 1.5rem; display: none; box-sizing: border-box; background: transparent; min-width: 0; }
    .editor-textarea { width: 100%; height: 100%; resize: none; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 1rem; font-size: 15px; line-height: 1.6; font-family: inherit; box-sizing: border-box; outline: none; background: #f8fafc; transition: all 0.3s; }
    .editor-textarea:focus { border-color: var(--primary, #3b82f6); background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    /* ë‹¤í¬ ëª¨ë“œ */
    .ebook-layout.dark-theme { background: #0f172a; border-color: #1e293b; }
    .ebook-layout.dark-theme .ebook-toolbar { background: #1e293b; border-color: #334155; }
    .ebook-layout.dark-theme .tool-btn { background: #334155; color: #cbd5e1; border-color: #475569; }
    .ebook-layout.dark-theme .tool-btn:hover { background: #475569; }
    .ebook-layout.dark-theme .tool-btn.primary { background: var(--primary, #3b82f6); color: #fff; border-color: var(--primary, #3b82f6); }
    .ebook-layout.dark-theme .book-meta { color: #f8fafc; }
    .ebook-layout.dark-theme .book-meta:focus { background: rgba(255,255,255,0.05); }
    .ebook-layout.dark-theme .ebook-body { background: #0f172a; }
    .ebook-layout.dark-theme .viewer-content { color: #cbd5e1; }
    .ebook-layout.dark-theme .nav-btn { color: #475569; }
    .ebook-layout.dark-theme .nav-btn:hover { color: #94a3b8; background: rgba(255,255,255,0.02); }
    .ebook-layout.dark-theme .editor-textarea { background: #1e293b; color: #cbd5e1; border-color: #334155; }
    .ebook-layout.dark-theme .editor-textarea:focus { border-color: #64748b; background: #0f172a; }

    /* ëª©ë¡ ëª¨ë‹¬ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 10000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal-card { background: #fff; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 1rem; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .modal-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
    .modal-header h3 { margin: 0; font-size: 1.1rem; color: #0f172a; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; transition: color 0.2s; }
    .close-btn:hover { color: #ef4444; }
    .modal-body { flex: 1; overflow-y: auto; padding: 1rem; }
    .book-list-item { padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; background: #fff; }
    .book-list-item:hover { border-color: var(--primary, #3b82f6); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .book-list-item h4 { margin: 0 0 0.4rem 0; color: #0f172a; font-size: 1rem; }
    .book-list-item p { margin: 0; font-size: 0.75rem; color: #64748b; }

    @media (max-width: 768px) {
        .nav-btn { display: none; } 
        .ebook-layout { height: calc(100vh - 120px); border-radius: 0; border: none; }
        .book-meta { max-width: 150px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main style="position: relative; padding: 1rem;">
        <header class="dash-header">
          <div class="dash-title">
            <h1 class="t">E-Book ê´€ë¦¬ì</h1>
            <p class="s">ë¬¸ì„œë¥¼ ì—´ëŒí•˜ê³ , ë‚´ìš©ì„ ìˆ˜ì • ë° ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          </div>
          <div class="status-pill">
            <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%;"></span>
            <span id="nowPill">ì¤€ë¹„ ì™„ë£Œ</span>
          </div>
        </header>

        <section class="ebook-layout" id="ebook-layout">
          <div class="ebook-toolbar">
            <div class="toolbar-group">
              <button class="tool-btn" onclick="openBookList()">ğŸ“š ì„œì¬</button>
              <div class="file-upload-wrapper">
                <button class="tool-btn">ğŸ“‚ íŒŒì¼ ì—´ê¸°</button>
                <input type="file" id="file-input" accept=".txt, .html" />
              </div>
              <input type="text" class="book-meta" id="meta-title" value="" placeholder="ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly>
            </div>

            <div class="toolbar-group">
              <button class="tool-btn" id="btn-theme" title="ë‹¤í¬ ëª¨ë“œ">ğŸŒ™</button>
              <button class="tool-btn" id="btn-zoom-out" title="ê¸€ì ì¶•ì†Œ">A-</button>
              <button class="tool-btn" id="btn-zoom-in" title="ê¸€ì í™•ëŒ€">A+</button>
              <span style="width: 1px; height: 20px; background: #cbd5e1; margin: 0 5px; display: inline-block;" class="divider"></span>
              <button class="tool-btn" id="btn-edit-toggle">âœï¸ í¸ì§‘</button>
              <button class="tool-btn primary" id="btn-save" onclick="saveBook()">ğŸ’¾ ì €ì¥</button>
              
              <button class="tool-btn" id="btn-enter-fs" onclick="enterFullScreen()">â›¶ ì „ì²´í™”ë©´</button>
              <button class="tool-btn danger" id="btn-exit-fs" style="display: none;" onclick="exitFullScreen()">âœ– ë‹«ê¸°</button>
            </div>
          </div>

          <div class="ebook-body" id="ebook-body">
            <button class="nav-btn" id="prev-btn">â€¹</button>
            
            <div class="viewer-window" id="viewer-window">
                <div class="viewer-content" id="viewer-content">
                    <div style="text-align: center; color: #94a3b8; margin-top: 20%;">
                        <h3>ìƒë‹¨ì˜ [ğŸ“š ì„œì¬] ë˜ëŠ” [ğŸ“‚ íŒŒì¼ ì—´ê¸°]ë¥¼ ëˆŒëŸ¬ ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</h3>
                    </div>
                </div>
            </div>

            <div class="editor-window" id="editor-window">
                <textarea class="editor-textarea" id="editor-content" placeholder="ì´ê³³ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì„¸ìš”..."></textarea>
            </div>

            <button class="nav-btn" id="next-btn">â€º</button>
            <div class="page-indicator" id="page-indicator-ui"><span id="current-page">0</span> / <span id="total-pages">0</span></div>
          </div>
        </section>

        <div class="modal-overlay" id="listModal">
          <div class="modal-card">
            <div class="modal-header">
              <h3>ğŸ“š ë‚´ ì„œì¬ (ì €ì¥ëœ ë¬¸ì„œ)</h3>
              <button class="close-btn" onclick="closeBookList()">Ã—</button>
            </div>
            <div class="modal-body" id="book-list-container">
              <div style="text-align:center; padding: 2rem; color:#64748b;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    // ğŸ’¡ Google Apps Script ë°°í¬ URL ìœ ì§€
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxnwLsNiKFKEuYytV8R_F6u2vDzxkzwbozB_d6cmzsZsDlVpkx5scRqFaKe2bz4K6lB/exec'; 

    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'E-Book', subtitle:'ë„ì„œ ê´€ë¦¬' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'ebook' });
    }

    let currentBookId = null; 
    let isEditMode = false;
    let booksData = []; 
    
    // --- ì „ì²´í™”ë©´ ì œì–´ ---
    function enterFullScreen() {
        document.getElementById('ebook-layout').classList.add('fullscreen');
        document.body.classList.add('fullscreen-active');
        document.getElementById('btn-enter-fs').style.display = 'none';
        document.getElementById('btn-exit-fs').style.display = 'inline-flex';
        document.getElementById('meta-title').removeAttribute('readonly');
        setTimeout(calculatePages, 300); // ë ˆì´ì•„ì›ƒ ë³€ê²½ í›„ ì¬ê³„ì‚°
    }

    function exitFullScreen() {
        document.getElementById('ebook-layout').classList.remove('fullscreen');
        document.body.classList.remove('fullscreen-active');
        document.getElementById('btn-enter-fs').style.display = 'inline-flex';
        document.getElementById('btn-exit-fs').style.display = 'none';
        document.getElementById('meta-title').setAttribute('readonly', true);
        setTimeout(calculatePages, 300); // ë ˆì´ì•„ì›ƒ ë³€ê²½ í›„ ì¬ê³„ì‚°
    }

    // --- â­ ê°•ë ¥í•´ì§„ í˜ì´ì§• ë¡œì§ (Transform í™œìš©) ---
    const viewerWindow = document.getElementById('viewer-window');
    const viewerContent = document.getElementById('viewer-content');
    let currentPage = 0, totalPages = 1;
    
    function getColumnGap() { return window.innerWidth <= 768 ? 10 : 20; }
    
    function calculatePages() {
        if(isEditMode || !viewerContent.innerHTML.trim()) return; 
        
        const gap = getColumnGap();
        viewerContent.style.columnGap = gap + 'px'; // CSSì™€ JS ì‹±í¬ ë§ì¶”ê¸°

        // 1. ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ ì ì‹œ ë³€í˜•ì„ í’€ê³  ì• ë‹ˆë©”ì´ì…˜ ì •ì§€
        viewerContent.style.transition = 'none';
        viewerContent.style.transform = `translateX(0px)`;
        void viewerContent.offsetWidth; // ê°•ì œ Reflow (ë¸Œë¼ìš°ì €ê°€ ì¦‰ì‹œ í¬ê¸° ì¬ê³„ì‚°í•˜ë„ë¡ ìœ ë„)

        // 2. í˜ì´ì§€ ìˆ˜ ê³„ì‚°
        const pageWidth = viewerWindow.clientWidth + gap;
        const totalWidth = viewerContent.scrollWidth;
        
        totalPages = Math.ceil(totalWidth / pageWidth) || 1;
        if(currentPage >= totalPages) currentPage = Math.max(0, totalPages - 1);
        
        updatePageIndicator();
        
        // 3. ì• ë‹ˆë©”ì´ì…˜ ë³µêµ¬ í›„ í˜„ì¬ í˜ì´ì§€ë¡œ ì´ë™
        viewerContent.style.transition = 'transform 0.3s ease-in-out';
        goToPage(currentPage);
    }

    function goToPage(page) {
        if (page < 0) page = 0;
        if (page >= totalPages) page = totalPages - 1;
        currentPage = page;
        
        const gap = getColumnGap();
        const pageWidth = viewerWindow.clientWidth + gap;
        
        // ìŠ¤í¬ë¡¤ì´ ì•„ë‹Œ Transform Xë¥¼ ì‚¬ìš©í•´ ê°•ì œë¡œ í”„ë ˆì„ ì´ë™ (ë²„ê·¸ ì›ì²œ ì°¨ë‹¨)
        viewerContent.style.transform = `translateX(-${currentPage * pageWidth}px)`;
        updatePageIndicator();
    }

    function updatePageIndicator() {
        document.getElementById('current-page').innerText = currentPage + 1;
        document.getElementById('total-pages').innerText = totalPages;
    }

    // --- í¸ì§‘ ëª¨ë“œ / ì½ê¸° ëª¨ë“œ ì „í™˜ ---
    document.getElementById("btn-edit-toggle").addEventListener("click", function() {
        isEditMode = !isEditMode;
        const editorWindow = document.getElementById("editor-window");
        const editorTextarea = document.getElementById("editor-content");
        const navBtns = document.querySelectorAll(".nav-btn");
        const pageUI = document.getElementById("page-indicator-ui");

        if (isEditMode) {
            this.innerHTML = "ğŸ“– ì½ê¸° ëª¨ë“œ";
            this.classList.add("primary");
            viewerWindow.style.display = "none";
            editorWindow.style.display = "block";
            navBtns.forEach(btn => btn.style.display = "none");
            pageUI.style.display = "none";
            
            let textRaw = viewerContent.innerHTML.replace(/<p>/g, '').replace(/<\/p>/g, '\n');
            editorTextarea.value = textRaw;
        } else {
            this.innerHTML = "âœï¸ í¸ì§‘";
            this.classList.remove("primary");
            editorWindow.style.display = "none";
            viewerWindow.style.display = "block";
            if(window.innerWidth > 768) navBtns.forEach(btn => btn.style.display = "flex");
            pageUI.style.display = "block";

            const textFormatted = editorTextarea.value.split('\n').filter(line => line.trim() !== '').map(line => `<p>${line}</p>`).join('');
            viewerContent.innerHTML = textFormatted;
            
            currentPage = 0;
            setTimeout(calculatePages, 100);
        }
    });

    // --- í´ë¼ìš°ë“œ ë°ì´í„° ì—°ë™ ---
    async function fetchBookList() {
        try {
            const res = await fetch(GAS_API_URL);
            const json = await res.json();
            booksData = json.items || [];
            renderBookList();
        } catch (e) {
            console.error("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
            document.getElementById('book-list-container').innerHTML = '<div style="color:red; text-align:center;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.</div>';
        }
    }

    function renderBookList() {
        const container = document.getElementById('book-list-container');
        container.innerHTML = '';
        if (booksData.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:2rem; color:#64748b;">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë“±ë¡í•´ë³´ì„¸ìš”!</div>';
            return;
        }

        booksData.reverse().forEach(book => {
            const div = document.createElement('div');
            div.className = 'book-list-item';
            div.innerHTML = `<h4>${book.title || 'ì œëª© ì—†ìŒ'}</h4><p>ìµœì¢… ìˆ˜ì •: ${new Date(book.date).toLocaleString()}</p>`;
            div.onclick = () => loadBookToViewer(book);
            container.appendChild(div);
        });
    }

    function loadBookToViewer(book) {
        currentBookId = book.id;
        document.getElementById('meta-title').value = book.title;
        
        document.getElementById('editor-content').value = book.content;
        viewerContent.innerHTML = book.content.split('\n').filter(line => line.trim() !== '').map(line => `<p>${line}</p>`).join('');
        
        if(isEditMode) document.getElementById("btn-edit-toggle").click(); 
        
        closeBookList();
        currentPage = 0;
        enterFullScreen(); 
    }

    async function saveBook() {
        const btn = document.getElementById('btn-save');
        const title = document.getElementById('meta-title').value;
        let contentToSave = isEditMode ? 
            document.getElementById('editor-content').value : 
            viewerContent.innerHTML.replace(/<p>/g, '').replace(/<\/p>/g, '\n');

        if (!title.trim() || !contentToSave.trim()) { alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        btn.innerText = 'ì €ì¥ ì¤‘...'; btn.disabled = true;
        const payload = { id: currentBookId, title: title, content: contentToSave };

        try {
            const res = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
            const json = await res.json();
            if (json.result === 'success') { alert('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); currentBookId = json.id; fetchBookList(); }
        } catch (e) { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } 
        finally { btn.innerText = 'ğŸ’¾ ì €ì¥'; btn.disabled = false; }
    }

    function openBookList() { document.getElementById('listModal').classList.add('show'); fetchBookList(); }
    function closeBookList() { document.getElementById('listModal').classList.remove('show'); }

    // --- íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ ---
    document.getElementById("file-input").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;

        currentBookId = null; 
        document.getElementById('meta-title').value = file.name.replace(/\.[^/.]+$/, ""); 

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            document.getElementById('editor-content').value = content;
            viewerContent.innerHTML = content.split('\n').filter(line => line.trim() !== '').map(line => `<p>${line}</p>`).join('');
            
            if(isEditMode) document.getElementById("btn-edit-toggle").click();
            
            currentPage = 0;
            enterFullScreen();
        };
        reader.readAsText(file);
    });

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
    document.getElementById("prev-btn").addEventListener("click", () => goToPage(currentPage - 1));
    document.getElementById("next-btn").addEventListener("click", () => goToPage(currentPage + 1));
    
    document.addEventListener("keyup", (e) => {
        if(document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') return;
        if(e.key === "ArrowLeft") goToPage(currentPage - 1);
        if(e.key === "ArrowRight") goToPage(currentPage + 1);
    });

    window.addEventListener('resize', () => { clearTimeout(window.resizeTimer); window.resizeTimer = setTimeout(calculatePages, 200); });
    
    // â­ ê¸€ì í¬ê¸° ë³€ê²½ ì‹œì—ë„ í˜ì´ì§€ ì¬ê³„ì‚°
    let currentFontSize = 16;
    document.getElementById("btn-zoom-in").addEventListener("click", () => {
        currentFontSize += 2; 
        viewerContent.style.fontSize = `${currentFontSize}px`; 
        setTimeout(calculatePages, 100); // í°íŠ¸ ë Œë”ë§ í›„ ê³„ì‚°ë˜ë„ë¡ ì§€ì—°
    });
    document.getElementById("btn-zoom-out").addEventListener("click", () => {
        currentFontSize = Math.max(12, currentFontSize - 2); 
        viewerContent.style.fontSize = `${currentFontSize}px`; 
        setTimeout(calculatePages, 100);
    });

    document.getElementById("btn-theme").addEventListener("click", function() {
        const layoutEl = document.getElementById("ebook-layout");
        layoutEl.classList.toggle('dark-theme');
        if (layoutEl.classList.contains('dark-theme')) {
            this.innerHTML = 'â˜€ï¸'; this.title = 'ë¼ì´íŠ¸ ëª¨ë“œ';
        } else {
            this.innerHTML = 'ğŸŒ™'; this.title = 'ë‹¤í¬ ëª¨ë“œ';
        }
    });

    (function init(){
      mountShell();
      fetchBookList(); 
    })();
  </script>
</body>
</html>
