<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>급여 · 명세서 (Step 4)</title>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0f172a; --muted:#64748b; --line:rgba(15,23,42,.10);
      --shadow:0 10px 28px rgba(15,23,42,.10); --primary:#111827; --ok:#16a34a; --bad:#ef4444;
      --r:18px;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 18px 32px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-bottom:14px;}
    .h{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .t{font-size:14px;font-weight:900;margin:0}
    .d{font-size:12px;color:var(--muted)}
    .b{padding:14px;}
    .stack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;}
    .mini{font-size:12px;color:var(--muted);line-height:1.45}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .btn{border:none;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:800;background:var(--primary);color:#fff}
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
    .btn.ok{background:var(--ok)}
    .btn.danger{background:var(--bad)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .warn{border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.06); border-radius:14px; padding:12px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
    .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin-bottom:8px;}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-size:12px;font-weight:900}
    .right{text-align:right}
    .in{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 10px;background:#fff;outline:none}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-weight:800;font-size:13px;box-shadow:0 10px 22px rgba(0,0,0,.2);display:none;z-index:50}
    .badge{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);background:#fff;}
    .btnlink{display:inline-block;text-decoration:none}
  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- ✅ 헤더 슬롯 -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- ✅ 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- ✅ 본문 -->
      <main class="admin-content">
        <div class="wrap">

          <!-- 상단 -->
          <div class="card">
            <div class="h">
              <div>
                <div class="t">급여 (Step 4) 명세서 생성 / 내 명세서 조회</div>
                <div class="d">POST generatePayslip · GET myPayslips</div>
              </div>
              <div class="stack">
                <a class="btn ghost btnlink" id="btnBackApprove" href="./payroll_step3_approve.html">← 승인</a>
                <a class="btn ghost btnlink" href="./payroll_step1_run.html">RUN 목록</a>
                <button class="btn ghost" id="btnReload">새로고침</button>
              </div>
            </div>
            <div class="b">
              <div class="stack">
                <span class="pill"><span class="mini">RUN</span><b id="viewRunId" class="mono">-</b></span>
                <span class="pill"><span class="mini">사번</span><b id="viewEmpNo" class="mono">-</b></span>
                <span class="pill"><span class="mini">이름</span><b id="viewName">-</b></span>
                <span class="badge">토큰/사번 자동</span>
              </div>

              <div id="loginWarn" class="warn mini" style="margin-top:10px; display:none;">
                로그인 세션이 없습니다. 먼저 로그인 후 다시 시도하세요.
                (<span class="mono">cheese_admin_token</span>, <span class="mono">cheese_admin_emp_no</span>)
              </div>
              <div id="runWarn" class="warn mini" style="margin-top:10px; display:none;">
                URL에 <span class="mono">runId</span>가 없습니다. (선택) RUN 기준 명세서 생성은 Step3에서 넘어오는 링크로 들어오세요.
              </div>
            </div>
          </div>

          <div class="grid">
            <!-- 4-A) 명세서 생성 -->
            <div class="card">
              <div class="h">
                <div>
                  <div class="t">4-A) RUN 기준 명세서 생성</div>
                  <div class="d">승인 완료된 RUN에 대해 명세서 생성</div>
                </div>
              </div>
              <div class="b">
                <div class="kv">
                  <div class="k">대상 RUN</div>
                  <div class="v"><b id="genRunId" class="mono">-</b></div>
                </div>

                <div class="mini" style="margin-bottom:8px;">
                  결과 로그
                </div>
                <textarea id="genLog" class="in mono" rows="10" readonly placeholder="여기에 결과/오류 로그가 표시됩니다."></textarea>

                <div class="stack" style="margin-top:10px;">
                  <button class="btn ok" id="btnGenerate">명세서 생성(generatePayslip)</button>
                  <button class="btn ghost" id="btnLoadMine">내 명세서 새로고침</button>
                </div>

                <div class="mini" style="margin-top:10px;">
                  * 승인 전 RUN이면 백엔드에서 에러를 반환하도록 하는 게 안전합니다.
                </div>
              </div>
            </div>

            <!-- 4-B) 내 명세서 조회 -->
            <div class="card">
              <div class="h">
                <div>
                  <div class="t">4-B) 내 명세서 조회</div>
                  <div class="d">GET myPayslips (사번 기준 본인 것만)</div>
                </div>
                <div class="stack">
                  <input id="month" class="in" style="width:160px" type="month" />
                  <button class="btn ghost" id="btnFilter">월 필터</button>
                  <button class="btn ghost" id="btnClear">초기화</button>
                </div>
              </div>
              <div class="b">
                <table>
                  <thead>
                    <tr>
                      <th style="width:130px;">period</th>
                      <th style="width:120px;">payDate</th>
                      <th class="right" style="width:140px;">gross</th>
                      <th class="right" style="width:140px;">ded</th>
                      <th class="right" style="width:140px;">net</th>
                      <th>status</th>
                    </tr>
                  </thead>
                  <tbody id="mineTbody"></tbody>
                </table>

                <div class="mini" style="margin-top:10px;">
                  * 응답 키가 다를 수 있어 대표 키들을 넓게 매핑해둠.
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="toast" id="toast"></div>
      </main>
    </div>
  </div>

  <!-- ✅ 공통 스크립트 -->
  <script src="./admin-common.js"></script>

  <script>
    /************************************************************
     * ✅ 너의 Apps Script WebApp /exec URL 로 교체
     ************************************************************/
    const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec';

    const $ = (id) => document.getElementById(id);

    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.style.display='none', 2200);
    };

    const fmt = (n) => (Number(n||0)).toLocaleString('ko-KR');

    function getSession() {
      return {
        token: (sessionStorage.getItem('cheese_admin_token') || '').trim(),
        empNo: (sessionStorage.getItem('cheese_admin_emp_no') || '').trim(),
        displayName: (sessionStorage.getItem('cheese_admin_display_name') || '').trim(),
        loginId: (sessionStorage.getItem('cheese_admin_login_id') || '').trim(),
      };
    }

    function ensureLogin() {
      const s = getSession();
      const ok = !!(s.token && s.empNo);
      $('loginWarn').style.display = ok ? 'none' : 'block';
      $('btnGenerate').disabled = !ok;
      $('btnLoadMine').disabled = !ok;
      $('btnFilter').disabled = !ok;
      $('btnClear').disabled = !ok;
      return { ok, ...s };
    }

    function getRunIdFromUrl() {
      const u = new URL(location.href);
      return (u.searchParams.get('runId') || u.searchParams.get('payrollRunId') || '').trim();
    }

    async function apiGet(mode, params = {}) {
      if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('XXXX')) {
        throw new Error('GAS_WEBAPP_URL을 먼저 /exec 주소로 교체하세요.');
      }
      const s = getSession();
      const usp = new URLSearchParams({
        mode,
        actor: s.empNo,
        token: s.token,
        ...params
      });
      const res = await fetch(GAS_WEBAPP_URL + '?' + usp.toString(), { method:'GET' });
      const json = await res.json().catch(()=>null);
      if (!json) throw new Error('JSON 파싱 실패(응답이 JSON이 아님)');
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.data;
    }

    async function apiPost(mode, params = {}) {
      if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('XXXX')) {
        throw new Error('GAS_WEBAPP_URL을 먼저 /exec 주소로 교체하세요.');
      }
      const s = getSession();
      const usp = new URLSearchParams({
        mode,
        actor: s.empNo,
        token: s.token,
        ...params
      });

      const res = await fetch(GAS_WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: usp.toString(),
      });

      const json = await res.json().catch(()=>null);
      if (!json) throw new Error('JSON 파싱 실패(응답이 JSON이 아님)');
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.data;
    }

    function pick(obj, keys, fallback='') {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return obj[k];
      }
      return fallback;
    }

    function appendLog(line) {
      const box = $('genLog');
      box.value = (box.value ? box.value + '\n' : '') + line;
      box.scrollTop = box.scrollHeight;
    }

    function renderMine(items) {
      const tb = $('mineTbody');
      tb.innerHTML = '';

      const arr = Array.isArray(items) ? items : (items?.items || []);
      if (!arr || !arr.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="mini">명세서가 없습니다.</td>`;
        tb.appendChild(tr);
        return;
      }

      arr.forEach(x => {
        const period = pick(x, ['period','targetMonth','month','periodYm'], '-');
        const payDate = pick(x, ['payDate','paymentDate'], '-');
        const gross = pick(x, ['gross','totalGross','grossAmount'], 0);
        const ded   = pick(x, ['deductions','totalDed','totalDeductions','dedAmount'], 0);
        const net   = pick(x, ['net','totalNet','netAmount'], 0);
        const st    = pick(x, ['status','state'], '-');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${period}</td>
          <td>${payDate}</td>
          <td class="right">${fmt(gross)}</td>
          <td class="right">${fmt(ded)}</td>
          <td class="right"><b>${fmt(net)}</b></td>
          <td>${st}</td>
        `;
        tb.appendChild(tr);
      });
    }

    let _mineAll = [];

    function applyMonthFilter() {
      const m = $('month').value; // YYYY-MM
      if (!m) { renderMine(_mineAll); return; }

      const filtered = _mineAll.filter(x => {
        const period = String(pick(x, ['period','targetMonth','month','periodYm'], '')).trim();
        // period가 2025-12 / 202512 / 2025.12 등 다양할 수 있어 느슨하게 매칭
        return period.includes(m) || period.replace(/\D/g,'').includes(m.replace('-',''));
      });

      renderMine(filtered);
    }

    async function loadMine() {
      const s = ensureLogin();
      if (!s.ok) return;

      try {
        const data = await apiGet('myPayslips', {}); // actor(empNo) 기반 본인 것
        // data 형태가 items 배열일 수도, {items:[]}일 수도 있음
        _mineAll = Array.isArray(data) ? data : (data?.items || []);
        renderMine(_mineAll);
        toast('내 명세서 로드 완료');
        console.log('[myPayslips]', data);
      } catch (e) {
        console.error(e);
        toast('내 명세서 로드 실패: ' + (e.message || e));
      }
    }

    async function generatePayslip() {
      const s = ensureLogin();
      if (!s.ok) return;

      const runId = getRunIdFromUrl();
      if (!runId) {
        toast('runId가 없어 명세서 생성 대상 RUN을 알 수 없습니다');
        return;
      }

      $('btnGenerate').disabled = true;
      appendLog(`▶ generatePayslip 시작 runId=${runId}`);

      try {
        const data = await apiPost('generatePayslip', { payrollRunId: runId, runId });
        appendLog(`✅ 완료: ${JSON.stringify(data)}`);
        toast('명세서 생성 완료');
        // 생성 후 내 명세서 바로 갱신
        await loadMine();
      } catch (e) {
        console.error(e);
        appendLog(`❌ 실패: ${e.message || e}`);
        toast('명세서 생성 실패: ' + (e.message || e));
      } finally {
        $('btnGenerate').disabled = false;
      }
    }

    $('btnReload').addEventListener('click', () => location.reload());
    $('btnLoadMine').addEventListener('click', loadMine);
    $('btnGenerate').addEventListener('click', generatePayslip);
    $('btnFilter').addEventListener('click', applyMonthFilter);
    $('btnClear').addEventListener('click', () => { $('month').value=''; renderMine(_mineAll); });

    (function init(){
      const s = ensureLogin();
      const runId = getRunIdFromUrl();

      $('viewEmpNo').textContent = s.empNo || '-';
      $('viewName').textContent = s.displayName || s.loginId || '-';
      $('viewRunId').textContent = runId || '-';
      $('genRunId').textContent = runId || '-';

      $('runWarn').style.display = runId ? 'none' : 'block';

      // 링크에 runId 유지
      $('btnBackApprove').href = `./payroll_step3_approve.html?runId=${encodeURIComponent(runId || '')}`;

      // runId 없으면 생성 버튼은 비활성(내 명세서 조회는 가능)
      if (!runId) $('btnGenerate').disabled = true;

      // 자동으로 내 명세서 로드
      if (s.ok) loadMine();
    })();
  </script>
</body>
</html>
