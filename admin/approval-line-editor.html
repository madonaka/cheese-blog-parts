<!-- approval-line-editor.html -->

<div id="approval-line-modal" class="approval-line-modal hidden">
  <div class="approval-line-backdrop"></div>

  <div class="approval-line-dialog" role="dialog" aria-modal="true">
    <div class="approval-line-header">
      <div>
        <div class="title">결재선 설정</div>
        <div class="subtitle" id="approval-line-context">결재선을 선택/편집할 수 있습니다.</div>
      </div>
      <button type="button" class="close-btn" id="approval-line-close">&times;</button>
    </div>

    <div class="approval-line-body">
      <div class="col left">
        <div class="col-title">직원 목록</div>
        <div class="col-sub">직원을 선택해서 1~3단계에 넣어주세요.</div>

        <div id="empList" class="emp-list"></div>
        <div id="empEmpty" class="emp-empty hidden">직원 목록이 없습니다.</div>
      </div>

      <div class="col right">
        <div class="col-title">결재선 구성</div>
        <div class="col-sub">단계별로 0명 이상 넣을 수 있습니다(중복은 불가).</div>

        <div class="steps">
          <div class="step">
            <div class="step-title">1단계</div>
            <div class="dropzone" data-step="1"></div>
          </div>
          <div class="step">
            <div class="step-title">2단계</div>
            <div class="dropzone" data-step="2"></div>
          </div>
          <div class="step">
            <div class="step-title">3단계</div>
            <div class="dropzone" data-step="3"></div>
          </div>
        </div>

        <!-- ✅ admin-common.js가 읽는 결과 값 -->
        <input type="hidden" id="approval-line-selected-id" value="" />
        <input type="hidden" id="approval-line-selected-name" value="" />
        <input type="hidden" id="approval-line-selected-json" value="" />
      </div>
    </div>

    <div class="approval-line-footer">
      <button type="button" class="btn btn-secondary" id="approval-line-cancel">취소</button>
      <button type="button" class="btn btn-primary" id="approval-line-save" disabled>결재선 적용</button>
    </div>
  </div>
</div>

<style>
  .hidden { display:none; }
  .approval-line-modal { position: fixed; inset: 0; z-index: 99999; }
  .approval-line-backdrop { position:absolute; inset:0; background: rgba(0,0,0,.55); }
  .approval-line-dialog {
    position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);
    width:min(980px, 95vw); height:min(82vh, 720px);
    background:#fff; border-radius:14px; overflow:hidden;
    display:flex; flex-direction:column;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .approval-line-header { padding: 14px 16px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
  .approval-line-header .title { font-weight: 800; font-size: 1.05rem; }
  .approval-line-header .subtitle { margin-top:2px; font-size: .85rem; color:#6b7280; }
  .close-btn { font-size: 1.4rem; line-height: 1; border:none; background:transparent; cursor:pointer; }
  .approval-line-body { display:flex; gap:12px; padding: 14px 16px; flex:1; min-height:0; }
  .col { border:1px solid #e5e7eb; border-radius:12px; padding:12px; flex:1; min-width:0; display:flex; flex-direction:column; }
  .col-title { font-weight: 800; }
  .col-sub { font-size: .82rem; color:#6b7280; margin-top:2px; margin-bottom:10px; }
  .emp-list { overflow:auto; border-top:1px dashed #e5e7eb; padding-top:10px; }
  .emp-card { border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:10px; }
  .emp-name { font-weight:700; }
  .emp-meta { font-size: .78rem; color:#6b7280; margin-top:2px; }
  .emp-actions { display:flex; gap:6px; align-items:flex-start; flex-wrap:wrap; justify-content:flex-end; }
  .emp-actions button { border:1px solid #d1d5db; background:#fff; border-radius:9999px; padding:6px 10px; font-size:.78rem; cursor:pointer; }
  .steps { display:flex; flex-direction:column; gap:10px; overflow:auto; }
  .step { border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
  .step-title { font-weight:800; margin-bottom:8px; }
  .dropzone { min-height: 56px; border:1px dashed #d1d5db; border-radius:10px; padding:8px; display:flex; flex-direction:column; gap:8px; }
  .drop-hint { font-size:.82rem; color:#9ca3af; padding:6px; }
  .picked { display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px solid #e5e7eb; border-radius:10px; padding:8px; background:#f9fafb; }
  .picked-del { border:1px solid #d1d5db; background:#fff; border-radius:9999px; width:28px; height:28px; cursor:pointer; }
  .approval-line-footer { padding: 12px 16px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px; }
  .btn { border:1px solid #d1d5db; background:#fff; border-radius:9999px; padding:8px 14px; cursor:pointer; }
  .btn-primary { border-color:#111827; background:#111827; color:#fff; }
  .btn-primary:disabled { opacity:.5; cursor:not-allowed; }
  .btn-secondary { }
  .emp-empty { font-size:.85rem; color:#6b7280; padding:10px; }
</style>

<script>
  // ====== 설정 ======
  const API_BASE = window.CHEESE_ADMIN_API_BASE || window.API_BASE || "";
  const TOKEN_KEY = "cheese_admin_token";

  // ====== 상태 ======
  let employees = [];
  const line = { steps: { 1: [], 2: [], 3: [] } };

  // ====== 유틸 ======
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function existsAnywhere(userId) {
    return [1,2,3].some(s => line.steps[s].some(e => e.userId === userId));
  }

  function syncHiddenAndSaveState() {
    const all = [...line.steps[1], ...line.steps[2], ...line.steps[3]];
    const saveBtn = document.getElementById("approval-line-save");

    const canSave = all.length > 0;
    if (saveBtn) saveBtn.disabled = !canSave;

    const lineId = canSave ? ("LINE-" + Date.now()) : "";
    const lineName = canSave ? "사용자 지정 결재선" : "";

    const json = canSave ? JSON.stringify({
      lineName,
      steps: [
        ...line.steps[1].map(e => ({ step:1, userId:e.userId, name:e.name, role:e.role })),
        ...line.steps[2].map(e => ({ step:2, userId:e.userId, name:e.name, role:e.role })),
        ...line.steps[3].map(e => ({ step:3, userId:e.userId, name:e.name, role:e.role })),
      ]
    }) : "";

    document.getElementById("approval-line-selected-id").value = lineId;
    document.getElementById("approval-line-selected-name").value = lineName;
    document.getElementById("approval-line-selected-json").value = json;
  }

  // ====== 렌더 ======
  function renderEmployees() {
    const root = document.getElementById("empList");
    const empty = document.getElementById("empEmpty");

    if (!employees || employees.length === 0) {
      root.innerHTML = "";
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    root.innerHTML = employees.map(e => {
      const safeName = escapeHtml(e.name);
      const safeRole = escapeHtml(e.role || "");
      const safeId = escapeHtml(e.userId);

      return `
        <div class="emp-card" draggable="true"
             data-user-id="${safeId}" data-name="${safeName}" data-role="${safeRole}">
          <div>
            <div class="emp-name">${safeName}</div>
            <div class="emp-meta">${safeId}${safeRole ? " · " + safeRole : ""}</div>
          </div>
          <div class="emp-actions">
            <button type="button" class="emp-add" data-step="1" data-user-id="${safeId}">1단계</button>
            <button type="button" class="emp-add" data-step="2" data-user-id="${safeId}">2단계</button>
            <button type="button" class="emp-add" data-step="3" data-user-id="${safeId}">3단계</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderDropzones() {
    document.querySelectorAll(".dropzone").forEach(z => {
      const step = Number(z.dataset.step);
      const arr = line.steps[step];

      z.innerHTML = arr.length
        ? arr.map(e => `
            <div class="picked" data-user-id="${escapeHtml(e.userId)}">
              <span>${escapeHtml(e.name)}${e.role ? " (" + escapeHtml(e.role) + ")" : ""}</span>
              <button type="button" class="picked-del" data-step="${step}" data-del="${escapeHtml(e.userId)}">×</button>
            </div>
          `).join("")
        : `<div class="drop-hint">여기로 드래그하거나, 오른쪽 버튼으로 단계에 추가</div>`;
    });

    syncHiddenAndSaveState();
  }

  // ====== 조작 ======
  function addToStep(step, userId) {
    const emp = employees.find(x => x.userId === userId);
    if (!emp) return;

    if (existsAnywhere(userId)) {
      alert("이미 결재선에 포함된 직원입니다.");
      return;
    }
    line.steps[step].push({ userId: emp.userId, name: emp.name, role: emp.role || "" });
    renderDropzones();
  }

  function removeFromStep(step, userId) {
    line.steps[step] = line.steps[step].filter(x => x.userId !== userId);
    renderDropzones();
  }

  // ====== 이벤트: 클릭으로 추가/삭제 ======
  document.addEventListener("click", (e) => {
    const addBtn = e.target.closest(".emp-add");
    if (addBtn) {
      const step = Number(addBtn.dataset.step);
      const userId = addBtn.dataset.userId;
      addToStep(step, userId);
      return;
    }
    const delBtn = e.target.closest(".picked-del");
    if (delBtn) {
      const step = Number(delBtn.dataset.step);
      const userId = delBtn.dataset.del;
      removeFromStep(step, userId);
      return;
    }
  });

  // ====== 이벤트: 드래그&드롭(PC용, 모바일에선 클릭으로) ======
  document.addEventListener("dragstart", (e) => {
    const card = e.target.closest(".emp-card");
    if (!card) return;
    e.dataTransfer.setData("text/plain", JSON.stringify({
      userId: card.dataset.userId,
      name: card.dataset.name,
      role: card.dataset.role
    }));
  });

  document.addEventListener("dragover", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();
  });

  document.addEventListener("drop", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();

    const step = Number(zone.dataset.step);
    const payload = JSON.parse(e.dataTransfer.getData("text/plain") || "{}");
    if (!payload.userId) return;

    if (existsAnywhere(payload.userId)) {
      alert("이미 결재선에 포함된 직원입니다.");
      return;
    }
    line.steps[step].push(payload);
    renderDropzones();
  });

  // ====== API: 직원 목록 로드 ======
  async function loadEmployeesFromApi() {
    if (!API_BASE) throw new Error("API_BASE가 설정되지 않았습니다. (window.CHEESE_ADMIN_API_BASE 필요)");

    const token = sessionStorage.getItem(TOKEN_KEY) || "";
    const params = new URLSearchParams();
    params.set("mode", "listEmployees");
    if (token) params.set("token", token);

    const res = await fetch(API_BASE + "?" + params.toString(), { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);

    const json = await res.json();
    if (!json.ok || !Array.isArray(json.employees)) {
      throw new Error(json.error || "employees 응답 형식이 올바르지 않습니다.");
    }

    // 기대 포맷: [{userId,name,role}, ...]
    employees = json.employees.map(e => ({
      userId: String(e.userId || e.employeeId || "").trim(),
      name: String(e.name || e.nameKor || "").trim(),
      role: String(e.role || e.roleId || "").trim(),
    })).filter(e => e.userId && e.name);

    return employees;
  }

  // ====== 초기화 ======
  (async function init(){
    try {
      await loadEmployeesFromApi();
    } catch (err) {
      console.warn("직원 목록 로드 실패:", err);
      // API가 아직 준비 전이면 빈 목록으로 표시
      employees = [];
    }
    renderEmployees();
    renderDropzones();
  })();
</script>
