<!-- approval-line-editor.html -->

<div id="approval-line-modal" class="approval-line-modal">
  <div class="approval-line-card">
    <div class="approval-line-head">
      <div>
        <div class="approval-line-title">결재선 설정</div>
        <div class="approval-line-sub">대상 필드: <span id="approval-line-target-name">-</span></div>
      </div>
      <button type="button" class="approval-line-x" id="approval-line-close">×</button>
    </div>

    <div class="approval-line-body">
      <div class="panel">
        <div class="panel-title">직원 목록</div>
        <div class="panel-sub">직원을 선택해서 1~3단계에 넣어주세요.</div>
        <div class="panel-sep"></div>

        <div id="empEmpty" class="emp-empty">직원 목록이 없습니다.</div>
        <div id="empList" class="emp-list"></div>
      </div>

      <div class="panel">
        <div class="panel-title">결재선 구성</div>
        <div class="panel-sub">단계별로 0명 이상 넣을 수 있습니다(중복은 불가).</div>
        <div class="panel-sep"></div>

        <div class="dropwrap">
          <div class="stepbox">
            <div class="step-title">1단계</div>
            <div class="dropzone" data-step="1"></div>
          </div>

          <div class="stepbox">
            <div class="step-title">2단계</div>
            <div class="dropzone" data-step="2"></div>
          </div>

          <div class="stepbox">
            <div class="step-title">3단계</div>
            <div class="dropzone" data-step="3"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="approval-line-foot">
      <input type="hidden" id="approval-line-selected-id" value="">
      <input type="hidden" id="approval-line-selected-name" value="">
      <input type="hidden" id="approval-line-selected-json" value="">

      <button type="button" class="btn btn-secondary" id="approval-line-cancel">취소</button>
      <button type="button" class="btn btn-primary" id="approval-line-save" disabled>결재선 적용</button>
    </div>
  </div>
</div>

<style>
  .approval-line-modal { position:fixed; inset:0; display:none; z-index:9999; background:rgba(17,24,39,.55); }
  .approval-line-modal.open { display:block; }
  .approval-line-card { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(980px, 94vw); height:min(640px, 86vh); background:#fff; border-radius:18px; box-shadow:0 18px 48px rgba(0,0,0,.25); display:flex; flex-direction:column; overflow:hidden; }
  .approval-line-head { display:flex; align-items:flex-start; justify-content:space-between; padding:18px 18px 12px; border-bottom:1px solid #e5e7eb; }
  .approval-line-title { font-size:18px; font-weight:800; }
  .approval-line-sub { font-size:13px; color:#6b7280; margin-top:2px; }
  .approval-line-x { border:0; background:transparent; font-size:22px; line-height:1; cursor:pointer; padding:8px 10px; border-radius:10px; }
  .approval-line-x:hover { background:#f3f4f6; }

  .approval-line-body { flex:1; display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:14px; overflow:hidden; }
  .panel { border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-height:0; }
  .panel-title { font-weight:800; padding:14px 14px 4px; }
  .panel-sub { font-size:12px; color:#6b7280; padding:0 14px 12px; }
  .panel-sep { height:1px; background:#e5e7eb; }

  .emp-list { padding:10px; overflow:auto; }
  .emp-card { border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; background:#fff; display:flex; justify-content:space-between; gap:10px; }
  .emp-name { font-weight:800; }
  .emp-meta { font-size:12px; color:#6b7280; margin-top:4px; }
  .emp-actions { display:flex; flex-direction:column; gap:6px; }
  .emp-add { border:1px solid #d1d5db; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-size:12px; }
  .emp-add:hover { background:#f9fafb; }

  .dropwrap { padding:10px; overflow:auto; }
  .stepbox { border:1px solid #e5e7eb; border-radius:12px; padding:10px; margin-bottom:10px; }
  .step-title { font-weight:800; margin-bottom:8px; }
  .dropzone { min-height:54px; border:1px dashed #cbd5e1; border-radius:10px; padding:8px; }
  .drop-hint { color:#94a3b8; font-size:12px; }

  .picked { display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:8px 10px; border-radius:10px; margin-bottom:8px; }
  .picked-del { border:0; background:#fff; border:1px solid #d1d5db; border-radius:8px; padding:2px 8px; cursor:pointer; }

  .approval-line-foot { padding:14px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px; }
  .btn { border:1px solid #d1d5db; background:#fff; border-radius:9999px; padding:8px 14px; cursor:pointer; }
  .btn-primary { border-color:#111827; background:#111827; color:#fff; }
  .btn-primary:disabled { opacity:.5; cursor:not-allowed; }

  .emp-empty { font-size:.85rem; color:#6b7280; padding:10px; }
</style>

<script>
  // ====== 설정 ======
  // (중요) 다른 페이지에서도 API_BASE 같은 전역 상수를 쓸 수 있어서,
  // 모달에서는 전용 이름(APPROVAL_API_BASE)을 사용합니다.
  const APPROVAL_API_BASE =
    (typeof CHEESE_APPROVAL_API_BASE !== "undefined" ? CHEESE_APPROVAL_API_BASE : "")
    || window.CHEESE_APPROVAL_API_BASE
    || (typeof CHEESE_ADMIN_API_BASE !== "undefined" ? CHEESE_ADMIN_API_BASE : "")
    || window.CHEESE_ADMIN_API_BASE
    || "";
  const APPROVAL_TOKEN_KEY = "cheese_admin_token";

  // ===== 직원 데이터 (API) =====
  let employees = [];
  const line = { steps: { 1: [], 2: [], 3: [] } };

  // ====== 유틸 ======
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  function existsAnywhere(userId) {
    return [1,2,3].some(s => line.steps[s].some(e => e.userId === userId));
  }

  function syncHiddenAndSaveState() {
    const all = [...line.steps[1], ...line.steps[2], ...line.steps[3]];
    const saveBtn = document.getElementById("approval-line-save");

    const canSave = all.length > 0;
    if (saveBtn) saveBtn.disabled = !canSave;

    const lineId = canSave ? ("LINE-" + Date.now()) : "";
    const lineName = canSave ? "사용자 지정 결재선" : "";

    const json = canSave ? JSON.stringify({
      lineName,
      steps: [
        ...line.steps[1].map(e => ({ step:1, userId:e.userId, name:e.name, role:e.role })),
        ...line.steps[2].map(e => ({ step:2, userId:e.userId, name:e.name, role:e.role })),
        ...line.steps[3].map(e => ({ step:3, userId:e.userId, name:e.name, role:e.role })),
      ]
    }) : "";

    document.getElementById("approval-line-selected-id").value = lineId;
    document.getElementById("approval-line-selected-name").value = lineName;
    document.getElementById("approval-line-selected-json").value = json;
  }

  // ====== 렌더 ======
  function renderEmployees() {
    const root = document.getElementById("empList");
    const empty = document.getElementById("empEmpty");

    if (!employees || employees.length === 0) {
      root.innerHTML = "";
      empty.classList.remove("hidden");
      empty.textContent = "직원 목록이 없습니다.";
      return;
    }
    empty.classList.add("hidden");

    root.innerHTML = employees.map(e => {
      const safeName = escapeHtml(e.name);
      const safeRole = escapeHtml(e.role || "");
      const safeId = escapeHtml(e.userId);

      return `
        <div class="emp-card" draggable="true"
             data-user-id="${safeId}" data-name="${safeName}" data-role="${safeRole}">
          <div>
            <div class="emp-name">${safeName}</div>
            <div class="emp-meta">${safeId}${safeRole ? " · " + safeRole : ""}</div>
          </div>
          <div class="emp-actions">
            <button type="button" class="emp-add" data-step="1" data-user-id="${safeId}">1단계</button>
            <button type="button" class="emp-add" data-step="2" data-user-id="${safeId}">2단계</button>
            <button type="button" class="emp-add" data-step="3" data-user-id="${safeId}">3단계</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderDropzones() {
    document.querySelectorAll(".dropzone").forEach(z => {
      const step = Number(z.dataset.step);
      const arr = line.steps[step];

      z.innerHTML = arr.length
        ? arr.map(e => `
            <div class="picked" data-user-id="${escapeHtml(e.userId)}">
              <span>${escapeHtml(e.name)}${e.role ? " (" + escapeHtml(e.role) + ")" : ""}</span>
              <button type="button" class="picked-del" data-step="${step}" data-del="${escapeHtml(e.userId)}">×</button>
            </div>
          `).join("")
        : `<div class="drop-hint">여기로 드래그하거나, 오른쪽 버튼으로 단계에 추가</div>`;
    });

    syncHiddenAndSaveState();
  }

  // ====== 조작 ======
  function addToStep(step, userId) {
    const emp = employees.find(x => x.userId === userId);
    if (!emp) return;

    if (existsAnywhere(userId)) {
      alert("이미 결재선에 포함된 직원입니다.");
      return;
    }
    line.steps[step].push({ userId: emp.userId, name: emp.name, role: emp.role || "" });
    renderDropzones();
  }

  function removeFromStep(step, userId) {
    line.steps[step] = line.steps[step].filter(x => x.userId !== userId);
    renderDropzones();
  }

  // ====== 이벤트: 클릭으로 추가/삭제 ======
  document.addEventListener("click", (e) => {
    const addBtn = e.target.closest(".emp-add");
    if (addBtn) {
      const step = Number(addBtn.dataset.step);
      const userId = addBtn.dataset.userId;
      addToStep(step, userId);
      return;
    }
    const delBtn = e.target.closest(".picked-del");
    if (delBtn) {
      const step = Number(delBtn.dataset.step);
      const userId = delBtn.dataset.del;
      removeFromStep(step, userId);
      return;
    }
  });

  // ====== 이벤트: 드래그&드롭(PC용, 모바일에선 클릭으로) ======
  document.addEventListener("dragstart", (e) => {
    const card = e.target.closest(".emp-card");
    if (!card) return;
    e.dataTransfer.setData("text/plain", JSON.stringify({
      userId: card.dataset.userId,
      name: card.dataset.name,
      role: card.dataset.role
    }));
  });

  document.addEventListener("dragover", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();
  });

  document.addEventListener("drop", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();

    const step = Number(zone.dataset.step);
    const payload = JSON.parse(e.dataTransfer.getData("text/plain") || "{}");
    if (!payload.userId) return;

    if (existsAnywhere(payload.userId)) {
      alert("이미 결재선에 포함된 직원입니다.");
      return;
    }
    line.steps[step].push(payload);
    renderDropzones();
  });

  // ====== API: 직원 목록 로드 ======
  async function loadEmployeesFromApi() {
    if (!APPROVAL_API_BASE) throw new Error("APPROVAL_API_BASE가 설정되지 않았습니다. (window.CHEESE_APPROVAL_API_BASE 필요)");

    const token = sessionStorage.getItem(APPROVAL_TOKEN_KEY) || "";
    const params = new URLSearchParams();
    params.set("mode", "listEmployees");
    if (token) params.set("token", token);

    const res = await fetch(APPROVAL_API_BASE + "?" + params.toString(), { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);

    const json = await res.json();
    if (!json.ok || !Array.isArray(json.employees)) {
      throw new Error(json.error || "employees 응답 형식이 올바르지 않습니다.");
    }

    employees = json.employees.map(e => ({
      userId: String(e.userId || e.employeeId || "").trim(),
      name: String(e.name || e.nameKor || "").trim(),
      role: String(e.role || e.roleId || "").trim(),
    })).filter(e => e.userId && e.name);

    return employees;
  }

  // ====== 모달 초기화(외부에서 호출) ======
  window.initApprovalLineModal = function initApprovalLineModal() {
    const modal = document.getElementById("approval-line-modal");
    const btnClose = document.getElementById("approval-line-close");
    const btnCancel = document.getElementById("approval-line-cancel");
    const btnSave = document.getElementById("approval-line-save");

    function closeModal() {
      modal.classList.remove("open");
    }

    if (btnClose) btnClose.onclick = closeModal;
    if (btnCancel) btnCancel.onclick = closeModal;

    if (btnSave) {
      btnSave.addEventListener("click", function () {
        const idEl = document.getElementById("approval-line-selected-id");
        const nameEl = document.getElementById("approval-line-selected-name");
        const jsonEl = document.getElementById("approval-line-selected-json");

        const lineId = (idEl ? idEl.value : "").trim();
        const lineName = (nameEl ? nameEl.value : "").trim();
        const json = (jsonEl ? jsonEl.value : "").trim();

        if (!lineId || !lineName || !json) {
          alert("결재선을 구성해 주세요.");
          return;
        }

        // 실제로 어떤 input에 넣을지는 admin-common에서 target을 잡아두는 구조라면,
        // 여기서 그 전역 상태를 읽어서 값 세팅하도록 연결하면 됨(프로젝트 구현에 맞게)
        // 지금은 모달 닫기만.
        closeModal();
      });
    }

    // 초기 로드
    (async function init(){
      try {
        await loadEmployeesFromApi();
      } catch (err) {
        console.warn("직원 목록 로드 실패:", err);
        employees = [];
      }
      renderEmployees();
      renderDropzones();
    })();
  };
</script>
