<!-- approval-line-editor.html -->

<div id="approval-line-modal" class="approval-line-modal hidden">
  <div class="approval-line-backdrop"></div>

  <div class="approval-line-dialog" role="dialog" aria-modal="true">
    <div class="approval-line-header">
      <div>
        <div class="title">결재선 설정</div>
        <div class="subtitle" id="approval-line-context">
          결재선을 선택/편집할 수 있습니다.
        </div>
      </div>
      <button type="button" class="close-btn" id="approval-line-close">&times;</button>
    </div>

    <div class="approval-line-body">
      <!-- 왼쪽: 직원 목록 (나중에 구현) -->
      <div class="panel">
        <h3>직원 목록</h3>
        <div id="empList" class="emp-list"></div>
      </div>

      <!-- 오른쪽: 결재선 구성 (나중에 구현) -->
      <div class="panel">
        <h3>결재선 구성</h3>
        <div class="steps">
          <div class="step">
            <div class="step-title">1단계</div>
            <div class="dropzone" data-step="1"></div>
          </div>
          <div class="step">
            <div class="step-title">2단계</div>
            <div class="dropzone" data-step="2"></div>
          </div>
          <div class="step">
            <div class="step-title">3단계</div>
            <div class="dropzone" data-step="3"></div>
          </div>
        </div>
        
        <!-- ✅ admin-common.js가 읽어갈 “선택 결과” -->
        <input type="hidden" id="approval-line-selected-id" value="">
        <input type="hidden" id="approval-line-selected-json" value="">
        <input type="hidden" id="approval-line-selected-name" value="">
      </div>
    </div>

    <div class="approval-line-footer">
      <button type="button" class="btn" id="approval-line-cancel">닫기</button>
      <button type="button" class="btn primary" id="approval-line-save" disabled>
        (추후) 결재선 적용
      </button>
    </div>
  </div>
</div>

<style>
  .approval-line-modal.hidden {
    display: none;
  }
  .approval-line-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
  }
  .approval-line-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
  }
  .approval-line-dialog {
    position: absolute;
    top: 50%;
    left: 50%;
    width: min(720px, 95vw);
    max-height: 90vh;
    transform: translate(-50%, -50%);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
    display: flex;
    flex-direction: column;
  }
  .approval-line-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .approval-line-header .title {
    font-size: 1rem;
    font-weight: 700;
  }
  .approval-line-header .subtitle {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .approval-line-body {
    padding: 0.75rem 1rem;
    display: grid;
    grid-template-columns: 1.1fr 1.2fr;
    gap: 0.75rem;
  }
  .approval-line-body .panel {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #f9fafb;
    min-height: 220px;
    font-size: 0.8rem;
  }
  .approval-line-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .approval-line-footer .btn {
    font-size: 0.8rem;
    padding: 0.35rem 0.9rem;
    border-radius: 9999px;
    border: 1px solid #d1d5db;
    background: #ffffff;
    cursor: pointer;
  }
  .approval-line-footer .btn.primary {
    border-color: #2563eb;
    background: #2563eb;
    color: #ffffff;
  }
  .close-btn {
    border: none;
    background: transparent;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
  }
</style>

<script>
  // ===== 샘플 직원 데이터 (나중에 API로 교체) =====
  const employees = [
    { userId: "EMP001", name: "김치즈", role: "EMP" },
    { userId: "MGR001", name: "김부장", role: "MGR" },
    { userId: "FIN001", name: "이재무", role: "FIN" },
    { userId: "ADM001", name: "박관리", role: "ADMIN" },
  ];

  // ===== 결재선 상태 =====
  const line = { steps: { 1: [], 2: [], 3: [] } };

  // ===== 렌더 =====
  function renderEmployees() {
    const root = document.getElementById("empList");
    root.innerHTML = employees.map(e => `
      <div class="emp-card" draggable="true"
           data-user-id="${e.userId}" data-name="${e.name}" data-role="${e.role}">
        <div class="emp-name">${e.name}</div>
        <div class="emp-meta">${e.userId} · ${e.role}</div>
      </div>
    `).join("");
  }

  function renderDropzones() {
    document.querySelectorAll(".dropzone").forEach(z => {
      const step = z.dataset.step;
      const arr = line.steps[step];

      z.innerHTML = arr.length
        ? arr.map(e => `
            <div class="picked" data-user-id="${e.userId}">
              <span>${e.name} (${e.role})</span>
              <button type="button" class="picked-del" data-step="${step}" data-del="${e.userId}">×</button>
            </div>
          `).join("")
        : `<div class="drop-hint">여기로 드래그</div>`;
    });

    syncHiddenAndSaveState();
  }

  // ===== 중복 방지(1~3단계 전체에서 같은 사람 2번 못 들어가게) =====
  function existsAnywhere(userId) {
    return [1,2,3].some(s => line.steps[s].some(e => e.userId === userId));
  }

  // ===== hidden 값 + 저장 버튼 활성화 =====
  function syncHiddenAndSaveState() {
    const all = [...line.steps[1], ...line.steps[2], ...line.steps[3]];
    const saveBtn = document.getElementById("approval-line-save");

    const canSave = all.length > 0;
    if (saveBtn) saveBtn.disabled = !canSave;

    // name/id/json 생성(일단 기본)
    const lineId = canSave ? "LINE-" + Date.now() : "";
    const lineName = canSave ? "사용자 지정 결재선" : "";
    const json = canSave ? JSON.stringify({
      lineName,
      steps: all.map((e, idx) => ({ order: idx + 1, userId: e.userId, name: e.name, role: e.role }))
    }) : "";

    document.getElementById("approval-line-selected-id").value = lineId;
    document.getElementById("approval-line-selected-name").value = lineName;
    document.getElementById("approval-line-selected-json").value = json;
  }

  // ===== 드래그 시작 =====
  document.addEventListener("dragstart", (e) => {
    const card = e.target.closest(".emp-card");
    if (!card) return;
    e.dataTransfer.setData("text/plain", JSON.stringify({
      userId: card.dataset.userId,
      name: card.dataset.name,
      role: card.dataset.role
    }));
  });

  // ===== 드롭존 이벤트 =====
  document.addEventListener("dragover", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();
  });

  document.addEventListener("drop", (e) => {
    const zone = e.target.closest(".dropzone");
    if (!zone) return;
    e.preventDefault();

    const step = Number(zone.dataset.step);
    const payload = JSON.parse(e.dataTransfer.getData("text/plain") || "{}");
    if (!payload.userId) return;

    if (existsAnywhere(payload.userId)) {
      alert("이미 결재선에 포함된 직원입니다.");
      return;
    }

    line.steps[step].push(payload);
    renderDropzones();
  });

  // ===== 선택 제거 =====
  document.addEventListener("click", (e) => {
    const del = e.target.closest(".picked-del");
    if (!del) return;
    const step = Number(del.dataset.step);
    const userId = del.dataset.del;
    line.steps[step] = line.steps[step].filter(x => x.userId !== userId);
    renderDropzones();
  });

  // 초기 렌더
  renderEmployees();
  renderDropzones();
</script>
