<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>블로그 코드 생성</title>

  <!-- ✅ 공통 CSS -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .bcg-wrap{ padding:14px; }

    .bcg-hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .bcg-title{
      margin:0;
      font-weight:950;
      letter-spacing:-0.2px;
      font-size:18px;
    }
    .bcg-sub{
      margin:6px 0 0;
      color:rgba(15,23,42,.72);
      line-height:1.45;
      font-size:13px;
    }

    .bcg-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .bcg-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .bcg-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .bcg-row:first-child{ margin-top:0; }

    .bcg-label{
      font-weight:900;
      font-size:12px;
      color:rgba(15,23,42,.78);
    }

    .bcg-input, .bcg-select, .bcg-textarea{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.18);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .bcg-input{ min-width:240px; flex:1; }
    .bcg-select{ min-width:110px; }
    .bcg-textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      line-height:1.55;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "맑은 고딕", sans-serif;
    }

    .bcg-output{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,0.26);
      border-radius:12px;
      background:rgba(15,23,42,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.55;
      white-space:pre;
    }

    .bcg-btn{
      border:1px solid rgba(15,23,42,0.16);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition:transform .06s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      user-select:none;
    }
    .bcg-btn:active{ transform:translateY(1px); box-shadow:0 5px 12px rgba(15,23,42,0.10); }
    .bcg-btn:hover{ background:rgba(15,23,42,0.02); border-color:rgba(15,23,42,0.22); }

    .bcg-btn--primary{
      border-color:rgba(37,99,235,0.38);
      box-shadow:0 10px 20px rgba(37,99,235,0.14);
    }
    .bcg-btn--primary:hover{ background:rgba(37,99,235,0.06); border-color:rgba(37,99,235,0.55); }

    .bcg-btn--danger{
      border-color:rgba(239,68,68,0.30);
      box-shadow:0 10px 20px rgba(239,68,68,0.10);
    }
    .bcg-btn--danger:hover{ background:rgba(239,68,68,0.06); border-color:rgba(239,68,68,0.48); }

    .bcg-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      font-size:12px;
      color:rgba(15,23,42,.72);
    }

    .bcg-toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:9999;
      max-width:min(420px, calc(100vw - 32px));
      background:rgba(15,23,42,0.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
      font-size:13px;
      line-height:1.35;
      transform:translateY(10px);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .bcg-toast.show{ opacity:1; transform:translateY(0); }

    .bcg-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .bcg-split{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .bcg-split{ grid-template-columns:1fr; }
    }

    .bcg-muted{
      color:rgba(15,23,42,.62);
      font-size:12px;
    }

    .bcg-sep{
      height:1px;
      background:rgba(15,23,42,0.10);
      margin:12px 0;
    }

    .bcg-mini{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      box-shadow:none;
    }

    .bcg-badge{
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:rgba(15,23,42,0.02);
    }

    .bcg-right{ margin-left:auto; }

    .bcg-check{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:rgba(15,23,42,.72);
      user-select:none;
    }
    .bcg-check input{ width:16px; height:16px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- 헤더 슬롯 -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- 본문 -->
      <main class="admin-content">
        <div class="bcg-wrap">

          <div class="bcg-card">
            <div class="bcg-hero">
              <div>
                <h1 class="bcg-title">블로그 코드 생성</h1>
                <p class="bcg-sub">
                  소제목(H1/H2/H3) + 본문을 넣으면, <b>바로 포스트 관리(BODY_1/2/3 등)에 붙여넣을 수 있는 HTML</b>로 변환해줘.
                  본문 블록은 원하는 만큼 추가할 수 있고, <b>각 블록마다 결과를 따로 복사</b>할 수 있어.
                </p>
              </div>

              <div class="bcg-actions">
                <span class="bcg-pill" id="blockCountPill">블록 0개</span>
                <button class="bcg-btn bcg-btn--primary" id="addBlockBtn" type="button">＋ 블록 추가</button>
              </div>
            </div>

            <div class="bcg-sep"></div>

            <div class="bcg-grid" id="blocks"></div>

            <div class="bcg-sep"></div>

            <div class="bcg-row">
              <span class="bcg-muted">
                ※ 변환 규칙: 빈 줄 기준으로 문단 분리(<code>&lt;p&gt;</code>), 문단 내부 줄바꿈은 <code>&lt;br&gt;</code> 처리. 기본은 HTML 이스케이프(안전).
              </span>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <div class="bcg-toast" id="toast"></div>

  <!-- ✅ 공통 JS (헤더/메뉴 슬롯 채움) -->
  <script src="./admin-common.js"></script>

  <script>
    (function(){
      const elBlocks = document.getElementById("blocks");
      const addBtn = document.getElementById("addBlockBtn");
      const pill = document.getElementById("blockCountPill");
      const toast = document.getElementById("toast");

      let seq = 0;

      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // 빈 줄 기준 문단 분리 → <p>..</p>, 문단 내부 줄바꿈은 <br>
      function textToParagraphHtml(text){
        const raw = String(text ?? "").replace(/\r\n/g, "\n");
        const blocks = raw
          .split(/\n{2,}/g)              // 2줄 이상 빈줄 = 문단 분리
          .map(p => p.trim())
          .filter(Boolean);

        if (blocks.length === 0) return "";

        return blocks.map(p => {
          const lines = p.split("\n").map(l => l.trimEnd());
          const joined = lines.map(line => escapeHtml(line)).join("<br>\n");
          return `<p>${joined}</p>`;
        }).join("\n");
      }

      async function copyToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          return true;
        }catch(e){
          // fallback
          try{
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            ta.style.top = "0";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return ok;
          }catch(e2){
            return false;
          }
        }
      }

      function updatePill(){
        const n = elBlocks.querySelectorAll("[data-bcg-block]").length;
        pill.textContent = `블록 ${n}개`;
      }

      function buildHtml({level, heading, body, keepRawHtml}){
        const tag = (level === "h1" || level === "h2" || level === "h3") ? level : "h2";
        const headText = keepRawHtml ? String(heading ?? "").trim() : escapeHtml(String(heading ?? "").trim());
        let bodyHtml = "";

        if (keepRawHtml){
          // 사용자가 HTML을 붙여넣을 수 있는 모드: 그대로 사용 (최소 트림)
          bodyHtml = String(body ?? "").trim();
        }else{
          bodyHtml = textToParagraphHtml(body);
        }

        // 소제목이 비었으면 본문만 반환 (유연하게)
        const headPart = headText ? `<${tag}>${headText}</${tag}>` : "";
        const parts = [headPart, bodyHtml].filter(Boolean);
        return parts.join("\n");
      }

      function createBlock(){
        seq += 1;
        const id = "bcg_" + seq;

        const wrap = document.createElement("div");
        wrap.className = "bcg-card";
        wrap.setAttribute("data-bcg-block", id);

        wrap.innerHTML = `
          <div class="bcg-row">
            <span class="bcg-badge">블록 #${seq}</span>

            <div class="bcg-right bcg-row" style="margin-top:0;">
              <label class="bcg-check" title="체크하면 입력한 내용을 HTML로 그대로 사용해요(이스케이프/문단 변환 없음).">
                <input type="checkbox" data-keep-raw />
                HTML 그대로
              </label>
              <button class="bcg-btn bcg-mini" type="button" data-generate>코드 생성</button>
              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-copy>복사</button>
              <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-remove>삭제</button>
            </div>
          </div>

          <div class="bcg-split" style="margin-top:10px;">
            <div>
              <div class="bcg-row">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <span class="bcg-label">소제목 레벨</span>
                    <select class="bcg-select" data-level>
                      <option value="h1">H1</option>
                      <option value="h2" selected>H2</option>
                      <option value="h3">H3</option>
                    </select>
                  </div>

                  <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:260px;">
                    <span class="bcg-label">소제목 텍스트</span>
                    <input class="bcg-input" data-heading placeholder="예) 숙종의 환국정치, 가계도 흐름 정리" />
                  </div>
                </div>
              </div>

              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">본문(원문 붙여넣기)</span>
                  <textarea class="bcg-textarea" data-body placeholder="여기에 블로그 원문을 붙여넣어.&#10;빈 줄은 문단으로 처리돼."></textarea>
                  <div class="bcg-muted">팁) 포스트 관리에서 BODY_1/2/3로 나눌 거면, 여기서 블록을 그 개수만큼 만들어서 각각 생성/복사하면 돼.</div>
                </div>
              </div>
            </div>

            <div>
              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">생성된 HTML</span>
                  <textarea class="bcg-output" data-output readonly placeholder="여기에 결과 HTML이 생성돼."></textarea>
                  <div class="bcg-muted">‘복사’ 버튼을 누르면 이 블록 결과만 클립보드로 복사돼.</div>
                </div>
              </div>
            </div>
          </div>
        `;

        // wire events
        const levelEl = wrap.querySelector("[data-level]");
        const headingEl = wrap.querySelector("[data-heading]");
        const bodyEl = wrap.querySelector("[data-body]");
        const outEl = wrap.querySelector("[data-output]");
        const keepRawEl = wrap.querySelector("[data-keep-raw]");

        const btnGen = wrap.querySelector("[data-generate]");
        const btnCopy = wrap.querySelector("[data-copy]");
        const btnRemove = wrap.querySelector("[data-remove]");

        function regenerate(){
          const html = buildHtml({
            level: levelEl.value,
            heading: headingEl.value,
            body: bodyEl.value,
            keepRawHtml: keepRawEl.checked
          });
          outEl.value = html;
        }

        btnGen.addEventListener("click", () => {
          regenerate();
          showToast("코드를 생성했어.");
        });

        btnCopy.addEventListener("click", async () => {
          // 자동 생성 안 했을 수도 있으니 복사 전에 생성
          if (!outEl.value.trim()) regenerate();
          const ok = await copyToClipboard(outEl.value);
          showToast(ok ? "복사 완료!" : "복사 실패(브라우저 권한을 확인해줘).");
        });

        btnRemove.addEventListener("click", () => {
          wrap.remove();
          updatePill();
          showToast("블록을 삭제했어.");
        });

        // 입력 시 자동 갱신(너무 무겁지 않게 간단 디바운스)
        let t = null;
        function schedule(){
          clearTimeout(t);
          t = setTimeout(regenerate, 180);
        }
        levelEl.addEventListener("change", schedule);
        headingEl.addEventListener("input", schedule);
        bodyEl.addEventListener("input", schedule);
        keepRawEl.addEventListener("change", schedule);

        // 초기 1회 생성
        regenerate();

        return wrap;
      }

      addBtn.addEventListener("click", () => {
        elBlocks.appendChild(createBlock());
        updatePill();
        showToast("새 블록을 추가했어.");
      });

      // 첫 블록 1개 기본 생성
      elBlocks.appendChild(createBlock());
      updatePill();
    })();
  </script>
</body>
</html>
