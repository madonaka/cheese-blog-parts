<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</title>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .bcg-wrap{ padding:14px; padding-bottom: 80px; /* í•˜ë‹¨ ë°” ê³µê°„ í™•ë³´ */ }

    .bcg-hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .bcg-title{
      margin:0;
      font-weight:950;
      letter-spacing:-0.2px;
      font-size:18px;
    }
    .bcg-sub{
      margin:6px 0 0;
      color:rgba(15,23,42,.72);
      line-height:1.45;
      font-size:13px;
    }
    
    .bcg-version {
      margin-top: 8px;
      font-size: 16px; 
      font-weight: 800;
      color: #334155;
      background: rgba(15,23,42,0.03);
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.06);
    }

    .bcg-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .bcg-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
      position: relative;
    }

    /* ë§ˆì§€ë§‰ ë¸”ë¡ ê°•ì¡° */
    .bcg-card:last-child {
      border-color: rgba(37,99,235,0.4);
    }

    .bcg-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .bcg-row:first-child{ margin-top:0; }

    .bcg-label{
      font-weight:900;
      font-size:12px;
      color:rgba(15,23,42,.78);
    }

    .bcg-input, .bcg-select, .bcg-textarea{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.18);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .bcg-input{ min-width:240px; flex:1; }
    .bcg-select{ min-width:110px; }
    .bcg-textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      line-height:1.55;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "ë§‘ì€ ê³ ë”•", sans-serif;
    }

    .bcg-output{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,0.26);
      border-radius:12px;
      background:rgba(15,23,42,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.55;
      white-space:pre;
    }

    .bcg-preview{
      width:100%;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      padding:12px;
      background:#fff;
      box-shadow:0 8px 18px rgba(15,23,42,0.06);
      min-height:64px;
      overflow:auto;
    }
    .bcg-preview h1, .bcg-preview h2, .bcg-preview h3{
      margin:0 0 10px;
      line-height:1.25;
    }
    .bcg-preview p{ margin:0 0 10px; line-height:1.6; }
    .bcg-preview p:last-child{ margin-bottom:0; }
    .bcg-preview-empty{
      color:rgba(15,23,42,.55);
      font-size:12px;
    }

    /* Footnote Preview Style */
    .bcg-preview .cheese-footnotes {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      padding-left: 20px;
      font-size: 0.9em;
      color: #555;
    }
    .bcg-preview .cheese-footnote-ref {
      color: #2563eb;
      font-size: 0.8em;
      vertical-align: super;
      text-decoration: none;
    }

    .bcg-btn{
      border:1px solid rgba(15,23,42,0.16);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition:transform .06s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      user-select:none;
    }
    .bcg-btn:active{ transform:translateY(1px); box-shadow:0 5px 12px rgba(15,23,42,0.10); }
    .bcg-btn:hover{ background:rgba(15,23,42,0.02); border-color:rgba(15,23,42,0.22); }

    .bcg-btn--primary{
      border-color:rgba(37,99,235,0.38);
      box-shadow:0 10px 20px rgba(37,99,235,0.14);
      color: #1e40af;
      background: #eff6ff;
    }
    .bcg-btn--primary:hover{ background:rgba(37,99,235,0.1); border-color:rgba(37,99,235,0.55); }

    .bcg-btn--danger{
      border-color:rgba(239,68,68,0.30);
      box-shadow:0 10px 20px rgba(239,68,68,0.10);
      color: #991b1b;
      background: #fef2f2;
    }
    .bcg-btn--danger:hover{ background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.48); }
    
    .bcg-btn--dark {
        background: #1e293b;
        color: #fff;
        border-color: #0f172a;
    }
    .bcg-btn--dark:hover { background: #334155; }

    .bcg-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      font-size:12px;
      color:rgba(15,23,42,.72);
    }

    .bcg-toast{
      position:fixed;
      right:16px;
      bottom:90px;
      z-index:9999;
      max-width:min(420px, calc(100vw - 32px));
      background:rgba(15,23,42,0.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
      font-size:13px;
      line-height:1.35;
      transform:translateY(10px);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .bcg-toast.show{ opacity:1; transform:translateY(0); }

    .bcg-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .bcg-split{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .bcg-split{ grid-template-columns:1fr; }
    }

    .bcg-muted{
      color:rgba(15,23,42,.62);
      font-size:12px;
    }

    .bcg-sep{
      height:1px;
      background:rgba(15,23,42,0.10);
      margin:12px 0;
    }

    .bcg-mini{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      box-shadow:none;
    }

    .bcg-badge{
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:rgba(15,23,42,0.02);
    }

    .bcg-right{ margin-left:auto; }

    .bcg-check{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:rgba(15,23,42,.72);
      user-select:none;
    }
    .bcg-check input{ width:16px; height:16px; }
    .bcg-toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:6px 0 8px;
    }
    .bcg-pill input[type="color"]{
      width:34px;
      height:20px;
      padding:0;
      border:0;
      background:transparent;
      cursor:pointer;
    }
    .bcg-pill input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; }
    .bcg-pill input[type="color"]::-webkit-color-swatch{
      border:1px solid rgba(15,23,42,0.18);
      border-radius:6px;
    }
    
    /* Global Footnote Bar */
    .bcg-global-foot {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid rgba(15,23,42,0.14);
        padding: 12px 20px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 1000;
        flex-wrap: wrap;
    }
    .bcg-global-foot-info {
        font-weight: 800;
        color: #334155;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .bcg-global-foot-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
    }

    /* Quick Swatches */
    .bcg-swatches{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-left:8px;
      vertical-align:middle;
      flex-wrap:wrap;
    }
    .bcg-swatch{
      width:18px;
      height:18px;
      border-radius:7px;
      border:1px solid rgba(15,23,42,0.18);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(15,23,42,0.10);
      padding:0;
    }
    .bcg-swatch:active{ transform:translateY(1px); }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="bcg-wrap">

          <div class="bcg-card">
            <div class="bcg-hero">
              <div>
                <h1 class="bcg-title">ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</h1>
                <p class="bcg-sub">
                  ì†Œì œëª©(H1/H2/H3) + ë³¸ë¬¸ì„ ë„£ìœ¼ë©´, <b>ë°”ë¡œ í¬ìŠ¤íŠ¸ ê´€ë¦¬(BODY_1/2/3 ë“±)ì— ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” HTML</b>ë¡œ ë³€í™˜í•´ì¤˜.
                  ë³¸ë¬¸ ë¸”ë¡ì€ ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€í•  ìˆ˜ ìˆê³ , <b>ê° ë¸”ë¡ë§ˆë‹¤ ê²°ê³¼ë¥¼ ë”°ë¡œ ë³µì‚¬</b>í•  ìˆ˜ ìˆì–´.
                </p>
                <div id="sysVersion" class="bcg-version"></div>
              </div>

              <div class="bcg-actions">
                <span class="bcg-pill" id="blockCountPill">ë¸”ë¡ 0ê°œ</span>
                <button class="bcg-btn bcg-btn--primary" id="addBlockBtn" type="button">ï¼‹ ë¸”ë¡ ì¶”ê°€</button>
              </div>
            </div>

            <div class="bcg-sep"></div>

            <div class="bcg-grid" id="blocks"></div>

            <div class="bcg-sep"></div>

            <div class="bcg-row">
              <span class="bcg-muted">
                â€» ì£¼ì„ ê¸°ëŠ¥: ê° ë¸”ë¡ì—ì„œ ì£¼ì„ì„ ì¶”ê°€í•˜ë©´, í•˜ë‹¨ <b>[ì „ì²´ ì£¼ì„ ê´€ë¦¬]</b> ë°”ì— ìë™ìœ¼ë¡œ ëª¨ì…ë‹ˆë‹¤. 
                ëª©ë¡ì€ ë§ˆì§€ë§‰ì— í•œ ë²ˆë§Œ ë¶™ì—¬ë„£ê±°ë‚˜, 'ë§ˆì§€ë§‰ ë¸”ë¡ì— ìë™ ì²¨ë¶€'ë¥¼ ì¼œì„œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </span>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <div class="bcg-global-foot">
    <div class="bcg-global-foot-info">
        <span>ğŸ“ ì „ì²´ ì£¼ì„: <span id="globalFnCount" style="color:#2563eb;">0</span>ê°œ</span>
    </div>
    <div class="bcg-global-foot-controls">
        <label class="bcg-check">
            <input type="checkbox" id="autoAppendLastFn" checked>
            ë§ˆì§€ë§‰ ë¸”ë¡ ì½”ë“œì— ëª©ë¡ ìë™ í¬í•¨
        </label>
        <div style="width:1px; height:16px; background:#cbd5e1; margin:0 4px;"></div>
        <button class="bcg-btn bcg-mini bcg-btn--dark" id="copyAllFnBtn" type="button">ì£¼ì„ ëª©ë¡ë§Œ ë³µì‚¬</button>
    </div>
  </div>
  
  <div class="bcg-modal-backdrop" id="tableModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" role="dialog" aria-modal="true" aria-labelledby="tableModalTitle">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title" id="tableModalTitle">í‘œ ë§Œë“¤ê¸°</h3>
        <span class="bcg-muted">ì…€ì„ ì±„ìš°ê³  â€œì‚½ì…â€ì„ ëˆ„ë¥´ë©´ ë³¸ë¬¸ì— í‘œ HTMLì´ ë“¤ì–´ê°€.</span>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="tableModalCloseBtn">ë‹«ê¸°</button>
      </div>
      <div class="bcg-modal-body">
        <div class="bcg-modal-grid">
          <div class="bcg-table-controls">
            <div class="bcg-field"><span class="bcg-label">í–‰</span><input class="bcg-input bcg-num" id="tblRows" type="number" min="1" max="30" value="3"></div>
            <div class="bcg-field"><span class="bcg-label">ì—´</span><input class="bcg-input bcg-num" id="tblCols" type="number" min="1" max="12" value="3"></div>
            <div class="bcg-field"><span class="bcg-label">ì˜µì…˜</span><label class="bcg-check" style="margin-top:4px;"><input type="checkbox" id="tblHeader" checked> ì²« ì¤„ì„ í—¤ë”(th)ë¡œ</label></div>
            <div class="bcg-field" style="min-width:240px; flex:1;"><span class="bcg-label">ìº¡ì…˜</span><input class="bcg-input" id="tblCaption" placeholder="ì˜ˆ) ì‹œëŒ€ë³„ ì™•ìœ„ ê³„ìŠ¹ ì •ë¦¬"></div>
            <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" id="tblRebuildBtn">ê·¸ë¦¬ë“œ ìƒì„±</button>
          </div>
          <div class="bcg-table-editor">
            <div class="bcg-table-cells" id="tblCells"></div>
          </div>
        </div>
      </div>
      <div class="bcg-modal-foot"><button class="bcg-btn bcg-mini" type="button" id="tblInsertBtn">ì‚½ì…</button></div>
    </div>
  </div>

  <div class="bcg-toast" id="toast"></div>

  <script src="./admin-common.js"></script>

  <script>
    (function(){
      // URL íƒ€ê²Ÿ í™•ì¸ ë° íŒì—… ëª¨ë“œ ì„¤ì •
      const urlParams = new URLSearchParams(window.location.search);
      const currentTarget = urlParams.get('target') || "";

      if (currentTarget) {
        const titleEl = document.querySelector(".bcg-title");
        if(titleEl) titleEl.innerHTML += ` <span class="bcg-badge" style="color:#0284c7; background:#e0f2fe; vertical-align:middle; font-size:13px;">ğŸ¯ íƒ€ê²Ÿ: ${currentTarget}</span>`;
        
        const header = document.getElementById("admin-header-slot");
        const menu = document.getElementById("admin-menu-slot");
        const main = document.querySelector(".admin-main");

        if (header) header.style.display = "none";
        if (menu) menu.style.display = "none";
        if (main) {
          main.style.display = "block";
          main.style.padding = "0";
          main.style.height = "auto";
        }
        document.body.style.backgroundColor = "#fff";
        
        const addBtnEl = document.getElementById("addBlockBtn");
        const pillEl = document.getElementById("blockCountPill");
        if (addBtnEl) addBtnEl.style.display = "none";
        if (pillEl) pillEl.style.display = "none";
      }

      const elBlocks = document.getElementById("blocks");
      const addBtn = document.getElementById("addBlockBtn");
      const pill = document.getElementById("blockCountPill");
      const toast = document.getElementById("toast");

      // Global Footnote Controls
      const globalFnCountEl = document.getElementById("globalFnCount");
      const autoAppendLastFnEl = document.getElementById("autoAppendLastFn");
      const copyAllFnBtn = document.getElementById("copyAllFnBtn");

      // Table Builder Elements
      const tableModal = document.getElementById("tableModal");
      const tableModalCloseBtn = document.getElementById("tableModalCloseBtn");
      const tblRowsEl = document.getElementById("tblRows");
      const tblColsEl = document.getElementById("tblCols");
      const tblHeaderEl = document.getElementById("tblHeader");
      const tblCaptionEl = document.getElementById("tblCaption");
      const tblRebuildBtn = document.getElementById("tblRebuildBtn");
      const tblCellsEl = document.getElementById("tblCells");
      const tblInsertBtn = document.getElementById("tblInsertBtn");

      let seq = 0;
      let tableCtx = null;

      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
      }

      function clampInt_(v, min, max, fallback){
        const n = parseInt(v, 10);
        if (!Number.isFinite(n)) return fallback;
        return Math.max(min, Math.min(max, n));
      }

      function escapeHtmlLite(s){
        return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function protectAllowedTags_(s){
        const src = String(s ?? "");
        const map = [];
        const re = /<\/?(?:strong|em|u|s)\s*>|<br\s*\/?>|<mark\s+style="background:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/mark>|<span\s+style="color:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/span>|<table\s+class="cheese-table"\s*>|<\/table>|<thead\s*>|<\/thead>|<tbody\s*>|<\/tbody>|<tr\s*>|<\/tr>|<th\s*>|<\/th>|<td\s*>|<\/td>|<caption\s*>|<\/caption>|<a\s+[^>]*cheese-footnote-ref[^>]*>.*?<\/a>/gi;
        const out = src.replace(re, (m)=>{
          const key = `@@ALLOWED_TAG_${map.length}@@`;
          map.push(m);
          return key;
        });
        return { out, map };
      }

      function restoreAllowedTags_(s, map){
        let out = String(s ?? "");
        (map || []).forEach((tag, i)=>{ out = out.split(`@@ALLOWED_TAG_${i}@@`).join(tag); });
        return out;
      }

      function escapeText_(s, allowTags){
        if (!allowTags) return escapeHtmlLite(s);
        const { out, map } = protectAllowedTags_(s);
        const escaped = escapeHtmlLite(out);
        return restoreAllowedTags_(escaped, map);
      }

      function textToParagraphHtml(text, allowTags) {
        const raw = String(text ?? "").replace(/\r\n/g, "\n").replace(/\u200B/g, '');
        const chunks = raw.split(/\n{2,}/g); 
        if (chunks.length === 0) return "";
        return chunks.map(chunk => {
          const trimmedChunk = chunk.trim();
          if (allowTags && /^<table\b/i.test(trimmedChunk) && /<\/table>\s*$/i.test(trimmedChunk)) {
            return escapeText_(trimmedChunk, allowTags);
          }
          const brOnlyRegex = /^(<br\s*\/?>)+$/i;
          if (brOnlyRegex.test(trimmedChunk.replace(/\s/g, ''))) return trimmedChunk; 
          
          const lines = chunk.split("\n").map(l => l.trimEnd());
          let processedLines = [];
          for (let i = 0; i < lines.length; i++) {
            let escaped = escapeText_(lines[i], allowTags);
            if (i < lines.length - 1) {
              if (/<br\s*\/?>$/i.test(escaped.trim())) processedLines.push(escaped);
              else processedLines.push(escaped + "<br>");
            } else {
              processedLines.push(escaped.replace(/<br\s*\/?>$/i, ""));
            }
          }
          const content = processedLines.filter(line => line.length > 0).join("\n");
          return content ? `<p>${content}</p>` : "<br>";
        }).join("\n");
      }
      
      function wrapSelection(textarea, left, right){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0, e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        if (s === e){
          textarea.value = v.slice(0, s) + left + right + v.slice(e);
          const pos = s + left.length;
          textarea.setSelectionRange(pos, pos);
        } else {
          textarea.value = v.slice(0, s) + left + v.slice(s, e) + right + v.slice(e);
          textarea.setSelectionRange(s + left.length, e + left.length);
        }
        textarea.focus();
      }

      function insertAtSelection(textarea, insertText){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0, e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        textarea.value = v.slice(0, s) + insertText + v.slice(e);
        const pos = s + String(insertText).length;
        textarea.setSelectionRange(pos, pos);
        textarea.focus();
      }

      function copyToClipboard(text){
        return navigator.clipboard.writeText(text).then(()=>true).catch(()=>{
          try{
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return ok;
          }catch(e){ return false; }
        });
      }

      /* ==========================
         Global Footnote Logic
      ========================== */
      function getAllFootnotes() {
        const blocks = elBlocks.querySelectorAll("[data-bcg-block]");
        let all = [];
        blocks.forEach(b => {
            if (b.bcgData && b.bcgData.footnotes) {
                all = all.concat(b.bcgData.footnotes);
            }
        });
        return all;
      }

      function generateFootnoteListHtml(footnotes, startIdx=1) {
        if (!footnotes || footnotes.length === 0) return "";
        let html = '\n\n<hr>\n<ol class="cheese-footnotes">';
        footnotes.forEach((note, i) => {
            const idx = startIdx + i;
            html += `\n  <li id="fn${idx}">\n    <a href="#fn${idx}-ref" class="cheese-footnote-index">*${idx}</a>\n    ${escapeHtmlLite(note)}\n  </li>`;
        });
        html += '\n</ol>';
        return html;
      }

      function updateGlobalFootnoteUI() {
        const all = getAllFootnotes();
        globalFnCountEl.textContent = all.length;
        triggerAllBlocksRegen();
      }

      function triggerAllBlocksRegen() {
        const blocks = elBlocks.querySelectorAll("[data-bcg-block]");
        blocks.forEach(b => {
            if (b.bcgRegenerate) b.bcgRegenerate();
        });
      }

      copyAllFnBtn.addEventListener("click", () => {
        const all = getAllFootnotes();
        if (all.length === 0) return showToast("ì €ì¥ëœ ì£¼ì„ì´ ì—†ì–´.");
        const html = generateFootnoteListHtml(all);
        copyToClipboard(html).then(ok => showToast(ok ? "ì „ì²´ ì£¼ì„ ëª©ë¡ ë³µì‚¬ ì™„ë£Œ!" : "ë³µì‚¬ ì‹¤íŒ¨"));
      });
      
      autoAppendLastFnEl.addEventListener("change", triggerAllBlocksRegen);

      /* ==========================
         Block Logic
      ========================== */
      function updatePill(){
        const n = elBlocks.querySelectorAll("[data-bcg-block]").length;
        pill.textContent = `ë¸”ë¡ ${n}ê°œ`;
        updateGlobalFootnoteUI();
      }

      function buildHtml({level, heading, body, allowTags, myFootnotes, myBlockIndex, isLastBlock}){
        const tag = (level === "h1" || level === "h2" || level === "h3") ? level : "h2";
        const headText = escapeHtmlLite(String(heading ?? "").trim());
        const bodyHtml = textToParagraphHtml(body, !!allowTags);
        const headPart = headText ? `<${tag}>${headText}</${tag}>` : "";
        
        const parts = [headPart, bodyHtml].filter(Boolean);

        // ë§ˆì§€ë§‰ ë¸”ë¡ì´ê³ , ìë™ ì²¨ë¶€ ì˜µì…˜ì´ ì¼œì ¸ìˆìœ¼ë©´ ì „ì²´ ëª©ë¡ ì¶”ê°€
        if (isLastBlock && autoAppendLastFnEl.checked) {
            const allFn = getAllFootnotes();
            if (allFn.length > 0) {
                parts.push(generateFootnoteListHtml(allFn));
            }
        }

        return parts.join("\n");
      }

      function createBlock(){
        seq += 1;
        const id = "bcg_" + seq;
        const wrap = document.createElement("div");
        wrap.className = "bcg-card";
        wrap.setAttribute("data-bcg-block", id);
        
        // ë°ì´í„° ì €ì¥ì†Œ
        wrap.bcgData = { footnotes: [] };

        wrap.innerHTML = `
          <div class="bcg-row">
            <span class="bcg-badge">ë¸”ë¡ #${seq}</span>
            <div class="bcg-right bcg-row" style="margin-top:0;">
              <label class="bcg-check">
                <input type="checkbox" data-keep-raw />
                ì„œì‹/íƒœê·¸ í—ˆìš©
              </label>
              <button class="bcg-btn bcg-mini" type="button" data-generate>ì½”ë“œ ìƒì„±</button>
              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-send>ê´€ë¦¬ìë¡œ ì „ì†¡ ğŸš€</button>
              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-copy>ë³µì‚¬</button>
              <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-remove>ì‚­ì œ</button>
            </div>
          </div>
          <div class="bcg-split" style="margin-top:10px;">
            <div>
              <div class="bcg-row">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <span class="bcg-label">ì†Œì œëª©</span>
                    <select class="bcg-select" data-level><option value="h1">H1</option><option value="h2" selected>H2</option><option value="h3">H3</option></select>
                  </div>
                  <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                    <span class="bcg-label">ì†Œì œëª© í…ìŠ¤íŠ¸</span>
                    <input class="bcg-input" data-heading placeholder="ì˜ˆ) ìˆ™ì¢…ì˜ í™˜êµ­ì •ì¹˜" />
                  </div>
                </div>
              </div>
              
              <div class="bcg-row" style="background:rgba(15,23,42,0.02); padding:8px 10px; border-radius:8px;">
                <span class="bcg-label">ì£¼ì„:</span>
                <span class="bcg-muted" data-fn-status>ì´ ë¸”ë¡ 0ê°œ</span>
                <span class="bcg-muted" style="margin-left:auto; font-size:11px;">â€» ì‹œì‘ ë²ˆí˜¸: <b data-start-idx-view>-</b></span>
                <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-fn-reset style="padding:2px 8px; font-size:11px; margin-left:8px;">ì´ˆê¸°í™”</button>
              </div>

              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">ë³¸ë¬¸</span>
                  <div style="display:flex; flex-direction:column; gap:10px; margin:10px 0;">
                    <div style="display:flex; gap:8px; align-items:center;">
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bold">êµµê²Œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="br">ì¤„ë°”ê¿ˆ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="table">í‘œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="footnote" style="color:#2563eb; border-color:#bfdbfe; background:#eff6ff;">ì£¼ì„(Fn)</button>
                    </div>
                    
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ê¸€ììƒ‰ <input type="color" data-color value="#111827" /></span>
                      <span class="bcg-swatches" data-color-swatches>
                        <button class="bcg-swatch" type="button" data-color-preset="#111827" title="ê¸°ë³¸(ê²€ì •)" style="background:#111827;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#475569" title="íšŒìƒ‰" style="background:#475569;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#2563eb" title="íŒŒë‘" style="background:#2563eb;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#16a34a" title="ì´ˆë¡" style="background:#16a34a;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#d97706" title="ì£¼í™©" style="background:#d97706;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#e11d48" title="ë¹¨ê°•" style="background:#e11d48;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="color">ì ìš©</button>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ë°°ê²½ <input type="color" data-bg value="#fde68a" /></span>
                      <span class="bcg-swatches" data-bg-swatches>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fde68a" title="ë…¸ë‘" style="background:#fde68a;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fecdd3" title="í•‘í¬" style="background:#fecdd3;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bfdbfe" title="í•˜ëŠ˜" style="background:#bfdbfe;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bbf7d0" title="ì—°ë‘" style="background:#bbf7d0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#e2e8f0" title="ì—°íšŒìƒ‰" style="background:#e2e8f0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#ddd6fe" title="ì—°ë³´ë¼" style="background:#ddd6fe;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bg">ì ìš©</button>
                    </div>

                  </div>
                  <textarea class="bcg-textarea" data-body placeholder="ì—¬ê¸°ì— ë¸”ë¡œê·¸ ì›ë¬¸ì„ ë¶™ì—¬ë„£ì–´."></textarea>
                </div>
              </div>
            </div>
            <div>
              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">ìƒì„±ëœ HTML <span class="bcg-muted" data-is-last-msg style="display:none; color:#2563eb;">(ëª©ë¡ í¬í•¨ë¨)</span></span>
                  <textarea class="bcg-output" data-output readonly></textarea>
                  <div class="bcg-preview" data-preview></div>
                </div>
              </div>
            </div>
          </div>
        `;

        const levelEl = wrap.querySelector("[data-level]");
        const headingEl = wrap.querySelector("[data-heading]");
        const bodyEl = wrap.querySelector("[data-body]");
        const outEl = wrap.querySelector("[data-output]");
        const prevEl = wrap.querySelector("[data-preview]");
        const keepRawEl = wrap.querySelector("[data-keep-raw]");
        
        const fnStatusEl = wrap.querySelector("[data-fn-status]");
        const fnStartIdxView = wrap.querySelector("[data-start-idx-view]");
        const fnResetBtn = wrap.querySelector("[data-fn-reset]");
        const lastMsgEl = wrap.querySelector("[data-is-last-msg]");

        const btnGen = wrap.querySelector("[data-generate]");
        const btnCopy = wrap.querySelector("[data-copy]");
        const btnRemove = wrap.querySelector("[data-remove]");
        const btnSend = wrap.querySelector("[data-send]");
        
        // ìƒ‰ìƒ ê´€ë ¨ ì—˜ë¦¬ë¨¼íŠ¸
        const colorEl = wrap.querySelector("[data-color]");
        const bgEl = wrap.querySelector("[data-bg]");

        function getMyStartIndex() {
            const allBlocks = Array.from(elBlocks.querySelectorAll("[data-bcg-block]"));
            const myIndex = allBlocks.indexOf(wrap);
            if (myIndex < 0) return 1;
            
            let count = 0;
            for(let i=0; i<myIndex; i++) {
                const b = allBlocks[i];
                if(b.bcgData && b.bcgData.footnotes) count += b.bcgData.footnotes.length;
            }
            return count + 1;
        }

        function regenerate(){
            const myStartIdx = getMyStartIndex();
            fnStartIdxView.textContent = myStartIdx;
            fnStatusEl.textContent = `ì´ ë¸”ë¡ ${wrap.bcgData.footnotes.length}ê°œ`;
            
            // ë§ˆì§€ë§‰ ë¸”ë¡ì¸ì§€ í™•ì¸
            const allBlocks = elBlocks.querySelectorAll("[data-bcg-block]");
            const isLast = (allBlocks.length > 0 && allBlocks[allBlocks.length-1] === wrap);
            
            if (isLast && autoAppendLastFnEl.checked && getAllFootnotes().length > 0) {
                lastMsgEl.style.display = "inline";
            } else {
                lastMsgEl.style.display = "none";
            }

            const html = buildHtml({
                level: levelEl.value,
                heading: headingEl.value,
                body: bodyEl.value,
                allowTags: keepRawEl.checked,
                myFootnotes: wrap.bcgData.footnotes,
                myBlockIndex: myStartIdx,
                isLastBlock: isLast
            });
            outEl.value = html;
            if (prevEl) prevEl.innerHTML = html.trim() ? html : '<div class="bcg-preview-empty">ë¯¸ë¦¬ë³´ê¸°</div>';
            
            // ê¸€ë¡œë²Œ UI ì—…ë°ì´íŠ¸ (ì¬ê·€ í˜¸ì¶œ ë°©ì§€)
            globalFnCountEl.textContent = getAllFootnotes().length;
        }
        
        wrap.bcgRegenerate = regenerate;

        btnGen.addEventListener("click", () => { regenerate(); showToast("ì½”ë“œë¥¼ ìƒì„±í–ˆì–´."); });
        btnCopy.addEventListener("click", async () => {
          if (!outEl.value.trim()) regenerate();
          await copyToClipboard(outEl.value);
          showToast("ë³µì‚¬ ì™„ë£Œ!");
        });
        
        btnSend.addEventListener("click", () => {
          if (!outEl.value.trim()) regenerate(); 
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ type: 'CH_BLOG_CODE', content: outEl.value, target: currentTarget }, '*');
            showToast(`ğŸš€ ì „ì†¡ ì™„ë£Œ!`);
          } else {
            alert("ê´€ë¦¬ì ì°½ì´ ë‹«í˜€ìˆê±°ë‚˜ ì—°ê²°ì´ ëŠì–´ì¡Œì–´.");
          }
        });

        btnRemove.addEventListener("click", () => { 
            wrap.remove(); 
            updatePill(); 
            showToast("ë¸”ë¡ ì‚­ì œë¨");
        });

        fnResetBtn.addEventListener("click", () => {
          if(confirm("ì´ ë¸”ë¡ì˜ ì£¼ì„ì„ ëª¨ë‘ ë¹„ìš¸ê¹Œ?")) {
            wrap.bcgData.footnotes = [];
            regenerate();
            updateGlobalFootnoteUI();
            showToast("ì´ˆê¸°í™”ë¨");
          }
        });

        let t = null;
        function schedule(){ clearTimeout(t); t = setTimeout(regenerate, 180); }
        [levelEl, headingEl, bodyEl, keepRawEl].forEach(el => el.addEventListener("input", schedule));
        levelEl.addEventListener("change", schedule);
        keepRawEl.addEventListener("change", schedule);

        // ì„œì‹ ë²„íŠ¼ ë¡œì§
        let lastSel = { s:0, e:0 };
        function saveSel_(){ try{ lastSel.s = bodyEl.selectionStart; lastSel.e = bodyEl.selectionEnd; }catch(e){} }
        function restoreSel_(){ try{ bodyEl.focus(); bodyEl.setSelectionRange(lastSel.s, lastSel.e); }catch(e){} }
        bodyEl.addEventListener("blur", saveSel_);
        // ìƒ‰ìƒ ì ìš© ì‹œ ì„ íƒì˜ì—­ ìœ ì§€ìš© ì´ë²¤íŠ¸
        bodyEl.addEventListener("mouseup", saveSel_);
        bodyEl.addEventListener("keyup", saveSel_);
        bodyEl.addEventListener("select", saveSel_);
        
        function hasSelection_(){ const s = lastSel.s ?? 0, e = lastSel.e ?? 0; return s !== e; }

        function ensureAllowTagsOn_(){ if (!keepRawEl.checked){ keepRawEl.checked = true; showToast("ì„œì‹/íƒœê·¸ í—ˆìš© ON"); } }

        // ìƒ‰ìƒ í”„ë¦¬ì…‹ ë²„íŠ¼ ì´ë²¤íŠ¸ ë³µêµ¬
        wrap.querySelectorAll("[data-color-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-color-preset");
            if (!v) return;
            colorEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<span style="color:${colorEl.value}">`, "</span>");
              schedule();
              showToast("ê¸€ììƒ‰ ì ìš©!");
            }else{
              showToast("ê¸€ììƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        wrap.querySelectorAll("[data-bg-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-bg-preset");
            if (!v) return;
            bgEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<mark style="background:${bgEl.value}">`, "</mark>");
              schedule();
              showToast("ë°°ê²½ìƒ‰ ì ìš©!");
            }else{
              showToast("ë°°ê²½ìƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        wrap.querySelectorAll("[data-fmt]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const fmt = btn.getAttribute("data-fmt");
            if (!fmt) return;
            ensureAllowTagsOn_();
            
            if (fmt === "footnote") {
              const noteContent = prompt("ì£¼ì„ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
              if (noteContent) {
                // 1. ì €ì¥
                wrap.bcgData.footnotes.push(noteContent);
                // 2. í˜„ì¬ ë²ˆí˜¸ ê³„ì‚° (ë‚´ ì‹œì‘ë²ˆí˜¸ + í˜„ì¬ ë°°ì—´ ê¸¸ì´ - 1)
                const currentIdx = getMyStartIndex() + wrap.bcgData.footnotes.length - 1;
                
                restoreSel_();
                // 3. íƒœê·¸ ì‚½ì…
                const linkTag = `<a id="fn${currentIdx}-ref" href="#fn${currentIdx}" class="cheese-footnote-ref" data-footnote-id="fn${currentIdx}">*${currentIdx}</a>`;
                insertAtSelection(bodyEl, linkTag);
                
                schedule();
                updateGlobalFootnoteUI();
                showToast(`ì£¼ì„ *${currentIdx} ì¶”ê°€ë¨`);
              }
              return;
            }

            if (fmt === "table"){
              openTableModal_({ bodyEl, ensureAllowTagsOn_, schedule, showToast });
              return;
            }
            
            // ê¸°íƒ€ ì„œì‹ ë° ìƒ‰ìƒ ì²˜ë¦¬ ë³µêµ¬
            restoreSel_();
            if (fmt === "bold") wrapSelection(bodyEl, "<strong>", "</strong>");
            else if (fmt === "br") wrapSelection(bodyEl, "<br>", "");
            else if (fmt === "color"){
              const c = (colorEl && colorEl.value) ? colorEl.value : "#111827";
              wrapSelection(bodyEl, `<span style="color:${c}">`, "</span>");
            }else if (fmt === "bg"){
              const b = (bgEl && bgEl.value) ? bgEl.value : "#fde68a";
              wrapSelection(bodyEl, `<mark style="background:${b}">`, "</mark>");
            }
            schedule();
          });
        });

        regenerate(); // ì´ˆê¸° ìƒì„±
        return wrap;
      }

      addBtn.addEventListener("click", () => {
        elBlocks.appendChild(createBlock());
        updatePill();
      });

      // ì´ˆê¸° ë¸”ë¡
      elBlocks.appendChild(createBlock());
      updatePill();

      window.addEventListener("message", (e) => {
        if (e.data && e.data.type === 'CH_LOAD_DATA') {
          const content = e.data.content || "";
          const firstBlock = elBlocks.querySelector("[data-bcg-block]");
          if (firstBlock && content.trim()) {
            const bodyEl = firstBlock.querySelector("[data-body]");
            const keepRawEl = firstBlock.querySelector("[data-keep-raw]");
            if (bodyEl) {
                bodyEl.value = content;
                if (keepRawEl) keepRawEl.checked = true;
                bodyEl.dispatchEvent(new Event("input"));
                showToast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
            }
          }
        }
      });

      if (window.opener) setTimeout(() => window.opener.postMessage({ type: 'CH_CODE_GEN_READY' }, '*'), 100);

      const pad2 = n => String(n).padStart(2, '0');
      (function showVersion(){
        const el = document.getElementById("sysVersion");
        if(!el) return;
        const d = new Date(document.lastModified);
        el.textContent = `Updated: ${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}`;
      })();
    })();
  </script>
</body>
</html>
