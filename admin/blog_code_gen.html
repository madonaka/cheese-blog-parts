<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</title>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .bcg-wrap{ padding:14px; padding-bottom: 60px; }

    .bcg-hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .bcg-title{
      margin:0;
      font-weight:950;
      letter-spacing:-0.2px;
      font-size:18px;
    }
    .bcg-sub{
      margin:6px 0 0;
      color:rgba(15,23,42,.72);
      line-height:1.45;
      font-size:13px;
    }
    
    .bcg-version {
      margin-top: 8px;
      font-size: 16px; 
      font-weight: 800;
      color: #334155;
      background: rgba(15,23,42,0.03);
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.06);
    }

    .bcg-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .bcg-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
      position: relative;
    }

    .bcg-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .bcg-row:first-child{ margin-top:0; }

    .bcg-label{
      font-weight:900;
      font-size:12px;
      color:rgba(15,23,42,.78);
    }

    .bcg-input, .bcg-select, .bcg-textarea{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.18);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .bcg-input{ min-width:240px; flex:1; }
    .bcg-select{ min-width:110px; }
    .bcg-textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      line-height:1.55;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "ë§‘ì€ ê³ ë”•", sans-serif;
    }

    .bcg-output{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,0.26);
      border-radius:12px;
      background:rgba(15,23,42,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.55;
      white-space:pre;
    }
    
    .bcg-output-mini {
      width: 100%;
      min-height: 80px;
      font-family: ui-monospace, SFMono-Regular, monospace;
      font-size: 11px;
      color: #475569;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      resize: vertical;
    }

    .bcg-preview{
      width:100%;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      padding:12px;
      background:#fff;
      box-shadow:0 8px 18px rgba(15,23,42,0.06);
      min-height:64px;
      overflow:auto;
    }
    .bcg-preview h1, .bcg-preview h2, .bcg-preview h3{
      margin:0 0 10px;
      line-height:1.25;
    }
    .bcg-preview p{ margin:0 0 10px; line-height:1.6; }
    .bcg-preview p:last-child{ margin-bottom:0; }
    .bcg-preview-empty{
      color:rgba(15,23,42,.55);
      font-size:12px;
    }

    .bcg-preview .cheese-footnotes {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      padding-left: 20px;
      font-size: 0.9em;
      color: #555;
    }
    .bcg-preview .cheese-footnote-ref {
      color: #2563eb;
      font-size: 0.8em;
      vertical-align: super;
      text-decoration: none;
    }

    .bcg-btn{
      border:1px solid rgba(15,23,42,0.16);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition:transform .06s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      user-select:none;
    }
    .bcg-btn:active{ transform:translateY(1px); box-shadow:0 5px 12px rgba(15,23,42,0.10); }
    .bcg-btn:hover{ background:rgba(15,23,42,0.02); border-color:rgba(15,23,42,0.22); }

    .bcg-btn--primary{
      border-color:rgba(37,99,235,0.38);
      box-shadow:0 10px 20px rgba(37,99,235,0.14);
      color: #1e40af;
      background: #eff6ff;
    }
    .bcg-btn--primary:hover{ background:rgba(37,99,235,0.1); border-color:rgba(37,99,235,0.55); }

    .bcg-btn--danger{
      border-color:rgba(239,68,68,0.30);
      box-shadow:0 10px 20px rgba(239,68,68,0.10);
      color: #991b1b;
      background: #fef2f2;
    }
    .bcg-btn--danger:hover{ background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.48); }
    
    .bcg-btn--dark {
        background: #1e293b;
        color: #fff;
        border-color: #0f172a;
    }
    .bcg-btn--dark:hover { background: #334155; }
    
    .bcg-btn--warning {
        background: #fffbeb;
        color: #b45309;
        border-color: #fcd34d;
    }
    .bcg-btn--warning:hover { background: #fef3c7; }

    .bcg-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      font-size:12px;
      color:rgba(15,23,42,.72);
    }

    .bcg-toast{
      position:fixed;
      right:16px;
      bottom:80px;
      z-index:9999;
      max-width:min(420px, calc(100vw - 32px));
      background:rgba(15,23,42,0.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
      font-size:13px;
      line-height:1.35;
      transform:translateY(10px);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      display:flex; align-items:center; gap:10px;
    }
    .bcg-toast.show{ opacity:1; transform:translateY(0); pointer-events:auto; }
    .bcg-toast-btn {
      background: #fff; color: #0f172a; border: 0; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer;
    }

    .bcg-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .bcg-split{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 980px){ .bcg-split{ grid-template-columns:1fr; } }
    .bcg-muted{ color:rgba(15,23,42,.62); font-size:12px; }
    .bcg-sep{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }
    .bcg-mini{ font-size:12px; padding:8px 10px; border-radius:12px; box-shadow:none; }
    .bcg-badge{ font-weight:950; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(15,23,42,0.14); background:rgba(15,23,42,0.02); }
    .bcg-right{ margin-left:auto; }
    .bcg-check{ display:inline-flex; align-items:center; gap:8px; font-size:12px; color:rgba(15,23,42,.72); user-select:none; }
    .bcg-check input{ width:16px; height:16px; }
    .bcg-toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0 8px; }
    .bcg-pill input[type="color"]{ width:34px; height:20px; padding:0; border:0; background:transparent; cursor:pointer; }
    .bcg-pill input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; }
    .bcg-pill input[type="color"]::-webkit-color-swatch{ border:1px solid rgba(15,23,42,0.18); border-radius:6px; }

    /* Quick Swatches */
    .bcg-swatches{ display:inline-flex; align-items:center; gap:6px; margin-left:8px; vertical-align:middle; flex-wrap:wrap; }
    .bcg-swatch{ width:18px; height:18px; border-radius:7px; border:1px solid rgba(15,23,42,0.18); cursor:pointer; box-shadow:0 6px 14px rgba(15,23,42,0.10); padding:0; }
    .bcg-swatch:active{ transform:translateY(1px); }

    /* Global Footnote Bar */
    .bcg-global-foot {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid rgba(15,23,42,0.14);
        padding: 12px 20px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 1000;
        flex-wrap: wrap;
    }
    .bcg-global-foot-info {
        font-weight: 800;
        color: #334155;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .bcg-global-foot-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
    }
    
    /* ===== Common Modal Styles ===== */
    .bcg-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:10000;
      backdrop-filter: blur(2px);
    }
    .bcg-modal-backdrop[hidden]{display:none !important;}
    
    .bcg-modal{
      width:min(920px, 100%);
      max-height:min(86vh, 900px);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.14);
      box-shadow:0 20px 60px rgba(15,23,42,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      animation: modalPop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes modalPop {
        from { transform: scale(0.95) translateY(10px); opacity: 0; }
        to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .bcg-modal-head{
      padding:16px 20px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(15,23,42,0.08);
      background: #fff;
    }
    .bcg-modal-title{
      font-weight:900;
      margin:0;
      font-size:16px;
      color: #1e293b;
    }
    .bcg-modal-body{
      padding:20px;
      overflow:auto;
      background: #f8fafc;
    }
    .bcg-modal-foot{
      padding:16px 20px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(15,23,42,0.08);
      background:#fff;
    }
    .bcg-modal-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    
    /* Manage Footnote List Styles */
    .bcg-manage-list {
      display: flex; flex-direction: column; gap: 8px;
    }
    .bcg-manage-item {
      display: flex; align-items: flex-start; gap: 10px;
      background: #fff;
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,0.12);
      border-radius: 8px;
    }
    .bcg-manage-content {
      flex: 1; font-size: 13px; line-height: 1.45; color: #334155;
      word-break: break-all;
    }
    .bcg-manage-del {
      flex: none;
      padding: 6px 10px;
      font-size: 12px;
      color: #b91c1c;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 6px;
      cursor: pointer;
    }
    .bcg-manage-del:hover { background: #fee2e2; }
    
    /* Table Editor Styles */
    .bcg-table-controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .bcg-table-controls .bcg-field{ display:flex; flex-direction:column; gap:6px; }
    .bcg-num{ width:90px; }
    .bcg-table-editor{ border:1px solid rgba(15,23,42,0.14); border-radius:14px; overflow:auto; background:#fff; }
    .bcg-table-cells{ display:grid; gap:6px; padding:10px; }
    .bcg-cell{ border:1px solid rgba(15,23,42,0.14); border-radius:10px; padding:8px 10px; min-height:40px; font-size:13px; outline:none; }
    .bcg-cell:focus{ border-color:rgba(37,99,235,0.55); box-shadow:0 0 0 3px rgba(37,99,235,0.14); }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      <main class="admin-content">
        <div class="bcg-wrap">
          <div class="bcg-card">
            <div class="bcg-hero">
              <div>
                <h1 class="bcg-title">ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</h1>
                <p class="bcg-sub">
                  ì†Œì œëª©(H1/H2/H3) + ë³¸ë¬¸ì„ ë„£ìœ¼ë©´, <b>ë°”ë¡œ í¬ìŠ¤íŠ¸ ê´€ë¦¬(BODY_1/2/3 ë“±)ì— ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” HTML</b>ë¡œ ë³€í™˜í•´ì¤˜.
                  ë³¸ë¬¸ ë¸”ë¡ì€ ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€í•  ìˆ˜ ìˆê³ , <b>ê° ë¸”ë¡ë§ˆë‹¤ ê²°ê³¼ë¥¼ ë”°ë¡œ ë³µì‚¬</b>í•  ìˆ˜ ìˆì–´.
                </p>
                <div id="sysVersion" class="bcg-version"></div>
              </div>
              <div class="bcg-actions">
                <span class="bcg-pill" id="blockCountPill">ë¸”ë¡ 0ê°œ</span>
                <button class="bcg-btn bcg-btn--primary" id="addBlockBtn" type="button">ï¼‹ ë¸”ë¡ ì¶”ê°€</button>
              </div>
            </div>
            <div class="bcg-sep"></div>
            <div class="bcg-grid" id="blocks"></div>
            <div class="bcg-sep"></div>
            <div class="bcg-row">
              <span class="bcg-muted">
                â€» ì£¼ì„ ì‹œìŠ¤í…œ: <b>ìë™ ì¬ì •ë ¬</b> ê¸°ëŠ¥ì´ ì¼œì ¸ ìˆì–´. 
                ì£¼ì„ì„ ì¤‘ê°„ì— ì‚½ì…í•˜ë©´, ì „ì²´ ë‚´ìš©ì„ ìŠ¤ìº”í•´ì„œ ìœ„ì—ì„œë¶€í„° 1, 2, 3 ìˆœì„œë¡œ ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ë§¤ê²¨ì¤˜.
              </span>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div class="bcg-global-foot">
    <div class="bcg-global-foot-info">
        <span>ğŸ“ ì „ì²´ ì£¼ì„(ì €ì¥ë¨): <span id="globalFnCount" style="color:#2563eb;">0</span>ê°œ</span>
        <button class="bcg-btn bcg-mini" id="viewAllFnBtn" type="button" style="margin-left:8px;">ê´€ë¦¬/í¸ì§‘</button>
    </div>
    <div class="bcg-global-foot-controls">
        <button class="bcg-btn bcg-mini bcg-btn--warning" id="cleanupFnBtn" type="button" style="display:none;">ğŸ§¹ ë¯¸ì‚¬ìš© ì •ë¦¬</button>
        <button class="bcg-btn bcg-mini bcg-btn--dark" id="copyAllFnBtn" type="button">ì£¼ì„ ëª©ë¡(li) ë³µì‚¬</button>
        <button class="bcg-btn bcg-mini bcg-btn--primary" id="copyWrapperBtn" type="button">ì£¼ì„ í‹€(&lt;ol&gt;) ë³µì‚¬</button>
        <div style="width:1px; height:16px; background:#cbd5e1; margin:0 4px;"></div>
        <button class="bcg-btn bcg-mini bcg-btn--danger" id="resetGlobalFnBtn" type="button">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="bcg-modal-backdrop" id="manageFnModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" style="width:600px;" role="dialog" aria-modal="true" aria-labelledby="manageFnModalTitle">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title" id="manageFnModalTitle">ì „ì²´ ì£¼ì„ ê´€ë¦¬</h3>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="manageFnModalCloseBtn">ë‹«ê¸°</button>
      </div>
      <div class="bcg-modal-body">
         <div class="bcg-muted" style="margin-bottom:10px;">
            ì—¬ê¸°ì„œ ì£¼ì„ì„ ì‚­ì œí•˜ë©´, <b>ë³¸ë¬¸ ë‚´ì˜ ì£¼ì„ íƒœê·¸ë„ ìë™ìœ¼ë¡œ ì œê±°</b>ë©ë‹ˆë‹¤.
         </div>
         <div id="manageFnList" class="bcg-manage-list"></div>
      </div>
      <div class="bcg-modal-foot">
        <button class="bcg-btn bcg-mini" type="button" id="manageFnDoneBtn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div class="bcg-modal-backdrop" id="tableModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" role="dialog" aria-modal="true" aria-labelledby="tableModalTitle">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title" id="tableModalTitle">í‘œ ë§Œë“¤ê¸°</h3>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="tableModalCloseBtn">ë‹«ê¸°</button>
      </div>
      <div class="bcg-modal-body">
        <div class="bcg-modal-grid">
          <div class="bcg-table-controls">
            <div class="bcg-field"><span class="bcg-label">í–‰</span><input class="bcg-input bcg-num" id="tblRows" type="number" min="1" max="30" value="3"></div>
            <div class="bcg-field"><span class="bcg-label">ì—´</span><input class="bcg-input bcg-num" id="tblCols" type="number" min="1" max="12" value="3"></div>
            <div class="bcg-field"><span class="bcg-label">ì˜µì…˜</span><label class="bcg-check" style="margin-top:4px;"><input type="checkbox" id="tblHeader" checked> ì²« ì¤„ì„ í—¤ë”(th)ë¡œ</label></div>
            <div class="bcg-field" style="min-width:240px; flex:1;"><span class="bcg-label">ìº¡ì…˜</span><input class="bcg-input" id="tblCaption" placeholder="ì˜ˆ) ì‹œëŒ€ë³„ ì™•ìœ„ ê³„ìŠ¹ ì •ë¦¬"></div>
            <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" id="tblRebuildBtn">ê·¸ë¦¬ë“œ ìƒì„±</button>
          </div>
          <div class="bcg-table-editor">
            <div class="bcg-table-cells" id="tblCells"></div>
          </div>
        </div>
      </div>
      <div class="bcg-modal-foot"><button class="bcg-btn bcg-mini" type="button" id="tblInsertBtn">ì‚½ì…</button></div>
    </div>
  </div>

  <div class="bcg-modal-backdrop" id="fnModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" style="width:500px;" role="dialog" aria-modal="true" aria-labelledby="fnModalTitle">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title" id="fnModalTitle">ì£¼ì„ ì¶”ê°€</h3>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="fnModalCloseBtn">ë‹«ê¸°</button>
      </div>
      <div class="bcg-modal-body">
         <div style="display:flex; flex-direction:column; gap:8px;">
            <span class="bcg-muted">ë³¸ë¬¸ì— ì£¼ì„ íƒœê·¸ê°€ ì‚½ì…ë˜ê³ , ë²ˆí˜¸ëŠ” <b>ë¬¸ì„œ ë‚´ ìœ„ì¹˜ ìˆœì„œëŒ€ë¡œ</b> ìë™ ì •ë¦¬ë©ë‹ˆë‹¤.</span>
            <textarea id="fnInput" class="bcg-textarea" style="min-height:120px;" placeholder="ì£¼ì„ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
         </div>
      </div>
      <div class="bcg-modal-foot">
        <button class="bcg-btn bcg-mini" type="button" id="fnCancelBtn">ì·¨ì†Œ</button>
        <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" id="fnConfirmBtn">ì¶”ê°€</button>
      </div>
    </div>
  </div>

<div class="bcg-modal-backdrop" id="aiModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" style="width:840px; max-height:90vh;" role="dialog" aria-modal="true">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title">âœ¨ AI ë¸”ë¡œê·¸ ê¸€ ìë™ ì‘ì„±</h3>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="aiModalCloseBtn">ë‹«ê¸°</button>
      </div>
      <div class="bcg-modal-body">
         <div class="bcg-split" style="gap:20px;">
           <div style="display:flex; flex-direction:column; gap:12px;">
              <div class="bcg-field" style="display:flex; flex-direction:column; gap:6px;">
                  <span class="bcg-label">ì£¼ì œ (ì„ íƒ)</span>
                  <input class="bcg-input" id="aiTopic" placeholder="ì˜ˆ: ìˆ™ì¢…ì˜ í™˜êµ­ ì •ì¹˜ ìš”ì•½">
              </div>
              <div class="bcg-field" style="display:flex; flex-direction:column; gap:6px;">
                  <span class="bcg-label">ë¬¸ì²´ / í†¤ì•¤ë§¤ë„ˆ</span>
                  <select class="bcg-select" id="aiTone">
                      <option value="í¥ë¯¸ì§„ì§„í•œ, ìœ ë¨¸ëŸ¬ìŠ¤í•œ, ì‹œì„ ì„ ë„ëŠ”">ìœ ë¨¸ëŸ¬ìŠ¤/í¥ë¯¸ì§„ì§„ (ìŠ¤í† ë¦¬í…”ë§)</option>
                      <option value="ì¹œê·¼í•œ, ë¸”ë¡œê±° ìŠ¤íƒ€ì¼, ì´ëª¨ì§€ ì‚¬ìš©">ì¹œê·¼í•œ ë¸”ë¡œê±°í’ (ì†Œí†µ, ì´ëª¨ì§€)</option>
                      <option value="ì „ë¬¸ê°€ë‹¤ìš´, ì‹ ë¢°ê° ìˆëŠ”">ì „ë¬¸ê°€í’ (ì‹ ë¢°ê°, ë…¼ë¦¬ì )</option>
                      <option value="í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ, ìš”ì•½í˜•">ê°„ê²°/ìš”ì•½í˜• (ì •ë³´ ì „ë‹¬ ì¤‘ì‹¬)</option>
                  </select>
              </div>
              <div class="bcg-field" style="display:flex; flex-direction:column; gap:6px;">
                  <span class="bcg-label">ì°¸ê³ í•  ê¸°ì¡´ ê¸€ (ìœ ì‚¬ë„ íšŒí”¼ìš©)</span>
                  <textarea class="bcg-textarea" id="aiRefText" style="min-height:100px;" placeholder="ìœ ì‚¬ë„ë¥¼ í”¼í•´ ë‹¤ì‹œ ì“¸ ì›ë¬¸ì´ë‚˜ ì°¸ê³  ìë£Œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
              </div>
              <div class="bcg-field" style="display:flex; flex-direction:column; gap:6px;">
                  <span class="bcg-label">ë‚´ ì˜ê²¬ / í•µì‹¬ ê°•ì¡°ì </span>
                  <textarea class="bcg-textarea" id="aiOpinion" style="min-height:80px;" placeholder="ì´ ë¶€ë¶„ì€ ê¼­ ê°•ì¡°í•´ì£¼ê³ , ë‚´ ìƒê°ì€ ì´ë ‡ë‹¤ëŠ” ê±¸ í¬í•¨í•´ì¤˜..."></textarea>
              </div>
              <button class="bcg-btn bcg-btn--dark" type="button" id="aiGenerateBtn" style="justify-content:center; padding:12px; margin-top:4px;">ğŸš€ AI ìƒì„± ì‹œì‘</button>
           </div>
           
           <div style="display:flex; flex-direction:column; gap:12px; height:100%;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span class="bcg-label">ìƒì„±ëœ ê²°ê³¼ (ììœ ë¡­ê²Œ ìˆ˜ì • ê°€ëŠ¥)</span>
              </div>
              <textarea class="bcg-textarea" id="aiOutput" style="flex:1; min-height:380px; background:#f8fafc; border-color:#cbd5e1;" placeholder="ìƒì„±ëœ ê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
           </div>
         </div>
      </div>
      <div class="bcg-modal-foot">
        <button class="bcg-btn bcg-mini" type="button" id="aiRegenerateBtn" style="display:none;">ğŸ”„ ì¬ìƒì„±</button>
        <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" id="aiApplyBtn">ë³¸ë¬¸ì— ë°˜ì˜í•˜ê¸°</button>
      </div>
    </div>
  </div>
  
  <div class="bcg-toast" id="toast"></div>
  <script src="./admin-common.js"></script>

  <script>
    (function(){
      // URL íƒ€ê²Ÿ í™•ì¸ ë° íŒì—… ëª¨ë“œ ì„¤ì •
      const urlParams = new URLSearchParams(window.location.search);
      const currentTarget = urlParams.get('target') || "";

      if (currentTarget) {
        const titleEl = document.querySelector(".bcg-title");
        if(titleEl) titleEl.innerHTML += ` <span class="bcg-badge" style="color:#0284c7; background:#e0f2fe; vertical-align:middle; font-size:13px;">ğŸ¯ íƒ€ê²Ÿ: ${currentTarget}</span>`;
        
        const header = document.getElementById("admin-header-slot");
        const menu = document.getElementById("admin-menu-slot");
        const main = document.querySelector(".admin-main");

        if (header) header.style.display = "none";
        if (menu) menu.style.display = "none";
        if (main) {
          main.style.display = "block";
          main.style.padding = "0";
          main.style.height = "auto";
        }
        document.body.style.backgroundColor = "#fff";
        
        const addBtnEl = document.getElementById("addBlockBtn");
        const pillEl = document.getElementById("blockCountPill");
        if (addBtnEl) addBtnEl.style.display = "none";
        if (pillEl) pillEl.style.display = "none";
      }

      const elBlocks = document.getElementById("blocks");
      const addBtn = document.getElementById("addBlockBtn");
      const pill = document.getElementById("blockCountPill");
      const toast = document.getElementById("toast");

      // Global Footnote Controls
      const globalFnCountEl = document.getElementById("globalFnCount");
      const copyAllFnBtn = document.getElementById("copyAllFnBtn");
      const copyWrapperBtn = document.getElementById("copyWrapperBtn");
      const resetGlobalFnBtn = document.getElementById("resetGlobalFnBtn");
      const cleanupFnBtn = document.getElementById("cleanupFnBtn");
      const viewAllFnBtn = document.getElementById("viewAllFnBtn");

      // Table Builder Elements
      const tableModal = document.getElementById("tableModal");
      const tableModalCloseBtn = document.getElementById("tableModalCloseBtn");
      const tblRowsEl = document.getElementById("tblRows");
      const tblColsEl = document.getElementById("tblCols");
      const tblHeaderEl = document.getElementById("tblHeader");
      const tblCaptionEl = document.getElementById("tblCaption");
      const tblRebuildBtn = document.getElementById("tblRebuildBtn");
      const tblCellsEl = document.getElementById("tblCells");
      const tblInsertBtn = document.getElementById("tblInsertBtn");

      // Footnote Modal Elements
      const fnModal = document.getElementById("fnModal");
      const fnInput = document.getElementById("fnInput");
      const fnConfirmBtn = document.getElementById("fnConfirmBtn");
      const fnCancelBtn = document.getElementById("fnCancelBtn");
      const fnModalCloseBtn = document.getElementById("fnModalCloseBtn");

      // Manage Modal Elements
      const manageFnModal = document.getElementById("manageFnModal");
      const manageFnList = document.getElementById("manageFnList");
      const manageFnCloseBtn = document.getElementById("manageFnModalCloseBtn");
      const manageFnDoneBtn = document.getElementById("manageFnDoneBtn");

      let seq = 0;
      let activeFnContext = null;
      const STORAGE_KEY = "bcg_global_footnotes";

      function showToast(msg, actionText, actionCallback){
        toast.innerHTML = `<span>${msg}</span>`;
        if(actionText && actionCallback) {
            const btn = document.createElement("button");
            btn.className = "bcg-toast-btn";
            btn.textContent = actionText;
            btn.onclick = () => { actionCallback(); toast.classList.remove("show"); };
            toast.appendChild(btn);
        }
        toast.classList.add("show");
        const delay = actionText ? 5000 : 1600;
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"), delay);
      }

      function clampInt_(v, min, max, fallback){
        const n = parseInt(v, 10);
        if (!Number.isFinite(n)) return fallback;
        return Math.max(min, Math.min(max, n));
      }

      function escapeHtmlLite(s){
        return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }
      
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function protectAllowedTags_(s){
        const src = String(s ?? "");
        const map = [];
        const re = /<\/?(?:strong|em|u|s)\s*>|<br\s*\/?>|<mark\s+style="background:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/mark>|<span\s+style="color:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/span>|<table\s+class="cheese-table"\s*>|<\/table>|<thead\s*>|<\/thead>|<tbody\s*>|<\/tbody>|<tr\s*>|<\/tr>|<th\s*>|<\/th>|<td\s*>|<\/td>|<caption\s*>|<\/caption>|<a\s+[^>]*cheese-footnote-ref[^>]*>.*?<\/a>|<hr\s*\/?>|<\/?ol[^>]*>|<\/?ul[^>]*>|<\/?li[^>]*>|<\/?a[^>]*>|<\/?div[^>]*>|<\/?blockquote[^>]*>|<\/?pre[^>]*>|<\/?p[^>]*>/gi;
        const out = src.replace(re, (m)=>{
          const key = `@@ALLOWED_TAG_${map.length}@@`;
          map.push(m);
          return key;
        });
        return { out, map };
      }

      function restoreAllowedTags_(s, map){
        let out = String(s ?? "");
        (map || []).forEach((tag, i)=>{ out = out.split(`@@ALLOWED_TAG_${i}@@`).join(tag); });
        return out;
      }

      function escapeText_(s, allowTags){
        if (!allowTags) return escapeHtmlLite(s);
        const { out, map } = protectAllowedTags_(s);
        const escaped = escapeHtmlLite(out);
        return restoreAllowedTags_(escaped, map);
      }

      function textToParagraphHtml(text, allowTags) {
        const raw = String(text ?? "").replace(/\r\n/g, "\n").replace(/\u200B/g, '');
        const chunks = raw.split(/\n{2,}/g); 
        if (chunks.length === 0) return "";
        return chunks.map(chunk => {
          const trimmedChunk = chunk.trim();
          if (allowTags && /^(<p\b|<table|<ol|<ul|<div|<hr|<blockquote|<pre)/i.test(trimmedChunk)) {
             return escapeText_(trimmedChunk, allowTags);
          }
          const brOnlyRegex = /^(<br\s*\/?>)+$/i;
          if (brOnlyRegex.test(trimmedChunk.replace(/\s/g, ''))) return trimmedChunk; 
          
          const lines = chunk.split("\n").map(l => l.trimEnd());
          let processedLines = [];
          for (let i = 0; i < lines.length; i++) {
            let escaped = escapeText_(lines[i], allowTags);
            if (i < lines.length - 1) {
              if (/<br\s*\/?>$/i.test(escaped.trim())) processedLines.push(escaped);
              else processedLines.push(escaped + "<br>");
            } else {
              processedLines.push(escaped.replace(/<br\s*\/?>$/i, ""));
            }
          }
          const content = processedLines.filter(line => line.length > 0).join("\n");
          return content ? `<p>${content}</p>` : "<br>";
        }).join("\n");
      }
      
      function wrapSelection(textarea, left, right){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0, e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        if (s === e){
          textarea.value = v.slice(0, s) + left + right + v.slice(e);
          const pos = s + left.length;
          textarea.setSelectionRange(pos, pos);
        } else {
          textarea.value = v.slice(0, s) + left + v.slice(s, e) + right + v.slice(e);
          textarea.setSelectionRange(s + left.length, e + left.length);
        }
        textarea.focus();
      }

      function insertAtSelection(textarea, insertText){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0, e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        textarea.value = v.slice(0, s) + insertText + v.slice(e);
        const pos = s + String(insertText).length;
        textarea.setSelectionRange(pos, pos);
        textarea.focus();
      }

      function copyToClipboard(text){
        return navigator.clipboard.writeText(text).then(()=>true).catch(()=>{
          try{
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return ok;
          }catch(e){ return false; }
        });
      }

      /* ==========================
         Footnote Modal Logic
      ========================== */
      function openFnModal(context) {
        if (!fnModal) return;
        activeFnContext = context;
        fnInput.value = "";
        fnModal.hidden = false;
        fnModal.style.display = 'flex';
        setTimeout(() => fnInput.focus(), 50);
      }
      
      function closeFnModal() {
        if (!fnModal) return;
        fnModal.hidden = true;
        fnModal.style.display = 'none';
        if (activeFnContext && activeFnContext.restoreFocus) {
             activeFnContext.restoreFocus();
        }
        activeFnContext = null;
      }
      
      function confirmFnModal() {
        const text = fnInput.value.trim();
        if (!text) {
             alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
             return;
        }
        if (activeFnContext && activeFnContext.onConfirm) {
            activeFnContext.onConfirm(text);
        }
        closeFnModal();
      }

      fnConfirmBtn.onclick = confirmFnModal;
      fnCancelBtn.onclick = closeFnModal;
      fnModalCloseBtn.onclick = closeFnModal;
      fnModal.onclick = (e) => { if (e.target === fnModal) closeFnModal(); };
      fnInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && e.ctrlKey) confirmFnModal(); 
        if (e.key === "Escape") closeFnModal();
      });

      /* ==========================
         Manage Modal Logic
      ========================== */
      function openManageFnModal() {
        const map = loadGlobalFootnotes();
        const keys = Object.keys(map);
        
        manageFnList.innerHTML = "";
        if (keys.length === 0) {
            manageFnList.innerHTML = '<div class="bcg-muted" style="text-align:center;">ì €ì¥ëœ ì£¼ì„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            keys.forEach(uid => {
                const div = document.createElement("div");
                div.className = "bcg-manage-item";
                div.innerHTML = `
                  <div class="bcg-manage-content">
                    <b>ID: ${uid.slice(-4)}</b><br>
                    ${escapeHtmlLite(map[uid])}
                  </div>
                  <button class="bcg-manage-del" type="button">ì‚­ì œ</button>
                `;
                div.querySelector(".bcg-manage-del").onclick = () => deleteFootnote(uid);
                manageFnList.appendChild(div);
            });
        }
        
        manageFnModal.hidden = false;
        manageFnModal.style.display = 'flex';
      }
      
      function closeManageFnModal() {
        manageFnModal.hidden = true;
        manageFnModal.style.display = 'none';
      }
      
      function deleteFootnote(uid) {
        if (!confirm("ì´ ì£¼ì„ì„ ì‚­ì œí• ê¹Œìš”?\në³¸ë¬¸ì— ì‚½ì…ëœ íƒœê·¸ë„ ìë™ìœ¼ë¡œ ì§€ì›Œì§‘ë‹ˆë‹¤.")) return;
        
        const map = loadGlobalFootnotes();
        delete map[uid];
        saveGlobalFootnotes(map);
        
        let removedCount = 0;
        document.querySelectorAll("[data-bcg-block]").forEach(block => {
            const bodyEl = block.querySelector("[data-body]");
            if(bodyEl) {
               const re = new RegExp(`<a [^>]*data-(?:fn-idx|footnote-id)="${escapeRegExp(uid)}"[^>]*>.*?<\/a>`, "g");
               if(re.test(bodyEl.value)) {
                  bodyEl.value = bodyEl.value.replace(re, "");
                  bodyEl.dispatchEvent(new Event("input"));
                  removedCount++;
               }
            }
        });
        
        openManageFnModal(); 
        updateGlobalFnUI();
        showToast(`ì£¼ì„ ì‚­ì œ ì™„ë£Œ (${removedCount}ê°œ íƒœê·¸ ì œê±°ë¨)`);
      }

      viewAllFnBtn.onclick = openManageFnModal;
      manageFnCloseBtn.onclick = closeManageFnModal;
      manageFnDoneBtn.onclick = closeManageFnModal;
      manageFnModal.onclick = (e) => { if (e.target === manageFnModal) closeManageFnModal(); };


      /* ==========================
         Table Builder Logic
      ========================== */
      let tableCtx = null;
      function openTableModal_(ctx){
        tableCtx = ctx || null;
        if (!tableModal) return;
        tableModal.hidden = false;
        tableModal.style.display = 'flex';
        tableModal.setAttribute('aria-hidden','false');
        const r = clampInt_(tblRowsEl?.value, 1, 30, 3);
        const c = clampInt_(tblColsEl?.value, 1, 12, 3);
        buildTableGrid_(r, c);
        const first = tblCellsEl?.querySelector(".bcg-cell");
        if (first) setTimeout(()=>first.focus(), 0);
      }

      function closeTableModal_(){
        if (!tableModal) return;
        tableModal.hidden = true;
        tableModal.style.display = 'none';
        tableModal.setAttribute('aria-hidden','true');
        tableCtx = null;
      }

      function handleSafeClose_() {
        const cells = tblCellsEl?.querySelectorAll(".bcg-cell");
        const hasContent = Array.from(cells || []).some(cell => cell.value.trim().length > 0);
        if (hasContent) {
          if (confirm("ì‘ì„± ì¤‘ì¸ í‘œ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ì–´ìš”?")) closeTableModal_();
        } else {
          closeTableModal_();
        }
      }

      function buildTableGrid_(rows, cols){
        if (!tblCellsEl) return;
        tblCellsEl.innerHTML = "";
        tblCellsEl.style.gridTemplateColumns = `repeat(${cols}, minmax(140px, 1fr))`;

        for (let r=0; r<rows; r++){
          for (let c=0; c<cols; c++){
            const inp = document.createElement("textarea");
            inp.className = "bcg-cell";
            inp.style.height = "60px";
            inp.placeholder = (r === 0 && (tblHeaderEl?.checked)) ? `í—¤ë” ${c+1}` : `R${r+1}C${c+1}`;
            inp.setAttribute("data-r", String(r));
            inp.setAttribute("data-c", String(c));
            
            inp.addEventListener("keydown", (e)=>{
              if (e.key === "Enter" && e.ctrlKey) {
                e.preventDefault();
                const target = tblCellsEl.querySelector(`.bcg-cell[data-r="${r+1}"][data-c="${c}"]`);
                if (target) target.focus();
              }
            });
            tblCellsEl.appendChild(inp);
          }
        }
      }

      function readTableCells_(rows, cols){
        const out = [];
        for (let r=0; r<rows; r++){
          const row = [];
          for (let c=0; c<cols; c++){
            const el = tblCellsEl?.querySelector(`.bcg-cell[data-r="${r}"][data-c="${c}"]`);
            let val = el ? String(el.value ?? "") : "";
            row.push(val.replace(/\n/g, "<br>"));
          }
          out.push(row);
        }
        return out;
      }

      function makeTableHtml_(rows, cols, useHeader, caption, cells){
        const cap = String(caption ?? "").trim();
        const lines = [];
        lines.push('<table class="cheese-table">');
        if (cap) lines.push(`  <caption>${cap}</caption>`);
        if (useHeader && rows >= 1){
          lines.push("  <thead>");
          lines.push("    <tr>");
          for (let c=0; c<cols; c++){
            const v = (cells?.[0]?.[c] ?? "");
            lines.push(`      <th>${v}</th>`);
          }
          lines.push("    </tr>");
          lines.push("  </thead>");
        }
        lines.push("  <tbody>");
        const start = (useHeader ? 1 : 0);
        for (let r=start; r<rows; r++){
          lines.push("    <tr>");
          for (let c=0; c<cols; c++){
            const v = (cells?.[r]?.[c] ?? "");
            lines.push(`      <td>${v}</td>`);
          }
          lines.push("    </tr>");
        }
        lines.push("  </tbody>");
        lines.push("</table>");
        return lines.join("\n");
      }

      if (tableModalCloseBtn) {
        tableModalCloseBtn.onclick = (e) => { e.preventDefault(); handleSafeClose_(); };
      }
      if (tableModal) {
        tableModal.onclick = (e) => {
          if (e.target === tableModal) e.stopPropagation();
        };
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
             if(!tableModal.hidden) handleSafeClose_();
             if(!fnModal.hidden) closeFnModal();
             if(!manageFnModal.hidden) closeManageFnModal();
        }
      });
      if (tblRebuildBtn) {
        tblRebuildBtn.onclick = () => {
          const cells = tblCellsEl?.querySelectorAll(".bcg-cell");
          const hasContent = Array.from(cells || []).some(cell => cell.value.trim().length > 0);
          if (hasContent && !confirm("í˜„ì¬ ì…ë ¥ëœ í‘œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
          const r = clampInt_(tblRowsEl?.value, 1, 30, 3);
          const c = clampInt_(tblColsEl?.value, 1, 12, 3);
          buildTableGrid_(r, c);
        };
      }
      if (tblInsertBtn) {
        tblInsertBtn.onclick = () => {
          if (!tableCtx || !tableCtx.bodyEl) return closeTableModal_();
          if (typeof tableCtx.ensureAllowTagsOn_ === "function") tableCtx.ensureAllowTagsOn_();
          const rows = clampInt_(tblRowsEl?.value, 1, 30, 3);
          const cols = clampInt_(tblColsEl?.value, 1, 12, 3);
          const cells = readTableCells_(rows, cols);
          const caption = tblCaptionEl ? tblCaptionEl.value : "";
          const useHeader = !!(tblHeaderEl && tblHeaderEl.checked);
          const tableHtml = makeTableHtml_(rows, cols, useHeader, caption, cells);
          const insertText = `\n\n${tableHtml}\n\n`;
          insertAtSelection(tableCtx.bodyEl, insertText);
          if (typeof tableCtx.schedule === "function") tableCtx.schedule();
          if (typeof tableCtx.showToast === "function") tableCtx.showToast("í‘œë¥¼ ì‚½ì…í–ˆì–´.");
          closeTableModal_();
        };
      }


      /* ==========================
         Global Footnote Logic
      ========================== */
      function loadGlobalFootnotes() {
        try {
          const s = localStorage.getItem(STORAGE_KEY);
          return s ? JSON.parse(s) : {};
        } catch(e) { return {}; }
      }

      function saveGlobalFootnotes(map) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(map));
          updateGlobalFnUI();
        } catch(e) { console.error("Storage error", e); }
      }

      function updateGlobalFnUI() {
        const map = loadGlobalFootnotes();
        const keys = Object.keys(map);
        globalFnCountEl.textContent = keys.length;
        
        const currentBodyText = document.querySelector("[data-body]")?.value || "";
        let usedCount = 0;
        keys.forEach(uid => {
            if(currentBodyText.includes(uid)) usedCount++;
        });
        
        if (keys.length > 0 && usedCount < keys.length) {
            cleanupFnBtn.style.display = "inline-flex";
            cleanupFnBtn.textContent = `ğŸ§¹ ë¯¸ì‚¬ìš© ${keys.length - usedCount}ê°œ ì •ë¦¬`;
        } else {
            cleanupFnBtn.style.display = "none";
        }

        document.querySelectorAll("[data-bcg-block]").forEach(b => {
           if(b.bcgRegenerate) b.bcgRegenerate();
        });
      }

      function generateFootnoteListHtml(footnotes, startIdx=1) {
        if (!footnotes || footnotes.length === 0) return "";
        let html = "";
        footnotes.forEach((note, i) => {
            const idx = startIdx + i;
            html += `<li id="fn${idx}">\n  <a href="#fn${idx}-ref" class="cheese-footnote-index">*${idx}</a>\n  ${escapeHtmlLite(note)}\n</li>\n`;
        });
        return html;
      }

      // Buttons
      copyAllFnBtn.addEventListener("click", async () => {
        showToast("ê° ë¸”ë¡ì˜ [ì£¼ì„ ëª©ë¡ ë³µì‚¬] ë²„íŠ¼ì„ ì´ìš©í•´ì£¼ì„¸ìš” (ìˆœì„œ ìë™ ì •ë ¬ë¨)");
      });

      copyWrapperBtn.addEventListener("click", async () => {
        const tpl = `\n<hr>\n<ol class="cheese-footnotes">\n  \n</ol>`;
        await copyToClipboard(tpl);
        showToast("ì£¼ì„ í‹€(<ol>) ë³µì‚¬ ì™„ë£Œ!");
      });

      resetGlobalFnBtn.addEventListener("click", () => {
        if(confirm("ì •ë§ ì´ˆê¸°í™”í• ê¹Œ?\n(ì €ì¥ëœ ëª¨ë“  ì£¼ì„ì„ ì§€ì›ë‹ˆë‹¤.)")) {
          localStorage.removeItem(STORAGE_KEY);
          updateGlobalFnUI();
          showToast("ì „ì²´ ì£¼ì„ ì´ˆê¸°í™” ì™„ë£Œ!");
          document.querySelectorAll("[data-bcg-block]").forEach(b => {
            if (b.bcgRegenerate) b.bcgRegenerate();
          });
        }
      });
      
      cleanupFnBtn.addEventListener("click", () => {
        if(!confirm("í˜„ì¬ ë³¸ë¬¸ì— ì—†ëŠ” ì£¼ì„ë“¤ì„ ì‚­ì œí• ê¹Œ?")) return;
        const map = loadGlobalFootnotes();
        const currentBodyText = document.querySelector("[data-body]")?.value || "";
        const newMap = {};
        Object.keys(map).forEach(uid => {
            if(currentBodyText.includes(uid)) newMap[uid] = map[uid];
        });
        saveGlobalFootnotes(newMap);
        showToast("ë¯¸ì‚¬ìš© ì£¼ì„ ì •ë¦¬ ì™„ë£Œ!");
      });

      updateGlobalFnUI();


      /* ==========================
         Block Logic
      ========================== */
      function updatePill(){
        const n = elBlocks.querySelectorAll("[data-bcg-block]").length;
        pill.textContent = `ë¸”ë¡ ${n}ê°œ`;
      }

      function buildHtmlAndList(bodyVal, allowTags){
        let bodyHtml = textToParagraphHtml(bodyVal, !!allowTags);
        const map = loadGlobalFootnotes();
        const globalKeys = Object.keys(map);
        
        const foundIds = [];
        const re = /<a [^>]*data-(?:fn-idx|footnote-id)="([^"]+)"[^>]*>.*?<\/a>/g;
        
        let m;
        while ((m = re.exec(bodyHtml)) !== null) {
            foundIds.push(m[1]);
        }
        
        const uniqueIds = [...new Set(foundIds)];
        let finalBody = bodyHtml;
        let listHtml = "";
        
        if (uniqueIds.length > 0) {
            uniqueIds.forEach((uid) => {
                const gIdx = globalKeys.indexOf(uid);
                let num;
                if(gIdx !== -1) {
                    num = gIdx + 1;
                } else {
                    num = "?";
                }
                
                const content = map[uid] || "(ì‚­ì œëœ ì£¼ì„)";
                
                if(num !== "?") {
                    listHtml += `<li id="fn${num}">\n  <a href="#fn${num}-ref" class="cheese-footnote-index">*${num}</a>\n  ${escapeHtmlLite(content)}\n</li>\n`;
                }

                const targetRe = new RegExp(`<a [^>]*data-(?:fn-idx|footnote-id)="${escapeRegExp(uid)}"[^>]*>.*?<\/a>`, "g");
                finalBody = finalBody.replace(targetRe, 
                    `<a id="fn${num}-ref" href="#fn${num}" class="cheese-footnote-index" data-footnote-id="fn${num}">*${num}</a>`
                );
            });
        }

        return { body: finalBody, list: listHtml, count: uniqueIds.length };
      }
      
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function createBlock(){
        seq += 1;
        const id = "bcg_" + seq;
        const wrap = document.createElement("div");
        wrap.className = "bcg-card";
        wrap.setAttribute("data-bcg-block", id);
        
        wrap.bcgData = { footnotes: [] };

        wrap.innerHTML = `
          <div class="bcg-row">
            <span class="bcg-badge">ë¸”ë¡ #${seq}</span>
            <div class="bcg-right bcg-row" style="margin-top:0;">
              <div style="display:flex; align-items:center; gap:6px; margin-right:10px;">
                <span class="bcg-label" style="margin-bottom:0;">ì‹œì‘ ë²ˆí˜¸:</span>
                <input type="number" data-start-idx class="bcg-input bcg-num" value="1" min="1" style="width:60px; height:32px; padding:4px;" disabled title="ìë™ ì •ë ¬ ëª¨ë“œì—ì„œëŠ” 1ë²ˆë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.">
              </div>
              <label class="bcg-check">
                <input type="checkbox" data-keep-raw />
                ì„œì‹/íƒœê·¸ í—ˆìš©
              </label>
              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-send>ê´€ë¦¬ìë¡œ ì „ì†¡ ğŸš€</button>
              <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-remove>ì‚­ì œ</button>
            </div>
          </div>
          <div class="bcg-split" style="margin-top:10px;">
            <div>
              <div class="bcg-row">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <span class="bcg-label">ì†Œì œëª©</span>
                    <select class="bcg-select" data-level><option value="h1">H1</option><option value="h2" selected>H2</option><option value="h3">H3</option></select>
                  </div>
                  <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                    <span class="bcg-label">ì†Œì œëª© í…ìŠ¤íŠ¸</span>
                    <input class="bcg-input" data-heading placeholder="ì˜ˆ) ìˆ™ì¢…ì˜ í™˜êµ­ì •ì¹˜" />
                  </div>
                </div>
              </div>
              
              <div class="bcg-row" style="background:rgba(15,23,42,0.02); padding:8px 10px; border-radius:8px;">
                <span class="bcg-label">ì£¼ì„ ì¶”ê°€:</span>
                <span class="bcg-muted" data-fn-status>0ê°œ (ìë™ì •ë ¬)</span>
                <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-fn-reset style="padding:2px 8px; font-size:11px; margin-left:auto;">ë¡œì»¬ ì´ˆê¸°í™”</button>
              </div>

              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">ë³¸ë¬¸</span>
                  <div style="display:flex; flex-direction:column; gap:10px; margin:10px 0;">
                  <div style="display:flex; gap:8px; align-items:center;">
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bold">êµµê²Œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="br">ì¤„ë°”ê¿ˆ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="table">í‘œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="footnote" style="color:#2563eb; border-color:#bfdbfe; background:#eff6ff;">ì£¼ì„(Fn)</button>
                      
                      <div style="width:1px; height:14px; background:rgba(15,23,42,0.1); margin:0 4px;"></div>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="ai" style="color:#9333ea; border-color:#e9d5ff; background:#faf5ff;">âœ¨ AI ê¸€ì“°ê¸°</button>
                    </div>
                    
                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ê¸€ììƒ‰ <input type="color" data-color value="#111827" /></span>
                      <span class="bcg-swatches" data-color-swatches>
                        <button class="bcg-swatch" type="button" data-color-preset="#111827" title="ê¸°ë³¸(ê²€ì •)" style="background:#111827;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#475569" title="íšŒìƒ‰" style="background:#475569;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#2563eb" title="íŒŒë‘" style="background:#2563eb;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#16a34a" title="ì´ˆë¡" style="background:#16a34a;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#d97706" title="ì£¼í™©" style="background:#d97706;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#e11d48" title="ë¹¨ê°•" style="background:#e11d48;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="color">ì ìš©</button>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ë°°ê²½ <input type="color" data-bg value="#fde68a" /></span>
                      <span class="bcg-swatches" data-bg-swatches>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fde68a" title="ë…¸ë‘" style="background:#fde68a;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fecdd3" title="í•‘í¬" style="background:#fecdd3;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bfdbfe" title="í•˜ëŠ˜" style="background:#bfdbfe;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bbf7d0" title="ì—°ë‘" style="background:#bbf7d0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#e2e8f0" title="ì—°íšŒìƒ‰" style="background:#e2e8f0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#ddd6fe" title="ì—°ë³´ë¼" style="background:#ddd6fe;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bg">ì ìš©</button>
                    </div>
                  </div>
                  <textarea class="bcg-textarea" data-body placeholder="ì—¬ê¸°ì— ë¸”ë¡œê·¸ ì›ë¬¸ì„ ë¶™ì—¬ë„£ì–´."></textarea>
                </div>
              </div>
            </div>
            <div>
              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <div style="display:flex; align-items:center; justify-content:space-between;">
                    <span class="bcg-label">1. ë³¸ë¬¸ ì½”ë“œ (ìë™ ì¬ì •ë ¬ë¨)</span>
                    <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-copy>ë³¸ë¬¸ ë³µì‚¬</button>
                  </div>
                  <textarea class="bcg-output" data-output readonly placeholder="ë³¸ë¬¸ìš© HTML"></textarea>
                  
                  <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
                     <span class="bcg-label">2. ì£¼ì„ ëª©ë¡ ì½”ë“œ (ìë™ ìˆœì„œ)</span>
                     <div style="display:flex; gap:4px;">
                       <button class="bcg-btn bcg-mini" type="button" data-copy-li title="<li>...</li> íƒœê·¸ë§Œ ë³µì‚¬í•©ë‹ˆë‹¤">ì£¼ì„(li) ë³µì‚¬</button>
                       <button class="bcg-btn bcg-mini" type="button" data-copy-wrapper title="<ol> í‹€ ì½”ë“œë¥¼ ë³µì‚¬í•©ë‹ˆë‹¤">ì£¼ì„ í‹€(<ol>) ë³µì‚¬</button>
                     </div>
                  </div>
                  <textarea class="bcg-output-mini" data-output-li readonly placeholder="ì£¼ì„ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— <li>...</li> ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤."></textarea>

                  <div class="bcg-row" style="margin-top:10px;">
                    <span class="bcg-label">ë¯¸ë¦¬ë³´ê¸°</span>
                  </div>
                  <div class="bcg-preview" data-preview></div>
                </div>
              </div>
            </div>
          </div>
        `;

        const levelEl = wrap.querySelector("[data-level]");
        const headingEl = wrap.querySelector("[data-heading]");
        const bodyEl = wrap.querySelector("[data-body]");
        const outEl = wrap.querySelector("[data-output]");
        const outLiEl = wrap.querySelector("[data-output-li]");
        const prevEl = wrap.querySelector("[data-preview]");
        const keepRawEl = wrap.querySelector("[data-keep-raw]");
        
        const fnStatusEl = wrap.querySelector("[data-fn-status]");
        const startIdxEl = wrap.querySelector("[data-start-idx]");

        const btnCopy = wrap.querySelector("[data-copy]");
        const btnCopyLi = wrap.querySelector("[data-copy-li]");
        const btnCopyWrapper = wrap.querySelector("[data-copy-wrapper]");
        const btnRemove = wrap.querySelector("[data-remove]");
        const btnSend = wrap.querySelector("[data-send]");
        
        // ìƒ‰ìƒ ê´€ë ¨ ì—˜ë¦¬ë¨¼íŠ¸
        const colorEl = wrap.querySelector("[data-color]");
        const bgEl = wrap.querySelector("[data-bg]");

        function checkStartIdx() {
           if (!wrap.bcgData.hasManualIdx) {
              const globalList = loadGlobalFootnotes();
              // startIdxEl.value = globalList.length + 1; // Removed
           }
        }
        wrap.bcgCheckStartIdx = checkStartIdx;
        setTimeout(checkStartIdx, 0);

        startIdxEl.addEventListener("input", () => {
           wrap.bcgData.hasManualIdx = true; 
           regenerate();
        });

        function regenerate(){
            const result = buildHtmlAndList(bodyEl.value, keepRawEl.checked);
            
            fnStatusEl.textContent = `${result.count}ê°œ (ìë™ì •ë ¬)`;
            // startIdxEl.value = 1; // Removed

            const tag = (levelEl.value === "h1" || levelEl.value === "h2" || levelEl.value === "h3") ? levelEl.value : "h2";
            const headText = escapeHtmlLite(String(headingEl.value ?? "").trim());
            const headPart = headText ? `<${tag}>${headText}</${tag}>` : "";
            
            const finalHtml = [headPart, result.body].filter(Boolean).join("\n");
            
            outEl.value = finalHtml;
            outLiEl.value = result.list;
            
            if (prevEl) {
               prevEl.innerHTML = finalHtml + (result.list ? `<hr><ol class="cheese-footnotes">${result.list}</ol>` : "");
            }
        }
        
        wrap.bcgRegenerate = regenerate;

        btnCopy.addEventListener("click", async () => {
          if (!outEl.value.trim()) regenerate();
          await copyToClipboard(outEl.value);
          showToast("ë³¸ë¬¸ ì½”ë“œ ë³µì‚¬ ì™„ë£Œ!");
        });

        btnCopyLi.addEventListener("click", async () => {
          if (!outLiEl.value.trim()) return showToast("ë³µì‚¬í•  ì£¼ì„ì´ ì—†ì–´.");
          await copyToClipboard(outLiEl.value);
          showToast("ì£¼ì„ ëª©ë¡(li) ë³µì‚¬ ì™„ë£Œ!");
        });

        btnCopyWrapper.addEventListener("click", async () => {
          const tpl = `\n<hr>\n<ol class="cheese-footnotes">\n  \n</ol>`;
          await copyToClipboard(tpl);
          showToast("ì£¼ì„ í‹€(<ol>) ë³µì‚¬ ì™„ë£Œ!");
        });
        
        btnSend.addEventListener("click", () => {
          if (!outEl.value.trim()) regenerate(); 
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ type: 'CH_BLOG_CODE', content: outEl.value, target: currentTarget }, '*');
            showToast(`ğŸš€ ì „ì†¡ ì™„ë£Œ!`);
          } else {
            alert("ê´€ë¦¬ì ì°½ì´ ë‹«í˜€ìˆê±°ë‚˜ ì—°ê²°ì´ ëŠì–´ì¡Œì–´.");
          }
        });

        btnRemove.addEventListener("click", () => { 
            wrap.remove(); 
            updatePill(); 
        });

        let t = null;
        function schedule(){ clearTimeout(t); t = setTimeout(regenerate, 180); }
        [levelEl, headingEl, bodyEl, keepRawEl].forEach(el => el.addEventListener("input", schedule));
        levelEl.addEventListener("change", schedule);
        keepRawEl.addEventListener("change", schedule);

        // ì„œì‹ ë²„íŠ¼ ë¡œì§
        let lastSel = { s:0, e:0 };
        function saveSel_(){ try{ lastSel.s = bodyEl.selectionStart; lastSel.e = bodyEl.selectionEnd; }catch(e){} }
        function restoreSel_(){ try{ bodyEl.focus(); bodyEl.setSelectionRange(lastSel.s, lastSel.e); }catch(e){} }
        // bodyEl.addEventListener("blur", saveSel_); // ì‚­ì œ: ë²„íŠ¼ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ ìƒëŠ” ë¬¸ì œ ë°©ì§€
        bodyEl.addEventListener("mouseup", saveSel_);
        bodyEl.addEventListener("keyup", saveSel_);
        bodyEl.addEventListener("select", saveSel_);
        
        function hasSelection_(){ const s = lastSel.s ?? 0, e = lastSel.e ?? 0; return s !== e; }
        function ensureAllowTagsOn_(){ if (!keepRawEl.checked){ keepRawEl.checked = true; showToast("ì„œì‹/íƒœê·¸ í—ˆìš© ON"); } }

        wrap.querySelectorAll("[data-color-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-color-preset");
            if (!v) return;
            colorEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<span style="color:${colorEl.value}">`, "</span>");
              schedule();
              showToast("ê¸€ììƒ‰ ì ìš©!");
            }else{
              showToast("ê¸€ììƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        wrap.querySelectorAll("[data-bg-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-bg-preset");
            if (!v) return;
            bgEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<mark style="background:${bgEl.value}">`, "</mark>");
              schedule();
              showToast("ë°°ê²½ìƒ‰ ì ìš©!");
            }else{
              showToast("ë°°ê²½ìƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        wrap.querySelectorAll("[data-fmt]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const fmt = btn.getAttribute("data-fmt");
            if (!fmt) return;
            ensureAllowTagsOn_();

            if (fmt === "ai") {
              openAiModal(bodyEl);
              return;
            }
            
            if (fmt === "footnote") {
              const noteContent = prompt("ì£¼ì„ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ë²ˆí˜¸ëŠ” ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ ë§¤ê²¨ì§‘ë‹ˆë‹¤)");
              if (noteContent) {
                // ë‚´ìš©ì„ URL ì¸ì½”ë”©í•˜ì—¬ íƒœê·¸ ì†ì„±ì— ì €ì¥
                const encoded = encodeURIComponent(noteContent);
                // ì„ì‹œ ID ìƒì„±
                const uid = "fn_" + Math.random().toString(36).substr(2, 6);
            
                restoreSel_();
                // í™”ë©´ì—ëŠ” *? ë¡œ í‘œì‹œë˜ê³ , ë‚´ìš©ì€ data-note ì†ì„±ì— ìˆ¨ê¹€
                const linkTag = `<a id="ref_${uid}" href="#note_${uid}" class="cheese-footnote-ref" data-note="${encoded}">*?</a>`;
                insertAtSelection(bodyEl, linkTag);
                
                schedule();
                showToast("ì£¼ì„ íƒœê·¸(*?)ê°€ ì¶”ê°€ë˜ì—ˆì–´.");
              }
              return;
            }

            if (fmt === "table"){
              openTableModal_({ bodyEl, ensureAllowTagsOn_, schedule, showToast });
              return;
            }
            
            restoreSel_();
            if (fmt === "bold") wrapSelection(bodyEl, "<strong>", "</strong>");
            else if (fmt === "br") wrapSelection(bodyEl, "<br>", "");
            else if (fmt === "color"){
              const c = (colorEl && colorEl.value) ? colorEl.value : "#111827";
              wrapSelection(bodyEl, `<span style="color:${c}">`, "</span>");
            }else if (fmt === "bg"){
              const b = (bgEl && bgEl.value) ? bgEl.value : "#fde68a";
              wrapSelection(bodyEl, `<mark style="background:${b}">`, "</mark>");
            }
            schedule();
          });
        });

        regenerate(); 
        return wrap;
      }

      addBtn.addEventListener("click", () => {
        elBlocks.appendChild(createBlock());
        updatePill();
      });

      // ì´ˆê¸° ë¸”ë¡
      elBlocks.appendChild(createBlock());
      updatePill();

      window.addEventListener("message", (e) => {
        if (e.data && e.data.type === 'CH_LOAD_DATA') {
          const content = e.data.content || "";
          
          // ê¸°ì¡´ ì£¼ì„ ë°ì´í„°ê°€ ìˆëŠ”ë° ë¶ˆëŸ¬ì˜¨ ë³¸ë¬¸ì´ ë¹„ì–´ìˆë‹¤ë©´, ì´ˆê¸°í™” ì œì•ˆ
          const map = loadGlobalFootnotes();
          if (!content.trim() && Object.keys(map).length > 0) {
             showToast("ìƒˆ ê¸€ ì“°ê¸° ìœ„í•´ ì£¼ì„ì„ ì´ˆê¸°í™”í• ê¹Œ?", "ì´ˆê¸°í™”", () => {
                 localStorage.removeItem(STORAGE_KEY);
                 updateGlobalFnUI();
             });
          }

          const firstBlock = elBlocks.querySelector("[data-bcg-block]");
          if (firstBlock) {
            const bodyEl = firstBlock.querySelector("[data-body]");
            const keepRawEl = firstBlock.querySelector("[data-keep-raw]");
            if (bodyEl) {
                bodyEl.value = content;
                if (content.trim()) {
                    if (keepRawEl) keepRawEl.checked = true;
                    showToast("ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
                }
                bodyEl.dispatchEvent(new Event("input"));
            }
          }
        }
      });

      if (window.opener) setTimeout(() => window.opener.postMessage({ type: 'CH_CODE_GEN_READY' }, '*'), 100);


      /* ==========================
         AI ìë™ ì‘ì„± Logic (Server ì—°ê²°)
      ========================== */
      // ğŸš¨ ì£¼ì˜: ë³¸ì¸ì˜ í¬ìŠ¤íŠ¸ ê´€ë¦¬ ë°°í¬ URLë¡œ ë³€ê²½í•˜ì„¸ìš”.
      const CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwXqz1uMy3EOrisCEKIe0Fk7yu0P6MQ1ddHDvo7Sr_CPEYY0RHP2GyUBL8YhaBqxnmBJg/exec";

      const aiModal = document.getElementById("aiModal");
      const aiTopic = document.getElementById("aiTopic");
      const aiTone = document.getElementById("aiTone");
      const aiRefText = document.getElementById("aiRefText");
      const aiOpinion = document.getElementById("aiOpinion");
      const aiOutput = document.getElementById("aiOutput");
      const aiGenerateBtn = document.getElementById("aiGenerateBtn");
      const aiRegenerateBtn = document.getElementById("aiRegenerateBtn");
      const aiApplyBtn = document.getElementById("aiApplyBtn");

      let activeAiBodyCtx = null;

      window.openAiModal = function(bodyEl) {
          activeAiBodyCtx = bodyEl;
          aiRefText.value = "";
          aiOpinion.value = "";
          aiOutput.value = "";
          aiRegenerateBtn.style.display = "none";
          aiModal.hidden = false;
          aiModal.style.display = 'flex';
      };

      function closeAiModal() {
          aiModal.hidden = true;
          aiModal.style.display = 'none';
          activeAiBodyCtx = null;
      }

      document.getElementById("aiModalCloseBtn").onclick = closeAiModal;
      aiModal.onclick = (e) => { if(e.target === aiModal) closeAiModal(); };

      async function requestAiGeneration() {
          const topic = aiTopic.value.trim();
          const tone = aiTone.value;
          const refText = aiRefText.value.trim();
          const opinion = aiOpinion.value.trim();

          if (!refText && !opinion && !topic) {
              alert("ì£¼ì œ, ì°¸ê³ í•  ê¸€, ë‚´ ì˜ê²¬ ì¤‘ í•˜ë‚˜ ì´ìƒì€ ì…ë ¥í•´ì£¼ì„¸ìš”!");
              return;
          }

          aiGenerateBtn.disabled = true;
          aiRegenerateBtn.disabled = true;
          aiOutput.value = "ì„œë²„ì—ì„œ AIê°€ ê¸€ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... â³\n(ì•½ 5~15ì´ˆ ì†Œìš”)";

          // ğŸš¨ JSON ê°ì²´ë¡œ í˜ì´ë¡œë“œ êµ¬ì„± (report_archive ì™€ ë™ì¼í•œ ë°©ì‹)
          const payload = {
              mode: 'generateAI',
              topic: topic,
              tone: tone,
              refText: refText,
              opinion: opinion
          };

          try {
              // ğŸš¨ JSON.stringify ë¡œ ë¬¶ì–´ì„œ ì „ì†¡ (ë³„ë„ì˜ Content-Type í—¤ë”ë¥¼ ë„£ì§€ ì•Šì•„ì•¼ CORS ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤)
              const response = await fetch(CHEESE_ADMIN_API_BASE, {
                  method: 'POST',
                  body: JSON.stringify(payload)
              });
              
              const data = await response.json();

              if (data.ok) {
                  aiOutput.value = data.text;
                  aiRegenerateBtn.style.display = "inline-flex";
              } else {
                  aiOutput.value = "ìƒì„± ì˜¤ë¥˜: " + data.message;
              }
          } catch (error) {
              aiOutput.value = "í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message;
          } finally {
              aiGenerateBtn.disabled = false;
              aiRegenerateBtn.disabled = false;
          }
      }

      aiGenerateBtn.onclick = requestAiGeneration;
      aiRegenerateBtn.onclick = requestAiGeneration;

      aiApplyBtn.onclick = () => {
          const resultText = aiOutput.value.trim();
          if (!resultText) {
              alert("ë°˜ì˜í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
              return;
          }
          if (activeAiBodyCtx) {
              insertAtSelection(activeAiBodyCtx, resultText + "\n\n");
              activeAiBodyCtx.dispatchEvent(new Event("input"));
              showToast("âœ¨ AI ìƒì„± ê¸€ì´ ë³¸ë¬¸ì— ë°˜ì˜ë˜ì—ˆì–´!");
          }
          closeAiModal();
      };
      
      const pad2 = n => String(n).padStart(2, '0');
      (function showVersion(){
        const el = document.getElementById("sysVersion");
        if(!el) return;
        const d = new Date(document.lastModified);
        el.textContent = `Updated: ${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}_${pad2(d.getHours())}${pad2(d.getMinutes())}`;
      })();
    })();
  </script>
</body>
</html>
