<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</title>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .bcg-wrap{ padding:14px; }

    .bcg-hero{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .bcg-title{
      margin:0;
      font-weight:950;
      letter-spacing:-0.2px;
      font-size:18px;
    }
    .bcg-sub{
      margin:6px 0 0;
      color:rgba(15,23,42,.72);
      line-height:1.45;
      font-size:13px;
    }

    .bcg-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .bcg-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .bcg-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .bcg-row:first-child{ margin-top:0; }

    .bcg-label{
      font-weight:900;
      font-size:12px;
      color:rgba(15,23,42,.78);
    }

    .bcg-input, .bcg-select, .bcg-textarea{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.18);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:13px;
    }
    .bcg-input{ min-width:240px; flex:1; }
    .bcg-select{ min-width:110px; }
    .bcg-textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      line-height:1.55;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "ë§‘ì€ ê³ ë”•", sans-serif;
    }

    .bcg-output{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,0.26);
      border-radius:12px;
      background:rgba(15,23,42,0.02);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.55;
      white-space:pre;
    }

    .bcg-preview{
      width:100%;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      padding:12px;
      background:#fff;
      box-shadow:0 8px 18px rgba(15,23,42,0.06);
      min-height:64px;
      overflow:auto;
    }
    .bcg-preview h1, .bcg-preview h2, .bcg-preview h3{
      margin:0 0 10px;
      line-height:1.25;
    }
    .bcg-preview p{ margin:0 0 10px; line-height:1.6; }
    .bcg-preview p:last-child{ margin-bottom:0; }
    .bcg-preview-empty{
      color:rgba(15,23,42,.55);
      font-size:12px;
    }

    /* Footnote Preview Style (Simple) */
    .bcg-preview .cheese-footnotes {
      margin-top: 20px;
      border-top: 1px solid #eee;
      padding-top: 10px;
      padding-left: 20px;
      font-size: 0.9em;
      color: #555;
    }
    .bcg-preview .cheese-footnote-ref {
      color: #2563eb;
      font-size: 0.8em;
      vertical-align: super;
      text-decoration: none;
    }

    .bcg-btn{
      border:1px solid rgba(15,23,42,0.16);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      transition:transform .06s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      user-select:none;
    }
    .bcg-btn:active{ transform:translateY(1px); box-shadow:0 5px 12px rgba(15,23,42,0.10); }
    .bcg-btn:hover{ background:rgba(15,23,42,0.02); border-color:rgba(15,23,42,0.22); }

    .bcg-btn--primary{
      border-color:rgba(37,99,235,0.38);
      box-shadow:0 10px 20px rgba(37,99,235,0.14);
    }
    .bcg-btn--primary:hover{ background:rgba(37,99,235,0.06); border-color:rgba(37,99,235,0.55); }

    .bcg-btn--danger{
      border-color:rgba(239,68,68,0.30);
      box-shadow:0 10px 20px rgba(239,68,68,0.10);
    }
    .bcg-btn--danger:hover{ background:rgba(239,68,68,0.06); border-color:rgba(239,68,68,0.48); }

    .bcg-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      font-size:12px;
      color:rgba(15,23,42,.72);
    }

    .bcg-toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:9999;
      max-width:min(420px, calc(100vw - 32px));
      background:rgba(15,23,42,0.92);
      color:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
      font-size:13px;
      line-height:1.35;
      transform:translateY(10px);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .bcg-toast.show{ opacity:1; transform:translateY(0); }

    .bcg-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .bcg-split{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .bcg-split{ grid-template-columns:1fr; }
    }

    .bcg-muted{
      color:rgba(15,23,42,.62);
      font-size:12px;
    }

    .bcg-sep{
      height:1px;
      background:rgba(15,23,42,0.10);
      margin:12px 0;
    }

    .bcg-mini{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      box-shadow:none;
    }

    .bcg-badge{
      font-weight:950;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:rgba(15,23,42,0.02);
    }

    .bcg-right{ margin-left:auto; }

    .bcg-check{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:rgba(15,23,42,.72);
      user-select:none;
    }
    .bcg-check input{ width:16px; height:16px; }
    .bcg-toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin:6px 0 8px;
    }
    .bcg-pill input[type="color"]{
      width:34px;
      height:20px;
      padding:0;
      border:0;
      background:transparent;
      cursor:pointer;
    }
    .bcg-pill input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; }
    .bcg-pill input[type="color"]::-webkit-color-swatch{
      border:1px solid rgba(15,23,42,0.18);
      border-radius:6px;
    }
  
    /* ===== table styles (preview) ===== */
    .bcg-preview .cheese-table{
      width:100%;
      border-collapse:collapse;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      overflow:hidden;
    }
    .bcg-preview .cheese-table th,
    .bcg-preview .cheese-table td{
      border:1px solid rgba(15,23,42,0.14);
      padding:10px;
      vertical-align:top;
      font-size:13px;
      line-height:1.45;
    }
    .bcg-preview .cheese-table th{
      background:rgba(15,23,42,0.04);
      font-weight:900;
    }
    .bcg-preview .cheese-table caption{
      caption-side:top;
      text-align:left;
      font-weight:900;
      padding:8px 2px 10px;
      color:rgba(15,23,42,.78);
    }

    /* ===== modal (table builder) ===== */
    .bcg-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:10000;
    }
    .bcg-modal-backdrop[hidden]{display:none !important;}
    .bcg-modal{
      width:min(920px, 100%);
      max-height:min(86vh, 900px);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.14);
      box-shadow:0 20px 60px rgba(15,23,42,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .bcg-modal-head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(15,23,42,0.10);
    }
    .bcg-modal-title{
      font-weight:950;
      margin:0;
      font-size:14px;
    }
    .bcg-modal-body{
      padding:14px;
      overflow:auto;
    }
    .bcg-modal-foot{
      padding:12px 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid rgba(15,23,42,0.10);
      background:rgba(15,23,42,0.02);
    }
    .bcg-modal-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .bcg-table-controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .bcg-table-controls .bcg-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bcg-num{
      width:90px;
    }
    .bcg-table-editor{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      overflow:auto;
      background:#fff;
    }
    .bcg-table-cells{
      display:grid;
      gap:6px;
      padding:10px;
    }
    .bcg-cell{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:10px;
      padding:8px 10px;
      min-height:40px;
      font-size:13px;
      outline:none;
    }
    .bcg-cell:focus{
      border-color:rgba(37,99,235,0.55);
      box-shadow:0 0 0 3px rgba(37,99,235,0.14);
    }

    /* quick color swatches */
    .bcg-swatches{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-left:8px;
      vertical-align:middle;
      flex-wrap:wrap;
    }
    .bcg-swatch{
      width:18px;
      height:18px;
      border-radius:7px;
      border:1px solid rgba(15,23,42,0.18);
      cursor:pointer;
      box-shadow:0 6px 14px rgba(15,23,42,0.10);
      padding:0;
    }
    .bcg-swatch:active{ transform:translateY(1px); }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="bcg-wrap">

          <div class="bcg-card">
            <div class="bcg-hero">
              <div>
                <h1 class="bcg-title">ë¸”ë¡œê·¸ ì½”ë“œ ìƒì„±</h1>
                <p class="bcg-sub">
                  ì†Œì œëª©(H1/H2/H3) + ë³¸ë¬¸ì„ ë„£ìœ¼ë©´, <b>ë°”ë¡œ í¬ìŠ¤íŠ¸ ê´€ë¦¬(BODY_1/2/3 ë“±)ì— ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” HTML</b>ë¡œ ë³€í™˜í•´ì¤˜.
                  ë³¸ë¬¸ ë¸”ë¡ì€ ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€í•  ìˆ˜ ìˆê³ , <b>ê° ë¸”ë¡ë§ˆë‹¤ ê²°ê³¼ë¥¼ ë”°ë¡œ ë³µì‚¬</b>í•  ìˆ˜ ìˆì–´.
                </p>
              </div>

              <div class="bcg-actions">
                <span class="bcg-pill" id="blockCountPill">ë¸”ë¡ 0ê°œ</span>
                <button class="bcg-btn bcg-btn--primary" id="addBlockBtn" type="button">ï¼‹ ë¸”ë¡ ì¶”ê°€</button>
              </div>
            </div>

            <div class="bcg-sep"></div>

            <div class="bcg-grid" id="blocks"></div>

            <div class="bcg-sep"></div>

            <div class="bcg-row">
              <span class="bcg-muted">
                â€» ë³€í™˜ ê·œì¹™: ë¹ˆ ì¤„ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ë‹¨ ë¶„ë¦¬(<code>&lt;p&gt;</code>), ë¬¸ë‹¨ ë‚´ë¶€ ì¤„ë°”ê¿ˆì€ <code>&lt;br&gt;</code> ì²˜ë¦¬. ê¸°ë³¸ì€ HTML ì´ìŠ¤ì¼€ì´í”„(ì•ˆì „). â€˜ì„œì‹/íƒœê·¸ í—ˆìš©â€™ì´ ì¼œì ¸ ìˆìœ¼ë©´ strong/span/mark/br/table ê´€ë ¨ íƒœê·¸ë§Œ í—ˆìš©í•´.
              </span>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  
  <div class="bcg-modal-backdrop" id="tableModal" hidden style="display:none" aria-hidden="true">
    <div class="bcg-modal" role="dialog" aria-modal="true" aria-labelledby="tableModalTitle">
      <div class="bcg-modal-head">
        <h3 class="bcg-modal-title" id="tableModalTitle">í‘œ ë§Œë“¤ê¸°</h3>
        <span class="bcg-muted">ì…€ì„ ì±„ìš°ê³  â€œì‚½ì…â€ì„ ëˆ„ë¥´ë©´ ë³¸ë¬¸ì— í‘œ HTMLì´ ë“¤ì–´ê°€.</span>
        <span class="bcg-right"></span>
        <button class="bcg-btn bcg-mini" type="button" id="tableModalCloseBtn">ë‹«ê¸°</button>
      </div>

      <div class="bcg-modal-body">
        <div class="bcg-modal-grid">
          <div class="bcg-table-controls">
            <div class="bcg-field">
              <span class="bcg-label">í–‰</span>
              <input class="bcg-input bcg-num" id="tblRows" type="number" min="1" max="30" value="3">
            </div>
            <div class="bcg-field">
              <span class="bcg-label">ì—´</span>
              <input class="bcg-input bcg-num" id="tblCols" type="number" min="1" max="12" value="3">
            </div>
            <div class="bcg-field">
              <span class="bcg-label">ì˜µì…˜</span>
              <label class="bcg-check" style="margin-top:4px;">
                <input type="checkbox" id="tblHeader" checked>
                ì²« ì¤„ì„ í—¤ë”(th)ë¡œ
              </label>
            </div>
            <div class="bcg-field" style="min-width:240px; flex:1;">
              <span class="bcg-label">ìº¡ì…˜(ì„ íƒ)</span>
              <input class="bcg-input" id="tblCaption" placeholder="ì˜ˆ) ì‹œëŒ€ë³„ ì™•ìœ„ ê³„ìŠ¹ ì •ë¦¬">
            </div>

            <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" id="tblRebuildBtn">ê·¸ë¦¬ë“œ ìƒì„±</button>
          </div>

          <div class="bcg-table-editor">
            <div class="bcg-muted" style="padding:10px 10px 0;">
              íŒ) ì—‘ì…€/ì‹œíŠ¸ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸(íƒ­ êµ¬ë¶„)ë¥¼ ì…€ì— ë¶™ì—¬ë„£ì–´ë„ ë¼. ì—”í„°ëŠ” ì¤„ë°”ê¿ˆ, Ctrl+ì—”í„°ëŠ” ë‹¤ìŒ ì…€ ì´ë™.
            </div>
            <div class="bcg-table-cells" id="tblCells"></div>
          </div>

          <div class="bcg-muted">
            ìƒì„±ë˜ëŠ” í‘œëŠ” <code>&lt;table class="cheese-table"&gt;</code> í˜•íƒœì•¼. ë¸”ë¡œê·¸ ê³µí†µ CSSì—ì„œ <code>.cheese-table</code> ìŠ¤íƒ€ì¼ì„ ì¡ì•„ë‘ë©´ ê¸€ë§ˆë‹¤ í†µì¼ë¼.
          </div>
        </div>
      </div>

      <div class="bcg-modal-foot">
        <button class="bcg-btn bcg-mini" type="button" id="tblInsertBtn">ì‚½ì…</button>
      </div>
    </div>
  </div>


  <div class="bcg-toast" id="toast"></div>

  <script src="./admin-common.js"></script>

  <script>
    (function(){
      // URL íƒ€ê²Ÿ í™•ì¸ ë° íŒì—… ëª¨ë“œ ì„¤ì •
      const urlParams = new URLSearchParams(window.location.search);
      const currentTarget = urlParams.get('target') || "";

      if (currentTarget) {
        const titleEl = document.querySelector(".bcg-title");
        if(titleEl) {
          titleEl.innerHTML += ` <span class="bcg-badge" style="color:#0284c7; background:#e0f2fe; vertical-align:middle; font-size:13px;">ğŸ¯ íƒ€ê²Ÿ: ${currentTarget}</span>`;
        }
        const header = document.getElementById("admin-header-slot");
        const menu = document.getElementById("admin-menu-slot");
        const main = document.querySelector(".admin-main");

        if (header) header.style.display = "none";
        if (menu) menu.style.display = "none";
        if (main) {
          main.style.display = "block";
          main.style.padding = "0";
          main.style.height = "auto";
        }
        document.body.style.backgroundColor = "#fff";

        const addBtnEl = document.getElementById("addBlockBtn");
        const pillEl = document.getElementById("blockCountPill");
        if (addBtnEl) addBtnEl.style.display = "none";
        if (pillEl) pillEl.style.display = "none";
      }

      const elBlocks = document.getElementById("blocks");
      const addBtn = document.getElementById("addBlockBtn");
      const pill = document.getElementById("blockCountPill");
      const toast = document.getElementById("toast");

      // Table Builder Elements
      const tableModal = document.getElementById("tableModal");
      const tableModalCloseBtn = document.getElementById("tableModalCloseBtn");
      const tblRowsEl = document.getElementById("tblRows");
      const tblColsEl = document.getElementById("tblCols");
      const tblHeaderEl = document.getElementById("tblHeader");
      const tblCaptionEl = document.getElementById("tblCaption");
      const tblRebuildBtn = document.getElementById("tblRebuildBtn");
      const tblCellsEl = document.getElementById("tblCells");
      const tblInsertBtn = document.getElementById("tblInsertBtn");

      let seq = 0;
      let tableCtx = null;

      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
      }

      function clampInt_(v, min, max, fallback){
        const n = parseInt(v, 10);
        if (!Number.isFinite(n)) return fallback;
        return Math.max(min, Math.min(max, n));
      }

      function escapeHtmlLite(s){
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function protectAllowedTags_(s){
        const src = String(s ?? "");
        const map = [];
        // ì£¼ì„ íƒœê·¸(a) í—ˆìš© ì¶”ê°€
        const re = /<\/?(?:strong|em|u|s)\s*>|<br\s*\/?>|<mark\s+style="background:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/mark>|<span\s+style="color:\s*#[0-9a-fA-F]{3,8}\s*"\s*>|<\/span>|<table\s+class="cheese-table"\s*>|<\/table>|<thead\s*>|<\/thead>|<tbody\s*>|<\/tbody>|<tr\s*>|<\/tr>|<th\s*>|<\/th>|<td\s*>|<\/td>|<caption\s*>|<\/caption>|<a\s+[^>]*cheese-footnote-ref[^>]*>.*?<\/a>/gi;
        const out = src.replace(re, (m)=>{
          const key = `@@ALLOWED_TAG_${map.length}@@`;
          map.push(m);
          return key;
        });
        return { out, map };
      }

      function restoreAllowedTags_(s, map){
        let out = String(s ?? "");
        (map || []).forEach((tag, i)=>{
          out = out.split(`@@ALLOWED_TAG_${i}@@`).join(tag);
        });
        return out;
      }

      function escapeText_(s, allowTags){
        if (!allowTags) return escapeHtmlLite(s);
        const { out, map } = protectAllowedTags_(s);
        const escaped = escapeHtmlLite(out);
        return restoreAllowedTags_(escaped, map);
      }

      function textToParagraphHtml(text, allowTags) {
        const raw = String(text ?? "").replace(/\r\n/g, "\n").replace(/\u200B/g, '');
        const chunks = raw.split(/\n{2,}/g); 
        if (chunks.length === 0) return "";
        return chunks.map(chunk => {
          const trimmedChunk = chunk.trim();
          // í…Œì´ë¸”ì´ë‚˜ ì£¼ì„ ë¦¬ìŠ¤íŠ¸ ë“± ë¸”ë¡ ìš”ì†Œê°€ ìˆìœ¼ë©´ ë¬¸ë‹¨ ê°ì‹¸ê¸° ì œì™¸ ê°€ëŠ¥ (ì—¬ê¸°ì„  ê°„ë‹¨íˆ ì²˜ë¦¬)
          if (allowTags && /^<table\b/i.test(trimmedChunk) && /<\/table>\s*$/i.test(trimmedChunk)) {
            return escapeText_(trimmedChunk, allowTags);
          }
          const brOnlyRegex = /^(<br\s*\/?>)+$/i;
          if (brOnlyRegex.test(trimmedChunk.replace(/\s/g, ''))) {
            return trimmedChunk; 
          }
          const lines = chunk.split("\n").map(l => l.trimEnd());
          let processedLines = [];
          for (let i = 0; i < lines.length; i++) {
            let escaped = escapeText_(lines[i], allowTags);
            if (i < lines.length - 1) {
              if (/<br\s*\/?>$/i.test(escaped.trim())) {
                processedLines.push(escaped);
              } else {
                processedLines.push(escaped + "<br>");
              }
            } else {
              processedLines.push(escaped.replace(/<br\s*\/?>$/i, ""));
            }
          }
          const content = processedLines.filter(line => line.length > 0).join("\n");
          return content ? `<p>${content}</p>` : "<br>";
        }).join("\n");
      }
      
      function wrapSelection(textarea, left, right){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0;
        const e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        if (s === e){
          const next = v.slice(0, s) + left + right + v.slice(e);
          textarea.value = next;
          const pos = s + left.length;
          textarea.setSelectionRange(pos, pos);
          textarea.focus();
          return;
        }
        const mid = v.slice(s, e);
        const next = v.slice(0, s) + left + mid + right + v.slice(e);
        textarea.value = next;
        textarea.setSelectionRange(s + left.length, e + left.length);
        textarea.focus();
      }

      function insertAtSelection(textarea, insertText){
        if (!textarea) return;
        const s = textarea.selectionStart ?? 0;
        const e = textarea.selectionEnd ?? 0;
        const v = textarea.value ?? "";
        const next = v.slice(0, s) + insertText + v.slice(e);
        textarea.value = next;
        const pos = s + String(insertText).length;
        textarea.setSelectionRange(pos, pos);
        textarea.focus();
      }

      function copyToClipboard(text){
        return navigator.clipboard.writeText(text).then(()=>true).catch(()=>{
          try{
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.left="-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            const ok = document.execCommand("copy");
            document.body.removeChild(ta);
            return ok;
          }catch(e){ return false; }
        });
      }

      /* ==========================
         Table Builder Logic
      ========================== */
      function openTableModal_(ctx){
        tableCtx = ctx || null;
        if (!tableModal) return;
        tableModal.hidden = false;
        tableModal.style.display = 'flex';
        tableModal.setAttribute('aria-hidden','false');
        const r = clampInt_(tblRowsEl?.value, 1, 30, 3);
        const c = clampInt_(tblColsEl?.value, 1, 12, 3);
        buildTableGrid_(r, c);
        const first = tblCellsEl?.querySelector(".bcg-cell");
        if (first) setTimeout(()=>first.focus(), 0);
      }

      function closeTableModal_(){
        if (!tableModal) return;
        tableModal.hidden = true;
        tableModal.style.display = 'none';
        tableModal.setAttribute('aria-hidden','true');
        tableCtx = null;
      }

      function handleSafeClose_() {
        const cells = tblCellsEl?.querySelectorAll(".bcg-cell");
        const hasContent = Array.from(cells || []).some(cell => cell.value.trim().length > 0);
        if (hasContent) {
          if (confirm("ì‘ì„± ì¤‘ì¸ í‘œ ë°ì´í„°ê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ì–´ìš”?")) closeTableModal_();
        } else {
          closeTableModal_();
        }
      }

      function buildTableGrid_(rows, cols){
        if (!tblCellsEl) return;
        tblCellsEl.innerHTML = "";
        tblCellsEl.style.gridTemplateColumns = `repeat(${cols}, minmax(140px, 1fr))`;

        for (let r=0; r<rows; r++){
          for (let c=0; c<cols; c++){
            const inp = document.createElement("textarea");
            inp.className = "bcg-cell";
            inp.style.height = "60px";
            inp.placeholder = (r === 0 && (tblHeaderEl?.checked)) ? `í—¤ë” ${c+1}` : `R${r+1}C${c+1}`;
            inp.setAttribute("data-r", String(r));
            inp.setAttribute("data-c", String(c));
            
            inp.addEventListener("keydown", (e)=>{
              if (e.key === "Enter" && e.ctrlKey) {
                e.preventDefault();
                const target = tblCellsEl.querySelector(`.bcg-cell[data-r="${r+1}"][data-c="${c}"]`);
                if (target) target.focus();
              }
            });
            tblCellsEl.appendChild(inp);
          }
        }
      }

      function readTableCells_(rows, cols){
        const out = [];
        for (let r=0; r<rows; r++){
          const row = [];
          for (let c=0; c<cols; c++){
            const el = tblCellsEl?.querySelector(`.bcg-cell[data-r="${r}"][data-c="${c}"]`);
            let val = el ? String(el.value ?? "") : "";
            row.push(val.replace(/\n/g, "<br>"));
          }
          out.push(row);
        }
        return out;
      }

      function makeTableHtml_(rows, cols, useHeader, caption, cells){
        const cap = String(caption ?? "").trim();
        const lines = [];
        lines.push('<table class="cheese-table">');
        if (cap) lines.push(`  <caption>${cap}</caption>`);
        if (useHeader && rows >= 1){
          lines.push("  <thead>");
          lines.push("    <tr>");
          for (let c=0; c<cols; c++){
            const v = (cells?.[0]?.[c] ?? "");
            lines.push(`      <th>${v}</th>`);
          }
          lines.push("    </tr>");
          lines.push("  </thead>");
        }
        lines.push("  <tbody>");
        const start = (useHeader ? 1 : 0);
        for (let r=start; r<rows; r++){
          lines.push("    <tr>");
          for (let c=0; c<cols; c++){
            const v = (cells?.[r]?.[c] ?? "");
            lines.push(`      <td>${v}</td>`);
          }
          lines.push("    </tr>");
        }
        lines.push("  </tbody>");
        lines.push("</table>");
        return lines.join("\n");
      }

      if (tableModalCloseBtn) {
        tableModalCloseBtn.onclick = (e) => { e.preventDefault(); handleSafeClose_(); };
      }
      if (tableModal) {
        tableModal.onclick = (e) => {
          if (e.target === tableModal) e.stopPropagation();
        };
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !tableModal.hidden) handleSafeClose_();
      });
      if (tblRebuildBtn) {
        tblRebuildBtn.onclick = () => {
          const cells = tblCellsEl?.querySelectorAll(".bcg-cell");
          const hasContent = Array.from(cells || []).some(cell => cell.value.trim().length > 0);
          if (hasContent && !confirm("í˜„ì¬ ì…ë ¥ëœ í‘œ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
          const r = clampInt_(tblRowsEl?.value, 1, 30, 3);
          const c = clampInt_(tblColsEl?.value, 1, 12, 3);
          buildTableGrid_(r, c);
        };
      }
      if (tblInsertBtn) {
        tblInsertBtn.onclick = () => {
          if (!tableCtx || !tableCtx.bodyEl) return closeTableModal_();
          if (typeof tableCtx.ensureAllowTagsOn_ === "function") tableCtx.ensureAllowTagsOn_();
          const rows = clampInt_(tblRowsEl?.value, 1, 30, 3);
          const cols = clampInt_(tblColsEl?.value, 1, 12, 3);
          const cells = readTableCells_(rows, cols);
          const caption = tblCaptionEl ? tblCaptionEl.value : "";
          const useHeader = !!(tblHeaderEl && tblHeaderEl.checked);
          const tableHtml = makeTableHtml_(rows, cols, useHeader, caption, cells);
          const insertText = `\n\n${tableHtml}\n\n`;
          insertAtSelection(tableCtx.bodyEl, insertText);
          if (typeof tableCtx.schedule === "function") tableCtx.schedule();
          if (typeof tableCtx.showToast === "function") tableCtx.showToast("í‘œë¥¼ ì‚½ì…í–ˆì–´.");
          closeTableModal_();
        };
      }


      /* ==========================
         Block Logic
      ========================== */
      function updatePill(){
        const n = elBlocks.querySelectorAll("[data-bcg-block]").length;
        pill.textContent = `ë¸”ë¡ ${n}ê°œ`;
      }

      // âœ… ì£¼ì„(footnotes) ë°°ì—´ì„ ë°›ì•„ì„œ ìµœì¢… HTML ìƒì„±
      function buildHtml({level, heading, body, allowTags, footnotes, fnStartIndex}){
        const tag = (level === "h1" || level === "h2" || level === "h3") ? level : "h2";
        const headText = escapeHtmlLite(String(heading ?? "").trim());
        const bodyHtml = textToParagraphHtml(body, !!allowTags);
        const headPart = headText ? `<${tag}>${headText}</${tag}>` : "";
        
        // ë³¸ë¬¸ ìƒì„±
        const parts = [headPart, bodyHtml].filter(Boolean);

        // âœ… ì£¼ì„ ëª©ë¡ ìƒì„± ë° ì¶”ê°€
        if (footnotes && footnotes.length > 0) {
          const startIdx = parseInt(fnStartIndex) || 1;
          let fnHtml = '\n\n<hr>\n<ol class="cheese-footnotes">';
          
          footnotes.forEach((note, i) => {
            const idx = startIdx + i;
            // ì£¼ì„ í…ìŠ¤íŠ¸ë„ HTML ì´ìŠ¤ì¼€ì´í”„ (ì•ˆì „)
            const safeNote = escapeHtmlLite(note);
            fnHtml += `\n  <li id="fn${idx}">\n    <a href="#fn${idx}-ref" class="cheese-footnote-index">*${idx}</a>\n    ${safeNote}\n  </li>`;
          });
          
          fnHtml += '\n</ol>';
          parts.push(fnHtml);
        }

        return parts.join("\n");
      }

      function createBlock(){
        seq += 1;
        const id = "bcg_" + seq;
        const wrap = document.createElement("div");
        wrap.className = "bcg-card";
        wrap.setAttribute("data-bcg-block", id);

        // âœ… ì£¼ì„ ë°ì´í„° ì €ì¥ì„ ìœ„í•œ ë°°ì—´
        let blockFootnotes = [];

        wrap.innerHTML = `
          <div class="bcg-row">
            <span class="bcg-badge">ë¸”ë¡ #${seq}</span>
            <div class="bcg-right bcg-row" style="margin-top:0;">
              <label class="bcg-check" title="ì²´í¬í•˜ë©´ ì„œì‹ ë²„íŠ¼ì´ ë„£ëŠ” íƒœê·¸(strong/span/mark/br/table)ë§Œ í—ˆìš©í•´ìš”. ê·¸ ì™¸ íƒœê·¸ëŠ” ìë™ ì´ìŠ¤ì¼€ì´í”„ë¼ìš”.">
                <input type="checkbox" data-keep-raw />
                ì„œì‹/íƒœê·¸ í—ˆìš©
              </label>
              <button class="bcg-btn bcg-mini" type="button" data-generate>ì½”ë“œ ìƒì„±</button>

              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-send 
                      style="background:#eff6ff; border-color:#bfdbfe; color:#1e40af;">
                ê´€ë¦¬ìë¡œ ì „ì†¡ ğŸš€
              </button>
              
              <button class="bcg-btn bcg-mini bcg-btn--primary" type="button" data-copy>ë³µì‚¬</button>
              <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-remove>ì‚­ì œ</button>
            </div>
          </div>
          <div class="bcg-split" style="margin-top:10px;">
            <div>
              <div class="bcg-row">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; width:100%;">
                  <div style="display:flex; flex-direction:column; gap:6px;">
                    <span class="bcg-label">ì†Œì œëª© ë ˆë²¨</span>
                    <select class="bcg-select" data-level>
                      <option value="h1">H1</option>
                      <option value="h2" selected>H2</option>
                      <option value="h3">H3</option>
                    </select>
                  </div>
                  <div style="display:flex; flex-direction:column; gap:6px; flex:1; min-width:260px;">
                    <span class="bcg-label">ì†Œì œëª© í…ìŠ¤íŠ¸</span>
                    <input class="bcg-input" data-heading placeholder="ì˜ˆ) ìˆ™ì¢…ì˜ í™˜êµ­ì •ì¹˜, ê°€ê³„ë„ íë¦„ ì •ë¦¬" />
                  </div>
                </div>
              </div>
              
              <div class="bcg-row" style="background:rgba(15,23,42,0.02); padding:8px 10px; border-radius:8px;">
                <span class="bcg-label">ì£¼ì„ ì„¤ì •:</span>
                <span class="bcg-muted">ì‹œì‘ ë²ˆí˜¸</span>
                <input class="bcg-input bcg-num" type="number" min="1" value="1" data-fn-start style="height:32px; flex:none; width:60px;" title="ì´ì „ ë¸”ë¡ì—ì„œ 2ë²ˆê¹Œì§€ ì¼ë‹¤ë©´ ì—¬ê¸°ëŠ” 3ìœ¼ë¡œ ì„¤ì •">
                <button class="bcg-btn bcg-mini bcg-btn--danger" type="button" data-fn-reset style="padding:4px 8px; font-size:11px;">ì£¼ì„ ì´ˆê¸°í™”</button>
                <span class="bcg-muted" data-fn-status style="margin-left:auto;">0ê°œ ì €ì¥ë¨</span>
              </div>

              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">ë³¸ë¬¸(ì›ë¬¸ ë¶™ì—¬ë„£ê¸°)</span>
                  
                  <div style="display:flex; flex-direction:column; gap:10px; margin:10px 0;">
                    <div style="display:flex; gap:8px; align-items:center;">
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bold">êµµê²Œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="br">ì¤„ë°”ê¿ˆ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="table">í‘œ</button>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="footnote" style="color:#2563eb; border-color:#bfdbfe; background:#eff6ff;">ì£¼ì„(Fn)</button>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ê¸€ììƒ‰ <input type="color" data-color value="#111827" /></span>
                      <span class="bcg-swatches" data-color-swatches>
                        <button class="bcg-swatch" type="button" data-color-preset="#111827" title="ê¸°ë³¸(ê²€ì •)" style="background:#111827;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#475569" title="íšŒìƒ‰" style="background:#475569;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#2563eb" title="íŒŒë‘" style="background:#2563eb;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#16a34a" title="ì´ˆë¡" style="background:#16a34a;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#d97706" title="ì£¼í™©" style="background:#d97706;"></button>
                        <button class="bcg-swatch" type="button" data-color-preset="#e11d48" title="ë¹¨ê°•" style="background:#e11d48;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="color">ì ìš©</button>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                      <span class="bcg-pill">ë°°ê²½ <input type="color" data-bg value="#fde68a" /></span>
                      <span class="bcg-swatches" data-bg-swatches>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fde68a" title="ë…¸ë‘" style="background:#fde68a;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#fecdd3" title="í•‘í¬" style="background:#fecdd3;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bfdbfe" title="í•˜ëŠ˜" style="background:#bfdbfe;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#bbf7d0" title="ì—°ë‘" style="background:#bbf7d0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#e2e8f0" title="ì—°íšŒìƒ‰" style="background:#e2e8f0;"></button>
                        <button class="bcg-swatch" type="button" data-bg-preset="#ddd6fe" title="ì—°ë³´ë¼" style="background:#ddd6fe;"></button>
                      </span>
                      <button class="bcg-btn bcg-mini" type="button" data-fmt="bg">ì ìš©</button>
                    </div>
                    
                    <span class="bcg-muted">â€» ì„œì‹ ë²„íŠ¼ì„ ì“°ë©´ â€œì„œì‹/íƒœê·¸ í—ˆìš©â€ì´ ìë™ìœ¼ë¡œ ì¼œì ¸.</span>
                  </div>

                  <textarea class="bcg-textarea" data-body placeholder="ì—¬ê¸°ì— ë¸”ë¡œê·¸ ì›ë¬¸ì„ ë¶™ì—¬ë„£ì–´.&#10;ë¹ˆ ì¤„ì€ ë¬¸ë‹¨ìœ¼ë¡œ ì²˜ë¦¬ë¼."></textarea>
                  <div class="bcg-muted">íŒ) í¬ìŠ¤íŠ¸ ê´€ë¦¬ì—ì„œ BODY_1/2/3ë¡œ ë‚˜ëˆŒ ê±°ë©´, ì—¬ê¸°ì„œ ë¸”ë¡ì„ ê·¸ ê°œìˆ˜ë§Œí¼ ë§Œë“¤ì–´ì„œ ê°ê° ìƒì„±/ë³µì‚¬í•˜ë©´ ë¼.</div>
                </div>
              </div>
            </div>
            <div>
              <div class="bcg-row">
                <div style="display:flex; flex-direction:column; gap:6px; width:100%;">
                  <span class="bcg-label">ìƒì„±ëœ HTML</span>
                  <textarea class="bcg-output" data-output readonly placeholder="ì—¬ê¸°ì— ê²°ê³¼ HTMLì´ ìƒì„±ë¼."></textarea>
                  <div class="bcg-muted">â€˜ë³µì‚¬â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ë¸”ë¡ ê²°ê³¼ë§Œ í´ë¦½ë³´ë“œë¡œ ë³µì‚¬ë¼.</div>
                  <div class="bcg-row" style="margin-top:10px;">
                    <span class="bcg-label">ë¯¸ë¦¬ë³´ê¸°</span>
                    <span class="bcg-muted">â€» ì„œì‹/íƒœê·¸ í—ˆìš©ì´ êº¼ì ¸ ìˆìœ¼ë©´ íƒœê·¸ëŠ” ê¸€ìë¡œ ë³´ì¼ ìˆ˜ ìˆì–´.</span>
                  </div>
                  <div class="bcg-preview" data-preview><div class="bcg-preview-empty">ì•„ì§ ìƒì„±ëœ ë‚´ìš©ì´ ì—†ì–´.</div></div>
                </div>
              </div>
            </div>
          </div>
        `;

        const levelEl = wrap.querySelector("[data-level]");
        const headingEl = wrap.querySelector("[data-heading]");
        const bodyEl = wrap.querySelector("[data-body]");
        const outEl = wrap.querySelector("[data-output]");
        const prevEl = wrap.querySelector("[data-preview]");
        const keepRawEl = wrap.querySelector("[data-keep-raw]");
        
        // âœ… ì£¼ì„ ê´€ë ¨ ì—˜ë¦¬ë¨¼íŠ¸
        const fnStartEl = wrap.querySelector("[data-fn-start]");
        const fnResetBtn = wrap.querySelector("[data-fn-reset]");
        const fnStatusEl = wrap.querySelector("[data-fn-status]");

        const btnGen = wrap.querySelector("[data-generate]");
        const btnCopy = wrap.querySelector("[data-copy]");
        const btnRemove = wrap.querySelector("[data-remove]");
        const btnSend = wrap.querySelector("[data-send]");

        btnSend.addEventListener("click", () => {
          if (!outEl.value.trim()) regenerate(); 
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({
              type: 'CH_BLOG_CODE',
              content: outEl.value,
              target: currentTarget
            }, '*');
            showToast(`ğŸš€ [${currentTarget || 'ìë™'}] ìœ¼ë¡œ ì „ì†¡í–ˆì–´!`);
          } else {
            alert("ê´€ë¦¬ì ì°½ì´ ë‹«í˜€ìˆê±°ë‚˜ ì—°ê²°ì´ ëŠì–´ì¡Œì–´.");
          }
        });
        
        function regenerate(){
          const html = buildHtml({
            level: levelEl.value,
            heading: headingEl.value,
            body: bodyEl.value,
            allowTags: keepRawEl.checked,
            footnotes: blockFootnotes, // ì£¼ì„ ë¦¬ìŠ¤íŠ¸ ì „ë‹¬
            fnStartIndex: fnStartEl.value
          });
          outEl.value = html;
          if (prevEl){
            if (html && html.trim()) prevEl.innerHTML = html;
            else prevEl.innerHTML = '<div class="bcg-preview-empty">ì•„ì§ ìƒì„±ëœ ë‚´ìš©ì´ ì—†ì–´.</div>';
          }
        }

        function updateFnStatus() {
          fnStatusEl.textContent = `${blockFootnotes.length}ê°œ ì €ì¥ë¨`;
        }

        // âœ… ì£¼ì„ ì´ˆê¸°í™” ë²„íŠ¼
        fnResetBtn.addEventListener("click", () => {
          if(confirm("ì €ì¥ëœ ì£¼ì„ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš¸ê¹Œ? (ë³¸ë¬¸ì˜ *1 íƒœê·¸ëŠ” ì§ì ‘ ì§€ì›Œì•¼ í•´)")) {
            blockFootnotes = [];
            updateFnStatus();
            regenerate();
            showToast("ì£¼ì„ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ");
          }
        });

        // âœ… ì£¼ì„ ì‹œì‘ ë²ˆí˜¸ ë³€ê²½ ì‹œ ì¬ìƒì„±
        fnStartEl.addEventListener("change", regenerate);
        fnStartEl.addEventListener("input", regenerate);

        btnGen.addEventListener("click", () => { regenerate(); showToast("ì½”ë“œë¥¼ ìƒì„±í–ˆì–´."); });
        btnCopy.addEventListener("click", async () => {
          if (!outEl.value.trim()) regenerate();
          const ok = await copyToClipboard(outEl.value);
          showToast(ok ? "ë³µì‚¬ ì™„ë£Œ!" : "ë³µì‚¬ ì‹¤íŒ¨");
        });
        btnRemove.addEventListener("click", () => { wrap.remove(); updatePill(); showToast("ë¸”ë¡ì„ ì‚­ì œí–ˆì–´."); });

        let t = null;
        function schedule(){ clearTimeout(t); t = setTimeout(regenerate, 180); }
        levelEl.addEventListener("change", schedule);
        headingEl.addEventListener("input", schedule);
        bodyEl.addEventListener("input", schedule);
        keepRawEl.addEventListener("change", schedule);

        const colorEl = wrap.querySelector("[data-color]");
        const bgEl = wrap.querySelector("[data-bg]");

        let lastSel = { s:0, e:0 };
        function saveSel_(){ try{ lastSel.s = bodyEl.selectionStart ?? 0; lastSel.e = bodyEl.selectionEnd ?? 0; }catch(e){} }
        function restoreSel_(){ try{ bodyEl.focus(); bodyEl.setSelectionRange(lastSel.s, lastSel.e); }catch(e){} }
        bodyEl.addEventListener("mouseup", saveSel_);
        bodyEl.addEventListener("keyup", saveSel_);
        bodyEl.addEventListener("select", saveSel_);
        bodyEl.addEventListener("focus", saveSel_);

        function hasSelection_(){ const s = lastSel.s ?? 0, e = lastSel.e ?? 0; return s !== e; }

        wrap.querySelectorAll("[data-color-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-color-preset");
            if (!v) return;
            colorEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<span style="color:${colorEl.value}">`, "</span>");
              schedule();
              showToast("ê¸€ììƒ‰ ì ìš©!");
            }else{
              showToast("ê¸€ììƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        wrap.querySelectorAll("[data-bg-preset]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const v = btn.getAttribute("data-bg-preset");
            if (!v) return;
            bgEl.value = v;
            if (hasSelection_()){
              restoreSel_();
              wrapSelection(bodyEl, `<mark style="background:${bgEl.value}">`, "</mark>");
              schedule();
              showToast("ë°°ê²½ìƒ‰ ì ìš©!");
            }else{
              showToast("ë°°ê²½ìƒ‰ ì„ íƒë¨");
              bodyEl.focus();
            }
          });
        });

        function ensureAllowTagsOn_(){
          if (!keepRawEl.checked){
            keepRawEl.checked = true;
            showToast("ì„œì‹/íƒœê·¸ í—ˆìš©ì„ ì¼°ì–´.");
          }
        }

        wrap.querySelectorAll("[data-fmt]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const fmt = btn.getAttribute("data-fmt");
            if (!fmt) return;
            ensureAllowTagsOn_();

            if (fmt === "table"){
              openTableModal_({ bodyEl, ensureAllowTagsOn_: ensureAllowTagsOn_, schedule, showToast });
              return;
            }
            
            // âœ… [ì¶”ê°€] ì£¼ì„ ì…ë ¥ ë¡œì§
            if (fmt === "footnote") {
              const noteContent = prompt("ì£¼ì„ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.\n(ë³¸ë¬¸ì—ëŠ” ë²ˆí˜¸ê°€ ë¶™ê³ , ì„¤ëª…ì€ ë§¨ ì•„ë˜ ëª©ë¡ì— ì¶”ê°€ë¼)");
              if (noteContent) {
                // 1. ì €ì¥ì†Œì— ì¶”ê°€
                blockFootnotes.push(noteContent);
                updateFnStatus();

                // 2. í˜„ì¬ ë²ˆí˜¸ ê³„ì‚° (ì‹œì‘ë²ˆí˜¸ + ì¸ë±ìŠ¤)
                const startIdx = parseInt(fnStartEl.value) || 1;
                const currentIdx = startIdx + blockFootnotes.length - 1;

                // 3. ë³¸ë¬¸ì— ë§í¬ íƒœê·¸ ì‚½ì…
                restoreSel_();
                const linkTag = `<a id="fn${currentIdx}-ref" href="#fn${currentIdx}" class="cheese-footnote-ref" data-footnote-id="fn${currentIdx}">*${currentIdx}</a>`;
                insertAtSelection(bodyEl, linkTag);
                
                showToast(`ì£¼ì„ *${currentIdx} ì¶”ê°€ ì™„ë£Œ!`);
                schedule();
              }
              return;
            }

            if (fmt === "bold"){
              restoreSel_();
              wrapSelection(bodyEl, "<strong>", "</strong>");
            }else if (fmt === "br"){
              restoreSel_();
              wrapSelection(bodyEl, "<br>", "");
            }else if (fmt === "color"){
              const c = (colorEl && colorEl.value) ? colorEl.value : "#111827";
              restoreSel_();
              wrapSelection(bodyEl, `<span style="color:${c}">`, "</span>");
            }else if (fmt === "bg"){
              const b = (bgEl && bgEl.value) ? bgEl.value : "#fde68a";
              restoreSel_();
              wrapSelection(bodyEl, `<mark style="background:${b}">`, "</mark>");
            }
            schedule();
          });
        });

        regenerate();
        return wrap;
      }

      addBtn.addEventListener("click", () => {
        elBlocks.appendChild(createBlock());
        updatePill();
        showToast("ìƒˆ ë¸”ë¡ì„ ì¶”ê°€í–ˆì–´.");
      });

      elBlocks.appendChild(createBlock());
      updatePill();

      window.addEventListener("message", (e) => {
        if (e.data && e.data.type === 'CH_LOAD_DATA') {
          const content = e.data.content || "";
          if (!content.trim()) return;

          const firstBlock = elBlocks.querySelector("[data-bcg-block]");
          if (firstBlock) {
            const bodyEl = firstBlock.querySelector("[data-body]");
            const keepRawEl = firstBlock.querySelector("[data-keep-raw]");
            
            if (bodyEl) {
              bodyEl.value = content;
              if (keepRawEl) keepRawEl.checked = true;
              bodyEl.dispatchEvent(new Event("input"));
              showToast("ê¸°ì¡´ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ì–´! ğŸ“");
            }
          }
        }
      });

      if (window.opener) {
        setTimeout(() => {
             window.opener.postMessage({ type: 'CH_CODE_GEN_READY' }, '*');
        }, 100);
      }
    })();
  </script>
</body>
</html>
