<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ì‚¬í•­ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    .page-title{ margin:10px 0 14px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .page-title .t{ font-size:20px; font-weight:1000; letter-spacing:-0.02em; }
    .page-title .s{ margin-top:4px; color:var(--sub); font-size:12px; font-weight:650; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
    .card-h{ padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(15,23,42,0.06); }
    .card-title{ font-weight:1000; letter-spacing:-0.02em; font-size:14px; display:flex; align-items:center; gap:8px; }
    .card-b{ padding:12px 14px 14px; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .left-tools{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .right-tools{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .chip{ border:1px solid rgba(15,23,42,0.12); background:#fff; border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; cursor:pointer; }
    .chip.is-on{ background:rgba(15,23,42,0.06); border-color:rgba(15,23,42,0.22); }

    .input{
      border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:12px;
      padding:10px 12px; font-size:13px; font-weight:650; outline:none; min-width:260px;
    }
    .btn{
      border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:12px;
      padding:10px 12px; font-size:13px; font-weight:900; cursor:pointer;
    }
    .btn.primary{ background:rgba(15,23,42,0.92); color:#fff; border-color:rgba(15,23,42,0.92); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .list{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:12px 12px; border-radius:14px;
      border:1px solid rgba(15,23,42,0.08); background:rgba(2,6,23,0.02); }
    .row-left{ min-width:0; display:flex; flex-direction:column; gap:6px; }
    .row-title{ font-weight:1000; font-size:14px; letter-spacing:-0.01em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }
    .row-meta{ color:var(--sub); font-size:12px; font-weight:650; display:flex; gap:10px; flex-wrap:wrap; }

    .tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }
    .tag--warn{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.28); }
    .tag--bad{ background:rgba(239,68,68,0.10); border-color:rgba(239,68,68,0.25); }
    .tag--pin{ background:rgba(59,130,246,0.10); border-color:rgba(59,130,246,0.25); }

    .muted{ color:var(--sub); font-size:12px; font-weight:650; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .linkbtn{ border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:12px; padding:8px 10px; font-size:12px; font-weight:900; cursor:pointer; }

    .skeleton{ height:12px; border-radius:999px; background:rgba(15,23,42,0.08); overflow:hidden; position:relative; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-60%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-60%);} 100%{transform:translateX(160%);} }

    @media (max-width:520px){
      .input{ min-width: 100%; width: 100%; }
      .row-title{ white-space:normal; overflow:visible; }
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main>
        <div class="page-title">
          <div>
            <div class="t">ê³µì§€ì‚¬í•­</div>
            <div class="s">ì „ì²´ ëª©ë¡ Â· ê²€ìƒ‰ Â· í•„í„°</div>
          </div>
          <div class="pill" id="countPill">ë¡œë”©ì¤‘â€¦</div>
        </div>

        <div class="card">
          <div class="card-h">
            <div class="card-title">ğŸ“‹ ê³µì§€ ëª©ë¡</div>
            <div class="actions">
              <button class="btn" type="button" onclick="location.href='./new_dashboard.html'">ëŒ€ì‹œë³´ë“œ</button>
              <button class="btn primary" id="btnNew" type="button">ê³µì§€ ì‘ì„±</button>
            </div>
          </div>

          <div class="card-b">
            <div class="toolbar">
              <div class="left-tools">
                <button class="chip is-on" data-filter="all" type="button">ì „ì²´</button>
                <button class="chip" data-filter="pin" type="button">ê³ ì •</button>
                <button class="chip" data-filter="danger" type="button">í•„ë…</button>
                <button class="chip" data-filter="warn" type="button">ì¤‘ìš”</button>
                <button class="chip" data-filter="normal" type="button">ì¼ë°˜</button>
              </div>

              <div class="right-tools">
                <input class="input" id="q" placeholder="ê²€ìƒ‰: ì œëª©/ì‚¬ë²ˆ(ì˜ˆ CL25-0001)" />
                <button class="btn" id="btnReload" type="button">ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn" id="btnMore" type="button">ë”ë³´ê¸°</button>
              </div>
            </div>

            <ul class="list" id="list">
              <li class="row"><div style="flex:1"><div class="skeleton" style="width:78%"></div><div style="height:8px"></div><div class="skeleton" style="width:55%"></div></div></li>
              <li class="row"><div style="flex:1"><div class="skeleton" style="width:84%"></div><div style="height:8px"></div><div class="skeleton" style="width:45%"></div></div></li>
            </ul>

            <div class="muted" id="empty" style="display:none; margin-top:12px;">ê³µì§€ ì—†ìŒ</div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    const ANN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function getSessionUser_(){
      const empNo = (sessionStorage.getItem("cheese_admin_emp_no") || "").trim();
      const name  = (sessionStorage.getItem("cheese_admin_display_name") || "").trim();
      const role  = (sessionStorage.getItem("cheese_admin_role") || "").trim();
      return empNo ? { empNo, name, role } : null;
    }

    function canWrite_(role){
      return ["ADMIN","FIN","MGR"].includes(String(role||"").toUpperCase());
    }

    function mountShell_(){
      const tryCall = (names, args)=>{
        for(const n of names){
          if(typeof window[n] === 'function'){
            try{ window[n](args); }catch(e){ console.warn(n,e); }
            return true;
          }
        }
        return false;
      };

      // header
      tryCall(['renderAdminHeader','mountAdminHeader'], {
        mountId: 'admin-header-slot',
        badgeText: 'board',
        subtitle: 'ê³µì§€ì‚¬í•­'
      });

      // menu
      tryCall(['renderAdminMenu','renderAdminSidebar','mountAdminMenu'], {
        mountId: 'admin-menu-slot',
        active: 'board'
      });
    }

    async function apiGet_(params){
      const url = ANN_API_BASE + "?" + new URLSearchParams(params).toString();
      const res = await fetch(url);
      const txt = await res.text();
      let j; try{ j = JSON.parse(txt); }catch(_){ throw new Error("ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹˜: " + txt); }
      if(!j.ok) throw new Error(j.message || "API ì˜¤ë¥˜");
      return j;
    }

    function tagHtml_(it){
      const level = String(it.level||"normal").toLowerCase();
      const pinned = Number(it.isPinned||0) === 1;

      const tags = [];
      if(pinned) tags.push('<span class="tag tag--pin">ê³ ì •</span>');

      if(level === 'danger') tags.push('<span class="tag tag--bad">í•„ë…</span>');
      else if(level === 'warn') tags.push('<span class="tag tag--warn">ì¤‘ìš”</span>');
      else tags.push('<span class="tag">ì¼ë°˜</span>');

      return tags.join(' ');
    }

    let __items = [];
    let __filter = 'all';
    let __limit = 20;

    async function load_(){
      document.getElementById('empty').style.display = 'none';

      const user = getSessionUser_();
      const writer = user && canWrite_(user.role);

      // ì‘ì„± ë²„íŠ¼
      const btnNew = document.getElementById('btnNew');
      btnNew.style.display = writer ? 'inline-flex' : 'none';
      btnNew.onclick = ()=> location.href = "./notice-editor.html";

      const j = await apiGet_({ mode:'listAnnouncements', limit: String(__limit) });
      __items = Array.isArray(j.items) ? j.items : [];
      document.getElementById('countPill').textContent = `í‘œì‹œ ${__items.length}ê±´`;
      render_();
    }

    function render_(){
      const q = (document.getElementById('q').value || '').trim().toLowerCase();
      let items = __items.slice();

      // filter
      if(__filter === 'pin') items = items.filter(x=>Number(x.isPinned||0)===1);
      if(['danger','warn','normal'].includes(__filter)) items = items.filter(x=>String(x.level||'normal').toLowerCase() === __filter);

      // search
      if(q){
        items = items.filter(x=>{
          const t = String(x.title||'').toLowerCase();
          const a = String(x.authorEmpNo||'').toLowerCase();
          return t.includes(q) || a.includes(q);
        });
      }

      const ul = document.getElementById('list');
      ul.innerHTML = '';

      if(!items.length){
        document.getElementById('empty').style.display = 'block';
        return;
      }

      const user = getSessionUser_();
      const isAdmin = user && String(user.role||'').toUpperCase() === 'ADMIN';


      items.forEach(it=>{
        const isAuthor = user && String(it.authorEmpNo||'').trim() === String(user.empNo||'').trim();
        const canEditThis = !!(isAdmin || isAuthor);
        const li = document.createElement('li');
        li.className = 'row';
        li.style.cursor = 'pointer';

        const updated = String(it.updatedAt || '').slice(0,16);
        const period = [
          it.startAt ? `ì‹œì‘ ${escapeHtml(it.startAt)}` : '',
          it.endAt ? `ì¢…ë£Œ ${escapeHtml(it.endAt)}` : ''
        ].filter(Boolean).join(' Â· ');

        li.innerHTML = `
          <div class="row-left">
            <div class="row-title">${escapeHtml(it.title || '')}</div>
            <div class="row-meta">
              <span>${escapeHtml(updated || '')}</span>
              <span>ì‘ì„± ${escapeHtml(it.authorEmpNo || '')}</span>
              ${period ? `<span>Â· ${period}</span>` : ''}
              <span>Â· ëŒ“ê¸€ ${Number(it.commentCount||0)}</span>
            </div>
          </div>
          <div class="actions">
            ${tagHtml_(it)}
            ${canEditThis ? `<button class="linkbtn" data-edit="1" type="button">ìˆ˜ì •</button>` : ''}
          </div>
        `;

        li.addEventListener('click', ()=>{
          location.href = "./notice.html?id=" + encodeURIComponent(String(it.noticeId||''));
        });

        const editBtn = li.querySelector('[data-edit="1"]');
        if(editBtn){
          editBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            location.href = "./notice-editor.html?id=" + encodeURIComponent(String(it.noticeId||''));
          });
        }

        ul.appendChild(li);
      });
    }

    function wire_(){
      document.querySelectorAll('[data-filter]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.querySelectorAll('[data-filter]').forEach(x=>x.classList.remove('is-on'));
          btn.classList.add('is-on');
          __filter = btn.getAttribute('data-filter');
          render_();
        });
      });

      document.getElementById('q').addEventListener('input', render_);

      document.getElementById('btnReload').addEventListener('click', ()=>{
        load_().catch(err=>alert(err.message||String(err)));
      });

      document.getElementById('btnMore').addEventListener('click', ()=>{
        __limit = Math.min(__limit + 20, 100);
        load_().catch(err=>alert(err.message||String(err)));
      });
    }

    (function init(){
      mountShell_();
      wire_();
      load_().catch(err=>{
        document.getElementById('countPill').textContent = 'ë¡œë”© ì‹¤íŒ¨';
        alert(err.message || String(err));
      });
    })();
  </script>
</body>
</html>
