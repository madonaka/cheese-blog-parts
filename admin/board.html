<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --line-color: #eee; --text-dark: #333; --text-gray: #777; --primary: #3b82f6; --danger: #ef4444; }
    
    .dashboard-layout { max-width: 1100px; margin: 0 auto; padding: 20px 10px; }
    
    /* ë²„ì „ í‘œì‹œ ë±ƒì§€ (ìƒë‹¨ì— ì‘ê²Œ ìœ ì§€) */
    .sys-version-small { font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px; text-align: right; }

    /* í—¤ë” ì˜ì—­ ì¶•ì†Œ */
    .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .page-header h2 { font-size: 1.4rem; margin: 0; font-weight: 900; letter-spacing: -1px; }
    
    /* ê²€ìƒ‰ì°½ & ë²„íŠ¼ ì••ì¶• */
    .search-bar { display: flex; gap: 5px; margin-bottom: 15px; justify-content: flex-end; }
    .search-bar input { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; width: 180px; }
    .btn-action { padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border: 1px solid #ddd; background: #fff; }
    .btn-write { background: var(--primary); color: #fff; border: none; }

    /* íƒ­ ë©”ë‰´ (ì‹¬í”Œí•˜ê²Œ) */
    .view-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 0; background: #f9f9f9; }
    .view-tab-btn { padding: 10px 15px; font-size: 0.9rem; font-weight: 700; border: none; background: none; color: #666; cursor: pointer; position: relative; }
    .view-tab-btn.active { color: var(--primary); }
    .view-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--primary); }

    /* ğŸ“Œ ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (í•µì‹¬) */
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
    .board-table th { background: #f1f1f1; border-bottom: 1px solid #ccc; padding: 10px 5px; font-weight: 700; color: #444; }
    .board-table td { padding: 10px 5px; border-bottom: 1px solid var(--line-color); text-align: center; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* ì—´ ë„ˆë¹„ ì¡°ì ˆ */
    .col-id { width: 40px; }
    .col-title { text-align: left !important; width: auto; }
    .col-date { width: 60px; color: var(--text-gray); font-size: 0.8rem; }
    .col-view { width: 40px; color: var(--text-gray); font-size: 0.8rem; }

    /* ì œëª© ì¤„ ìŠ¤íƒ€ì¼ */
    .notice-row:hover { background: #f8f9fa; }
    .notice-row.is-pinned { background: #fff8f8; } /* ê³ ì •ê¸€ ë°°ê²½ìƒ‰ */
    .notice-row.is-pinned td { font-weight: 600; }

    .title-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    .title-link:hover .title-text { text-decoration: underline; }
    
    /* ë¯¸ë‹ˆ ë±ƒì§€ */
    .m-badge { font-size: 0.7rem; padding: 1px 4px; border-radius: 2px; font-weight: 800; color: #fff; line-height: 1; }
    .m-badge-pin { background: #777; }
    .m-badge-danger { background: var(--danger); }
    .m-badge-new { color: var(--danger); font-weight: 900; font-style: italic; font-family: 'Arial'; margin-left: 2px; }
    
    .comment-count { color: var(--primary); font-size: 0.8rem; font-weight: 700; margin-left: 3px; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘: ê°€ë¦´ ê±´ ê°€ë¦¬ê¸° */
    @media (max-width: 600px) {
      .col-id, .col-view { display: none; }
      .board-table th:nth-child(1), .board-table td:nth-child(1) { display: none; } /* ë²ˆí˜¸ ìˆ¨ê¹€ */
      .board-table th:nth-child(4), .board-table td:nth-child(4) { display: none; } /* ì¡°íšŒ ìˆ¨ê¹€ */
      .page-header h2 { font-size: 1.1rem; }
    }
    
    .empty-state { text-align: center; padding: 50px 0; color: #999; border-bottom: 1px solid var(--line-color); }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
        <div class="sys-version-small" id="sysVersion">Version Checking...</div>

        <div class="page-header">
          <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
          <button class="btn-action btn-write" onclick="location.href='notice.html'">ê¸€ì“°ê¸°</button>
        </div>

        <div class="search-bar">
          <input type="text" id="search-keyword" placeholder="ì œëª© ê²€ìƒ‰..." onkeyup="if(event.key==='Enter') renderBoard()">
          <button class="btn-action" onclick="renderBoard()">ê²€ìƒ‰</button>
        </div>

        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchTab('all')" id="tab-all">ì „ì²´</button>
          <button class="view-tab-btn" onclick="switchTab('important')" id="tab-important">í•„ë…</button>
          <button class="view-tab-btn" onclick="switchTab('draft')" id="tab-draft">ì„ì‹œ</button>
        </div>

        <table class="board-table">
          <thead>
            <tr>
              <th class="col-id">ë²ˆí˜¸</th>
              <th class="col-title">ì œëª©</th>
              <th class="col-date">ë‚ ì§œ</th>
              <th class="col-view">ì¡°íšŒ</th>
            </tr>
          </thead>
          <tbody id="notice-list-body">
            </tbody>
        </table>
        <div id="empty-msg" class="empty-state" style="display:none;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

      </div>
    </section>
  </main>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "board"; 
  let g_announcements = [];
  let currentTab = 'all';

  document.addEventListener('DOMContentLoaded', loadAnnouncements);

  async function loadAnnouncements() {
      if(typeof showAdminLoading==='function') showAdminLoading("ë¡œë”© ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=listAnnouncements");
          const json = await res.json();
          if(json.ok || json.result === "success") {
              g_announcements = json.announcements || json.data || json.items || [];
              renderBoard();
          }
      } catch(e) { console.error(e); } 
      finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchTab(tabId) {
      currentTab = tabId;
      document.querySelectorAll('.view-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      renderBoard();
  }

  function renderBoard() {
      const body = document.getElementById('notice-list-body');
      const empty = document.getElementById('empty-msg');
      body.innerHTML = ''; empty.style.display = 'none';

      const keyword = document.getElementById('search-keyword').value.toLowerCase().trim();
      const now = new Date();

      let filtered = g_announcements.filter(item => {
          const status = String(item.status || '').trim().toLowerCase();
          const level = String(item.level || '').trim().toLowerCase();
          if (currentTab === 'draft') return status === 'draft';
          if (status === 'draft') return false;
          if (currentTab === 'important') return (item.isPinned == 1 || level === 'danger' || level === 'warn');
          if (keyword && !String(item.title).toLowerCase().includes(keyword)) return false;
          return true;
      });

      // ì •ë ¬: ê³ ì •ê¸€ ìš°ì„  -> ìµœì‹ ìˆœ
      filtered.sort((a, b) => {
          if (a.isPinned != b.isPinned) return b.isPinned - a.isPinned;
          return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
      });

      if (filtered.length === 0) { empty.style.display = 'block'; return; }

      filtered.forEach((item, idx) => {
          const row = document.createElement('tr');
          row.className = `notice-row ${item.isPinned == 1 ? 'is-pinned' : ''}`;
          
          const isDanger = String(item.level).toLowerCase() === 'danger';
          const isNew = (now - new Date(item.createdAt)) < (24 * 60 * 60 * 1000); // 24ì‹œê°„ ì´ë‚´ ìƒˆê¸€
          const dateStr = item.createdAt ? item.createdAt.substring(5, 10).replace('-', '.') : '--.--'; // 05.12 í˜•ì‹
          const id = item.noticeId || item.id;

          row.innerHTML = `
              <td class="col-id">${item.isPinned == 1 ? 'ğŸ“Œ' : filtered.length - idx}</td>
              <td class="col-title">
                <a class="title-link" onclick="location.href='notice.html?id=${id}'">
                  ${isDanger ? '<span class="m-badge m-badge-danger">í•„ë…</span>' : ''}
                  ${item.isPinned == 1 && !isDanger ? '<span class="m-badge m-badge-pin">ê³µì§€</span>' : ''}
                  <span class="title-text">${item.title}</span>
                  ${item.commentCount > 0 ? `<span class="comment-count">[${item.commentCount}]</span>` : ''}
                  ${isNew ? '<span class="m-badge-new">N</span>' : ''}
                </a>
              </td>
              <td class="col-date">${dateStr}</td>
              <td class="col-view">${item.viewCount || 0}</td>
          `;
          body.appendChild(row);
      });
  }

  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      el.textContent = `Ver: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} [List-Type]`;
  })();
</script>
</body>
</html>
