<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --line-color: #eee; --text-dark: #333; --text-gray: #777; --primary: #3b82f6; --danger: #ef4444; }
    
    .dashboard-layout { max-width: 1100px; margin: 0 auto; padding: 20px 10px; }
    .sys-version-small { font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px; text-align: right; }

    .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .page-header h2 { font-size: 1.4rem; margin: 0; font-weight: 900; letter-spacing: -1px; }
    
    .search-bar { display: flex; gap: 5px; margin-bottom: 15px; justify-content: flex-end; }
    .search-bar input { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; width: 180px; }
    .btn-action { padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border: 1px solid #ddd; background: #fff; }
    .btn-write { background: var(--primary); color: #fff; border: none; }

    .view-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 0; background: #f9f9f9; }
    .view-tab-btn { padding: 10px 15px; font-size: 0.9rem; font-weight: 700; border: none; background: none; color: #666; cursor: pointer; position: relative; }
    .view-tab-btn.active { color: var(--primary); }
    .view-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--primary); }

    .board-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
    .board-table th { background: #f1f1f1; border-bottom: 1px solid #ccc; padding: 10px 5px; font-weight: 700; color: #444; text-align: center; }
    .board-table td { padding: 10px 5px; border-bottom: 1px solid var(--line-color); text-align: center; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .col-id { width: 50px; }
    .col-title { text-align: left !important; width: auto; }
    .col-date { width: 65px; color: var(--text-gray); font-size: 0.85rem; }
    .col-view { width: 50px; color: var(--text-gray); font-size: 0.85rem; }

    .notice-row:hover { background: #f8f9fa; }
    .notice-row.is-pinned { background: #fff8f8; }
    .notice-row.is-pinned td { font-weight: 600; }

    .title-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    .title-link:hover .title-text { text-decoration: underline; }
    
    .m-badge { font-size: 0.7rem; padding: 1px 4px; border-radius: 2px; font-weight: 800; color: #fff; line-height: 1; }
    .m-badge-pin { background: #777; }
    .m-badge-danger { background: var(--danger); }
    .m-badge-new { color: var(--danger); font-weight: 900; font-style: italic; font-family: 'Arial'; margin-left: 2px; }
    .comment-count { color: var(--primary); font-size: 0.8rem; font-weight: 700; margin-left: 3px; }

    /* í˜ì´ì§• */
    .pagination { display: flex; justify-content: center; gap: 6px; margin-top: 25px; margin-bottom: 40px; }
    .page-btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-size: 0.9rem; cursor: pointer; color: #555; font-weight: 600; }
    .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .page-btn:hover:not(.active) { background: #f1f5f9; }

    @media (max-width: 600px) {
      .col-id { display: none; }
      .board-table th:nth-child(1), .board-table td:nth-child(1) { display: none; } 
      .col-date { width: 50px; font-size: 0.75rem; padding: 10px 2px; }
      .col-view { width: 40px; font-size: 0.75rem; padding: 10px 2px; }
      .title-text { font-size: 0.9rem; }
      .page-header h2 { font-size: 1.1rem; }
    }
    
    .empty-state { text-align: center; padding: 50px 0; color: #999; border-bottom: 1px solid var(--line-color); }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
        <div class="sys-version-small" id="sysVersion">Version Checking...</div>

        <div class="page-header">
          <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
          <button class="btn-action btn-write" onclick="location.href='notice.html'">ê¸€ì“°ê¸°</button>
        </div>

        <div class="search-bar">
          <input type="text" id="search-keyword" placeholder="ì œëª© ê²€ìƒ‰..." onkeyup="if(event.key==='Enter') executeSearch()">
          <button class="btn-action" onclick="executeSearch()">ê²€ìƒ‰</button>
        </div>

        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchTab('all')" id="tab-all">ì „ì²´</button>
          <button class="view-tab-btn" onclick="switchTab('important')" id="tab-important">í•„ë…</button>
          <button class="view-tab-btn" onclick="switchTab('draft')" id="tab-draft">ì„ì‹œ</button>
        </div>

        <table class="board-table">
          <thead>
            <tr>
              <th class="col-id">ë²ˆí˜¸</th>
              <th class="col-title">ì œëª©</th>
              <th class="col-date">ë‚ ì§œ</th>
              <th class="col-view">ì¡°íšŒ</th>
            </tr>
          </thead>
          <tbody id="notice-list-body">
            </tbody>
        </table>
        <div id="empty-msg" class="empty-state" style="display:none;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

        <div id="pagination-root" class="pagination"></div>

      </div>
    </section>
  </main>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "board"; 
  let g_announcements = [];
  
  let currentTab = 'all';
  let currentPage = 1;
  const itemsPerPage = 10; // ğŸ‘ˆ í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ê²Œì‹œê¸€ ìˆ˜ (ìˆ˜ì • ê°€ëŠ¥)

  document.addEventListener('DOMContentLoaded', loadAnnouncements);

  // ìœ í‹¸ í•¨ìˆ˜ë“¤
  function getV(obj, ...keys) {
      if (!obj) return "";
      for (let key of keys) {
          const target = String(key).toLowerCase().replace(/[\s_]/g, '');
          const foundKey = Object.keys(obj).find(k => String(k).toLowerCase().replace(/[\s_]/g, '') === target);
          if (foundKey && obj[foundKey] !== undefined && obj[foundKey] !== null && obj[foundKey] !== "") {
              return obj[foundKey];
          }
      }
      return "";
  }

  function forceFormatDate(dateVal) {
      if (!dateVal) return '--.--';
      const raw = String(dateVal).trim();
      const match = raw.match(/(\d{4})[-/.\së…„]+(\d{1,2})[-/.\sì›”]+(\d{1,2})/);
      if (match) return `${match[2].padStart(2, '0')}.${match[3].padStart(2, '0')}`; 
      const d = new Date(raw);
      if (!isNaN(d.getTime())) return `${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
      return raw.substring(0, 5);
  }

  function findViewCount(item) {
      let v = getV(item, 'viewCount', 'view_count', 'views', 'ì¡°íšŒìˆ˜', 'ì¡°íšŒ', 'ì½ìŒ', '#num!', 'num');
      if (v !== "") {
          let parsed = parseInt(String(v).replace(/[^0-9]/g, ''), 10);
          if (!isNaN(parsed)) return parsed;
      }
      for (let k of Object.keys(item)) {
          if (/(view|ì¡°íšŒ|hit|num)/i.test(String(k))) {
              let parsed = parseInt(String(item[k]).replace(/[^0-9]/g, ''), 10);
              if (!isNaN(parsed)) return parsed;
          }
      }
      return 0; 
  }

  function findCommentCount(item) {
      let c = getV(item, 'commentCount', 'ëŒ“ê¸€ìˆ˜', 'ëŒ“ê¸€');
      if (c !== "") {
          let parsed = parseInt(String(c).replace(/[^0-9]/g, ''), 10);
          if (!isNaN(parsed)) return parsed;
      }
      for (let k of Object.keys(item)) {
          if (/(comment|ëŒ“ê¸€)/i.test(String(k))) {
              let parsed = parseInt(String(item[k]).replace(/[^0-9]/g, ''), 10);
              if (!isNaN(parsed)) return parsed;
          }
      }
      return 0;
  }

  function findDateStr(item) {
      let d = getV(item, 'createdAt', 'created_at', 'ìƒì„±ì¼ì‹œ', 'ì‘ì„±ì¼', 'ë‚ ì§œ', 'ë“±ë¡ì¼', 'startAt');
      if (d !== "") return forceFormatDate(d);
      for (let k of Object.keys(item)) {
          if (/(date|time|at|ì¼|ì‹œ|ë‚ ì§œ)/i.test(k)) {
              if (/^\d{4}[-/.]/.test(String(item[k]))) return forceFormatDate(item[k]);
          }
      }
      return '--.--';
  }

  async function loadAnnouncements() {
      if(typeof showAdminLoading==='function') showAdminLoading("ë¡œë”© ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=listAnnouncements");
          const json = await res.json();
          if(json.ok || json.result === "success") {
              g_announcements = json.announcements || json.data || json.items || json.notice || [];
              renderBoard();
          }
      } catch(e) { console.error(e); } 
      finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchTab(tabId) {
      currentTab = tabId;
      currentPage = 1; 
      document.querySelectorAll('.view-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      renderBoard();
  }

  function executeSearch() {
      currentPage = 1; 
      renderBoard();
  }

  // âœ… í˜ì´ì§• ë¡œì§ í•µì‹¬ (ê³ ì •ê¸€ + ì¼ë°˜ê¸€ í•©ì³ì„œ 10ê°œë¡œ ì»·íŒ…)
  function renderBoard() {
      const body = document.getElementById('notice-list-body');
      const empty = document.getElementById('empty-msg');
      body.innerHTML = ''; empty.style.display = 'none';

      const keyword = document.getElementById('search-keyword').value.toLowerCase().trim();

      // 1. ìœ íš¨ ë°ì´í„° í•„í„°ë§
      let filtered = g_announcements.filter(item => {
          const status = String(getV(item, 'status', 'ìƒíƒœ') || '').trim().toLowerCase();
          const level = String(getV(item, 'level', 'ì¤‘ìš”ë„') || '').trim().toLowerCase();
          const isPinned = (getV(item, 'isPinned', 'ìƒë‹¨ê³ ì •') == 1);
          const title = String(getV(item, 'title', 'ì œëª©') || '').toLowerCase();

          if (currentTab === 'draft') return status === 'draft';
          if (status === 'draft') return false;
          if (currentTab === 'important') return (isPinned || level === 'danger' || level === 'warn');
          if (keyword && !title.includes(keyword)) return false;
          return true;
      });

      // 2. ê³ ì •ê¸€(Pinned)ê³¼ ì¼ë°˜ê¸€(Normal) ì™„ë²½ ë¶„ë¦¬
      const pinnedItems = [];
      const normalItems = [];

      filtered.forEach(item => {
          const isPinned = (getV(item, 'isPinned', 'ìƒë‹¨ê³ ì •') == 1 || String(getV(item, 'level', 'ì¤‘ìš”ë„')).toLowerCase() === 'danger');
          if (isPinned && currentTab !== 'draft') {
              pinnedItems.push(item);
          } else {
              normalItems.push(item);
          }
      });

      // 3. ìµœì‹ ìˆœ ì •ë ¬
      const sortByDateDesc = (a, b) => {
          const dateA = new Date(getV(a, 'createdAt', 'ìƒì„±ì¼ì‹œ', 'ì‘ì„±ì¼') || 0);
          const dateB = new Date(getV(b, 'createdAt', 'ìƒì„±ì¼ì‹œ', 'ì‘ì„±ì¼') || 0);
          return dateB - dateA;
      };
      pinnedItems.sort(sortByDateDesc);
      normalItems.sort(sortByDateDesc);

      // 4. ë¦¬ìŠ¤íŠ¸ ë³‘í•© (í•­ìƒ ê³ ì •ê¸€ì´ ìœ„ë¡œ ì˜¤ë„ë¡)
      const finalItems = [...pinnedItems, ...normalItems];

      // ë¹ˆ ë°ì´í„° ì²˜ë¦¬
      if (finalItems.length === 0) { 
          empty.style.display = 'block'; 
          document.getElementById('pagination-root').innerHTML = '';
          return; 
      }

      // 5. í˜ì´ì§• ê³„ì‚° (ì´ ê°¯ìˆ˜ ê¸°ì¤€)
      const totalPages = Math.ceil(finalItems.length / itemsPerPage) || 1;
      if (currentPage > totalPages) currentPage = totalPages;

      const startIndex = (currentPage - 1) * itemsPerPage;
      // í™”ë©´ì— ë³´ì—¬ì¤„ ë”± 10ê°œì˜ ë°ì´í„°ë§Œ ìŠ¬ë¼ì´ì‹±
      const pageItems = finalItems.slice(startIndex, startIndex + itemsPerPage);

      // 6. í™”ë©´ ë Œë”ë§
      pageItems.forEach((item) => {
          // ì´ ì•„ì´í…œì´ ê³ ì •ê¸€ ë°°ì—´ì— ì†í•˜ëŠ”ì§€ í™•ì¸
          const isPinned = pinnedItems.includes(item);
          
          let displayNum = '';
          if (isPinned) {
              displayNum = 'ğŸ“Œ';
          } else {
              // ì¼ë°˜ê¸€ì´ë¼ë©´, ì¼ë°˜ê¸€ ì „ì²´ ëª©ë¡ì—ì„œì˜ ì§„ì§œ ë²ˆí˜¸ë¥¼ ì°¾ì•„ ë¶€ì—¬
              const normalIdx = normalItems.indexOf(item);
              displayNum = normalItems.length - normalIdx; 
          }
          
          body.appendChild(createRow(item, isPinned, displayNum));
      });

      // 7. í˜ì´ì§• ë²„íŠ¼ ìƒì„±
      renderPagination(totalPages);
  }

  function createRow(item, isPinned, displayNum) {
      const row = document.createElement('tr');
      row.className = `notice-row ${isPinned ? 'is-pinned' : ''}`;
      
      const isDanger = String(getV(item, 'level', 'ì¤‘ìš”ë„')).toLowerCase() === 'danger';
      const dateStr = findDateStr(item);
      const viewCount = findViewCount(item);
      const commentCount = findCommentCount(item);
      
      const rawDateVal = getV(item, 'createdAt', 'ìƒì„±ì¼ì‹œ', 'ì‘ì„±ì¼');
      const isNew = rawDateVal ? (new Date() - new Date(rawDateVal)) < (24 * 60 * 60 * 1000) : false;
      
      const id = getV(item, 'noticeId', 'id');
      const title = getV(item, 'title', 'ì œëª©') || '(ì œëª© ì—†ìŒ)';

      row.innerHTML = `
          <td class="col-id">${displayNum}</td>
          <td class="col-title">
            <a class="title-link" onclick="location.href='notice.html?id=${id}'">
              ${isDanger ? '<span class="m-badge m-badge-danger">í•„ë…</span>' : ''}
              ${isPinned && !isDanger ? '<span class="m-badge m-badge-pin">ê³µì§€</span>' : ''}
              <span class="title-text">${title}</span>
              ${commentCount > 0 ? `<span class="comment-count">[${commentCount}]</span>` : ''}
              ${isNew ? '<span class="m-badge-new">N</span>' : ''}
            </a>
          </td>
          <td class="col-date">${dateStr}</td>
          <td class="col-view">${viewCount}</td>
      `;
      return row;
  }

  // âœ… í˜ì´ì§• ë²„íŠ¼ ë Œë”ë§ (1í˜ì´ì§€ ë¿ì´ì–´ë„ ë¬´ì¡°ê±´ í‘œì‹œë¨)
  function renderPagination(totalPages) {
      const pRoot = document.getElementById('pagination-root');
      pRoot.innerHTML = '';
      
      // ê¸€ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìµœì†Œ [ 1 ] ë²„íŠ¼ì€ í•­ìƒ ë³´ì´ê²Œ ì„¤ì •

      if (currentPage > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'page-btn';
          prevBtn.textContent = 'â—€';
          prevBtn.onclick = () => { currentPage--; renderBoard(); };
          pRoot.appendChild(prevBtn);
      }

      for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.onclick = () => { currentPage = i; renderBoard(); };
          pRoot.appendChild(btn);
      }

      if (currentPage < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'page-btn';
          nextBtn.textContent = 'â–¶';
          nextBtn.onclick = () => { currentPage++; renderBoard(); };
          pRoot.appendChild(nextBtn);
      }
  }

  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      el.textContent = `Ver: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [True-Pagination]`;
  })();
</script>
</body>
</html>
