<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; padding-bottom: 60px; }
    
    /* ìƒë‹¨ í—¤ë” ì˜ì—­ */
    .archive-header { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .archive-title h2 { font-size: 1.8rem; color: #1e293b; margin: 0 0 8px 0; letter-spacing: -0.5px; font-weight: 800; }
    .archive-title p { color: #64748b; margin: 0; font-size: 0.95rem; }
    
    .report-controls { 
        display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between;
        background: #fff; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .styled-input { padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; font-family: inherit; }
    .styled-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    .btn-new { padding: 10px 20px; border-radius: 8px; border: none; background: #3b82f6; color: #fff; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
    .btn-new:hover { background: #2563eb; transform: translateY(-2px); }

    /* íƒ­ ë©”ë‰´ */
    .view-tabs { display: flex; gap: 6px; margin-bottom: 24px; background: #f1f5f9; padding: 6px; border-radius: 12px; overflow-x: auto; white-space: nowrap; }
    .view-tab-btn { padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 0.95rem; border: none; background: transparent; color: var(--text-sub); cursor: pointer; transition: all 0.2s; }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* ì¤‘ìš” ê³µì§€ (Pinned) ê·¸ë¦¬ë“œ */
    .pinned-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .pinned-card { background: #fff; border-radius: 16px; padding: 24px; border: 2px solid #fca5a5; box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.1); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .pinned-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.15); }
    .pinned-card::before { content: 'ğŸ“Œ í•„ë…'; position: absolute; top: 0; right: 0; background: #ef4444; color: #fff; font-size: 0.75rem; font-weight: 800; padding: 6px 16px; border-bottom-left-radius: 12px; }
    
    /* ì¼ë°˜ ê³µì§€ ë¦¬ìŠ¤íŠ¸ */
    .notice-list { display: flex; flex-direction: column; gap: 12px; }
    .notice-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
    .notice-item:hover { border-color: #cbd5e1; transform: translateX(4px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    
    .notice-info-left { display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0; }
    .notice-info-right { display: flex; align-items: center; gap: 20px; flex-shrink: 0; color: #64748b; font-size: 0.9rem; }
    
    .notice-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .notice-preview { font-size: 0.9rem; color: #64748b; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    
    /* ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; white-space: nowrap; }
    .badge-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
    .badge-warn { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
    .badge-normal { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .badge-draft { background: #f3f4f6; color: #94a3b8; border: 1px dashed #cbd5e1; }
    
    .meta-stat { display: flex; align-items: center; gap: 4px; font-weight: 600; }
    .meta-date { font-family: monospace; font-size: 0.85rem; color: #94a3b8; }

    @media (max-width: 768px) {
        .notice-item { flex-direction: column; align-items: flex-start; gap: 12px; }
        .notice-info-right { width: 100%; justify-content: flex-end; border-top: 1px dashed #e2e8f0; padding-top: 12px; }
    }
    
    .empty-state { text-align: center; padding: 60px 20px; background: #f8fafc; border-radius: 16px; border: 2px dashed #cbd5e1; color: #94a3b8; font-weight: 600; }
    /* ë²„ì „ í‘œì‹œ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .sys-version-large { font-size: 1.1rem; font-weight: 800; color: #ef4444; background: #fee2e2; display: inline-block; padding: 4px 12px; border-radius: 20px; margin-top: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
        <div class="archive-header">
          <div class="archive-title">
            <h2>ğŸ“¢ ì‚¬ë‚´ ê³µì§€ì‚¬í•­</h2>
            <p>ìƒˆë¡œìš´ ì†Œì‹ê³¼ ì¤‘ìš”í•œ ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
          </div>
          
          <div class="report-controls">
            <div style="display: flex; gap: 10px; flex: 1; max-width: 500px;">
                <input type="text" id="search-keyword" class="styled-input" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰..." style="flex: 1;" onkeyup="if(event.key==='Enter') renderBoard()">
                <button class="styled-input" style="background:#f1f5f9; cursor:pointer; font-weight:700;" onclick="renderBoard()">ğŸ” ê²€ìƒ‰</button>
            </div>
            <button class="btn-new" onclick="location.href='notice.html'">+ ìƒˆ ê³µì§€ ì‘ì„±</button>
          </div>
        </div>

        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchTab('all')" id="tab-all">ğŸ“‚ ì „ì²´ ê³µì§€</button>
          <button class="view-tab-btn" onclick="switchTab('important')" id="tab-important">ğŸš¨ ì¤‘ìš”/í•„ë…</button>
          <button class="view-tab-btn" onclick="switchTab('archived')" id="tab-archived">ğŸ—‚ï¸ ì¢…ë£Œ/ë³´ê´€</button>
          <button class="view-tab-btn" onclick="switchTab('draft')" id="tab-draft" style="margin-left: auto;">ğŸ“ ì„ì‹œì €ì¥</button>
        </div>

        <div id="pinned-notice-list" class="pinned-grid"></div>

        <div id="normal-notice-list" class="notice-list">
             <div class="empty-state">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "board"; 
  let g_announcements = [];
  let currentTab = 'all';

  document.addEventListener('DOMContentLoaded', () => {
      loadAnnouncements();
  });

  async function loadAnnouncements() {
      if(typeof showAdminLoading==='function') showAdminLoading("ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      try {
          // API ëª¨ë“œ: listAnnouncements
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=listAnnouncements");
          const json = await res.json();
          if(json.ok) {
              g_announcements = json.announcements || [];
              renderBoard();
          } else {
              alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + (json.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
          }
      } catch(e) { 
          console.error(e); 
          document.getElementById('normal-notice-list').innerHTML = `<div class="empty-state" style="color:#ef4444;">ë°ì´í„° í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
      } finally { 
          if(typeof hideAdminLoading==='function') hideAdminLoading(); 
      }
  }

  function switchTab(tabId) {
      currentTab = tabId;
      document.querySelectorAll('.view-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      renderBoard();
  }

  function renderBoard() {
      const pinnedRoot = document.getElementById('pinned-notice-list');
      const normalRoot = document.getElementById('normal-notice-list');
      pinnedRoot.innerHTML = ''; normalRoot.innerHTML = '';

      const keyword = document.getElementById('search-keyword').value.toLowerCase().trim();
      const todayStr = new Date().toISOString().split('T')[0];

      // í•„í„°ë§
      let filtered = g_announcements.filter(item => {
          // 1. ìƒíƒœ ë° íƒ­ í•„í„°
          if (currentTab === 'draft' && item.status !== 'draft') return false;
          if (currentTab !== 'draft' && item.status === 'draft') return false;
          
          if (currentTab === 'archived' && item.status !== 'archived') return false;
          if (currentTab !== 'archived' && item.status === 'archived') return false;

          if (currentTab === 'important') {
              if (item.level !== 'danger' && item.level !== 'warn' && item.isPinned != 1) return false;
          }

          // 2. ê²€ìƒ‰ í•„í„°
          if (keyword) {
              const title = (item.title || "").toLowerCase();
              const body = (item.body || "").toLowerCase();
              if (!title.includes(keyword) && !body.includes(keyword)) return false;
          }

          return true;
      });

      // ì •ë ¬: ìµœì‹  ê¸€(updatedAt ë˜ëŠ” createdAt) ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
      filtered.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
      });

      // Pinned(ìƒë‹¨ ê³ ì •) ë¶„ë¦¬
      const pinnedItems = filtered.filter(item => item.isPinned == 1 || item.level === 'danger');
      const normalItems = filtered.filter(item => item.isPinned != 1 && item.level !== 'danger');

      // ë Œë”ë§ - Pinned
      if (pinnedItems.length > 0 && currentTab !== 'draft' && currentTab !== 'archived') {
          pinnedItems.forEach(item => pinnedRoot.appendChild(createPinnedCard(item)));
      }

      // ë Œë”ë§ - Normal
      if (normalItems.length === 0 && pinnedItems.length === 0) {
          normalRoot.innerHTML = `<div class="empty-state">ì¡°ê±´ì— ë§ëŠ” ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      } else {
          normalItems.forEach(item => normalRoot.appendChild(createNormalRow(item)));
      }
  }

  function getBadgeHtml(level, status) {
      if (status === 'draft') return `<span class="badge badge-draft">ì„ì‹œì €ì¥</span>`;
      if (status === 'archived') return `<span class="badge badge-normal">ì¢…ë£Œë¨</span>`;
      
      if (level === 'danger') return `<span class="badge badge-danger">ğŸš¨ í•„ë…</span>`;
      if (level === 'warn') return `<span class="badge badge-warn">âš ï¸ ì¤‘ìš”</span>`;
      return `<span class="badge badge-normal">ì•ˆë‚´</span>`;
  }

  function createPinnedCard(item) {
      const card = document.createElement('div');
      card.className = 'pinned-card';
      
      // notice.html ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ (ID íŒŒë¼ë¯¸í„° ì „ë‹¬)
      card.onclick = () => location.href = `notice.html?id=${item.noticeId}`;

      const dateStr = (item.createdAt || "").split(' ')[0];
      const previewText = (item.body || "").replace(/<[^>]*>?/gm, '').slice(0, 80) + "...";

      card.innerHTML = `
          <div style="margin-bottom: 12px;">${getBadgeHtml(item.level, item.status)}</div>
          <div class="notice-title" style="font-size: 1.25rem; margin-bottom: 8px;">${item.title}</div>
          <div class="notice-preview" style="margin-bottom: 20px;">${previewText}</div>
          
          <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed #fca5a5; padding-top:12px;">
              <span class="meta-date">ğŸ“… ${dateStr}</span>
              <div style="display:flex; gap:12px;">
                  <span class="meta-stat" style="color:#ef4444;">ğŸ‘ï¸ ${item.viewCount || 0}</span>
                  <span class="meta-stat" style="color:#ef4444;">ğŸ’¬ ${item.commentCount || 0}</span>
              </div>
          </div>
      `;
      return card;
  }

  function createNormalRow(item) {
      const row = document.createElement('div');
      row.className = 'notice-item';
      
      row.onclick = () => location.href = `notice.html?id=${item.noticeId}`;

      const dateStr = (item.createdAt || "").split(' ')[0];
      const previewText = (item.body || "").replace(/<[^>]*>?/gm, '').slice(0, 60) + "...";

      row.innerHTML = `
          <div class="notice-info-left">
              ${getBadgeHtml(item.level, item.status)}
              <div style="min-width: 0; flex: 1;">
                  <div class="notice-title">${item.title}</div>
                  <div class="notice-preview">${previewText}</div>
              </div>
          </div>
          <div class="notice-info-right">
              <span class="meta-date">${dateStr}</span>
              <span class="meta-stat" title="ì¡°íšŒìˆ˜">ğŸ‘ï¸ ${item.viewCount || 0}</span>
              <span class="meta-stat" title="ëŒ“ê¸€ìˆ˜">ğŸ’¬ ${item.commentCount || 0}</span>
          </div>
      `;
      return row;
  }
  // ğŸ‘‡ </script> ë‹«íˆê¸° ë°”ë¡œ ìœ„ì— ì•„ë˜ í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤ ğŸ‘‡
  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      
      const versionTag = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [Board-Update]`;
      
      el.textContent = `Version: ${versionTag}`;
  })();
</script>
</body>
</html>
