<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    // âœ… API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --line-color: #eee; --text-dark: #333; --text-gray: #777; --primary: #3b82f6; --danger: #ef4444; }
    
    .dashboard-layout { max-width: 1100px; margin: 0 auto; padding: 20px 10px; }
    .sys-version-small { font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px; text-align: right; }

    .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .page-header h2 { font-size: 1.4rem; margin: 0; font-weight: 900; letter-spacing: -1px; }
    
    .search-bar { display: flex; gap: 5px; margin-bottom: 15px; justify-content: flex-end; }
    .search-bar input { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem; width: 180px; }
    .btn-action { padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border: 1px solid #ddd; background: #fff; }
    .btn-write { background: var(--primary); color: #fff; border: none; }

    .view-tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 0; background: #f9f9f9; }
    .view-tab-btn { padding: 10px 15px; font-size: 0.9rem; font-weight: 700; border: none; background: none; color: #666; cursor: pointer; position: relative; }
    .view-tab-btn.active { color: var(--primary); }
    .view-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--primary); }

    /* ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
    .board-table th { background: #f1f1f1; border-bottom: 1px solid #ccc; padding: 10px 5px; font-weight: 700; color: #444; }
    .board-table td { padding: 10px 5px; border-bottom: 1px solid var(--line-color); text-align: center; color: var(--text-dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .col-id { width: 50px; }
    .col-title { text-align: left !important; width: auto; }
    .col-date { width: 70px; color: var(--text-gray); font-size: 0.85rem; }
    .col-view { width: 50px; color: var(--text-gray); font-size: 0.85rem; }

    .notice-row:hover { background: #f8f9fa; }
    .notice-row.is-pinned { background: #fff8f8; }
    .notice-row.is-pinned td { font-weight: 600; }

    .title-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    .title-link:hover .title-text { text-decoration: underline; }
    
    .m-badge { font-size: 0.7rem; padding: 1px 4px; border-radius: 2px; font-weight: 800; color: #fff; line-height: 1; }
    .m-badge-pin { background: #777; }
    .m-badge-danger { background: var(--danger); }
    .m-badge-new { color: var(--danger); font-weight: 900; font-style: italic; font-family: 'Arial'; margin-left: 2px; }
    .comment-count { color: var(--primary); font-size: 0.8rem; font-weight: 700; margin-left: 3px; }

    /* í˜ì´ì§• (ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼) */
    .pagination { display: flex; justify-content: center; gap: 6px; margin-top: 25px; margin-bottom: 40px; }
    .page-btn { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-size: 0.9rem; cursor: pointer; color: #555; font-weight: 600; }
    .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .page-btn:hover:not(.active) { background: #f1f5f9; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘: ë‚ ì§œ/ì¡°íšŒìˆ˜ëŠ” ì‘ê²Œ ìœ ì§€í•˜ê³  ë²ˆí˜¸ë§Œ ìˆ¨ê¹€ */
    @media (max-width: 600px) {
      .col-id { display: none; }
      .board-table th:nth-child(1), .board-table td:nth-child(1) { display: none; } 
      .col-date { width: 45px; font-size: 0.75rem; }
      .col-view { width: 35px; font-size: 0.75rem; }
      .page-header h2 { font-size: 1.1rem; }
    }
    
    .empty-state { text-align: center; padding: 50px 0; color: #999; border-bottom: 1px solid var(--line-color); }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
        <div class="sys-version-small" id="sysVersion">Version Checking...</div>

        <div class="page-header">
          <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
          <button class="btn-action btn-write" onclick="location.href='notice.html'">ê¸€ì“°ê¸°</button>
        </div>

        <div class="search-bar">
          <input type="text" id="search-keyword" placeholder="ì œëª© ê²€ìƒ‰..." onkeyup="if(event.key==='Enter') executeSearch()">
          <button class="btn-action" onclick="executeSearch()">ê²€ìƒ‰</button>
        </div>

        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchTab('all')" id="tab-all">ì „ì²´</button>
          <button class="view-tab-btn" onclick="switchTab('important')" id="tab-important">í•„ë…</button>
          <button class="view-tab-btn" onclick="switchTab('draft')" id="tab-draft">ì„ì‹œ</button>
        </div>

        <table class="board-table">
          <thead>
            <tr>
              <th class="col-id">ë²ˆí˜¸</th>
              <th class="col-title">ì œëª©</th>
              <th class="col-date">ë‚ ì§œ</th>
              <th class="col-view">ì¡°íšŒ</th>
            </tr>
          </thead>
          <tbody id="notice-list-body">
            </tbody>
        </table>
        <div id="empty-msg" class="empty-state" style="display:none;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

        <div id="pagination-root" class="pagination"></div>

      </div>
    </section>
  </main>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "board"; 
  let g_announcements = [];
  
  // âœ… í˜ì´ì§• ê´€ë ¨ ë³€ìˆ˜
  let currentTab = 'all';
  let currentPage = 1;
  const itemsPerPage = 10; // í•œ í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ê²Œì‹œê¸€ ìˆ˜

  document.addEventListener('DOMContentLoaded', loadAnnouncements);

  function getV(obj, key) {
    if(!obj) return "";
    const foundKey = Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase());
    return foundKey ? obj[foundKey] : "";
  }

  async function loadAnnouncements() {
      if(typeof showAdminLoading==='function') showAdminLoading("ë¡œë”© ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=listAnnouncements");
          const json = await res.json();
          if(json.ok || json.result === "success") {
              g_announcements = json.announcements || json.data || json.items || [];
              renderBoard();
          }
      } catch(e) { console.error(e); } 
      finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchTab(tabId) {
      currentTab = tabId;
      currentPage = 1; // íƒ­ ë³€ê²½ ì‹œ 1í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
      document.querySelectorAll('.view-tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
      renderBoard();
  }

  function executeSearch() {
      currentPage = 1; // ê²€ìƒ‰ ì‹œ 1í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
      renderBoard();
  }

  function renderBoard() {
      const body = document.getElementById('notice-list-body');
      const empty = document.getElementById('empty-msg');
      body.innerHTML = ''; empty.style.display = 'none';

      const keyword = document.getElementById('search-keyword').value.toLowerCase().trim();
      const now = new Date();

      // 1. ë°ì´í„° í•„í„°ë§
      let filtered = g_announcements.filter(item => {
          const status = String(getV(item, 'status') || '').trim().toLowerCase();
          const level = String(getV(item, 'level') || '').trim().toLowerCase();
          const isPinned = (getV(item, 'isPinned') == 1);
          const title = String(getV(item, 'title') || '').toLowerCase();

          if (currentTab === 'draft') return status === 'draft';
          if (status === 'draft') return false;
          if (currentTab === 'important') return (isPinned || level === 'danger' || level === 'warn');
          if (keyword && !title.includes(keyword)) return false;
          return true;
      });

      // 2. ì •ë ¬ (ê³ ì •ê¸€ ë¶„ë¦¬ ì—†ì´ ëª¨ë‘ ìµœì‹ ìˆœ ì •ë ¬ í›„ ë¶„ë¥˜)
      filtered.sort((a, b) => new Date(getV(b, 'createdAt') || 0) - new Date(getV(a, 'createdAt') || 0));

      const pinnedItems = filtered.filter(item => getV(item, 'isPinned') == 1 || String(getV(item, 'level')).toLowerCase() === 'danger');
      const normalItems = filtered.filter(item => !(getV(item, 'isPinned') == 1 || String(getV(item, 'level')).toLowerCase() === 'danger'));

      if (filtered.length === 0) { 
          empty.style.display = 'block'; 
          document.getElementById('pagination-root').innerHTML = '';
          return; 
      }

      // 3. í˜ì´ì§• ê³„ì‚° (ì¼ë°˜ ê¸€ ê¸°ì¤€)
      const totalPages = Math.ceil(normalItems.length / itemsPerPage) || 1;
      if (currentPage > totalPages) currentPage = totalPages;

      const startIndex = (currentPage - 1) * itemsPerPage;
      const pageNormalItems = normalItems.slice(startIndex, startIndex + itemsPerPage);

      // 4. ë Œë”ë§ - ê³ ì •ê¸€(Pinned)ì€ 1í˜ì´ì§€ì—ì„œë§Œ ìƒë‹¨ì— í‘œì‹œ
      if (currentPage === 1 && currentTab !== 'draft') {
          pinnedItems.forEach(item => body.appendChild(createRow(item, true, 'ğŸ“Œ')));
      }

      // 5. ë Œë”ë§ - ì¼ë°˜ê¸€ í˜ì´ì§• ì²˜ë¦¬
      pageNormalItems.forEach((item, idx) => {
          const displayNum = normalItems.length - startIndex - idx; // ì—­ìˆœ ë²ˆí˜¸ ë§¤ê¸°ê¸°
          body.appendChild(createRow(item, false, displayNum));
      });

      // 6. í˜ì´ì§• ë²„íŠ¼ ìƒì„±
      renderPagination(totalPages);
  }

  function createRow(item, isPinned, displayNum) {
      const row = document.createElement('tr');
      row.className = `notice-row ${isPinned ? 'is-pinned' : ''}`;
      
      const isDanger = String(getV(item, 'level')).toLowerCase() === 'danger';
      const cDate = getV(item, 'createdAt');
      const isNew = cDate ? (new Date() - new Date(cDate)) < (24 * 60 * 60 * 1000) : false;
      
      // âœ… ë‚ ì§œ ì¶”ì¶œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (MM.DD í¬ë§·)
      let dateStr = '--.--';
      if (cDate) {
          const match = String(cDate).match(/(\d{4})[-/.](\d{2})[-/.](\d{2})/);
          if(match) dateStr = `${match[2]}.${match[3]}`; // 12.14 í˜•ì‹
          else dateStr = String(cDate).substring(0, 10);
      }
      
      const id = getV(item, 'noticeId') || getV(item, 'id');
      const viewCount = getV(item, 'viewCount') || 0;
      const commentCount = getV(item, 'commentCount') || 0;
      const title = getV(item, 'title') || '(ì œëª© ì—†ìŒ)';

      row.innerHTML = `
          <td class="col-id">${displayNum}</td>
          <td class="col-title">
            <a class="title-link" onclick="location.href='notice.html?id=${id}'">
              ${isDanger ? '<span class="m-badge m-badge-danger">í•„ë…</span>' : ''}
              ${isPinned && !isDanger ? '<span class="m-badge m-badge-pin">ê³µì§€</span>' : ''}
              <span class="title-text">${title}</span>
              ${commentCount > 0 ? `<span class="comment-count">[${commentCount}]</span>` : ''}
              ${isNew ? '<span class="m-badge-new">N</span>' : ''}
            </a>
          </td>
          <td class="col-date">${dateStr}</td>
          <td class="col-view">${viewCount}</td>
      `;
      return row;
  }

  // âœ… í˜ì´ì§• ë²„íŠ¼ ë Œë”ë§ í•¨ìˆ˜
  function renderPagination(totalPages) {
      const pRoot = document.getElementById('pagination-root');
      pRoot.innerHTML = '';
      
      if (totalPages <= 1) return; // 1í˜ì´ì§€ ë¿ì´ë©´ ë²„íŠ¼ ìˆ¨ê¹€

      // ì´ì „ ë²„íŠ¼
      if (currentPage > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'page-btn';
          prevBtn.textContent = 'â—€';
          prevBtn.onclick = () => { currentPage--; renderBoard(); };
          pRoot.appendChild(prevBtn);
      }

      // ìˆ«ì ë²„íŠ¼
      for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
          btn.textContent = i;
          btn.onclick = () => { currentPage = i; renderBoard(); };
          pRoot.appendChild(btn);
      }

      // ë‹¤ìŒ ë²„íŠ¼
      if (currentPage < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'page-btn';
          nextBtn.textContent = 'â–¶';
          nextBtn.onclick = () => { currentPage++; renderBoard(); };
          pRoot.appendChild(nextBtn);
      }
  }

  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      el.textContent = `Ver: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} [Paging-Update]`;
  })();
</script>
</body>
</html>
