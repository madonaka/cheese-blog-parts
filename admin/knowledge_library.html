<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knowledge DB · Library</title>

  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "knowledge_library";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "Knowledge DB";
    window.CHEESE_ADMIN_PAGE_BADGE    = "Library";
  </script>

  <link rel="stylesheet" href="./admin.css" />
  <script defer src="./admin-common.js"></script>

  <style>
    /* 공통 overflow로 잘리는 것 방지 */
    .admin-main, .notice-wrap { height:auto !important; min-height:0 !important; }
    .notice-wrap { overflow:visible !important; padding-bottom:24px !important; }

    .card{
      background:#fff; border:1px solid rgba(15,23,42,.10);
      border-radius:18px; box-shadow:0 10px 28px rgba(15,23,42,.10);
      overflow:hidden; margin-bottom:14px;
    }
    .h{ padding:14px 14px 12px; border-bottom:1px solid rgba(15,23,42,.10); }
    .h-title{ margin:0; font-size:16px; font-weight:900; color:#0f172a; }
    .h-desc{ margin:6px 0 0; font-size:12px; color:#64748b; line-height:1.4; }

    .tools{
      display:flex; flex-wrap:wrap; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(15,23,42,.10);
      align-items:center;
    }
    .field{ display:flex; gap:8px; align-items:center; }
    .label{ font-size:12px; font-weight:800; color:#0f172a; }
    .input, .select{
      height:34px; border:1px solid rgba(15,23,42,.14);
      border-radius:12px; padding:0 10px; font-size:13px; outline:none;
      background:#fff; color:#0f172a;
    }
    .input{ width: 260px; max-width: 70vw; }
    .select{ width: 160px; max-width: 45vw; }
    .btn{
      height:34px; border-radius:12px; border:1px solid rgba(15,23,42,.14);
      background:#fff; padding:0 12px; font-size:13px; font-weight:900;
      cursor:pointer;
    }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .meta{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px; font-size:12px; color:#64748b;
      border-bottom:1px solid rgba(15,23,42,.10);
      gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
      background:rgba(15,23,42,.06); color:#0f172a;
      white-space:nowrap;
    }
    .muted{ color:#64748b; font-size:12px; }

    /* ✅ 카드 리스트(모바일 우선) */
    .list-wrap{ padding: 12px 14px 14px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .item{
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding: 12px 12px 11px;
      box-shadow:0 8px 18px rgba(15,23,42,.06);
      background:#fff;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      box-shadow:0 14px 26px rgba(15,23,42,.10);
      border-color: rgba(15,23,42,.22);
    }

    .row1{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .title{
      margin:0;
      font-weight:900;
      font-size:14px;
      color:#0f172a;
      line-height:1.25;
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .id{
      flex:0 0 auto;
      font-size:12px;
      font-weight:900;
      color:#475569;
      background: rgba(15,23,42,.06);
      border-radius: 999px;
      padding: 4px 8px;
      white-space: nowrap;
    }
    .row2{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-top: 8px;
    }
    .row3{
      margin-top: 8px;
      display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .tags{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,.06);
      font-size: 12px;
      font-weight: 800;
      color: #0f172a;
    }
    .date{
      font-size:12px; color:#64748b;
      white-space: nowrap;
    }
    .excerpt{
      margin-top: 8px;
      font-size: 12px;
      color:#475569;
      line-height: 1.45;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .pager{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; gap:10px; flex-wrap:wrap;
      border-top:1px solid rgba(15,23,42,.10);
    }
    .pager .left, .pager .right{ display:flex; gap:8px; align-items:center; }

    .err{
      padding:10px 14px; color:#b91c1c; background:rgba(185,28,28,.06);
      border-top:1px solid rgba(185,28,28,.18);
      font-size:12px;
      display:none;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="notice-wrap">
        <section class="card">
          <div class="h">
            <p class="h-title">Library (목록/검색) · 카드 보기</p>
            <p class="h-desc">좌우 스크롤 없이 카드로 목록을 표시합니다. (검색/필터/페이지네이션 포함)</p>
          </div>

          <div class="tools">
            <div class="field">
              <span class="label">검색</span>
              <input id="q" class="input" placeholder="제목/본문/태그 키워드" />
            </div>

            <div class="field">
              <span class="label">카테고리</span>
              <select id="category" class="select">
                <option value="">전체</option>
                <option value="timeline">연표</option>
                <option value="person">인물</option>
                <option value="event">사건</option>
                <option value="memo">메모</option>
              </select>
            </div>

            <div class="field">
              <span class="label">정렬</span>
              <select id="sort" class="select">
                <option value="updated_desc">최근 수정</option>
                <option value="created_desc">최근 생성</option>
                <option value="title_asc">제목 A→Z</option>
              </select>
            </div>

            <button id="btnSearch" class="btn primary">검색</button>
            <button id="btnReset" class="btn">초기화</button>
          </div>

          <div class="meta">
            <div>
              <span class="pill">총 <b id="total">0</b>건</span>
              <span class="muted" id="metaHint"></span>
            </div>
            <div class="field">
              <span class="label">페이지 크기</span>
              <select id="size" class="select" style="width:110px;">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>

          <div class="list-wrap">
            <div id="grid" class="grid">
              <div class="muted">불러오는 중...</div>
            </div>
          </div>

          <div class="pager">
            <div class="left">
              <button id="btnPrev" class="btn">이전</button>
              <button id="btnNext" class="btn">다음</button>
              <span class="muted">Page <b id="page">1</b></span>
            </div>
            <div class="right">
              <button id="btnRefresh" class="btn">새로고침</button>
              <a class="btn" href="./knowledge_db_hub.html" style="text-decoration:none; display:inline-flex; align-items:center;">허브로</a>
            </div>
          </div>

          <div id="err" class="err"></div>
        </section>

        <script>
          const API_BASE =
            (window.CHEESE_ADMIN_API_BASE || window.CHEESE_BLOG_API_BASE || "").trim();

          const state = {
            page: 1,
            size: 20,
            q: "",
            category: "",
            sort: "updated_desc",
            total: 0,
            loading: false,
          };

          const $ = (id) => document.getElementById(id);
          const ui = {
            q: $("q"),
            category: $("category"),
            sort: $("sort"),
            size: $("size"),
            btnSearch: $("btnSearch"),
            btnReset: $("btnReset"),
            btnPrev: $("btnPrev"),
            btnNext: $("btnNext"),
            btnRefresh: $("btnRefresh"),
            grid: $("grid"),
            total: $("total"),
            page: $("page"),
            metaHint: $("metaHint"),
            err: $("err"),
          };

          function setError(msg){
            ui.err.style.display = msg ? "block" : "none";
            ui.err.textContent = msg || "";
          }
          function setLoading(v){
            state.loading = v;
            ui.btnSearch.disabled = v;
            ui.btnPrev.disabled = v;
            ui.btnNext.disabled = v;
            ui.btnRefresh.disabled = v;
          }

          async function apiGet(params){
            if (!API_BASE){
              throw new Error("API Base가 비어 있습니다. window.CHEESE_ADMIN_API_BASE 또는 window.CHEESE_BLOG_API_BASE를 설정하세요.");
            }
            const usp = new URLSearchParams(params);
            const url = `${API_BASE}?${usp.toString()}`;
            const res = await fetch(url, { method:"GET", cache:"no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          }

          function mapResponse(data){
            if (!data) return { total: 0, items: [] };
            if (Array.isArray(data.items)) {
              return { total: Number(data.total || data.items.length || 0), items: data.items };
            }
            if (Array.isArray(data.rows)) {
              return { total: Number(data.totalCount || data.rows.length || 0), items: data.rows };
            }
            return { total: 0, items: [] };
          }

          function fmtDate(iso){
            if (!iso) return "";
            const d = new Date(iso);
            if (isNaN(d.getTime())) return String(iso);
            const yy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,"0");
            const dd = String(d.getDate()).padStart(2,"0");
            const hh = String(d.getHours()).padStart(2,"0");
            const mi = String(d.getMinutes()).padStart(2,"0");
            return `${yy}-${mm}-${dd} ${hh}:${mi}`;
          }

          function escapeHtml(s){
            return String(s)
              .replaceAll("&","&amp;")
              .replaceAll("<","&lt;")
              .replaceAll(">","&gt;")
              .replaceAll('"',"&quot;")
              .replaceAll("'","&#039;");
          }

          function getId(it){ return it.id ?? it.docId ?? it.key ?? ""; }
          function getTitle(it){ return it.title ?? it.name ?? "(제목 없음)"; }
          function getCategory(it){ return it.category ?? it.type ?? ""; }
          function getTags(it){
            if (Array.isArray(it.tags)) return it.tags;
            if (typeof it.tags === "string") return it.tags.split(",").map(s=>s.trim()).filter(Boolean);
            return [];
          }
          function getUpdatedAt(it){
            return it.updatedAt ?? it.updated_at ?? it.updated ?? it.modifiedAt ?? it.modified_at ?? "";
          }
          function getExcerpt(it){
            // 있으면 사용, 없으면 빈 값
            return it.excerpt ?? it.summary ?? it.desc ?? it.description ?? "";
          }

          function render(items){
            ui.page.textContent = String(state.page);
            ui.total.textContent = String(state.total);
            ui.metaHint.textContent = state.q ? `검색어: "${state.q}"` : "";

            if (!items || items.length === 0){
              ui.grid.innerHTML = `<div class="muted">결과가 없습니다.</div>`;
              return;
            }

            ui.grid.innerHTML = items.map(it => {
              const id = String(getId(it));
              const title = String(getTitle(it));
              const category = String(getCategory(it));
              const tags = getTags(it).slice(0, 8); // 너무 많으면 컷
              const updated = getUpdatedAt(it) ? fmtDate(getUpdatedAt(it)) : "-";
              const excerpt = String(getExcerpt(it) || "");

              return `
                <article class="item">
                  <div class="row1">
                    <p class="title" data-open="${escapeHtml(id)}">${escapeHtml(title)}</p>
                    <span class="id">${escapeHtml(id)}</span>
                  </div>

                  <div class="row2">
                    ${category ? `<span class="pill">${escapeHtml(category)}</span>` : `<span class="muted">분류 없음</span>`}
                    <span class="date">수정 ${escapeHtml(updated)}</span>
                  </div>

                  ${excerpt ? `<div class="excerpt">${escapeHtml(excerpt)}</div>` : ``}

                  <div class="row3">
                    <div class="tags">
                      ${tags.length ? tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("") : `<span class="muted">태그 없음</span>`}
                    </div>
                  </div>
                </article>
              `;
            }).join("");

            // 카드 클릭 → Editor로 이동
            ui.grid.querySelectorAll("[data-open]").forEach(el=>{
              el.addEventListener("click", () => {
                const id = el.getAttribute("data-open");
                location.href = `./knowledge_editor.html?id=${encodeURIComponent(id)}`;
              });
            });
          }

          async function load(){
            if (state.loading) return;
            setError("");
            setLoading(true);

            try{
              const data = await apiGet({
                mode: "knowledgeList",
                q: state.q,
                category: state.category,
                sort: state.sort,
                page: String(state.page),
                size: String(state.size),
              });

              if (data.ok === false) throw new Error(data.message || "API 오류");

              const mapped = mapResponse(data);
              state.total = mapped.total;

              render(mapped.items);

              const maxPage = Math.max(1, Math.ceil(state.total / state.size));
              ui.btnPrev.disabled = state.loading || state.page <= 1;
              ui.btnNext.disabled = state.loading || state.page >= maxPage;

            }catch(e){
              setError(e?.message || String(e));
              ui.grid.innerHTML = `<div class="muted">오류가 발생했습니다.</div>`;
            }finally{
              setLoading(false);
            }
          }

          function applyFromUi(resetPage=true){
            state.q = ui.q.value.trim();
            state.category = ui.category.value;
            state.sort = ui.sort.value;
            state.size = Number(ui.size.value || 20);
            if (resetPage) state.page = 1;
          }

          ui.btnSearch.addEventListener("click", () => { applyFromUi(true); load(); });
          ui.btnReset.addEventListener("click", () => {
            ui.q.value = "";
            ui.category.value = "";
            ui.sort.value = "updated_desc";
            ui.size.value = "20";
            applyFromUi(true);
            load();
          });
          ui.btnRefresh.addEventListener("click", () => load());
          ui.btnPrev.addEventListener("click", () => { if (state.page>1){ state.page--; load(); } });
          ui.btnNext.addEventListener("click", () => { state.page++; load(); });

          ui.q.addEventListener("keydown", (e)=>{
            if (e.key === "Enter"){
              applyFromUi(true);
              load();
            }
          });

          applyFromUi(true);
          load();
        </script>
      </main>
    </div>
  </div>
</body>
</html>
