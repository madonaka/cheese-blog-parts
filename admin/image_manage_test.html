
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì´ë¯¸ì§€ ê´€ë¦¬ íˆ´</title>

  <!-- âœ… ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* [1. ë ˆì´ì•„ì›ƒ & ê³µí†µ ì»´í¬ë„ŒíŠ¸] */
    body { background-color: #f2f4f6; color: #333d4b; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
    .im-wrap { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .im-card { background: #fff; border: none; border-radius: 24px; padding: 28px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
    .im-title { font-weight: 700; font-size: 22px; color: #191f28; margin: 0 0 16px; letter-spacing: -0.4px; }
    .im-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 16px 0; }
    .im-label { font-weight: 600; min-width: 120px; color: #4e5968; font-size: 15px; }
    .im-help { color: #8b95a1; font-size: 13px; line-height: 1.6; margin-top: 4px; }
    .im-status { display: inline-block; padding: 6px 12px; border-radius: 8px; background: #f9fafb; font-weight: 700; font-size: 12px; color: #4e5968; }
    .im-status.ok { background: #e8f3ee; color: #00814d; }
    .im-status.bad { background: #fdf0f0; color: #e52e2e; }
  
    /* [2. ì…ë ¥ í¼ & ë²„íŠ¼] */
    .im-input { background-color: #f9fafb; border: 1px solid transparent; border-radius: 12px; padding: 14px 16px; transition: all 0.2s; font-size: 15px; width: 100%; box-sizing: border-box; }
    .im-input:focus { background-color: #fff; border-color: #3182f6; outline: none; box-shadow: 0 0 0 3px rgba(49,130,246,0.1); }
    .im-range { width: 220px; accent-color: #3182f6; cursor: pointer; }
    .im-btn { border: none; background: #f2f4f6; color: #4e5968; border-radius: 14px; padding: 14px 24px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
    .im-btn.primary { background: #3182f6; color: #fff; box-shadow: 0 4px 12px rgba(49,130,246,0.2); } 
    .im-btn:hover { filter: brightness(0.96); transform: translateY(-1px); }
    .im-btn:active { transform: scale(0.97); }
    .im-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    .im-smallbtn { background: #f2f4f6; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; font-size: 13px; color: #4e5968; }
  
    /* [3. ë¯¸ë¦¬ë³´ê¸° & ì¹© UI] */
    .im-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 24px; }
    .im-chiprow { display: flex; gap: 8px; flex-wrap: wrap; }
    .im-chip { padding: 10px 16px; border-radius: 12px; background: #f2f4f6; color: #4e5968; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; }
    .im-chip.on { background: #3182f6; color: #fff; box-shadow: 0 4px 10px rgba(49,130,246,0.15); }
    .im-selected { border: 3px solid #3182f6; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 24px rgba(49,130,246,0.2); }
    .im-clickhint { color: #8b95a1; font-weight: 500; font-size: 12px; margin-left: 6px; }
    .im-preview-link img { cursor: zoom-in; border-radius: 16px; width: 100%; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .im-preview-link img:hover { transform: scale(1.03); }
  
    /* [4. ê²°ê³¼ & ì•Œë¦¼] */
    .im-result { margin-top: 20px; padding: 24px; border-radius: 18px; background: #f9fafb; font-size: 14px; line-height: 1.6; color: #333d4b; border: 1px solid #edf1f5; }
    .im-toast { position: fixed; right: 24px; top: 24px; z-index: 10000; min-width: 300px; padding: 18px 24px; border-radius: 20px; background: #fff; box-shadow: 0 12px 40px rgba(0,0,0,0.15); font-weight: 700; font-size: 15px; opacity: 0; transform: translateY(-20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; border: none; }
    .im-toast.show { opacity: 1; transform: translateY(0); }
    .im-toast.ok { color: #00814d; border-left: 5px solid #00814d; }
    .im-toast.bad { color: #e52e2e; border-left: 5px solid #e52e2e; }
  
    /* [5. íƒ­ & ë‹¨ê³„ íë¦„ ì œì–´] */
    .im-tabs { display: flex; gap: 8px; margin-bottom: 28px; background: #e8eaed; padding: 6px; border-radius: 18px; width: fit-content; }
    .im-tab { border: none; background: transparent; border-radius: 14px; padding: 10px 22px; cursor: pointer; font-weight: 700; color: #8b95a1; transition: all 0.25s; font-size: 14px; }
    .im-tab.on { background: #fff; color: #3182f6; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .im-panel { display: none !important; }
    .im-panel.on { display: block !important; animation: slideUp 0.4s ease-out;}
    
    /* [6. ëª©ë¡ ë¦¬ìŠ¤íŠ¸] */
    .im-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .im-item { border: none; border-radius: 24px; padding: 24px; background: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.03); transition: all 0.3s; }
    .im-item:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .im-thumb { width: 100%; border-radius: 16px; display: block; margin: 16px 0; border: 1px solid #f2f4f6; }
    .im-item-fname { font-weight: 700; font-size: 18px; color: #191f28; line-height: 1.4; margin-bottom: 6px; }
    .im-item-id { font-weight: 600; font-size: 14px; color: #adb5bd; }
  
    /* [7. ìœ í‹¸ë¦¬í‹° & ì• ë‹ˆë©”ì´ì…˜] */
    .im-hidden { position: fixed; left: -9999px; visibility: hidden; }
    .im-hr { height: 1px; background: #f2f4f6; margin: 24px 0; border: none; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 980px) { .im-grid, .im-list { grid-template-columns: 1fr; } .im-label { min-width: auto; margin-bottom: 6px; } .im-row { flex-direction: column; align-items: flex-start; } .im-tabs { width: 100%; overflow-x: auto; } }
    /* âœ… ë²„íŠ¼ ë””ìì¸ ê°œì„  */
    .im-btn { 
      border: none; 
      background: #f2f4f6; 
      color: #4e5968; 
      border-radius: 14px; 
      padding: 16px 24px; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
      cursor: pointer; 
      font-weight: 700; 
      font-size: 16px; 
      transition: all 0.2s; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      gap: 8px;
    }
    
    /* ê°•ì¡°ìš© íŒŒë€ ë²„íŠ¼ */
    .im-btn.primary { 
      background: #3182f6; 
      color: #fff; 
      box-shadow: 0 8px 16px rgba(49,130,246,0.15); /* ì…ì²´ê° ì¶”ê°€ */
    }
    
    .im-btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
    .im-btn:active { transform: scale(0.96); }
    
    /* âœ… ë²„íŠ¼ë“¤ì„ ê°ì‹¸ëŠ” í•˜ë‹¨ ë°” ë ˆì´ì•„ì›ƒ */
    .im-action-row {
      display: flex;
      align-items: center;
      gap: 12px;           /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #f2f4f6;
    }
    /* âœ… ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³´ê°• */
    .im-btn {
      height: 54px;        /* ë²„íŠ¼ ë†’ì´ í†µì¼ */
      padding: 0 24px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    
    /* ì´ì „ìœ¼ë¡œ ë²„íŠ¼ (íšŒìƒ‰ ë°°ê²½) */
    .im-btn-secondary {
      background-color: #f2f4f6;
      color: #4e5968;
      flex: 1;            /* 1ì˜ ë¹„ìœ¨ */
      max-width: 140px;   /* ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ ì œí•œ */
    }
    
    /* ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ (íŒŒë€ìƒ‰ ë°°ê²½) */
    .im-btn-primary {
      background-color: #3182f6;
      color: #fff;
      flex: 2;            /* 2ì˜ ë¹„ìœ¨ë¡œ ì„¤ì •í•˜ì—¬ ì•ˆì •ê° ë¶€ì—¬ */
      box-shadow: 0 8px 16px rgba(49,130,246,0.12);
    }
    
    .im-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .im-btn:active { transform: scale(0.98); }
    @keyframes imSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* [8. ë¡œë”© ë§ˆìŠ¤í¬ & ìŠ¤í”¼ë„ˆ (ì¶”ê°€ë¨)] */
    .im-global-mask { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255, 255, 255, 0.8); z-index: 99999; 
      display: none; align-items: center; justify-content: center; flex-direction: column; 
    }
    .im-global-spinner { 
      width: 50px; height: 50px; 
      border: 5px solid #e2e8f0; border-top: 5px solid #3182f6; 
      border-radius: 50%; animation: imGlobalSpin 1s linear infinite; margin-bottom: 10px; 
    }
    .im-global-text { 
      font-weight: 800; color: #3182f6; font-size: 16px; 
      animation: imPulse 1.5s ease-in-out infinite; 
    }
    @keyframes imGlobalSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes imPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* [9. ë³´ê´€í•¨ ì„œë¸Œ íƒ­ & ê°œì„ ëœ ë¦¬ìŠ¤íŠ¸] */
    .im-subtabs { display: flex; gap: 4px; background: #f2f4f6; padding: 4px; border-radius: 12px; width: fit-content; margin-bottom: 20px; }
    .im-subtab { padding: 8px 16px; border-radius: 10px; border: none; background: transparent; color: #4e5968; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .im-subtab.on { background: #fff; color: #3182f6; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    
    /* ê°œì„ ëœ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ (ê°€ë¡œí˜• ë°°ì¹˜) */
    .im-clean-item { display: flex; align-items: center; background: #fff; border: 1px solid #edf1f5; border-radius: 16px; padding: 12px; margin-bottom: 12px; transition: all 0.2s; gap: 16px; }
    .im-clean-item:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.06); border-color: #dbeafe; }
    
    .im-clean-thumb { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; background: #f9fafb; border: 1px solid #edf1f5; flex-shrink: 0; }
    
    .im-clean-info { flex: 1; min-width: 0; }
    .im-clean-title { font-weight: 700; font-size: 15px; color: #191f28; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .im-clean-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #8b95a1; }
    
    .im-badge { padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .im-badge.orig { background: #fff1f2; color: #e11d48; }
    .im-badge.resized { background: #eff6ff; color: #2563eb; }
    
    .im-clean-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .im-btn-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 1px solid #edf1f5; background: #fff; cursor: pointer; color: #4e5968; transition: all 0.2s; }
    .im-btn-icon:hover { background: #f9fafb; border-color: #cbd5e1; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 12px; padding: 0 4px;">
          <span id="sysVersion" style="font-size: 14px; color: #4b5563; font-weight: 800; background: #e5e7eb; padding: 6px 12px; border-radius: 20px; letter-spacing: 0.5px;"></span>
        </div>
        <div class="im-wrap">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 8px; padding: 0 10px;">
            <span id="sysVersion" style="font-size: 11px; color: #8b95a1; font-weight: 700;"></span>
          </div>
          
       <!--âœ… íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="im-tabs">
          <button class="im-tab on" data-tab="1" type="button">1. íŒŒì¼ ì„ íƒ</button>
          <button class="im-tab" data-tab="2" type="button">2. í¸ì§‘ ì„¤ì •</button>
          <button class="im-tab" data-tab="3" type="button">3. ë¯¸ë¦¬ë³´ê¸°/ì „ì†¡</button>
          <button class="im-tab" data-tab="4" type="button">4. ë³´ê´€í•¨</button>
        </div>

       <!--âœ… Step 1: íŒŒì¼ ì„ íƒ íŒ¨ë„ (ID ë° íŒŒì¼ ì„ íƒ) -->
        <div id="panel-1" class="im-panel on">
          <div class="im-card">
            <h1 class="im-title">1. ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</h1>
            <p class="im-help">ê°€ê³µí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ì €ì¥ ì˜µì…˜ì„ ì„¤ì •í•˜ì„¸ìš”.</p>
            <button type="button" class="im-smallbtn" onclick="resetAllSettings_()" style="color: #f04452; background: #fff0f0;">
              ğŸ”„ ì „ì²´ ì´ˆê¸°í™”
            </button>
            <div class="im-row">
              <div class="im-label">íŒŒì¼ëª…(ê¸°ë³¸)</div>
              <input id="baseName" class="im-input" type="text" placeholder="ì˜ˆ: ìˆ™ì¢…_í™˜êµ­ì •ì¹˜_ë„í‘œ" value="" />
              <span class="im-help">íŒŒì¼ëª… ê·œì¹™: (ê¸°ë³¸ëª…)__Vë‚ ì§œ__Q%__ID.jpg</span>
            </div>
        
            <div class="im-row" style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 20px;">
              <div class="im-label">ì´ë¯¸ì§€ íŒŒì¼</div>
              <input id="imgFile" class="im-input" type="file" accept="image/*" style="width: 100%;" />

              <div id="filePreviewContainer" style="display:none; margin-top:10px; text-align:center; background:#f9fafb; border-radius:16px; padding:20px; border:1px dashed #cbd5e1;">
                <p class="im-help" style="margin-bottom:10px;">ì„ íƒëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</p>
                <img id="filePreviewImg" src="" style="max-width:100%; max-height:300px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);" />
              </div>
              
              <div class="im-card" style="background: #f9fafb; border: 1px solid #e5e8eb;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px;">
                  <input id="saveOrigOn" type="checkbox" checked style="width: 22px; height: 22px; accent-color: #3182f6;" />
                  <span style="font-size: 15px; font-weight: 700; color: #191f28;">Google Driveì— ì›ë³¸ ë³„ë„ ì €ì¥</span>
                </label>
              
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px; border-top: 1px solid #eee;">
                  <input id="onlyOrigOn" type="checkbox" style="width: 22px; height: 22px; accent-color: #f04452;" />
                  <div>
                    <span style="font-size: 15px; font-weight: 700; color: #f04452;">ì›ë³¸ íŒŒì¼'ë§Œ' ì €ì¥</span>
                    <span class="im-help" style="display:block;">ì²´í¬ ì‹œ ë¦¬ì‚¬ì´ì§•/ì›Œí„°ë§ˆí¬ ëœ ê°€ê³µë³¸ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>
                  </div>
                </label>
              </div>
        
              <div class="im-action-row">
                <button type="button" class="im-btn im-btn-primary" onclick="moveTab(2)" style="flex: 1;">
                  ì´ë¯¸ì§€ ê°€ê³µ ì‹œì‘í•˜ê¸° â†’
                </button>
              </div>
            </div>
          </div>
        </div>

        <!--âœ… Step 2: í¸ì§‘ ì„¤ì • íŒ¨ë„ (ì›Œí„°ë§ˆí¬, í’ˆì§ˆ, ë¸”ëŸ¬) -->
        <div id="panel-2" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">2. ì´ë¯¸ì§€ ê°€ê³µ ì„¤ì •</h1>
            <p class="im-help">í’ˆì§ˆ, ë¸”ëŸ¬, ì›Œí„°ë§ˆí¬ ë° ë¬¸êµ¬ í‘œì‹œ ì„¤ì •ì„ ì¡°ì •í•˜ì„¸ìš”.</p>
        
            <div class="im-row">
              <div class="im-label">ì›Œí„°ë§ˆí¬ PNG</div>
              <input id="wmFile" class="im-input" type="file" accept="image/png" />
              <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input id="wmOn" type="checkbox" checked /> ì›Œí„°ë§ˆí¬ ì ìš©
              </label>
            </div>
        
            <div class="im-row">
              <div class="im-label">JPEG í’ˆì§ˆ</div>
              <input id="jpegQ" class="im-range" type="range" min="0.4" max="0.9" step="0.01" value="0.72" />
              <span id="jpegQVal" style="font-weight:900;">0.72</span>
              <span class="im-help">ë‚®ì„ìˆ˜ë¡ ìš©ëŸ‰â†“ / ê¸€ì ë­‰ê°œì§â†‘</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">ë¯¸ì„¸ ë¸”ëŸ¬(px)</div>
              <input id="blurPx" class="im-range" type="range" min="0" max="1.2" step="0.1" value="0.5" />
              <span id="blurPxVal" style="font-weight:900;">0.5</span>
              <span class="im-help">0.4~0.6ë¶€í„° ê¶Œì¥</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">ì›Œí„°ë§ˆí¬ íˆ¬ëª…ë„</div>
              <input id="wmAlpha" class="im-range" type="range" min="0.00" max="1.00" step="0.01" value="0.25" />
              <span id="wmAlphaVal" style="font-weight:900;">0.25</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">í‘œì‹œ ë¬¸êµ¬</div>
              <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                <textarea id="noteText" class="im-input" rows="3" placeholder="ì˜ˆ: Â© Cheesehistory.com&#10;{VER} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ {PCT}%{BLUR}">Â© Cheesehistory.com
        {VER} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ {PCT}%{BLUR}</textarea>
                <div id="notePreview" class="im-help" style="border:1px solid rgba(15,23,42,.12); border-radius:12px; padding:10px; white-space:pre-wrap; font-weight:900;"></div>
              </div>
            </div>
        
            <div class="im-row">
              <div class="im-label">ë¬¸êµ¬ ì„¸ë¶€ì„¤ì •</div>
              <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input id="noteOn" type="checkbox" checked /> í‘œì‹œ
              </label>
              <select id="notePos" class="im-input" style="max-width:140px;">
                <option value="tr" selected>ìš°ì¸¡ ìƒë‹¨</option>
                <option value="tl">ì¢Œì¸¡ ìƒë‹¨</option>
                <option value="br">ìš°ì¸¡ í•˜ë‹¨</option>
                <option value="bl">ì¢Œì¸¡ í•˜ë‹¨</option>
              </select>
            </div>
        
<div class="im-row">
              <div class="im-label">ê¸€ì í¬ê¸°</div>
              <input id="noteFont" class="im-range" type="range" min="10" max="48" step="1" value="18" />
              <span id="noteFontVal" style="font-weight:900;">18px</span>
            </div>

            <div class="im-row">
              <div class="im-label">ì´ë¯¸ì§€ í¬ê¸°</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <label class="im-chip on" onclick="selectScale(this, 1.0)">
                  <input type="radio" name="scaleOpt" value="1.0" checked hidden> ì›ë³¸(100%)
                </label>
                <label class="im-chip" onclick="selectScale(this, 0.6)">
                  <input type="radio" name="scaleOpt" value="0.6" hidden> 60%
                </label>
                <label class="im-chip" onclick="selectScale(this, 0.5)">
                  <input type="radio" name="scaleOpt" value="0.5" hidden> 50%
                </label>
                <label class="im-chip" onclick="selectScale(this, 0.4)">
                  <input type="radio" name="scaleOpt" value="0.4" hidden> 40%
                </label>
              </div>
            </div>

            <div style="margin-top:20px; border-top:1px dashed #cbd5e1; padding-top:20px;">
              <div class="im-row" style="justify-content: space-between; align-items:center;">
                <span class="im-label">ì„¤ì • ë¯¸ë¦¬ë³´ê¸°</span>
                <button type="button" onclick="previewCurrentSettings()" class="im-smallbtn" style="background:#fff; border:1px solid #cbd5e1;">
                  ğŸ‘€ í˜„ì¬ ì„¤ì •ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° í™•ì¸ (Test)
                </button>
              </div>
              
              <div id="step2PreviewBox" style="display:none; text-align:center; margin-top:12px; background:#e2e8f0; border-radius:12px; padding:12px;">
                 <img id="step2PreviewImg" style="max-width:100%; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1);" />
                 <p class="im-help">â–² í˜„ì¬ ì„¤ì •ì´ ì ìš©ëœ ì˜ˆì‹œì…ë‹ˆë‹¤. ë§ˆìŒì— ë“¤ë©´ ì•„ë˜ 'ì‘ì—… ì¶”ê°€'ë¥¼ ëˆ„ë¥´ì„¸ìš”.</p>
              </div>
            </div>

            <div class="im-row">
              <div class="im-label">íŒŒì¼ëª… íƒœê·¸</div>
              <input id="fileTag" class="im-input" type="text" placeholder="ì˜ˆ: (ë„¤ì´ë²„ìš©) ë˜ëŠ” _cover" style="flex:1;" />
              <span class="im-help">ì…ë ¥ ì‹œ íŒŒì¼ëª… ë’¤ì— ë¶™ìŠµë‹ˆë‹¤.</span>
            </div>
            
            <div style="margin-top:24px; padding:20px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:16px;">
              <h3 style="margin:0 0 8px; font-size:16px; color:#0369a1;">â• ì‘ì—… ëŒ€ê¸°ì—´ì— ì¶”ê°€</h3>
              <p class="im-help" style="margin-bottom:12px;">í˜„ì¬ ì„¤ì •(ì›Œí„°ë§ˆí¬, ë¸”ëŸ¬, í…ìŠ¤íŠ¸ ë“±)ì„ ì‘ì—… ëª©ë¡ì— ë‹´ìŠµë‹ˆë‹¤.</p>
              
              <div style="display:flex; gap:10px;">
                <button type="button" onclick="addCurrentJob()" class="im-btn primary" style="flex:1; padding:14px; font-size:14px;">
                  í˜„ì¬ í¬ê¸°ë¡œ 1ê°œ ì¶”ê°€
                </button>
                
                <button type="button" onclick="addBatchJobs()" class="im-btn" style="flex:1; background:#fff; border:2px solid #3182f6; color:#3182f6; padding:14px; font-size:14px;">
                  ğŸ“¦ 40/50/60% 3ì¢… ì¼ê´„ ì¶”ê°€
                </button>
              </div>
            </div>
            
            <div id="jobQueueArea" style="margin-top:24px; display:none;">
              <div class="im-label" style="margin-bottom:10px;">ìƒì„± ëŒ€ê¸° ì¤‘ì¸ ì‘ì—… (<span id="jobCount">0</span>ê°œ)</div>
              <div id="jobList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        
            <div class="im-action-row">
              <button type="button" class="im-btn im-btn-secondary" onclick="moveTab(1)">ì´ì „ìœ¼ë¡œ</button>
              <button type="button" id="btnGoStep3" class="im-btn im-btn-primary" onclick="moveTab(3)" disabled style="flex: 2;">
                ì‘ì—… ëª©ë¡ í™•ì • ë° ìƒì„±í•˜ê¸° â†’
              </button>
            </div>  
          </div>
        </div>

        <!--âœ… Step 3: ì—…ë¡œë“œ ë° í™•ì¸ íŒ¨ë„ (ë¯¸ë¦¬ë³´ê¸° ë° ì „ì†¡) -->
        <div id="panel-3" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">3. ìµœì¢… í™•ì¸ ë° ì—…ë¡œë“œ</h1>
            
            <div id="onlyOrigConfirmArea" style="display:none; background:#fff9fa; border:1px solid #fecdd3; border-radius:20px; padding:24px; margin-bottom:20px;">
              <div style="font-size:18px; font-weight:700; color:#f43f5e; margin-bottom:8px;">âš ï¸ ì›ë³¸ ì „ìš© ë°±ì—… ëª¨ë“œ</div>
              <p class="im-help" style="color:#e11d48; font-weight:600; margin-bottom:12px;">
                ë¦¬ì‚¬ì´ì§•ê³¼ ì›Œí„°ë§ˆí¬ê°€ ì ìš©ë˜ì§€ ì•Šì€ ìˆœìˆ˜ ì›ë³¸ íŒŒì¼ ê·¸ëŒ€ë¡œ Google Driveì— ì €ì¥í•©ë‹ˆë‹¤.
              </p>
              <div style="padding:14px; background:#fff; border-radius:12px; border:1px solid #fda4af;">
                <span id="origFileNameDisplay" style="font-family:monospace; font-weight:700; color:#191f28; word-break:break-all;"></span>
              </div>
            </div>
            
        
            <div class="im-row" style="margin-top:20px; gap:12px;">
              <p class="im-help">ê°€ê³µëœ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ê³  ì„œë²„(Google Drive/DB)ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.</p>
              <button id="btnMakePreviews" class="im-btn primary" type="button" style="flex:1;">
                40% / 50% / 60% ë¯¸ë¦¬ë³´ê¸° ìƒì„±
              </button>
              <button id="btnUploadSelected" class="im-btn primary" type="button" disabled style="flex:1; background-color: #3182f6;">
                ì„ íƒí•œ ë²„ì „ ì—…ë¡œë“œ(ì €ì¥)
              </button>
            </div>
        
            <div class="im-row" style="margin-top:20px;">
              <div class="im-label">ì—…ë¡œë“œ ëŒ€ìƒ</div>
              <div id="scalePick" class="im-chiprow"></div>
              <span class="im-help">ì¹©ì„ ëˆŒëŸ¬ ì „ì†¡í•  í’ˆì§ˆì„ ì„ íƒí•˜ì„¸ìš”.</span>
            </div>
        
            <div id="previewGrid" class="im-grid"></div>
        
            <div class="im-hr"></div>
        
            <div class="im-row" style="justify-content:space-between;">
              <div class="im-help">ì—…ë¡œë“œ ì„±ê³µ ì‹œ ìƒì„±ëœ HTML ìŠ¤ë‹ˆí«ì„ í™•ì¸í•˜ì„¸ìš”.</div>
              <button id="btnCopySnippet" class="im-smallbtn" type="button" disabled>ìŠ¤ë‹ˆí« ë³µì‚¬</button>
            </div>
            <div id="uploadResult" class="im-result" style="display:none;"></div>
        
            <div id="toast" class="im-toast" aria-live="polite"></div>
        
            <div class="im-action-row">
              <button type="button" class="im-btn im-btn-secondary" onclick="moveTab(2)">ë‹¤ì‹œ í¸ì§‘</button>
              <button type="button" class="im-btn im-btn-primary" onclick="moveTab(4)" style="background-color: #191f28;">
                ì´ë¯¸ì§€ ë³´ê´€í•¨ ì´ë™ â†’
              </button>
            </div>  
        
            <iframe id="uploadFrame" name="uploadFrame" class="im-hidden"></iframe>
            <form id="uploadForm" class="im-hidden" method="POST" target="uploadFrame"
                  action="https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec">
              <input type="hidden" name="__form" value="1" />
              <input type="hidden" name="payload" id="formPayload" value="" />
            </form>
          </div>
        </div>

        <!--âœ… Step 4: ë³´ê´€í•¨ íŒ¨ë„ (ê¸°ì¡´ ëª©ë¡) -->
        <div id="panel-4" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">4. ì´ë¯¸ì§€ ë³´ê´€í•¨</h1>
            
            <div class="im-row" style="justify-content:space-between; align-items: center; margin-bottom: 16px;">
              <div class="im-subtabs">
                <button type="button" class="im-subtab on" onclick="filterList('all')">ì „ì²´</button>
                <button type="button" class="im-subtab" onclick="filterList('resized')">ê°€ê³µë³¸ (Resized)</button>
                <button type="button" class="im-subtab" onclick="filterList('orig')">ì›ë³¸ (Original)</button>
              </div>
        
              <button id="btnReloadList" class="im-smallbtn" type="button" style="height: 36px;">
                ğŸ”„ ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
        
            <div class="im-row">
              <input id="listFilter" class="im-input" type="text" placeholder="íŒŒì¼ëª… ë˜ëŠ” ID ê²€ìƒ‰..." style="flex:1;" />
              <span id="listCount" class="im-status ok">0ê°œ</span>
            </div>
        
            <div id="listArea" style="margin-top: 16px; min-height: 300px;">
              </div>
        
            <div style="text-align: left; margin-top: 24px;">
              <button type="button" class="im-btn im-btn-secondary" onclick="moveTab(3)" style="width: auto;">
                â† ì´ì „ (ì—…ë¡œë“œ)
              </button>
            </div>
          </div>
        </div>

        </div>
      </main>
    </div>
  </div>
  
  <!-- âœ… ê²½ê³  ëª¨ë‹¬ -->
  <div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:20px; padding:30px; width:90%; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center; animation: slideUp 0.3s ease-out;">
      <div id="modalIcon" style="font-size:40px; margin-bottom:16px;">âš ï¸</div>
      <div id="modalMsg" style="font-size:16px; font-weight:700; color:#191f28; line-height:1.5; margin-bottom:24px; white-space:pre-wrap;">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
      <button type="button" onclick="closeModal_()" class="im-btn primary" style="width:100%; padding:14px;">í™•ì¸</button>
    </div>
  </div>
  <!-- âœ… ì‚­ì œê²½ê³  ëª¨ë‹¬ -->
  <div id="confirmOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(2px);">
  <div style="background:#fff; border-radius:24px; padding:32px; width:90%; max-width:380px; box-shadow:0 20px 50px rgba(0,0,0,0.2); text-align:center; animation: slideUp 0.2s ease-out;">
    <div style="font-size:48px; margin-bottom:16px;">ğŸ—‘ï¸</div>
    <div style="font-size:20px; font-weight:800; color:#e11d48; margin-bottom:8px;">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <p style="color:#4b5563; font-size:15px; line-height:1.5; margin-bottom:24px;">
      Drive íŒŒì¼ê³¼ ëª©ë¡ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </p>
    <div style="display:flex; gap:12px;">
      <button type="button" onclick="closeConfirm_()" style="flex:1; padding:14px; border-radius:14px; border:none; background:#f3f4f6; color:#4b5563; font-weight:700; cursor:pointer;">ì·¨ì†Œ</button>
      <button type="button" id="btnRealDelete" style="flex:1; padding:14px; border-radius:14px; border:none; background:#e11d48; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(225,29,72,0.3);">ë„¤, ì‚­ì œí•©ë‹ˆë‹¤</button>
    </div>
  </div>
</div>

  
  <!-- âœ… ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ëŠ” ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ -->
  <script src="./admin-common.js"></script>

<script>
  (() => {
    // âœ… Apps Script ë°°í¬ URL
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec";

    // ====== DOM Elements ======
    const $baseName = document.getElementById("baseName");    
    const $file   = document.getElementById("imgFile");
    const $wmFile = document.getElementById("wmFile");
    const $wmOn   = document.getElementById("wmOn");

    const $jpegQ = document.getElementById("jpegQ");
    const $jpegQVal = document.getElementById("jpegQVal");
    const $blurPx = document.getElementById("blurPx");
    const $blurPxVal = document.getElementById("blurPxVal");

    const $wmAlpha = document.getElementById("wmAlpha");
    const $wmAlphaVal = document.getElementById("wmAlphaVal");

    const $noteText = document.getElementById("noteText");
    const $noteOn = document.getElementById("noteOn");
    const $notePos = document.getElementById("notePos");
    const $noteFont = document.getElementById("noteFont");
    const $notePreview = document.getElementById("notePreview");
    
    const $noteFontVal = document.getElementById("noteFontVal");

    const $btnMake = document.getElementById("btnMakePreviews");
    const $btnUpload = document.getElementById("btnUploadSelected");
    const $grid = document.getElementById("previewGrid");
    const $scalePick = document.getElementById("scalePick");

    const $result = document.getElementById("uploadResult");
    const $btnCopy = document.getElementById("btnCopySnippet");
    const $toast  = document.getElementById("toast");

    // list UI
    const $btnReloadList = document.getElementById("btnReloadList");
    const $listFilter = document.getElementById("listFilter");
    const $listArea = document.getElementById("listArea");
    const $listCount = document.getElementById("listCount");

    // ====== UI ì´ˆê¸° ì„¤ì • ë° ì´ë²¤íŠ¸ ì—°ê²° ======
    $jpegQ.addEventListener("input", () => $jpegQVal.textContent = Number($jpegQ.value).toFixed(2));
    $blurPx.addEventListener("input", () => $blurPxVal.textContent = Number($blurPx.value).toFixed(1));
    $wmAlpha.addEventListener("input", () => $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2));
    $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2);

    $noteFont.addEventListener("input", () => $noteFontVal.textContent = `${Number($noteFont.value)}px`);

    function refreshNotePreview_(){
      if (!$notePreview) return;
      const t = ($noteText.value || "").replace(/\r\n/g, "\n");
      $notePreview.textContent = t;
    }
    $noteText.addEventListener("input", refreshNotePreview_);
    refreshNotePreview_();
    $noteFontVal.textContent = `${Number($noteFont.value)}px`;

    // ====== ìƒíƒœ ë³€ìˆ˜ ======
    // [ë³µêµ¬] ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    const SCALES = [0.4, 0.5, 0.6]; 
    const previews = new Map();

    let sourceImg = null;
    let watermarkImg = null;

    // [ë³€ê²½] ë‹¤ì¤‘ ì‘ì—…ì„ ìœ„í•œ í ë° ê²°ê³¼ ë°°ì—´
    let jobQueue = []; 
    let jobResults = []; 
    let selectedScale = null; // í˜¸í™˜ì„± ìœ ì§€ìš© (Make Cardì—ì„œ ì°¸ì¡°)
    
    let lastSnippetText = "";
    let currentListNonce = "";
    let lastListItems = [];

    // ====== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ======
    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      })[m]);
    }

    // [ìˆ˜ì •] ëª¨ë“  Blob URL í•´ì œ (previews + jobResults)
    function revokeAllPreviewUrls() {
      // 1. ê¸°ì¡´ ë°©ì‹ Map ì •ë¦¬
      if (previews) {
        for (const v of previews.values()) {
          if (v.url) URL.revokeObjectURL(v.url);
        }
        previews.clear();
      }
      
      // 2. ìƒˆë¡œìš´ ë°©ì‹ Array ì •ë¦¬
      if (jobResults) {
        jobResults.forEach(res => {
          if (res.url) URL.revokeObjectURL(res.url);
        });
        jobResults = [];
      }
    }

    function resetUploadResult() {
      lastSnippetText = "";
      $btnCopy.disabled = true;
      $result.style.display = "none";
      $result.textContent = "";
    }

    function loadFileAsImage(file) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("image load fail")); };
        img.src = url;
      });
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function yyyymmdd() {
      const d = new Date();
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    }
    function versionToday() { return `V${yyyymmdd()}`; }

    // ====== ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ê´€ë ¨ ======
    function ellipsisToFit(ctx, text, maxW) {
      if (ctx.measureText(text).width <= maxW) return text;
      const E = "â€¦";
      let lo = 0, hi = text.length;
      while (lo < hi) {
        const mid = Math.floor((lo + hi) / 2);
        const t = text.slice(0, mid) + E;
        if (ctx.measureText(t).width <= maxW) lo = mid + 1;
        else hi = mid;
      }
      return text.slice(0, Math.max(0, lo - 1)) + E;
    }
    
    function drawCornerTextNoBg(ctx, tw, th, lines, fontSizePx, pos) {
      const pad = Math.max(10, Math.round(tw * 0.015));
      const lineGap = Math.max(3, Math.round(fontSizePx * 0.25));
    
      ctx.save();
      ctx.font = `900 ${fontSizePx}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = "top";
      ctx.fillStyle = "#000";
      ctx.globalAlpha = 1;
    
      const maxW = tw - pad * 2;
      const fitted = lines.map(t => ellipsisToFit(ctx, t, maxW));
    
      const lineH = Math.ceil(fontSizePx * 1.15);
      const totalH = fitted.length * lineH + (fitted.length - 1) * lineGap;
    
      const p = (pos || "tr");
      const isTop = p.includes("t");
      const isLeft = p.includes("l");
    
      let y = isTop ? pad : Math.max(pad, th - pad - totalH);
    
      for (const t of fitted) {
        const w = ctx.measureText(t).width;
        const x = isLeft ? pad : Math.max(pad, tw - pad - w);
        ctx.fillText(t, x, y);
        y += lineH + lineGap;
      }
      ctx.restore();
    }

    // [í•µì‹¬] ë Œë”ë§ í•¨ìˆ˜ (config ê°ì²´ ê¸°ë°˜)
    async function renderPreviewBlob(config) {
      if (!sourceImg) throw new Error("source image not loaded");

      const blur = config.blurPx;
      const q = config.jpegQ;
      const scale = config.scale || 1.0;

      const sw = sourceImg.naturalWidth;
      const sh = sourceImg.naturalHeight;

      const tw = Math.max(1, Math.round(sw * scale));
      const th = Math.max(1, Math.round(sh * scale));

      const canvas = document.createElement("canvas");
      canvas.width = tw;
      canvas.height = th;

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      // 1. ë¸”ëŸ¬
      ctx.filter = blur > 0 ? `blur(${blur}px)` : "none";
      ctx.drawImage(sourceImg, 0, 0, tw, th);
      ctx.filter = "none";

      // 2. ì›Œí„°ë§ˆí¬
      if (config.useWm && config.wmImg) {
        ctx.globalAlpha = Number.isFinite(config.wmAlpha) ? config.wmAlpha : 0.25;
        const iw = config.wmImg.naturalWidth;
        const ih = config.wmImg.naturalHeight;
        
        // ê¸°ì¡´: ì¤‘ì•™ ì •ë ¬ (ì›ë³¸ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì°¨ê²Œ í˜¹ì€ ì ì ˆíˆ)
        const s = Math.max(tw / iw, th / ih);
        const dw = iw * s;
        const dh = ih * s;
        const dx = (tw - dw) / 2;
        const dy = (th - dh) / 2;

        ctx.drawImage(config.wmImg, dx, dy, dw, dh);
        ctx.globalAlpha = 1;
      }

      // 3. í…ìŠ¤íŠ¸
      if (config.noteOn) {
        const ver = versionToday();
        const blurToken = blur > 0 ? ` Â· ë¯¸ì„¸ë¸”ëŸ¬ ${blur.toFixed(1)}px` : "";
        let raw = (config.noteText || "").trim();
        if (!raw) raw = "Â© Cheesehistory.com";
        if (!/\{PCT\}|\bì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ\b/.test(raw)) raw += `\n{VER} Â· í’ˆì§ˆ {PCT}%{BLUR}`; 

        raw = raw
          .replace(/\{VER\}/g, ver)
          .replace(/\{PCT\}/g, String(Math.round(scale * 100)))
          .replace(/\{BLUR\}/g, blurToken);
        
        const lines = raw.split("\n").map(s => s.trim()).filter(s => s.length > 0);
        drawCornerTextNoBg(ctx, tw, th, lines, config.noteFont, config.notePos);
      }

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), "image/jpeg", q);
      });
      
      if (!blob) throw new Error("toBlob failed");
      return { blob, w: tw, h: th, bytes: blob.size, config: config };
    }

    function makePreviewCard({ scale, url, w, h, bytes }, index) {
      const pct = Math.round(scale * 100);
      const sizeKB = Math.round(bytes / 1024);

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px;">
          Job #${index+1} Â· ${w}Ã—${h} Â· ${sizeKB}KB
          <span class="im-clickhint">(í´ë¦­:í™•ëŒ€)</span>
        </div>
        <div class="cheese-img-wrapper" data-scale="${scale}">
          <div class="cheese-img-inner">
            <a class="im-preview-link" href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="">
            </a>
          </div>
        </div>
      `;
      // ë‹¤ì¤‘ ëª¨ë“œì—ì„œëŠ” ê°œë³„ ì„ íƒ ë¡œì§ë³´ë‹¤ëŠ” ì¼ê´„ ì—…ë¡œë“œë¥¼ ìœ ë„
      return wrap;
    }

    // ì¹© ë Œë”ë§ (ë‹¤ì¤‘ ëª¨ë“œì—ì„œëŠ” ì˜ ì•ˆ ì“°ì´ì§€ë§Œ ì—ëŸ¬ ë°©ì§€ìš©)
    function renderScaleChips() {
      $scalePick.innerHTML = ""; 
    }
    
    function highlightSelected() {
      // ë‹¤ì¤‘ ëª¨ë“œì—ì„œëŠ” ê¸°ëŠ¥ ìƒëµ
    }

    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result;
          const b64 = String(dataUrl).split(",")[1] || "";
          resolve(b64);
        };
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    function safeTrim(s){ return (s == null ? "" : String(s)).trim(); }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (e2) {
          return false;
        }
      }
    }

    function makeNonce_() {
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    // ====== ë¡œë”© & í† ìŠ¤íŠ¸ ======
    let toastTimer = null;
    window.setBusy_ = function(isBusy, msg = "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...") {
      const mask = document.getElementById("globalMask");
      const txt = document.getElementById("globalMaskText");
      if (!mask) return;
      if (isBusy) {
        if (txt) txt.textContent = msg;
        mask.style.display = "flex";
      } else {
        mask.style.display = "none";
      }
    };
    
    function toast_(msg, type = "sub") {
      if (!$toast) return;
      $toast.textContent = String(msg || "");
      $toast.classList.remove("ok","bad","sub","show");
      $toast.classList.add(type);
      void $toast.offsetWidth;
      $toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { $toast.classList.remove("show"); }, 2600);
    }

    function showUploadResult_(json) {
      lastSnippetText = json.snippet || "";
      $btnCopy.disabled = !lastSnippetText;
      $result.style.display = "block";
      $result.textContent =
        `ì—…ë¡œë“œ ì™„ë£Œ!\nDB ID: ${json.id}\nHTML ìŠ¤ë‹ˆí«:\n${lastSnippetText}`;
    }

    // ====== ëª©ë¡ ë Œë”ë§ (ìƒëµ ì—†ì´ í¬í•¨) ======
    let currentFilterType = 'all';
    window.filterList = function(type) {
      currentFilterType = type;
      document.querySelectorAll('.im-subtab').forEach(btn => {
        btn.classList.toggle('on', btn.textContent.includes(type === 'all' ? 'ì „ì²´' : (type === 'orig' ? 'ì›ë³¸' : 'ê°€ê³µ')));
      });
      renderList(lastListItems);
    };

// [ìˆ˜ì •] ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (ì›ë³¸/ë¦¬ì‚¬ì´ì§• ëª…í™•íˆ êµ¬ë¶„)
    function renderList(items){
      const q = String($listFilter.value || "").trim().toLowerCase();
      const filtered = (items || []).filter(it => {
        const searchMatch = !q || String(it.id||"").toLowerCase().includes(q) || String(it.base_name||"").toLowerCase().includes(q);
        if (!searchMatch) return false;
        
        // âœ… [íŒë³„ ê¸°ì¤€ ë³€ê²½] 100%ë¼ê³  ì›ë³¸ ì•„ë‹˜. íŒŒì¼ëª…ì— "_ORIG"ê°€ ìˆì–´ì•¼ ì§„ì§œ ì›ë³¸.
        const isTrueOrig = String(it.base_name).includes("_ORIG") || it.scale_pct === "ORIG";
        
        const hasBackup = !!it.orig_drive_view_url;
        if (currentFilterType === 'orig') return isTrueOrig || hasBackup;
        if (currentFilterType === 'resized') return !isTrueOrig;
        return true;
      });

      $listCount.textContent = `${filtered.length}ê°œ`;
      $listArea.innerHTML = "";
      if (filtered.length === 0) {
        $listArea.innerHTML = `<div style="text-align:center; padding:60px 0; color:#adb5bd;">ì¡°ê±´ì— ë§ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      for (const it of filtered) {
        // âœ… íŒŒì¼ëª…ì— _ORIG ê°€ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ë§Œ ë¹¨ê°„ ë°°ì§€(ì›ë³¸) ì ìš©
        const isTrueOrig = String(it.base_name).includes("_ORIG") || it.scale_pct === "ORIG";
        const showAsOrig = (currentFilterType === 'orig') || isTrueOrig;
        
        const title = (showAsOrig && !isTrueOrig && it.orig_drive_name) 
          ? it.orig_drive_name 
          : (it.base_name || it.id);

        // âœ… [ë§í¬ ìˆ˜ì •] ì—‰ëš±í•œ ë°±ì—… ê²½ë¡œê°€ ì•„ë‹ˆë¼, í˜„ì¬ í–‰ì˜ íŒŒì¼ ê²½ë¡œë¥¼ ì—½ë‹ˆë‹¤.
        // ë…ë¦½ ì—…ë¡œë“œ ë°©ì‹ì´ë¯€ë¡œ ë³¸ì¸ íŒŒì¼ ë§í¬(drive_view_url)ê°€ ë§ìŠµë‹ˆë‹¤.
        const driveLink = it.drive_view_url || "#";
        const thumbSrc = it.img_src || "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png";

        const card = document.createElement("div");
        card.className = "im-clean-item";
        
        // ë°°ì§€ HTML
        let badgeHtml = "";
        if (isTrueOrig) {
           // ì§„ì§œ ì›ë³¸ì¸ ê²½ìš°
           badgeHtml = `<span class="im-badge orig">ORIGINAL</span>`;
        } else {
           // 100%ì—¬ë„ ì›ë³¸ì´ ì•„ë‹ˆë©´ íŒŒë€ìƒ‰ ë°°ì§€
           badgeHtml = `<span class="im-badge resized">${it.scale_pct}%</span>`;
        }

        card.innerHTML = `
          <img class="im-clean-thumb" src="${thumbSrc}" onerror="this.src='https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png'">
          <div class="im-clean-info">
            <div class="im-clean-title">${escapeHtml(title)}</div>
            <div class="im-clean-meta">${badgeHtml} <span>${it.id}</span></div>
          </div>
          <div class="im-clean-actions">
            <a href="${driveLink}" target="_blank" class="im-btn-icon">ğŸ“‚</a>
            <button type="button" class="im-btn-icon btnCopy">ğŸ“‹</button>
            <button type="button" class="im-btn-icon btnDel" style="color:#e11d48; border-color:#fecdd3; background:#fff1f2;">ğŸ—‘ï¸</button>
          </div>
        `;
        
        card.querySelector(".btnCopy").addEventListener("click", async () => {
           const got = await loadOne(it.id);
           if(got?.snippet) { await copyToClipboard(got.snippet); alert("ë³µì‚¬ ì™„ë£Œ!"); }
        });
        card.querySelector(".btnDel").addEventListener("click", () => openConfirmDelete(it.id));
        $listArea.appendChild(card);
      }
    }

    $listFilter.addEventListener("input", () => renderList(lastListItems));
    $btnReloadList.addEventListener("click", () => loadList());

    function jsonpCall_(url, cbName){
      return new Promise((resolve) => {
        window[cbName] = (data) => { resolve(data); };
        const script = document.createElement("script");
        script.src = url;
        script.onerror = () => resolve({ok:false});
        document.head.appendChild(script);
      });
    }

    window.loadList = async function(){      
      currentListNonce = makeNonce_();
      const cb = `__im_list_cb_${currentListNonce}`;
      const url = `${WEBAPP_URL}?mode=list&callback=${cb}&nonce=${currentListNonce}`;
      toast_("ëª©ë¡ ë¡œë“œ ì¤‘...", "sub");
      const data = await jsonpCall_(url, cb);
      if (data && data.ok) {
        lastListItems = data.items || [];
        renderList(lastListItems);
        toast_("ë¡œë”© ì™„ë£Œ", "ok");
      }
    }

    function loadOne(id){
      const nonce = makeNonce_();
      const cb = `__im_get_cb_${nonce}`;
      const url = `${WEBAPP_URL}?mode=get&id=${id}&callback=${cb}&nonce=${nonce}`;
      return jsonpCall_(url, cb).then(d => d.ok ? d.item : null);
    }

    // ====== API POST ======
    window.apiPost = async function(bodyObj) {
      const res = await fetch(`${WEBAPP_URL}?_ts=${Date.now()}`, {
        method: "POST", body: JSON.stringify(bodyObj)
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      return data;
    }

    // ====== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (íŒŒì¼ ì„ íƒ) ======
    $file.addEventListener("change", async () => {
      try { revokeAllPreviewUrls(); } catch(e) { console.warn(e); }
      
      $grid.innerHTML = "";
      $scalePick.innerHTML = "";
      resetUploadResult();
      
      const f = $file.files?.[0];
      
      // âœ… [ì¶”ê°€ë¨] íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª…ì„ ì…ë ¥ì°½ì— ìë™ ì…ë ¥ (í™•ì¥ì ì œê±°)
      if (f) {
        const nameWithoutExt = f.name.substring(0, f.name.lastIndexOf('.')) || f.name;
        // ì´ë¯¸ ì…ë ¥ëœ ê°’ì´ ì—†ì„ ë•Œë§Œ ìë™ ì…ë ¥
        if (!$baseName.value.trim()) {
          $baseName.value = nameWithoutExt;
        }
      }

      const $previewContainer = document.getElementById("filePreviewContainer");
      const $previewImg = document.getElementById("filePreviewImg");

      if (!f) {
        if ($previewContainer) $previewContainer.style.display = "none";
        return;
      }
      
      try {
        sourceImg = await loadFileAsImage(f);
        if ($previewContainer && $previewImg) {
          $previewImg.src = URL.createObjectURL(f);
          $previewContainer.style.display = "block";
          $previewImg.onload = () => URL.revokeObjectURL($previewImg.src);
        }
      } catch (e) {
        sourceImg = null;
        alert("ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨");
      }
    });

    $wmFile.addEventListener("change", async () => {
      const f = $wmFile.files?.[0];
      watermarkImg = f ? await loadFileAsImage(f) : null;
    });

    // ====== [í•µì‹¬] ì¼ê´„ ìƒì„± ë²„íŠ¼ (Step 3) ======
    $btnMake.addEventListener("click", async () => {
      if (jobQueue.length === 0) { alert("ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
      
      $grid.innerHTML = "";
      revokeAllPreviewUrls(); // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”
      jobResults = [];
      resetUploadResult();

      try {
        setBusy_(true, `ì´ ${jobQueue.length}ì¥ ìƒì„± ì¤‘...`);
        await new Promise(r => setTimeout(r, 50)); 

        for (let i = 0; i < jobQueue.length; i++) {
          const config = jobQueue[i];
          const r = await renderPreviewBlob(config); 
          const url = URL.createObjectURL(r.blob);
          
          jobResults.push({ ...r, url, index: i });
          
          const card = makePreviewCard(r, i); // ì¹´ë“œ ìƒì„±
          $grid.appendChild(card);
        }

        $btnUpload.disabled = false;
        $btnUpload.textContent = `ìƒì„±ëœ ${jobQueue.length}ê°œ ì´ë¯¸ì§€ ì¼ê´„ ì—…ë¡œë“œ`;
      } catch (e) {
        console.error(e);
        alert("ìƒì„± ì‹¤íŒ¨: " + e.message);
      } finally {
        setBusy_(false);
      }
    });

// ====== [í•µì‹¬] ì¼ê´„ ì—…ë¡œë“œ ë²„íŠ¼ (ì›ë³¸ ê²½ë¡œ ì¤€ìˆ˜ & ë¦¬ì‚¬ì´ì§• êµ¬ë¶„) ======
    $btnUpload.addEventListener("click", async () => {
      const origFile = $file.files?.[0];
      if (!origFile) { window.showAlert_("íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }

      // 1. ê¸°ë³¸ íŒŒì¼ëª… ì •ë¦¬
      const userBaseName = safeTrim($baseName.value);
      const origNameOnly = origFile.name.substring(0, origFile.name.lastIndexOf('.')) || origFile.name;
      const finalBaseName = userBaseName || origNameOnly;

      const isOnlyOrig = document.getElementById("onlyOrigOn")?.checked || false;
      const shouldSaveOrig = document.getElementById("saveOrigOn")?.checked || false;
      const version = versionToday();
      
      const origW = sourceImg?.naturalWidth || 0;
      const origH = sourceImg?.naturalHeight || 0;

      $btnUpload.disabled = true;
      let successLogs = [];

      try {
        // ------------------------------------------------------------
        // [1] ì§„ì§œ ì›ë³¸ íŒŒì¼ ì €ì¥ (ì„œë²„ì˜ ë³„ë„ URL ê²½ë¡œì— ì €ì¥)
        // ------------------------------------------------------------
        if (isOnlyOrig || shouldSaveOrig) {
          window.setBusy_(true, "ì›ë³¸ íŒŒì¼ ë°±ì—… ì¤‘...");
          const b64 = await blobToBase64(origFile);
          
          const payload = {
            mode: "upload",
            mime: origFile.type,
            base64: b64, 
            save_orig: true, // ì„œë²„ ì›ë³¸ í´ë” ì €ì¥ íŠ¸ë¦¬ê±°
            only_orig: true, // ë¦¬ì‚¬ì´ì§• ì²˜ë¦¬ ê±´ë„ˆë›°ê¸°
            orig_base64: b64, 
            orig_mime: origFile.type,
            
            meta: {
              // âœ… [í•µì‹¬] ì›ë³¸ì„ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ ì´ë¦„ ëì— _ORIG ì¶”ê°€
              base_name: finalBaseName + "_ORIG", 
              version: version,
              scale: 1.0, 
              scale_pct: 100, // #NUM! ë°©ì§€ìš© ìˆ«ì
              orig_w: origW, orig_h: origH, bytes: origFile.size
            }
          };

          const res = await window.apiPost(payload);
          // only_orig=trueì¼ ë•Œ ì„œë²„ëŠ” orig_drive_url ë“±ì„ ë°˜í™˜í•¨
          const savedName = res.orig_drive_name || res.drive_name || "Original";
          successLogs.push(`\n${res.snippet || ""}`);
          
          // 'ì›ë³¸ë§Œ ì €ì¥' ëª¨ë“œë©´ ì—¬ê¸°ì„œ ë
          if (isOnlyOrig) {
            finishUpload(successLogs);
            return;
          }
        }

        // ------------------------------------------------------------
        // [2] ë¦¬ì‚¬ì´ì§•/ê°€ê³µ ì´ë¯¸ì§€ ì €ì¥ (100% í¬í•¨)
        // ------------------------------------------------------------
        if (jobResults.length === 0) {
           if(shouldSaveOrig) { finishUpload(successLogs); return; }
           throw new Error("ì—…ë¡œë“œí•  ì‘ì—… ê²°ê³¼ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        if (!confirm(`ì´ ${jobResults.length}ê°œì˜ ê°€ê³µ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          $btnUpload.disabled = false; window.setBusy_(false); return;
        }

        for (let i = 0; i < jobResults.length; i++) {
          window.setBusy_(true, `ê°€ê³µë³¸ ì—…ë¡œë“œ ì¤‘ (${i+1}/${jobResults.length})...`);
          
          const res = jobResults[i];
          const cfg = res.config;
          const b64 = await blobToBase64(res.blob);
          const pct = Math.round(cfg.scale * 100);

          // âœ… ë¦¬ì‚¬ì´ì§• íŒŒì¼ëª… ìƒì„± (ê´„í˜¸, blur ì œê±°)
          let nameForJob = finalBaseName;
          
          // íƒœê·¸ê°€ ìˆìœ¼ë©´ ê¹”ë”í•˜ê²Œ '_íƒœê·¸' ë¶™ì´ê¸°
          if (cfg.userTag) {
             nameForJob += `_${cfg.userTag}`; 
          }
          
          // 100% ë¦¬ì‚¬ì´ì§•ì¸ ê²½ìš° ì›ë³¸ê³¼ ì´ë¦„ ê²¹ì¹˜ì§€ ì•Šê²Œ (ì„ íƒì‚¬í•­)
          // ì›ë³¸ì€ _ORIGê°€ ë¶™ìœ¼ë¯€ë¡œ ê²¹ì¹˜ì§€ ì•ŠìŒ. ê·¸ëŒ€ë¡œ ì§„í–‰.

          const payload = {
            mode: "upload",
            mime: "image/jpeg",
            base64: b64,
            save_orig: false, // ì—¬ê¸°ì„œëŠ” ì›ë³¸ ì €ì¥ ì•ˆ í•¨
            orig_base64: "",
            
            meta: {
              base_name: nameForJob,
              label: (cfg.noteText||"").split("\n")[0],
              version: version,
              scale: cfg.scale, 
              scale_pct: pct,
              blur_px: cfg.blurPx, 
              wm_alpha: cfg.wmAlpha,
              orig_w: origW, orig_h: origH, out_w: res.w, out_h: res.h,
              bytes: res.bytes
            }
          };
          
          const serverRes = await window.apiPost(payload);
          const fName = serverRes.drive_name || `Job #${i+1}`;
          if (serverRes.snippet) {
            successLogs.push(`\n${serverRes.snippet}`);
          }
        }
        
        finishUpload(successLogs);

      } catch(e) {
        console.error(e);
        window.showAlert_("ì‹¤íŒ¨: " + e.message, "âŒ");
        $btnUpload.disabled = false;
      } finally {
        window.setBusy_(false);
      }
    });
    
    function finishUpload(logs) {
      resetUploadResult();
      const combined = logs.join("\n\n");
      $result.style.display = "block";
      $result.textContent = `âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ!\n\n${combined}`;
      lastSnippetText = combined;
      $btnCopy.disabled = false;
      window.showAlert_("ëª¨ë“  íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "ğŸ‰");
      if(window.loadList) window.loadList();
      $btnUpload.disabled = false;
    }
    $btnCopy.addEventListener("click", async () => {
      if (!lastSnippetText) return;
      await copyToClipboard(lastSnippetText);
      alert("ë³µì‚¬ë¨");
    });

    window.addEventListener("beforeunload", revokeAllPreviewUrls);

    // âœ… [ì¶”ê°€] í˜„ì¬ ì„¤ì • íì— ë‹´ê¸° (ì˜¬ë°”ë¥¸ ìœ„ì¹˜)
 window.addCurrentJob = function() {
      if (!sourceImg) { alert("ì›ë³¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const useWm = document.getElementById("wmOn").checked;
      if (useWm && !watermarkImg) { alert("ì›Œí„°ë§ˆí¬ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

      const scaleInput = document.querySelector('input[name="scaleOpt"]:checked');
      const currentScale = scaleInput ? Number(scaleInput.value) : 1.0;
      
      // âœ… [ì¶”ê°€] ì‚¬ìš©ì ì…ë ¥ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
      const userTag = document.getElementById("fileTag").value.trim();

      const job = {
        id: Date.now(),
        wmImg: watermarkImg, 
        useWm: useWm,
        jpegQ: Number(document.getElementById("jpegQ").value),
        blurPx: Number(document.getElementById("blurPx").value),
        wmAlpha: Number(document.getElementById("wmAlpha").value),
        noteText: document.getElementById("noteText").value,
        noteOn: document.getElementById("noteOn").checked,
        notePos: document.getElementById("notePos").value,
        noteFont: Number(document.getElementById("noteFont").value),
        
        scale: currentScale,
        userTag: userTag // âœ… ì €ì¥
      };

      jobQueue.push(job);
      renderJobQueueUI();
      
      const tagMsg = userTag ? ` (íƒœê·¸: ${userTag})` : "";
      toast_(`ì‘ì—… ì¶”ê°€ë¨${tagMsg}`, "ok");
    };
   
    // [ìˆ˜ì •] Step 2 ì„¤ì • ë¯¸ë¦¬ë³´ê¸° (ì„ íƒëœ í¬ê¸° ë°˜ì˜)
    window.previewCurrentSettings = async function() {
      if (!sourceImg) { alert("ì›ë³¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      
      const useWm = document.getElementById("wmOn").checked;
      if (useWm && !watermarkImg) { alert("ì›Œí„°ë§ˆí¬ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

      // âœ… [ì¶”ê°€] ì„ íƒëœ í¬ê¸°ê°’ ê°€ì ¸ì˜¤ê¸°
      const scaleInput = document.querySelector('input[name="scaleOpt"]:checked');
      const currentScale = scaleInput ? Number(scaleInput.value) : 1.0;

      const tempConfig = {
        wmImg: watermarkImg, 
        useWm: useWm,
        jpegQ: Number(document.getElementById("jpegQ").value),
        blurPx: Number(document.getElementById("blurPx").value),
        wmAlpha: Number(document.getElementById("wmAlpha").value),
        noteText: document.getElementById("noteText").value,
        noteOn: document.getElementById("noteOn").checked,
        notePos: document.getElementById("notePos").value,
        noteFont: Number(document.getElementById("noteFont").value),
        
        scale: currentScale  // âœ… 1.0 ê³ ì • ëŒ€ì‹  ì„ íƒëœ ê°’ ì‚¬ìš©
      };

      try {
        window.setBusy_(true, "ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘...");
        const result = await renderPreviewBlob(tempConfig);
        
        const url = URL.createObjectURL(result.blob);
        const img = document.getElementById("step2PreviewImg");
        const box = document.getElementById("step2PreviewBox");
        
        if (img && box) {
           if (img.src && img.src.startsWith("blob:")) URL.revokeObjectURL(img.src);
           img.src = url;
           box.style.display = "block";
           
           // ì•ˆë‚´ ë¬¸êµ¬ ì—…ë°ì´íŠ¸
           box.querySelector('.im-help').textContent = 
             `â–² ${Math.round(currentScale * 100)}% í¬ê¸°ê°€ ì ìš©ëœ ì˜ˆì‹œì…ë‹ˆë‹¤.`;
        }
      } catch (e) {
        alert("ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: " + e.message);
      } finally {
        window.setBusy_(false);
      }
    };
    
    // âœ… [ì¶”ê°€] ì‘ì—… ëª©ë¡ ê·¸ë¦¬ê¸°
    function renderJobQueueUI() {
      const area = document.getElementById("jobQueueArea");
      const list = document.getElementById("jobList");
      const cnt = document.getElementById("jobCount");
      const btnGo = document.getElementById("btnGoStep3");

      if (jobQueue.length > 0) {
        area.style.display = "block";
        btnGo.disabled = false;
        btnGo.textContent = `ì´ ${jobQueue.length}ê°œ ì‘ì—… í™•ì • ë° ìƒì„± â†’`;
      } else {
        area.style.display = "none";
        btnGo.disabled = true;
      }

      cnt.textContent = jobQueue.length;
      list.innerHTML = "";
      
      jobQueue.forEach((job, idx) => {
        const div = document.createElement("div");
        div.className = "im-clean-item";
        div.innerHTML = `
          <div class="im-clean-info">
            <div class="im-clean-title">Job #${idx+1}</div>
            <div class="im-clean-meta">
              ë¸”ëŸ¬ ${job.blurPx} Â· í’ˆì§ˆ ${job.jpegQ} Â· ${job.noteOn ? "í…ìŠ¤íŠ¸ON" : "OFF"}
            </div>
          </div>
          <button type="button" onclick="removeJob(${job.id})" class="im-smallbtn" style="color:red;">ì‚­ì œ</button>
        `;
        list.appendChild(div);
      });
    }

    // âœ… [ì¶”ê°€] ì‘ì—… ì‚­ì œ
    window.removeJob = function(id) {
      jobQueue = jobQueue.filter(j => j.id !== id);
      renderJobQueueUI();
    };

    // [ìˆ˜ì •] ë²„ì „ í‘œì‹œ (í˜„ì¬ ì‹œê°„ì´ ì•„ë‹Œ, íŒŒì¼ì˜ 'ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„' í‘œì‹œ)
    (function showVersion(){
      const el = document.getElementById("sysVersion");
      if(!el) return;
      
      // âœ… document.lastModified : ë¸Œë¼ìš°ì €ê°€ ì¸ì‹í•œ íŒŒì¼ì˜ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°
      const d = new Date(document.lastModified);
      
      // ë‚ ì§œ í¬ë§·íŒ… (YYYYMMDD_HHMM)
      const dateStr = `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
      const timeStr = `${pad2(d.getHours())}${pad2(d.getMinutes())}`;
      
      // í™”ë©´ì— í‘œì‹œ (Updated: ë‚ ì§œ_ì‹œê°„)
      el.textContent = `Updated: ${dateStr}_${timeStr}`;
    })();

    // [ì¶”ê°€] ë¦¬ì‚¬ì´ì§• ì¹© UI ì„ íƒ ì²˜ë¦¬
    window.selectScale = function(el, val) {
      document.querySelectorAll('input[name="scaleOpt"]').forEach(input => {
        input.closest('.im-chip').classList.remove('on');
      });
      el.classList.add('on');
      el.querySelector('input').checked = true;
    };

    // [ì¶”ê°€] 40%, 50%, 60% 3ì¢… ì„¸íŠ¸ ì¼ê´„ ì¶”ê°€
    window.addBatchJobs = function() {
      if (!sourceImg) { alert("ì›ë³¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const useWm = document.getElementById("wmOn").checked;
      if (useWm && !watermarkImg) { alert("ì›Œí„°ë§ˆí¬ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

      // âœ… [ì¶”ê°€] ì¼ê´„ ì¶”ê°€ ì‹œì—ë„ íƒœê·¸ ì ìš©
      const userTag = document.getElementById("fileTag").value.trim();

      const baseConfig = {
        wmImg: watermarkImg,
        useWm: useWm,
        jpegQ: Number(document.getElementById("jpegQ").value),
        blurPx: Number(document.getElementById("blurPx").value),
        wmAlpha: Number(document.getElementById("wmAlpha").value),
        noteText: document.getElementById("noteText").value,
        noteOn: document.getElementById("noteOn").checked,
        notePos: document.getElementById("notePos").value,
        noteFont: Number(document.getElementById("noteFont").value),
        
        userTag: userTag // âœ… ê³µí†µ ì €ì¥
      };

      const scales = [0.6, 0.5, 0.4];
      
      scales.forEach((sc, i) => {
        const job = {
          ...baseConfig,
          id: Date.now() + i, 
          scale: sc
        };
        jobQueue.push(job);
      });

      renderJobQueueUI();
      alert(`3ê°œì˜ ì‘ì—…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.${userTag ? "\níƒœê·¸: " + userTag : ""}`);
    };
  })(); 

  // ====== ì „ì—­ (ëª¨ë‹¬ ê´€ë ¨) ======
  window.showAlert_ = function(msg, icon = "âš ï¸") {
    const overlay = document.getElementById("modalOverlay");
    document.getElementById("modalMsg").textContent = msg;
    document.getElementById("modalIcon").textContent = icon;
    overlay.style.display = "flex";
  };
  
  window.closeModal_ = function() {
    document.getElementById("modalOverlay").style.display = "none";
  };

  window.resetAllSettings_ = function() {
    if(!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    location.reload(); // ê°€ì¥ ê¹”ë”í•œ ì´ˆê¸°í™”
  };

  // íƒ­ ì´ë™ (ì™¸ë¶€ í˜¸ì¶œìš©)
  window.moveTab = function(tabNum) {
    const fileInput = document.getElementById("imgFile");
    if (tabNum == 2 && (!fileInput || !fileInput.files.length)) {
       window.showAlert_("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return;
    }
    
    document.querySelectorAll('.im-tab').forEach(b => b.classList.remove('on'));
    document.querySelectorAll('.im-panel').forEach(p => p.classList.remove('on'));
    
    document.querySelector(`.im-tab[data-tab="${tabNum}"]`)?.classList.add('on');
    document.getElementById(`panel-${tabNum}`)?.classList.add('on');

    if(tabNum === 3) {
       // Step 3 ì§„ì… ì‹œ UI ì •ë¦¬
       const isOrig = document.getElementById("onlyOrigOn").checked;
       document.getElementById("onlyOrigConfirmArea").style.display = isOrig ? "block" : "none";
       document.getElementById("btnMakePreviews").style.display = isOrig ? "none" : "inline-flex";
    }
  };

  // ì‚­ì œ ëª¨ë‹¬ ê´€ë ¨
  let targetDeleteId = null;
  window.openConfirmDelete = function(id) {
    targetDeleteId = id;
    document.getElementById("confirmOverlay").style.display = "flex";
  };
  window.closeConfirm_ = function() {
    document.getElementById("confirmOverlay").style.display = "none";
  };
  
  document.addEventListener('DOMContentLoaded', () => {
    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.im-tab').forEach(btn => {
      btn.addEventListener('click', function() {
        const n = this.getAttribute('data-tab');
        if(n === '1') window.resetAllSettings_();
        else window.moveTab(n);
      });
    });

    // ì‹¤ì œ ì‚­ì œ ë²„íŠ¼
    const $del = document.getElementById("btnRealDelete");
    if($del) {
      $del.onclick = async () => {
        if(!targetDeleteId) return;
        window.closeConfirm_();
        try {
          window.setBusy_(true, "ì‚­ì œ ì¤‘...");
          await window.apiPost({ mode: "delete", id: targetDeleteId });
          window.showAlert_("ì‚­ì œë¨", "ğŸ—‘ï¸");
          window.loadList();
        } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: "+e); }
        finally { window.setBusy_(false); }
      };
    }
  });
  
</script>
  
  <div id="globalMask" class="im-global-mask">
  <div class="im-global-spinner"></div>
  <div id="globalMaskText" class="im-global-text">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
</div>
</body>
</html>
