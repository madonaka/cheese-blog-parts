<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지 작성/수정 · Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />

  <!-- ✅ Summernote (Lite) + jQuery (Summernote는 jQuery 필요) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    .wrap{ max-width: 980px; margin:0 auto; padding:18px 18px 28px; box-sizing:border-box; }
    .title{ margin:10px 0 14px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .title .t{ font-size:20px; font-weight:1000; letter-spacing:-0.02em; }
    .title .s{ margin-top:4px; color:var(--sub); font-size:12px; font-weight:650; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
    .card-h{ padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(15,23,42,0.06); }
    .card-title{ font-weight:1000; letter-spacing:-0.02em; font-size:14px; display:flex; align-items:center; gap:8px; }
    .card-b{ padding:14px 14px 16px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:8px; }
    label{ font-size:12px; color:var(--sub); font-weight:900; }
    .input, .select, .textarea{
      border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:12px;
      padding:10px 12px; font-size:13px; font-weight:650; outline:none;
    }
    .textarea{ min-height: 360px; resize: vertical; } /* ✅ 기존 textarea 높이 */

    .row2{ grid-column: 1 / -1; }

    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px; }
    .btn{
      border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:12px;
      padding:10px 12px; font-size:13px; font-weight:900; cursor:pointer;
    }
    .btn.primary{ background:rgba(15,23,42,0.92); color:#fff; border-color:rgba(15,23,42,0.92); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .hint{ font-size:12px; color:var(--sub); font-weight:650; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }

    .checkline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .checkline .c{ display:flex; align-items:center; gap:8px; font-size:13px; font-weight:900; }
    .checkline input{ transform: scale(1.1); }

    /* ✅ Summernote가 card 스타일과 어울리도록 살짝만 정리 */
    .note-editor.note-frame{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      overflow:hidden;
    }
    .note-toolbar{
      border-bottom:1px solid rgba(15,23,42,0.08);
    }
    .note-editable{
      font-size:13px;
      font-weight:650;
    }

    @media (max-width:760px){
      .grid{ grid-template-columns: 1fr; }
      .textarea{ min-height: 320px; }
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="wrap">
        <div class="title">
          <div>
            <div class="t" id="pageT">공지 작성</div>
            <div class="s" id="pageS">로그인 세션의 사번/이름이 자동으로 작성자로 적용됩니다.</div>
          </div>
          <div class="pill" id="modePill">new</div>
        </div>

        <div class="card">
          <div class="card-h">
            <div class="card-title">✍️ 공지 내용</div>
            <div class="hint" id="writerHint"></div>
          </div>

          <div class="card-b">
            <div class="grid">
              <div class="field row2">
                <label>제목</label>
                <input class="input" id="title" placeholder="[필독] …" />
              </div>

              <div class="field">
                <label>레벨</label>
                <select class="select" id="level">
                  <option value="danger">danger (필독)</option>
                  <option value="warn">warn (중요)</option>
                  <option value="normal" selected>normal (일반)</option>
                </select>
              </div>

              <div class="field">
                <label>상태</label>
                <select class="select" id="status">
                  <option value="published">published (게시)</option>
                  <option value="draft" selected>draft (초안)</option>
                  <option value="archived">archived (보관)</option>
                </select>
              </div>

              <div class="field">
                <label>게시 시작일 (옵션)</label>
                <input class="input" id="startAt" type="date" />
              </div>

              <div class="field">
                <label>게시 종료일 (옵션)</label>
                <input class="input" id="endAt" type="date" />
              </div>

              <div class="field row2">
                <label>본문</label>
                <!-- ✅ 그대로 textarea 유지하고 Summernote가 이걸 에디터로 바꿈 -->
                <textarea class="textarea" id="body" placeholder="공지 내용을 입력하세요."></textarea>
                <div class="hint">* 서식(굵게/색/표/링크) 적용 가능. 저장 시 HTML로 저장됩니다.</div>
              </div>

              <div class="field row2">
                <label>옵션</label>
                <div class="checkline">
                  <label class="c"><input type="checkbox" id="isPinned" /> 상단 고정</label>
                  <label class="c"><input type="checkbox" id="allowComments" checked /> 댓글 허용</label>
                </div>
                <div class="hint">* 작성 권한이 없으면 저장 버튼이 숨겨집니다(운영 정책에 맞게).</div>
              </div>
            </div>

            <div class="btnbar">
              <button class="btn" type="button" id="btnBack">목록</button>
              <button class="btn" type="button" id="btnView" style="display:none;">상세 보기</button>
              <button class="btn primary" type="button" id="btnSave">저장</button>
            </div>

            <div class="hint" id="msg" style="margin-top:10px;"></div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    const ANN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";

    function getSessionUser_(){
      const empNo = (sessionStorage.getItem("cheese_admin_emp_no") || "").trim();
      const name  = (sessionStorage.getItem("cheese_admin_display_name") || "").trim();
      const role  = (sessionStorage.getItem("cheese_admin_role") || "").trim();
      return empNo ? { empNo, name, role } : null;
    }
    function canWrite_(role){
      return ["ADMIN","FIN","MGR"].includes(String(role||"").toUpperCase());
    }

    function mountShell_(){
      const tryCall = (names, args)=>{
        for(const n of names){
          if(typeof window[n] === 'function'){
            try{ window[n](args); }catch(e){ console.warn(n,e); }
            return true;
          }
        }
        return false;
      };

      tryCall(['renderAdminHeader','mountAdminHeader'], {
        mountId: 'admin-header-slot',
        badgeText: 'notice',
        subtitle: '공지 작성/수정'
      });
      tryCall(['renderAdminMenu','renderAdminSidebar','mountAdminMenu'], {
        mountId: 'admin-menu-slot',
        active: 'board'
      });
    }

    function qs_(k){
      return new URLSearchParams(location.search).get(k);
    }

    async function apiGet_(params){
      const url = ANN_API_BASE + "?" + new URLSearchParams(params).toString();
      const res = await fetch(url);
      const txt = await res.text();
      let j; try{ j = JSON.parse(txt); }catch(_){ throw new Error("서버 응답이 JSON이 아님: " + txt); }
      if(!j.ok) throw new Error(j.message || "API 오류");
      return j;
    }

    // ✅ Apps Script e.parameter 호환: form-urlencoded로 POST
    async function apiPostForm_(payload){
      const body = new URLSearchParams(payload);
      const res = await fetch(ANN_API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });
      const txt = await res.text();
      let j; try{ j = JSON.parse(txt); }catch(_){ throw new Error("서버 응답이 JSON이 아님: " + txt); }
      if(!j.ok) throw new Error(j.message || "API 오류");
      return j;
    }

    function setMsg_(t){
      document.getElementById('msg').textContent = t || '';
    }

    /* =======================================================
       ✅ Summernote wrapper (초기화/값 읽기/값 세팅/잠금)
       ======================================================= */
    let __editorReady = false;

    function initEditor_(){
      if(__editorReady) return;
      if(!window.jQuery || !jQuery.fn || !jQuery.fn.summernote){
        console.warn('Summernote 로드 실패(또는 jQuery 없음)');
        return;
      }
      $('#body').summernote({
        placeholder: '공지 내용을 입력하세요.',
        height: 360,
        toolbar: [
          ['style', ['style']],
          ['font', ['bold', 'underline', 'clear']],
          ['color', ['color']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['table', ['table']],
          ['insert', ['link']],          // ✅ 서버 없는 구조면 이미지 업로드는 일단 제외
          ['view', ['codeview']]
        ]
      });
      __editorReady = true;
    }

    function getBodyHtml_(){
      if(__editorReady) return String($('#body').summernote('code') || '').trim();
      return (document.getElementById('body').value || '').trim();
    }

    function setBodyHtml_(html){
      const v = String(html || '');
      if(__editorReady) $('#body').summernote('code', v);
      else document.getElementById('body').value = v;
    }

    function lockEditor_(locked){
      if(__editorReady){
        if(locked) $('#body').summernote('disable');
        else $('#body').summernote('enable');
      }else{
        document.getElementById('body').readOnly = locked;
      }
    }

    function readForm_(){
      return {
        title: (document.getElementById('title').value || '').trim(),
        body: getBodyHtml_(), // ✅ Summernote HTML
        level: document.getElementById('level').value,
        status: document.getElementById('status').value,
        startAt: (document.getElementById('startAt').value || '').trim(),
        endAt: (document.getElementById('endAt').value || '').trim(),
        isPinned: document.getElementById('isPinned').checked ? '1' : '0',
        allowComments: document.getElementById('allowComments').checked ? '1' : '0'
      };
    }

    function toYmd_(v){
      if(v instanceof Date){
        return v.toISOString().slice(0,10);
      }
      if(!v) return '';
      const s = String(v).trim();
      const m = s.match(/\d{4}-\d{2}-\d{2}/);
      return m ? m[0] : '';
    }

    function fillForm_(n){
      document.getElementById('title').value = n.title || '';
      setBodyHtml_(n.body || ''); // ✅ Summernote 세팅
      document.getElementById('level').value = n.level || 'normal';
      document.getElementById('status').value = n.status || 'draft';
      document.getElementById('startAt').value = toYmd_(n.startAt);
      document.getElementById('endAt').value   = toYmd_(n.endAt);
      document.getElementById('isPinned').checked = Number(n.isPinned||0)===1;
      document.getElementById('allowComments').checked = Number(n.allowComments||0)===1;
    }

    let __noticeId = '';
    let __authorEmpNo = '';
    let __canEdit = true;

    async function loadIfEdit_(){
      __noticeId = (qs_('id') || qs_('noticeId') || '').trim();
      if(!__noticeId){
        document.getElementById('modePill').textContent = 'new';

        const user = getSessionUser_();
        if(!user){
          lockForm_(true);
          setMsg_('로그인이 필요합니다.');
          return;
        }

        if(!canWrite_(user.role)){
          lockForm_(true);
          setMsg_('작성 권한이 없습니다. (읽기 전용)');
        }else{
          lockForm_(false);
        }
        return;
      }

      document.getElementById('pageT').textContent = '공지 수정';
      document.getElementById('modePill').textContent = __noticeId;

      const j = await apiGet_({ mode:'getAnnouncement', noticeId: __noticeId });
      fillForm_(j.notice || {});

      const user = getSessionUser_();
      __authorEmpNo = String((j.notice && j.notice.authorEmpNo) || '').trim();

      const isAdmin  = user && String(user.role||'').toUpperCase() === 'ADMIN';
      const isAuthor = user && String(user.empNo||'').trim() === __authorEmpNo;

      __canEdit = !!(isAdmin || isAuthor);

      if(!__canEdit){
        lockForm_(true);
        setMsg_('이 공지는 작성자 또는 ADMIN만 수정할 수 있어요. (읽기 전용)');
      }else{
        lockForm_(false);
      }

      document.getElementById('btnView').style.display = 'inline-flex';
      document.getElementById('btnView').onclick = ()=> location.href = "./notice.html?id=" + encodeURIComponent(__noticeId);
    }

    async function save_(){
      if(__noticeId && !__canEdit){
        alert('작성자 또는 ADMIN만 수정할 수 있습니다.');
        return;
      }
      const user = getSessionUser_();
      if(!user){
        alert('로그인이 필요합니다.');
        location.href = "../index.html";
        return;
      }
      if(!__noticeId && !canWrite_(user.role)){
        alert('작성 권한이 없습니다.');
        return;
      }

      const f = readForm_();
      if(!f.title) return alert('제목을 입력해 주세요.');

      // ✅ Summernote는 빈 값이어도 "<p><br></p>" 같은 게 들어올 수 있어 정리
      const bodyText = f.body.replace(/<[^>]*>/g,'').replace(/&nbsp;/g,' ').trim();
      if(!bodyText) return alert('본문을 입력해 주세요.');

      if(f.startAt && f.endAt && f.startAt > f.endAt){
        alert('게시 시작일은 종료일보다 늦을 수 없습니다.');
        return;
      }

      setMsg_('저장 중…');

      const payload = Object.assign({
        mode: 'upsertAnnouncement',
        noticeId: __noticeId || '',
        authorEmpNo: __noticeId ? __authorEmpNo : user.empNo
      }, f);

      const j = await apiPostForm_(payload);

      if(j.noticeId) __noticeId = j.noticeId;

      setMsg_('저장 완료 ✅');
      document.getElementById('modePill').textContent = __noticeId || 'saved';
      document.getElementById('btnView').style.display = __noticeId ? 'inline-flex' : 'none';
      if(__noticeId){
        document.getElementById('btnView').onclick = ()=> location.href = "./notice.html?id=" + encodeURIComponent(__noticeId);
      }
    }

    function wireDateGuards_(){
      const startEl = document.getElementById('startAt');
      const endEl   = document.getElementById('endAt');
      if(!startEl || !endEl) return;

      const sync = () => {
        const s = (startEl.value || '').trim();
        const e = (endEl.value || '').trim();

        startEl.max = e || '';
        endEl.min   = s || '';

        if(s && e && s > e){
          endEl.value = s;
          setMsg_('게시 종료일이 시작일보다 빨라 자동으로 보정했습니다.');
        }
      };

      ['change','input'].forEach(ev=>{
        startEl.addEventListener(ev, sync);
        endEl.addEventListener(ev, sync);
      });

      sync();
    }

    function lockForm_(locked){
      const ids = ['title','level','status','startAt','endAt','isPinned','allowComments'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(el.tagName === 'INPUT'){
          if(el.type === 'checkbox') el.disabled = locked;
          else el.readOnly = locked;
        }else{
          el.disabled = locked;
        }
      });

      // ✅ 본문 에디터 잠금
      lockEditor_(locked);

      const btnSave = document.getElementById('btnSave');
      if(btnSave) btnSave.style.display = locked ? 'none' : 'inline-flex';
    }

    (function init(){
      mountShell_();
      wireDateGuards_();

      // ✅ Summernote는 DOM 준비 후 초기화하는 게 안전
      initEditor_();

      const user = getSessionUser_();
      document.getElementById('writerHint').textContent =
        user ? `작성자: ${user.empNo}${user.name ? ' · ' + user.name : ''}` : '로그인 정보 없음';

      const btnSave = document.getElementById('btnSave');
      if(!user){
        btnSave.style.display = 'none';
      }

      document.getElementById('btnBack').onclick = ()=> location.href = "./board.html";
      btnSave.onclick = ()=> save_().catch(err=>{ setMsg_(''); alert(err.message||String(err)); });

      loadIfEdit_().catch(err=>alert(err.message||String(err)));
    })();
  </script>
</body>
</html>
