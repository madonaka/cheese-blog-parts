<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í¬ìŠ¤íŠ¸ ê´€ë¦¬ í…ŒìŠ¤íŠ¸</title>

  <!-- âœ… ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .pm-wrap{ padding: 14px; }

    .pm-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }

    .pm-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .pm-label{ font-weight:800; }

    .pm-input, .pm-select{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:10px;
      min-width:280px;
      background:#fff;
    }

    .pm-title{ min-width:420px; }

    .pm-textarea{
      width:100%;
      min-height:420px;
      padding:12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;
      line-height:1.45;
    }

    .pm-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.18);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      white-space:nowrap;
    }

    .pm-btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .pm-btn.danger{ background:#b91c1c; color:#fff; border-color:#b91c1c; }
    .pm-btn.ghost{ background:rgba(15,23,42,0.03); }
    .pm-btn.small{ padding:8px 10px; font-size:12px; border-radius:9px; }

    .pm-muted{ color:#6b7280; font-size:13px; }
    .pm-status{ margin-top:10px; font-size:13px; }
    .pm-status.ok{ color:#047857; }
    .pm-status.err{ color:#b91c1c; }

    .pm-meta{ display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; margin-top:10px; }
    .pm-meta div{ padding:6px 0; }

    .pm-link{ color:#2563eb; font-weight:800; text-decoration:none; }

    .pm-pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.15);
      font-size:12px;
      margin-left:8px;
    }

    .pm-small{ font-size:12px; color:#6b7280; }

    .pm-banner{
      margin: 0 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185,28,28,0.25);
      background: rgba(185,28,28,0.06);
      color:#7f1d1d;
      font-weight:800;
      font-size:13px;
      display:none;
      white-space:pre-line;
    }

    /* ===== dynamic fields ===== */
    .pm-dyn-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr)); /* âœ… ì¹´ë“œ 2ì—´ */
      gap:10px 12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .pm-dyn-grid{ grid-template-columns: 1fr; }
    }
    .pm-dyn-item{
      border:1px solid rgba(15,23,42,0.12);
      border-radius:12px;
      padding:10px;
      background:rgba(15,23,42,0.02);
    }
    .pm-dyn-key{ font-weight:900; margin:0 0 6px; }
    /* âœ… ë™ì  ì¹´ë“œ í—¤ë”(íƒ€ì´í‹€ + ë¹„ìš°ê¸° ë²„íŠ¼) */
    .pm-dyn-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin:0 0 6px;
    }
    .pm-dyn-key{ margin:0; } /* ê¸°ì¡´ margin-bottom ëŒ€ì‹  headì—ì„œ ê´€ë¦¬ */
    
    /* ë¹„ìš°ê¸° ë²„íŠ¼ì„ ì¡°ê¸ˆ ë” ê°€ë³ê²Œ */
    .pm-dyn-clear{
      padding:6px 10px;
      font-size:12px;
      border-radius:9px;
    }

    
    .pm-dyn-help{ margin:0 0 10px; }
    .pm-dyn-textarea{ min-height:200px; }
    .pm-hr{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }

    .pm-hidden{ display:none !important; }

    /* ==============================
       âœ… Sticky Action Bar (NEW)
    ============================== */
    .pm-stickybar{
      position: sticky;
      top: 0;
      z-index: 50;
      margin: 0 0 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.14);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(15,23,42,0.08);
    }
    .pm-stickybar .bar-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pm-stickybar .bar-left{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pm-stickybar .bar-right{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pm-sticky-id{
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.04);
      border:1px solid rgba(15,23,42,0.12);
      max-width:340px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pm-sticky-status{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.12);
      background:rgba(15,23,42,0.03);
      font-size:12px;
      color:#111827;
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pm-sticky-status.ok{ color:#047857; border-color: rgba(4,120,87,0.25); background: rgba(4,120,87,0.06); }
    .pm-sticky-status.err{ color:#b91c1c; border-color: rgba(185,28,28,0.25); background: rgba(185,28,28,0.06); }

    .pm-spinner{
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(15,23,42,0.22);
      border-top-color: rgba(15,23,42,0.75);
      animation: pmspin 0.9s linear infinite;
      display:none;
      flex:0 0 auto;
    }
    .pm-spinner.on{ display:inline-block; }
    @keyframes pmspin { to { transform: rotate(360deg); } }

    .pm-sticky-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pm-divider{
      width:1px;
      height:26px;
      background:rgba(15,23,42,0.12);
      margin:0 2px;
    }
    /* [NEW] ìƒë‹¨ ë ˆì´ì•„ì›ƒ ë¶„í•  (ì¢Œ:ì„¤ì • / ìš°:ì„¹ì…˜ìˆœì„œ) */
    .pm-top-grid {
      display: grid;
      grid-template-columns: 3fr 1fr; /* ì¢Œì¸¡ 3 : ìš°ì¸¡ 1 ë¹„ìœ¨ */
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 1100px) {
      .pm-top-grid { grid-template-columns: 1fr; } /* í™”ë©´ ì¢ìœ¼ë©´ 1ì—´ë¡œ */
    }
    
    /* [NEW] ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì„¹ì…˜ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .pm-sort-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    .pm-sort-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: #fff;
      border: 1px solid rgba(15,23,42,0.15);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: grab; /* ì†ë°”ë‹¥ ëª¨ì–‘ */
      transition: background 0.2s, transform 0.2s;
      font-size: 13px;
      user-select: none;
    }
    .pm-sort-item:active {
      cursor: grabbing; /* ê½‰ ì¥” ì† ëª¨ì–‘ */
      background: #f1f5f9;
    }
    /* ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ì‹œê° íš¨ê³¼ */
    .pm-sort-item.dragging {
      opacity: 0.5;
      background: #e2e8f0;
      border-style: dashed;
    }
    /* ì„¹ì…˜ ë²ˆí˜¸ ë±ƒì§€ */
    .pm-sort-idx {
      font-weight: 900;
      color: #2563eb;
      width: 20px;
      text-align: center;
    }
    /* ì„¹ì…˜ ì´ë¦„ */
    .pm-sort-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 600;
    }

    /* [NEW] ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .pm-modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .pm-modal-content {
      background: #fff;
      width: 90%; max-width: 500px;
      max-height: 80vh;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: pmFadeIn 0.2s ease-out;
    }
    @keyframes pmFadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    
    .pm-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
      display: flex; justify-content: space-between; align-items: center;
      background: #f8fafc;
    }
    .pm-modal-body {
      padding: 16px 20px;
      overflow-y: auto;
      flex: 1;
    }
    .pm-modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex; justify-content: space-between; align-items: center;
      background: #f8fafc;
    }
    
    /* ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .pm-lib-list { list-style: none; padding: 0; margin: 0; }
    .pm-lib-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.15s;
      border-radius: 8px;
    }
    .pm-lib-item:hover { background: #eff6ff; }
    .pm-lib-item:last-child { border-bottom: none; }
    .pm-lib-name { font-weight: 600; font-size: 14px; color: #334155; }
    .pm-lib-add { color: #2563eb; font-size: 12px; font-weight: 800; }

    
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="pm-wrap">
        <h2 style="margin:0 0 12px; display:flex; align-items:center; flex-wrap:wrap;">
          í¬ìŠ¤íŠ¸ ê´€ë¦¬ í…ŒìŠ¤íŠ¸
          <span class="pm-pill">Sheet DB + Drive HTML</span>
          <span id="sysVersion" class="pm-pill" style="background:#f1f5f9; color:#64748b; font-family:monospace; margin-left:auto;">
            Checking...
          </span>
        </h2>

          <div id="banner" class="pm-banner"></div>

          <!-- ==============================
               âœ… Sticky Action Bar (NEW)
               - í•­ìƒ ìƒë‹¨ì— ê³ ì •
               - í•µì‹¬ ì•¡ì…˜ + ì§„í–‰ìƒíƒœ í‘œì‹œ
          ============================== -->
          <div class="pm-stickybar" id="stickyBar">
            <div class="bar-row">
              <div class="bar-left">
                <div class="pm-sticky-id" id="stickyId">ID: -</div>

                <div class="pm-sticky-status" id="stickyStatus">
                  <span class="pm-spinner" id="stickySpinner"></span>
                  <span id="stickyStatusText">ì¤€ë¹„ë¨</span>
                </div>
              </div>

              <div class="bar-right">
                <div class="pm-sticky-actions">
                  <!-- ì›í´ë¦­ íŒŒì´í”„ë¼ì¸ -->
                  <button id="btnQuickPublish" class="pm-btn primary">ì›í´ë¦­ ë°œí–‰</button>
                  <button id="btnQuickDraft" class="pm-btn ghost">ì›í´ë¦­ ì´ˆì•ˆ ì €ì¥</button>

                  <div class="pm-divider"></div>

                  <!-- ìì£¼ ì“°ëŠ” ë‹¨ì¼ ì•¡ì…˜ -->
                  <button id="btnQuickDriveSave" class="pm-btn">Drive ì €ì¥</button>
                  <button id="btnQuickBloggerUpsert" class="pm-btn">Blogger ì—…ë¡œë“œ</button>

                  <div class="pm-divider"></div>

                  <button id="btnQuickBloggerRead" class="pm-btn small">Blogger ë¶ˆëŸ¬ì˜¤ê¸°</button>
                  <button id="btnQuickLabels" class="pm-btn small">ë¼ë²¨ ì ìš©</button>
                  
                  <button id="btnClear" class="pm-btn small danger" title="í¸ì§‘ì°½ ë¹„ìš°ê¸°">ğŸ—‘ï¸</button>

                  <a id="stickyOpenBlogger" class="pm-link" href="#" target="_blank" style="display:none;">ê¸€ ì—´ê¸°</a>
                </div>
              </div>
            </div>

            <div class="bar-row" style="margin-top:10px;">
              <div class="pm-row" style="width:100%;">
                <div class="pm-label">ë¼ë²¨</div>
                <input
                  id="bloggerLabelsTop"
                  class="pm-input"
                  type="text"
                  placeholder="ì˜ˆ: ì£¼ìš” ì‚¬ê±´,2026,ì •ì¹˜ (ì½¤ë§ˆë¡œ êµ¬ë¶„)"
                  style="min-width:320px;"
                />
                <select id="bloggerLabelsActionTop" class="pm-select" style="min-width:160px;">
                  <option value="replace">ë®ì–´ì“°ê¸°</option>
                  <option value="add">ì¶”ê°€</option>
                  <option value="remove">ì œê±°</option>
                </select>
                <span class="pm-muted pm-small" id="stickyLabelsHint">â€» ì…ë ¥ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì—…ë¡œë“œ ì‹œ ê¸°ì¡´ ë¼ë²¨ ìœ ì§€(keep)</span>
              </div>
            </div>
          </div>
          
          <div class="pm-top-grid">
            
            <section class="pm-card">
              <div class="pm-row" style="justify-content: space-between;">
                <div style="display:flex; gap:10px; align-items:center;">
                  <button id="btnOpenPostModal" class="pm-btn" style="min-width:140px;">
                    ğŸ“‚ ê¸°ì¡´ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
                  </button>
                  <button id="btnStartNewPost" class="pm-btn primary" style="min-width:120px;">
                    ğŸ“ ìƒˆ ê¸€ ì‘ì„±
                  </button>
                </div>
                <div id="currentPostInfo" class="pm-pill" style="background:#f1f5f9; padding:8px 12px; font-size:13px;">
                  ì„ íƒë¨: ì—†ìŒ (ìƒˆ ê¸€ ëª¨ë“œ)
                </div>
              </div>
            
              <div id="newPostConfig" style="margin-top:15px; padding:15px; background:rgba(37,99,235,0.04); border-radius:12px; border:1px solid rgba(37,99,235,0.1); display:block;">
                <div class="pm-label" style="color:#2563eb; margin-bottom:10px;">ìƒˆ ê¸€ ì„¤ì • (ID ìƒì„±)</div>
                
                <div class="pm-row">
                  <div class="pm-label">ë¶„ë¥˜</div>
                  <select id="category" class="pm-select">
                    <option value="">ë¶„ë¥˜ ì„ íƒ...</option>
                    <option value="monthly_news">ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬</option>
                    <option value="timeline_kr_cn_jp">í•œêµ­ì‚¬+ì¤‘êµ­ì‚¬+ì¼ë³¸ì‚¬ ì—°í‘œ</option>
                    <option value="genealogy_series">ê°€ê³„ë„ì‹œë¦¬ì¦ˆ</option>
                    <option value="etc">ê¸°íƒ€</option>
                    <option value="manual">ìˆ˜ë™ì…ë ¥</option>
                  </select>
                  
                  <div class="pm-label" style="margin-left:10px;">ID</div>
                  <input id="id" class="pm-input" type="text" placeholder="ë¶„ë¥˜ ì„ íƒ ì‹œ ìë™ ìƒì„±" disabled style="background:#eee;" />
                  
                  <button id="btnRegenId" class="pm-btn small">ID ìƒì„±</button>
                </div>
                <div class="pm-muted pm-small" style="margin-top:6px;">
                  â€» ê¸°ì¡´ ê¸€ì„ ìˆ˜ì •í•  ë•ŒëŠ” IDë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </div>
              </div>
            
              <div class="pm-row" style="margin-top:10px;">
                <div class="pm-label">í…œí”Œë¦¿(Drive)</div>
                  <select id="templateSelect" class="pm-select" style="min-width:280px;"></select>
            
                  <button id="btnApplyTemplate" class="pm-btn">í…œí”Œë¦¿ ì ìš©(ìƒˆë¡œ)</button>
                  <button id="btnRewrapTemplate" class="pm-btn">ë˜í¼ ì¬ì ìš©(ë³¸ë¬¸ ìœ ì§€)</button>
            
                  <span class="pm-muted pm-small">
                    â€» í…œí”Œë¦¿ì€ Driveì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸(JSON) + ì„¹ì…˜(HTML ì¡°ê°)ì„ ì¡°ë¦½í•©ë‹ˆë‹¤.
                  </span>
                </div>
            
                <div id="status" class="pm-status pm-muted">ì¤€ë¹„ë¨</div>
            
                <details style="margin-top:10px;">
                  <summary class="pm-muted" style="cursor:pointer; font-weight:800;">ë””ë²„ê·¸(ë§ˆì§€ë§‰ ì‘ë‹µ)</summary>
                  <pre id="debug" style="margin:10px 0 0; padding:10px; border:1px solid rgba(15,23,42,0.14); border-radius:12px; background:rgba(15,23,42,0.03); overflow:auto; max-height:220px; font-size:12px;"></pre>
                </details>
            
                <div class="pm-meta">
                  <div class="pm-muted">Drive fileId</div><div id="driveFileId" class="pm-muted">-</div>
                  <div class="pm-muted">Drive url</div><div id="driveUrl" class="pm-muted">-</div>
                  <div class="pm-muted">Updated</div><div id="updatedAt" class="pm-muted">-</div>
                </div>
            
                <div class="pm-row" style="margin-top:10px;">
                  <a id="openDriveLink" class="pm-link" href="#" target="_blank" style="display:none;">Drive íŒŒì¼ ì—´ê¸°</a>
                </div>
              </section>
            
              <section class="pm-card" style="height:100%; display:flex; flex-direction:column; min-height: 400px;">
                <div class="pm-label" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                  <span>ì„¹ì…˜ ìˆœì„œ</span>
                  <span class="pm-small pm-muted">ë“œë˜ê·¸í•˜ì—¬ ì´ë™</span>
                </div>
                
                <ul id="sectionSortList" class="pm-sort-list" style="flex:1; overflow-y:auto;">
                  <li class="pm-muted" style="padding:10px; text-align:center;">í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</li>
                </ul>
                
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.05);">
                  <button class="pm-btn primary" style="width:100%;" onclick="openSectionModal_()">
                    + ì„¹ì…˜ ì¶”ê°€ (Library)
                  </button>
                  <div class="pm-small pm-muted" style="text-align:center; margin-top:6px;">
                    ìˆœì„œë¥¼ ë°”ê¾¸ë©´ ì•„ë˜ ì…ë ¥ì°½ë„ í•¨ê»˜ ì´ë™í•©ë‹ˆë‹¤.
                  </div>
                </div>
              </section>
            
            </div>
          
            <div class="pm-row">
              <div class="pm-label">Title</div>
              <input id="title" class="pm-input pm-title" type="text" placeholder="ê¸€ ì œëª©" />
              <div class="pm-muted" id="charCount">0 chars</div>
            </div>

            <div style="margin-top:10px;">
              <div class="pm-label" style="margin-bottom:6px;">HTML(ìµœì¢…ë³¸)</div>
              <textarea id="html" class="pm-textarea" placeholder="ì—¬ê¸°ì— ìµœì¢… HTMLì´ ìƒì„±ë©ë‹ˆë‹¤. (ë””ë²„ê·¸/ì§ì ‘í¸ì§‘ ê°€ëŠ¥)"></textarea>
            </div>

            <div style="margin-top:10px;">
              <div class="pm-label" style="margin-bottom:6px;">ë™ì  ì…ë ¥(í…œí”Œë¦¿ ìŠ¬ë¡¯/í† í°)</div>
              <p class="pm-muted pm-small pm-dyn-help" id="dynHelp">
                â€» í…œí”Œë¦¿ì—ì„œ SLOT(ì˜ˆ: BODY_1/2/3) ë˜ëŠ” í† í°(ì˜ˆ: {{THUMB_URL}})ì„ ê°ì§€í•´ ì…ë ¥ì¹¸ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
              </p>

              <!-- SLOT(TEXTAREA) -->
              <div id="slotFields" class="pm-dyn-grid"></div>

              <div class="pm-hr"></div>

              <!-- Token(INPUT) -->
              <div id="tokenFields" class="pm-dyn-grid"></div>
            </div>

          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- âœ… ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ëŠ” ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ -->
  <script src="./admin-common.js"></script>

<script>
  /** =========================
   * âœ… admin-common.js: í—¤ë”/ë©”ë‰´ ìŠ¬ë¡¯ ìœ ì§€
   * ========================= */
  (function renderShellOnce(){
    try{
      if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
        window.AdminCommon.renderShell({
          headerSlotId: "admin-header-slot",
          menuSlotId: "admin-menu-slot",
          activeMenu: "post_manage"
        });
      }
    }catch(_){}
  })();

  (() => {
    const $ = (id) => document.getElementById(id);
    let current = null;
    // í¬ìŠ¤íŠ¸ ëª©ë¡ ìºì‹œ
    let _cachedPostList = [];
    
    // âœ… ê³ ì •: Apps Script ì£¼ì†Œ
    const API_BASE = "https://script.google.com/macros/s/AKfycbwXqz1uMy3EOrisCEKIe0Fk7yu0P6MQ1ddHDvo7Sr_CPEYY0RHP2GyUBL8YhaBqxnmBJg/exec";
    // ì„¹ì…˜ HTML ìºì‹œ
    const sectionCache = new Map();

    // í˜„ì¬ í…œí”Œë¦¿ ë¶„ì„ ê²°ê³¼
    const templateState = {
      templateId: "",
      manifest: null,
      sections: [],   
      slots: [],   
      tokens: []   
    };

    /* =========================
       âœ… Sticky bar helpers
       ========================= */
    function setBusy_(on){
      const sp = $("stickySpinner");
      if (!sp) return;
      sp.classList.toggle("on", !!on);
    }

    function setStickyId_(){
      const id = getTargetId() || "-";
      if($("stickyId")) $("stickyId").textContent = "ID: " + id;
    }

    function getTargetId(){
      // [ìˆ˜ì •] ë“œë¡­ë°•ìŠ¤ ì œê±°ë¨, ID ì…ë ¥ì¹¸ë§Œ í™•ì¸
      const fromInput = $("id") ? $("id").value.trim() : "";
      return fromInput || "";
    }

    /* =========================
       âœ… ì‹¤ì‹œê°„ í”„ë¦¬ë·°
       ========================= */
    let previewTimer = null;
    let previewSeq = 0;

    function scheduleAssemblePreview_(){
      clearTimeout(previewTimer);
      previewTimer = setTimeout(runAssemblePreview_, 250);
    }

    async function runAssemblePreview_(){
      const tplId = $("templateSelect") ? $("templateSelect").value : "";
      if (!tplId) return;

      const seq = ++previewSeq;
      try{
        const out = await assembleHtmlUsingState_(tplId, buildVarsForAssemble_());
        if (seq !== previewSeq) return;

        $("html").value = out.html;
        syncCharCount();
      }catch(e){
        setStatus("í”„ë¦¬ë·° ì¡°ë¦½ ì‹¤íŒ¨: " + (e?.message || e), false);
        setDebug(String(e && e.stack ? e.stack : e));
      }
    }

    // ì´ë²¤íŠ¸ ìœ„ì„
    (function bindPreviewDelegation_(){
      const bind = (boxId) => {
        const box = $(boxId);
        if (!box || box.__pmDelegationBound) return;
        box.addEventListener("input", scheduleAssemblePreview_, true);
        box.addEventListener("change", scheduleAssemblePreview_, true);
        box.__pmDelegationBound = true;
      };
      bind("slotFields");
      bind("tokenFields");
    })();

    (function bindClearDelegation_(){
      const clearBySelector = (sel) => {
        const el = document.querySelector(sel);
        if (!el) return;
        el.value = "";
        el.dispatchEvent(new Event("input", { bubbles:true }));
        el.dispatchEvent(new Event("change", { bubbles:true }));
      };
      
      const bind = (boxId) => {
        const box = $(boxId);
        if (!box || box.__pmClearBound) return;
        
        box.addEventListener("click", (e) => {
          const btn = e.target.closest(".pm-dyn-clear");
          if (!btn) return;
          
          const slot = btn.getAttribute("data-clear-slot");
          const tok  = btn.getAttribute("data-clear-token");
          
          if (slot) clearBySelector(`[data-slot="${CSS.escape(slot)}"]`);
          if (tok)  clearBySelector(`[data-token="${CSS.escape(tok)}"]`);
        });
        
        box.__pmClearBound = true;
      };
      
      bind("slotFields");
      bind("tokenFields");
    })();
    
    function attachDynamicPreviewListeners_(){
      document.querySelectorAll("[data-slot]").forEach(el=>{
        if (el.__pmPreviewBound) return;
        el.addEventListener("input", scheduleAssemblePreview_);
        el.addEventListener("change", scheduleAssemblePreview_);
        el.__pmPreviewBound = true;
      });

      document.querySelectorAll("[data-token]").forEach(el=>{
        if (el.__pmPreviewBound) return;
        el.addEventListener("input", scheduleAssemblePreview_);
        el.addEventListener("change", scheduleAssemblePreview_);
        el.__pmPreviewBound = true;
      });
    }

    function setStatus(msg, ok=true){
      const el = $("status");
      if(el) {
        el.textContent = msg;
        el.className = "pm-status " + (ok ? "ok" : "err");
      }
      const st = $("stickyStatus");
      const tx = $("stickyStatusText");
      if (tx) tx.textContent = msg;
      if (st){
        st.classList.remove("ok","err");
        st.classList.add(ok ? "ok" : "err");
      }
    }

    function showBanner(msg){
      const b = $("banner");
      if(b) { b.textContent = msg; b.style.display = "block"; }
    }

    function hideBanner(){
      const b = $("banner");
      if(b) { b.textContent = ""; b.style.display = "none"; }
    }

    function setDebug(obj){
      const el = $("debug");
      if (!el) return;
      try{ el.textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2); }
      catch(e){ el.textContent = String(obj); }
    }

    function setMeta(post){
      $("driveFileId").textContent = post.drive_file_id || "-";
      $("driveUrl").textContent = post.drive_url || "-";
      $("updatedAt").textContent = post.updated_at || "-";

      const link = $("openDriveLink");
      if (post.drive_url){
        link.href = post.drive_url;
        link.style.display = "inline";
      } else {
        link.style.display = "none";
      }
    }

    function setBloggerMeta(info){
      const meta = $("bloggerMeta");
      const link = $("openBloggerLink");
      const stickyLink = $("stickyOpenBlogger");

      if (meta){
        meta.textContent = info
          ? (info.status ? `status: ${info.status}` : '') + (info.post_id ? `  postId: ${info.post_id}` : '')
          : '';
      }

      if (link){
        if (info && info.url){
          link.href = info.url;
          link.style.display = 'inline';
        }else{
          link.style.display = 'none';
        }
      }

      if (stickyLink){
        if (info && info.url){
          stickyLink.href = info.url;
          stickyLink.style.display = 'inline';
        }else{
          stickyLink.style.display = 'none';
        }
      }
    }

    function syncCharCount(){
      $("charCount").textContent = ($("html").value || "").length + " chars";
    }
    $("html").addEventListener("input", syncCharCount);
    $("title").addEventListener("input", ()=>{ attachDynamicPreviewListeners_(); scheduleAssemblePreview_(); });

    function buildUrl(mode, paramsObj){
      const params = new URLSearchParams();
      params.set("mode", mode);
      params.set("_ts", String(Date.now()));

      if (paramsObj && typeof paramsObj === "object"){
        for (const [k,v] of Object.entries(paramsObj)){
          if (v === undefined || v === null) continue;
          params.set(k, String(v));
        }
      }
      return `${API_BASE}?${params.toString()}`;
    }

    function readTemplateMeta_(html){
      const get = (key) => {
        const re = new RegExp(``, "i");
        const m = String(html||"").match(re);
        return m ? m[1].trim() : "";
      };
      return {
        template_id: get("template_id"),
        template_ver: get("template_ver"),
      };
    }

    function extractBodies_(html){
      const t = String(html || "");
      const out = {};
      const reStart = //ig;
      let m;
      while ((m = reStart.exec(t)) !== null){
        const name = (m[1] || "BODY").trim();
        const startIdx = reStart.lastIndex;
        const endMark = name === "BODY"
          ? //ig
          : new RegExp(``, "ig");
        endMark.lastIndex = startIdx;
        const em = endMark.exec(t);
        if (!em) continue;
        const endIdx = em.index;
        out[name] = t.slice(startIdx, endIdx).trim();
        reStart.lastIndex = endMark.lastIndex;
      }
      if (Object.keys(out).length === 0){
        out["BODY"] = t.trim();
      }
      return out;
    }

    async function apiGet(mode, paramsObj){
      const url = buildUrl(mode, paramsObj);
      const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
      const text = await res.text().catch(()=> "");
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0,500)}`);
      try { return JSON.parse(text); }
      catch { throw new Error("JSON_PARSE_FAILED\n" + text.slice(0,500)); }
    }

    async function apiPost(mode, bodyObj){
      const url = `${API_BASE}?_ts=${Date.now()}`;
      const body = new URLSearchParams();
      body.set("mode", String(mode || ""));
      if (bodyObj && typeof bodyObj === "object"){
        for (const [k,v] of Object.entries(bodyObj)){
          if (v === undefined || v === null) continue;
          body.set(k, String(v));
        }
      }
      const res = await fetch(url, { method:"POST", body, cache:"no-store", credentials:"omit" });
      const text = await res.text().catch(()=> "");
      let data = null;
      try { data = JSON.parse(text); } catch(_){}
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
      if (!data)   throw new Error(`JSON ì•„ë‹˜: ${text.slice(0,300)}`);
      return data;
    }

    // ===== ì´ë¯¸ì§€ ê´€ë¦¬ =====
    const IMG_DB_URL = "https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec";
    const IMG_THUMB_W = 1200;
    function imgThumbUrl_(fileId, w = IMG_THUMB_W){
      const id = String(fileId || "").trim();
      if (!id) return "";
      return `https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w${encodeURIComponent(String(w||IMG_THUMB_W))}`;
    }
    function imgMakeNonce_(){
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }
    function imgJsonpCall_(url, cbName, timeoutMs = 12000){
      return new Promise((resolve) => {
        let done = false;
        let script = null;
        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"timeout" });
        }, timeoutMs);
        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
        window[cbName] = (data) => {
          if (done) return;
          done = true;
          cleanup();
          resolve(data);
        };
        script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + `_=${Date.now()}`;
        script.onerror = () => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"script_load_failed" });
        };
        document.head.appendChild(script);
      });
    }
    async function imgList_(){
      const nonce = imgMakeNonce_();
      const cb = `__img_list_cb_${nonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${IMG_DB_URL}?mode=list&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(nonce)}`;
      const res = await imgJsonpCall_(url, cb, 12000);
      if (!res || !res.ok) throw new Error(res?.error || "IMG_LIST_FAILED");
      return Array.isArray(res.items) ? res.items : [];
    }
    async function imgGet_(id){
      const nonce = imgMakeNonce_();
      const cb = `__img_get_cb_${nonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${IMG_DB_URL}?mode=get&id=${encodeURIComponent(String(id||""))}&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(nonce)}`;
      const res = await imgJsonpCall_(url, cb, 12000);
      if (!res || !res.ok) throw new Error(res?.error || "IMG_GET_FAILED");
      return res.item || null;
    }

    // ===== Drive Template/Section helpers =====
    async function listTemplates_(){
      const res = await apiGet("listTemplates");
      if (!res || !res.ok) throw new Error(res?.message || "LIST_TEMPLATES_FAILED");
      return res.items || [];
    }
    async function getTemplateManifest_(templateId){
      const res = await apiGet("getTemplate", { template_id: templateId });
      if (!res || !res.ok) throw new Error(res?.message || "GET_TEMPLATE_FAILED");
      const txt = String(res.json || "").trim();
      if (!txt) throw new Error("TEMPLATE_JSON_EMPTY");
      let manifest = null;
      try{ manifest = JSON.parse(txt); }
      catch(e){ throw new Error("TEMPLATE_JSON_PARSE_FAILED: " + (e?.message || e)); }
      return manifest;
    }
    async function getSectionHtml_(name){
      const key = String(name || "").trim();
      if (!key) return "";
      if (sectionCache.has(key)) return sectionCache.get(key);
      const res = await apiGet("getSection", { name: key });
      if (!res || !res.ok) throw new Error(res?.message || ("GET_SECTION_FAILED: " + key));
      const html = String(res.html || "");
      sectionCache.set(key, html);
      return html;
    }

    function buildTokensMetaComment_(vars){
      const fallbackKeys = [
        "THUMB_URL","CANONICAL_URL","YEAR","MONTH",
        "YEAR_NAV_JSON",
        "IMG_ID","IMG_SRC","IMG_HREF","IMG_OW","IMG_OH",
        "IMG_ALT","IMG_TITLE","IMG_SNIPPET","ZOOM_LABEL"
      ];
      const reserved = new Set(["TITLE","NAV","FOOTER","title","nav","footer"]);
      const slotNames = Array.isArray(templateState?.slots) ? templateState.slots : [];
      for (const s of slotNames){
        const a = String(s || "").trim();
        if (!a) continue;
        reserved.add(a);
        reserved.add(a.toUpperCase());
      }
      const keySet = new Set();
      const tplTokens = Array.isArray(templateState?.tokens) ? templateState.tokens : [];
      if (tplTokens.length){
        tplTokens.forEach(k => keySet.add(String(k || "").trim()));
      }else{
        fallbackKeys.forEach(k => keySet.add(k));
      }
      if (vars && typeof vars === "object"){
        Object.keys(vars).forEach(k => keySet.add(String(k || "").trim()));
      }
      const obj = {};
      for (const key0 of keySet){
        const key = String(key0 || "").trim();
        if (!key) continue;
        if (reserved.has(key)) continue;
        if (/^BODY(_\d+)?$/i.test(key)) continue;
        if (!/^[A-Za-z0-9_]+$/.test(key)) continue;
        const v = vars ? vars[key] : undefined;
        if (v === undefined || v === null) continue;
        const s = String(v);
        if (s.trim() === "") continue;
        obj[key] = s;
      }
      if (!Object.keys(obj).length) return "";
      return `\n`;
    }

    function extractTokensMetaFromHtml_(html){
      const t = String(html || "");
      const m = t.match(//i);
      if (!m) return {};
      try{
        const obj = JSON.parse(m[1]);
        return (obj && typeof obj === "object" && !Array.isArray(obj)) ? obj : {};
      }catch(_){ return {}; }
    }

    function escapeRegExp(s){
      return String(s||"").replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function replaceTokens_(html, vars){
      let out = String(html || "");
      if (!vars || typeof vars !== "object") return out;
      for (const [k,v] of Object.entries(vars)){
        const key = String(k || "").trim();
        if (!key) continue;
        const re = new RegExp(`{{\\s*${escapeRegExp(key)}\\s*}}`, "g");
        out = out.replace(re, String(v ?? ""));
      }
      out = out.replace(/\{\s*zoom_label\s*\}/gi, String(vars?.ZOOM_LABEL ?? vars?.zoom_label ?? ""));
      return out;
    }

    // ===== IMG_SLOT helpers =====
    function parseImgSlotIndex_(v){
      const m = String(v || "").trim().toUpperCase().match(/^IMG_(\d+)$/);
      return m ? Number(m[1]) : 0;
    }
    function applyImgSlotNumbering_(html, imgSlot){
      const n = parseImgSlotIndex_(imgSlot);
      if (!n) return String(html || "");
      const baseTokens = ["IMG_ID","IMG_SRC","IMG_HREF","IMG_OW","IMG_OH","IMG_ALT","IMG_TITLE","IMG_SNIPPET","THUMB_URL"];
      let out = String(html || "");
      for (const t of baseTokens){
        const re = new RegExp(`{{\\s*${escapeRegExp(t)}\\s*}}`, "g");
        out = out.replace(re, `{{${t}_${n}}}`);
      }
      return out;
    }
    function getImgTokenIndices_(tokenNames){
      const idx = new Set();
      (tokenNames || []).forEach(t=>{
        const m = String(t||"").trim().match(/^(IMG_(?:ID|SRC|HREF|OW|OH|ALT|TITLE|SNIPPET)|THUMB_URL)_(\d+)$/);
        if (m) idx.add(Number(m[2]));
      });
      return Array.from(idx).filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
    }

    function collectSlotsFromManifest_(manifest){
      const slots = [];
      const seen = new Set();
      const sections = Array.isArray(manifest?.sections) ? manifest.sections : [];
      for (const sec of sections){
        const slot = (sec && typeof sec === "object" && sec.vars && sec.vars.SLOT) ? String(sec.vars.SLOT).trim() : "";
        if (slot && !seen.has(slot)){
          seen.add(slot);
          slots.push(slot);
        }
      }
      if (slots.length === 0) slots.push("BODY");
      return slots;
    }

    async function collectTokensFromTemplate_(manifest, slotNames){
      const supported = new Set([
        "THUMB_URL","CANONICAL_URL","YEAR","MONTH","YEAR_NAV_JSON",
        "IMG_ID","IMG_SRC","IMG_HREF","IMG_OW","IMG_OH","IMG_ALT","IMG_TITLE","IMG_SNIPPET","ZOOM_LABEL"
      ]);
      const imgFamily = new Set([
        "IMG_ID","IMG_SRC","IMG_HREF","IMG_OW","IMG_OH","IMG_ALT","IMG_TITLE","IMG_SNIPPET","THUMB_URL"
      ]);
      const reserved = new Set(["TITLE","NAV","FOOTER","BODY"]);
      (slotNames || []).forEach(s=>reserved.add(String(s)));
      const found = new Set();
      const sections = Array.isArray(manifest?.sections) ? manifest.sections : [];
      for (const sec of sections){
        const name = (typeof sec === "string") ? sec.trim() : (sec && typeof sec === "object") ? String(sec.name || "").trim() : "";
        if (!name) continue;
        const secVarsObj = (sec && typeof sec === "object" && sec.vars && typeof sec.vars === "object") ? sec.vars : {};
        const imgSlotN = parseImgSlotIndex_(secVarsObj.IMG_SLOT);
        let html = "";
        try{ html = await getSectionHtml_(name); } catch(e){ html = ""; }
        const re = /{{\s*([A-Z0-9_]+)\s*}}/g;
        let m;
        while ((m = re.exec(String(html))) !== null){
          const token = String(m[1] || "").trim();
          if (!token) continue;
          if (reserved.has(token)) continue;
          if (imgSlotN && imgFamily.has(token)){
            found.add(`${token}_${imgSlotN}`);
            continue;
          }
          if (supported.has(token)) found.add(token);
        }
        if (/\{\s*zoom_label\s*\}/i.test(String(html))) {
          if (!reserved.has("ZOOM_LABEL") && supported.has("ZOOM_LABEL")) found.add("ZOOM_LABEL");
        }
      }
      return Array.from(found);
    }

    // ===== ì„¹ì…˜ ê´€ë¦¬ ë¡œì§ =====
    async function refreshSectionState_() {
      try {
        setBusy_(true);
        const savedSlots = getSlotValues_();
        const savedTokens = getTokenValues_();
        const simulatedManifest = { ...templateState.manifest, sections: templateState.sections };
        templateState.slots = collectSlotsFromManifest_(simulatedManifest);
        templateState.tokens = await collectTokensFromTemplate_(simulatedManifest, templateState.slots);
        renderDynamicFields_(); 
        renderSortableList_();
        setSlotValues_(savedSlots);
        setTokenValues_(savedTokens);
        scheduleAssemblePreview_();
      } catch (e) {
        setStatus("ì„¹ì…˜ ê°±ì‹  ì˜¤ë¥˜: " + e.message, false);
        setDebug(e.stack);
      } finally {
        setBusy_(false);
      }
    }

    function renderDynamicFields_() {
      const slotBox = $("slotFields");
      const tokBox = $("tokenFields");
      slotBox.innerHTML = "";
      tokBox.innerHTML = "";

      const sections = templateState.sections || [];
      sections.forEach((sec, i) => {
        const secName = (typeof sec === "string") ? sec : (sec.name || "Unknown");
        const slotKey = (typeof sec === "object" && sec.vars && sec.vars.SLOT) ? sec.vars.SLOT : null;
        const wrap = document.createElement("div");
        wrap.className = "pm-dyn-item";
        let html = `
          <div class="pm-dyn-head">
            <div class="pm-dyn-key" style="display:flex; align-items:center; gap:4px;">
              <button type="button" class="pm-btn small ghost" onclick="window.moveSection_(${i}, -1)" ${i === 0 ? 'disabled' : ''}>â†‘</button>
              <button type="button" class="pm-btn small ghost" onclick="window.moveSection_(${i}, 1)" ${i === sections.length - 1 ? 'disabled' : ''}>â†“</button>
              <span class="pm-pill" style="margin-left:4px;">${i+1}. ${escapeHtml(secName)}</span>
              ${slotKey ? `<span style="font-weight:bold; color:#2563eb;">[${escapeHtml(slotKey)}]</span>` : `<span class="pm-small pm-muted">(ê³ ì •)</span>`}
            </div>
            <div style="display:flex; gap:4px;">
               <button type="button" class="pm-btn small danger" onclick="window.deleteSection_(${i})">ì‚­ì œ</button>
               ${slotKey ? `<button type="button" class="pm-btn small ghost pm-dyn-clear" data-clear-slot="${escapeHtml(slotKey)}">ë¹„ìš°ê¸°</button>` : ''}
            </div>
          </div>
        `;
        if (slotKey) {
          html += `<textarea class="pm-textarea pm-dyn-textarea" data-slot="${escapeHtml(slotKey)}" placeholder="SLOT ì…ë ¥: ${escapeHtml(slotKey)}"></textarea>`;
        } else {
          html += `<div class="pm-small pm-muted" style="padding:10px;">ì´ ì„¹ì…˜ì€ ì…ë ¥ ê°€ëŠ¥í•œ SLOT(ë³¸ë¬¸)ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        }
        wrap.innerHTML = html;
        slotBox.appendChild(wrap);
      });

      const tokenNames = templateState.tokens || [];
      let __imgListCache = null; 

      async function initImgPickerUIForIndex_(n){
        const suffix = n ? String(n) : "base";
        const sel = document.getElementById(`imgDbSelect_${suffix}`);
        const btn = document.getElementById(`btnImgDbApply_${suffix}`);
        const pv  = document.getElementById(`imgDbPreview_${suffix}`);
        const lnk = document.getElementById(`imgDbLink_${suffix}`);
        
        if (!sel || !btn) return;
        sel.innerHTML = `<option value="">ì´ë¯¸ì§€ ì„ íƒ...</option>`;
        try{
          if (!__imgListCache) __imgListCache = await imgList_();
          for (const it of __imgListCache){
            const id = String(it.id || "");
            const name = String(it.base_name || it.drive_name || "");
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = name ? `${id} â€” ${name}` : id;
            sel.appendChild(opt);
          }
          sel.addEventListener("change", () => {
            const id = sel.value;
            const hit = (__imgListCache || []).find(x => String(x.id) === String(id));
            if (!hit) { 
              if (pv) pv.innerHTML = `<span style="font-size:24px; opacity:0.2;">ğŸ–¼ï¸</span>`;
              if (lnk) lnk.style.display = "none";
              return; 
            }
            const thumb = imgThumbUrl_(hit.drive_file_id) || hit.img_src || "";
            const href  = hit.img_href || hit.drive_view_url || "";
            if (pv) pv.innerHTML = thumb ? `<img src="${thumb}" style="width:100%; height:100%; object-fit:cover;" />` : `<span class="pm-small pm-muted">No Thumb</span>`;
            if (lnk) { lnk.href = href; lnk.style.display = "inline"; }
          });
          btn.addEventListener("click", async () => {
            const id = sel.value;
            if (!id) { setStatus("ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.", false); return; }
            setStatus("ì´ë¯¸ì§€ ìƒì„¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", true);
            const item = await imgGet_(id);
            if (!item) { setStatus("ì´ë¯¸ì§€ ìƒì„¸ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", false); return; }
            const toksArr = (templateState.tokens || []);
            const toks = new Set(toksArr);
            const patch = {};
            const put = (baseKey, val) => {
              if (n){
                const k = `${baseKey}_${n}`;
                if (toks.has(k)) patch[k] = val;
              } else {
                if (toks.has(baseKey)) patch[baseKey] = val;
              }
            };
            put("IMG_ID", item.id || "");
            put("IMG_SRC", imgThumbUrl_(item.drive_file_id) || item.img_src || "");
            put("IMG_HREF", item.img_href || item.drive_view_url || "");
            put("IMG_ALT", item.img_alt || "");
            put("IMG_TITLE", item.img_title || "");
            put("IMG_SNIPPET", item.snippet || "");
            put("IMG_OW", item.orig_w || "");
            put("IMG_OH", item.orig_h || "");
            put("THUMB_URL", imgThumbUrl_(item.drive_file_id) || item.img_src || "");
            patchTokenValues_(patch);
            scheduleAssemblePreview_();
            setStatus(`ì´ë¯¸ì§€ í† í° ì ìš© ì™„ë£Œ (${id})`, true);
          });
        }catch(e){
          setStatus("ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", false);
        }
      }

      const needsImg = (tokenNames || []).some(t => /^IMG_/.test(String(t||""))) || (tokenNames || []).includes("THUMB_URL");
      if (needsImg) {
        const indices = getImgTokenIndices_(tokenNames || []);
        const groups = indices.length ? indices : [0];
        for (const n of groups){
          const suffix = n ? String(n) : "base";
          const label  = n ? `IMG_${n}` : "IMG";
          const title  = n ? `ì´ë¯¸ì§€ ê·¸ë£¹ ${n}` : "ë©”ì¸ ì´ë¯¸ì§€";
          const wrap = document.createElement("div");
          wrap.className = "pm-dyn-item";
          wrap.style.gridColumn = "1 / -1"; 
          wrap.innerHTML = `
            <div style="display:flex; gap:16px; align-items:start;">
                <div id="imgDbPreview_${suffix}" style="width:120px; height:100px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0;">
                    <span style="font-size:24px; opacity:0.2; user-select:none;">ğŸ–¼ï¸</span>
                </div>
                <div style="flex:1; min-width:0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <div class="pm-dyn-key" style="margin:0; font-size:14px;">${escapeHtml(title)} <span style="color:#94a3b8; font-weight:normal; font-size:12px; margin-left:4px;">[${label}]</span></div>
                        <a id="imgDbLink_${suffix}" href="#" target="_blank" class="pm-link" style="font-size:12px; display:none;">ì›ë³¸ ë³´ê¸° â†—</a>
                    </div>
                    <select id="imgDbSelect_${suffix}" class="pm-select" style="width:100%; margin-bottom:8px; height:38px;"></select>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button id="btnImgDbApply_${suffix}" class="pm-btn small primary" style="white-space:nowrap;">ì„ íƒê°’ ì ìš©</button>
                        <span class="pm-muted pm-small" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">â† ì„ íƒ ì‹œ <strong>${label}_*</strong> í•„ë“œ ìë™ ì…ë ¥</span>
                    </div>
                </div>
            </div>`;
          tokBox.appendChild(wrap);
          initImgPickerUIForIndex_(n); 
        }
      }

      tokenNames.forEach(tok => {
        const wrap = document.createElement("div");
        wrap.className = "pm-dyn-item";
        const isYearNav = String(tok) === "YEAR_NAV_JSON";
        wrap.innerHTML = `
            <div class="pm-dyn-head">
              <div class="pm-dyn-key">${escapeHtml(tok)}</div>
              <button type="button" class="pm-btn small ghost pm-dyn-clear" data-clear-token="${escapeHtml(tok)}">ë¹„ìš°ê¸°</button>
            </div>
            ${isYearNav ? `<textarea class="pm-textarea pm-dyn-textarea" data-token="${escapeHtml(tok)}" placeholder="${escapeHtml(tokenPlaceholder_(tok))}"></textarea>` : `<input class="pm-input" data-token="${escapeHtml(tok)}" style="width:100%;" placeholder="${escapeHtml(tokenPlaceholder_(tok))}" />`}
        `;
        tokBox.appendChild(wrap);
      });
      attachDynamicPreviewListeners_();
    }

    function renderSortableList_() {
      const listEl = document.getElementById("sectionSortList");
      if (!listEl) return;
      listEl.innerHTML = "";
      const sections = templateState.sections || [];
      sections.forEach((sec, idx) => {
        const secName = (typeof sec === "string") ? sec : (sec.name || "Unknown");
        const slotName = (typeof sec === "object" && sec.vars && sec.vars.SLOT) ? sec.vars.SLOT : "";
        const li = document.createElement("li");
        li.className = "pm-sort-item";
        li.draggable = true; li.dataset.index = idx;
        li.innerHTML = `<div class="pm-sort-idx">${idx + 1}</div><div class="pm-sort-name" title="${secName}">${secName}${slotName ? `<br><span style="color:#2563eb; font-size:11px;">[${slotName}]</span>` : ''}</div><div style="color:#cbd5e1; cursor:grab;">â˜°</div>`;
        addDragEvents_(li);
        listEl.appendChild(li);
      });
    }

    let dragStartIndex = -1;
    function addDragEvents_(li) {
      li.addEventListener("dragstart", (e) => { dragStartIndex = +li.dataset.index; li.classList.add("dragging"); e.dataTransfer.effectAllowed = "move"; });
      li.addEventListener("dragend", () => { li.classList.remove("dragging"); document.querySelectorAll(".pm-sort-item").forEach(el => el.classList.remove("drag-over")); });
      li.addEventListener("dragover", (e) => { e.preventDefault(); });
      li.addEventListener("drop", (e) => { e.preventDefault(); const dragEndIndex = +li.dataset.index; if (dragStartIndex !== -1 && dragStartIndex !== dragEndIndex) { moveSectionByIndex_(dragStartIndex, dragEndIndex); } });
    }
    function moveSectionByIndex_(from, to) {
      const arr = templateState.sections;
      const [moved] = arr.splice(from, 1);
      arr.splice(to, 0, moved);
      refreshSectionState_();
    }
    window.moveSection_ = function(index, direction) {
      const newIndex = index + direction;
      const arr = templateState.sections;
      if (newIndex < 0 || newIndex >= arr.length) return;
      [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
      refreshSectionState_();
    };
    window.deleteSection_ = function(index) {
      if (!confirm("ì´ ì„¹ì…˜ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      templateState.sections.splice(index, 1);
      refreshSectionState_();
    };

    function tokenPlaceholder_(tok){
      switch(String(tok||"")){
        case "THUMB_URL": return "ì˜ˆ: https://... (ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL)";
        case "CANONICAL_URL": return "ì˜ˆ: https://www.cheesehistory.com/... (ì •ì‹ URL)";
        case "YEAR": return "ì˜ˆ: 2026";
        case "MONTH": return "ì˜ˆ: 01";
        case "YEAR_NAV_JSON": return "ì¤„ì…ë ¥ ì˜ˆ:\n2022,https://...\n2023,https://...";
        case "ZOOM_LABEL": return "ì˜ˆ: ì´ë¯¸ì§€ í¬ê²Œë³´ê¸°";
        default: return "";
      }
    }

    function getSlotValues_(){
      const out = {};
      document.querySelectorAll("[data-slot]").forEach(el=>{ const k = el.getAttribute("data-slot"); if(k) out[k] = (el.value || ""); });
      return out;
    }
    function setSlotValues_(map){
      const m = map || {};
      document.querySelectorAll("[data-slot]").forEach(el=>{ const k = el.getAttribute("data-slot"); if(k) el.value = (m[k] !== undefined && m[k] !== null) ? String(m[k]) : ""; });
    }
    function getTokenValues_(){
      const out = {};
      document.querySelectorAll("[data-token]").forEach(el=>{ const k = el.getAttribute("data-token"); if(k) out[k] = (el.value || ""); });
      return out;
    }
    function setTokenValues_(map){
      const m = map || {};
      document.querySelectorAll("[data-token]").forEach(el=>{ const k = el.getAttribute("data-token"); if(k) el.value = (m[k] !== undefined && m[k] !== null) ? String(m[k]) : ""; });
    }
    function patchTokenValues_(map){
      const m = map || {};
      document.querySelectorAll("[data-token]").forEach(el=>{ const k = el.getAttribute("data-token"); if(k && m[k] !== undefined) el.value = String(m[k]); });
    }
    function compactVars_(obj){
      const out = {};
      for (const [k,v] of Object.entries(obj || {})){ const s = (v === undefined || v === null) ? "" : String(v); if (s.trim() !== "") out[k] = s; }
      return out;
    }
    function buildVarsForAssemble_(){
      const title = $("title").value.trim();
      const slotVals  = getSlotValues_();
      const tokenVals = getTokenValues_();
      const z = String((tokenVals.ZOOM_LABEL ?? tokenVals.zoom_label ?? "")).trim();
      tokenVals.ZOOM_LABEL = z || "ì´ë¯¸ì§€ í¬ê²Œë³´ê¸°";
      tokenVals.zoom_label = tokenVals.ZOOM_LABEL;
      if (tokenVals.YEAR_NAV_JSON && !String(tokenVals.YEAR_NAV_JSON).trim().startsWith("[")) {
        tokenVals.YEAR_NAV_JSON = lineToYearNavJson_(tokenVals.YEAR_NAV_JSON);
      }
      return { TITLE: title, title: title, NAV: "", FOOTER: "", nav: "", footer: "", ...compactVars_(slotVals), ...compactVars_(tokenVals) };
    }
    function lineToYearNavJson_(txt){
      return JSON.stringify(String(txt||"").trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
        const idx = line.indexOf(","); if(idx<0) return null;
        const y = line.slice(0,idx).trim(); const h = line.slice(idx+1).trim();
        return y ? {year:y, href:h} : null;
      }).filter(Boolean));
    }

    async function analyzeAndRenderTemplate_(tplId){
      templateState.templateId = tplId || "";
      templateState.manifest = null;
      templateState.sections = []; 
      templateState.slots = [];
      templateState.tokens = [];
      if (!tplId){ renderDynamicFields_(); renderSortableList_(); return; }
      try{
        const manifest = await getTemplateManifest_(tplId);
        templateState.manifest = manifest;
        if (manifest.sections) templateState.sections = [...manifest.sections];
        const slotNames = collectSlotsFromManifest_(manifest);
        const tokenNames = await collectTokensFromTemplate_(manifest, slotNames);
        templateState.slots = slotNames;
        templateState.tokens = tokenNames;
        const prevSlots = getSlotValues_();
        const prevToks  = getTokenValues_();
        renderDynamicFields_();
        renderSortableList_();
        setSlotValues_(prevSlots);
        setTokenValues_(prevToks);
      }catch(e){
        renderDynamicFields_();
        setStatus("í…œí”Œë¦¿ ë¶„ì„ ì‹¤íŒ¨: " + (e?.message || e), false);
        setDebug(String(e && e.stack ? e.stack : e));
      }
    }

    async function assembleHtmlFromManifest_(manifest, templateId, vars){
      const tid = String(manifest?.template_id || manifest?.id || templateId).trim();
      const tver = String(manifest?.template_ver || manifest?.ver || "").trim();
      const sections = Array.isArray(manifest?.sections) ? manifest.sections : [];
      if (!sections.length) throw new Error("TEMPLATE_SECTIONS_EMPTY");
      const parts = [];
      for (const sec of sections){
        const secName = (typeof sec === "string") ? sec.trim() : (sec && typeof sec === "object") ? String(sec.name || "").trim() : "";
        if (!secName) continue;
        let secHtml = await getSectionHtml_(secName);
        const secVarsRaw = (sec && typeof sec === "object" && sec.vars && typeof sec.vars === "object") ? sec.vars : {};
        const slotName = (secVarsRaw && secVarsRaw.SLOT) ? String(secVarsRaw.SLOT).trim() : "";
        if (slotName){
          const slotVal = (vars && (vars[slotName] ?? vars[String(slotName).toUpperCase()])) ?? "";
          if (String(slotVal).length > 0){
            secHtml = secHtml.replace(/{{\s*BODY\s*}}/g, String(slotVal));
          } else {
            secHtml = secHtml.replace(/{{\s*BODY\s*}}/g, `{{${slotName}}}`);
          }
          secHtml = secHtml
            .replace(//gi, ``)
            .replace(//gi, ``)
            .replace(//gi, ``)
            .replace(//gi, ``);
        }
        const imgSlot = (secVarsRaw && secVarsRaw.IMG_SLOT) ? String(secVarsRaw.IMG_SLOT).trim() : "";
        if (imgSlot) secHtml = applyImgSlotNumbering_(secHtml, imgSlot);
        const secVars = { ...secVarsRaw };
        secHtml = replaceTokens_(secHtml, { ...vars, ...secVars });
        parts.push(secHtml);
      }
      let assembled = parts.join("\n");
      const metaHeader = `\n` + (tver ? `\n` : "");
      const tokensMeta = buildTokensMetaComment_(vars);
      return { html: metaHeader + tokensMeta + assembled, manifest };
    }

    async function assembleHtmlFromTemplate_(templateId, vars){
      const manifest = await getTemplateManifest_(templateId);
      return assembleHtmlFromManifest_(manifest, templateId, vars);
    }

    async function assembleHtmlUsingState_(templateId, vars){
      if (!templateId) throw new Error("TEMPLATE_ID_REQUIRED");
      if (!templateState.manifest || templateState.templateId !== templateId){
        templateState.templateId = templateId;
        templateState.manifest = await getTemplateManifest_(templateId);
        templateState.sections = [...(templateState.manifest.sections || [])];
      }
      const currentManifest = { ...templateState.manifest, sections: templateState.sections };
      return assembleHtmlFromManifest_(currentManifest, templateId, vars);
    }

    async function initTemplateSelect_(){
      const sel = $("templateSelect");
      sel.innerHTML = "";
      sel.appendChild(new Option("í…œí”Œë¦¿ ì„ íƒ...", ""));
      try{
        setStatus("í…œí”Œë¦¿ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘(Drive)...", true);
        const items = await listTemplates_();
        for (const it of items){
          const id = String(it.id || it.template_id || it.name || "").replace(/\.json$/i, "").trim();
          if (!id) continue;
          sel.appendChild(new Option(id, id));
        }
        setStatus(`í…œí”Œë¦¿ ${items.length}ê°œ ë¡œë“œë¨`, true);
      }catch(e){
        setStatus("í…œí”Œë¦¿ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e.message, false);
      }
    }

    async function applyTemplateNew(){
      const tplId = $("templateSelect").value;
      if (!tplId) return setStatus("í…œí”Œë¦¿ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.", false);
      try{
        setBusy_(true);
        hideBanner();
        setStatus("í…œí”Œë¦¿ ì ìš©(ìƒˆë¡œ) ì¤‘...", true);
        await analyzeAndRenderTemplate_(tplId);
        setSlotValues_({});
        const out = await assembleHtmlUsingState_(tplId, buildVarsForAssemble_());
        $("html").value = out.html;
        syncCharCount();
        setStatus("í…œí”Œë¦¿ ì ìš© ì™„ë£Œ(ìƒˆë¡œ).", true);
      }catch(e){
        setStatus("í…œí”Œë¦¿ ì ìš© ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function rewrapTemplateKeepBody(){
      const tplId = $("templateSelect").value;
      if (!tplId) return setStatus("í…œí”Œë¦¿ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.", false);
      try{
        setBusy_(true);
        hideBanner();
        setStatus("ë˜í¼ ì¬ì ìš©(ë³¸ë¬¸ ìœ ì§€) ì¤‘...", true);
        const out = await assembleHtmlUsingState_(tplId, buildVarsForAssemble_());
        $("html").value = out.html;
        syncCharCount();
        setStatus("ë˜í¼ ì¬ì ìš© ì™„ë£Œ(ë³¸ë¬¸ ìœ ì§€).", true);
      }catch(e){
        setStatus("ë˜í¼ ì¬ì ìš© ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    // [ìˆ˜ì •] ëª¨ë‹¬ìš© ë¦¬ìŠ¤íŠ¸ ë¡œì§
    async function refreshList(){
      try{
        setBusy_(true);
        setStatus("ëª©ë¡ ë°ì´í„° ê°±ì‹  ì¤‘...", true);
        const res = await apiGet("listPosts");
        if (!res || !res.ok) return setStatus("ëª©ë¡ ì‹¤íŒ¨: " + (res?.message||""), false);
        _cachedPostList = res.items || [];
        setStatus(`ëª©ë¡ ê°±ì‹  ì™„ë£Œ (${_cachedPostList.length}ê±´)`, true);
        // ëª¨ë‹¬ ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
        const listEl = $("postModalList");
        if (listEl && listEl.offsetParent !== null) {
           renderPostModalList_(_cachedPostList);
        }
      }catch(e){
        setStatus("ëª©ë¡ ì˜¤ë¥˜: " + e.message, false);
      }finally{
        setBusy_(false);
      }
    }

    // [ìˆ˜ì •] DB ë¼ë²¨ ìƒë‹¨ë°˜ì˜, ì—ëŸ¬ì½”ë“œ ì œê±°
    async function loadPost(){
      if (!$("id")) return;
      const id = $("id").value.trim();
      if (!id) return setStatus("IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        hideBanner();
        setStatus(`ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘: ${id}`, true);
        const res = await apiGet("getPost", { id });
        if (!res || !res.ok) return setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", false);
        current = res.post;
        $("id").value = current.id;
        $("title").value = current.title || "";
        $("html").value = current.html || "";
        
        $("newPostConfig").style.display = "none";
        $("currentPostInfo").textContent = `í¸ì§‘ ì¤‘: ${current.title || current.id}`;
        $("currentPostInfo").style.background = "#dbeafe";
        $("currentPostInfo").style.color = "#1e40af";

        const meta = readTemplateMeta_(current.html || "");
        if (meta.template_id && $("templateSelect")) {
          $("templateSelect").value = meta.template_id;
          await analyzeAndRenderTemplate_(meta.template_id);
        } else {
          await analyzeAndRenderTemplate_($("templateSelect").value || "");
        }
        setSlotValues_(extractBodies_(current.html || ""));
        setTokenValues_(extractTokensMetaFromHtml_(current.html || ""));
        syncCharCount();
        setMeta(current);
        setBloggerMeta(null);
        setStickyId_();
        
        const dbLabels = current.blogger_labels || "";
        if($("bloggerLabelsTop")) $("bloggerLabelsTop").value = dbLabels; 
        setStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", true);
      }catch(e){
        setStatus("ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function exportToDrive(skipReload = false){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        hideBanner();
        const tplId = $("templateSelect").value;
        if (tplId){
          setStatus("ì €ì¥ ì „ ìµœì¢… HTML ìƒì„±(í…œí”Œë¦¿ ì¡°ë¦½) ì¤‘...", true);
          const out = await assembleHtmlUsingState_(tplId, buildVarsForAssemble_());
          $("html").value = out.html;
          syncCharCount();
        }
        const payload = { id, title: $("title").value.trim(), html: $("html").value };
        setStatus("Drive ì €ì¥/ì—…ë°ì´íŠ¸ ì¤‘...", true);
        const res = await apiPost("driveUpsert", payload);
        if (!res || !res.ok) return setStatus("Drive ì €ì¥ ì‹¤íŒ¨: " + (res?.message||""), false);
        setStatus(`Drive ì €ì¥ ì™„ë£Œ: ${res.file?.name || ""}`, true);
        if (!skipReload) { await refreshList(); await loadPost(); }
      }catch(e){
        setStatus("Drive ì €ì¥ ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function importFromDrive(){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        hideBanner();
        setStatus("Driveì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", true);
        const res = await apiGet("driveReadById", { id });
        if (!res || !res.ok) return setStatus("Drive ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (res?.message||""), false);
        $("html").value = res.html || "";
        syncCharCount();
        const html = $("html").value || "";
        const meta = readTemplateMeta_(html);
        if (meta.template_id) {
          $("templateSelect").value = meta.template_id;
          await analyzeAndRenderTemplate_(meta.template_id);
        } else {
          await analyzeAndRenderTemplate_($("templateSelect").value || "");
        }
        setSlotValues_(extractBodies_(html));
        setTokenValues_(extractTokensMetaFromHtml_(html));
        setStickyId_();
        setStatus("Drive ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", true);
      }catch(e){
        setStatus("Drive ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function exportToBlogger(publishState = null){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        const tplId = $("templateSelect").value;
        if (tplId){
          setStatus("ì—…ë¡œë“œ ì „ ìµœì¢… HTML ìƒì„±(í…œí”Œë¦¿ ì¡°ë¦½) ì¤‘...", true);
          const out = await assembleHtmlUsingState_(tplId, buildVarsForAssemble_());
          $("html").value = out.html;
          syncCharCount();
        }
        const labelsCsv = $("bloggerLabelsTop").value.trim();
        const actionUi = $("bloggerLabelsActionTop").value || "replace";
        const payload = {
          id,
          title: $("title").value.trim(),
          html: $("html").value,
          publish: (publishState !== null) ? String(publishState) : "keep", 
          labels: labelsCsv,
          labels_action: labelsCsv ? actionUi : "keep"
        };
        hideBanner();
        setStatus("Blogger ì—…ë¡œë“œ/ìˆ˜ì • ì¤‘...", true);
        const res = await apiPost("bloggerUpsert", payload);
        if (!res || !res.ok) return setStatus("Blogger ì—…ë¡œë“œ ì‹¤íŒ¨: " + (res?.message||""), false);
        setBloggerMeta({ url: res.url, post_id: res.post_id, status: res.status });
        setStatus(`Blogger ${res.status === 'published' ? 'ë°œí–‰' : 'ì´ˆì•ˆ'} ì™„ë£Œ`, true);
      }catch(e){
        setStatus("Blogger ì—…ë¡œë“œ ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function importFromBlogger(){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        hideBanner();
        setStatus("Bloggerì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", true);
        const res = await apiGet("bloggerRead", { id });
        if (!res || !res.ok) return setStatus("Blogger ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (res?.message||""), false);
        $("title").value = res.title || $("title").value;
        $("html").value = res.html || "";
        syncCharCount();
        const html = $("html").value || "";
        const meta = readTemplateMeta_(html);
        if (meta.template_id) {
          $("templateSelect").value = meta.template_id;
          await analyzeAndRenderTemplate_(meta.template_id);
        } else {
          await analyzeAndRenderTemplate_($("templateSelect").value || "");
        }
        setSlotValues_(extractBodies_(html));
        setTokenValues_(extractTokensMetaFromHtml_(html));
        const labelsArr = Array.isArray(res.labels) ? res.labels : [];
        if($("bloggerLabelsTop")) $("bloggerLabelsTop").value = labelsArr.join(", ");
        setBloggerMeta({ url: res.url, post_id: res.post_id, status: "loaded" });
        setStickyId_();
        setStatus("Blogger ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", true);
      }catch(e){
        setStatus("Blogger ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    async function patchBloggerLabels(){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      const labels = $("bloggerLabelsTop").value.trim(); 
      const action = $("bloggerLabelsActionTop").value || "replace";
      try{
        setBusy_(true);
        hideBanner();
        setStatus("ë¼ë²¨ ì ìš© ì¤‘...", true);
        const res = await apiPost("bloggerPatchLabels", { id, labels, action });
        if (!res || !res.ok) return setStatus("ë¼ë²¨ ì ìš© ì‹¤íŒ¨: " + (res?.message||""), false);
        setStatus(`ë¼ë²¨ ì ìš© ì™„ë£Œ (${(res.labels||[]).length}ê°œ)`, true);
        if (res.url) setBloggerMeta({ url: res.url, post_id: res.post_id, status: "labels_updated" });
      }catch(e){
        setStatus("ë¼ë²¨ ì ìš© ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    function clearEditor(){
      $("title").value = "";
      $("html").value = "";
      setSlotValues_({});
      setTokenValues_({});
      syncCharCount();
      setStatus("í¸ì§‘ì°½ì„ ë¹„ì› ìŠµë‹ˆë‹¤.", true);
      setStickyId_();
    }

    async function pipelinePublish_(publish){
      const id = getTargetId();
      if (!id) return setStatus("idê°€ í•„ìš”í•©ë‹ˆë‹¤.", false);
      try{
        setBusy_(true);
        setStatus(publish ? "ì›í´ë¦­ ë°œí–‰ ì‹œì‘..." : "ì›í´ë¦­ ì´ˆì•ˆ ì €ì¥ ì‹œì‘...", true);
        await exportToDrive(true);
        await exportToBlogger(publish);
        setStatus(publish ? "ì›í´ë¦­ ë°œí–‰ ì™„ë£Œ" : "ì›í´ë¦­ ì´ˆì•ˆ ì €ì¥ ì™„ë£Œ", true);
      }catch(e){
        setStatus("ì›í´ë¦­ ì‘ì—… ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }

    // ID ìƒì„± ë¡œì§
    function mapCategoryToPrefix(cat){
      const m = { monthly_news:"NM", timeline_kr_cn_jp:"TL", genealogy_series:"GN", etc:"ETC" };
      return m[cat] || "POST";
    }
    function yyyymmddNow(){
      const d = new Date();
      const z = n=>n<10?"0"+n:n;
      return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}`;
    }
    async function regenId(){
      const cat = $("category").value;
      if (!cat) return setStatus("ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.", false);
      if (cat === "manual"){
        setStatus("ìˆ˜ë™ì…ë ¥ ë¶„ë¥˜ì…ë‹ˆë‹¤. IDë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.", true);
        $("id").disabled = false; $("id").focus(); setStickyId_(); return;
      }
      const prefix = mapCategoryToPrefix(cat);
      const base = `${prefix}_${yyyymmddNow()}_`;
      try{
        setBusy_(true);
        setStatus("ID ìƒì„± ì¤‘...", true);
        const res = await apiGet("listPosts");
        if (!res || !res.ok) throw new Error(res?.message || "LIST_FAILED");
        let maxSeq = 0;
        for (const it of (res.items || [])){
          const id = String(it.id || "");
          if (!id.startsWith(base)) continue;
          const n = parseInt(id.slice(base.length), 10);
          if (!isNaN(n)) maxSeq = Math.max(maxSeq, n);
        }
        const nextSeq = String(maxSeq + 1).padStart(2, "0");
        $("id").value = `${base}${nextSeq}`;
        $("id").disabled = true;
        setStickyId_();
        setStatus(`ID ìƒì„± ì™„ë£Œ: ${$("id").value}`, true);
      }catch(e){
        setStatus("ID ìƒì„± ì˜¤ë¥˜: " + e.message, false);
      }finally{ setBusy_(false); }
    }
    function onCategoryChange(){
      const cat = $("category").value;
      if (cat === "manual"){
        $("id").disabled = false; setStatus("ìˆ˜ë™ì…ë ¥: IDë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.", true); setStickyId_(); return;
      }
      $("id").disabled = true;
      if (cat) regenId();
    }

    $("templateSelect").addEventListener("change", async ()=>{
      const tplId = $("templateSelect").value || "";
      await analyzeAndRenderTemplate_(tplId);
      attachDynamicPreviewListeners_();
      scheduleAssemblePreview_();
    });

    // ë²„íŠ¼ ì—°ê²°
    $("btnRefresh").addEventListener("click", ()=>refreshList());
    $("btnApplyTemplate").addEventListener("click", applyTemplateNew);
    $("btnRewrapTemplate").addEventListener("click", rewrapTemplateKeepBody);
    $("btnRegenId").addEventListener("click", regenId);
    $("category").addEventListener("change", onCategoryChange);

    $("btnQuickPublish").addEventListener("click", ()=>pipelinePublish_(true));
    $("btnQuickDraft").addEventListener("click", ()=>pipelinePublish_(false));
    $("btnQuickDriveSave").addEventListener("click", ()=>exportToDrive(false));
    $("btnQuickBloggerUpsert").addEventListener("click", ()=>exportToBlogger(null));
    $("btnQuickBloggerRead").addEventListener("click", importFromBlogger);
    $("btnQuickLabels").addEventListener("click", patchBloggerLabels);
    if($("btnClear")) $("btnClear").addEventListener("click", clearEditor);

    $("btnOpenPostModal").addEventListener("click", window.openPostModal_);
    $("btnStartNewPost").addEventListener("click", window.startNewPost_);
    $("btnRefreshPostList").addEventListener("click", refreshList);

    // ëª¨ë‹¬ ë° ëª¨ë“œ ë¡œì§
    window.startNewPost_ = function() {
      clearEditor();
      $("id").value = "";
      $("category").value = "";
      $("newPostConfig").style.display = "block";
      $("currentPostInfo").textContent = "ìƒíƒœ: ìƒˆ ê¸€ ì‘ì„± ì¤‘";
      $("currentPostInfo").style.background = "#f1f5f9";
      $("currentPostInfo").style.color = "#64748b";
      setStatus("ìƒˆ ê¸€ ì‘ì„± ëª¨ë“œì…ë‹ˆë‹¤.", true);
    };

    window.openPostModal_ = function() {
      const modal = document.getElementById("postSelectModal");
      const search = document.getElementById("postModalSearch");
      if(!modal) return;
      modal.style.display = "flex";
      search.value = ""; search.focus();
      if(_cachedPostList.length === 0) refreshList(); 
      else renderPostModalList_(_cachedPostList);
      
      search.oninput = () => {
        const kw = search.value.toLowerCase();
        const filtered = _cachedPostList.filter(it => 
          (it.title||"").toLowerCase().includes(kw) || (it.id||"").toLowerCase().includes(kw)
        );
        renderPostModalList_(filtered);
      };
    };
    window.closePostModal_ = function() {
      const modal = document.getElementById("postSelectModal");
      if(modal) modal.style.display = "none";
    };
    function renderPostModalList_(items) {
      const listEl = document.getElementById("postModalList");
      if(!listEl) return;
      listEl.innerHTML = "";
      if(!items || items.length === 0){
        listEl.innerHTML = `<li class="pm-muted" style="padding:20px; text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
        return;
      }
      items.forEach(it => {
        const li = document.createElement("li");
        li.className = "pm-lib-item"; li.style.display = "block";
        li.innerHTML = `<div style="font-weight:bold; color:#334155; margin-bottom:4px;">${escapeHtml(it.title || "(ì œëª© ì—†ìŒ)")}</div><div style="font-size:12px; color:#94a3b8; font-family:monospace;">${escapeHtml(it.id)}</div>`;
        li.onclick = () => {
          $("id").value = it.id;
          loadPost(); 
          closePostModal_();
        };
        listEl.appendChild(li);
      });
    }

    // ì„¹ì…˜ ëª¨ë‹¬
    window.openSectionModal_ = async function() {
      const modal = document.getElementById("sectionModal");
      const listEl = document.getElementById("secModalList");
      const searchEl = document.getElementById("secModalSearch");
      if(!modal) return;
      modal.style.display = "flex";
      searchEl.value = ""; searchEl.focus();
      listEl.innerHTML = `<li class="pm-muted" style="text-align:center; padding:20px;">ì„¹ì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>`;
      try {
        const res = await apiGet("listSections"); 
        const items = res.items || [];
        window._cachedSectionList = items; 
        renderSectionModalList_(items);
        searchEl.oninput = () => {
          const kw = searchEl.value.toLowerCase();
          const filtered = window._cachedSectionList.filter(it => (it.name || it.id || "").toLowerCase().includes(kw));
          renderSectionModalList_(filtered);
        };
      } catch(e) {
        listEl.innerHTML = `<li class="pm-status err" style="text-align:center;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`;
      }
    };
    window.closeSectionModal_ = function() {
      const modal = document.getElementById("sectionModal");
      if(modal) modal.style.display = "none";
    };
    function renderSectionModalList_(items) {
      const listEl = document.getElementById("secModalList");
      if(!listEl) return;
      if(items.length === 0) { listEl.innerHTML = `<li class="pm-muted" style="text-align:center; padding:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`; return; }
      listEl.innerHTML = "";
      items.forEach(it => {
        const name = it.name || it.id || "Unknown";
        const li = document.createElement("li");
        li.className = "pm-lib-item";
        li.innerHTML = `<div class="pm-lib-name">${escapeHtml(name)}</div><div class="pm-lib-add">+ ì¶”ê°€</div>`;
        li.onclick = () => { window.addSection_(name); li.style.background = "#dbeafe"; setTimeout(() => window.closeSectionModal_(), 100); };
        listEl.appendChild(li);
      });
    }
    window.addSection_ = function(sectionName) {
      if (!sectionName) return;
      let nextNum = 1;
      const currentSlots = new Set();
      (templateState.sections || []).forEach(s => { if(s.vars && s.vars.SLOT) currentSlots.add(s.vars.SLOT); });
      while(true) { if(!currentSlots.has(`BODY_${nextNum}`)) break; nextNum++; }
      const newSlotName = `BODY_${nextNum}`;
      const newSec = { name: sectionName, vars: { SLOT: newSlotName } };
      if (!templateState.sections) templateState.sections = [];
      templateState.sections.push(newSec);
      refreshSectionState_();
      setStatus(`ì„¹ì…˜ ì¶”ê°€ë¨: ${sectionName} (${newSlotName})`, true);
    };

    // ì´ˆê¸° ì‹¤í–‰
    (async function init(){
      // ë²„ì „ í‘œì‹œ
      (function showVersion(){
         const el = document.getElementById("sysVersion");
         if(!el) return;
         try {
           const d = new Date(document.lastModified);
           if(isNaN(d.getTime())) { el.textContent = "V. Unknown"; return; }
           const z = n => n<10?"0"+n:n;
           el.textContent = "V. " + d.getFullYear() + z(d.getMonth()+1) + z(d.getDate()) + "_" + z(d.getHours()) + z(d.getMinutes());
         } catch(e) { el.textContent = "V. Error"; }
      })();

      setDebug("");
      renderDynamicFields_([], []);
      setStickyId_();
      await refreshList();
      await initTemplateSelect_();
      setStatus("ì¤€ë¹„ë¨", true);
    })();
  })();

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
</script>

<div id="sectionModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content">
      <div class="pm-modal-header">
        <h3 style="margin:0;">ì„¹ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬</h3>
        <button class="pm-btn small ghost" onclick="closeSectionModal_()">âœ•</button>
      </div>
      
      <div class="pm-modal-body">
        <div class="pm-row" style="margin-bottom:12px;">
          <input id="secModalSearch" class="pm-input" type="text" placeholder="ì„¹ì…˜ ì´ë¦„ ê²€ìƒ‰..." style="width:100%;" />
        </div>
  
        <ul id="secModalList" class="pm-lib-list">
          <li class="pm-muted" style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</li>
        </ul>
      </div>
      
      <div class="pm-modal-footer">
        <span class="pm-small pm-muted">í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.</span>
        <button class="pm-btn" onclick="closeSectionModal_()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <div id="postSelectModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content">
      <div class="pm-modal-header">
        <h3 style="margin:0;">ê¸°ì¡´ í¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <div style="display:flex; gap:8px;">
          <button id="btnRefreshPostList" class="pm-btn small">ğŸ”„ ëª©ë¡ ê°±ì‹ </button>
          <button class="pm-btn small ghost" onclick="closePostModal_()">âœ•</button>
        </div>
      </div>
      
      <div class="pm-modal-body">
        <div class="pm-row" style="margin-bottom:12px;">
          <input id="postModalSearch" class="pm-input" type="text" placeholder="ì œëª© ë˜ëŠ” ID ê²€ìƒ‰..." style="width:100%;" />
        </div>

        <ul id="postModalList" class="pm-lib-list">
          <li class="pm-muted" style="text-align:center; padding:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
        </ul>
      </div>
      
      <div class="pm-modal-footer">
        <span class="pm-small pm-muted">í´ë¦­í•˜ë©´ ì—ë””í„°ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</span>
        <button class="pm-btn" onclick="closePostModal_()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

</body>
</html>
