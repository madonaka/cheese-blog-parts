<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>포스트 관리 테스트</title>

  <!-- ✅ 메인 관리자 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />
  <link rel="stylesheet" href="./post_manage.css" />

  
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="pm-wrap">
        <h2 style="margin:0 0 12px; display:flex; align-items:center; flex-wrap:wrap;">
          포스트 관리 테스트
          <span class="pm-pill">Sheet DB + Drive HTML</span>
          <span id="sysVersion" class="pm-pill" style="background:#f1f5f9; color:#64748b; font-family:monospace; margin-left:auto;">
            Checking...
          </span>
        </h2>

          <div id="banner" class="pm-banner"></div>

          <!-- ==============================
               ✅ Sticky Action Bar (NEW)
               - 항상 상단에 고정
               - 핵심 액션 + 진행상태 표시
          ============================== -->
        <div class="pm-stickybar" id="stickyBar">
            
            <div class="bar-row" style="margin-bottom: 8px;">
              <div class="bar-left">
                <div class="pm-sticky-id" id="stickyId">ID: -</div>
                <div class="pm-sticky-status" id="stickyStatus">
                  <span class="pm-spinner" id="stickySpinner"></span>
                  <span id="stickyStatusText">준비됨</span>
                </div>
              </div>
            </div>

            <div class="pm-sticky-actions primary-actions">
              <button id="btnQuickPublish" class="pm-btn primary">원클릭 발행</button>
              <button id="btnQuickDraft" class="pm-btn ghost">원클릭 초안 저장</button>
            </div>

            <button id="btnStickyToggle" class="pm-btn small ghost pm-mobile-toggle">▼ 더보기</button>

            <div id="stickyFoldable" class="pm-foldable-area">
              
              <div class="pm-hr mobile-hr" style="margin: 8px 0; border-top: 1px dashed #cbd5e1; background: none;"></div>

              <div class="pm-sticky-actions secondary-actions">
                <div class="pm-divider desktop-only"></div>

                <button id="btnQuickDriveSave" class="pm-btn">Drive 저장</button>
                <button id="btnQuickBloggerUpsert" class="pm-btn">Blogger 업로드</button>

                <div class="pm-divider desktop-only"></div>

                <button id="btnQuickBloggerRead" class="pm-btn small">Blogger 불러오기</button>
                <button id="btnQuickLabels" class="pm-btn small">라벨 적용</button>
                
                <button id="btnClear" class="pm-btn small danger" title="편집창 비우기">🗑️ 편집창 비우기</button>
                <button id="btnDeletePost" class="pm-btn small danger" style="background:#fee2e2; color:#b91c1c; border-color:#fca5a5; margin-left:4px;">
                  ⛔ 포스팅 영구 삭제
                </button>
                <a id="stickyOpenBlogger" class="pm-link" href="#" target="_blank" style="display:none;">글 열기</a>
              </div>

              <div class="bar-row" style="margin-top:10px;">
                <div class="pm-row" style="width:100%;">
                  <div class="pm-label">라벨</div>
                  <input
                    id="bloggerLabelsTop"
                    class="pm-input"
                    type="text"
                    placeholder="예: 주요 사건,2026,정치"
                    style="flex:1;"
                  />
                  <select id="bloggerLabelsActionTop" class="pm-select" style="width:auto;">
                    <option value="replace">덮어쓰기</option>
                    <option value="add">추가</option>
                    <option value="remove">제거</option>
                  </select>
                </div>
                <div class="pm-muted pm-small" style="width:100%;">※ 비어 있으면 기존 유지</div>
              </div>
            </div>
          </div>
          
            <div class="pm-top-grid">
            
           <section class="pm-card">
                <div class="pm-row" style="margin-bottom: 16px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 14px;">
                  <button id="btnOpenNewModal" class="pm-btn primary" style="flex:1; height:44px;">➕ 새 포스트 작성</button>
                  <button id="btnOpenEditModal" class="pm-btn ghost" style="flex:1; height:44px;">📂 기존 포스트 불러오기</button>
                </div>

                <div class="pm-row">
                  <div class="pm-label">현재 작업 ID</div>
                  <input id="id" class="pm-input" type="text" placeholder="작성할 ID가 여기에 표시됩니다." disabled style="flex:1; background:#f8fafc; font-weight:800; color:#2563eb;" />
                </div>
            
            
                <div class="pm-row" style="margin-top:10px;">
                  <div class="pm-label">템플릿(Drive)</div>
                  <select id="templateSelect" class="pm-select" style="min-width:280px;"></select>
            
                  <button id="btnApplyTemplate" class="pm-btn">템플릿 적용(새로)</button>
                  <button id="btnRewrapTemplate" class="pm-btn">래퍼 재적용(본문 유지)</button>
            
                  <span class="pm-muted pm-small">
                    ※ 템플릿은 Drive의 매니페스트(JSON) + 섹션(HTML 조각)을 조립합니다.
                  </span>
                </div>
            
                <div id="status" class="pm-status pm-muted">준비됨</div>
            
                <details style="margin-top:10px;">
                  <summary class="pm-muted" style="cursor:pointer; font-weight:800;">디버그(마지막 응답)</summary>
                  <pre id="debug" style="margin:10px 0 0; padding:10px; border:1px solid rgba(15,23,42,0.14); border-radius:12px; background:rgba(15,23,42,0.03); overflow:auto; max-height:220px; font-size:12px;"></pre>
                </details>
            
                <div class="pm-meta">
                  <div class="pm-muted">Drive fileId</div><div id="driveFileId" class="pm-muted">-</div>
                  <div class="pm-muted">Drive url</div><div id="driveUrl" class="pm-muted">-</div>
                  <div class="pm-muted">Updated</div><div id="updatedAt" class="pm-muted">-</div>
                </div>
            
                <div class="pm-row" style="margin-top:10px;">
                  <a id="openDriveLink" class="pm-link" href="#" target="_blank" style="display:none;">Drive 파일 열기</a>
                </div>
              </section>
            
              <section class="pm-card" style="height:100%; display:flex; flex-direction:column; min-height: 400px;">
                <div class="pm-label" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                  <span>섹션 순서</span>
                  <span class="pm-small pm-muted">드래그하여 이동</span>
                </div>
                
                <ul id="sectionSortList" class="pm-sort-list" style="flex:1; overflow-y:auto;">
                  <li class="pm-muted" style="padding:10px; text-align:center;">템플릿을 불러오면 표시됩니다.</li>
                </ul>
                
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.05);">
                  <button class="pm-btn primary" style="width:100%;" onclick="openSectionModal_()">
                    + 섹션 추가 (Library)
                  </button>
                  <div class="pm-small pm-muted" style="text-align:center; margin-top:6px;">
                    순서를 바꾸면 아래 입력창도 함께 이동합니다.
                  </div>
                </div>
              </section>
            </div>
          
            <div class="pm-row">
              <div class="pm-label">Title</div>
              <input id="title" class="pm-input pm-title" type="text" placeholder="글 제목" />
              <div class="pm-muted" id="charCount">0 chars</div>
            </div>

            <details style="margin-top:10px; border:1px solid #e2e8f0; border-radius:12px; padding:10px; background:#f8fafc;">
              <summary class="pm-label" style="cursor:pointer; color:#475569; display:flex; align-items:center; justify-content:space-between;">
                <span>HTML 소스 코드 확인 (최종본)</span>
                <span class="pm-small pm-muted">클릭하여 열기/닫기</span>
              </summary>
              
              <textarea id="html" class="pm-textarea" style="margin-top:10px;" placeholder="여기에 최종 HTML이 생성됩니다."></textarea>
            </details>

            <div style="margin-top:10px;">
              <div class="pm-label" style="margin-bottom:6px;">동적 입력(템플릿 슬롯/토큰)</div>
              <p class="pm-muted pm-small pm-dyn-help" id="dynHelp">
                ※ 템플릿에서 SLOT(예: BODY_1/2/3) 또는 토큰(예: {{THUMB_URL}})을 감지해 입력칸이 자동 생성됩니다.
              </p>

              <!-- SLOT(TEXTAREA) -->
              <div id="slotFields" class="pm-dyn-grid"></div>

              <div class="pm-hr"></div>

              <!-- Token(INPUT) -->
              <div id="tokenFields" class="pm-dyn-grid"></div>
            </div>

          </section>
        </div>
      </main>
    </div>
  </div>


    <div id="sectionModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content">
      <div class="pm-modal-header">
        <h3 style="margin:0;">섹션 라이브러리</h3>
        <button class="pm-btn small ghost" onclick="closeSectionModal_()">✕</button>
      </div>
      
      <div class="pm-modal-body">
        <div class="pm-row" style="margin-bottom:12px;">
          <input id="secModalSearch" class="pm-input" type="text" placeholder="섹션 이름 검색..." style="width:100%;" />
        </div>
  
        <ul id="secModalList" class="pm-lib-list">
          <li class="pm-muted" style="text-align:center; padding:20px;">로딩 중...</li>
        </ul>
      </div>
      
      <div class="pm-modal-footer">
        <span class="pm-small pm-muted">클릭하여 추가하세요.</span>
        <button class="pm-btn" onclick="closeSectionModal_()">닫기</button>
      </div>
    </div>
  </div>

  <div id="newPostModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content">
      <div class="pm-modal-header">
        <h3 style="margin:0;">새 포스트 생성</h3>
        <button class="pm-btn small ghost" onclick="closeModal_('newPostModal')">✕</button>
      </div>
      <div class="pm-modal-body">
        <div class="pm-label" style="margin-bottom:8px;">1. 카테고리 분류 선택</div>
        <select id="category" class="pm-select" style="width:100%; margin-bottom:16px; height:42px;">
          <option value="">분류 선택...</option>
          <option value="monthly_news">주요 사건, 이슈, 뉴스 월별 총정리 (NM)</option>
          <option value="timeline_kr_cn_jp">한국사+중국사+일본사 연표 (TL)</option>
          <option value="genealogy_series">가계도시리즈 (GN)</option>
          <option value="etc">기타 (ETC)</option>
          <option value="manual">수동입력</option>
        </select>
        <div id="manualIdArea" style="display:none; margin-bottom:16px;">
          <div class="pm-label" style="margin-bottom:8px;">2. ID 직접 입력</div>
          <input id="manualIdInput" class="pm-input" type="text" style="width:100%;" placeholder="예: MY_POST_01" />
        </div>
        <div class="pm-muted pm-small">분류를 선택하면 자동으로 다음 ID가 생성됩니다.</div>
      </div>
      <div class="pm-modal-footer">
        <button id="btnCreateIdConfirm" class="pm-btn primary" style="width:100%;">이 ID로 새 글 쓰기 시작</button>
      </div>
    </div>
  </div>

  <div id="editPostModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content">
      <div class="pm-modal-header">
        <h3 style="margin:0;">기존 포스트 불러오기</h3>
        <button class="pm-btn small ghost" onclick="closeModal_('editPostModal')">✕</button>
      </div>
      <div class="pm-modal-body">
        <input id="postSearchInput" class="pm-input" type="text" placeholder="ID 또는 제목 검색..." style="width:100%; margin-bottom:12px;" />
        <ul id="postModalList" class="pm-lib-list" style="max-height:400px; overflow-y:auto;">
          <li class="pm-muted" style="text-align:center; padding:20px;">목록을 불러오는 중...</li>
        </ul>
      </div>
      <div class="pm-modal-footer">
        <button class="pm-btn ghost" style="width:100%;" onclick="refreshPostList_()">🔄 목록 새로고침</button>
      </div>
    </div>
  </div>

  <div id="alertModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content" style="max-width: 400px;">
      <div class="pm-modal-header">
        <h3 id="alertTitle" style="margin:0;">알림</h3>
        <button class="pm-btn small ghost" onclick="closeModal_('alertModal')">✕</button>
      </div>
      <div class="pm-modal-body" style="text-align: center; padding: 30px 20px;">
        <div id="alertIcon" style="font-size: 40px; margin-bottom: 15px;">✅</div>
        <div id="alertMsg" style="font-weight: 600; line-height: 1.5; white-space: pre-line;">메시지 내용</div>
      </div>
      <div class="pm-modal-footer">
        <button class="pm-btn primary" style="width:100%;" onclick="closeModal_('alertModal')">확인</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" class="pm-modal-overlay" style="display:none;">
    <div class="pm-modal-content" style="max-width: 450px;">
      <div class="pm-modal-header" style="background:#fef2f2; border-bottom:1px solid #fecaca;">
        <h3 style="margin:0; color:#b91c1c;">⛔ 게시글 영구 삭제</h3>
        <button class="pm-btn small ghost" onclick="closeModal_('deleteConfirmModal')">✕</button>
      </div>
      <div class="pm-modal-body" style="padding: 24px 20px;">
        <p style="margin:0 0 10px; font-weight:600; font-size:16px;">
          정말 이 포스트를 삭제하시겠습니까?
        </p>
        <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:16px;">
          <span style="color:#64748b; font-size:13px;">삭제 대상 ID:</span><br>
          <strong id="deleteTargetId" style="color:#2563eb; font-size:18px;">-</strong>
        </div>
        <p class="pm-small pm-status err" style="margin:0; line-height:1.5;">
          ⚠️ <strong>경고:</strong> 이 작업은 되돌릴 수 없습니다.<br>
          1. Google Sheet (데이터) 삭제<br>
          2. Google Drive (HTML 파일) 휴지통 이동<br>
          3. Blogger (게시글) 영구 삭제<br>
          <br>
          연결된 모든 데이터가 사라집니다. 진행하시겠습니까?
        </p>
      </div>
      <div class="pm-modal-footer" style="background:#fef2f2; border-top:1px solid #fecaca;">
        <button class="pm-btn ghost" onclick="closeModal_('deleteConfirmModal')" style="width:100px;">취소</button>
        <button id="btnRealDelete" class="pm-btn danger" style="flex:1;">네, 삭제합니다</button>
      </div>
    </div>
  </div>

  <div style="position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; border-top: 1px solid #ccc; display: flex; justify-content: center; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);">
    <button class="pm-btn pm-btn-primary" onclick="openIntegratedManager()">👁️ 통합 미리보기 & 주석 정렬</button>
  </div>
  
  <div id="integratedModal" class="pm-modal-backdrop">
    <div class="pm-modal-full">
      
      <div class="pm-pane-left">
        <div class="pm-pane-head">
          <div style="display:flex; align-items:center; gap:10px;">
            <span>📝 통합 에디터</span>
            <button class="pm-btn pm-btn-sm pm-btn-primary" onclick="insertFootnoteAtCursor()">+ 주석 추가 (*?)</button>
          </div>
          <div class="pm-tabs">
            <button class="pm-tab active" onclick="switchView('edit')">편집 모드</button>
            <button class="pm-tab" onclick="switchView('preview')">미리보기</button>
          </div>
        </div>
        
        <div id="viewEdit" class="pm-pane-body">
        </div>
  
        <div id="viewPreview" class="pm-pane-body blog-preview-content" style="display:none; background:#fff;"></div>
      </div>
  
      <div class="pm-pane-right">
        <div class="pm-pane-head">
          주석 목록 (자동 정렬)
          <span id="fnTotalCount" style="background:#eff6ff; color:#2563eb; padding:2px 8px; border-radius:12px; font-size:12px;">0</span>
        </div>
        <div id="fnListArea" class="pm-pane-body">
          </div>
        <div class="pm-pane-foot">
          <button class="pm-btn" onclick="closeIntegratedManager()">취소</button>
          <button class="pm-btn pm-btn-primary" onclick="applyIntegratedChanges()">적용하기</button>
        </div>
      </div>
  
    </div>
  </div>

<div id="footnoteInputModal" class="pm-modal-overlay" style="display:none; z-index: 99999;">
    <div class="pm-modal-content" style="max-width: 450px;">
      <div class="pm-modal-header">
        <h3 style="margin:0;">📝 새 주석 추가</h3>
        <button class="pm-btn small ghost" onclick="closeFootnoteModal()">✕</button>
      </div>
      <div class="pm-modal-body" style="padding: 20px;">
        <div class="pm-label" style="margin-bottom:8px;">주석 내용</div>
        <textarea id="footnoteInputTextarea" class="pm-textarea" style="width:100%; min-height:140px; font-size:13px;" placeholder="여기에 주석 내용을 길게 입력하셔도 안전합니다..."></textarea>
        <div class="pm-small pm-muted" style="margin-top:8px;">※ 모달 바깥 영역을 클릭해도 창이 닫히지 않아 내용이 날아가지 않습니다.</div>
      </div>
      <div class="pm-modal-footer">
        <button class="pm-btn ghost" style="width:80px;" onclick="closeFootnoteModal()">취소</button>
        <button class="pm-btn primary" style="flex:1; margin-left:8px;" onclick="confirmFootnoteModal()">주석 삽입</button>
      </div>
    </div>
  </div>

  
  <div id="globalMask" class="pm-global-mask">
    <div class="pm-global-spinner"></div>
    <div class="pm-global-text">처리 중입니다...</div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>
  <script src="./post_manage.js"></script>
  
 
<script>
// [NEW] 문서 수정일시 표시 (안전한 버전)
      (function showVersion(){
        // 1. $ 대신 document.getElementById 직접 사용 (오류 방지)
        const el = document.getElementById("sysVersion");
        if (!el) return;
        
        // 2. 브라우저가 인식한 마지막 수정 시간
        const d = new Date(document.lastModified);
        
        // 3. 날짜 유효성 체크
        if (isNaN(d.getTime())) {
           el.textContent = "V. Unknown";
           return;
        }

        // 4. 포맷팅 (YYYYMMDD_HHmm)
        const z = (n) => (n < 10 ? "0" + n : n);
        const verStr = 
          d.getFullYear() +
          z(d.getMonth() + 1) +
          z(d.getDate()) + "_" +
          z(d.getHours()) +
          z(d.getMinutes());

        el.textContent = "V. " + verStr;
        el.title = "Last Modified: " + document.lastModified;
      })();
    
    // 🚀 [NEW] 자동 로그 생성 함수 (포스트 발행 기록용)
    // [수정된 createAutoLog 함수]
    async function createAutoLog(newStatus, title, id, prevStatus) {
      const LOG_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
      
      const today = new Date().toISOString().split('T')[0];
      let logTitle = "";
      let logContent = "";
      let tags = "System";
    
      // 상태 분기 로직
      if (newStatus === "published") {
          if (prevStatus === "published") {
              // 1. 기존에 포스팅 되어있는 (파란불/published) 글을 다시 발행 -> "수정"
              logTitle = "📝 포스팅 수정됨 (발행)";
              logContent = `기존에 발행된 포스트 내용을 수정했습니다.\n제목: ${title}\nID: ${id}`;
              tags = "Update";
          } else {
              // 2. 새로 발행하거나, 초안(draft) 상태였던 글을 발행 -> "발행"
              logTitle = "🚀 포스팅 발행됨";
              logContent = `포스트를 정식으로 발행(공개)했습니다.\n제목: ${title}\nID: ${id}`;
              tags = "Publish";
          }
      } else {
          // 3. 초안(draft)으로 저장/발행 -> "초안 발행"
          logTitle = "💾 포스팅 초안 저장";
          logContent = `포스팅을 초안 상태로 저장(발행)했습니다.\n제목: ${title}\nID: ${id}`;
          tags = "Draft";
      }
    
      try {
          await fetch(LOG_API_BASE, {
              method: "POST",
              body: JSON.stringify({
                  mode: "addLog",
                  date: today,
                  title: logTitle,
                  content: logContent,
                  relatedId: id || "",
                  tags: tags
              })
          });
          console.log("자동 로그 기록 완료:", logTitle);
      } catch(e) {
          console.error("자동 로그 기록 실패:", e);
      }
    }
  </script>
  
</body>
</html>
