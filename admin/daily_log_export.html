<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- âœ… ê´€ë¦¬ì ê³µí†µ CSS ìœ ì§€ -->
  <link rel="stylesheet" href="./admin.css" />

<style>
  /* =========================================================
     Export í•„í„° ì¹´ë“œ
  ========================================================= */
  .export-card{
    background:#fff;
    border:1px solid rgba(15,23,42,0.10);
    border-radius:14px;
    padding:14px;
    box-shadow:0 10px 24px rgba(15,23,42,0.06);
  }
  .export-sections{ display:flex; flex-direction:column; gap:14px; }
  .search-block{
    border: 1px solid rgba(15,23,42,0.08);
    border-radius:12px;
    padding:12px;
    background: rgba(15,23,42,0.02);
  }
  .search-title{
    font-weight: 900;
    font-size: 0.95rem;
    color:#0f172a;
    margin: 0 0 10px;
  }
  .search-grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:10px;
    align-items:end;
  }
  .fg{ display:flex; flex-direction:column; gap:6px; }
  .fg label{ font-weight:800; font-size:0.9rem; color:#111827; }
  .fg input{
    border:1px solid rgba(15,23,42,0.18);
    border-radius:10px;
    padding:10px 12px;
    font-size:14px;
    outline:none;
    background:#fff;
    height:40px;
  }
  .fg input[type="date"]{ padding:8px 10px; }

  .span-2{ grid-column: span 2; min-width:120px; }
  .span-4{ grid-column: span 4; min-width:200px; }
  .span-8{ grid-column: span 8; min-width:260px; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .help-line{
    margin-top:10px;
    color:rgba(17,24,39,0.75);
    font-size:0.92rem;
    line-height:1.45;
  }
  @media (max-width: 980px){
    .span-2,.span-4,.span-8{ grid-column: span 12; min-width: 0; }
  }

  /* =========================================================
     íƒ­ UI
  ========================================================= */
  .tabs{
    display:flex; gap:8px; align-items:center;
    margin: 12px 0 14px;
    flex-wrap: wrap;
  }
  .tab-btn{
    border: 1px solid rgba(15,23,42,0.14);
    background:#fff;
    padding: 8px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 700;
  }
  .tab-btn.active{ background:#111827; color:#fff; border-color:#111827; }
  .tab-panel{ display:none; }
  .tab-panel.active{ display:block; }

  /* =========================================================
     ì›” ìš”ì•½ ìƒì„±ê¸° í¼
  ========================================================= */
  .note-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
  }
  @media (max-width: 900px){
    .note-grid{ grid-template-columns: 1fr; }
  }
  .card{
    background:#fff;
    border: 1px solid rgba(15,23,42,0.10);
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 10px 24px rgba(15,23,42,0.06);
  }
  .card h2{ margin:0 0 10px; font-size: 1.05rem; }
  .field{ display:flex; flex-direction: column; gap: 6px; margin: 10px 0; }
  .field label{ font-weight: 800; font-size: 0.92rem; color:#111827; }
  .field input, .field textarea{
    width:100%;
    border: 1px solid rgba(15,23,42,0.18);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 14px;
    outline: none;
    background:#fff;
  }
  .field textarea{ min-height: 120px; resize: vertical; }

  .row-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }

  /* =========================================================
     month-note ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼(í¬ìŠ¤íŠ¸ì‡)
  ========================================================= */
  .month-note{
    margin: 10px 0 14px;
    padding: 12px 14px;
    border-radius: 10px;
    background: #fff7cc;
    border: 1px solid rgba(17,24,39,0.10);
    box-shadow: 0 8px 18px rgba(15,23,42,0.08);
    position: relative;
  }
  .month-note::before{
    content:"";
    position:absolute;
    top:-8px;
    left: 18px;
    width: 66px;
    height: 18px;
    border-radius: 6px;
    background: rgba(255,255,255,0.65);
    border: 1px solid rgba(17,24,39,0.08);
    transform: rotate(-2deg);
  }
  .month-note-title{ font-weight: 800; color: #111827; margin-bottom: 8px; }
  .month-note-tags{ display:flex; flex-wrap:wrap; gap:8px; }
  .month-note-tags .mtag{
    display:inline-block;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 0.85em;
    font-weight: 700;
    background: rgba(17,24,39,0.08);
    color:#111827;
  }
  .month-note-desc{ margin-top: 8px; font-size: 0.88em; color: rgba(17,24,39,0.75); }
   /* âœ… ì„œë²„ ìë™ ì›”í¬ìŠ¤íŠ¸ì‡(ul/li) ì§€ì› */
  .month-note-list{
    margin: 0;
    padding-left: 18px;
    display:flex;
    flex-direction: column;
    gap: 6px;
  }
  .month-note-list li{
    font-size: 0.9em;
    font-weight: 800;
    color: rgba(17,24,39,0.85);
    line-height: 1.35;
  }
  @media (max-width: 640px){
    .month-note{ padding: 12px; }
    .month-note::before{ left: 12px; }
  }

  /* =========================================================
     íƒœê·¸ ê²€ìˆ˜ ì¹´ë“œ
  ========================================================= */
  .ev-card{
    border:1px solid rgba(15,23,42,0.10);
    border-radius:14px;
    padding:12px 12px 10px;
    background:#fff;
    box-shadow:0 10px 24px rgba(15,23,42,0.06);
    position: relative; /* âœ… ì¶”ê°€ */
  }

  /* âœ… important ì²´í¬ ì‹œ ì¹´ë“œ ê°•ì¡°(ë¶‰ì€ ê³„ì—´) */
  .ev-card.is-important{
    background: rgba(254, 226, 226, 0.60);           /* ì—°í•œ ë ˆë“œ */
    border-color: rgba(239, 68, 68, 0.28);
    box-shadow: 0 10px 24px rgba(239, 68, 68, 0.10);
  }
  .ev-card.is-important::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width:6px;
    background: rgba(239, 68, 68, 0.55);
    border-top-left-radius:14px;
    border-bottom-left-radius:14px;
  }
  .ev-card.is-important .ev-title{
    color:#7f1d1d;
  }
  
  /* âœ… important ì²´í¬ë°•ìŠ¤ ë¼ë²¨ë„ ë¶‰ê²Œ(ëˆˆì— ë” ë„ê²Œ) */
  .tag-item.is-important-tag{
    padding:4px 10px;
    border-radius:999px;
    background: rgba(239, 68, 68, 0.12);
    border:1px solid rgba(239, 68, 68, 0.22);
    color:#7f1d1d;
  }

  /* âœ… hidden(ë¹„í‘œì‹œ) ì¹´ë“œ ê·¸ë ˆì´ì•„ì›ƒ */
  .ev-card.is-hidden{
    background: #d1d5db !important;
    border-color: rgba(15,23,42,0.18);
    opacity: 0.62;
    filter: grayscale(1);
  }
  .ev-card.is-hidden .ev-title{ color: rgba(15,23,42,0.72); }
  .ev-card.is-hidden .ev-body{ color: rgba(17,24,39,0.65); }

  .ev-head{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
  .ev-title{ font-weight:900; color:#0f172a; line-height:1.25; }
  .ev-meta{ color:rgba(17,24,39,0.65); font-size:0.88rem; margin-top:4px; }
  .ev-body{
    margin-top:8px;
    color:rgba(17,24,39,0.86);
    font-size:0.95rem;
    line-height:1.45;
    white-space:pre-wrap;
  }
  .ev-tags{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:10px 14px;
    align-items:center;
  }
  .tag-group{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    padding:8px 10px;
    border-radius:12px;
    background:rgba(15,23,42,0.03);
    border:1px solid rgba(15,23,42,0.06);
  }
  .tag-item{ display:flex; gap:6px; align-items:center; font-weight:800; font-size:0.92rem; }
  .tag-item input{ transform: translateY(1px); }

  /* âœ… ë¹„í‘œì‹œ í† ê¸€(í—¤ë” ìš°ì¸¡) */
  .hide-toggle{
    display:flex;
    gap:6px;
    align-items:center;
    font-weight:900;
    font-size:0.9rem;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(15,23,42,0.05);
    border:1px solid rgba(15,23,42,0.10);
    user-select:none;
  }
  .ev-card.is-hidden .hide-toggle{
    background:rgba(239,68,68,0.10);
    border-color:rgba(239,68,68,0.22);
    color:#7f1d1d;
  }

  .tag-note{ display:none; gap:8px; align-items:center; margin-top:8px; }
  .tag-note input{
    width:min(520px, 100%);
    border: 1px solid rgba(15,23,42,0.18);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
    background:#fff;
    height:36px;
  }

  .save-pill{
    font-size:0.82rem;
    font-weight:800;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(17,24,39,0.06);
    color:rgba(17,24,39,0.75);
    white-space:nowrap;
  }
  .save-pill.saving{ background:rgba(255,184,0,0.16); color:#7a4d00; }
  .save-pill.saved{ background:rgba(34,197,94,0.14); color:#0f5132; }
  .save-pill.err{ background:rgba(239,68,68,0.14); color:#7f1d1d; }

  /* =========================================================
     ê·¸ë£¹(E-xxxxxx-xx) í¸ì§‘ UI
  ========================================================= */
  .group-editor{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .group-editor input{
    border: 1px solid rgba(15,23,42,0.18);
    border-radius: 10px;
    padding: 6px 10px;
    font-size: 14px;
    background: #fff;
    height: 36px;
    outline: none;
    min-width: 220px;
    font-weight: 800;
  }
  .group-editor .btn-mini{
    border:1px solid rgba(15,23,42,0.14);
    background:#fff;
    padding:6px 10px;
    border-radius:10px;
    cursor:pointer;
    font-weight:900;
    height:36px;
  }
  .group-editor .btn-mini.primary{ background:#111827; color:#fff; border-color:#111827; }
  .group-editor .btn-mini.danger{
    background:rgba(239,68,68,0.10);
    border-color:rgba(239,68,68,0.25);
    color:#7f1d1d;
  }
  .tag-hint{ font-size: 0.82rem; color: rgba(17,24,39,0.6); font-weight: 700; margin-left: 6px; }

  /* =========================================================
     ì´ë²¤íŠ¸(ë‚ ì§œ/ì œëª©/ë‚´ìš©) í¸ì§‘ UI
  ========================================================= */
  .ev-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn-mini{
    border:1px solid rgba(15,23,42,0.14);
    background:#fff;
    padding:6px 10px;
    border-radius:10px;
    cursor:pointer;
    font-weight:900;
    height:34px;
    line-height:1;
  }
  .btn-mini.primary{ background:#111827; color:#fff; border-color:#111827; }
  .btn-mini.ghost{ background:rgba(15,23,42,0.04); }

  .ev-editor{
    display:none;
    margin-top:10px;
    padding:10px;
    border-radius:12px;
    background:rgba(15,23,42,0.02);
    border:1px solid rgba(15,23,42,0.08);
  }
  .ev-editor.open{ display:block; }
  .ev-edit-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:8px;
  }
  @media (max-width: 900px){
    .ev-edit-grid{ grid-template-columns: 1fr; }
  }
  .ev-edit-field{ display:flex; flex-direction:column; gap:6px; margin-top:10px; }
  .ev-edit-field label{ font-weight:900; font-size:0.9rem; color:#111827; }
  .ev-edit-field input, .ev-edit-field textarea{
    width:100%;
    border: 1px solid rgba(15,23,42,0.18);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 14px;
    outline: none;
    background:#fff;
  }
  .ev-edit-field textarea{ min-height: 160px; resize: vertical; white-space: pre-wrap; }
  .ev-edit-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px; }
  .ev-edit-actions .tag-hint{ margin-left:0; }

  /* =========================================================
     ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ íƒ­
  ========================================================= */
  .add-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 10px;
  }
  .tg-select{
    height:34px;
    padding:6px 10px;
    border-radius:10px;
    border:1px solid rgba(15,23,42,0.14);
    background:#fff;
    font-weight:700;
  }
  @media (max-width: 980px){
    .add-grid{ grid-template-columns: 1fr; }
  }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .add-preview{
    border:1px solid rgba(15,23,42,0.10);
    border-radius:12px;
    padding:12px;
    background:rgba(15,23,42,0.02);
    min-height: 180px;
    white-space: pre-wrap;
    word-break: break-word;
    font-size: 13px;
  }

  /* =========================================================
     Clipboard paste image zone (Tag review)
     - ê¸°ë³¸ì€ ìˆ¨ê¹€(display:none)
     - JSì—ì„œ ë³´ì¼ ë•Œ display:flexë¡œ ì¼œê¸°
  ========================================================= */
  .paste-zone{
    border:1px dashed rgba(15,23,42,0.25);
    border-radius:10px;
    padding:10px 12px;
    background:#fff;
    min-height:44px;
    font-size:0.92rem;
    color:rgba(15,23,42,0.75);
  }
  .paste-zone:focus{ outline:2px solid rgba(37,99,235,0.25); }
  .paste-hint{ font-size:0.82rem; color:rgba(15,23,42,0.65); margin-top:6px; }

  .paste-preview{
    margin-top:8px;
    display:none;              /* âœ… ê¸°ë³¸ ìˆ¨ê¹€ */
    align-items:center;
    gap:10px;
  }
  .paste-preview a{
    font-size:0.82rem;
    font-weight:800;
    text-decoration:underline;
    white-space:nowrap;
  }
  .paste-preview img{
    width:72px;
    height:72px;
    border-radius:10px;
    object-fit:cover;
    display:block;
    flex:0 0 auto;
    border:1px solid rgba(15,23,42,0.12);
  }
  @media (max-width: 640px){
    .paste-preview img{ width:56px; height:56px; }
  }
</style>

</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="wrap">
        <h1>ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬</h1>
        <p class="desc">
          daily_events ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¸”ë¡œê·¸ì— ë°”ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
          (ì›”/ì¼/ID/ê¸°ê°„ í•„í„° + íƒœê·¸ ê²€ìˆ˜/ìˆ˜ì • + ì´ë²¤íŠ¸ ë‚´ìš© ìˆ˜ì • + ì‹ ê·œ ì¶”ê°€)
        </p>

        <!-- âœ… íƒ­ -->
        <div class="tabs">
          <button class="tab-btn" data-tab="tab-add">ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€</button>
          <button class="tab-btn" data-tab="tab-tagging">íƒœê·¸ ê²€ìˆ˜</button>
          <button class="tab-btn active" data-tab="tab-export">HTMLì½”ë“œ ìƒì„±ê¸°</button>
          <button class="tab-btn" data-tab="tab-monthnote">ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ìƒì„±ê¸°</button>
          <button class="tab-btn" data-tab="tab-yearhead">ì—°ë„ í—¤ë”/í‘œì§€ ìƒì„±ê¸°</button>
        </div>

        <!-- =========================
             TAB 0: ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€
        ========================= -->
        <section id="tab-add" class="tab-panel">
          <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom: 14px;">
            <h2 style="color:#0369a1; margin:0 0 10px;">ğŸ¤– AI ë‰´ìŠ¤/ì´ë¯¸ì§€ ë¶„ì„</h2>
            <div style="margin-bottom:10px;">
              <label style="display:block; font-size:0.92rem; font-weight:800; color:#1e293b; margin-bottom:6px;">
                ê¸°ì‚¬ í…ìŠ¤íŠ¸ ë˜ëŠ” URLì„ ì…ë ¥í•˜ê±°ë‚˜, <strong>ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)</strong> í•˜ì„¸ìš”.
              </label>
              <textarea id="ai_input_text"
                style="width:100%; height:80px; padding:10px; border:1px solid #cbd5e1; border-radius:10px; font-size:0.9rem; outline:none;"
                placeholder="ê¸°ì‚¬ ë³¸ë¬¸ì„ ë³µì‚¬í•´ ë„£ê±°ë‚˜, ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>

              <div id="ai_image_preview_area" style="margin-top:8px; display:none;">
                <span style="font-size:0.8rem; color:#059669; font-weight:bold;">ğŸ“¸ ì´ë¯¸ì§€ ì¸ì‹ë¨ (ë¶„ì„ ì‹œ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤)</span>
                <div style="margin-top:4px;">
                  <img id="ai_image_preview" style="max-height:100px; border:1px solid #cbd5e1; border-radius:6px;">
                  <button onclick="clearAiImage()" class="btn-mini" style="margin-left:6px; cursor:pointer;">ì‚­ì œ</button>
                </div>
              </div>
            </div>
            <div style="text-align:right;">
              <button id="btn_ai_analyze" class="btn primary" style="background:#0ea5e9; border-color:#0ea5e9;" onclick="runAiAnalysis()">
                âš¡ AI ë¶„ì„ ë° ë³€í™˜ ì‹¤í–‰
              </button>
            </div>
          </div>

          <div class="card">
            <h2>ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ (íŒŒì´í”„ ì—¬ëŸ¬ ì¤„ ë¶™ì—¬ë„£ê¸°: 1í–‰=1ì´ë²¤íŠ¸)</h2>
            <p class="desc" style="margin-top:6px;">
              í˜•ì‹(11ì¹¸ ê³ ì •): <span class="mono">id|date_type|date_start|date_end|title|content_raw|party|is_foreign|country|tags|created_at</span><br/>
              - <b>id</b>ê°€ <span class="mono">AUTO</span> ë˜ëŠ” ë¹ˆì¹¸ì´ë©´, ì„œë²„ê°€ <b>date_start ê¸°ì¤€</b>ìœ¼ë¡œ <span class="mono">YYMMDD-01</span>ì²˜ëŸ¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.<br/>
              - ì €ì¥ ì‹œ <b>date_type</b>ì€ start/endë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤. (end ìˆìœ¼ë©´ range, ì—†ìœ¼ë©´ single)
            </p>

            <div class="add-grid">
              <div>
                <div class="field">
                  <label>ì…ë ¥ ë¼ì¸</label>
                  <textarea id="addLine" class="mono" style="min-height:180px;"
                    placeholder="AUTO|single|2026-01-14||ì œëª©|ë‚´ìš©|gukhim|FALSE||important|2026-01-14 13:40"></textarea>
                </div>

                <div class="row-actions">
                  <button id="addSave" class="btn primary">ì‹œíŠ¸ì— ì €ì¥</button>
                  <button id="addClear" class="btn">ë¹„ìš°ê¸°</button>
                  <span id="addStatus" class="desc" style="margin-left:auto;"></span>
                </div>

                <p class="desc" style="margin-top:10px;">
                  âœ… íŒ: GPT ì¶œë ¥ì— <span class="mono">|</span>ê°€ ë³¸ë¬¸ì— ì„ì´ë©´ ì—´ì´ ê¹¨ì§‘ë‹ˆë‹¤. ë³¸ë¬¸(content_raw)ì—ëŠ” <span class="mono">|</span>ë¥¼ ì“°ì§€ ì•ŠëŠ” ê²Œ ì•ˆì „í•©ë‹ˆë‹¤.
                </p>
              </div>

              <div>
                <div class="field">
                  <label>ë¯¸ë¦¬ë³´ê¸°(íŒŒì‹± ê²°ê³¼)</label>
                  <div id="addPreview" class="add-preview mono">(ì•„ì§ ì—†ìŒ)</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- =========================
             TAB 1: íƒœê·¸ ê²€ìˆ˜
        ========================= -->
        <section id="tab-tagging" class="tab-panel">
          <div class="card">
            <h2>íƒœê·¸ ê²€ìˆ˜</h2>
            <p class="desc" style="margin-top:6px;">
              ì•„ë˜ ëª©ë¡ì€ <b>í˜„ì¬ ì…ë ¥ëœ ì—°/ì›”/ì¼/ê¸°ê°„/id í•„í„°</b> ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
              (Export íƒ­ ì…ë ¥ê°’ê³¼ ë™ì¼)
            </p>

            <div class="row-actions" style="margin-top:10px;">
                <button id="tgLoad" class="btn primary">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              
                <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
                  <input id="tgOnlyEmpty" type="checkbox" />
                  íƒœê·¸ ë¹„ì–´ìˆëŠ” ê²ƒë§Œ
                </label>
              
                <!-- âœ… ì¶”ê°€: ìˆ¨ê¹€ ë³´ê¸° ì˜µì…˜ -->
                <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
                  ìˆ¨ê¹€
                  <select id="tgHiddenView" class="tg-select">
                    <option value="all" selected>ì „ì²´(ìˆ¨ê¹€ í¬í•¨)</option>
                    <option value="exclude">ìˆ¨ê¹€ ì œì™¸</option>
                    <option value="only">ìˆ¨ê¹€ë§Œ</option>
                  </select>
                </label>
              <!-- âœ… ì¶”ê°€: ë‚ ì§œ ì •ë ¬ -->
              <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
                ì •ë ¬
                <select id="tgSort" class="tg-select">
                  <option value="date_desc" selected>ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ</option>
                  <option value="date_asc">ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ</option>
                </select>
              </label>
              
              <!-- âœ… ì¶”ê°€: ê²€ìƒ‰ -->
              <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
                ê²€ìƒ‰
                <input id="tgQuery" type="text" placeholder="ì œëª©/ë‚´ìš©/íƒœê·¸/ID ê²€ìƒ‰" style="height:34px; padding:6px 10px; border-radius:10px; border:1px solid rgba(15,23,42,0.14); min-width:240px;" />
              </label>

                <span id="tgStatus" class="desc" style="margin-left:auto;"></span>
              </div>

            <div id="tgCards" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
          </div>
        </section>

        <!-- =========================
             TAB 2: Daily Log Export
        ========================= -->
        <section id="tab-export" class="tab-panel active">
          <div class="export-card">
            <div class="export-sections">

              <div class="search-block">
                <div class="search-title">ì—°ë„, ì›”, ì¼ ê²€ìƒ‰</div>
                <div class="search-grid">
                  <div class="fg span-2">
                    <label for="year">ì—°ë„</label>
                    <input id="year" type="number" value="2026" />
                  </div>

                  <div class="fg span-2">
                    <label for="month">ì›”</label>
                    <input id="month" type="number" min="1" max="12" value="1" />
                  </div>

                  <div class="fg span-4">
                    <label for="day">ì¼ (ë‹¨ì¼)</label>
                    <input id="day" type="date" />
                  </div>
                </div>
              </div>

              <div class="search-block">
                <div class="search-title">êµ¬ì²´ì  ë²”ìœ„ë¡œ ê²€ìƒ‰</div>
                <div class="search-grid">
                  <div class="fg span-4">
                    <label for="start">start</label>
                    <input id="start" type="date" />
                  </div>

                  <div class="fg span-4">
                    <label for="end">end</label>
                    <input id="end" type="date" />
                  </div>
                </div>
              </div>

              <div class="search-block">
                <div class="search-title">idë¡œ ê²€ìƒ‰(ë³µìˆ˜ ê°€ëŠ¥)</div>
                <div class="search-grid">
                  <div class="fg span-8">
                    <label for="ids">id</label>
                    <input id="ids" type="text" placeholder="EVT001 ë˜ëŠ” EVT001,EVT002" />
                  </div>
                </div>
              </div>

              <div class="actions">
                <button id="btnGenerate" class="btn primary">HTML ìƒì„±</button>
                <label style="display:flex; gap:8px; align-items:center; font-weight:800; margin-left:6px;">
                  <input id="includeMonthNote" type="checkbox" />
                  ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ í¬í•¨
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:800; margin-left:6px;">
                  <input id="includeYearHead" type="checkbox" />
                  ì—°ë„ í—¤ë” í¬í•¨
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:800; margin-left:6px;">
                  <input id="includeServerMonthNotes" type="checkbox" checked />
                  (ê¸°ê°„) ì›”ë³„ í¬ìŠ¤íŠ¸ì‡ ìë™ ì‚½ì…
                </label>
                <button id="btnCopy" class="btn">ë³µì‚¬</button>
                <button id="btnOpen" class="btn">ìš”ì²­ URL ì—´ê¸°</button>
                <button id="btnClear" class="btn">ë¹„ìš°ê¸°</button>
              </div>

              <div class="help-line">
                - <b>day</b>ë¥¼ ì…ë ¥í•˜ë©´ ì¼ë³„ ì¶”ì¶œì´ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.<br/>
                - <b>start/end</b>ëŠ” ê¸°ê°„ ì¶”ì¶œì…ë‹ˆë‹¤. (startë§Œ ë˜ëŠ” endë§Œë„ ê°€ëŠ¥)<br/>
                - <b>id</b>ëŠ” ë‹¨ì¼ ë˜ëŠ” ì½¤ë§ˆë¡œ ì—¬ëŸ¬ ê°œ ì§€ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </div>

            </div>
          </div>

          <textarea
            id="output"
            placeholder="ì—¬ê¸°ì— daily-log HTMLì´ ìƒì„±ë©ë‹ˆë‹¤"
            style="width:100%; height:380px; margin-top:14px;"
          ></textarea>

          <p class="desc" style="margin-top:10px;">
            ë§ˆì§€ë§‰ ìš”ì²­ URL: <span id="lastUrl" style="word-break:break-all;"></span>
          </p>
        </section>

        <!-- =========================
             TAB 3: ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ìƒì„±ê¸°
        ========================= -->
        <section id="tab-monthnote" class="tab-panel">
          <div class="note-grid">
            <div class="card">
              <h2>ì…ë ¥</h2>

              <div class="field">
                <label>ìë™ ì¶”ì²œ ê°œìˆ˜(Top N)</label>
                <input id="mnTopN" type="number" min="3" max="30" value="8" />
              </div>
                            
              <div class="field">
                <label>íƒ€ì´í‹€</label>
                <input id="mnTitle" type="text" placeholder="ì˜ˆ) 1ì›” í•µì‹¬ í‚¤ì›Œë“œ" />
              </div>

              <div class="field">
                <label>í‚¤ì›Œë“œ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì½¤ë§ˆë¡œ ì…ë ¥)</label>
                <textarea id="mnTags" placeholder="ì˜ˆ)
ë² ë„¤ìˆ˜ì—˜ë¼ ê³µìŠµ
ë¯¼ì£¼ë‹¹ ê³µì²œí—Œê¸ˆ íŒŒë¬¸
ì´í˜œí›ˆ í›„ë³´ì ë…¼ë€"></textarea>
              </div>

              <div class="field">
                <label>í•˜ë‹¨ ì„¤ëª… (ì„ íƒ)</label>
                <input id="mnDesc" type="text" placeholder="ì˜ˆ) â€» í•œ ë‹¬ì„ ê´€í†µí•˜ëŠ” ì´ìŠˆ í‚¤ì›Œë“œ" />
              </div>

              <div class="row-actions">
                <button id="mnBuild" class="btn primary">ì½”ë“œ ìƒì„±</button>
                <button id="mnCopy" class="btn">ì½”ë“œ ë³µì‚¬</button>
                <button id="mnReset" class="btn">ì…ë ¥ ì´ˆê¸°í™”</button>
                <button id="mnAuto" class="btn">important íƒœê·¸ ìë™ ì¶”ì²œ</button>
              </div>

              <p class="desc" style="margin-top:10px;">
                - í‚¤ì›Œë“œëŠ” ìµœëŒ€ 8ê°œ ì •ë„ê°€ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤.<br/>
                - ì…ë ¥ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
              </p>
            </div>

            <div class="card">
              <h2>ë¯¸ë¦¬ë³´ê¸°</h2>
              <div id="mnPreview"></div>

              <h2 style="margin-top:14px;">ìƒì„±ëœ ì½”ë“œ</h2>
              <textarea id="mnOutput" style="width:100%; height:220px;" placeholder="ì—¬ê¸°ì— month-note ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤"></textarea>
            </div>
          </div>
        </section>
        
        <!-- =========================
             TAB 4: ì—°ë„ í—¤ë”/í‘œì§€ ìƒì„±ê¸°
        ========================= -->
        <section id="tab-yearhead" class="tab-panel">
          <div class="note-grid">
            <div class="card">
              <h2>ì…ë ¥</h2>
        
              <div class="field">
                <label>íƒ€ì„ë¼ì¸ CSS href (ì„ íƒ)</label>
              
                <!-- ì „ì²´ hrefëŠ” ì½ê¸° ì „ìš©(ë¯¸ë¦¬ë³´ê¸°/í™•ì¸ìš©) -->
                <input id="yhCssHrefFull" type="url" readonly
                  value="https://cdn.jsdelivr.net/gh/madonaka/cheese-blog-parts@db6329169e3a7fa5b56ff024d7889fc600cc0d07/timeline/daily-log.css" />
              
                <!-- @ ë’¤(ë²„ì „/ì»¤ë°‹)ë§Œ ë°”ê¿€ ìˆ˜ ìˆê²Œ -->
                <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                  <input id="yhCssRev" type="text"
                    value="db6329169e3a7fa5b56ff024d7889fc600cc0d07"
                    placeholder="@ ë’¤ ì»¤ë°‹/íƒœê·¸/ë¸Œëœì¹˜ (ì˜ˆ: main ë˜ëŠ” SHA)" style="flex:1; min-width:320px;" />
                </div>
              
                <p class="desc" style="margin-top:8px;">
                  â€» ìœ„ URLì˜ <b>@ ë’¤</b> ê°’ë§Œ ë³€ê²½ë©ë‹ˆë‹¤. (ì˜ˆ: main, v1.2.3, ì»¤ë°‹ SHA)
                </p>
              </div>
        
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ src</label>
                <input id="yhImgSrc" type="url" placeholder="https://... (ì´ë¯¸ì§€ URL)" />
              </div>
        
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ alt/title</label>
                <input id="yhImgAlt" type="text" value="2023ë…„ ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬" />
              </div>
        
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ ì›ë³¸ í¬ê¸°(ì„ íƒ)</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="yhImgOrigW" type="number" placeholder="data-original-width (ì˜ˆ:1500)" style="flex:1; min-width:200px;" />
                  <input id="yhImgOrigH" type="number" placeholder="data-original-height (ì˜ˆ:1500)" style="flex:1; min-width:200px;" />
                </div>
              </div>
        
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ í‘œì‹œ í¬ê¸°(ì„ íƒ)</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="yhImgW" type="number" placeholder="width (ì˜ˆ:640)" style="flex:1; min-width:200px;" />
                  <input id="yhImgH" type="number" placeholder="height (ì˜ˆ:640)" style="flex:1; min-width:200px;" />
                </div>
              </div>
        
              <hr style="border:none; border-top:1px solid rgba(15,23,42,0.10); margin:12px 0;" />
        
              <div class="field">
                <label>ì—°ë„ ë„¤ë¹„ ì œëª©</label>
                <input id="yhYearNavTitle" type="text" value="ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬" />
              </div>
        
              <div class="field">
                <label>í˜„ì¬ ì—°ë„(í•˜ì´ë¼ì´íŠ¸)</label>
                <input id="yhCurrentYear" type="number" value="2023" />
              </div>
        
              <div class="field">
                <label>ì—°ë„ ë§í¬ ëª©ë¡ (1ì¤„=1ê°œ, í˜•ì‹: YYYY|URL)</label>
                <textarea id="yhYearLinks" class="mono" placeholder="2024|https://...
        2025|https://...
        2026|https://...">2024|https://www.cheesehistory.com/2026/01/2024.html
        2025|https://www.cheesehistory.com/2026/01/2025.html
        2026|https://www.cheesehistory.com/2026/01/2026.html</textarea>
              </div>
        
              <hr style="border:none; border-top:1px solid rgba(15,23,42,0.10); margin:12px 0;" />
        
              <div class="field">
                <label>ì—° ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ íƒ€ì´í‹€</label>
                <input id="yhYearNoteTitle" type="text" value="2023ë…„ ê¸°ë³¸ ì •ë³´" />
              </div>
        
              <div class="field">
                <label>ì—° ìš”ì•½ íƒœê·¸ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì½¤ë§ˆ)</label>
                <textarea id="yhYearNoteTags" placeholder="ê³„ë¬˜ë…„(ç™¸å¯å¹´)
        ê²€ì€ í† ë¼ í•´
        ìµœì €ì‹œê¸‰ 9,620ì›">ê³„ë¬˜ë…„(ç™¸å¯å¹´)
        ê²€ì€ í† ë¼ í•´
        ìµœì €ì‹œê¸‰ 9,620ì›
        ìµœì €ì„ê¸ˆ 201ë§Œ 580ì›
        ë³‘ì¥ì›”ê¸‰ 130ë§Œ ì›</textarea>
              </div>
        
              <div class="field">
                <label>ì—° ìš”ì•½ í•˜ë‹¨ ì„¤ëª…(ì„ íƒ)</label>
                <input id="yhYearNoteDesc" type="text" value="â€»ìœ¤ì„ì—´ ëŒ€í†µë ¹ ì„ê¸° 3ë…„ ì°¨(22.5.10~) â€»22ëŒ€ êµ­íšŒì˜ì› ì„ ê±°(24.4.10)" />
              </div>
        
              <div class="row-actions">
                <button id="yhBuild" class="btn primary">ì½”ë“œ ìƒì„±</button>
                <button id="yhCopy" class="btn">ì½”ë“œ ë³µì‚¬</button>
                <button id="yhReset" class="btn">ì…ë ¥ ì´ˆê¸°í™”</button>
              </div>
        
              <p class="desc" style="margin-top:10px;">
                - ìƒì„±ëœ ì½”ë“œëŠ” ë¸”ë¡œê·¸ ê¸€ ìƒë‹¨ì— ë¶™ì—¬ë„£ê¸°ìš©ì…ë‹ˆë‹¤.<br/>
                - ì…ë ¥ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
              </p>
            </div>
        
            <div class="card">
              <h2>ë¯¸ë¦¬ë³´ê¸°</h2>
              <div id="yhPreview"></div>
        
              <h2 style="margin-top:14px;">ìƒì„±ëœ ì½”ë“œ</h2>
              <textarea id="yhOutput" style="width:100%; height:260px;" placeholder="ì—¬ê¸°ì— ì—°ë„ í—¤ë”/í‘œì§€ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤"></textarea>
            </div>
          </div>
        </section>


        
      </main>
    </div>
  </div>

  <!-- âœ… ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ëŠ” ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ -->
  <script src="./admin-common.js"></script>

  <script>
    /* =========================
       ê³µí†µ: escape
    ========================= */
    function escHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/\"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function escAttr(s){ return escHtml(s).replace(/\"/g,"&quot;"); }

    /* âœ… [ì¶”ê°€] bool íŒŒì„œ + hidden íŒì • */
    function parseBool_(v){
      if (v === true) return true;
      if (v === false) return false;
      const s = String(v ?? "").trim().toLowerCase();
      return (s === "true" || s === "t" || s === "1" || s === "y" || s === "yes" || s === "on");
    }

    /* =========================
       íƒ­ ë¡œì§
    ========================= */
    const tabBtns = Array.from(document.querySelectorAll(".tab-btn"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    function setActiveTab(tabId){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      tabPanels.forEach(p => p.classList.toggle("active", p.id === tabId));
      localStorage.setItem("CHEESE_ACTIVE_TAB", tabId);
    }

    tabBtns.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));
    const savedTab = localStorage.getItem("CHEESE_ACTIVE_TAB");
    if (savedTab && document.getElementById(savedTab)) setActiveTab(savedTab);

    /* =========================
       Daily Log Export
    ========================= */
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbyuC0qHyRdDKL2fC5fmRy66l0y1baCLbXuf9pNlPh0rBde_HQMzaqQv5NK06H_n7WFk/exec";

    const el = {
      year: document.getElementById("year"),
      month: document.getElementById("month"),
      day: document.getElementById("day"),
      start: document.getElementById("start"),
      end: document.getElementById("end"),
      ids: document.getElementById("ids"),
      output: document.getElementById("output"),
      lastUrl: document.getElementById("lastUrl"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnCopy: document.getElementById("btnCopy"),
      btnOpen: document.getElementById("btnOpen"),
      btnClear: document.getElementById("btnClear"),
    };

    let lastRequestUrl = "";

    el.btnGenerate.addEventListener("click", generate);
    el.btnCopy.addEventListener("click", copyOutput);
    el.btnOpen.addEventListener("click", openLastUrl);
    el.btnClear.addEventListener("click", () => {
        el.output.value = "";
        el.lastUrl.textContent = "";
        lastRequestUrl = "";
        el.day.value = "";
        el.start.value = "";
        el.end.value = "";
    });

    function buildUrl() {
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("ì›” ì¶”ì¶œì€ ì—°ë„/ì›”ì´ í•„ìš”í•˜ê³ , ì¼ë³„ì€ dayê°€ í•„ìš”í•˜ë©°, ê¸°ê°„ì€ start/endê°€ í•„ìš”í•©ë‹ˆë‹¤. (startë§Œ ë˜ëŠ” endë§Œë„ ê°€ëŠ¥)");
      }

      const params = new URLSearchParams();
      params.set("mode", "exportDailyLog");

      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

       // âœ… ì„œë²„ ìë™ ì›”ë³„ í¬ìŠ¤íŠ¸ì‡ ON/OFF ì „ë‹¬
      const serverNotesOn = document.getElementById("includeServerMonthNotes")?.checked === true;
      params.set("includeMonthNotes", serverNotesOn ? "1" : "0");
      
      if (ids) params.set("id", ids);

      return `${API_BASE}?${params.toString()}`;
    }

    async function generate() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
    
        el.output.value = "ìƒì„± ì¤‘...";
    
        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          redirect: "follow",
          credentials: "omit"
        });
        if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP " + res.status + ")");
    
        const text = await res.text();
    
        if (text && /<!doctype html|<html/i.test(text)) {
          throw new Error("APIê°€ HTML í™”ë©´ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ doGet(e) ë¶„ê¸°/ë°°í¬ í™•ì¸ í•„ìš”)");
        }
    
        const fixed = text.replace(/&lt;br\s*\/?&gt;/gi, "<br>");
        let outHtml = fixed || "<!-- empty -->";
    
        // âœ… í˜„ì¬ ì…ë ¥ ìƒíƒœ ê¸°ë°˜ìœ¼ë¡œ 'ê¸°ê°„ export' íŒë³„
        const isRangeExport =
          !String(el.day.value || "").trim() &&
          (String(el.start.value || "").trim() || String(el.end.value || "").trim());
    
        // âœ… ì„œë²„ ìë™ ì›”ë³„ í¬ìŠ¤íŠ¸ì‡ ON/OFF(ì„œë²„ ì¤‘ë³µ ë°©ì§€ìš©)
        const serverNotesOn =
          document.getElementById("includeServerMonthNotes")?.checked === true;
    
        // 1) âœ… ì²´í¬ ì‹œ: month-note ì½”ë“œë¥¼ ë¨¼ì € ì•ì— ë¶™ì„
        // ë‹¨, ê¸°ê°„ exportì—ì„œ ì„œë²„ ìë™ ì›”ë³„ í¬ìŠ¤íŠ¸ì‡ ONì´ë©´ ì¤‘ë³µ ë°©ì§€ë¡œ prepend ê¸ˆì§€
        const includeMN =
          document.getElementById("includeMonthNote")?.checked === true;
    
        if (includeMN && !(isRangeExport && serverNotesOn)) {
          const mnOutputEl = document.getElementById("mnOutput");
          let mnCode = String(mnOutputEl?.value || "").trim();
    
          if (!mnCode) {
            try { buildMonthNote(); } catch (_) {}
            mnCode = String(mnOutputEl?.value || "").trim();
          }
    
          if (mnCode) {
            outHtml = mnCode + "\n\n" + outHtml;
          }
        }
    
        // 2) âœ… ì²´í¬ ì‹œ: ì—°ë„ í—¤ë”(í‘œì§€) ì½”ë“œë¥¼ ë§ˆì§€ë§‰ì— ì•ì— ë¶™ì„ â†’ ìµœìƒë‹¨ì´ ë¨
        const includeYH =
          document.getElementById("includeYearHead")?.checked === true;
    
        if (includeYH) {
          const yhOutputEl = document.getElementById("yhOutput");
          let yhCode = String(yhOutputEl?.value || "").trim();
    
          if (!yhCode) {
            try { buildYearHead_(); } catch (_) {}
            yhCode = String(yhOutputEl?.value || "").trim();
          }
    
          if (yhCode) {
            outHtml = yhCode + "\n\n" + outHtml;
          }
        }
    
        el.output.value = outHtml;
      } catch (e) {
        el.output.value = "";
        const msg = (e && e.message ? e.message : String(e));
        alert(
          "HTML ìƒì„± ì‹¤íŒ¨: " + msg +
          "\n\n(í™•ì¸) 'ìš”ì²­ URL ì—´ê¸°'ë¡œ ìƒˆ íƒ­ì—ì„œ ê²°ê³¼ê°€ í…ìŠ¤íŠ¸ë¡œ ëœ¨ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
        );
      }
    }


    async function copyOutput() {
      const val = (el.output.value || "").trim();
      if (!val) {
        alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      try {
        await navigator.clipboard.writeText(el.output.value);
        alert("ë³µì‚¬ ì™„ë£Œ");
      } catch (e) {
        el.output.focus();
        el.output.select();
        document.execCommand("copy");
        alert("ë³µì‚¬ ì™„ë£Œ");
      }
    }

    function openLastUrl() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (e) {
        alert("URL ìƒì„± ì‹¤íŒ¨: " + (e && e.message ? e.message : String(e)));
      }
    }

    /* =========================
       ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ìƒì„±ê¸°
    ========================= */
    const mn = {
      title: document.getElementById("mnTitle"),
      tags: document.getElementById("mnTags"),
      desc: document.getElementById("mnDesc"),
      preview: document.getElementById("mnPreview"),
      output: document.getElementById("mnOutput"),
      build: document.getElementById("mnBuild"),
      copy: document.getElementById("mnCopy"),
      reset: document.getElementById("mnReset"),
      topN: document.getElementById("mnTopN"),
      auto: document.getElementById("mnAuto"),
    };
    
    const MN_KEY = "CHEESE_MONTH_NOTE_FORM";
    
    function loadMonthNote(){
      try{
        const saved = JSON.parse(localStorage.getItem(MN_KEY) || "{}");
        if (saved.title != null) mn.title.value = saved.title;
        if (saved.tags  != null) mn.tags.value  = saved.tags;
        if (saved.desc  != null) mn.desc.value  = saved.desc;
        if (saved.topN  != null && mn.topN) mn.topN.value = saved.topN;
      }catch(_){ }
    }
    
    function saveMonthNote(){
      localStorage.setItem(MN_KEY, JSON.stringify({
        title: mn.title.value || "",
        tags:  mn.tags.value || "",
        desc:  mn.desc.value || "",
        topN:  mn.topN ? (mn.topN.value || "8") : "8"
      }));
    }
    
    ["input","change"].forEach(evt=>{
      mn.title.addEventListener(evt, saveMonthNote);
      mn.tags.addEventListener(evt, saveMonthNote);
      mn.desc.addEventListener(evt, saveMonthNote);
      if (mn.topN) mn.topN.addEventListener(evt, saveMonthNote);
    });
    
    // âœ… ìˆœì„œ: ë¡œë“œ â†’ ê°’ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸°/ì½”ë“œ ìƒì„±
    loadMonthNote();
    if ((mn.title.value || mn.tags.value || mn.desc.value).trim().length){
      buildMonthNote();
    }
    
    function parseTags(text){
      const cap = Math.min(Math.max(Number(mn.topN?.value || 8), 3), 20);
      return String(text || "")
        .split(/\n|,/g)
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, cap);
    }
    
    function buildMonthNote(){
      const title = (mn.title.value || "").trim() || "ì›” í•µì‹¬ í‚¤ì›Œë“œ";
      const tags = parseTags(mn.tags.value);
      const desc = (mn.desc.value || "").trim();
    
      const tagHtml = tags.length
        ? tags.map(t => `    <span class="mtag">${escHtml(t)}</span>`).join("\n")
        : `    <span class="mtag">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>`;
    
      const descHtml = desc
        ? `\n\n  <div class="month-note-desc">\n    ${escHtml(desc)}\n  </div>`
        : "";
    
      // âœ… summary íƒ€ì´í‹€ ìë™(ì—°/ì›” í•„í„° ê¸°ì¤€)
      const y = String(el.year?.value || "").trim();
      const m = String(el.month?.value || "").trim();
    
      const canUseYm = !!(y && m && !el.day?.value && !el.start?.value && !el.end?.value);
      const summaryTitle = canUseYm ? `${y}ë…„ ${Number(m)}ì›”` : "";
      const summaryHtml = summaryTitle
        ? `  <summary><h2>${escHtml(summaryTitle)}</h2></summary>\n`
        : "";
    
      const html =
    `${summaryHtml}  <!-- âœ… ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ (ë§¤ë‹¬ 1íšŒ) -->
      <div class="month-note">
        <div class="month-note-title">${escHtml(title)}</div>
        <div class="month-note-tags">
    ${tagHtml}
        </div>${descHtml ? descHtml.replace(/\n/g, "\n  ") : ""}
      </div>`;
    
      mn.preview.innerHTML =
        `<div class="month-note">
          <div class="month-note-title">${escHtml(title)}</div>
          <div class="month-note-tags">
            ${tags.map(t => `<span class="mtag">${escHtml(t)}</span>`).join("")}
          </div>
          ${desc ? `<div class="month-note-desc">${escHtml(desc)}</div>` : ""}
        </div>`;
    
      mn.output.value = html;
    }
    
    mn.build.addEventListener("click", (e) => {
      e.preventDefault();
      buildMonthNote();
      saveMonthNote();
    });
    
    mn.copy.addEventListener("click", async (e) => {
      e.preventDefault();
      const val = (mn.output.value || "").trim();
      if (!val){ buildMonthNote(); }
      try{
        await navigator.clipboard.writeText(mn.output.value);
        alert("ë³µì‚¬ ì™„ë£Œ");
      }catch(_){
        mn.output.focus();
        mn.output.select();
        document.execCommand("copy");
        alert("ë³µì‚¬ ì™„ë£Œ");
      }
    });
    
    mn.reset.addEventListener("click", (e) => {
      e.preventDefault();
      mn.title.value = "";
      mn.tags.value = "";
      mn.desc.value = "";
      if (mn.topN) mn.topN.value = "8";
      mn.preview.innerHTML = "";
      mn.output.value = "";
      localStorage.removeItem(MN_KEY);
    });


    if ((mn.title.value || mn.tags.value || mn.desc.value).trim().length){
      buildMonthNote();
    }

    /* =========================
       TAGGING (íƒœê·¸ ê²€ìˆ˜ + ì´ë²¤íŠ¸ í¸ì§‘)
    ========================= */
    const TG_ADMIN_KEY = ""; // Code.gsì˜ ADMIN_KEYì™€ ë™ì¼í•˜ê²Œ(ë¹„ìš°ë©´ ë³´í˜¸ ì—†ìŒ)
    const BASE_UI = ["ë³´ìˆ˜","ì§„ë³´","êµ­ì œ","ì´ìŠˆ"];
    const BASE_DB_PREFIX = "ì¤‘ìš”-";
    const GROUP_RE = /^E-\d{6}-\d{2}$/;

    const tg = {
      load: document.getElementById("tgLoad"),
      onlyEmpty: document.getElementById("tgOnlyEmpty"),
      sort: document.getElementById("tgSort"),      // âœ… ì¶”ê°€
      query: document.getElementById("tgQuery"),    // âœ… ì¶”ê°€
      hiddenView: document.getElementById("tgHiddenView"), // âœ… ì¶”ê°€
      status: document.getElementById("tgStatus"),
      cards: document.getElementById("tgCards"),
    };
    
    // âœ… ë¡œë“œëœ â€œì›ë³¸ ëª©ë¡â€ì„ ì €ì¥í•´ë‘ê³ , í™”ë©´ì—ì„œë§Œ í•„í„°/ì •ë ¬
    tg._allItems = [];

    const SAVE_DEBOUNCE_MS = 450;
    const saveTimers = new Map();

    tg.load.addEventListener("click", loadTagCards);
    tg.hiddenView.addEventListener("change", applyTgView_);

    // âœ… ì¶”ê°€: ì •ë ¬/ê²€ìƒ‰ì€ ì¬í˜¸ì¶œ(fetch) ì—†ì´ í™”ë©´ë§Œ ê°±ì‹ 
    if (tg.sort)  tg.sort.addEventListener("change", applyTgView_);
    if (tg.query) tg.query.addEventListener("input", debounce_(applyTgView_, 120));
    tg.onlyEmpty.addEventListener("change", applyTgView_);
        
    function buildListUrl(){
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("ì›” ì¶”ì¶œì€ ì—°ë„/ì›”ì´ í•„ìš”í•˜ê³ , ì¼ë³„ì€ dayê°€ í•„ìš”í•˜ë©°, ê¸°ê°„ì€ start/endê°€ í•„ìš”í•©ë‹ˆë‹¤. (startë§Œ ë˜ëŠ” endë§Œë„ ê°€ëŠ¥)");
      }

      const params = new URLSearchParams();
      params.set("mode", "listEvents");
      params.set("limit", "300");

      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }
    
      // âœ… ì¶”ê°€: ìˆ¨ê¹€ í¬í•¨ ì—¬ë¶€(ì„œë²„ì˜ includeHidden íŒŒë¼ë¯¸í„°)
      const view = tg.hiddenView ? tg.hiddenView.value : "all";
      params.set("includeHidden", view === "exclude" ? "false" : "true");
        
      if (ids) params.set("id", ids);
      if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);

      return `${API_BASE}?${params.toString()}`;
    }

    /* =========================
       ì—°ë„ í—¤ë”/í‘œì§€ ìƒì„±ê¸°
    ========================= */
    const YH_DEFAULT_CSS_FULL =
      "https://cdn.jsdelivr.net/gh/madonaka/cheese-blog-parts@db6329169e3a7fa5b56ff024d7889fc600cc0d07/timeline/daily-log.css";
    const YH_DEFAULT_CSS_REV =
      "db6329169e3a7fa5b56ff024d7889fc600cc0d07";

    const yh = {
      cssHrefFull: document.getElementById("yhCssHrefFull"),
      cssRev: document.getElementById("yhCssRev"),
      imgSrc: document.getElementById("yhImgSrc"),
      imgAlt: document.getElementById("yhImgAlt"),
      imgOrigW: document.getElementById("yhImgOrigW"),
      imgOrigH: document.getElementById("yhImgOrigH"),
      imgW: document.getElementById("yhImgW"),
      imgH: document.getElementById("yhImgH"),
      yearNavTitle: document.getElementById("yhYearNavTitle"),
      currentYear: document.getElementById("yhCurrentYear"),
      yearLinks: document.getElementById("yhYearLinks"),
      yearNoteTitle: document.getElementById("yhYearNoteTitle"),
      yearNoteTags: document.getElementById("yhYearNoteTags"),
      yearNoteDesc: document.getElementById("yhYearNoteDesc"),
      preview: document.getElementById("yhPreview"),
      output: document.getElementById("yhOutput"),
      build: document.getElementById("yhBuild"),
      copy: document.getElementById("yhCopy"),
      reset: document.getElementById("yhReset"),
    };
    
    const YH_KEY = "CHEESE_YEAR_HEAD_FORM";
    
    function parseLines_(text){
      return String(text || "").replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
    }
    function parseTagsSmart_(text){
      return String(text || "")
        .split(/\n|,/g)
        .map(s=>s.trim())
        .filter(Boolean)
        .slice(0, 30);
    }
    function parseYearLinks_(text){
      // line: YYYY|URL
      return parseLines_(text).map(line=>{
        const i = line.indexOf("|");
        if (i < 0) return { year: line.trim(), url: "" };
        return { year: line.slice(0,i).trim(), url: line.slice(i+1).trim() };
      }).filter(x=>x.year);
    }
    
    function loadYearHead_(){
      try{
        const saved = JSON.parse(localStorage.getItem(YH_KEY) || "{}");
        // ì‹ ê·œ ì €ì¥ê°’ ìš°ì„ 
        if (saved.cssHrefFull != null && yh.cssHrefFull) yh.cssHrefFull.value = saved.cssHrefFull;
        if (saved.cssRev != null && yh.cssRev) yh.cssRev.value = saved.cssRev;
        
        // (êµ¬ë²„ì „ í˜¸í™˜) ì˜ˆì „ì— cssHrefë¡œ ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ íŒŒì‹±í•´ì„œ revë§Œ ì±„ì›€
        if (saved.cssHref != null && yh.cssHrefFull && yh.cssRev) {
          yh.cssHrefFull.value = saved.cssHref;
          const m = String(saved.cssHref).match(/@([^\/]+)\//);
          if (m && m[1]) yh.cssRev.value = m[1];
        }

        if (saved.imgSrc != null) yh.imgSrc.value = saved.imgSrc;
        if (saved.imgAlt != null) yh.imgAlt.value = saved.imgAlt;
        if (saved.imgOrigW != null) yh.imgOrigW.value = saved.imgOrigW;
        if (saved.imgOrigH != null) yh.imgOrigH.value = saved.imgOrigH;
        if (saved.imgW != null) yh.imgW.value = saved.imgW;
        if (saved.imgH != null) yh.imgH.value = saved.imgH;
        if (saved.yearNavTitle != null) yh.yearNavTitle.value = saved.yearNavTitle;
        if (saved.currentYear != null) yh.currentYear.value = saved.currentYear;
        if (saved.yearLinks != null) yh.yearLinks.value = saved.yearLinks;
        if (saved.yearNoteTitle != null) yh.yearNoteTitle.value = saved.yearNoteTitle;
        if (saved.yearNoteTags != null) yh.yearNoteTags.value = saved.yearNoteTags;
        if (saved.yearNoteDesc != null) yh.yearNoteDesc.value = saved.yearNoteDesc;
      }catch(_){}
    }
    function saveYearHead_(){
      localStorage.setItem(YH_KEY, JSON.stringify({
        cssHrefFull: yh.cssHrefFull?.value || "",
        cssRev: yh.cssRev?.value || "",
        imgSrc: yh.imgSrc?.value || "",
        imgAlt: yh.imgAlt?.value || "",
        imgOrigW: yh.imgOrigW?.value || "",
        imgOrigH: yh.imgOrigH?.value || "",
        imgW: yh.imgW?.value || "",
        imgH: yh.imgH?.value || "",
        yearNavTitle: yh.yearNavTitle?.value || "",
        currentYear: yh.currentYear?.value || "",
        yearLinks: yh.yearLinks?.value || "",
        yearNoteTitle: yh.yearNoteTitle?.value || "",
        yearNoteTags: yh.yearNoteTags?.value || "",
        yearNoteDesc: yh.yearNoteDesc?.value || "",
      }));
    }
    
    ["input","change"].forEach(evt=>{
      Object.values(yh).forEach(elm=>{
        if (elm && (elm.tagName === "INPUT" || elm.tagName === "TEXTAREA")){
          elm.addEventListener(evt, saveYearHead_);
        }
      });
    });
    
    function buildYearHead_(){
      // âœ… ì „ì²´ hrefì—ì„œ @ë’¤(rev)ë§Œ êµì²´í•´ì„œ ìµœì¢… href ìƒì„±
      const full0 = String(yh.cssHrefFull?.value || "").trim();
      const rev = String(yh.cssRev?.value || "").trim();
      
      // full0ê°€ ë¹„ì–´ìˆìœ¼ë©´ CSS ì¶œë ¥ ìƒëµ
      let cssHref = "";
      if (full0) {
        // full0ì—ì„œ @.../ ë¶€ë¶„ë§Œ ì°¾ì•„ êµì²´
        cssHref = full0.replace(/@([^\/]+)\//, (m, oldRev) => `@${rev || oldRev}/`);
      }
      
      const imgSrc = String(yh.imgSrc?.value || "").trim();
      const imgAlt = String(yh.imgAlt?.value || "").trim() || "ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬";
    
      const ow = String(yh.imgOrigW?.value || "").trim();
      const oh = String(yh.imgOrigH?.value || "").trim();
      const w  = String(yh.imgW?.value || "").trim();
      const h  = String(yh.imgH?.value || "").trim();
    
      const navTitle = String(yh.yearNavTitle?.value || "").trim() || "ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬";
      const curYear = String(yh.currentYear?.value || "").trim();
    
      const links = parseYearLinks_(yh.yearLinks?.value || "");
      const yearCells = [];
    
      if (curYear){
        yearCells.push(`<span class="cheese-year-cell current" aria-current="page">${escHtml(curYear)}</span>`);
      }
    
      links.forEach(x=>{
        const y = String(x.year||"").trim();
        const u = String(x.url||"").trim();
        if (!y) return;
        if (curYear && y === curYear) return; // ì¤‘ë³µ ë°©ì§€
        if (!u){
          yearCells.push(`<span class="cheese-year-cell">${escHtml(y)}</span>`);
        }else{
          yearCells.push(`<a class="cheese-year-cell" href="${escAttr(u)}">${escHtml(y)}</a>`);
        }
      });
    
      const noteTitle = String(yh.yearNoteTitle?.value || "").trim() || (curYear ? `${curYear}ë…„ ê¸°ë³¸ ì •ë³´` : "ì—°ë„ ê¸°ë³¸ ì •ë³´");
      const noteTags = parseTagsSmart_(yh.yearNoteTags?.value || "");
      const noteDesc = String(yh.yearNoteDesc?.value || "").trim();
    
      const tagsHtml = noteTags.length
        ? noteTags.map(t => `      <span class="mtag">${escHtml(t)}</span>`).join("\n")
        : `      <span class="mtag">íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>`;
    
      const cssBlock = cssHref
        ? `<link rel="stylesheet" href="${escAttr(cssHref)}" />\n\n`
        : "";
    
      const imgBlock = imgSrc
        ? `<!--â–¼ ì´ë¯¸ì§€ + í™•ëŒ€ ë²„íŠ¼ (Bloggerìš©) -->\n<div class="cheese-img-wrapper">\n  <div class="cheese-img-inner">\n    <div class="separator" style="clear: both; text-align: center;">\n      <a href="${escAttr(imgSrc)}" style="margin-left: 1em; margin-right: 1em;">\n        <img\n          alt="${escAttr(imgAlt)}"\n          border="0"\n          ${oh ? `data-original-height="${escAttr(oh)}"\n          ` : ""}${ow ? `data-original-width="${escAttr(ow)}"\n          ` : ""}${h ? `height="${escAttr(h)}"\n          ` : ""}src="${escAttr(imgSrc)}"\n          title="${escAttr(imgAlt)}"\n          ${w ? `width="${escAttr(w)}"\n          ` : ""}/>\n      </a>\n    </div>\n    <div class="cheese-img-overlay"></div>\n  </div>\n</div>\n\n`
        : "";
    
      const navBlock =
    `<!-- ì—°ë„ ë„¤ë¹„ê²Œì´ì…˜ -->
    <details class="cheese-year-nav" open="">
      <summary>
        <div class="cheese-year-head">
          <p class="cheese-year-title">${escHtml(navTitle)}</p>
        </div>
        <span class="cheese-year-toggle">í¼ì¹˜ê¸° / ì ‘ê¸°</span>
      </summary>
    
      <div class="cheese-year-body" aria-label="ì—°ë„ ì´ë™ ë§í¬">
        <div class="cheese-year-grid">
          ${yearCells.join("\n      ")}
        </div>
      </div>
    </details>
    <br /><br />
    
    <!-- âœ… ì—° ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ -->
    <div class="month-note year-note">
      <div class="month-note-title">${escHtml(noteTitle)}</div>
      <div class="month-note-tags">
    ${tagsHtml}
      </div>
    ${noteDesc ? `\n  <div class="month-note-desc">\n    ${escHtml(noteDesc)}\n  </div>\n` : ""}
    </div>`;
    
      const html = cssBlock + imgBlock + navBlock;
    
      // ë¯¸ë¦¬ë³´ê¸°(ê°„ë‹¨)
      yh.preview.innerHTML = `
        <div class="month-note year-note">
          <div class="month-note-title">${escHtml(noteTitle)}</div>
          <div class="month-note-tags">
            ${noteTags.map(t=>`<span class="mtag">${escHtml(t)}</span>`).join("")}
          </div>
          ${noteDesc ? `<div class="month-note-desc">${escHtml(noteDesc)}</div>` : ""}
        </div>
        <div class="desc" style="margin-top:10px;">
          â€» ì‹¤ì œ ì¶œë ¥ì—ëŠ” ì—°ë„ ë„¤ë¹„/ì´ë¯¸ì§€/CSS ë§í¬ê°€ í•¨ê»˜ í¬í•¨ë©ë‹ˆë‹¤.
        </div>
      `;
    
      yh.output.value = html;
    }
    
    loadYearHead_();
    if ((yh.imgSrc?.value || yh.yearLinks?.value || yh.yearNoteTitle?.value || yh.yearNoteTags?.value || "").trim().length){
      try{ buildYearHead_(); }catch(_){}
    }
    
    if (yh.build){
      yh.build.addEventListener("click", (e)=>{
        e.preventDefault();
        buildYearHead_();
        saveYearHead_();
      });
    }
    if (yh.copy){
      yh.copy.addEventListener("click", async (e)=>{
        e.preventDefault();
        if (!String(yh.output.value || "").trim()) buildYearHead_();
        try{
          await navigator.clipboard.writeText(yh.output.value);
          alert("ë³µì‚¬ ì™„ë£Œ");
        }catch(_){
          yh.output.focus();
          yh.output.select();
          document.execCommand("copy");
          alert("ë³µì‚¬ ì™„ë£Œ");
        }
      });
    }
    if (yh.reset){
      yh.reset.addEventListener("click", (e)=>{
        e.preventDefault();
    
        // âœ… CSSëŠ” ì´ˆê¸°í™”í•´ë„ ê¸°ë³¸ê°’ ìœ ì§€
        if (yh.cssHrefFull) yh.cssHrefFull.value = YH_DEFAULT_CSS_FULL;
        if (yh.cssRev) yh.cssRev.value = YH_DEFAULT_CSS_REV;
    
        // âœ… ë‚˜ë¨¸ì§€ ì…ë ¥ê°’ë§Œ ë¹„ìš°ê¸°
        const keepIds = new Set(["yhCssHrefFull", "yhCssRev"]);
        Object.values(yh).forEach(elm=>{
          if (!elm) return;
          if (elm.tagName === "INPUT" || elm.tagName === "TEXTAREA"){
            if (keepIds.has(elm.id)) return; // CSS ê´€ë ¨ 2ê°œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
            elm.value = "";
          }
        });
    
        yh.preview.innerHTML = "";
        yh.output.value = "";
    
        // ì €ì¥ê°’ì€ ì§€ìš°ë˜, ê¸°ë³¸ CSS ê°’ì€ ë‹¤ì‹œ ì €ì¥ë˜ê²Œ
        localStorage.removeItem(YH_KEY);
        try { saveYearHead_(); } catch(_){}
      });
    }

    
    // âœ… ì¬ë“±ë¡(AUTO) í›„: ìƒˆ date_startê°€ í˜„ì¬ í•„í„° ë²”ìœ„ ë°–ì´ë©´
    // ìƒˆë¡œ ìƒì„±ëœ ì¹´ë“œê°€ ëª©ë¡ì— ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ â†’ í•„í„°ë¥¼ ìë™ ë™ê¸°í™”
    function syncFiltersToDateStart_(dateStart){
      const ds = String(dateStart || "").trim();
      if (!ds) return false;
      
      
      // 1) YYYY-MM-DD â†’ day ìš°ì„ 
      if (/^\d{4}-\d{2}-\d{2}$/.test(ds)){
      if (el.day) el.day.value = ds;
      if (el.start) el.start.value = "";
      if (el.end) el.end.value = "";
      if (el.year) el.year.value = "";
      if (el.month) el.month.value = "";
      return true;
      }
      
      
      // 2) YYYY-MM â†’ year/month
      if (/^\d{4}-\d{2}$/.test(ds)){
      const y = ds.slice(0,4);
      const m = String(Number(ds.slice(5,7))); // 01 â†’ 1
      if (el.year) el.year.value = y;
      if (el.month) el.month.value = m;
      if (el.day) el.day.value = "";
      if (el.start) el.start.value = "";
      if (el.end) el.end.value = "";
      return true;
      }
      
      
      // 3) YYYY â†’ ê¸°ê°„ìœ¼ë¡œ ì¡ì•„ì¤Œ(ì—°/ì›” ì—†ì´ë„ buildListUrl í†µê³¼)
      if (/^\d{4}$/.test(ds)){
      if (el.day) el.day.value = "";
      if (el.year) el.year.value = "";
      if (el.month) el.month.value = "";
      if (el.start) el.start.value = ds + "-01-01";
      if (el.end) el.end.value = ds + "-12-31";
      return true;
      }
    
    
    return false;
    }


    function debounce_(fn, ms){
      let t = null;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }
    
    function applyTgView_(){
      const allItems = Array.isArray(tg._allItems) ? tg._allItems : [];
      let items = allItems.slice();
    
      // 1) íƒœê·¸ ë¹„ì–´ìˆëŠ” ê²ƒë§Œ
      if (tg.onlyEmpty && tg.onlyEmpty.checked) {
        items = items.filter(it => !String(it.tags || "").trim());
      }
    
      // 2) ìˆ¨ê¹€ ë³´ê¸° í•„í„°(ê¸°ì¡´ ë¡œì§ê³¼ ë™ì¼)
      const view = tg.hiddenView ? tg.hiddenView.value : "all";
      if (view === "exclude") items = items.filter(it => it.hidden !== true);
      if (view === "only")    items = items.filter(it => it.hidden === true);
    
      // 3) ê²€ìƒ‰(ì œëª©/ë‚´ìš©/íƒœê·¸/ID/ë‚ ì§œ/party)
      const q = String(tg.query?.value || "").trim().toLowerCase();
      if (q){
        const tokens = q.split(/\s+/g).filter(Boolean); // ê³µë°± ê¸°ì¤€ AND ê²€ìƒ‰
        items = items.filter(it=>{
          const hay = [
            it.id, it.title, it.content_raw, it.tags, it.date_start, it.date_end, it.party, it.country
          ].map(v=>String(v||"")).join(" ").toLowerCase();
          return tokens.every(tok => hay.includes(tok));
        });
      }
    
      // 4) ë‚ ì§œ ì •ë ¬
      const sort = String(tg.sort?.value || "date_desc");
      const toTime = (d)=> {
        const s = String(d||"").trim();
        if (!s) return 0;
        const t = Date.parse(s);
        return Number.isFinite(t) ? t : 0;
      };
    
      items.sort((a,b)=>{
        const ta = toTime(a.date_start);
        const tb = toTime(b.date_start);
        if (ta !== tb) return (sort === "date_asc") ? (ta - tb) : (tb - ta);
        // tie-breaker: id (ì•ˆì •ì ìœ¼ë¡œ)
        return String(a.id||"").localeCompare(String(b.id||""), "ko");
      });
    
      // 5) ë Œë” + ë°”ì¸ë”©
      tg.cards.innerHTML = items.map(it => renderEventCardHtml(it)).join("");
      items.forEach(it => bindEventCard(it));
    
      // ìƒíƒœ í‘œì‹œ(ì›ë³¸ ëŒ€ë¹„)
      const hiddenCnt = allItems.filter(it => it.hidden === true).length;
      tg.status.textContent =
        `${items.length}ê±´ í‘œì‹œ / ì „ì²´ ${allItems.length}ê±´ (ìˆ¨ê¹€ ${hiddenCnt}ê±´)`;
    }
    
    async function loadTagCards(){
      try{
        tg.status.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        tg.cards.innerHTML = "";
    
        const url = buildListUrl();
        const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
        if (!res.ok) throw new Error("ëª©ë¡ API ì‹¤íŒ¨ (HTTP " + res.status + ")");
    
        const data = await safeReadJson_(res);
        if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "UNKNOWN_ERROR");
    
        const allItems = Array.isArray(data.items) ? data.items : [];
        tg._allItems = allItems.slice();   // âœ… ì›ë³¸ ì €ì¥
        applyTgView_();                    // âœ… ì •ë ¬/ê²€ìƒ‰/í•„í„° + ë Œë”ê¹Œì§€ ì—¬ê¸°ì„œ ì²˜ë¦¬
      }catch(e){
        tg.status.textContent = "";
        alert("íƒœê·¸ ê²€ìˆ˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (e && e.message ? e.message : String(e)));
      }
    }

    function parseTagsToArray(s){
      return String(s || "")
        .split(",")
        .map(x=>String(x).trim())
        .filter(Boolean);
    }

    function toDbBase(ui){ return `${BASE_DB_PREFIX}${ui}`; }
    function hasDbBase(arr, ui){ return arr.includes(toDbBase(ui)); }
    function addDbBase(arr, ui){
      const t = toDbBase(ui);
      if (arr.includes(t)) return arr;
      return arr.concat([t]);
    }
    function removeDbBase(arr, ui){
      const t = toDbBase(ui);
      return arr.filter(x => x !== t);
    }

    function getGroupTag(arr){
      for (const t of arr){
        const s = String(t||"").trim();
        if (GROUP_RE.test(s)) return s;
      }
      return "";
    }
    function removeGroupTags(arr){
      return arr.filter(t => !GROUP_RE.test(String(t||"").trim()));
    }

    // âœ… important-* ë³µìˆ˜ ì¶”ì¶œ (important / important-ë¼ë²¨ ëª¨ë‘ ëŒ€ì‘)
    function getTypedTagValues(arr, type){
      const out = [];
      for (const t of (arr || [])){
        const s = String(t||"").trim();
        if (s === type) { out.push(""); continue; }
        if (s.startsWith(type + "-")) out.push(s.slice(type.length + 1));
      }
      return out;
    }
    
    // âœ… ë‹¨ì¼ ê°’ì´ í•„ìš”í•œ ê³³(economy/mourning ë“±)ì—ì„œ ì“°ëŠ” ë˜í¼
    function getTypedTagValue(arr, type){
      const vals = getTypedTagValues(arr, type);
      if (!vals.length) return null; // ì•„ì˜ˆ ì—†ìœ¼ë©´ null
      const first = vals.find(v => String(v).trim().length > 0);
      return (first != null) ? first : ""; // [""] í˜•íƒœë©´ ""
    }
    
    function hasTypedTag(arr, type){
      return getTypedTagValues(arr, type).length > 0;
    }
    
    function removeTyped(arr, type){
      return arr.filter(t=>{
        const s = String(t||"").trim();
        return !(s === type || s.startsWith(type + "-"));
      });
    }
    
    function upsertTyped(arr, type, value){
      const kept = removeTyped(arr, type);
      const v = String(value || "").trim();
      return kept.concat([ v ? `${type}-${v}` : type ]);
    }

    function normalizeTagsArray(arr){
      const seen = new Set();
      const uniq = [];
      arr.forEach(t=>{
        const s = String(t||"").trim();
        if (!s) return;
        if (seen.has(s)) return;
        seen.add(s);
        uniq.push(s);
      });

      const baseOrder = BASE_UI.map(ui => toDbBase(ui));
      const typedOrder = ["economy","important","mnforce","mourning","mourning"];

      const group = [];
      const base = [];
      const typed = [];
      const other = [];

      uniq.forEach(t=>{
        const s = String(t||"").trim();
        if (GROUP_RE.test(s)) { group.push(s); return; }
        if (baseOrder.includes(s)) { base.push(s); return; }

        const m = /^([a-z]+)(?:-.*)?$/i.exec(s);
        const tp = m ? String(m[1]).toLowerCase() : "";
        if (typedOrder.includes(tp)) { typed.push(s); return; }

        other.push(s);
      });

      const groupOne = group.length ? [group[0]] : [];

      const baseSorted = [];
      baseOrder.forEach(x=>{ if (base.includes(x)) baseSorted.push(x); });

      const typedSorted = [];
      const picked = new Set();
      
      typedOrder.forEach(tp=>{
        if (tp === "important"){
          // âœ… importantëŠ” ì „ë¶€ ìœ ì§€(ì›ë˜ ë“±ì¥ ìˆœì„œ ìœ ì§€)
          const allImp = typed.filter(t=>{
            const m = /^([a-z]+)(?:-.*)?$/i.exec(String(t||"").trim());
            const x = m ? String(m[1]).toLowerCase() : "";
            return x === "important";
          });
          allImp.forEach(t => typedSorted.push(t));
          return;
        }
      
        // ê¸°ì¡´: economy/mourningì€ 1ê°œë§Œ
        const found = typed.find(t=>{
          const m = /^([a-z]+)(?:-.*)?$/i.exec(t);
          const x = m ? String(m[1]).toLowerCase() : "";
          return x === tp;
        });
        if (found && !picked.has(tp)) { picked.add(tp); typedSorted.push(found); }
      });

      return groupOne.concat(baseSorted).concat(typedSorted).concat(other);
    }

    function showNote(root, type, on){
      const box = root.querySelector(`.tag-note[data-note="${type}"]`);
      if (!box) return;
      box.style.display = on ? "flex" : "none";
    }
    function focusNote(root, type){
      const input = root.querySelector(`.tag-note[data-note="${type}"] input`);
      if (input) input.focus();
    }
    function clearNote(root, type){
      const input = root.querySelector(`.tag-note[data-note="${type}"] input`);
      if (input) input.value = "";
    }

    function buildPreview(text){
      const s = String(text || "").replace(/\s+/g," ").trim();
      if (!s) return "<span style='color:rgba(17,24,39,0.55)'>ë‚´ìš© ì—†ìŒ</span>";
      const cut = s.length > 220 ? (s.slice(0,220) + "â€¦") : s;
      return escHtml(cut);
    }

    /* âœ… [ì¶”ê°€] ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” hidden ì»¬ëŸ¼ íŒì •(í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •) */
    function isHiddenItem_(it, tagsArr){
      // ì„œë²„ ì»¬ëŸ¼ëª…ì´ hide/is_hidden/hidden ì¤‘ ë¬´ì—‡ì´ë“  ëŒ€ì‘
      const v = (it && (it.hidden ?? it.is_hidden ?? it.hide));
      if (parseBool_(v)) return true;

      // (í˜¹ì‹œ íƒœê·¸ ê¸°ë°˜ì´ ì„ì—¬ìˆë‹¤ë©´ ë³´ì¡°ë¡œ ëŒ€ì‘)
      if (Array.isArray(tagsArr) && tagsArr.includes("__HIDE")) return true;

      return false;
    }

    function renderEventCardHtml(it){
      const id = escAttr(it.id);
      const title = escHtml(it.title || "");
      const date = escHtml(it.date_start || "");
      const party = escHtml(it.party || "");

      const tags = parseTagsToArray(it.tags || "");
      const hidden = isHiddenItem_(it, tags);

      const hasBosu  = hasDbBase(tags, "ë³´ìˆ˜");
      const hasJinbo = hasDbBase(tags, "ì§„ë³´");
      const hasIntl  = hasDbBase(tags, "êµ­ì œ");
      const hasIssue = hasDbBase(tags, "ì´ìŠˆ");

      const ecoVal = getTypedTagValue(tags, "economy");
      const mouVal = getTypedTagValue(tags, "mourning");
      
      // âœ… importantëŠ” ë³µìˆ˜
      const impVals = getTypedTagValues(tags, "important");
      const impVal  = impVals.filter(v => String(v).trim()).join(", ");
      
      // âœ… [ì¶”ê°€] ì›”ìš”ì•½ ê°•ì œ(ë³µìˆ˜)
      const forceVals = getTypedTagValues(tags, "mnforce");
      const forceOn = forceVals.length > 0;
      
      const ecoOn = ecoVal != null;
      const mouOn = mouVal != null;
      const impOn = impVals.length > 0;

      const groupTag = getGroupTag(tags) || "";

      const pillId = `pill_${id}`;
      const noteEId = `note_e_${id}`;
      const noteIId = `note_i_${id}`;
      const noteMId = `note_m_${id}`;

      const contentPreview = buildPreview(it.content_raw || "");

      return `
      <div class="ev-card${hidden ? " is-hidden" : ""}${impOn ? " is-important" : ""}" data-id="${id}" data-hidden="${hidden ? "1" : "0"}">
        <div class="ev-head">
          <div>
            <div class="ev-title">${title}</div>
            <div class="ev-meta">${date}${party ? " Â· " + party : ""} Â· ${id}</div>
          </div>
          <div class="ev-actions">
            <!-- âœ… [ì¶”ê°€] ë¹„í‘œì‹œ í† ê¸€ -->
            <label class="hide-toggle" title="ë¹„í‘œì‹œ(íˆë“ ) ì²˜ë¦¬">
              <input type="checkbox" data-action="hide-toggle" ${hidden ? "checked" : ""}/>
              ë¹„í‘œì‹œ
            </label>

            <span id="${pillId}" class="save-pill">ëŒ€ê¸°</span>
            <button type="button" class="btn-mini ghost" data-action="edit-toggle">í¸ì§‘</button>
          </div>
        </div>

        <div class="ev-body">${contentPreview}</div>

        <div class="ev-editor" data-role="editor">
          <div class="ev-edit-grid">
            <div class="ev-edit-field">
              <label>date_start</label>
              <input data-role="edit-start" type="date" value="${escAttr(it.date_start || "")}" />
            </div>
            <div class="ev-edit-field">
              <label>date_end</label>
              <input data-role="edit-end" type="date" value="${escAttr(it.date_end || "")}" />
            </div>
          </div>

          <div class="ev-edit-field">
            <label>title</label>
            <input data-role="edit-title" type="text" value="${escAttr(it.title || "")}" />
          </div>

          <div class="ev-edit-field">
            <label>image_url</label>
            <input data-role="edit-image-url" type="url" placeholder="https://..." value="${escAttr(it.image_url || "")}" />
          </div>

            <div class="ev-edit-field">
              <div class="ev-edit-label">ìŠ¤í¬ë¦°ìƒ· ë¶™ì—¬ë„£ê¸°</div>
              <div class="paste-zone" data-role="paste-image" contenteditable="true" spellcheck="false" tabindex="0">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê³  Ctrl+V</div>
              <div class="paste-hint">âœ… ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°(Ctrl+V)ê°€ ë“¤ì–´ì˜¤ë©´ Driveì— ì €ì¥í•˜ê³  <b>image_url</b>ì„ ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤. (image_url ì…ë ¥ì¹¸ì—ì„œ Ctrl+V í•´ë„ ë™ì¼)</div>
              <div class="paste-preview" data-role="paste-preview"></div>
            </div>


          <div class="ev-edit-field">
            <label>content_raw</label>
            <textarea data-role="edit-content">${escHtml(it.content_raw || "")}</textarea>
          </div>

          <div class="ev-edit-actions">
          <button type="button" class="btn-mini primary" data-action="edit-save">ì €ì¥</button>
          <button type="button" class="btn-mini" data-action="edit-cancel">ì·¨ì†Œ</button>
          
          
          <!-- âœ… ìƒˆ id ì¬ìƒì„±(appendEvent AUTO) + ê¸°ì¡´ ìˆ¨ê¹€(patchHidden) -->
          <button type="button" class="btn-mini" data-action="edit-recreate">ì¬ë“±ë¡(AUTO)</button>
          
          
          <span class="tag-hint">â€» ì €ì¥ ì‹œ date_typeì€ start/endë¡œ ìë™ ê³„ì‚° Â· ì¬ë“±ë¡ì€ ìƒˆ id ìƒì„± í›„ ê¸°ì¡´ ê±´ì„ ë¹„í‘œì‹œ ì²˜ë¦¬</span>
          </div>
        </div>

        <div class="ev-tags">
          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ë³´ìˆ˜" ${hasBosu ? "checked":""}/>ë³´ìˆ˜</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ì§„ë³´" ${hasJinbo ? "checked":""}/>ì§„ë³´</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="êµ­ì œ" ${hasIntl ? "checked":""}/>êµ­ì œ</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ì´ìŠˆ" ${hasIssue ? "checked":""}/>ì´ìŠˆ</label>
            <span class="tag-hint">(DB: ì¤‘ìš”-*)</span>
          </div>

          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="economy" ${ecoOn ? "checked":""}/>economy</label>
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="important" ${impOn ? "checked":""}/>important</label>
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="mourning" ${mouOn ? "checked":""}/>mourning</label>
          </div>

          <div class="tag-group">
            <span style="font-weight:900;">ì„œë¸Œì¹´ë“œ ê·¸ë£¹</span>
            <div class="group-editor" data-tg="group">
              <input data-role="group-input" type="text" placeholder="ì˜ˆ) E-202601-01" value="${escAttr(groupTag)}" />
              <button type="button" class="btn-mini primary" data-action="group-apply">ì ìš©</button>
              <button type="button" class="btn-mini danger" data-action="group-clear">í•´ì œ</button>
              <span class="tag-hint">E-xxxxxx-xx (1ê°œ ìœ ì§€)</span>
            </div>
          </div>
        </div>

        <div class="tag-note" data-note="economy" style="${ecoOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">economy</b>
          <input id="${noteEId}" type="text" placeholder="ì˜ˆ) í™˜ìœ¨/ê¸ˆë¦¬/ìœ ê°€" value="${escAttr(ecoVal || "")}" />
        </div>

        <div class="tag-note" data-note="important" style="${impOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">important</b>
          <input id="${noteIId}" type="text" placeholder="ì˜ˆ) ì™œ ì¤‘ìš”í•œì§€ í•œ ì¤„" value="${escAttr(impVal || "")}" />
        
          <!-- âœ… [ì¶”ê°€] ì›” ìš”ì•½ ê°•ì œ í¬í•¨ -->
          <label style="display:flex; gap:6px; align-items:center; font-weight:900; margin-left:10px; white-space:nowrap;">
            <input type="checkbox" data-role="mnforce" ${forceOn ? "checked" : ""}/>
            ì›”ìš”ì•½ ê°•ì œ
          </label>
        </div>

        <div class="tag-note" data-note="mourning" style="${mouOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">mourning</b>
          <input id="${noteMId}" type="text" placeholder="ì˜ˆ) í™•ì‚°/ì¦í­ í¬ì¸íŠ¸" value="${escAttr(mouVal || "")}" />
        </div>

        <textarea data-role="tags-raw" style="display:none;">${escHtml(tags.join(","))}</textarea>
      </div>
      `;
    }

    function scheduleSave(id, tagsArr, pillEl){
      if (saveTimers.has(id)) clearTimeout(saveTimers.get(id));

      pillEl.classList.remove("saved","err");
      pillEl.classList.add("saving");
      pillEl.textContent = "ì €ì¥ì¤‘";

      const timer = setTimeout(async ()=>{
        try{
          const ok = await postPatchTags(id, tagsArr.join(","));
          if (!ok) throw new Error("SAVE_FAILED");

          pillEl.classList.remove("saving","err");
          pillEl.classList.add("saved");
          pillEl.textContent = "ì €ì¥ë¨";
        }catch(e){
          pillEl.classList.remove("saving","saved");
          pillEl.classList.add("err");
          pillEl.textContent = "ì˜¤ë¥˜";
        }
      }, SAVE_DEBOUNCE_MS);

      saveTimers.set(id, timer);
    }

    async function postPatchTags(id, tags){
      const params = new URLSearchParams();
      params.set("mode","patchTags");
      if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;

      try{
        const body = new URLSearchParams();
        body.set('id', String(id||''));
        body.set('tags', String(tags||''));

        const res = await fetch(url, {
          method:"POST",
          body,
          cache:"no-store",
          credentials:"omit"
        });

        if (res.ok){
          const data = await safeReadJson_(res);
          if (data && data.ok === true) return true;
        }
      }catch(_){ }

      return false;
    }

    async function postPatchEvent(id, patch){
      const params = new URLSearchParams();
      params.set('mode','patchEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;
    
      try{
        const body = new URLSearchParams();
        body.set('id', String(id||''));
        if (patch && patch.date_start != null) body.set('date_start', String(patch.date_start||''));
        if (patch && patch.date_end != null)   body.set('date_end', String(patch.date_end||''));
        if (patch && patch.title != null)      body.set('title', String(patch.title||''));
        if (patch && patch.content_raw != null)body.set('content_raw', String(patch.content_raw||''));
        if (patch && patch.image_url != null)  body.set('image_url', String(patch.image_url||''));
    
        const res = await fetch(url, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
    
        // JSON íŒŒì‹± ì‹œë„
        let data = null;
        try { data = JSON.parse(text); } catch(_){}
    
        if (!res.ok){
          return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        }
        if (!data){
          return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        }
        if (data.ok !== true){
          return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
        }
        return { ok:true, data };
      }catch(e){
        return { ok:false, error: e && e.message ? e.message : String(e) };
      }
    }

    // âœ… ì¬ë°œê¸‰(ë®ì–´ì“°ê¸°): date_start ê¸°ì¤€ìœ¼ë¡œ idê¹Œì§€ ì¬ì‚°ì •
    async function postReissueEvent(id, patch, force){
      const params = new URLSearchParams();
      params.set('mode','reissueEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;
    
      try{
        const body = new URLSearchParams();
        body.set('id', String(id||''));
        if (patch && patch.date_start != null) body.set('date_start', String(patch.date_start||''));
        if (patch && patch.date_end != null)   body.set('date_end', String(patch.date_end||''));
        if (patch && patch.title != null)      body.set('title', String(patch.title||''));
        if (patch && patch.content_raw != null)body.set('content_raw', String(patch.content_raw||''));
        if (patch && patch.image_url != null)  body.set('image_url', String(patch.image_url||''));
        if (force === true) body.set('force', 'true');
    
        const res = await fetch(url, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
    
        let data = null;
        try { data = JSON.parse(text); } catch(_){}
    
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data)  return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
    
        return { ok:true, data };
      }catch(e){
        return { ok:false, error: e && e.message ? e.message : String(e) };
      }
    }

    async function postUploadImage(id, title, mime, base64){
      const params = new URLSearchParams();
      params.set('mode','uploadImage');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;

      // âœ… ë””ë²„ê·¸ìš©: ì›ë¬¸/ìƒíƒœì½”ë“œê¹Œì§€ í•­ìƒ í™•ë³´
      const mkErr = (label, extra) => {
        const parts = [];
        if (label) parts.push(String(label));
        if (extra && typeof extra === 'object'){
          try{ parts.push(JSON.stringify(extra)); }catch(_){ parts.push(String(extra)); }
        }else if (extra != null){
          parts.push(String(extra));
        }
        return parts.join(' | ').slice(0, 2000);
      };

      try{
        // âœ… JSON ê¸ˆì§€: preflight(OPTIONS) ì•ˆ ìƒê¸°ê²Œ "í¼ ì „ì†¡"ìœ¼ë¡œ ë³´ëƒ„
        const body = new URLSearchParams();
        body.set('id', String(id||''));
        body.set('title', String(title||''));
        body.set('mime', String(mime||''));
        body.set('data', String(base64||''));

        const res = await fetch(url, {
          method:'POST',
          body,                 // âœ… form-urlencoded
          cache:'no-store',
          credentials:'omit'    // ìœ ì§€
          // âœ… headers ì„¤ì •í•˜ì§€ ë§ ê²ƒ!
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch(_){ }

        // âœ… ì½˜ì†”ì— ìµœì†Œ ì •ë³´ ë‚¨ê¹€(ì•Œë¦¼ì´ ì§§ì•„ë„ ì›ì¸ ì¶”ì  ê°€ëŠ¥)
        try{
          console.log('[uploadImage] url=', url);
          console.log('[uploadImage] status=', res.status);
          console.log('[uploadImage] raw=', (text||'').slice(0, 500));
        }catch(_){ }

        if (!res.ok){
          return { ok:false, error: mkErr(`HTTP ${res.status}`, (data ? data : String(text || '').slice(0,500))), raw:text, status:res.status, url };
        }

        if (!data){
          return { ok:false, error: mkErr('JSON_PARSE_FAILED', String(text || '').slice(0,500)), raw:text, status:res.status, url };
        }

        if (data.ok !== true) {
          const msg = (data && data.detail)
            ? `${data.error}: ${data.detail}`
            : (data && data.error ? String(data.error) : 'UPLOAD_FAILED');

          return { ok:false, error: mkErr('API_ERROR', { msg, build: data._build, ts: data._ts }), raw:text, status:res.status, url, data };
        }

        return { ok:true, data, raw:text, status:res.status, url };
      }catch(e){
        const msg = e && e.message ? e.message : String(e);
        return { ok:false, error: mkErr('FETCH_ERROR', msg), status:0, url };
      }
    }


    
    function safePipe_(s){
      // | ê°€ ë“¤ì–´ê°€ë©´ 11ì¹¸ íŒŒì‹±ì´ ê¹¨ì§€ë¯€ë¡œ ì¹˜í™˜
      return String(s ?? "").replaceAll("|", "ï½œ");
      }
      
      
      async function postAppendEventLine(line){
      const params = new URLSearchParams();
      params.set('mode','appendEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;
      
      
      try{
      const body = new URLSearchParams();
      body.set('line', String(line || ''));
      
      
      const res = await fetch(url, { method:'POST', body, cache:'no-store', credentials:'omit' });
      const text = await res.text();
      
      
      let data = null;
      try { data = JSON.parse(text); } catch(_){ }
      
      
      if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
      if (!data) return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
      if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
      
      
      // Apps Script appendEvent ì„±ê³µ ì‹œ {ok:true, id:"YYMMDD-##"} í˜•íƒœ
      return { ok:true, id: String(data.id || '') };
      
      
      }catch(e){
      return { ok:false, error: e && e.message ? e.message : String(e) };
      }
    }

    
    async function postPatchHidden(id, hidden){
      const params = new URLSearchParams();
      params.set('mode','patchHidden');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const url = `${API_BASE}?${params.toString()}`;
    
      try{
        const body = new URLSearchParams();
        body.set('id', String(id||''));
        body.set('hidden', hidden ? 'true' : 'false');
    
        const res = await fetch(url, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
    
        let data = null;
        try { data = JSON.parse(text); } catch(_){}
    
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data)    return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
    
        return { ok:true, data };
      }catch(e){
        return { ok:false, error: e && e.message ? e.message : String(e) };
      }
    }
 
    function bindEventCard(it){
      const root = tg.cards.querySelector(`.ev-card[data-id="${CSS.escape(it.id)}"]`);
      if (!root) return;

      const pill = root.querySelector(`#pill_${CSS.escape(it.id)}`);

      const editor = root.querySelector('[data-role="editor"]');
      const btnToggle = root.querySelector('[data-action="edit-toggle"]');
      const btnSave = root.querySelector('[data-action="edit-save"]');
      const btnCancel = root.querySelector('[data-action="edit-cancel"]');
      const inStart = root.querySelector('[data-role="edit-start"]');
      const inEnd = root.querySelector('[data-role="edit-end"]');
      const inTitle = root.querySelector('[data-role="edit-title"]');
      const inContent = root.querySelector('[data-role="edit-content"]');
      const inImageUrl = root.querySelector('[data-role="edit-image-url"]');
      const pasteZone = root.querySelector('[data-role="paste-image"]');
      const pastePreview = root.querySelector('[data-role="paste-preview"]');

      const btnRecreate = root.querySelector('[data-action="edit-recreate"]');
      
      const uiTitle = root.querySelector('.ev-title');
      const uiMeta = root.querySelector('.ev-meta');
      const uiBody = root.querySelector('.ev-body');

      /* âœ… [ì¶”ê°€] ë¹„í‘œì‹œ í† ê¸€ */
      const hideChk = root.querySelector('[data-action="hide-toggle"]');
      const applyHiddenUi = (on) => {
        root.classList.toggle('is-hidden', !!on);
        root.dataset.hidden = on ? '1' : '0';
      };
      let originalHidden = !!(hideChk && hideChk.checked);
      applyHiddenUi(originalHidden);

      // âœ… important UI í† ê¸€(ì¹´ë“œ ë¶‰ì€ ê°•ì¡° + ë¼ë²¨ ê°•ì¡°)
      const impChk = root.querySelector('input[type="checkbox"][data-tg="typed"][data-key="important"]');
      const impLabel = impChk ? impChk.closest('label') : null;
      
      const applyImportantUi = (on) => {
        root.classList.toggle('is-important', !!on);
        if (impLabel) impLabel.classList.toggle('is-important-tag', !!on);
      };
      
      // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
      applyImportantUi(!!(impChk && impChk.checked));
    
      
      const setPill = (state, text) => {
        if (!pill) return;
        pill.classList.remove('saving','saved','err');
        if (state) pill.classList.add(state);
        pill.textContent = text;
      };

      // âœ… Google Drive URLì—ì„œ íŒŒì¼ ID ì¶”ì¶œ & ì¸ë„¤ì¼ URL ìƒì„±
      const driveIdFromUrl_ = (u) => {
        const s = String(u || '');
        // 1) ...?id=FILE_ID
        let m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
        if (m && m[1]) return m[1];
        // 2) /d/FILE_ID/...
        m = s.match(/\/d\/([a-zA-Z0-9_-]{10,})(?:[/?]|$)/);
        if (m && m[1]) return m[1];
        return '';
      };
      const toDriveThumbUrl_ = (u) => {
        const id = driveIdFromUrl_(u);
        if (!id) return '';
        // Driveê°€ ì¸ë„¤ì¼ì„ ë§Œë“¤ì–´ì£¼ëŠ” ì—”ë“œí¬ì¸íŠ¸(ê³µìœ  ê¶Œí•œì´ ìˆì–´ì•¼ í‘œì‹œë¨)
        return `https://drive.google.com/thumbnail?id=${id}&sz=w200`;
      };

      // âœ… image_url â†’ ë¯¸ë¦¬ë³´ê¸° ë™ê¸°í™”
      const renderImagePreview = (rawUrl) => {
        if (!pastePreview) return;
      
        const url = String(rawUrl || "").trim();
        if (!url) {
          pastePreview.style.display = "none";
          pastePreview.innerHTML = "";
          return;
        }

        const thumb = toDriveThumbUrl_(url) || url;
        pastePreview.style.display = "flex"; // âœ… CSSì™€ ë§ì¶° flexë¡œ í‘œì‹œ
        pastePreview.innerHTML = `
          <a href="${escAttr(url)}" target="_blank" rel="noopener">ì›ë³¸ ì—´ê¸°</a>
          <img src="${escAttr(thumb)}" alt="" loading="lazy" />
        `;

        // âœ… ì¸ë„¤ì¼ì´ ê¹¨ì§€ëŠ” ê²½ìš°(ê¶Œí•œ/URL ë¬¸ì œ) - ë§í¬ëŠ” ìœ ì§€í•˜ê³  íŒíŠ¸ë§Œ í‘œì‹œ
        const img = pastePreview.querySelector('img');
        if (img){
          img.addEventListener('error', ()=>{
            try{ img.remove(); }catch(_){ }
            pastePreview.insertAdjacentHTML('beforeend', '<span class="tag-hint">ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨</span>');
          }, { once:true });
        }
      };
      
      // clipboard paste(image) -> upload -> fill image_url -> save (image_url only)
      const handleImagePaste = async (e)=>{
        try{
          // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€(ìº¡ì²˜/ë²„ë¸” ì¤‘ì²© ë“±)
          if (e && e.__dlImgHandled) return;

          const items = (e.clipboardData && e.clipboardData.items) ? Array.from(e.clipboardData.items) : [];
          const imgItem = items.find(x => x && x.type && x.type.indexOf('image/') === 0);
          if (!imgItem) return; // í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°ëŠ” ê·¸ëŒ€ë¡œ í†µê³¼

          // ì´ì œë¶€í„°ëŠ” â€œì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°â€ë¡œ ì²˜ë¦¬
          e.__dlImgHandled = true;
          e.preventDefault();
          e.stopPropagation();

          setPill('saving','ì—…ë¡œë“œì¤‘');

          const blob = imgItem.getAsFile();
          const mime = blob && blob.type ? blob.type : 'image/png';
          const b64 = await readBlobAsBase64_(blob);

          const curTitle = String(inTitle?.value || it.title || '').trim();
          const up = await postUploadImage(it.id, curTitle, mime, b64);
          if (!up || up.ok !== true){
            const dbg = up ? (up.error || JSON.stringify(up).slice(0,800)) : 'NO_RESPONSE';
            throw new Error(String(dbg || 'UPLOAD_FAILED'));
          }

          const url = String(up.data && up.data.url ? up.data.url : '').trim();
          if (!url) throw new Error('URL_EMPTY');

          if (inImageUrl) inImageUrl.value = url;

          // âœ… ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ê°±ì‹ 
          renderImagePreview(url);
          
          // âœ… image_urlë§Œ DBì— ì¦‰ì‹œ ë°˜ì˜(ë‹¤ë¥¸ í•„ë“œ ë®ì–´ì“°ê¸° ë°©ì§€)
          const saved = await postPatchEvent(it.id, { image_url: url });
          if (!saved.ok) throw new Error(saved.error || 'PATCH_FAILED');
          
          // âœ… ì·¨ì†Œ/ì¬ë¡œë”© ì‹œ ì•ˆ ì‚¬ë¼ì§€ê²Œ ìŠ¤ëƒ…ìƒ·ë„ ê°±ì‹ 
          original.image_url = url;
          it.image_url = url;
          if (!saved.ok) throw new Error(saved.error || 'PATCH_FAILED');

          setPill('saved','ì—…ë¡œë“œë¨');
        }catch(err){
          setPill('err','ì˜¤ë¥˜');
          console.log('upload debug(err)=', err);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err && err.message ? err.message : String(err)));
        }
      };

      // âœ… ì–´ë””ì— ì»¤ì„œê°€ ìˆì–´ë„(íŠ¹íˆ image_url input) ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°ê°€ ë™ì‘í•˜ë„ë¡
      if (pasteZone) pasteZone.addEventListener('paste', handleImagePaste);
      if (inImageUrl) inImageUrl.addEventListener('paste', handleImagePaste);
      // ì¹´ë“œ ì˜ì—­ ì–´ë””ì„œë“  Ctrl+V ê°€ëŠ¥(í…ìŠ¤íŠ¸ëŠ” í†µê³¼, ì´ë¯¸ì§€ì¼ ë•Œë§Œ ì—…ë¡œë“œ)
      root.addEventListener('paste', handleImagePaste, true);

      if (inImageUrl) {
        inImageUrl.addEventListener('input', () => {
          renderImagePreview(inImageUrl.value);
        });
        inImageUrl.addEventListener('change', () => {
          renderImagePreview(inImageUrl.value);
        });
      }
      

      if (hideChk){
          hideChk.addEventListener('change', async ()=>{
          const on = !!hideChk.checked;
          applyHiddenUi(on);
          setPill('saving','ì €ì¥ì¤‘');
        
          const r = await postPatchHidden(it.id, on);
        
          if (r.ok){
            setPill('saved','ì €ì¥ë¨');
            originalHidden = on;
          }else{
            setPill('err','ì˜¤ë¥˜');
            alert('ë¹„í‘œì‹œ ì €ì¥ ì‹¤íŒ¨: ' + r.error);
        
            // ì‹¤íŒ¨ ì‹œ ì›ë³µ
            hideChk.checked = originalHidden;
            applyHiddenUi(originalHidden);
          }
        });
      }

      const snap = () => ({
        date_start: String(inStart?.value || '').trim(),
        date_end: String(inEnd?.value || '').trim(),
        title: String(inTitle?.value || '').trim(),
        content_raw: String(inContent?.value || ''),
        image_url: String(inImageUrl?.value || '').trim(),
        hidden: !!(hideChk && hideChk.checked)
      });
      let original = snap();
      renderImagePreview(original.image_url); // âœ… ì¹´ë“œ ë¡œë“œ ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ë„ í‘œì‹œ

      const openEditor = (on) => {
        if (!editor) return;
        editor.classList.toggle('open', !!on);
        if (on) {
          original = snap();
          renderImagePreview(original.image_url); // âœ… ì—´ ë•Œë„ ë™ê¸°í™”
        }
      };
if (btnToggle){
        btnToggle.addEventListener('click', ()=>{
          const isOpen = editor && editor.classList.contains('open');
          openEditor(!isOpen);
        });
      }

      if (btnCancel){
        btnCancel.addEventListener('click', ()=>{
          if (inStart) inStart.value = original.date_start || '';
          if (inEnd) inEnd.value = original.date_end || '';
          if (inTitle) inTitle.value = original.title || '';
          if (inContent) inContent.value = original.content_raw || '';
          if (inImageUrl) inImageUrl.value = original.image_url || '';

          if (hideChk){
            hideChk.checked = !!original.hidden;
            applyHiddenUi(!!original.hidden);
          }
          renderImagePreview(original.image_url); // âœ… ì·¨ì†Œ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì›ë³µ

          openEditor(false);
        });
      }

    if (btnRecreate){
      btnRecreate.addEventListener('click', async ()=>{
        try{
          const cur = snap();
    
          // ìµœì†Œ ê²€ì¦
          if (!cur.title){ alert('titleì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
          if (!String(cur.date_start||'').trim() && String(cur.date_end||'').trim()){
            alert('date_endë¥¼ ì“°ë ¤ë©´ date_startê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
          }
    
          setPill('saving','ì¬ë°œê¸‰ì¤‘');
    
          // âœ… ê°™ì€ í–‰ì„ â€œëŒ€ì²´(ë®ì–´ì“°ê¸°)â€í•˜ë©´ì„œ, date_start ê¸°ì¤€ìœ¼ë¡œ idê¹Œì§€ ì¬ì‚°ì •
          // - force=true: ë²„íŠ¼ì„ ëˆ„ë¥¸ ê²½ìš°ì—ëŠ” ê°™ì€ ë‚ ì§œì—¬ë„ ìƒˆ idë¥¼ ë°œê¸‰
          const r = await postReissueEvent(it.id, {
            date_start: cur.date_start || '',
            date_end: cur.date_end || '',
            title: cur.title || '',
            content_raw: cur.content_raw || '',
            image_url: cur.image_url || ''
          }, true);
    
          if (!r.ok) throw new Error(r.error || 'reissueEvent ì‹¤íŒ¨');
    
          const newId = String(r.data?.new_id || '');
          const oldId = String(r.data?.old_id || String(it.id||''));
    
          setPill('saved', (newId && newId !== oldId) ? `ì¬ë°œê¸‰ë¨ â†’ ${newId}` : 'ì €ì¥ë¨');
    
          // âœ… ìƒˆ date_start ê¸°ì¤€ìœ¼ë¡œ í•„í„° ë™ê¸°í™” (í•„í„° ë°–ì´ë©´ ì¹´ë“œê°€ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ)
          syncFiltersToDateStart_(cur.date_start);
    
          // idê°€ ë°”ë€Œë©´ í˜„ì¬ ì¹´ë“œì˜ data-idë„ ê°±ì‹ (ë¦¬ë Œë” ì „ê¹Œì§€ë¼ë„ ì¼ê´€ì„± ìœ ì§€)
          if (newId) root.dataset.id = newId;
    
          // ì •ë ¬/í‘œì‹œ ë³´ì¥: ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          if (typeof loadTagCards === 'function'){
            await loadTagCards();
          }
        }catch(e){
          setPill('err','ì˜¤ë¥˜');
          alert('ì¬ë°œê¸‰ ì‹¤íŒ¨: ' + (e && e.message ? e.message : String(e)));
        }
      });
    }

      
      
      if (btnSave){
        btnSave.addEventListener('click', async ()=>{
          try{
            const cur = snap();
            if (!cur.title){
              alert('titleì€ ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            if (!cur.date_start && cur.date_end){
              alert('date_endë¥¼ ì“°ë ¤ë©´ date_startê°€ í•„ìš”í•©ë‹ˆë‹¤.');
              return;
            }

            setPill('saving','ì €ì¥ì¤‘');

            const ok = await postPatchEvent(it.id, {
              date_start: cur.date_start,
              date_end: cur.date_end,
              title: cur.title,
              content_raw: cur.content_raw,
              image_url: cur.image_url,
              hidden: cur.hidden ? 'TRUE' : 'FALSE'
            });
            if (!ok) throw new Error('SAVE_FAILED');

            if (uiTitle) uiTitle.textContent = cur.title;

            const party = String(it.party || '').trim();
            const meta = `${cur.date_start || ''}${party ? ' Â· ' + party : ''} Â· ${it.id}`;
            if (uiMeta) uiMeta.textContent = meta;

            if (uiBody) uiBody.innerHTML = buildPreview(cur.content_raw || '');

            applyHiddenUi(!!cur.hidden);
            originalHidden = !!cur.hidden;

            original = cur;
            openEditor(false);
            setPill('saved','ì €ì¥ë¨');
          }catch(e){
            setPill('err','ì˜¤ë¥˜');
            alert('ì €ì¥ ì‹¤íŒ¨: ' + (e && e.message ? e.message : String(e)));
          }
        });
      }

      const getTags = () => parseTagsToArray(root.querySelector('[data-role="tags-raw"]').value);
      const setTags = (arr) => {
        const norm = normalizeTagsArray(arr);
        root.querySelector('[data-role="tags-raw"]').value = norm.join(',');
        scheduleSave(it.id, norm, pill);
      };

      // âœ… [ì¶”ê°€] ì›”ìš”ì•½ ê°•ì œ í¬í•¨ ì²´í¬ë°•ìŠ¤
      const forceChk = root.querySelector('input[type="checkbox"][data-role="mnforce"]');
      
      function parseImportantInputToLabels_(){
        const input = root.querySelector(`.tag-note[data-note="important"] input`);
        const raw = String(input?.value || "");
        return raw.split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
      }
      
      function removeMnForce_(tags){
        return removeTyped(tags, "mnforce"); // ì´ë¯¸ ìˆëŠ” ìœ í‹¸ ì¬ì‚¬ìš©( mnforce / mnforce-* ì œê±° )
      }
      
      function applyMnForceFromImportant_(on){
        let tags = getTags();
        tags = removeMnForce_(tags);
      
        if (on){
          const labels = parseImportantInputToLabels_();
          if (!labels.length){
            alert("ì›”ìš”ì•½ ê°•ì œë¥¼ ì¼œë ¤ë©´ important ì…ë ¥ì¹¸ì— ë¼ë²¨(í‚¤ì›Œë“œ)ì„ 1ê°œ ì´ìƒ ì ì–´ì£¼ì„¸ìš”.");
            if (forceChk) forceChk.checked = false;
            setTags(tags);
            return;
          }
          tags = tags.concat(labels.map(v => `mnforce-${v}`));
        }
      
        setTags(tags);
      }
      
      if (forceChk){
        forceChk.addEventListener("change", ()=>{
          applyMnForceFromImportant_(!!forceChk.checked);
        });
      }

      
      root.querySelectorAll('input[type="checkbox"][data-tg]').forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const kind = chk.dataset.tg;
          const key = chk.dataset.key;
          const checked = chk.checked;

          let tags = getTags();

          if (kind === 'base'){
            if (key === 'ë³´ìˆ˜' && checked) tags = removeDbBase(tags, 'ì§„ë³´');
            if (key === 'ì§„ë³´' && checked) tags = removeDbBase(tags, 'ë³´ìˆ˜');

            tags = checked ? addDbBase(tags, key) : removeDbBase(tags, key);
            setTags(tags);
            return;
          }

          if (kind === 'typed'){
            if (checked){
              if (key === "important"){
                // ê¸°ì¡´ important-*ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ìœ ì§€, ì—†ìœ¼ë©´ importantë§Œ ì¶”ê°€
                if (!hasTypedTag(tags, "important")) tags = tags.concat(["important"]);
              } else {
                tags = upsertTyped(tags, key, getTypedTagValue(tags, key) || '');
              }
              showNote(root, key, true);
              focusNote(root, key);
            }else{
              tags = removeTyped(tags, key);
              showNote(root, key, false);
              clearNote(root, key);
            }
            if (key === "important") applyImportantUi(checked);
            setTags(tags);
            return;
          }
        });
      });

      ['economy','important','mourning'].forEach(tp=>{
        const input = root.querySelector(`.tag-note[data-note="${tp}"] input`);
        if (!input) return;

        let t = null;
        input.addEventListener('input', ()=>{
          clearTimeout(t);
          t = setTimeout(()=>{
            let tags = getTags();
            const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
            if (!on) return;
            if (tp === "important"){
              const raw = String(input.value || "");
              const vals = raw.split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
            
              tags = removeTyped(tags, "important");
              if (!vals.length){
                // important ì²´í¬ë§Œ ì¼œì§„ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ì‹¶ìœ¼ë©´ importantë§Œ ë„£ìŒ
                tags = tags.concat(["important"]);
              } else {
                tags = tags.concat(vals.map(v => `important-${v}`));
              }
            } else {
              tags = upsertTyped(tags, tp, input.value || '');
            }
            
            // âœ… [ì¶”ê°€] ì›”ìš”ì•½ ê°•ì œ ONì´ë©´ mnforce-*ë„ important ë¼ë²¨ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶°ì¤Œ
            if (tp === "important"){
              const forceChk2 = root.querySelector('input[type="checkbox"][data-role="mnforce"]');
              if (forceChk2 && forceChk2.checked){
                // í˜„ì¬ tagsì—ì„œ mnforce ì œê±° í›„, ì…ë ¥ ë¼ë²¨ë¡œ ë‹¤ì‹œ êµ¬ì„±
                tags = removeTyped(tags, "mnforce");
                const labels2 = String(input.value || "").split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
                if (labels2.length){
                  tags = tags.concat(labels2.map(v => `mnforce-${v}`));
                }else{
                  // ë¼ë²¨ì´ ì‚¬ë¼ì¡Œë‹¤ë©´ ê°•ì œë„ í•´ì œí•˜ëŠ” í¸ì´ ì•ˆì „
                  forceChk2.checked = false;
                }
              }
            }

            
            setTags(tags);
          }, 450);
        });

        input.addEventListener('blur', ()=>{
          let tags = getTags();
          const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
          if (!on) return;
        
          if (tp === "important"){
            const raw = String(input.value || "");
            const vals = raw.split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
        
            tags = removeTyped(tags, "important");
            if (!vals.length){
              tags = tags.concat(["important"]);
            } else {
              tags = tags.concat(vals.map(v => `important-${v}`));
            }
          } else {
            tags = upsertTyped(tags, tp, input.value || '');
          }
          setTags(tags);
        });
      });

      const groupBox = root.querySelector('.group-editor[data-tg="group"]');
      if (groupBox){
        const input = groupBox.querySelector('input[data-role="group-input"]');
        const btnApply = groupBox.querySelector('[data-action="group-apply"]');
        const btnClear = groupBox.querySelector('[data-action="group-clear"]');

        const applyGroup = (raw) => {
          const v = String(raw || '').trim();
          if (v && !GROUP_RE.test(v)){
            alert('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nE-xxxxxx-xx (ì˜ˆ: E-202601-01)');
            return;
          }
          let tags = getTags();
          tags = removeGroupTags(tags);
          if (v) tags = tags.concat([v]);
          setTags(tags);
          if (input) input.value = v;
        };

        if (btnApply) btnApply.addEventListener('click', ()=> applyGroup(input ? input.value : ''));
        if (btnClear) btnClear.addEventListener('click', ()=> applyGroup(''));

        if (input){
          input.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter'){
              e.preventDefault();
              applyGroup(input.value);
            }
          });
        }
      }
    }

    async function safeReadJson_(res){
      const text = await res.text();
      if (text && /<!doctype html|<html/i.test(text)) {
        throw new Error("APIê°€ JSON ëŒ€ì‹  HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (ì›¹ì•± ë°°í¬/ê¶Œí•œ/URL í™•ì¸ í•„ìš”)");
      }
      try{
        return JSON.parse(text);
      }catch(_){
        throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨: " + (text ? text.slice(0, 140) : "(empty)"));
      }
    }

  /* =========================
     ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ íƒ­ (ë‹¨ê±´/ì¼ê´„)
  ========================= */

  /* =========================
     content_raw ìë™ <br> ì‚½ì…
     ê·œì¹™:
     - "â€¢" ì•ì— ë‚´ìš©ì´ ìˆìœ¼ë©´: "â€¦ â€¢" -> "â€¦<br>â€¢"
       (ë‹¨, ê¸€ ë§¨ ì•ì´ë©´ ì¶”ê°€ ì•ˆ í•¨ / ì´ë¯¸ <br>ë‚˜ ì¤„ë°”ê¿ˆì´ë©´ ì¶”ê°€ ì•ˆ í•¨)
     - "." ë’¤ì— ë‹¤ìŒ ë‚´ìš©ì´ ë” ìˆìœ¼ë©´: ". ë‹¤ìŒ" -> ".<br>ë‹¤ìŒ"
       (ë‹¨, ë§ˆì§€ë§‰ì´ë©´ ì¶”ê°€ ì•ˆ í•¨ / ì´ë¯¸ <br>ë‚˜ ì¤„ë°”ê¿ˆì´ë©´ ì¶”ê°€ ì•ˆ í•¨)
  ========================= */
  function autoInsertBrInContentRaw_(input){
    let s = String(input ?? "");
  
    const endsWithBrOrNl_ = (txt) => {
      const t = String(txt).replace(/[ \t]+$/g, ""); // trailing spacesë§Œ ì œê±°
      if (!t) return true; // ë¹„ì–´ìˆìœ¼ë©´ "ì•ì— ë‚´ìš© ì—†ìŒ" ì·¨ê¸‰
      if (/\n$/.test(t)) return true;
      if (/<br\s*\/?>$/i.test(t)) return true;
      return false;
    };
  
    // 1) "â€¢" ì•ì— ë‚´ìš©ì´ ìˆìœ¼ë©´ <br> ì‚½ì…
    //    - ì´ë¯¸ <br> ë˜ëŠ” \n ë’¤ë©´ ì‚½ì…í•˜ì§€ ì•ŠìŒ
    s = s.replace(/(\S)([ \t]*)â€¢/g, (m, prevChar, _spaces, offset, whole) => {
      const before = whole.slice(0, offset + 1); // prevCharê¹Œì§€ í¬í•¨
      if (endsWithBrOrNl_(before)) return prevChar + _spaces + "â€¢";
      // ê³µë°±ì€ ì œê±°í•˜ê³  ì¤„ë°”ê¿ˆ íƒœê·¸ ì‚½ì…
      return prevChar + "<br>" + "â€¢";
    });
  
    // 2) "." ë’¤ì— ë‹¤ìŒ ë‚´ìš©ì´ ë” ìˆìœ¼ë©´ <br> ì‚½ì…
    //    - ì´ë¯¸ <br> ë˜ëŠ” \nì´ ì˜¤ë©´ ì‚½ì…í•˜ì§€ ì•ŠìŒ
     //s = s.replace(/\./g, (dot, offset, whole) => {
     //  const after = whole.slice(offset + 1);
     //  if (after.trim().length === 0) return dot;                 // ë¬¸ì¥ ë(ë§ˆì§€ë§‰) => ë¶ˆí•„ìš”
     //  if (/^\s*(<br\s*\/?>|\n)/i.test(after)) return dot;        // ì´ë¯¸ ì¤„ë°”ê¿ˆì´ë©´ ê·¸ëŒ€ë¡œ
     //  return dot + "<br>";
    // });
  
    return s;
  }

  const add = {
    line: document.getElementById('addLine'),
    save: document.getElementById('addSave'),
    clear: document.getElementById('addClear'),
    status: document.getElementById('addStatus'),
    preview: document.getElementById('addPreview')
  };
  
  const ADD_COLS = ["id","date_type","date_start","date_end","title","content_raw","party","is_foreign","country","tags","created_at"];
  
  function splitNonEmptyLines_(text){
    return String(text || "").replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
  }
  
  function parsePipeLineStrict_(line){
    const raw = String(line || '').replace(/\r/g,'').trim();
    if (!raw) return null;
  
    const parts = raw.split('|');
  
    // 11ì¹¸ ë¯¸ë§Œì´ë©´ íŒ¨ë”©, ì´ˆê³¼ë©´ ì˜¤ë¥˜(íŒŒì´í”„ê°€ ë³¸ë¬¸ì— ì„ì¸ ê²½ìš°)
    if (parts.length < 11) {
      while(parts.length < 11) parts.push('');
    } else if (parts.length > 11) {
      throw new Error('ì—´ ê°œìˆ˜ ì´ˆê³¼(11ì¹¸ í•„ìš”). content_rawì— | ê°€ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
    }
  
    const obj = {};
    for (let i=0;i<11;i++){
      obj[ADD_COLS[i]] = (parts[i] ?? '').toString();
    }
    return obj;
  }
  
  function validateAddObj_(obj){
    const ds = String(obj?.date_start || '').trim();
    const de = String(obj?.date_end || '').trim();
    const title = String(obj?.title || '').trim();
  
    if (!ds && de) return 'date_endë¥¼ ì“°ë ¤ë©´ date_startê°€ í•„ìš”í•©ë‹ˆë‹¤.';
    if (!ds) return 'date_startëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.';
    if (!title) return 'titleì€ í•„ìˆ˜ì…ë‹ˆë‹¤.';
    return '';
  }
  
  function renderAddPreviewFromText_(){
    const lines = splitNonEmptyLines_(add.line.value);
  
    if (!lines.length){
      add.preview.textContent = '(ì•„ì§ ì—†ìŒ)';
      add.status.textContent = '';
      return;
    }
  
    // ë‹¨ê±´ì´ë©´ ìì„¸íˆ
    if (lines.length === 1){
      try{
        const obj = parsePipeLineStrict_(lines[0]);
  
        // âœ… ì—¬ê¸°ì„œ content_raw ìë™ ê°€ê³µ
        obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
  
        const err = validateAddObj_(obj);
        if (err) throw new Error(err);
  
        add.preview.textContent = ADD_COLS.map(k => `${k}: ${obj[k] ?? ''}`).join('\n');
        add.status.textContent = '';
      }catch(e){
        add.preview.textContent = 'ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + (e?.message ? e.message : String(e));
      }
      return;
    }
  
    // ì—¬ëŸ¬ ê±´ì´ë©´ ìš”ì•½
    const out = [];
    out.push(`ì´ ${lines.length}í–‰ (1í–‰=1ì´ë²¤íŠ¸)`);
    out.push('---');
  
    let okCount = 0;
    lines.forEach((line, idx) => {
      try{
        const obj = parsePipeLineStrict_(line);
  
        // âœ… ë‹¤ê±´ë„ ë™ì¼í•˜ê²Œ content_raw ìë™ ê°€ê³µ
        obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
  
        const err = validateAddObj_(obj);
        if (err) throw new Error(err);
  
        okCount++;
        const range = (obj.date_end && String(obj.date_end).trim()) ? ` ~ ${obj.date_end}` : '';
        out.push(`[${idx+1}] âœ… ${obj.date_start}${range} | ${obj.title} | tags=${obj.tags || ''}`);
      }catch(e){
        out.push(`[${idx+1}] âŒ ${e?.message ? e.message : String(e)}`);
      }
    });
  
    out.push('---');
    out.push(`ê²€ì¦ í†µê³¼: ${okCount}/${lines.length}`);
    add.preview.textContent = out.join('\n');
  }

  
  add.line.addEventListener('input', renderAddPreviewFromText_);
  
  add.clear.addEventListener('click', ()=>{
    add.line.value = '';
    add.preview.textContent = '(ì•„ì§ ì—†ìŒ)';
    add.status.textContent = '';
  });
  
  /** âœ… ë‹¨ê±´: appendEvent(form)
   *  âœ… ì¼ê´„: appendEvents(JSON)
   *
   *  âš ï¸ ì£¼ì˜: Google Apps Script WebAppì€ CORS preflight(OPTIONS)ë¥¼ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ë§ì•„ì„œ
   *  `Content-Type: application/json` ê°™ì€ í—¤ë”ë¥¼ ë¶™ì´ë©´ ë¸Œë¼ìš°ì €ì—ì„œ "Failed to fetch"ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   *  ê·¸ë˜ì„œ headersë¥¼ ì§€ì •í•˜ì§€ ì•Šê³  JSON ë¬¸ìì—´ì„ bodyë¡œë§Œ ë³´ë‚´ preflightë¥¼ í”¼í•©ë‹ˆë‹¤.
   */
  async function postAppendEvents_(lines){
    const params = new URLSearchParams();
    params.set('mode','appendEvents');
    if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
    const url = `${API_BASE}?${params.toString()}`;

    try{
      const res = await fetch(url, {
        method: 'POST',
        // âœ… headers ê¸ˆì§€(=preflight ë°©ì§€)
        body: JSON.stringify({ lines }),
        cache: 'no-store',
        credentials: 'omit'
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch(_){ }

      if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
      if (!data)   return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
      return { ok:true, data };
    }catch(e){
      return { ok:false, error: e && e.message ? e.message : String(e) };
    }
  }

  function replaceIdInLine_(line, newId){
    const parts = String(line || '').split('|');
    while(parts.length < 11) parts.push('');
    parts[0] = String(newId || '').trim();
    return parts.slice(0,11).join('|');
  }

  add.save.addEventListener('click', async ()=>{
    try{
      const lines = splitNonEmptyLines_(add.line.value);

      // âœ… ì €ì¥ ì§ì „: content_raw ìë™ <br> ì‚½ì… ë°˜ì˜í•œ lines2 ìƒì„±
      const lines2 = lines.map(line=>{
      const obj = parsePipeLineStrict_(line);
        // content_raw ìë™ ê°€ê³µ
        obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
      
        // í˜¹ì‹œ ëª¨ë¥´ë‹ˆ íŒŒì´í”„ ì•ˆì „ ì¹˜í™˜(ì—´ ê¹¨ì§ ë°©ì§€)
        // (ì›í•˜ë©´ content_rawì—ë§Œ ì ìš©í•´ë„ ë¨)
        ADD_COLS.forEach(k => { obj[k] = safePipe_(obj[k]); });
      
        // 11ì¹¸ ì¬ì¡°ë¦½
        return ADD_COLS.map(k => String(obj[k] ?? "")).join("|");
      });

      if (!lines.length) { alert('ì…ë ¥ ë¼ì¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }

      // âœ… ì¼ê´„ ì €ì¥(ë°°ì¹˜) + ê²°ê³¼ idë¥¼ ì…ë ¥ê°’ì— ë˜ëŒë ¤ì“°ê¸°
      const BATCH = 200; // ë„ˆë¬´ í¬ë©´ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ ì ë‹¹íˆ ìª¼ê°­ë‹ˆë‹¤.
      const allResults = [];

      add.status.textContent = `ì¼ê´„ ì €ì¥ ì¤‘... (0/${lines.length})`;

      for (let s=0; s<lines.length; s+=BATCH){
        const chunk = lines2.slice(s, s+BATCH);
        add.status.textContent = `ì¼ê´„ ì €ì¥ ì¤‘... (${Math.min(s+BATCH, lines.length)}/${lines.length})`;

        const r = await postAppendEvents_(chunk);
        if (!r.ok) throw new Error(r.error || 'BULK_SAVE_FAILED');

        const results = Array.isArray(r.data && r.data.results) ? r.data.results : [];
        if (!results.length) throw new Error('ì„œë²„ ì‘ë‹µì— resultsê°€ ì—†ìŠµë‹ˆë‹¤. (appendEvents)');

        allResults.push(...results);

        // ì¼ë¶€ ì‹¤íŒ¨ê°€ ìˆìœ¼ë©´ ì—¬ê¸°ì„œ ë©ˆì¶¤(ì¤‘ë³µ ì €ì¥ ë°©ì§€). ì›í•˜ë©´ ê³„ì† ì§„í–‰ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ
        const okThisBatch = results.every(x => x && x.ok === true);
        if (!okThisBatch) break;
      }

      // ê²°ê³¼ ë°˜ì˜
      const newLines = lines2.map((line, i)=>{
        const rr = allResults[i];
        if (rr && rr.ok === true && rr.id) return replaceIdInLine_(line, rr.id);
        return line;
      });
      add.line.value = newLines.join('\n');

      const okCount = allResults.filter(x => x && x.ok === true).length;
      const failIdx = [];
      allResults.forEach((x, i)=>{ if (!x || x.ok !== true) failIdx.push(i+1); });
      // ì²˜ë¦¬ë˜ì§€ ì•Šì€ í–‰(ì„œë²„ ì¤‘ë‹¨/ë¶€ë¶„ ì‹¤í–‰)ë„ ì‹¤íŒ¨ë¡œ í‘œì‹œ
      for (let i=allResults.length; i<lines.length; i++){ failIdx.push(i+1); }

      renderAddPreviewFromText_();

      if (failIdx.length){
        add.status.textContent = `ë¶€ë¶„ ì‹¤íŒ¨: ì„±ê³µ ${okCount}/${lines.length} (ì‹¤íŒ¨ í–‰: ${failIdx.join(', ')})`;
        alert(`ì¼ê´„ ì €ì¥ ì¤‘ ì¼ë¶€ ì‹¤íŒ¨ê°€ ìˆìŠµë‹ˆë‹¤.\nì‹¤íŒ¨ í–‰: ${failIdx.join(', ')}\në¯¸ë¦¬ë³´ê¸°ì—ì„œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
        return;
      }

      add.status.textContent = `ì¼ê´„ ì €ì¥ ì™„ë£Œ: ${okCount}/${lines.length}`;
    }catch(e){
      add.status.textContent = '';
      renderAddPreviewFromText_();
      alert('ì €ì¥ ì‹¤íŒ¨: ' + (e && e.message ? e.message : String(e)));
    }
  });

// ì´ˆê¸° 1íšŒ
  renderAddPreviewFromText_();

  // âœ… Clipboard ì´ë¯¸ì§€ Blob -> base64(ë°ì´í„° ë¶€ë¶„ë§Œ)
  function readBlobAsBase64_(blob){
    return new Promise((resolve, reject) => {
      try{
        const fr = new FileReader();
        fr.onload = () => {
          const s = String(fr.result || "");
          const i = s.indexOf(",");
          resolve(i >= 0 ? s.slice(i + 1) : s); // "data:...;base64," í—¤ë” ì œê±°
        };
        fr.onerror = () => reject(fr.error || new Error("FileReader failed"));
        fr.readAsDataURL(blob);
      }catch(e){
        reject(e);
      }
    });
  }
function extractImportantLabelsFromTags_(tagsStr){
  const tags = String(tagsStr || "")
    .split(",")
    .map(s => String(s).trim())
    .filter(Boolean);

  const out = [];
  tags.forEach(t => {
    // important ë˜ëŠ” important-ë¼ë²¨
    const m = /^important(?:-(.+))?$/i.exec(t);
    if (!m) return;

    const label = String(m[1] || "").trim();
    // ë¼ë²¨ ì—†ëŠ” "important"ëŠ” ì¶”ì²œ í‚¤ì›Œë“œë¡œ ì˜ë¯¸ê°€ ì•½í•´ì„œ ì œì™¸(ì›í•˜ë©´ í¬í•¨ìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
    if (!label) return;

    out.push(label);
  });
  return out;
}

function extractMnForceLabelsFromTags_(tagsStr){
  const tags = String(tagsStr || "")
    .split(",")
    .map(s => String(s).trim())
    .filter(Boolean);

  const out = [];
  tags.forEach(t => {
    const m = /^mnforce-(.+)$/i.exec(t);
    if (!m) return;
    const label = String(m[1] || "").trim();
    if (!label) return;
    out.push(label);
  });
  return out;
}

    
function buildListUrlForSuggest_(){
  // Export íƒ­ê³¼ ë™ì¼í•œ í•„í„° ì…ë ¥ê°’ ì‚¬ìš©
  const year  = String(el.year.value || "").trim();
  const month = String(el.month.value || "").trim();
  const day   = String(el.day.value || "").trim();
  const start = String(el.start.value || "").trim();
  const end   = String(el.end.value || "").trim();
  const ids   = String(el.ids.value || "").trim();

  if (!day && !start && !end && (!year || !month)) {
    throw new Error("ì›” ì¶”ì²œì€ ì—°ë„/ì›”ì´ í•„ìš”í•©ë‹ˆë‹¤. (ë˜ëŠ” ê¸°ê°„ start/end, ì¼ day)");
  }

  const params = new URLSearchParams();
  params.set("mode", "listEvents");
  params.set("limit", "800");

  if (day) {
    params.set("day", day);
  } else if (start || end) {
    if (start) params.set("start", start);
    if (end) params.set("end", end);
  } else {
    params.set("year", year);
    params.set("month", month);
  }

  // âœ… ì¶”ì²œì€ ìˆ¨ê¹€(ë¹„í‘œì‹œ) ì œì™¸ê°€ ìì—°ìŠ¤ëŸ¬ì›€
  params.set("includeHidden", "false");

  if (ids) params.set("id", ids);
  if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);

  return `${API_BASE}?${params.toString()}`;
}

async function autoSuggestMonthNote_(){
  const topN = Math.min(Math.max(Number(mn.topN?.value || 8), 3), 20);

  const url = buildListUrlForSuggest_();
  const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
  if (!res.ok) throw new Error("ì¶”ì²œìš© ëª©ë¡ API ì‹¤íŒ¨ (HTTP " + res.status + ")");

  const data = await safeReadJson_(res);
  if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "UNKNOWN_ERROR");

  const items = Array.isArray(data.items) ? data.items : [];
  
  // 1) âœ… ê°•ì œ ë¼ë²¨ ë¨¼ì € ìˆ˜ì§‘(ì¤‘ë³µ ì œê±°, ë“±ì¥ ìˆœì„œ ìœ ì§€)
  const forced = [];
  const forcedSet = new Set();
  items.forEach(it=>{
    const labs = extractMnForceLabelsFromTags_(it.tags || "");
    labs.forEach(lb=>{
      if (forcedSet.has(lb)) return;
      forcedSet.add(lb);
      forced.push(lb);
    });
  });
  
  // 2) ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ì²˜ëŸ¼ important ë¹ˆë„ ì§‘ê³„
  const freq = new Map();
  items.forEach(it => {
    const labels = extractImportantLabelsFromTags_(it.tags || "");
    labels.forEach(lb => freq.set(lb, (freq.get(lb) || 0) + 1));
  });
  
  const ranked = Array.from(freq.entries())
    .sort((a,b) => (b[1] - a[1]) || String(a[0]).localeCompare(String(b[0]), "ko"))
    .map(x=>x[0])
    .filter(lb => !forcedSet.has(lb)); // âœ… ê°•ì œëŠ” ì¤‘ë³µ ë°©ì§€
  
  // 3) âœ… forcedë¥¼ ì•ì— ë‘ê³ , ë‚¨ì€ ìë¦¬ë§Œ rankedë¡œ ì±„ì›€
  const picked = forced.slice(0, topN).concat(
    ranked.slice(0, Math.max(0, topN - forced.length))
  );

  // íƒ€ì´í‹€ ìë™
  const y = String(el.year.value || "").trim();
  const m = String(el.month.value || "").trim();
  if (y && m && !el.day.value && !el.start.value && !el.end.value) {
    mn.title.value = `${y}ë…„ ${m}ì›” í•µì‹¬ í‚¤ì›Œë“œ`;
  } else {
    mn.title.value = `ë²”ìœ„ í•µì‹¬ í‚¤ì›Œë“œ`;
  }

  mn.tags.value = picked.join("\n");
  mn.desc.value = `â€» í•µì‹¬ (${Math.min(forced.length, topN)}ê°œ) + ì¤‘ë³µ íƒœê·¸ Top ${Math.max(0, picked.length - Math.min(forced.length, topN))} ê¸°ì¤€ ì¶”ì²œ`;


  buildMonthNote();
  saveMonthNote();
}

if (mn.auto){
  mn.auto.addEventListener("click", async (e)=>{
    e.preventDefault();
    try{
      await autoSuggestMonthNote_();
      alert("important íƒœê·¸ ì¶”ì²œì„ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤. (í•„ìš”í•˜ë©´ í‚¤ì›Œë“œë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”)");
    }catch(err){
      alert("ìë™ ì¶”ì²œ ì‹¤íŒ¨: " + (err && err.message ? err.message : String(err)));
    }
  });
}
    
/* =========================================
   [NEW] AI ë¶„ì„ ê´€ë ¨ ë¡œì§ (ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° + API í˜¸ì¶œ)
   ========================================= */
let currentAiBase64 = null; // ì´ë¯¸ì§€ ë°ì´í„° ë‹´ì„ ë³€ìˆ˜

// 1. ë¶™ì—¬ë„£ê¸°(Paste) ì´ë²¤íŠ¸ ê°ì§€
const aiTextEl = document.getElementById('ai_input_text');
if(aiTextEl){
  aiTextEl.addEventListener('paste', function(e){
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (let i = 0; i < items.length; i++) {
      if (items[i].type.indexOf("image") !== -1) {
        e.preventDefault(); // ì´ë¯¸ì§€ëŠ” í…ìŠ¤íŠ¸ìƒìì— í…ìŠ¤íŠ¸ë¡œ ë“¤ì–´ê°€ì§€ ì•Šê²Œ ë°©ì§€
        const blob = items[i].getAsFile();
        const reader = new FileReader();
        reader.onload = function(event){
          currentAiBase64 = event.target.result; // data:image/png;base64,...
          // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
          document.getElementById('ai_image_preview').src = currentAiBase64;
          document.getElementById('ai_image_preview_area').style.display = 'block';
        };
        reader.readAsDataURL(blob);
      }
    }
  });
}

function clearAiImage(){
  currentAiBase64 = null;
  document.getElementById('ai_image_preview').src = "";
  document.getElementById('ai_image_preview_area').style.display = 'none';
}

async function runAiAnalysis() {
  const textVal = document.getElementById('ai_input_text').value.trim();

  if (!textVal && !currentAiBase64) {
    alert("ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.");
    return;
  }

  const btn = document.getElementById('btn_ai_analyze');
  const originalBtnText = btn.innerText;
  btn.disabled = true;
  btn.innerText = "â³ AI ë¶„ì„ ì¤‘... (ìµœëŒ€ 20ì´ˆ ì†Œìš”)";

  try {
    const payload = {
      mode: "analyzeArticle",
      text: textVal,
      image: currentAiBase64 // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ null ì „ì†¡
    };

    // API_BASEì™€ TG_ADMIN_KEYëŠ” ê¸°ì¡´ ì½”ë“œ ìƒë‹¨ì— ì •ì˜ëœ ë³€ìˆ˜ë¥¼ ì‚¬ìš©
    const params = new URLSearchParams();
    params.set("mode", "analyzeArticle");
    if (typeof TG_ADMIN_KEY !== 'undefined' && TG_ADMIN_KEY) {
       params.set("key", TG_ADMIN_KEY);
    }
    
    const url = `${API_BASE}?${params.toString()}`;

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();

    if (json.ok) {
      // ì„±ê³µ ì‹œ: ê²°ê³¼ ë¬¸ìì—´ì„ ê¸°ì¡´ 'addLine' ì…ë ¥ì°½ì— ë„£ìŒ
      const targetInput = document.getElementById('addLine');
      if(targetInput) {
        targetInput.value = json.result;
        
        alert("âœ… ë¶„ì„ ì™„ë£Œ! \nì•„ë˜ [ì…ë ¥ ë¼ì¸]ì— ë³€í™˜ëœ ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në‚´ìš©ì„ í™•ì¸í•˜ê³  'ì‹œíŠ¸ì— ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
        targetInput.focus();
        
        // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  íŠ¸ë¦¬ê±°
        targetInput.dispatchEvent(new Event('input'));
      }
    } else {
      throw new Error(json.error || json.detail || "Unknown Error");
    }

  } catch (err) {
    alert("AI ë¶„ì„ ì‹¤íŒ¨: " + err.message);
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.innerText = originalBtnText;
  }
}
</script>
</body>
</html>
