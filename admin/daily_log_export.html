<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Daily Log Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />
</head>

<body>
  <div class="admin-shell">
    <!-- ✅ 헤더 슬롯 유지 -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- ✅ 메뉴 슬롯 유지 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- 메인 콘텐츠 -->
      <main class="wrap">
        <h1>Daily Log Export</h1>
        <p class="desc">
          daily_events 시트 데이터를 블로그에 바로 붙여넣을 수 있는 HTML로 변환합니다.
          (월/일/ID 필터 지원)
        </p>

        <div class="form-row" style="flex-wrap:wrap; gap:10px; align-items:center;">
          <!-- 월 추출 -->
          <label>연도</label>
          <input id="year" type="number" value="2026" style="width:110px" />

          <label style="margin-left:6px;">월</label>
          <input id="month" type="number" min="1" max="12" value="1" style="width:90px" />

          <!-- 일별 추출 -->
          <label style="margin-left:6px;">일</label>
          <input
            id="day"
            type="text"
            placeholder="YYYY-MM-DD (예: 2026-01-07)"
            style="width:220px"
          />

          <!-- ID 추출 -->
          <label style="margin-left:6px;">id</label>
          <input
            id="ids"
            type="text"
            placeholder="EVT001 또는 EVT001,EVT002"
            style="width:220px"
          />

          <button id="btnGenerate" class="btn primary" style="margin-left:6px;">
            HTML 생성
          </button>

          <button id="btnCopy" class="btn">
            복사
          </button>

          <button id="btnOpen" class="btn">
            요청 URL 열기
          </button>

          <button id="btnClear" class="btn">
            비우기
          </button>
        </div>

        <p class="desc" style="margin-top:10px;">
          - <b>day</b>를 입력하면 일별 추출이 우선 적용됩니다. (day 비우면 year/month로 월 추출)<br />
          - <b>id</b>는 단일 또는 콤마로 여러 개 지정 가능합니다.
        </p>

        <textarea
          id="output"
          placeholder="여기에 daily-log HTML이 생성됩니다"
          style="width:100%; height:380px; margin-top:14px;"
        ></textarea>

        <p class="desc" style="margin-top:10px;">
          마지막 요청 URL: <span id="lastUrl" style="word-break:break-all;"></span>
        </p>
      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

  <script>
    // ✅ 화면 입력 없이 자동 고정
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbyuC0qHyRdDKL2fC5fmRy66l0y1baCLbXuf9pNlPh0rBde_HQMzaqQv5NK06H_n7WFk/exec";

    const el = {
      year: document.getElementById("year"),
      month: document.getElementById("month"),
      day: document.getElementById("day"),
      ids: document.getElementById("ids"),
      output: document.getElementById("output"),
      lastUrl: document.getElementById("lastUrl"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnCopy: document.getElementById("btnCopy"),
      btnOpen: document.getElementById("btnOpen"),
      btnClear: document.getElementById("btnClear"),
    };

    let lastRequestUrl = "";

    el.btnGenerate.addEventListener("click", generate);
    el.btnCopy.addEventListener("click", copyOutput);
    el.btnOpen.addEventListener("click", openLastUrl);
    el.btnClear.addEventListener("click", () => {
      el.output.value = "";
      el.lastUrl.textContent = "";
      lastRequestUrl = "";
    });

    function buildUrl() {
      const year = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day = String(el.day.value || "").trim();
      const ids = String(el.ids.value || "").trim();

      // day가 있으면 day 우선, 없으면 year/month 필요
      if (!day && (!year || !month)) {
        throw new Error("월 추출은 연도/월이 필요하고, 일별 추출은 day(YYYY-MM-DD)가 필요합니다.");
      }

      const params = new URLSearchParams();
      params.set("mode", "exportDailyLog");

      if (day) {
        params.set("day", day);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

      if (ids) params.set("id", ids);

      return `${API_BASE}?${params.toString()}`;
    }

    async function generate() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;

        el.output.value = "생성 중...";

        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error("API 호출 실패 (HTTP " + res.status + ")");

        const text = await res.text();

        // 혹시 HTML 화면이 그대로 내려오는 경우(= doGet 분기 실패) 감지
        if (text && /<!doctype html|<html/i.test(text)) {
          throw new Error("API가 HTML 화면을 반환했습니다. (서버 doGet(e) 분기/배포 확인 필요)");
        }

        el.output.value = text || "<!-- empty -->";
      } catch (e) {
        el.output.value = "";
        alert("HTML 생성 실패: " + (e && e.message ? e.message : String(e)));
      }
    }

    async function copyOutput() {
      const val = (el.output.value || "").trim();
      if (!val) {
        alert("복사할 내용이 없습니다.");
        return;
      }
      try {
        await navigator.clipboard.writeText(el.output.value);
        alert("복사 완료");
      } catch (e) {
        // fallback
        el.output.focus();
        el.output.select();
        document.execCommand("copy");
        alert("복사 완료");
      }
    }

    function openLastUrl() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (e) {
        alert("URL 생성 실패: " + (e && e.message ? e.message : String(e)));
      }
    }
  </script>
</body>
</html>
