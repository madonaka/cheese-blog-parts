<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Daily Log Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== Export 필터 카드 ===== */
    .export-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.10);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .export-sections{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .search-block{
      border: 1px solid rgba(15,23,42,0.08);
      border-radius:12px;
      padding:12px;
      background: rgba(15,23,42,0.02);
    }

    .search-title{
      font-weight: 900;
      font-size: 0.95rem;
      color:#0f172a;
      margin: 0 0 10px;
    }

    .search-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      align-items:end;
    }

    .fg{ display:flex; flex-direction:column; gap:6px; }
    .fg label{ font-weight:800; font-size:0.9rem; color:#111827; }
    .fg input{
      border:1px solid rgba(15,23,42,0.18);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
      height:40px;
    }
    .fg input[type="date"]{ padding:8px 10px; }

    /* span 유틸 */
    .span-2{ grid-column: span 2; min-width:120px; }
    .span-4{ grid-column: span 4; min-width:200px; }
    .span-8{ grid-column: span 8; min-width:260px; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .help-line{
      margin-top:10px;
      color:rgba(17,24,39,0.75);
      font-size:0.92rem;
      line-height:1.45;
    }

    @media (max-width: 980px){
      .span-2,.span-4,.span-8{ grid-column: span 12; min-width: 0; }
    }

    /* ===== 탭 UI ===== */
    .tabs{
      display:flex; gap:8px; align-items:center;
      margin: 12px 0 14px;
      flex-wrap: wrap;
    }
    .tab-btn{
      border: 1px solid rgba(15,23,42,0.14);
      background:#fff;
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 700;
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    /* ===== 월 요약 생성기 폼 ===== */
    .note-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .note-grid{ grid-template-columns: 1fr; }
    }
    .card{
      background:#fff;
      border: 1px solid rgba(15,23,42,0.10);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.06);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 1.05rem;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-weight: 800;
      font-size: 0.92rem;
      color:#111827;
    }
    .field input, .field textarea{
      width:100%;
      border: 1px solid rgba(15,23,42,0.18);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background:#fff;
    }
    .field textarea{ min-height: 120px; resize: vertical; }

    .row-actions{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }

    /* ===== month-note 미리보기 스타일(기본 포스트잇) ===== */
    .month-note{
      margin: 10px 0 14px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #fff7cc;
      border: 1px solid rgba(17,24,39,0.10);
      box-shadow: 0 8px 18px rgba(15,23,42,0.08);
      position: relative;
    }
    .month-note::before{
      content:"";
      position:absolute;
      top:-8px;
      left: 18px;
      width: 66px;
      height: 18px;
      border-radius: 6px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(17,24,39,0.08);
      transform: rotate(-2deg);
    }
    .month-note-title{
      font-weight: 800;
      color: #111827;
      margin-bottom: 8px;
    }
    .month-note-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .month-note-tags .mtag{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.85em;
      font-weight: 700;
      background: rgba(17,24,39,0.08);
      color:#111827;
    }
    .month-note-desc{
      margin-top: 8px;
      font-size: 0.88em;
      color: rgba(17,24,39,0.75);
    }
    @media (max-width: 640px){
      .month-note{ padding: 12px; }
      .month-note::before{ left: 12px; }
    }

    /* ===== 태그 검수 카드 ===== */
    .ev-card{
      border:1px solid rgba(15,23,42,0.10);
      border-radius:14px;
      padding:12px 12px 10px;
      background:#fff;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .ev-head{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .ev-title{
      font-weight:900;
      color:#0f172a;
      line-height:1.25;
    }
    .ev-meta{
      color:rgba(17,24,39,0.65);
      font-size:0.88rem;
      margin-top:4px;
    }
    .ev-body{
      margin-top:8px;
      color:rgba(17,24,39,0.86);
      font-size:0.95rem;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .ev-tags{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
    }
    .tag-group{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(15,23,42,0.03);
      border:1px solid rgba(15,23,42,0.06);
    }
    .tag-item{
      display:flex; gap:6px; align-items:center;
      font-weight:800;
      font-size:0.92rem;
    }
    .tag-item input{ transform: translateY(1px); }

    .tag-note{
      display:none;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .tag-note input{
      width:min(520px, 100%);
      border: 1px solid rgba(15,23,42,0.18);
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
      height:36px;
    }

    .save-pill{
      font-size:0.82rem;
      font-weight:800;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(17,24,39,0.06);
      color:rgba(17,24,39,0.75);
      white-space:nowrap;
    }
    .save-pill.saving{ background:rgba(255,184,0,0.16); color:#7a4d00; }
    .save-pill.saved{ background:rgba(34,197,94,0.14); color:#0f5132; }
    .save-pill.err{ background:rgba(239,68,68,0.14); color:#7f1d1d; }

    /* 그룹(E-xxxxxx-xx) 편집 UI */
    .group-editor{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .group-editor input{
      border: 1px solid rgba(15,23,42,0.18);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 14px;
      background: #fff;
      height: 36px;
      outline: none;
      min-width: 220px;
      font-weight: 800;
    }
    .group-editor .btn-mini{
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      height:36px;
    }
    .group-editor .btn-mini.primary{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .group-editor .btn-mini.danger{
      background:rgba(239,68,68,0.10);
      border-color:rgba(239,68,68,0.25);
      color:#7f1d1d;
    }
    .tag-hint{
      font-size: 0.82rem;
      color: rgba(17,24,39,0.6);
      font-weight: 700;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- ✅ 헤더 슬롯 유지 -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- ✅ 메뉴 슬롯 유지 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- 메인 콘텐츠 -->
      <main class="wrap">
        <h1>Daily Log Export</h1>
        <p class="desc">
          daily_events 시트 데이터를 블로그에 바로 붙여넣을 수 있는 HTML로 변환합니다.
          (월/일/ID 필터 지원)
        </p>

        <!-- ✅ 탭 -->
        <div class="tabs">
          <button class="tab-btn" data-tab="tab-tagging">태그 검수</button>
          <button class="tab-btn active" data-tab="tab-export">HTML코드 생성기</button>
          <button class="tab-btn" data-tab="tab-monthnote">월 요약 포스트잇 생성기</button>
        </div>

        <!-- =========================
             TAB 1: 태그 검수
        ========================= -->
        <section id="tab-tagging" class="tab-panel">
          <div class="card">
            <h2>태그 검수</h2>
            <p class="desc" style="margin-top:6px;">
              아래 목록은 <b>현재 입력된 연/월/일/기간/id 필터</b> 값을 그대로 사용합니다.
              (Export 탭 입력값과 동일)
            </p>

            <div class="row-actions" style="margin-top:10px;">
              <button id="tgLoad" class="btn primary">목록 불러오기</button>
              <label style="display:flex; gap:8px; align-items:center; font-weight:700;">
                <input id="tgOnlyEmpty" type="checkbox" />
                태그 비어있는 것만
              </label>
              <span id="tgStatus" class="desc" style="margin-left:auto;"></span>
            </div>

            <div id="tgCards" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
          </div>
        </section>

        <!-- =========================
             TAB 2: Daily Log Export
        ========================= -->
        <section id="tab-export" class="tab-panel active">
          <div class="export-card">
            <div class="export-sections">

              <!-- 1) 연/월/일 -->
              <div class="search-block">
                <div class="search-title">연도, 월, 일 검색</div>
                <div class="search-grid">
                  <div class="fg span-2">
                    <label for="year">연도</label>
                    <input id="year" type="number" value="2026" />
                  </div>

                  <div class="fg span-2">
                    <label for="month">월</label>
                    <input id="month" type="number" min="1" max="12" value="1" />
                  </div>

                  <div class="fg span-4">
                    <label for="day">일 (단일)</label>
                    <input id="day" type="date" />
                  </div>
                </div>
              </div>

              <!-- 2) 기간 -->
              <div class="search-block">
                <div class="search-title">구체적 범위로 검색</div>
                <div class="search-grid">
                  <div class="fg span-4">
                    <label for="start">start</label>
                    <input id="start" type="date" />
                  </div>

                  <div class="fg span-4">
                    <label for="end">end</label>
                    <input id="end" type="date" />
                  </div>
                </div>
              </div>

              <!-- 3) ID -->
              <div class="search-block">
                <div class="search-title">id로 검색(복수 가능)</div>
                <div class="search-grid">
                  <div class="fg span-8">
                    <label for="ids">id</label>
                    <input id="ids" type="text" placeholder="EVT001 또는 EVT001,EVT002" />
                  </div>
                </div>
              </div>

              <!-- 버튼 -->
              <div class="actions">
                <button id="btnGenerate" class="btn primary">HTML 생성</button>
                <button id="btnCopy" class="btn">복사</button>
                <button id="btnOpen" class="btn">요청 URL 열기</button>
                <button id="btnClear" class="btn">비우기</button>
              </div>

              <!-- 안내 -->
              <div class="help-line">
                - <b>day</b>를 입력하면 일별 추출이 우선 적용됩니다.<br/>
                - <b>start/end</b>는 기간 추출입니다. (start만 또는 end만도 가능)<br/>
                - <b>id</b>는 단일 또는 콤마로 여러 개 지정 가능합니다.
              </div>

            </div>
          </div>

          <textarea
            id="output"
            placeholder="여기에 daily-log HTML이 생성됩니다"
            style="width:100%; height:380px; margin-top:14px;"
          ></textarea>

          <p class="desc" style="margin-top:10px;">
            마지막 요청 URL: <span id="lastUrl" style="word-break:break-all;"></span>
          </p>
        </section>

        <!-- =========================
             TAB 3: 월 요약 포스트잇 생성기
        ========================= -->
        <section id="tab-monthnote" class="tab-panel">
          <div class="note-grid">
            <!-- 입력 -->
            <div class="card">
              <h2>입력</h2>

              <div class="field">
                <label>타이틀</label>
                <input id="mnTitle" type="text" placeholder="예) 1월 핵심 키워드" />
              </div>

              <div class="field">
                <label>키워드 (줄바꿈 또는 콤마로 입력)</label>
                <textarea id="mnTags" placeholder="예)
베네수엘라 공습
민주당 공천헌금 파문
이혜훈 후보자 논란"></textarea>
              </div>

              <div class="field">
                <label>하단 설명 (선택)</label>
                <input id="mnDesc" type="text" placeholder="예) ※ 한 달을 관통하는 이슈 키워드" />
              </div>

              <div class="row-actions">
                <button id="mnBuild" class="btn primary">코드 생성</button>
                <button id="mnCopy" class="btn">코드 복사</button>
                <button id="mnReset" class="btn">입력 초기화</button>
              </div>

              <p class="desc" style="margin-top:10px;">
                - 키워드는 최대 8개 정도가 보기 좋습니다.<br/>
                - 입력은 자동 저장됩니다.
              </p>
            </div>

            <!-- 미리보기/출력 -->
            <div class="card">
              <h2>미리보기</h2>
              <div id="mnPreview"></div>

              <h2 style="margin-top:14px;">생성된 코드</h2>
              <textarea id="mnOutput" style="width:100%; height:220px;" placeholder="여기에 month-note 코드가 생성됩니다"></textarea>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

  <script>
    /* =========================
       탭 로직
    ========================= */
    const tabBtns = Array.from(document.querySelectorAll(".tab-btn"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    function setActiveTab(tabId){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      tabPanels.forEach(p => p.classList.toggle("active", p.id === tabId));
      localStorage.setItem("CHEESE_ACTIVE_TAB", tabId);
    }

    tabBtns.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));
    const savedTab = localStorage.getItem("CHEESE_ACTIVE_TAB");
    if (savedTab && document.getElementById(savedTab)) setActiveTab(savedTab);

    /* =========================
       Daily Log Export (기존)
    ========================= */
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbyuC0qHyRdDKL2fC5fmRy66l0y1baCLbXuf9pNlPh0rBde_HQMzaqQv5NK06H_n7WFk/exec";

    const el = {
      year: document.getElementById("year"),
      month: document.getElementById("month"),
      day: document.getElementById("day"),
      start: document.getElementById("start"),
      end: document.getElementById("end"),
      ids: document.getElementById("ids"),
      output: document.getElementById("output"),
      lastUrl: document.getElementById("lastUrl"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnCopy: document.getElementById("btnCopy"),
      btnOpen: document.getElementById("btnOpen"),
      btnClear: document.getElementById("btnClear"),
    };

    let lastRequestUrl = "";

    el.btnGenerate.addEventListener("click", generate);
    el.btnCopy.addEventListener("click", copyOutput);
    el.btnOpen.addEventListener("click", openLastUrl);
    el.btnClear.addEventListener("click", () => {
        el.output.value = "";
        el.lastUrl.textContent = "";
        lastRequestUrl = "";
        el.day.value = "";
        el.start.value = "";
        el.end.value = "";
    });

    function buildUrl() {
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();

      // type="date"는 value가 "YYYY-MM-DD"로 들어옴
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();

      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("월 추출은 연도/월이 필요하고, 일별은 day가 필요하며, 기간은 start/end가 필요합니다. (start만 또는 end만도 가능)");
      }

      const params = new URLSearchParams();
      params.set("mode", "exportDailyLog");

      // ✅ 우선순위: day > start/end > year/month
      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

      if (ids) params.set("id", ids);

      return `${API_BASE}?${params.toString()}`;
    }

    async function generate() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;

        el.output.value = "생성 중...";

        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          redirect: "follow",
          credentials: "omit"
        });
        if (!res.ok) throw new Error("API 호출 실패 (HTTP " + res.status + ")");

        const text = await res.text();

        if (text && /<!doctype html|<html/i.test(text)) {
          throw new Error("API가 HTML 화면을 반환했습니다. (서버 doGet(e) 분기/배포 확인 필요)");
        }

        const fixed = text.replace(/&lt;br\s*\/?&gt;/gi, "<br>");
        el.output.value = fixed || "<!-- empty -->";
      } catch (e) {
        el.output.value = "";
        const msg = (e && e.message ? e.message : String(e));
        alert("HTML 생성 실패: " + msg + "\n\n(확인) '요청 URL 열기'로 새 탭에서 결과가 텍스트로 뜨는지 확인하세요.");
      }
    }

    async function copyOutput() {
      const val = (el.output.value || "").trim();
      if (!val) {
        alert("복사할 내용이 없습니다.");
        return;
      }
      try {
        await navigator.clipboard.writeText(el.output.value);
        alert("복사 완료");
      } catch (e) {
        el.output.focus();
        el.output.select();
        document.execCommand("copy");
        alert("복사 완료");
      }
    }

    function openLastUrl() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (e) {
        alert("URL 생성 실패: " + (e && e.message ? e.message : String(e)));
      }
    }

    /* =========================
       월 요약 포스트잇 생성기
    ========================= */
    const mn = {
      title: document.getElementById("mnTitle"),
      tags: document.getElementById("mnTags"),
      desc: document.getElementById("mnDesc"),
      preview: document.getElementById("mnPreview"),
      output: document.getElementById("mnOutput"),
      build: document.getElementById("mnBuild"),
      copy: document.getElementById("mnCopy"),
      reset: document.getElementById("mnReset"),
    };

    // 저장/복원
    const MN_KEY = "CHEESE_MONTH_NOTE_FORM";
    function loadMonthNote(){
      try{
        const saved = JSON.parse(localStorage.getItem(MN_KEY) || "{}");
        if (saved.title != null) mn.title.value = saved.title;
        if (saved.tags  != null) mn.tags.value  = saved.tags;
        if (saved.desc  != null) mn.desc.value  = saved.desc;
      }catch(_){ }
    }
    function saveMonthNote(){
      localStorage.setItem(MN_KEY, JSON.stringify({
        title: mn.title.value || "",
        tags:  mn.tags.value || "",
        desc:  mn.desc.value || ""
      }));
    }
    ["input","change"].forEach(evt=>{
      mn.title.addEventListener(evt, saveMonthNote);
      mn.tags.addEventListener(evt, saveMonthNote);
      mn.desc.addEventListener(evt, saveMonthNote);
    });
    loadMonthNote();

    // HTML escape (텍스트 입력이 깨지지 않게)
    function escHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/\"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    // 키워드 파싱: 줄바꿈/콤마 모두 지원
    function parseTags(text){
      return String(text || "")
        .split(/\n|,/g)
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, 12); // 안전 상한
    }

    function buildMonthNote(){
      const title = (mn.title.value || "").trim() || "월 핵심 키워드";
      const tags = parseTags(mn.tags.value);
      const desc = (mn.desc.value || "").trim();

      const tagHtml = tags.length
        ? tags.map(t => `    <span class="mtag">${escHtml(t)}</span>`).join("\n")
        : `    <span class="mtag">키워드를 입력하세요</span>`;

      const descHtml = desc
        ? `\n\n  <div class="month-note-desc">\n    ${escHtml(desc)}\n  </div>`
        : "";

      const html =
`<!-- ✅ 월 요약 포스트잇 (매달 1회) -->
<div class="month-note">
  <div class="month-note-title">${escHtml(title)}</div>
  <div class="month-note-tags">
${tagHtml}
  </div>${descHtml}
</div>`;

      // 미리보기(실제 렌더링)
      mn.preview.innerHTML =
        `<div class="month-note">
          <div class="month-note-title">${escHtml(title)}</div>
          <div class="month-note-tags">
            ${tags.map(t => `<span class="mtag">${escHtml(t)}</span>`).join("")}
          </div>
          ${desc ? `<div class="month-note-desc">${escHtml(desc)}</div>` : ""}
        </div>`;

      // 코드 출력(복사용)
      mn.output.value = html;
    }

    mn.build.addEventListener("click", (e) => {
      e.preventDefault();
      buildMonthNote();
      saveMonthNote();
    });

    mn.copy.addEventListener("click", async (e) => {
      e.preventDefault();
      const val = (mn.output.value || "").trim();
      if (!val){ buildMonthNote(); }
      try{
        await navigator.clipboard.writeText(mn.output.value);
        alert("복사 완료");
      }catch(_){
        mn.output.focus();
        mn.output.select();
        document.execCommand("copy");
        alert("복사 완료");
      }
    });

    mn.reset.addEventListener("click", (e) => {
      e.preventDefault();
      mn.title.value = "";
      mn.tags.value = "";
      mn.desc.value = "";
      mn.preview.innerHTML = "";
      mn.output.value = "";
      localStorage.removeItem(MN_KEY);
    });

    // 처음 들어왔을 때 미리보기 자동 생성(입력값 있으면)
    if ((mn.title.value || mn.tags.value || mn.desc.value).trim().length){
      buildMonthNote();
    }

    /* =========================
       TAGGING (태그 검수)
       - base 태그는 DB에 "중요-보수" 형태로 저장
       - 그룹 태그는 E-xxxxxx-xx 단 1개 유지
    ========================= */

    // 선택: ADMIN_KEY를 Code.gs와 맞추면 list/patch 보호 가능
    const ADMIN_KEY = ""; // Code.gs의 ADMIN_KEY와 동일하게(비우면 보호 없음)

    // base UI 표시용 ↔ DB 저장용 매핑
    const BASE_UI = ["보수","진보","국제","이슈"]; // UI에서 보이는 라벨
    const BASE_DB_PREFIX = "중요-";                 // DB에 저장되는 접두

    // group(E-xxxxxx-xx) 패턴
    const GROUP_RE = /^E-\d{6}-\d{2}$/;

    const tg = {
      load: document.getElementById("tgLoad"),
      onlyEmpty: document.getElementById("tgOnlyEmpty"),
      status: document.getElementById("tgStatus"),
      cards: document.getElementById("tgCards"),
    };

    const SAVE_DEBOUNCE_MS = 450;
    const saveTimers = new Map(); // id -> timer

    tg.load.addEventListener("click", loadTagCards);

    function buildListUrl(){
      // buildUrl()과 동일한 입력값 사용(연/월/일/기간/id 우선순위)
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("월 추출은 연도/월이 필요하고, 일별은 day가 필요하며, 기간은 start/end가 필요합니다. (start만 또는 end만도 가능)");
      }

      const params = new URLSearchParams();
      params.set("mode", "listEvents");
      params.set("limit", "300");

      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

      if (ids) params.set("id", ids);
      if (ADMIN_KEY) params.set("key", ADMIN_KEY);

      return `${API_BASE}?${params.toString()}`;
    }

    async function loadTagCards(){
      try{
        tg.status.textContent = "불러오는 중...";
        tg.cards.innerHTML = "";

        const url = buildListUrl();
        const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
        if (!res.ok) throw new Error("목록 API 실패 (HTTP " + res.status + ")");

        const data = await res.json();
        if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "UNKNOWN_ERROR");

        let items = Array.isArray(data.items) ? data.items : [];

        // 태그 비어있는 것만
        if (tg.onlyEmpty.checked) {
          items = items.filter(it => !String(it.tags || "").trim());
        }

        tg.status.textContent = `${items.length}건`;

        tg.cards.innerHTML = items.map(it => renderEventCardHtml(it)).join("");

        // 이벤트 바인딩
        items.forEach(it => bindEventCard(it));

      }catch(e){
        tg.status.textContent = "";
        alert("태그 검수 목록 불러오기 실패: " + (e && e.message ? e.message : String(e)));
      }
    }

    function renderEventCardHtml(it){
      const id = escAttr(it.id);
      const title = escHtml(it.title || "");
      const date = escHtml(it.date_start || "");
      const party = escHtml(it.party || "");

      // tags: DB 그대로(예: 중요-보수, E-202601-01, economy-..., 기타...)
      const tags = parseTagsToArray(it.tags || "");

      // base: DB태그 기반으로 UI 체크여부 계산
      const hasBosu  = hasDbBase(tags, "보수");
      const hasJinbo = hasDbBase(tags, "진보");
      const hasIntl  = hasDbBase(tags, "국제");
      const hasIssue = hasDbBase(tags, "이슈");

      // typed
      const ecoVal = getTypedTagValue(tags, "economy");
      const impVal = getTypedTagValue(tags, "important");
      const mouVal = getTypedTagValue(tags, "mounting");
      const ecoOn = ecoVal != null;
      const impOn = impVal != null;
      const mouOn = mouVal != null;

      // group(E-xxxxxx-xx) 하나만
      const groupTag = getGroupTag(tags) || "";

      const pillId = `pill_${id}`;
      const noteEId = `note_e_${id}`;
      const noteIId = `note_i_${id}`;
      const noteMId = `note_m_${id}`;
      const groupSelId = `group_${id}`;

      const contentPreview = buildPreview(it.content_raw || "");

      return `
      <div class="ev-card" data-id="${id}">
        <div class="ev-head">
          <div>
            <div class="ev-title">${title}</div>
            <div class="ev-meta">${date}${party ? " · " + party : ""} · ${id}</div>
          </div>
          <span id="${pillId}" class="save-pill">대기</span>
        </div>

        <div class="ev-body">${contentPreview}</div>

        <div class="ev-tags">
          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="보수" ${hasBosu ? "checked":""}/>보수</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="진보" ${hasJinbo ? "checked":""}/>진보</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="국제" ${hasIntl ? "checked":""}/>국제</label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="이슈" ${hasIssue ? "checked":""}/>이슈</label>
            <span class="tag-hint">(DB: 중요-*)</span>
          </div>

          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="economy" ${ecoOn ? "checked":""}/>economy</label>
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="important" ${impOn ? "checked":""}/>important</label>
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="mounting" ${mouOn ? "checked":""}/>mounting</label>
          </div>

          <div class="tag-group">
            <span style="font-weight:900;">서브카드 그룹</span>
            <div class="group-editor" data-tg="group">
              <input data-role="group-input" type="text" placeholder="예) E-202601-01" value="${escAttr(groupTag)}" />
              <button type="button" class="btn-mini primary" data-action="group-apply">적용</button>
              <button type="button" class="btn-mini danger" data-action="group-clear">해제</button>
              <span class="tag-hint">E-xxxxxx-xx (1개 유지)</span>
            </div>
          </div>
        </div>

        <div class="tag-note" data-note="economy" style="${ecoOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">economy</b>
          <input id="${noteEId}" type="text" placeholder="예) 환율/금리/유가" value="${escAttr(ecoVal || "")}" />
        </div>

        <div class="tag-note" data-note="important" style="${impOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">important</b>
          <input id="${noteIId}" type="text" placeholder="예) 왜 중요한지 한 줄" value="${escAttr(impVal || "")}" />
        </div>

        <div class="tag-note" data-note="mounting" style="${mouOn ? "display:flex;" : ""}">
          <b style="min-width:82px;">mounting</b>
          <input id="${noteMId}" type="text" placeholder="예) 확산/증폭 포인트" value="${escAttr(mouVal || "")}" />
        </div>

        <textarea data-role="tags-raw" style="display:none;">${escHtml(tags.join(","))}</textarea>
      </div>
      `;
    }

    function bindEventCard(it){
      const root = tg.cards.querySelector(`.ev-card[data-id="${CSS.escape(it.id)}"]`);
      if (!root) return;

      const pill = root.querySelector(`#pill_${CSS.escape(it.id)}`);

      const getTags = () => parseTagsToArray(root.querySelector('[data-role="tags-raw"]').value);
      const setTags = (arr) => {
        const norm = normalizeTagsArray(arr);
        root.querySelector('[data-role="tags-raw"]').value = norm.join(",");
        scheduleSave(it.id, norm, pill);
      };

      // base / typed 체크박스들
      root.querySelectorAll('input[type="checkbox"][data-tg]').forEach(chk=>{
        chk.addEventListener("change", ()=>{
          const kind = chk.dataset.tg;
          const key = chk.dataset.key;
          const checked = chk.checked;

          let tags = getTags();

          if (kind === "base"){
            // UI: 보수/진보/국제/이슈
            // DB: 중요-보수/중요-진보/중요-국제/중요-이슈

            // 보수/진보는 상호배타 (DB도 같이 제거)
            if (key === "보수" && checked) tags = removeDbBase(tags, "진보");
            if (key === "진보" && checked) tags = removeDbBase(tags, "보수");

            tags = checked ? addDbBase(tags, key) : removeDbBase(tags, key);
            setTags(tags);
            return;
          }

          if (kind === "typed"){
            if (checked){
              tags = upsertTyped(tags, key, getTypedTagValue(tags, key) || "");
              showNote(root, key, true);
              focusNote(root, key);
            }else{
              tags = removeTyped(tags, key);
              showNote(root, key, false);
              clearNote(root, key);
            }
            setTags(tags);
            return;
          }
        });
      });

      // typed 입력창들(디바운스)
      ["economy","important","mounting"].forEach(tp=>{
        const input = root.querySelector(`.tag-note[data-note="${tp}"] input`);
        if (!input) return;

        let t = null;
        input.addEventListener("input", ()=>{
          clearTimeout(t);
          t = setTimeout(()=>{
            let tags = getTags();
            const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
            if (!on) return;

            tags = upsertTyped(tags, tp, input.value || "");
            setTags(tags);
          }, 450);
        });

        input.addEventListener("blur", ()=>{
          let tags = getTags();
          const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
          if (!on) return;
          tags = upsertTyped(tags, tp, input.value || "");
          setTags(tags);
        });
      });

      // 그룹(E-xxxxxx-xx) editor (input + 적용/해제)
      const groupBox = root.querySelector('.group-editor[data-tg="group"]');
      if (groupBox){
        const input = groupBox.querySelector('input[data-role="group-input"]');
        const btnApply = groupBox.querySelector('[data-action="group-apply"]');
        const btnClear = groupBox.querySelector('[data-action="group-clear"]');

        const applyGroup = (raw) => {
          const v = String(raw || "").trim();
          if (v && !GROUP_RE.test(v)){
            alert("형식이 올바르지 않습니다.\nE-xxxxxx-xx (예: E-202601-01)");
            return;
          }
          let tags = getTags();
          tags = removeGroupTags(tags);
          if (v) tags = tags.concat([v]);
          setTags(tags);
          if (input) input.value = v;
        };

        if (btnApply){
          btnApply.addEventListener('click', ()=> applyGroup(input ? input.value : ""));
        }
        if (btnClear){
          btnClear.addEventListener('click', ()=> applyGroup(""));
        }

        // 엔터로도 적용
        if (input){
          input.addEventListener('keydown', (e)=>{
            if (e.key === 'Enter'){
              e.preventDefault();
              applyGroup(input.value);
            }
          });
        }
      }
    }

    // (구버전 select용 함수는 더 이상 사용하지 않음)

    function scheduleSave(id, tagsArr, pillEl){
      if (saveTimers.has(id)) clearTimeout(saveTimers.get(id));

      pillEl.classList.remove("saved","err");
      pillEl.classList.add("saving");
      pillEl.textContent = "저장중";

      const timer = setTimeout(async ()=>{
        try{
          const ok = await postPatchTags(id, tagsArr.join(","));
          if (!ok) throw new Error("SAVE_FAILED");

          pillEl.classList.remove("saving","err");
          pillEl.classList.add("saved");
          pillEl.textContent = "저장됨";
        }catch(e){
          pillEl.classList.remove("saving","saved");
          pillEl.classList.add("err");
          pillEl.textContent = "오류";
        }
      }, SAVE_DEBOUNCE_MS);

      saveTimers.set(id, timer);
    }

    async function postPatchTags(id, tags){
      const params = new URLSearchParams();
      params.set("mode","patchTags");
      if (ADMIN_KEY) params.set("key", ADMIN_KEY);

      const url = `${API_BASE}?${params.toString()}`;

      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id, tags }),
        cache:"no-store",
        credentials:"omit"
      });

      if (!res.ok) return false;

      const data = await res.json().catch(()=>null);
      return !!(data && data.ok === true);
    }

    /* ---------- Tag Helpers ---------- */

    function parseTagsToArray(s){
      return String(s || "")
        .split(",")
        .map(x=>String(x).trim())
        .filter(Boolean);
    }

    // base UI -> DB tag
    function toDbBase(ui){ return `${BASE_DB_PREFIX}${ui}`; }

    function hasDbBase(arr, ui){
      return arr.includes(toDbBase(ui));
    }

    function addDbBase(arr, ui){
      const t = toDbBase(ui);
      if (arr.includes(t)) return arr;
      return arr.concat([t]);
    }

    function removeDbBase(arr, ui){
      const t = toDbBase(ui);
      return arr.filter(x => x !== t);
    }

    function getGroupTag(arr){
      for (const t of arr){
        const s = String(t||"").trim();
        if (GROUP_RE.test(s)) return s;
      }
      return "";
    }

    function removeGroupTags(arr){
      return arr.filter(t => !GROUP_RE.test(String(t||"").trim()));
    }

    function getTypedTagValue(arr, type){
      // type or type-xxx
      for (const t of arr){
        const s = String(t||"").trim();
        if (s === type) return ""; // on but empty
        if (s.startsWith(type + "-")) return s.slice(type.length + 1);
      }
      return null; // off
    }

    function removeTyped(arr, type){
      return arr.filter(t=>{
        const s = String(t||"").trim();
        return !(s === type || s.startsWith(type + "-"));
      });
    }

    function upsertTyped(arr, type, value){
      // 먼저 기존 type 제거 후 새로 추가
      const kept = removeTyped(arr, type);
      const v = String(value || "").trim();
      return kept.concat([ v ? `${type}-${v}` : type ]);
    }

    function normalizeTagsArray(arr){
      // 중복 제거(첫 등장 유지)
      const seen = new Set();
      const uniq = [];
      arr.forEach(t=>{
        const s = String(t||"").trim();
        if (!s) return;
        if (seen.has(s)) return;
        seen.add(s);
        uniq.push(s);
      });

      // base는 DB형(중요-*)
      const baseOrder = BASE_UI.map(ui => toDbBase(ui));
      const typedOrder = ["economy","important","mounting","mourning"]; // 기존 유지

      const group = [];
      const base = [];
      const typed = [];
      const other = [];

      uniq.forEach(t=>{
        const s = String(t||"").trim();

        if (GROUP_RE.test(s)) { group.push(s); return; }
        if (baseOrder.includes(s)) { base.push(s); return; }

        const m = /^([a-z]+)(?:-.*)?$/i.exec(s);
        const tp = m ? String(m[1]).toLowerCase() : "";
        if (typedOrder.includes(tp)) { typed.push(s); return; }

        other.push(s);
      });

      // group: E 태그는 1개만 유지(첫번째)
      const groupOne = group.length ? [group[0]] : [];

      const baseSorted = [];
      baseOrder.forEach(x=>{ if (base.includes(x)) baseSorted.push(x); });

      const typedSorted = [];
      const picked = new Set();
      typedOrder.forEach(tp=>{
        const found = typed.find(t=>{
          const m = /^([a-z]+)(?:-.*)?$/i.exec(t);
          const x = m ? String(m[1]).toLowerCase() : "";
          return x === tp;
        });
        if (found && !picked.has(tp)) { picked.add(tp); typedSorted.push(found); }
      });

      return groupOne.concat(baseSorted).concat(typedSorted).concat(other);
    }

    function showNote(root, type, on){
      const box = root.querySelector(`.tag-note[data-note="${type}"]`);
      if (!box) return;
      box.style.display = on ? "flex" : "none";
    }
    function focusNote(root, type){
      const input = root.querySelector(`.tag-note[data-note="${type}"] input`);
      if (input) input.focus();
    }
    function clearNote(root, type){
      const input = root.querySelector(`.tag-note[data-note="${type}"] input`);
      if (input) input.value = "";
    }

    function buildPreview(text){
      const s = String(text || "").replace(/\s+/g," ").trim();
      if (!s) return "<span style='color:rgba(17,24,39,0.55)'>내용 없음</span>";
      const cut = s.length > 220 ? (s.slice(0,220) + "…") : s;
      return escHtml(cut);
    }

    function escAttr(s){ return escHtml(s).replace(/\"/g,"&quot;"); }
  </script>
</body>
</html>
