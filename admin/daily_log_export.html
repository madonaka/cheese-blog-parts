<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./admin.css" />

<style>
  @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

  /* =========================================================
     ğŸš¨ ëª¨ë°”ì¼ ê°€ë¡œ ìŠ¤í¬ë¡¤(í™”ë©´ ì˜ë¦¼) ë°©ì§€ ì ˆëŒ€ ê·œì¹™ ğŸš¨
  ========================================================= */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  html, body {
    max-width: 100vw;
    overflow-x: hidden;
  }

  /* =========================================================
     ê¸€ë¡œë²Œ & ë¦¬ì…‹
  ========================================================= */
  :root {
    --primary: #4f46e5;       
    --bg-color: #f8fafc;      
    --card-bg: #ffffff;
    --text-main: #0f172a;     
    --text-muted: #64748b;    
    --border: #e2e8f0;        
    --danger: #ef4444;        
    --danger-bg: #fef2f2;
    --success: #10b981;       
    --success-bg: #ecfdf5;
    --radius-md: 10px;
    --radius-lg: 16px;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
  }

  body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    line-height: 1.6;
    margin: 0;
  }

  .admin-main .wrap {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    padding: 24px 20px 60px;
  }

  h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.02em; word-break: keep-all; }

  .version-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #e0e7ff; /* ì—°í•œ íŒŒë€ìƒ‰(Primary) ë°°ê²½ */
    color: var(--primary);     /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    border: 1px solid #c7d2fe;
    font-size: 0.85rem;
    font-weight: 800;
    padding: 4px 12px;
    border-radius: 99px;       /* ì•Œì•½(ìº¡ìŠ) ëª¨ì–‘ */
    white-space: nowrap;
    letter-spacing: 0.02em;
    transform: translateY(-2px); /* ì‹œê°ì ì¸ ìˆ˜ì§ ì •ë ¬ ë¯¸ì„¸ì¡°ì • */
  }
  
  /* ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ì œëª©ê³¼ ë°°ì§€ ì—¬ë°± ì¡°ì • */
  @media (max-width: 768px) {
    .title-wrapper { gap: 8px !important; margin-bottom: 12px !important; }
    .version-badge { font-size: 0.75rem; padding: 3px 10px; transform: none; }
  }
  
  .desc { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; word-break: keep-all; }

  /* =========================================================
     ì›Œí¬í”Œë¡œìš° ê·¸ë£¹ (ì‘ì—… 1 & 2)
  ========================================================= */
  .workflow-container {
    display: flex; flex-wrap: wrap; gap: 32px;
    background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg);
    padding: 20px; box-shadow: var(--shadow-sm); margin-bottom: 24px; width: 100%;
  }
  .workflow-group { display: flex; flex-direction: column; gap: 12px; }
  .workflow-group:not(:last-child) { border-right: 2px dashed var(--border); padding-right: 32px; }
  .group-label { font-size: 0.85rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .tabs { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; width: 100%; }
  .tab-btn {
    border: 1px solid var(--border); background: var(--bg-color); color: var(--text-muted);
    padding: 10px 18px; border-radius: 99px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.2s;
    white-space: nowrap; display: inline-flex; justify-content: center; align-items: center;
  }
  .tab-btn:hover { background: var(--card-bg); border-color: #cbd5e1; color: var(--text-main); }
  .tab-btn.active { background: var(--text-main); color: #fff; border-color: var(--text-main); box-shadow: var(--shadow-md); }
  
  .tab-panel { display: none; animation: fadeIn 0.3s ease; }
  .tab-panel.active { display: block; width: 100%; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  /* =========================================================
     ê³µí†µ ìš”ì†Œ (ì¹´ë“œ, í•„í„°, ì¸í’‹, ë²„íŠ¼)
  ========================================================= */
  .card, .export-card {
    background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg);
    padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 20px; width: 100%;
  }
  .card h2 { margin: 0 0 16px; font-size: 1.2rem; font-weight: 800; word-break: keep-all; }
  
  #global-filter-wrap {
    display: none; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: var(--radius-lg);
    padding: 20px; margin-bottom: 24px; box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.02); width: 100%;
  }
  .global-filter-title { font-weight: 800; font-size: 1.1rem; color: var(--primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .global-filter-title::before { content: "ğŸ—“ï¸"; font-size: 1.2rem; }

  .export-sections { display: flex; flex-direction: column; gap: 16px; width: 100%; }
  .search-block { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; width: 100%; }
  .search-title { font-weight: 800; font-size: 0.95rem; color: var(--text-muted); margin: 0 0 12px; }
  .search-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }

  .fg { display: flex; flex-direction: column; gap: 6px; }
  .fg label, .field label { font-weight: 700; font-size: 0.9rem; }
  .fg input, .field input, .field textarea, .tg-select, .group-editor input {
    border: 1px solid #cbd5e1; border-radius: var(--radius-md); padding: 10px 14px; font-size: 0.95rem;
    outline: none; background: var(--card-bg); width: 100%; transition: 0.2s;
  }
  .fg input:focus, .field input:focus, .field textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.15); }
  .field textarea { min-height: 120px; resize: vertical; }
  
  .span-2 { grid-column: span 2; }
  .span-4 { grid-column: span 4; }
  .span-8 { grid-column: span 8; }

  .btn, .btn-mini {
    border: 1px solid var(--border); background: var(--card-bg); border-radius: var(--radius-md);
    cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; white-space: nowrap;
  }
  .btn { padding: 10px 18px; font-size: 0.95rem; height: 42px; }
  .btn-mini { padding: 8px 12px; font-size: 0.85rem; border-radius: 8px; height: 36px; }
  .btn:hover, .btn-mini:hover { background: var(--bg-color); border-color: #cbd5e1; }
  .btn.primary, .btn-mini.primary { background: var(--text-main); color: #fff; border-color: var(--text-main); }
  .btn-mini.danger { background: var(--danger-bg); border-color: #fca5a5; color: var(--danger); }
  .btn-mini.ghost { border: none; background: var(--bg-color); }

  .actions, .row-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 14px;}
  .help-line { margin-top: 10px; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; }

  .note-grid, .add-grid, .ev-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top:10px; }
  .mono{ 
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
    word-break: break-all; /* âœ… ì¶”ê°€: í™”ë©´ì„ ë„˜ì–´ê°€ë©´ ê°•ì œë¡œ ì¤„ë°”ê¿ˆ */
    overflow-wrap: break-word; /* âœ… ì¶”ê°€: ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ ì•ˆì „ì¥ì¹˜ */
  }
  .add-preview { border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; background: var(--bg-color); min-height: 200px; white-space: pre-wrap; word-break: break-word; font-size:13px; color: var(--text-muted); }
  
  /* =========================================================
     ì´ë²¤íŠ¸ ì¹´ë“œ (íƒœê·¸ ê²€ìˆ˜)
  ========================================================= */
  .ev-card {
    border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 18px; background: var(--card-bg);
    position: relative; margin-bottom: 12px; transition: box-shadow 0.2s; width: 100%;
  }
  .ev-card:hover { box-shadow: var(--shadow-md); }
  .ev-card.is-important { background: #fffbfa; border-color: #fecaca; }
  .ev-card.is-important::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: var(--danger); border-radius: 16px 0 0 16px; }
  .ev-card.is-hidden { background: var(--bg-color) !important; opacity: 0.6; filter: grayscale(0.8); }

  .ev-head { display: flex; gap: 12px; align-items: flex-start; justify-content: space-between; }
  .ev-title { font-weight: 800; font-size: 1.1rem; line-height: 1.4; word-break: keep-all; }
  .ev-meta { color: var(--text-muted); font-size: 0.85rem; margin-top: 6px; font-weight: 500; }
  .ev-body { margin-top: 12px; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; background: var(--bg-color); padding: 12px; border-radius: var(--radius-md); }
  .ev-tags { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  .tag-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; padding: 10px 14px; border-radius: var(--radius-md); background: var(--bg-color); border: 1px solid var(--border); }
  .tag-item { display: flex; gap: 6px; align-items: center; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
  .tag-item input { accent-color: var(--primary); transform: translateY(1px); width: 16px; height: 16px; }
  .tag-item.is-important-tag { padding: 4px 10px; border-radius: 99px; background: var(--danger-bg); border: 1px solid #fecaca; color: var(--danger); }
  
  .tag-note { display: none; gap: 10px; align-items: center; margin-top: 12px; }
  .tag-note b { min-width: 82px; font-size: 0.85rem; }
  .save-pill { font-size: 0.8rem; font-weight: 800; padding: 6px 12px; border-radius: 99px; background: var(--bg-color); color: var(--text-muted); }
  .save-pill.saving { background: #fef3c7; color: #b45309; }
  .save-pill.saved { background: var(--success-bg); color: #047857; }
  .save-pill.err { background: var(--danger-bg); color: var(--danger); }
  
  .hide-toggle { display: flex; gap: 6px; align-items: center; font-weight: 800; font-size: 0.85rem; padding: 6px 10px; border-radius: 99px; background: var(--bg-color); border: 1px solid var(--border); cursor: pointer; }
  .ev-card.is-hidden .hide-toggle { background: var(--danger-bg); border-color: #fca5a5; color: var(--danger); }


  /* ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ë””ìì¸ */
  .month-note { margin: 16px 0; padding: 20px 24px; border-radius: 4px 12px 12px 12px; background: #fff8c4; border: 1px solid #fde047; box-shadow: 2px 4px 10px rgba(0,0,0,0.06); position: relative; transform: rotate(-0.5deg); }
  .month-note::before { content:""; position: absolute; top: -12px; left: 18px; width: 66px; height: 18px; border-radius: 4px; background: rgba(255,255,255,0.7); border: 1px solid rgba(17,24,39,0.08); transform: rotate(-2deg); }
  .month-note-title { font-weight: 800; font-size: 1.1rem; color: #451a03; margin-bottom: 12px; border-bottom: 2px dashed #fcd34d; padding-bottom: 8px; }
  .month-note-tags { display: flex; flex-wrap: wrap; gap: 8px; }
  .month-note-tags .mtag { display: inline-block; padding: 4px 10px; border-radius: 99px; font-size: 0.85em; font-weight: 800; background: rgba(255,255,255,0.6); color: #78350f; border: 1px solid rgba(217, 119, 6, 0.2); }
  .month-note-desc { margin-top: 12px; font-size: 0.9em; font-weight: 600; color: #92400e; }

  /* ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì˜ì—­ */
  .paste-zone { border: 2px dashed #cbd5e1; border-radius: var(--radius-md); padding: 16px; background: #fff; text-align: center; font-weight: 700; color: var(--text-muted); cursor: pointer; }
  .paste-hint { font-size: 0.85rem; color: var(--text-muted); margin-top: 6px; }
  .paste-preview { margin-top: 12px; display: none; align-items: center; gap: 12px; background: #fff; padding: 8px; border-radius: 8px; border: 1px solid var(--border); }
  .paste-preview img { width: 80px; height: 80px; border-radius: 6px; object-fit: cover; }

 /* =========================================================
     ì»¤ìŠ¤í…€ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ë””ìì¸ (ì›” ì„ íƒ ë“±)
  ========================================================= */
  .custom-select {
    appearance: none; /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í™”ì‚´í‘œ ìˆ¨ê¹€ */
    -webkit-appearance: none;
    -moz-appearance: none;
    background-color: var(--card-bg);
    border: 1px solid #cbd5e1;
    border-radius: var(--radius-md);
    padding: 10px 36px 10px 14px; /* ìš°ì¸¡ í™”ì‚´í‘œ ì•„ì´ì½˜ ì—¬ë°± í™•ë³´ */
    font-size: 0.95rem;
    color: var(--text-main);
    width: 100%;
    cursor: pointer;
    transition: 0.2s border-color, 0.2s box-shadow;
    /* SVGë¡œ ë§Œë“  ê¹”ë”í•œ í™”ì‚´í‘œ ì•„ì´ì½˜ ì‚½ì… */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
  }
  .custom-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
  }
  /* =========================================================
     ì´ë²¤íŠ¸ íƒœê·¸(ì¹© ë””ìì¸) ë° ë¶€ê°€ ì…ë ¥ì°½(ë…¸íŠ¸) ë””ìì¸ ê°œì„ 
  ========================================================= */
  .ev-tags { margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .tag-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; padding: 10px 14px; border-radius: var(--radius-md); background: #f8fafc; border: 1px solid var(--border); }
  
  /* ì²´í¬ë°•ìŠ¤ë¥¼ ìˆ¨ê¸°ê³  ì˜ˆìœ ì•Œì•½(Chip) ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ */
  .tag-item { display: inline-flex; align-items: center; cursor: pointer; position: relative; margin: 0; }
  .tag-item input { position: absolute; opacity: 0; width: 0; height: 0; }
  .tag-item span { 
    padding: 6px 14px; border-radius: 99px; background: #ffffff; border: 1px solid #cbd5e1; 
    font-size: 0.85rem; font-weight: 800; color: var(--text-muted); transition: all 0.2s;
  }
  /* ê¸°ë³¸ íƒœê·¸ & ê²½ì œ/ì• ë„ ì„ íƒ ì‹œ ì‹œê° íš¨ê³¼ */
  .tag-item input:checked + span { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 6px rgba(79, 70, 229, 0.2); }
  /* ì¤‘ìš”(ğŸŒŸ) íƒœê·¸ íŠ¹í™” ë””ìì¸ (ë¹¨ê°„ìƒ‰) */
  .tag-item.is-important-tag input:checked + span { background: #ef4444; color: #fff; border-color: #ef4444; box-shadow: 0 2px 6px rgba(239, 68, 68, 0.2); }

  /* ê·¸ë£¹í•‘ ì—ë””í„° ë‘¥ê¸€ê²Œ */
  .group-editor input { border: 1px solid #cbd5e1; border-radius: var(--radius-md); padding: 8px 12px; font-size: 0.85rem; outline: none; transition: 0.2s; }
  .group-editor input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.15); }

  /* ì¡°ê±´ë¶€ ë“±ì¥í•˜ëŠ” íƒœê·¸ ë¶€ê°€ ë…¸íŠ¸ ì…ë ¥ì°½ ë””ìì¸ (ë°°ê²½ìƒ‰ê³¼ ë³´ë”ë¡œ ì˜ˆì˜ê²Œ êµ¬ë¶„) */
  .tag-note { display: none; gap: 12px; align-items: center; margin-top: 12px; background: #f0fdf4; padding: 12px 16px; border-radius: var(--radius-md); border: 1px solid #bbf7d0; animation: fadeIn 0.3s ease; }
  .tag-note[data-note="important"] { background: #fff1f2; border-color: #fecdd3; } /* ì¤‘ìš” í‚¤ì›Œë“œ ì°½ì€ ë¹¨ê°„ ê³„ì—´ */
  .tag-note[data-note="mourning"] { background: #f8fafc; border-color: #cbd5e1; }  /* ì• ë„ ì°½ì€ íšŒìƒ‰ ê³„ì—´ */
  
  .tag-note b { min-width: 75px; font-size: 0.85rem; color: #1e293b; }
  .tag-note input { flex: 1; border: 1px solid #cbd5e1; border-radius: 8px; padding: 8px 14px; font-size: 0.9rem; outline: none; transition: 0.2s; background: #fff; }
  .tag-note input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.15); }

  /* ëª¨ë°”ì¼ì—ì„œ íƒœê·¸ ì„¸ë¡œ ë‚˜ì—´ ë°©ì§€ -> ê°€ë¡œ ì •ë ¬(wrap)ë¡œ ë³µêµ¬ */
  @media (max-width: 768px) {
    .tag-group { width: 100% !important; flex-direction: row !important; flex-wrap: wrap !important; align-items: center !important; padding: 12px !important;}
    .tag-note { flex-direction: column; align-items: stretch; gap: 8px; }
    .tag-note b { margin-bottom: 2px; }
  }
  /* =========================================================
     ğŸ“± ëª¨ë°”ì¼ ì™„ë²½ ëŒ€ì‘ (í™”ë©´ í­ 768px ì´í•˜)
  ========================================================= */
  @media (max-width: 768px) {
    .admin-main .wrap { padding: 12px 16px 40px !important; }
    h1 { font-size: 1.35rem !important; }
    
    /* 1. ì›Œí¬í”Œë¡œìš°ë¥¼ ê°•ì œë¡œ ìœ„/ì•„ë˜ë¡œ ìŒ“ì´ê²Œ ë§Œë“¦ */
    .workflow-container { flex-direction: column !important; padding: 16px !important; gap: 20px !important; margin-bottom: 16px !important;}
    .workflow-group { width: 100% !important; min-width: 0 !important;}
    .workflow-group:not(:last-child) { border-right: none !important; border-bottom: 2px dashed var(--border) !important; padding-right: 0 !important; padding-bottom: 20px !important; }
    
    /* 2. íƒ­ ë²„íŠ¼ë“¤ì„ ê°€ë¡œ 100% ê½‰ì°¨ê²Œ ë§Œë“¤ì–´ ìŠ¤í¬ë¡¤ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
    .tabs { flex-direction: column !important; align-items: stretch !important; gap: 10px !important; padding: 0 !important; margin-top: 12px !important; border: none !important; box-shadow: none !important; background: transparent !important;}
    .tab-btn { width: 100% !important; margin: 0 !important; padding: 14px !important; font-size: 1.05rem !important; white-space: normal !important; text-align: center !important;}

    /* 3. ê·¸ë¦¬ë“œ, ì„¹ì…˜ ë“± ë°˜ì‘í˜• ì •ë ¬ (ê²€ìƒ‰ í•„í„° ì˜ì—­ UI ê°œì„ ) */
    .card, .export-card { padding: 16px !important; }
    
    /* ê¸°ì¡´: search-grid í¬í•¨ ëª¨ë“  ìš”ì†Œë¥¼ ì„¸ë¡œ 1ë‹¨ìœ¼ë¡œ ë§Œë“¤ë˜ ê²ƒì„ ë¶„ë¦¬ */
    .export-sections, .note-grid, .add-grid, .ev-edit-grid { display: flex !important; flex-direction: column !important; gap: 14px !important; width: 100% !important; }
    
    /* ê°œì„ : ê²€ìƒ‰ í•„í„°(ì—°/ì›”, ì‹œì‘/ì¢…ë£Œì¼)ëŠ” 2ë‹¨ ê·¸ë¦¬ë“œë¡œ ë¬¶ì–´ì„œ ê¹”ë”í•˜ê²Œ ë°°ì¹˜ */
    .search-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 12px !important; width: 100% !important; }
    
    .span-2, .span-4, .span-8 { width: 100% !important; min-width: 0 !important; }
    
    /* ê²€ìƒ‰ ê·¸ë¦¬ë“œì˜ 3ë²ˆì§¸ ìš”ì†Œ(ì¼(ë‹¨ì¼), IDê²€ìƒ‰)ëŠ” ê°€ë¡œ ì „ì²´(2ì¹¸)ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    .search-grid > .fg:nth-child(3) { grid-column: span 2 !important; }

    .search-block { min-width: 0 !important; width: 100% !important; padding: 16px !important; }
    
    /* ê¸€ë¡œë²Œ í•„í„° íƒ€ì´í‹€ ë° ë°•ìŠ¤ ì—¬ë°± ëª¨ë°”ì¼ ìµœì í™” */
    .global-filter-title { font-size: 1rem !important; margin-bottom: 12px !important; word-break: keep-all; }
    #global-filter-wrap { padding: 16px !important; margin-bottom: 16px !important; }

    /* 4. ê°ì¢… ë²„íŠ¼ ëª©ë¡ë“¤ ì„¸ë¡œë¡œ ê½‰ ì°¨ê²Œ */
    .row-actions, .actions, .ev-edit-actions { display: flex !important; flex-direction: column !important; align-items: stretch !important; width: 100% !important; gap: 10px !important; margin-top: 16px !important;}
    .row-actions .btn, .actions .btn, .ev-edit-actions button { width: 100% !important; margin: 0 !important; }
    .actions > label { flex-direction: column !important; align-items: flex-start !important; margin: 0 !important; width: 100% !important; }

    /* 5. íƒœê·¸ ê²€ìˆ˜ ì¹´ë“œ ë‚´ë¶€ ì •ë ¬ */
    .ev-card { padding: 16px !important; }
    .ev-head { flex-direction: column !important; align-items: flex-start !important; gap: 12px !important; }
    .ev-actions { width: 100% !important; flex-direction: row !important; flex-wrap: wrap !important; justify-content: flex-start !important; padding-top: 12px !important; border-top: 1px dashed var(--border) !important; }

    .ev-tags { flex-direction: column !important; align-items: stretch !important; gap: 10px !important;}
    
    /* ğŸ‘‡ tag-groupì„ ê°€ë¡œ(row)ë¡œ ë°°ì¹˜í•˜ê³  ê³µê°„ì´ ëª¨ìë¼ë©´ ì¤„ë°”ê¿ˆ(wrap) ë˜ë„ë¡ ìˆ˜ì • */
    .tag-group { width: 100% !important; flex-direction: row !important; flex-wrap: wrap !important; align-items: center !important; padding: 12px !important; gap: 8px !important; }
    
    .group-editor { display: flex !important; flex-direction: column !important; width: 100% !important; align-items: stretch !important; }
    
    .group-editor input, .group-editor button { width: 100% !important; margin: 0 !important; }
    
    .tag-note { flex-direction: column !important; align-items: stretch !important; gap: 8px !important; }    .tag-note b { margin-bottom: 2px !important; }
    .tag-note input { width: 100% !important; }
    .tag-note label { margin-left: 0 !important; margin-top: 4px !important;}

    /* ê¸°íƒ€ ì¸í’‹ ì°½ ë° ë²„íŠ¼ */
    #tgQuery { width: 100% !important; }
    .tg-select { width: 100% !important; }
  }
  /* =========================================================
     ìˆ˜ë™ ì…ë ¥ í¼ ëª¨ë‹¬ (Modal) ì¶”ê°€
  ========================================================= */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15,23,42,0.6); backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center;
    z-index: 9999; padding: 20px;
  }
  .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
  .modal-content {
    background: #fff; border-radius: var(--radius-lg); padding: 24px;
    width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px dashed var(--border); padding-bottom: 12px; }
  .modal-header h2 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--text-main); }
  .close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted); line-height: 1; padding: 0; }
  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 640px) { .modal-grid { grid-template-columns: 1fr; } }

  /* =========================================================
     ê²€ìƒ‰ í•„í„° ì˜ì—­ ë°˜ì‘í˜• íƒ­ ë””ìì¸
  ========================================================= */
  /* ë°ìŠ¤í¬í†±: íƒ­ ë²„íŠ¼ ìˆ¨ê¸°ê³  ê¸°ì¡´ì²˜ëŸ¼ ë‚˜ë€íˆ í‘œì‹œ */
  .filter-tabs { display: none; }
  .filter-panels { display: flex; gap: 16px; flex-wrap: wrap; width: 100%; }
  .filter-panel { flex: 1; min-width: 300px; display: block !important; }

  /* ëª¨ë°”ì¼: íƒ­ ë²„íŠ¼ í‘œì‹œí•˜ê³  ì„ íƒëœ íŒ¨ë„ë§Œ ë„“ê²Œ í‘œì‹œ */
  @media (max-width: 768px) {
    .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; width: 100%; }
    .filter-tab-btn {
      flex: 1; padding: 12px 8px; border-radius: var(--radius-md); border: 1px solid #cbd5e1;
      background: #fff; font-weight: 800; font-size: 0.9rem; color: var(--text-muted);
      cursor: pointer; transition: 0.2s; text-align: center; word-break: keep-all;
    }
    .filter-tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    
    .filter-panels { display: block; }
    .filter-panel { display: none !important; animation: fadeIn 0.2s ease; }
    .filter-panel.active { display: block !important; }
    
    /* íƒ­ì´ ì œëª© ì—­í• ì„ í•˜ë¯€ë¡œ ê¸°ì¡´ íŒ¨ë„ ë‚´ë¶€ ì œëª©ì€ ìˆ¨ê¹€ ì²˜ë¦¬ */
    .filter-panel .search-title { display: none; } 
  }
</style>

</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <main class="wrap">
        <div class="title-wrapper" style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap;">
          <h1 style="margin-bottom: 0;">ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬</h1>
          <span id="versionBadge" class="version-badge">ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘...</span>        
        <p class="desc">
          ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¸”ë¡œê·¸ì— ë°”ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ë³€í™˜í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. ì›Œí¬í”Œë¡œìš° ìˆœì„œëŒ€ë¡œ ì‘ì—…ì„ ì§„í–‰í•˜ì„¸ìš”.
        </p>

      <div class="workflow-container">
        <div class="workflow-group">
          <div class="group-label">ì‘ì—… 1: ë°ì´í„° ì…ë ¥</div>
          <div class="tabs" style="margin:0;">
            <button class="tab-btn active" data-tab="tab-add">ğŸ“ ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€</button>
          </div>
        </div>
        
        <div class="workflow-group" style="flex:1;">
          <div class="group-label">ì‘ì—… 2: ë°œí–‰ íŒŒì´í”„ë¼ì¸ (ê²€ìˆ˜ â†’ ì¶”ì¶œ)</div>
          <div class="tabs" style="margin:0;">
            <button class="tab-btn" data-tab="tab-tagging">1ï¸âƒ£ íƒœê·¸/ë‚´ìš© ê²€ìˆ˜</button>
            <button class="tab-btn" data-tab="tab-monthnote">2ï¸âƒ£ ì›” ìš”ì•½ ìƒì„±</button>
            <button class="tab-btn" data-tab="tab-yearhead">3ï¸âƒ£ ì—°ë„ í—¤ë” ìƒì„±</button>
            <button class="tab-btn" data-tab="tab-export">4ï¸âƒ£ ìµœì¢… HTML ì¶”ì¶œ</button>
          </div>
        </div>
      </div>

      <div id="global-filter-wrap">
          <div class="global-filter-title">ì¶”ì¶œí•  ë°ì´í„°ì˜ ë‚ ì§œ/ê¸°ê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ì„¸ìš”</div>
          
          <div class="filter-tabs">
            <button type="button" class="filter-tab-btn active" data-target="filter-basic">ì—°ë„, ì›”, ì¼ ê²€ìƒ‰</button>
            <button type="button" class="filter-tab-btn" data-target="filter-advanced">êµ¬ì²´ì  ë²”ìœ„ ë° ID ê²€ìƒ‰</button>
          </div>

          <div class="export-sections">
            <div class="filter-panels">
              
             <div id="filter-basic" class="search-block filter-panel active">
                <div class="search-title">ì—°ë„, ì›”, ì¼ ê²€ìƒ‰</div>
                <div class="search-grid">
                  <div class="fg span-4">
                    <label for="year">ì—°ë„</label>
                    <input id="year" type="number" value="2026" />
                  </div>
                  
                  <div class="fg span-4">
                    <label for="month">ì›”</label>
                    <select id="month" class="custom-select">
                      <option value="1" selected>1ì›”</option>
                      <option value="2">2ì›”</option>
                      <option value="3">3ì›”</option>
                      <option value="4">4ì›”</option>
                      <option value="5">5ì›”</option>
                      <option value="6">6ì›”</option>
                      <option value="7">7ì›”</option>
                      <option value="8">8ì›”</option>
                      <option value="9">9ì›”</option>
                      <option value="10">10ì›”</option>
                      <option value="11">11ì›”</option>
                      <option value="12">12ì›”</option>
                    </select>
                  </div>

                  <div class="fg span-4">
                    <label for="day">ì¼ (ë‹¨ì¼)</label>
                    <input id="day" type="date" />
                  </div>
                </div>
              </div>

            <div id="filter-advanced" class="search-block filter-panel">
                <div class="search-title">êµ¬ì²´ì  ë²”ìœ„ ë° ID ê²€ìƒ‰</div>
                <div class="search-grid">
                  <div class="fg span-4">
                    <label for="start">Start Date</label>
                    <input id="start" type="date" />
                  </div>
                  <div class="fg span-4">
                    <label for="end">End Date</label>
                    <input id="end" type="date" />
                  </div>
                  <div class="fg span-4">
                    <label for="ids">ID ë¡œ ê²€ìƒ‰</label>
                    <input id="ids" type="text" placeholder="ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„" />
                  </div>
                </div>
              </div>
            </div>
            <div class="help-line" style="font-size:0.85rem; color:var(--text-muted);">
              ğŸ’¡ <b>day</b> ì…ë ¥ ì‹œ ì¼ë³„ ìš°ì„  ì ìš© / <b>start~end</b> ì…ë ¥ ì‹œ ê¸°ê°„ ì ìš© / ë¯¸ì…ë ¥ ì‹œ <b>ì—°ë„+ì›”</b> ì ìš©
            </div>
          </div>
        </div>

        <section id="tab-add" class="tab-panel active">
          <div class="card ai-card">
            <h2>âœ¨ AI ë‰´ìŠ¤/ì´ë¯¸ì§€ ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸</h2>
            <div style="margin-bottom:12px;">
              <label style="display:block; font-size:0.95rem; font-weight:800; color:var(--text-main); margin-bottom:8px;">
                ê¸°ì‚¬ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ ë„£ê±°ë‚˜, <strong>ê´€ë ¨ ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°(Ctrl+V)</strong> í•˜ì„¸ìš”.
              </label>
              <textarea id="ai_input_text"
                style="width:100%; height:100px; padding:16px; border:1px solid #bae6fd; border-radius:12px; font-size:0.95rem; outline:none; background:#fff; box-shadow:inset 0 2px 4px rgba(0,0,0,0.02);"
                placeholder="í…ìŠ¤íŠ¸ ì…ë ¥ ë˜ëŠ” í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°..."></textarea>

              <div id="ai_image_preview_area" style="margin-top:12px; display:none; background:#fff; padding:12px; border-radius:12px; border:1px dashed #7dd3fc;">
                <span style="font-size:0.85rem; color:#0369a1; font-weight:800; display:flex; align-items:center; gap:6px;">ğŸ“¸ ì¸ì‹ëœ ì´ë¯¸ì§€ (ë¶„ì„ì— í™œìš©ë©ë‹ˆë‹¤)</span>
                <div style="margin-top:8px; display:flex; align-items:flex-end; gap:12px;">
                  <img id="ai_image_preview" style="max-height:100px; border-radius:8px; box-shadow:var(--shadow-sm);">
                  <button onclick="clearAiImage()" class="btn-mini danger">ì‚­ì œ</button>
                </div>
              </div>
            </div>
            <div style="text-align:right;">
              <button id="btn_ai_analyze" class="btn primary" style="background:#0284c7; border-color:#0284c7;" onclick="runAiAnalysis()">
                âš¡ AI ìë™ íŒŒì‹± ì‹¤í–‰
              </button>
            </div>
          </div>

          <div class="card">
            <h2>ìˆ˜ë™ ì´ë²¤íŠ¸ ë“±ë¡ (íŒŒì´í”„ ë¼ì¸ í˜•íƒœ)</h2>
            <p class="desc" style="margin-top:6px;">
              í˜•ì‹(11ì¹¸ ê³ ì •): <span class="mono">id|date_type|date_start|date_end|title|content_raw|party|is_foreign|country|tags|created_at</span><br/>
              - <b>id</b>ê°€ <span class="mono">AUTO</span> ì´ë©´ ìë™ ìƒì„±. ì €ì¥ ì‹œ date_type ìë™ ê³„ì‚°. ì—¬ëŸ¬ ì¤„ ë™ì‹œ ì…ë ¥ ê°€ëŠ¥.
            </p>

            <div class="add-grid">
              <div>
                <div class="field">
                  <label style="margin:0;">ë°ì´í„° ì…ë ¥ (ì—¬ëŸ¬ í–‰ ê°€ëŠ¥)</label>
                  <button type="button" class="btn-mini primary" onclick="openManualModal()">ğŸ“ + í¼ìœ¼ë¡œ ì…ë ¥í•˜ê¸°</button>
                  <textarea id="addLine" class="mono" style="min-height:220px;"
                    placeholder="AUTO|single|2026-01-14||ì œëª©|ë‚´ìš©|gukhim|FALSE||important|2026-01-14 13:40"></textarea>
                </div>

                <div class="row-actions">
                  <button id="addSave" class="btn primary">ì‹œíŠ¸ì— ì¼ê´„ ì €ì¥</button>
                  <button id="addClear" class="btn">ì…ë ¥ì°½ ë¹„ìš°ê¸°</button>
                  <span id="addStatus" class="tag-hint" style="margin-left:auto;"></span>
                </div>
              </div>

              <div>
                <div class="field">
                  <label>ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (íŒŒì‹± ê²°ê³¼ ê²€ì¦)</label>
                  <div id="addPreview" class="add-preview mono">(ì•„ì§ ì—†ìŒ)</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-tagging" class="tab-panel">
          <div class="card">
            <h2>ë°ì´í„° ê²€ìˆ˜ ë° íƒœê¹…</h2>
            <p class="desc">
              ìƒë‹¨ ê¸€ë¡œë²Œ í•„í„°ì—ì„œ ì„¤ì •í•œ ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ê²€ìˆ˜í•©ë‹ˆë‹¤. ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì£¼ìš” íƒœê·¸ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”.
            </p>

            <div class="row-actions" style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid var(--border);">
              <button id="tgLoad" class="btn primary">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
              
              <div style="display:flex; gap:16px; flex-wrap:wrap; margin-left:auto;">
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  <input id="tgOnlyEmpty" type="checkbox" style="width:18px; height:18px; accent-color:var(--primary);" />
                  íƒœê·¸ ì—†ëŠ” ê²ƒë§Œ
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  ë³´ê¸° ëª¨ë“œ
                  <select id="tgHiddenView" class="tg-select">
                    <option value="all" selected>ì „ì²´ ë³´ê¸°</option>
                    <option value="exclude">ìˆ¨ê¹€ í•­ëª© ì œì™¸</option>
                    <option value="only">ìˆ¨ê¹€ í•­ëª©ë§Œ</option>
                  </select>
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  ì •ë ¬
                  <select id="tgSort" class="tg-select">
                    <option value="date_desc" selected>ìµœì‹ ìˆœ (ë‚´ë¦¼ì°¨ìˆœ)</option>
                    <option value="date_asc">ê³¼ê±°ìˆœ (ì˜¤ë¦„ì°¨ìˆœ)</option>
                  </select>
                </label>
                <input id="tgQuery" type="text" placeholder="ì œëª©/ë‚´ìš©/íƒœê·¸/ID ê²€ìƒ‰" style="width:240px; padding:8px 14px; border-radius:8px; border:1px solid #cbd5e1; outline:none;" />
              </div>
            </div>
            
            <div style="margin-top:12px; text-align:right;"><span id="tgStatus" class="tag-hint"></span></div>

            <div id="tgCards" style="margin-top:16px; display:flex; flex-direction:column; gap:16px;"></div>
          </div>
        </section>
        
        <section id="tab-monthnote" class="tab-panel">
          <div class="note-grid">
            <div class="card">
              <h2>ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ì„¤ì •</h2>
              <p class="desc">ê¸€ ìƒë‹¨ì— ë“¤ì–´ê°ˆ ìš”ì•½ ì •ë³´(íƒœê·¸)ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. 'important' íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ ìë™ ì¶”ì²œë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
              
              <div class="field">
                <label>ì¶”ì¶œí•  í‚¤ì›Œë“œ ê°œìˆ˜(Top N)</label>
                <input id="mnTopN" type="number" min="3" max="30" value="8" />
              </div>
                            
              <div class="field">
                <label>íƒ€ì´í‹€</label>
                <input id="mnTitle" type="text" placeholder="ì˜ˆ) 1ì›” í•µì‹¬ í‚¤ì›Œë“œ" />
              </div>

              <div class="field">
                <label>í‚¤ì›Œë“œ ì…ë ¥ (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì½¤ë§ˆ ê¸°ì¤€)</label>
                <textarea id="mnTags" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
              </div>

              <div class="field">
                <label>í•˜ë‹¨ ë¶€ê°€ ì„¤ëª… (ì„ íƒ)</label>
                <input id="mnDesc" type="text" placeholder="ì˜ˆ) â€» í•œ ë‹¬ì„ ê´€í†µí•˜ëŠ” ì´ìŠˆ í‚¤ì›Œë“œ" />
              </div>

              <div class="row-actions" style="margin-top: 24px;">
                <button id="mnBuild" class="btn primary">ì½”ë“œ ê°±ì‹ </button>
                <button id="mnAuto" class="btn" style="background:#f0fdf4; border-color:#86efac; color:#166534;">âœ¨ important ê¸°ë°˜ ìë™ ì¶”ì²œ</button>
                <button id="mnCopy" class="btn">HTML ë³µì‚¬</button>
                <button id="mnReset" class="btn danger" style="margin-left:auto;">ì´ˆê¸°í™”</button>
              </div>
            </div>

            <div class="card">
              <h2>ë””ìì¸ ë¯¸ë¦¬ë³´ê¸°</h2>
              <div id="mnPreview" style="padding:20px 0;"></div>

              <h2 style="margin-top:24px;">ìƒì„±ëœ ì†ŒìŠ¤ ì½”ë“œ</h2>
              <textarea id="mnOutput" style="width:100%; height:180px; font-family:monospace; font-size:13px; background:#f8fafc; border:1px solid #cbd5e1; padding:12px; border-radius:8px;" placeholder="ì—¬ê¸°ì— HTML ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤"></textarea>
            </div>
          </div>
        </section>
        
        <section id="tab-yearhead" class="tab-panel">
          <div class="note-grid">
            <div class="card">
              <h2>ì—°ë„ í—¤ë” ë° ë‚´ë¹„ê²Œì´ì…˜ ì„¤ì •</h2>
              <p class="desc">ì—°ë§/ì—°ì´ˆ ê²°ì‚° í¬ìŠ¤íŒ… ì‹œ ë“¤ì–´ê°ˆ ìµœìƒë‹¨ í‘œì§€ì™€ ì—°ë„ ì´ë™ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
              
              <div class="field">
                <label>CSS ìŠ¤íƒ€ì¼ì‹œíŠ¸ ë¦¬ë¹„ì „ ê´€ë¦¬</label>
                <input id="yhCssHrefFull" type="url" readonly value="https://cdn.jsdelivr.net/gh/madonaka/cheese-blog-parts@db6329169e3a7fa5b56ff024d7889fc600cc0d07/timeline/daily-log.css" style="background:#f1f5f9; color:#64748b;" />
                <div style="margin-top:8px;">
                  <input id="yhCssRev" type="text" value="db6329169e3a7fa5b56ff024d7889fc600cc0d07" placeholder="@ ë’¤ ì»¤ë°‹/ë¸Œëœì¹˜ëª… ì…ë ¥" />
                </div>
              </div>
        
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ URL (src)</label>
                <input id="yhImgSrc" type="url" placeholder="https://..." />
              </div>
              <div class="field">
                <label>ëŒ€í‘œ ì´ë¯¸ì§€ Alt ì†ì„±</label>
                <input id="yhImgAlt" type="text" value="2023ë…„ ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬" />
              </div>
        
              <div class="add-grid" style="gap:12px; margin-top:0;">
                <div class="field">
                  <label>ì›ë³¸ í¬ê¸° (W / H)</label>
                  <div style="display:flex; gap:8px;">
                    <input id="yhImgOrigW" type="number" placeholder="Width" />
                    <input id="yhImgOrigH" type="number" placeholder="Height" />
                  </div>
                </div>
                <div class="field">
                  <label>í‘œì‹œ í¬ê¸° (W / H)</label>
                  <div style="display:flex; gap:8px;">
                    <input id="yhImgW" type="number" placeholder="Width" />
                    <input id="yhImgH" type="number" placeholder="Height" />
                  </div>
                </div>
              </div>
        
              <hr style="border:none; border-top:1px dashed #cbd5e1; margin:24px 0;" />
        
              <div class="field">
                <label>ì—°ë„ ë‚´ë¹„ê²Œì´ì…˜ íƒ€ì´í‹€</label>
                <input id="yhYearNavTitle" type="text" value="ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬" />
              </div>
        
              <div class="add-grid" style="gap:12px; margin-top:0;">
                <div class="field">
                  <label>ê°•ì¡°í•  í˜„ì¬ ì—°ë„</label>
                  <input id="yhCurrentYear" type="number" value="2023" />
                </div>
              </div>
        
              <div class="field">
                <label>ì—°ë„ ë§í¬ ëª©ë¡ (í˜•ì‹: YYYY|URL)</label>
                <textarea id="yhYearLinks" class="mono" style="min-height:100px;">2024|https://www.cheesehistory.com/2026/01/2024.html
2025|https://www.cheesehistory.com/2026/01/2025.html
2026|https://www.cheesehistory.com/2026/01/2026.html</textarea>
              </div>
        
              <hr style="border:none; border-top:1px dashed #cbd5e1; margin:24px 0;" />
        
              <div class="field">
                <label>ì—°ë„ ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ íƒ€ì´í‹€</label>
                <input id="yhYearNoteTitle" type="text" value="2023ë…„ ê¸°ë³¸ ì •ë³´" />
              </div>
              <div class="field">
                <label>ì—°ë„ ìš”ì•½ íƒœê·¸</label>
                <textarea id="yhYearNoteTags" style="min-height:100px;">ê³„ë¬˜ë…„(ç™¸å¯å¹´)
ê²€ì€ í† ë¼ í•´
ìµœì €ì‹œê¸‰ 9,620ì›</textarea>
              </div>
              <div class="field">
                <label>ì—°ë„ ìš”ì•½ í•˜ë‹¨ ì„¤ëª…</label>
                <input id="yhYearNoteDesc" type="text" value="â€»ìœ¤ì„ì—´ ëŒ€í†µë ¹ ì„ê¸° 3ë…„ ì°¨(22.5.10~) â€»22ëŒ€ êµ­íšŒì˜ì› ì„ ê±°(24.4.10)" />
              </div>
        
              <div class="row-actions" style="margin-top:24px;">
                <button id="yhBuild" class="btn primary">ì½”ë“œ ìƒì„±</button>
                <button id="yhCopy" class="btn">ì½”ë“œ ë³µì‚¬</button>
                <button id="yhReset" class="btn danger" style="margin-left:auto;">ì´ˆê¸°í™”</button>
              </div>
            </div>
        
            <div class="card">
              <h2>í¬ìŠ¤íŠ¸ì‡ ë¯¸ë¦¬ë³´ê¸°</h2>
              <div id="yhPreview" style="padding:20px 0;"></div>
              <h2 style="margin-top:24px;">ìƒì„±ëœ ì†ŒìŠ¤ ì½”ë“œ</h2>
              <textarea id="yhOutput" style="width:100%; height:400px; font-family:monospace; font-size:13px; background:#f8fafc; border:1px solid #cbd5e1; padding:12px; border-radius:8px;"></textarea>
            </div>
          </div>
        </section>

        <section id="tab-export" class="tab-panel">
          <div class="card" style="border-top: 4px solid var(--primary);">
            <h2>ìµœì¢… HTML ì½”ë“œ ì¶”ì¶œ</h2>
            <p class="desc">ëª¨ë“  ê²€ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆë‹¤ë©´, ìƒë‹¨ í•„í„° ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ìµœì¢… HTML ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

            <div class="actions" style="background:#f8fafc; padding:20px; border-radius:12px; border:1px solid var(--border);">
              <button id="btnGenerate" class="btn primary" style="padding:12px 24px; font-size:1.05rem;">ğŸš€ ë¸”ë¡œê·¸ HTML ìƒì„±</button>
              
              <div style="display:flex; flex-direction:column; gap:8px; margin-left:20px;">
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  <input id="includeMonthNote" type="checkbox" style="width:18px; height:18px; accent-color:var(--primary);" />
                  ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ë¸”ë¡ì„ ë§¨ ìœ„ì— í¬í•¨
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  <input id="includeYearHead" type="checkbox" style="width:18px; height:18px; accent-color:var(--primary);" />
                  ì—°ë„ í‘œì§€/í—¤ë” ë¸”ë¡ì„ ë§¨ ìœ„ì— í¬í•¨
                </label>
                <label style="display:flex; gap:8px; align-items:center; font-weight:700; color:var(--text-main);">
                  <input id="includeServerMonthNotes" type="checkbox" checked style="width:18px; height:18px; accent-color:var(--primary);" />
                  (ê¸°ê°„ ì¶”ì¶œ ì‹œ) ì›”ë³„ í¬ìŠ¤íŠ¸ì‡ ìë™ ì‚½ì…
                </label>
              </div>
              
              <div style="margin-left:auto; display:flex; gap:10px;">
                <button id="btnCopy" class="btn">ê²°ê³¼ ë³µì‚¬</button>
                <button id="btnOpen" class="btn">API URL ì§ì ‘ ì—´ê¸°</button>
                <button id="btnClear" class="btn danger">ì¶œë ¥ ë¹„ìš°ê¸°</button>
              </div>
            </div>

            <textarea
              id="output"
              placeholder="ì—¬ê¸°ì— í‹°ìŠ¤í† ë¦¬/ë¸”ë¡œê·¸ìŠ¤íŒŸì— ë¶™ì—¬ë„£ì„ HTML ì½”ë“œê°€ ì¶œë ¥ë©ë‹ˆë‹¤."
              style="width:100%; height:450px; margin-top:20px; font-family:monospace; font-size:14px; padding:16px; background:#1e293b; color:#e2e8f0; border-radius:12px; border:none; outline:none; resize:vertical;"
            ></textarea>

            <p class="desc" style="margin-top:12px; font-size:0.85rem;">
              ìµœê·¼ API ìš”ì²­ URL: <span id="lastUrl" style="word-break:break-all; color:var(--primary); font-weight:600;"></span>
            </p>
          </div>
        </section>
        
      </main>
    </div>
  </div>


  <div id="manualInputModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ“ ì´ë²¤íŠ¸ ìˆ˜ë™ ì‘ì„± í¼</h2>
      <button class="close-btn" onclick="closeManualModal()">&times;</button>
    </div>
    
    <div class="fg" style="margin-bottom:12px;">
      <label>ì œëª© (title) <span style="color:var(--danger)">*</span></label>
      <input type="text" id="m_title" placeholder="ì´ë²¤íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    
    <div class="modal-grid" style="margin-bottom:12px;">
      <div class="fg"><label>ì‹œì‘ì¼ (date_start) <span style="color:var(--danger)">*</span></label><input type="date" id="m_start" /></div>
      <div class="fg"><label>ì¢…ë£Œì¼ (date_end)</label><input type="date" id="m_end" /></div>
    </div>
    
    <div class="fg" style="margin-bottom:12px;">
      <label>ë‚´ìš© (content_raw)</label>
      <textarea id="m_content" placeholder="ë‚´ìš©ì„ í¸í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”. ì¤„ë°”ê¿ˆì„ í•´ë„ ì•Œì•„ì„œ í•œ ì¤„ë¡œ í•©ì³ì§‘ë‹ˆë‹¤." style="min-height:120px;"></textarea>
    </div>
    
    <div class="modal-grid" style="margin-bottom:12px;">
      <div class="fg"><label>ì •ë‹¹/ì†Œì† (party)</label><input type="text" id="m_party" placeholder="ì˜ˆ: gukhim, minju" /></div>
      <div class="fg"><label>íƒœê·¸ (tags)</label><input type="text" id="m_tags" placeholder="ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„" /></div>
    </div>
    
    <div class="modal-grid" style="margin-bottom:24px;">
      <div class="fg"><label>í•´ì™¸ ì—¬ë¶€ (is_foreign)</label>
        <select id="m_foreign" class="tg-select">
          <option value="FALSE">FALSE (êµ­ë‚´)</option>
          <option value="TRUE">TRUE (í•´ì™¸)</option>
        </select>
      </div>
      <div class="fg"><label>êµ­ê°€ (country)</label><input type="text" id="m_country" placeholder="í•´ì™¸ì¸ ê²½ìš° ì…ë ¥" /></div>
    </div>
    
    <div class="row-actions" style="justify-content:flex-end;">
      <button type="button" class="btn" onclick="closeManualModal()">ì·¨ì†Œ</button>
      <button type="button" class="btn primary" onclick="applyManualModal()">ì…ë ¥ë€ì— ì™ ë„£ê¸°</button>
    </div>
  </div>
</div>
  
  <script src="./admin-common.js"></script>

  <script>
    /* =========================
       ê³µí†µ: escape
    ========================= */
    function escHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/\"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function escAttr(s){ return escHtml(s).replace(/\"/g,"&quot;"); }

    function parseBool_(v){
      if (v === true) return true;
      if (v === false) return false;
      const s = String(v ?? "").trim().toLowerCase();
      return (s === "true" || s === "t" || s === "1" || s === "y" || s === "yes" || s === "on");
    }

    /* =========================
       íƒ­ ë¡œì§ (ìˆ˜ì •: ê¸€ë¡œë²Œ í•„í„° í‘œì‹œ/ìˆ¨ê¹€ ì œì–´ ì¶”ê°€)
    ========================= */
    const tabBtns = Array.from(document.querySelectorAll(".tab-btn"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    function setActiveTab(tabId){
      tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === tabId));
      tabPanels.forEach(p => p.classList.toggle("active", p.id === tabId));
      localStorage.setItem("CHEESE_ACTIVE_TAB", tabId);

      // ì›Œí¬í”Œë¡œìš° ë°˜ì˜: ë°œí–‰ íŒŒì´í”„ë¼ì¸ì—ì„œë§Œ ê¸€ë¡œë²Œ í•„í„° í‘œì‹œ
      const filterWrap = document.getElementById("global-filter-wrap");
      if(filterWrap) {
        if(["tab-tagging", "tab-monthnote", "tab-yearhead", "tab-export"].includes(tabId)) {
          filterWrap.style.display = "block";
        } else {
          filterWrap.style.display = "none";
        }
      }
    }

    tabBtns.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));
    const savedTab = localStorage.getItem("CHEESE_ACTIVE_TAB");
    if (savedTab && document.getElementById(savedTab)) {
        setActiveTab(savedTab);
    } else {
        setActiveTab("tab-add"); // ê¸°ë³¸ í™œì„± íƒ­
    }

    /* ì´í•˜ ê¸°ì¡´ JS ì½”ë“œëŠ” ì™„ë²½íˆ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤. */
    
    /* =========================
       Daily Log Export
    ========================= */
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbyuC0qHyRdDKL2fC5fmRy66l0y1baCLbXuf9pNlPh0rBde_HQMzaqQv5NK06H_n7WFk/exec";

    const el = {
      year: document.getElementById("year"),
      month: document.getElementById("month"),
      day: document.getElementById("day"),
      start: document.getElementById("start"),
      end: document.getElementById("end"),
      ids: document.getElementById("ids"),
      output: document.getElementById("output"),
      lastUrl: document.getElementById("lastUrl"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnCopy: document.getElementById("btnCopy"),
      btnOpen: document.getElementById("btnOpen"),
      btnClear: document.getElementById("btnClear"),
    };

    let lastRequestUrl = "";

    el.btnGenerate.addEventListener("click", generate);
    el.btnCopy.addEventListener("click", copyOutput);
    el.btnOpen.addEventListener("click", openLastUrl);
    el.btnClear.addEventListener("click", () => {
        el.output.value = "";
        el.lastUrl.textContent = "";
        lastRequestUrl = "";
        el.day.value = "";
        el.start.value = "";
        el.end.value = "";
    });

    function buildUrl() {
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("ì›” ì¶”ì¶œì€ ì—°ë„/ì›”ì´ í•„ìš”í•˜ê³ , ì¼ë³„ì€ dayê°€ í•„ìš”í•˜ë©°, ê¸°ê°„ì€ start/endê°€ í•„ìš”í•©ë‹ˆë‹¤. (startë§Œ ë˜ëŠ” endë§Œë„ ê°€ëŠ¥)");
      }

      const params = new URLSearchParams();
      params.set("mode", "exportDailyLog");

      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

      const serverNotesOn = document.getElementById("includeServerMonthNotes")?.checked === true;
      params.set("includeMonthNotes", serverNotesOn ? "1" : "0");
      
      if (ids) params.set("id", ids);

      return `${API_BASE}?${params.toString()}`;
    }

    async function generate() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
    
        el.output.value = "ìƒì„± ì¤‘...";
    
        const res = await fetch(url, {
          method: "GET",
          cache: "no-store",
          redirect: "follow",
          credentials: "omit"
        });
        if (!res.ok) throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP " + res.status + ")");
    
        const text = await res.text();
    
        if (text && /<!doctype html|<html/i.test(text)) {
          throw new Error("APIê°€ HTML í™”ë©´ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (ì„œë²„ doGet(e) ë¶„ê¸°/ë°°í¬ í™•ì¸ í•„ìš”)");
        }
    
        const fixed = text.replace(/&lt;br\s*\/?&gt;/gi, "<br>");
        let outHtml = fixed || "";
    
        const isRangeExport =
          !String(el.day.value || "").trim() &&
          (String(el.start.value || "").trim() || String(el.end.value || "").trim());
    
        const serverNotesOn =
          document.getElementById("includeServerMonthNotes")?.checked === true;
    
        const includeMN =
          document.getElementById("includeMonthNote")?.checked === true;
    
        if (includeMN && !(isRangeExport && serverNotesOn)) {
          const mnOutputEl = document.getElementById("mnOutput");
          let mnCode = String(mnOutputEl?.value || "").trim();
    
          if (!mnCode) {
            try { buildMonthNote(); } catch (_) {}
            mnCode = String(mnOutputEl?.value || "").trim();
          }
    
          if (mnCode) {
            outHtml = mnCode + "\n\n" + outHtml;
          }
        }
    
        const includeYH =
          document.getElementById("includeYearHead")?.checked === true;
    
        if (includeYH) {
          const yhOutputEl = document.getElementById("yhOutput");
          let yhCode = String(yhOutputEl?.value || "").trim();
    
          if (!yhCode) {
            try { buildYearHead_(); } catch (_) {}
            yhCode = String(yhOutputEl?.value || "").trim();
          }
    
          if (yhCode) {
            outHtml = yhCode + "\n\n" + outHtml;
          }
        }
    
        el.output.value = outHtml;
      } catch (e) {
        el.output.value = "";
        const msg = (e && e.message ? e.message : String(e));
        alert(
          "HTML ìƒì„± ì‹¤íŒ¨: " + msg +
          "\n\n(í™•ì¸) 'ìš”ì²­ URL ì—´ê¸°'ë¡œ ìƒˆ íƒ­ì—ì„œ ê²°ê³¼ê°€ í…ìŠ¤íŠ¸ë¡œ ëœ¨ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
        );
      }
    }


    async function copyOutput() {
      const val = (el.output.value || "").trim();
      if (!val) {
        alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      try {
        await navigator.clipboard.writeText(el.output.value);
        alert("ë³µì‚¬ ì™„ë£Œ");
      } catch (e) {
        el.output.focus();
        el.output.select();
        document.execCommand("copy");
        alert("ë³µì‚¬ ì™„ë£Œ");
      }
    }

    function openLastUrl() {
      try {
        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;
        window.open(url, "_blank", "noopener,noreferrer");
      } catch (e) {
        alert("URL ìƒì„± ì‹¤íŒ¨: " + (e && e.message ? e.message : String(e)));
      }
    }

    /* =========================
       ì›” ìš”ì•½ í¬ìŠ¤íŠ¸ì‡ ìƒì„±ê¸°
    ========================= */
    const mn = {
      title: document.getElementById("mnTitle"),
      tags: document.getElementById("mnTags"),
      desc: document.getElementById("mnDesc"),
      preview: document.getElementById("mnPreview"),
      output: document.getElementById("mnOutput"),
      build: document.getElementById("mnBuild"),
      copy: document.getElementById("mnCopy"),
      reset: document.getElementById("mnReset"),
      topN: document.getElementById("mnTopN"),
      auto: document.getElementById("mnAuto"),
    };
    
    const MN_KEY = "CHEESE_MONTH_NOTE_FORM";
    
    function loadMonthNote(){
      try{
        const saved = JSON.parse(localStorage.getItem(MN_KEY) || "{}");
        if (saved.title != null) mn.title.value = saved.title;
        if (saved.tags  != null) mn.tags.value  = saved.tags;
        if (saved.desc  != null) mn.desc.value  = saved.desc;
        if (saved.topN  != null && mn.topN) mn.topN.value = saved.topN;
      }catch(_){ }
    }
    
    function saveMonthNote(){
      localStorage.setItem(MN_KEY, JSON.stringify({
        title: mn.title.value || "",
        tags:  mn.tags.value || "",
        desc:  mn.desc.value || "",
        topN:  mn.topN ? (mn.topN.value || "8") : "8"
      }));
    }
    
    ["input","change"].forEach(evt=>{
      mn.title.addEventListener(evt, saveMonthNote);
      mn.tags.addEventListener(evt, saveMonthNote);
      mn.desc.addEventListener(evt, saveMonthNote);
      if (mn.topN) mn.topN.addEventListener(evt, saveMonthNote);
    });
    
    loadMonthNote();
    if ((mn.title.value || mn.tags.value || mn.desc.value).trim().length){
      buildMonthNote();
    }
    
    function parseTags(text){
      const cap = Math.min(Math.max(Number(mn.topN?.value || 8), 3), 20);
      return String(text || "")
        .split(/\n|,/g)
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, cap);
    }
    
    function buildMonthNote(){
      const title = (mn.title.value || "").trim() || "ì›” í•µì‹¬ í‚¤ì›Œë“œ";
      const tags = parseTags(mn.tags.value);
      const desc = (mn.desc.value || "").trim();
    
      const tagHtml = tags.length
        ? tags.map(t => `    <span class="mtag">${escHtml(t)}</span>`).join("\n")
        : `    <span class="mtag">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>`;
    
      const descHtml = desc
        ? `\n\n  <div class="month-note-desc">\n    ${escHtml(desc)}\n  </div>`
        : "";
    
      const y = String(el.year?.value || "").trim();
      const m = String(el.month?.value || "").trim();
    
      const canUseYm = !!(y && m && !el.day?.value && !el.start?.value && !el.end?.value);
      const summaryTitle = canUseYm ? `${y}ë…„ ${Number(m)}ì›”` : "";
      const summaryHtml = summaryTitle
        ? `  <summary><h2>${escHtml(summaryTitle)}</h2></summary>\n`
        : "";
    
      const html =
    `${summaryHtml}  <div class="month-note">
        <div class="month-note-title">${escHtml(title)}</div>
        <div class="month-note-tags">
    ${tagHtml}
        </div>${descHtml ? descHtml.replace(/\n/g, "\n  ") : ""}
      </div>`;
    
      mn.preview.innerHTML =
        `<div class="month-note">
          <div class="month-note-title">${escHtml(title)}</div>
          <div class="month-note-tags">
            ${tags.map(t => `<span class="mtag">${escHtml(t)}</span>`).join("")}
          </div>
          ${desc ? `<div class="month-note-desc">${escHtml(desc)}</div>` : ""}
        </div>`;
    
      mn.output.value = html;
    }
    
    mn.build.addEventListener("click", (e) => {
      e.preventDefault();
      buildMonthNote();
      saveMonthNote();
    });
    
    mn.copy.addEventListener("click", async (e) => {
      e.preventDefault();
      const val = (mn.output.value || "").trim();
      if (!val){ buildMonthNote(); }
      try{
        await navigator.clipboard.writeText(mn.output.value);
        alert("ë³µì‚¬ ì™„ë£Œ");
      }catch(_){
        mn.output.focus();
        mn.output.select();
        document.execCommand("copy");
        alert("ë³µì‚¬ ì™„ë£Œ");
      }
    });
    
    mn.reset.addEventListener("click", (e) => {
      e.preventDefault();
      mn.title.value = "";
      mn.tags.value = "";
      mn.desc.value = "";
      if (mn.topN) mn.topN.value = "8";
      mn.preview.innerHTML = "";
      mn.output.value = "";
      localStorage.removeItem(MN_KEY);
    });

    if ((mn.title.value || mn.tags.value || mn.desc.value).trim().length){
      buildMonthNote();
    }

    /* =========================
       TAGGING (íƒœê·¸ ê²€ìˆ˜ + ì´ë²¤íŠ¸ í¸ì§‘)
    ========================= */
    const TG_ADMIN_KEY = "";
    const BASE_UI = ["ë³´ìˆ˜","ì§„ë³´","êµ­ì œ","ì´ìŠˆ"];
    const BASE_DB_PREFIX = "ì¤‘ìš”-";
    const GROUP_RE = /^E-\d{6}-\d{2}$/;

    const tg = {
      load: document.getElementById("tgLoad"),
      onlyEmpty: document.getElementById("tgOnlyEmpty"),
      sort: document.getElementById("tgSort"),
      query: document.getElementById("tgQuery"),
      hiddenView: document.getElementById("tgHiddenView"),
      status: document.getElementById("tgStatus"),
      cards: document.getElementById("tgCards"),
    };
    
    tg._allItems = [];

    const SAVE_DEBOUNCE_MS = 450;
    const saveTimers = new Map();

    tg.load.addEventListener("click", loadTagCards);
    tg.hiddenView.addEventListener("change", applyTgView_);
    if (tg.sort)  tg.sort.addEventListener("change", applyTgView_);
    if (tg.query) tg.query.addEventListener("input", debounce_(applyTgView_, 120));
    tg.onlyEmpty.addEventListener("change", applyTgView_);
        
    function buildListUrl(){
      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const start = String(el.start.value || "").trim();
      const end   = String(el.end.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      if (!day && !start && !end && (!year || !month)) {
        throw new Error("ê²€ìˆ˜í•  ì›”/ì¼/ê¸°ê°„ ì •ë³´ë¥¼ ê¸€ë¡œë²Œ í•„í„°ì—ì„œ ì§€ì •í•´ ì£¼ì„¸ìš”.");
      }

      const params = new URLSearchParams();
      params.set("mode", "listEvents");
      params.set("limit", "300");

      if (day) {
        params.set("day", day);
      } else if (start || end) {
        if (start) params.set("start", start);
        if (end) params.set("end", end);
      } else {
        params.set("year", year);
        params.set("month", month);
      }
    
      const view = tg.hiddenView ? tg.hiddenView.value : "all";
      params.set("includeHidden", view === "exclude" ? "false" : "true");
        
      if (ids) params.set("id", ids);
      if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);

      return `${API_BASE}?${params.toString()}`;
    }

    /* =========================
       ì—°ë„ í—¤ë”/í‘œì§€ ìƒì„±ê¸°
    ========================= */
    const YH_DEFAULT_CSS_FULL = "https://cdn.jsdelivr.net/gh/madonaka/cheese-blog-parts@db6329169e3a7fa5b56ff024d7889fc600cc0d07/timeline/daily-log.css";
    const YH_DEFAULT_CSS_REV = "db6329169e3a7fa5b56ff024d7889fc600cc0d07";

    const yh = {
      cssHrefFull: document.getElementById("yhCssHrefFull"),
      cssRev: document.getElementById("yhCssRev"),
      imgSrc: document.getElementById("yhImgSrc"),
      imgAlt: document.getElementById("yhImgAlt"),
      imgOrigW: document.getElementById("yhImgOrigW"),
      imgOrigH: document.getElementById("yhImgOrigH"),
      imgW: document.getElementById("yhImgW"),
      imgH: document.getElementById("yhImgH"),
      yearNavTitle: document.getElementById("yhYearNavTitle"),
      currentYear: document.getElementById("yhCurrentYear"),
      yearLinks: document.getElementById("yhYearLinks"),
      yearNoteTitle: document.getElementById("yhYearNoteTitle"),
      yearNoteTags: document.getElementById("yhYearNoteTags"),
      yearNoteDesc: document.getElementById("yhYearNoteDesc"),
      preview: document.getElementById("yhPreview"),
      output: document.getElementById("yhOutput"),
      build: document.getElementById("yhBuild"),
      copy: document.getElementById("yhCopy"),
      reset: document.getElementById("yhReset"),
    };
    
    const YH_KEY = "CHEESE_YEAR_HEAD_FORM";
    
    function parseLines_(text){
      return String(text || "").replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
    }
    function parseTagsSmart_(text){
      return String(text || "").split(/\n|,/g).map(s=>s.trim()).filter(Boolean).slice(0, 30);
    }
    function parseYearLinks_(text){
      return parseLines_(text).map(line=>{
        const i = line.indexOf("|");
        if (i < 0) return { year: line.trim(), url: "" };
        return { year: line.slice(0,i).trim(), url: line.slice(i+1).trim() };
      }).filter(x=>x.year);
    }
    
    function loadYearHead_(){
      try{
        const saved = JSON.parse(localStorage.getItem(YH_KEY) || "{}");
        if (saved.cssHrefFull != null && yh.cssHrefFull) yh.cssHrefFull.value = saved.cssHrefFull;
        if (saved.cssRev != null && yh.cssRev) yh.cssRev.value = saved.cssRev;
        if (saved.cssHref != null && yh.cssHrefFull && yh.cssRev) {
          yh.cssHrefFull.value = saved.cssHref;
          const m = String(saved.cssHref).match(/@([^\/]+)\//);
          if (m && m[1]) yh.cssRev.value = m[1];
        }
        if (saved.imgSrc != null) yh.imgSrc.value = saved.imgSrc;
        if (saved.imgAlt != null) yh.imgAlt.value = saved.imgAlt;
        if (saved.imgOrigW != null) yh.imgOrigW.value = saved.imgOrigW;
        if (saved.imgOrigH != null) yh.imgOrigH.value = saved.imgOrigH;
        if (saved.imgW != null) yh.imgW.value = saved.imgW;
        if (saved.imgH != null) yh.imgH.value = saved.imgH;
        if (saved.yearNavTitle != null) yh.yearNavTitle.value = saved.yearNavTitle;
        if (saved.currentYear != null) yh.currentYear.value = saved.currentYear;
        if (saved.yearLinks != null) yh.yearLinks.value = saved.yearLinks;
        if (saved.yearNoteTitle != null) yh.yearNoteTitle.value = saved.yearNoteTitle;
        if (saved.yearNoteTags != null) yh.yearNoteTags.value = saved.yearNoteTags;
        if (saved.yearNoteDesc != null) yh.yearNoteDesc.value = saved.yearNoteDesc;
      }catch(_){}
    }
    function saveYearHead_(){
      localStorage.setItem(YH_KEY, JSON.stringify({
        cssHrefFull: yh.cssHrefFull?.value || "", cssRev: yh.cssRev?.value || "",
        imgSrc: yh.imgSrc?.value || "", imgAlt: yh.imgAlt?.value || "",
        imgOrigW: yh.imgOrigW?.value || "", imgOrigH: yh.imgOrigH?.value || "",
        imgW: yh.imgW?.value || "", imgH: yh.imgH?.value || "",
        yearNavTitle: yh.yearNavTitle?.value || "", currentYear: yh.currentYear?.value || "",
        yearLinks: yh.yearLinks?.value || "", yearNoteTitle: yh.yearNoteTitle?.value || "",
        yearNoteTags: yh.yearNoteTags?.value || "", yearNoteDesc: yh.yearNoteDesc?.value || "",
      }));
    }
    
    ["input","change"].forEach(evt=>{
      Object.values(yh).forEach(elm=>{
        if (elm && (elm.tagName === "INPUT" || elm.tagName === "TEXTAREA")){
          elm.addEventListener(evt, saveYearHead_);
        }
      });
    });
    
    function buildYearHead_(){
      const full0 = String(yh.cssHrefFull?.value || "").trim();
      const rev = String(yh.cssRev?.value || "").trim();
      
      let cssHref = "";
      if (full0) cssHref = full0.replace(/@([^\/]+)\//, (m, oldRev) => `@${rev || oldRev}/`);
      
      const imgSrc = String(yh.imgSrc?.value || "").trim();
      const imgAlt = String(yh.imgAlt?.value || "").trim() || "ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬";
      const ow = String(yh.imgOrigW?.value || "").trim();
      const oh = String(yh.imgOrigH?.value || "").trim();
      const w  = String(yh.imgW?.value || "").trim();
      const h  = String(yh.imgH?.value || "").trim();
      const navTitle = String(yh.yearNavTitle?.value || "").trim() || "ì£¼ìš” ì‚¬ê±´, ì´ìŠˆ, ë‰´ìŠ¤ ì›”ë³„ ì´ì •ë¦¬";
      const curYear = String(yh.currentYear?.value || "").trim();
      const links = parseYearLinks_(yh.yearLinks?.value || "");
      const yearCells = [];
    
      if (curYear) yearCells.push(`<span class="cheese-year-cell current" aria-current="page">${escHtml(curYear)}</span>`);
      links.forEach(x=>{
        const y = String(x.year||"").trim();
        const u = String(x.url||"").trim();
        if (!y || (curYear && y === curYear)) return;
        if (!u) yearCells.push(`<span class="cheese-year-cell">${escHtml(y)}</span>`);
        else yearCells.push(`<a class="cheese-year-cell" href="${escAttr(u)}">${escHtml(y)}</a>`);
      });
    
      const noteTitle = String(yh.yearNoteTitle?.value || "").trim() || (curYear ? `${curYear}ë…„ ê¸°ë³¸ ì •ë³´` : "ì—°ë„ ê¸°ë³¸ ì •ë³´");
      const noteTags = parseTagsSmart_(yh.yearNoteTags?.value || "");
      const noteDesc = String(yh.yearNoteDesc?.value || "").trim();
    
      const tagsHtml = noteTags.length ? noteTags.map(t => `      <span class="mtag">${escHtml(t)}</span>`).join("\n") : `      <span class="mtag">íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>`;
      const cssBlock = cssHref ? `<link rel="stylesheet" href="${escAttr(cssHref)}" />\n\n` : "";
      const imgBlock = imgSrc ? `\n<div class="cheese-img-wrapper">\n  <div class="cheese-img-inner">\n    <div class="separator" style="clear: both; text-align: center;">\n      <a href="${escAttr(imgSrc)}" style="margin-left: 1em; margin-right: 1em;">\n        <img\n          alt="${escAttr(imgAlt)}"\n          border="0"\n          ${oh ? `data-original-height="${escAttr(oh)}"\n          ` : ""}${ow ? `data-original-width="${escAttr(ow)}"\n          ` : ""}${h ? `height="${escAttr(h)}"\n          ` : ""}src="${escAttr(imgSrc)}"\n          title="${escAttr(imgAlt)}"\n          ${w ? `width="${escAttr(w)}"\n          ` : ""}/>\n      </a>\n    </div>\n    <div class="cheese-img-overlay"></div>\n  </div>\n</div>\n\n` : "";
      const navBlock = `\n<details class="cheese-year-nav" open="">\n  <summary>\n    <div class="cheese-year-head">\n      <p class="cheese-year-title">${escHtml(navTitle)}</p>\n    </div>\n    <span class="cheese-year-toggle">í¼ì¹˜ê¸° / ì ‘ê¸°</span>\n  </summary>\n\n  <div class="cheese-year-body" aria-label="ì—°ë„ ì´ë™ ë§í¬">\n    <div class="cheese-year-grid">\n      ${yearCells.join("\n      ")}\n    </div>\n  </div>\n</details>\n<br /><br />\n\n\n<div class="month-note year-note">\n  <div class="month-note-title">${escHtml(noteTitle)}</div>\n  <div class="month-note-tags">\n${tagsHtml}\n  </div>\n${noteDesc ? `  <div class="month-note-desc">\n    ${escHtml(noteDesc)}\n  </div>\n` : ""}</div>`;
    
      yh.preview.innerHTML = `
        <div class="month-note year-note">
          <div class="month-note-title">${escHtml(noteTitle)}</div>
          <div class="month-note-tags">${noteTags.map(t=>`<span class="mtag">${escHtml(t)}</span>`).join("")}</div>
          ${noteDesc ? `<div class="month-note-desc">${escHtml(noteDesc)}</div>` : ""}
        </div>
        <div class="desc" style="margin-top:10px;">â€» ì‹¤ì œ ì¶œë ¥ì—ëŠ” ì—°ë„ ë„¤ë¹„/ì´ë¯¸ì§€/CSS ë§í¬ê°€ í•¨ê»˜ í¬í•¨ë©ë‹ˆë‹¤.</div>
      `;
      yh.output.value = cssBlock + imgBlock + navBlock;
    }
    
    loadYearHead_();
    if ((yh.imgSrc?.value || yh.yearLinks?.value || yh.yearNoteTitle?.value || yh.yearNoteTags?.value || "").trim().length){
      try{ buildYearHead_(); }catch(_){}
    }
    
    if (yh.build) yh.build.addEventListener("click", (e)=>{ e.preventDefault(); buildYearHead_(); saveYearHead_(); });
    if (yh.copy) yh.copy.addEventListener("click", async (e)=>{
      e.preventDefault(); if (!String(yh.output.value || "").trim()) buildYearHead_();
      try{ await navigator.clipboard.writeText(yh.output.value); alert("ë³µì‚¬ ì™„ë£Œ"); }
      catch(_){ yh.output.focus(); yh.output.select(); document.execCommand("copy"); alert("ë³µì‚¬ ì™„ë£Œ"); }
    });
    if (yh.reset) yh.reset.addEventListener("click", (e)=>{
      e.preventDefault();
      if (yh.cssHrefFull) yh.cssHrefFull.value = YH_DEFAULT_CSS_FULL;
      if (yh.cssRev) yh.cssRev.value = YH_DEFAULT_CSS_REV;
      const keepIds = new Set(["yhCssHrefFull", "yhCssRev"]);
      Object.values(yh).forEach(elm=>{
        if (!elm) return;
        if ((elm.tagName === "INPUT" || elm.tagName === "TEXTAREA") && !keepIds.has(elm.id)) elm.value = "";
      });
      yh.preview.innerHTML = ""; yh.output.value = "";
      localStorage.removeItem(YH_KEY);
      try { saveYearHead_(); } catch(_){}
    });

    function syncFiltersToDateStart_(dateStart){
      const ds = String(dateStart || "").trim();
      if (!ds) return false;
      if (/^\d{4}-\d{2}-\d{2}$/.test(ds)){
        if (el.day) el.day.value = ds; if (el.start) el.start.value = ""; if (el.end) el.end.value = "";
        if (el.year) el.year.value = ""; if (el.month) el.month.value = "";
        return true;
      }
      if (/^\d{4}-\d{2}$/.test(ds)){
        const y = ds.slice(0,4); const m = String(Number(ds.slice(5,7)));
        if (el.year) el.year.value = y; if (el.month) el.month.value = m;
        if (el.day) el.day.value = ""; if (el.start) el.start.value = ""; if (el.end) el.end.value = "";
        return true;
      }
      if (/^\d{4}$/.test(ds)){
        if (el.day) el.day.value = ""; if (el.year) el.year.value = ""; if (el.month) el.month.value = "";
        if (el.start) el.start.value = ds + "-01-01"; if (el.end) el.end.value = ds + "-12-31";
        return true;
      }
      return false;
    }

    function debounce_(fn, ms){
      let t = null;
      return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
    }
    
    function applyTgView_(){
      const allItems = Array.isArray(tg._allItems) ? tg._allItems : [];
      let items = allItems.slice();
    
      if (tg.onlyEmpty && tg.onlyEmpty.checked) items = items.filter(it => !String(it.tags || "").trim());
    
      const view = tg.hiddenView ? tg.hiddenView.value : "all";
      if (view === "exclude") items = items.filter(it => it.hidden !== true);
      if (view === "only")    items = items.filter(it => it.hidden === true);
    
      const q = String(tg.query?.value || "").trim().toLowerCase();
      if (q){
        const tokens = q.split(/\s+/g).filter(Boolean);
        items = items.filter(it=>{
          const hay = [it.id, it.title, it.content_raw, it.tags, it.date_start, it.date_end, it.party, it.country].map(v=>String(v||"")).join(" ").toLowerCase();
          return tokens.every(tok => hay.includes(tok));
        });
      }
    
      const sort = String(tg.sort?.value || "date_desc");
      const toTime = (d)=> { const t = Date.parse(String(d||"").trim()); return Number.isFinite(t) ? t : 0; };
      items.sort((a,b)=>{
        const ta = toTime(a.date_start); const tb = toTime(b.date_start);
        if (ta !== tb) return (sort === "date_asc") ? (ta - tb) : (tb - ta);
        return String(a.id||"").localeCompare(String(b.id||""), "ko");
      });
    
      tg.cards.innerHTML = items.map(it => renderEventCardHtml(it)).join("");
      items.forEach(it => bindEventCard(it));
    
      const hiddenCnt = allItems.filter(it => it.hidden === true).length;
      tg.status.textContent = `${items.length}ê±´ í‘œì‹œ / ì „ì²´ ${allItems.length}ê±´ (ìˆ¨ê¹€ ${hiddenCnt}ê±´)`;
    }
    
    async function loadTagCards(){
      try{
        tg.status.textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        tg.cards.innerHTML = "";
    
        const url = buildListUrl();
        const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
        if (!res.ok) throw new Error("ëª©ë¡ API ì‹¤íŒ¨ (HTTP " + res.status + ")");
    
        const data = await safeReadJson_(res);
        if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "UNKNOWN_ERROR");
    
        const allItems = Array.isArray(data.items) ? data.items : [];
        tg._allItems = allItems.slice();
        applyTgView_();
      }catch(e){
        tg.status.textContent = "";
        alert("íƒœê·¸ ê²€ìˆ˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (e && e.message ? e.message : String(e)));
      }
    }

    function parseTagsToArray(s){ return String(s || "").split(",").map(x=>String(x).trim()).filter(Boolean); }
    function toDbBase(ui){ return `${BASE_DB_PREFIX}${ui}`; }
    function hasDbBase(arr, ui){ return arr.includes(toDbBase(ui)); }
    function addDbBase(arr, ui){ const t = toDbBase(ui); return arr.includes(t) ? arr : arr.concat([t]); }
    function removeDbBase(arr, ui){ const t = toDbBase(ui); return arr.filter(x => x !== t); }
    function getGroupTag(arr){ for (const t of arr){ const s = String(t||"").trim(); if (GROUP_RE.test(s)) return s; } return ""; }
    function removeGroupTags(arr){ return arr.filter(t => !GROUP_RE.test(String(t||"").trim())); }
    function getTypedTagValues(arr, type){
      const out = [];
      for (const t of (arr || [])){
        const s = String(t||"").trim();
        if (s === type) { out.push(""); continue; }
        if (s.startsWith(type + "-")) out.push(s.slice(type.length + 1));
      }
      return out;
    }
    function getTypedTagValue(arr, type){
      const vals = getTypedTagValues(arr, type);
      if (!vals.length) return null;
      const first = vals.find(v => String(v).trim().length > 0);
      return (first != null) ? first : "";
    }
    function hasTypedTag(arr, type){ return getTypedTagValues(arr, type).length > 0; }
    function removeTyped(arr, type){ return arr.filter(t=>{ const s = String(t||"").trim(); return !(s === type || s.startsWith(type + "-")); }); }
    function upsertTyped(arr, type, value){
      const kept = removeTyped(arr, type); const v = String(value || "").trim();
      return kept.concat([ v ? `${type}-${v}` : type ]);
    }
    function normalizeTagsArray(arr){
      const seen = new Set(); const uniq = [];
      arr.forEach(t=>{ const s = String(t||"").trim(); if (!s || seen.has(s)) return; seen.add(s); uniq.push(s); });
      const baseOrder = BASE_UI.map(ui => toDbBase(ui));
      const typedOrder = ["economy","important","mnforce","mourning","mourning"];
      const group = [], base = [], typed = [], other = [];
      uniq.forEach(t=>{
        const s = String(t||"").trim();
        if (GROUP_RE.test(s)) { group.push(s); return; }
        if (baseOrder.includes(s)) { base.push(s); return; }
        const m = /^([a-z]+)(?:-.*)?$/i.exec(s); const tp = m ? String(m[1]).toLowerCase() : "";
        if (typedOrder.includes(tp)) { typed.push(s); return; }
        other.push(s);
      });
      const groupOne = group.length ? [group[0]] : [];
      const baseSorted = []; baseOrder.forEach(x=>{ if (base.includes(x)) baseSorted.push(x); });
      const typedSorted = []; const picked = new Set();
      typedOrder.forEach(tp=>{
        if (tp === "important"){
          const allImp = typed.filter(t=>{ const m = /^([a-z]+)(?:-.*)?$/i.exec(String(t||"").trim()); return (m ? String(m[1]).toLowerCase() : "") === "important"; });
          allImp.forEach(t => typedSorted.push(t)); return;
        }
        const found = typed.find(t=>{ const m = /^([a-z]+)(?:-.*)?$/i.exec(t); return (m ? String(m[1]).toLowerCase() : "") === tp; });
        if (found && !picked.has(tp)) { picked.add(tp); typedSorted.push(found); }
      });
      return groupOne.concat(baseSorted).concat(typedSorted).concat(other);
    }
    function showNote(root, type, on){ const box = root.querySelector(`.tag-note[data-note="${type}"]`); if (box) box.style.display = on ? "flex" : "none"; }
    function focusNote(root, type){ const input = root.querySelector(`.tag-note[data-note="${type}"] input`); if (input) input.focus(); }
    function clearNote(root, type){ const input = root.querySelector(`.tag-note[data-note="${type}"] input`); if (input) input.value = ""; }
    function buildPreview(text){
      const s = String(text || "").replace(/\s+/g," ").trim();
      if (!s) return "<span style='color:var(--text-muted)'>ë‚´ìš© ì—†ìŒ</span>";
      return escHtml(s.length > 220 ? (s.slice(0,220) + "â€¦") : s);
    }
    function isHiddenItem_(it, tagsArr){
      const v = (it && (it.hidden ?? it.is_hidden ?? it.hide));
      if (parseBool_(v)) return true;
      if (Array.isArray(tagsArr) && tagsArr.includes("__HIDE")) return true;
      return false;
    }

    function renderEventCardHtml(it){
      const id = escAttr(it.id); const title = escHtml(it.title || ""); const date = escHtml(it.date_start || ""); const party = escHtml(it.party || "");
      const tags = parseTagsToArray(it.tags || ""); const hidden = isHiddenItem_(it, tags);
      const hasBosu = hasDbBase(tags, "ë³´ìˆ˜"); const hasJinbo = hasDbBase(tags, "ì§„ë³´"); const hasIntl = hasDbBase(tags, "êµ­ì œ"); const hasIssue = hasDbBase(tags, "ì´ìŠˆ");
      const ecoVal = getTypedTagValue(tags, "economy"); const mouVal = getTypedTagValue(tags, "mourning");
      const impVals = getTypedTagValues(tags, "important"); const impVal = impVals.filter(v => String(v).trim()).join(", ");
      const forceVals = getTypedTagValues(tags, "mnforce"); const forceOn = forceVals.length > 0;
      const ecoOn = ecoVal != null; const mouOn = mouVal != null; const impOn = impVals.length > 0;
      // ğŸ’¡ ê·¸ë£¹í•‘ IDê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ "E-"ë¥¼ ì±„ì›Œë‘¡ë‹ˆë‹¤.
      const groupTag = getGroupTag(tags) || "E-";
      const contentPreview = buildPreview(it.content_raw || "");

return `
      <div class="ev-card${hidden ? " is-hidden" : ""}${impOn ? " is-important" : ""}" data-id="${id}" data-hidden="${hidden ? "1" : "0"}">
        
        <div class="ev-head">
          <div style="flex:1;">
            <div class="ev-title">${title}</div>
            <div class="ev-meta">${date}${party ? " Â· " + party : ""} Â· ${id}</div>
          </div>
          <div class="ev-actions" style="display:flex; gap:6px; flex-shrink:0;">
            <button type="button" class="btn-mini" data-action="edit-toggle">ë‚´ìš© í¸ì§‘</button>
            <label class="hide-toggle">
              <input type="checkbox" data-action="hide-toggle" ${hidden ? "checked" : ""} style="width:16px;height:16px;" /> ìˆ¨ê¹€
            </label>
            <span id="pill_${id}" class="save-pill" style="margin-left:4px;">ëŒ€ê¸°</span>
          </div>
        </div>

        <div class="ev-body">${contentPreview}</div>

        <div class="modal-overlay ev-editor" data-role="editor">
          <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px dashed var(--border);">
              <div style="font-weight: 800; font-size: 1.15rem; color: var(--text-main);">ğŸ“ ì´ë²¤íŠ¸ ë‚´ìš© í¸ì§‘</div>
              <button type="button" class="close-btn" data-action="edit-cancel">&times;</button>
            </div>
            
            <div class="field" style="margin-bottom: 16px;">
              <label>ì œëª© (title) <span style="color:var(--danger)">*</span></label>
              <input data-role="edit-title" type="text" value="${escAttr(it.title || "")}" />
            </div>

            <div class="ev-edit-grid" style="margin-bottom: 16px; gap: 16px;">
              <div class="field"><label>ì‹œì‘ì¼ (date_start)</label><input data-role="edit-start" type="date" value="${escAttr(it.date_start || "")}" /></div>
              <div class="field"><label>ì¢…ë£Œì¼ (date_end)</label><input data-role="edit-end" type="date" value="${escAttr(it.date_end || "")}" /></div>
            </div>

            <div class="field" style="margin-bottom: 16px;">
              <label>ì´ë¯¸ì§€ ë§í¬ (image_url)</label>
              <input data-role="edit-image-url" type="url" placeholder="https://..." value="${escAttr(it.image_url || "")}" />
            </div>

            <div class="field" style="margin-bottom: 16px;">
              <label>ìŠ¤í¬ë¦°ìƒ· ë¶™ì—¬ë„£ê¸° (í´ë¦½ë³´ë“œ)</label>
              <div class="paste-zone" data-role="paste-image" contenteditable="true" spellcheck="false" tabindex="0">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê³  Ctrl+V (ë˜ëŠ” Cmd+V)</div>
              <div class="paste-preview" data-role="paste-preview"></div>
            </div>

            <div class="field" style="margin-bottom: 24px;">
              <label>ë³¸ë¬¸ ë‚´ìš© (content_raw)</label>
              <textarea data-role="edit-content" style="min-height:120px; font-size:0.95rem; line-height:1.6; padding:12px;">${escHtml(it.content_raw || "")}</textarea>
            </div>

            <div class="row-actions" style="justify-content: flex-end; padding-top: 16px; border-top: 1px dashed var(--border); margin-top: 0;">
              <button type="button" class="btn danger" data-action="edit-recreate" style="margin-right: auto; background: var(--danger-bg); color: var(--danger); border-color: #fca5a5;">ìƒˆ ID ë°œê¸‰</button>
              <button type="button" class="btn" data-action="edit-cancel">ì·¨ì†Œ</button>
              <button type="button" class="btn primary" data-action="edit-save" style="padding: 10px 24px;">ì €ì¥ ì™„ë£Œ</button>
            </div>
          </div>
        </div>
        <div class="ev-tags">
          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ë³´ìˆ˜" ${hasBosu ? "checked":""}/><span>ë³´ìˆ˜</span></label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ì§„ë³´" ${hasJinbo ? "checked":""}/><span>ì§„ë³´</span></label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="êµ­ì œ" ${hasIntl ? "checked":""}/><span>êµ­ì œ</span></label>
            <label class="tag-item"><input type="checkbox" data-tg="base" data-key="ì´ìŠˆ" ${hasIssue ? "checked":""}/><span>ì´ìŠˆ</span></label>
          </div>
          <div class="tag-group">
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="economy" ${ecoOn ? "checked":""}/><span>ê²½ì œ</span></label>
            <label class="tag-item is-important-tag"><input type="checkbox" data-tg="typed" data-key="important" ${impOn ? "checked":""}/><span>ì¤‘ìš”(ğŸŒŸ)</span></label>
            <label class="tag-item"><input type="checkbox" data-tg="typed" data-key="mourning" ${mouOn ? "checked":""}/><span>ì• ë„</span></label>
          </div>
          <div class="tag-group" style="margin-left:auto;">
            <div class="group-editor" data-tg="group" style="display:flex; gap:8px;">
              <input data-role="group-input" type="text" placeholder="ì˜ˆ: E-202601-01" value="${escAttr(groupTag)}" style="width:140px;"/>
              <button type="button" class="btn-mini primary" data-action="group-apply">ë¬¶ê¸°</button>
            </div>
          </div>
        </div>

        <div class="tag-note" data-note="economy" style="${ecoOn ? "display:flex;" : ""}">
          <b>ê²½ì œ ë¼ë²¨</b><input id="note_e_${id}" type="text" placeholder="ì˜ˆ) í™˜ìœ¨/ê¸ˆë¦¬/ìœ ê°€" value="${escAttr(ecoVal || "")}" />
        </div>
        <div class="tag-note" data-note="important" style="${impOn ? "display:flex;" : ""}">
          <b>í•µì‹¬ í‚¤ì›Œë“œ</b><input id="note_i_${id}" type="text" placeholder="ì¤‘ìš” ì´ìœ  í•œ ì¤„ ë˜ëŠ” í‚¤ì›Œë“œ ì…ë ¥" value="${escAttr(impVal || "")}" />
          <label style="display:flex; gap:6px; align-items:center; font-weight:800; font-size:0.85rem; color:#b45309; white-space:nowrap;"><input type="checkbox" data-role="mnforce" ${forceOn ? "checked" : ""}/>ì›” ìš”ì•½ ê°•ì œ</label>
        </div>
        <div class="tag-note" data-note="mourning" style="${mouOn ? "display:flex;" : ""}">
          <b>ì• ë„ í¬ì¸íŠ¸</b><input id="note_m_${id}" type="text" placeholder="ì–´ë–¤ ì‚¬ê±´ì— ëŒ€í•œ ì• ë„ì¸ì§€ ì‘ì„±" value="${escAttr(mouVal || "")}" />
        </div>

        <textarea data-role="tags-raw" style="display:none;">${escHtml(tags.join(","))}</textarea>
      </div>
      `;
    }
      
    function scheduleSave(id, tagsArr, pillEl){
      if (saveTimers.has(id)) clearTimeout(saveTimers.get(id));
      pillEl.className = "save-pill saving"; pillEl.textContent = "ì €ì¥ ì¤‘...";
      const timer = setTimeout(async ()=>{
        try{
          const ok = await postPatchTags(id, tagsArr.join(","));
          if (!ok) throw new Error("SAVE_FAILED");
          pillEl.className = "save-pill saved"; pillEl.textContent = "ì €ì¥ ì™„ë£Œ";
        }catch(e){
          pillEl.className = "save-pill err"; pillEl.textContent = "ì €ì¥ ì˜¤ë¥˜";
        }
      }, SAVE_DEBOUNCE_MS);
      saveTimers.set(id, timer);
    }

    async function postPatchTags(id, tags){
      const params = new URLSearchParams(); params.set("mode","patchTags");
      if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);
      const body = new URLSearchParams(); body.set('id', String(id||'')); body.set('tags', String(tags||''));
      try{
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:"POST", body, cache:"no-store", credentials:"omit" });
        if (res.ok){ const data = await safeReadJson_(res); if (data && data.ok === true) return true; }
      }catch(_){ }
      return false;
    }

    async function postPatchEvent(id, patch){
      const params = new URLSearchParams(); params.set('mode','patchEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const body = new URLSearchParams(); body.set('id', String(id||''));
      if (patch && patch.date_start != null) body.set('date_start', String(patch.date_start||''));
      if (patch && patch.date_end != null)   body.set('date_end', String(patch.date_end||''));
      if (patch && patch.title != null)      body.set('title', String(patch.title||''));
      if (patch && patch.content_raw != null)body.set('content_raw', String(patch.content_raw||''));
      if (patch && patch.image_url != null)  body.set('image_url', String(patch.image_url||''));
      if (patch && patch.hidden != null)     body.set('hidden', patch.hidden);
    
      try{
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_){}
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data) return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
        return { ok:true, data };
      }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e) }; }
    }

    async function postReissueEvent(id, patch, force){
      const params = new URLSearchParams(); params.set('mode','reissueEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      const body = new URLSearchParams(); body.set('id', String(id||''));
      if (patch && patch.date_start != null) body.set('date_start', String(patch.date_start||''));
      if (patch && patch.date_end != null)   body.set('date_end', String(patch.date_end||''));
      if (patch && patch.title != null)      body.set('title', String(patch.title||''));
      if (patch && patch.content_raw != null)body.set('content_raw', String(patch.content_raw||''));
      if (patch && patch.image_url != null)  body.set('image_url', String(patch.image_url||''));
      if (force === true) body.set('force', 'true');
    
      try{
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_){}
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data)  return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
        return { ok:true, data };
      }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e) }; }
    }

    async function postUploadImage(id, title, mime, base64){
      const params = new URLSearchParams(); params.set('mode','uploadImage');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      try{
        const body = new URLSearchParams(); body.set('id', String(id||'')); body.set('title', String(title||'')); body.set('mime', String(mime||'')); body.set('data', String(base64||''));
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_){ }
        if (!res.ok) return { ok:false, error: `HTTP ${res.status}`, raw:text, status:res.status };
        if (!data) return { ok:false, error: 'JSON_PARSE_FAILED', raw:text, status:res.status };
        if (data.ok !== true) return { ok:false, error: data.error || 'UPLOAD_FAILED', raw:text, status:res.status, data };
        return { ok:true, data, raw:text, status:res.status };
      }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e), status:0 }; }
    }

    function safePipe_(s){ return String(s ?? "").replaceAll("|", "ï½œ"); }
    
    async function postAppendEventLine(line){
      const params = new URLSearchParams(); params.set('mode','appendEvent');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      try{
        const body = new URLSearchParams(); body.set('line', String(line || ''));
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_){ }
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data) return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
        return { ok:true, id: String(data.id || '') };
      }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e) }; }
    }

    async function postPatchHidden(id, hidden){
      const params = new URLSearchParams(); params.set('mode','patchHidden');
      if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
      try{
        const body = new URLSearchParams(); body.set('id', String(id||'')); body.set('hidden', hidden ? 'true' : 'false');
        const res = await fetch(`${API_BASE}?${params.toString()}`, { method:'POST', body, cache:'no-store', credentials:'omit' });
        const text = await res.text();
        let data = null; try { data = JSON.parse(text); } catch(_){}
        if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
        if (!data)    return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
        if (data.ok !== true) return { ok:false, error: String(data.error || JSON.stringify(data)).slice(0,300) };
        return { ok:true, data };
      }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e) }; }
    }
 
    function bindEventCard(it){
      const root = tg.cards.querySelector(`.ev-card[data-id="${CSS.escape(it.id)}"]`);
      if (!root) return;

      const pill = root.querySelector(`#pill_${CSS.escape(it.id)}`);
      const editor = root.querySelector('[data-role="editor"]');
      const btnToggle = root.querySelector('[data-action="edit-toggle"]');
      const btnSave = root.querySelector('[data-action="edit-save"]');
      const btnCancel = root.querySelector('[data-action="edit-cancel"]');
      const inStart = root.querySelector('[data-role="edit-start"]');
      const inEnd = root.querySelector('[data-role="edit-end"]');
      const inTitle = root.querySelector('[data-role="edit-title"]');
      const inContent = root.querySelector('[data-role="edit-content"]');
      const inImageUrl = root.querySelector('[data-role="edit-image-url"]');
      const pasteZone = root.querySelector('[data-role="paste-image"]');
      const pastePreview = root.querySelector('[data-role="paste-preview"]');
      const btnRecreate = root.querySelector('[data-action="edit-recreate"]');
      const uiTitle = root.querySelector('.ev-title');
      const uiMeta = root.querySelector('.ev-meta');
      const uiBody = root.querySelector('.ev-body');
      const hideChk = root.querySelector('[data-action="hide-toggle"]');
      
      const applyHiddenUi = (on) => {
        root.classList.toggle('is-hidden', !!on);
        root.dataset.hidden = on ? '1' : '0';
      };
      let originalHidden = !!(hideChk && hideChk.checked);
      applyHiddenUi(originalHidden);

      const impChk = root.querySelector('input[type="checkbox"][data-tg="typed"][data-key="important"]');
      const impLabel = impChk ? impChk.closest('label') : null;
      const applyImportantUi = (on) => {
        root.classList.toggle('is-important', !!on);
        if (impLabel) impLabel.classList.toggle('is-important-tag', !!on);
      };
      applyImportantUi(!!(impChk && impChk.checked));
    
      const setPill = (state, text) => {
        if (!pill) return;
        pill.className = `save-pill ${state}`; pill.textContent = text;
      };

      const driveIdFromUrl_ = (u) => {
        const s = String(u || '');
        let m = s.match(/[?&]id=([a-zA-Z0-9_-]{10,})/); if (m && m[1]) return m[1];
        m = s.match(/\/d\/([a-zA-Z0-9_-]{10,})(?:[/?]|$)/); if (m && m[1]) return m[1];
        return '';
      };
      const toDriveThumbUrl_ = (u) => {
        const id = driveIdFromUrl_(u);
        return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w200` : '';
      };

      const renderImagePreview = (rawUrl) => {
        if (!pastePreview) return;
        const url = String(rawUrl || "").trim();
        if (!url) { pastePreview.style.display = "none"; pastePreview.innerHTML = ""; return; }
        const thumb = toDriveThumbUrl_(url) || url;
        pastePreview.style.display = "flex";
        pastePreview.innerHTML = `<a href="${escAttr(url)}" target="_blank" rel="noopener" style="font-weight:700; color:var(--primary);">ì´ë¯¸ì§€ ë§í¬ ì—´ê¸°</a><img src="${escAttr(thumb)}" alt="" loading="lazy" />`;
      };
      
      const handleImagePaste = async (e)=>{
        try{
          if (e && e.__dlImgHandled) return;
          const items = (e.clipboardData && e.clipboardData.items) ? Array.from(e.clipboardData.items) : [];
          const imgItem = items.find(x => x && x.type && x.type.indexOf('image/') === 0);
          if (!imgItem) return;

          e.__dlImgHandled = true; e.preventDefault(); e.stopPropagation();
          setPill('saving','ì—…ë¡œë“œ ì¤‘...');

          const blob = imgItem.getAsFile();
          const mime = blob && blob.type ? blob.type : 'image/png';
          const b64 = await readBlobAsBase64_(blob);
          const curTitle = String(inTitle?.value || it.title || '').trim();
          
          const up = await postUploadImage(it.id, curTitle, mime, b64);
          if (!up || up.ok !== true) throw new Error(String(up ? up.error : 'UPLOAD_FAILED'));

          const url = String(up.data && up.data.url ? up.data.url : '').trim();
          if (!url) throw new Error('URL_EMPTY');
          if (inImageUrl) inImageUrl.value = url;
          renderImagePreview(url);
          
          const saved = await postPatchEvent(it.id, { image_url: url });
          if (!saved.ok) throw new Error(saved.error || 'PATCH_FAILED');
          
          original.image_url = url; it.image_url = url;
          setPill('saved','ì—…ë¡œë“œ ì„±ê³µ');
        }catch(err){
          setPill('err','ì—…ë¡œë“œ ì‹¤íŒ¨'); alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err && err.message ? err.message : String(err)));
        }
      };

      if (pasteZone) pasteZone.addEventListener('paste', handleImagePaste);
      if (inImageUrl) inImageUrl.addEventListener('paste', handleImagePaste);
      root.addEventListener('paste', handleImagePaste, true);
      if (inImageUrl) { inImageUrl.addEventListener('input', () => renderImagePreview(inImageUrl.value)); inImageUrl.addEventListener('change', () => renderImagePreview(inImageUrl.value)); }
      
      if (hideChk){
          hideChk.addEventListener('change', async ()=>{
          const on = !!hideChk.checked;
          applyHiddenUi(on); setPill('saving','ì €ì¥ ì¤‘...');
          const r = await postPatchHidden(it.id, on);
          if (r.ok){ setPill('saved','ì €ì¥ë¨'); originalHidden = on; }
          else{ setPill('err','ì˜¤ë¥˜'); alert('ìˆ¨ê¹€ ì²˜ë¦¬ ì‹¤íŒ¨: ' + r.error); hideChk.checked = originalHidden; applyHiddenUi(originalHidden); }
        });
      }

      const snap = () => ({
        date_start: String(inStart?.value || '').trim(), date_end: String(inEnd?.value || '').trim(),
        title: String(inTitle?.value || '').trim(), content_raw: String(inContent?.value || ''),
        image_url: String(inImageUrl?.value || '').trim(), hidden: !!(hideChk && hideChk.checked)
      });
      let original = snap();
      renderImagePreview(original.image_url);

      const openEditor = (on) => {
        if (!editor) return;
        editor.classList.toggle('open', !!on);
        if (on) { original = snap(); renderImagePreview(original.image_url); }
      };
      
    if (btnToggle) btnToggle.addEventListener('click', ()=> openEditor(!(editor && editor.classList.contains('open'))));
      
      // ëª¨ë‹¬ ë‹«ê¸°(ì·¨ì†Œ) ê³µí†µ í•¨ìˆ˜
      const closeEditorHandler = () => {
        if (inStart) inStart.value = original.date_start || ''; if (inEnd) inEnd.value = original.date_end || '';
        if (inTitle) inTitle.value = original.title || ''; if (inContent) inContent.value = original.content_raw || '';
        if (inImageUrl) inImageUrl.value = original.image_url || '';
        if (hideChk){ hideChk.checked = !!original.hidden; applyHiddenUi(!!original.hidden); }
        renderImagePreview(original.image_url); openEditor(false);
      };

      // í•˜ë‹¨ ì·¨ì†Œ ë²„íŠ¼ê³¼ ìƒë‹¨ X ë²„íŠ¼ ëª¨ë‘ì— ì´ë²¤íŠ¸ ì—°ê²°
      root.querySelectorAll('[data-action="edit-cancel"]').forEach(btn => {
        btn.addEventListener('click', closeEditorHandler);
      });

      // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­ ì‹œ ë‹«ê¸°
      if (editor) {
        editor.addEventListener('click', (e) => {
          if (e.target === editor) {
            closeEditorHandler();
          }
        });
      }

      if (btnRecreate){
        btnRecreate.addEventListener('click', async ()=>{
          try{
            const cur = snap();
            if (!cur.title){ alert('ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            if (!String(cur.date_start||'').trim() && String(cur.date_end||'').trim()){ alert('ì¢…ë£Œì¼ì„ ì“°ë ¤ë©´ ì‹œì‘ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
            setPill('saving','ì¬ë°œê¸‰ ì¤‘...');
            const r = await postReissueEvent(it.id, { date_start: cur.date_start, date_end: cur.date_end, title: cur.title, content_raw: cur.content_raw, image_url: cur.image_url }, true);
            if (!r.ok) throw new Error(r.error || 'reissueEvent ì‹¤íŒ¨');
            const newId = String(r.data?.new_id || ''); const oldId = String(r.data?.old_id || String(it.id||''));
            setPill('saved', (newId && newId !== oldId) ? `ì¬ë°œê¸‰ë¨ â†’ ${newId}` : 'ì €ì¥ë¨');
            syncFiltersToDateStart_(cur.date_start);
            if (newId) root.dataset.id = newId;
            if (typeof loadTagCards === 'function') await loadTagCards();
          }catch(e){ setPill('err','ì˜¤ë¥˜'); alert('ì¬ë°œê¸‰ ì‹¤íŒ¨: ' + (e && e.message ? e.message : String(e))); }
        });
      }
      
      if (btnSave){
        btnSave.addEventListener('click', async ()=>{
          try{
            const cur = snap();
            if (!cur.title){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
            if (!cur.date_start && cur.date_end){ alert('ì¢…ë£Œì¼ì„ ì“°ë ¤ë©´ ì‹œì‘ì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
            setPill('saving','ì €ì¥ ì¤‘...');
            const ok = await postPatchEvent(it.id, { date_start: cur.date_start, date_end: cur.date_end, title: cur.title, content_raw: cur.content_raw, image_url: cur.image_url, hidden: cur.hidden ? 'TRUE' : 'FALSE' });
            if (!ok) throw new Error('SAVE_FAILED');
            if (uiTitle) uiTitle.textContent = cur.title;
            const party = String(it.party || '').trim(); const meta = `${cur.date_start || ''}${party ? ' Â· ' + party : ''} Â· ${it.id}`;
            if (uiMeta) uiMeta.textContent = meta;
            if (uiBody) uiBody.innerHTML = buildPreview(cur.content_raw || '');
            applyHiddenUi(!!cur.hidden); originalHidden = !!cur.hidden;
            original = cur; openEditor(false); setPill('saved','ì €ì¥ë¨');
          }catch(e){ setPill('err','ì˜¤ë¥˜'); alert('ì €ì¥ ì‹¤íŒ¨: ' + (e && e.message ? e.message : String(e))); }
        });
      }

      const getTags = () => parseTagsToArray(root.querySelector('[data-role="tags-raw"]').value);
      const setTags = (arr) => { const norm = normalizeTagsArray(arr); root.querySelector('[data-role="tags-raw"]').value = norm.join(','); scheduleSave(it.id, norm, pill); };
      const forceChk = root.querySelector('input[type="checkbox"][data-role="mnforce"]');
      
      function parseImportantInputToLabels_(){
        const input = root.querySelector(`.tag-note[data-note="important"] input`);
        return String(input?.value || "").split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
      }
      function removeMnForce_(tags){ return removeTyped(tags, "mnforce"); }
      function applyMnForceFromImportant_(on){
        let tags = getTags(); tags = removeMnForce_(tags);
        if (on){
          const labels = parseImportantInputToLabels_();
          if (!labels.length){ alert("ì›”ìš”ì•½ ê°•ì œë¥¼ ì¼œë ¤ë©´ important í‚¤ì›Œë“œë¥¼ 1ê°œ ì´ìƒ ì ì–´ì£¼ì„¸ìš”."); if (forceChk) forceChk.checked = false; setTags(tags); return; }
          tags = tags.concat(labels.map(v => `mnforce-${v}`));
        }
        setTags(tags);
      }
      if (forceChk) forceChk.addEventListener("change", ()=>applyMnForceFromImportant_(!!forceChk.checked));

      root.querySelectorAll('input[type="checkbox"][data-tg]').forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const kind = chk.dataset.tg; const key = chk.dataset.key; const checked = chk.checked;
          let tags = getTags();
          if (kind === 'base'){
            const BASE_UI = ["ë³´ìˆ˜","ì§„ë³´","êµ­ì œ","ì´ìŠˆ"];
            
            if (checked) {
              // ğŸ’¡ í•œ ê°œë§Œ ì²´í¬ë˜ë„ë¡ ë‚˜ë¨¸ì§€ ëª¨ë‘ ê°•ì œ í•´ì œ
              BASE_UI.forEach(ui => { if (ui !== key) tags = removeDbBase(tags, ui); });
              tags = addDbBase(tags, key);
              
              // í™”ë©´ìƒì˜ ë‹¤ë¥¸ ì¹©(ì²´í¬ë°•ìŠ¤)ë“¤ë„ ì‹œê°ì ìœ¼ë¡œ ì²´í¬ í•´ì œ
              root.querySelectorAll('input[type="checkbox"][data-tg="base"]').forEach(c => {
                if (c !== chk) c.checked = false;
              });
            } else {
              // ì²´í¬ë¥¼ í•´ì œí•œ ê²½ìš° í•´ë‹¹ íƒœê·¸ë§Œ ì œê±°
              tags = removeDbBase(tags, key);
            }
            
            setTags(tags); 
            return;
          }
          if (kind === 'typed'){
            if (checked){
              if (key === "important") { if (!hasTypedTag(tags, "important")) tags = tags.concat(["important"]); }
              else tags = upsertTyped(tags, key, getTypedTagValue(tags, key) || '');
              showNote(root, key, true); focusNote(root, key);
            }else{ tags = removeTyped(tags, key); showNote(root, key, false); clearNote(root, key); }
            if (key === "important") applyImportantUi(checked);
            setTags(tags); return;
          }
        });
      });

      ['economy','important','mourning'].forEach(tp=>{
        const input = root.querySelector(`.tag-note[data-note="${tp}"] input`);
        if (!input) return;
        let t = null;
        input.addEventListener('input', ()=>{
          clearTimeout(t);
          t = setTimeout(()=>{
            let tags = getTags(); const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
            if (!on) return;
            if (tp === "important"){
              const vals = String(input.value || "").split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
              tags = removeTyped(tags, "important");
              tags = !vals.length ? tags.concat(["important"]) : tags.concat(vals.map(v => `important-${v}`));
            } else tags = upsertTyped(tags, tp, input.value || '');
            if (tp === "important"){
              const forceChk2 = root.querySelector('input[type="checkbox"][data-role="mnforce"]');
              if (forceChk2 && forceChk2.checked){
                tags = removeTyped(tags, "mnforce"); const labels2 = String(input.value || "").split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
                if (labels2.length) tags = tags.concat(labels2.map(v => `mnforce-${v}`)); else forceChk2.checked = false;
              }
            }
            setTags(tags);
          }, 450);
        });
        input.addEventListener('blur', ()=>{
          let tags = getTags(); const on = root.querySelector(`input[type="checkbox"][data-tg="typed"][data-key="${tp}"]`)?.checked;
          if (!on) return;
          if (tp === "important"){
            const vals = String(input.value || "").split(/,|\n/g).map(s=>s.trim()).filter(Boolean);
            tags = removeTyped(tags, "important"); tags = !vals.length ? tags.concat(["important"]) : tags.concat(vals.map(v => `important-${v}`));
          } else tags = upsertTyped(tags, tp, input.value || '');
          setTags(tags);
        });
      });

      const groupBox = root.querySelector('.group-editor[data-tg="group"]');
      if (groupBox){
        const input = groupBox.querySelector('input[data-role="group-input"]');
        const btnApply = groupBox.querySelector('[data-action="group-apply"]');
        const applyGroup = (raw) => {
          const v = String(raw || '').trim();
          if (v && !GROUP_RE.test(v)){ alert('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nE-xxxxxx-xx (ì˜ˆ: E-202601-01)'); return; }
          let tags = getTags(); tags = removeGroupTags(tags); if (v) tags = tags.concat([v]); setTags(tags); if (input) input.value = v;
        };
        if (btnApply) btnApply.addEventListener('click', ()=> applyGroup(input ? input.value : ''));
        if (input) input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); applyGroup(input.value); } });
      }
    }

    async function safeReadJson_(res){
      const text = await res.text();
      if (text && /<!doctype html|<html/i.test(text)) throw new Error("APIê°€ JSON ëŒ€ì‹  HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (ì›¹ì•± ë°°í¬ í™•ì¸ í•„ìš”)");
      try{ return JSON.parse(text); }catch(_){ throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨"); }
    }

  /* =========================
     ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€ ë¡œì§
  ========================= */
  function autoInsertBrInContentRaw_(input){
    let s = String(input ?? "");
    const endsWithBrOrNl_ = (txt) => {
      const t = String(txt).replace(/[ \t]+$/g, "");
      if (!t) return true;
      if (/\n$/.test(t) || /<br\s*\/?>$/i.test(t)) return true;
      return false;
    };
    s = s.replace(/(\S)([ \t]*)â€¢/g, (m, prevChar, _spaces, offset, whole) => {
      const before = whole.slice(0, offset + 1);
      if (endsWithBrOrNl_(before)) return prevChar + _spaces + "â€¢";
      return prevChar + "<br>" + "â€¢";
    });
    return s;
  }

  const add = { line: document.getElementById('addLine'), save: document.getElementById('addSave'), clear: document.getElementById('addClear'), status: document.getElementById('addStatus'), preview: document.getElementById('addPreview') };
  const ADD_COLS = ["id","date_type","date_start","date_end","title","content_raw","party","is_foreign","country","tags","created_at"];
  
  function splitNonEmptyLines_(text){ return String(text || "").replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean); }
  function parsePipeLineStrict_(line){
    const raw = String(line || '').replace(/\r/g,'').trim(); if (!raw) return null;
    const parts = raw.split('|');
    if (parts.length < 11) { while(parts.length < 11) parts.push(''); }
    else if (parts.length > 11) throw new Error('ì—´ ê°œìˆ˜ ì´ˆê³¼(11ì¹¸ í•„ìš”).');
    const obj = {}; for (let i=0;i<11;i++) obj[ADD_COLS[i]] = (parts[i] ?? '').toString();
    return obj;
  }
  function validateAddObj_(obj){
    const ds = String(obj?.date_start || '').trim(); const de = String(obj?.date_end || '').trim(); const title = String(obj?.title || '').trim();
    if (!ds && de) return 'date_endë¥¼ ì“°ë ¤ë©´ date_startê°€ í•„ìš”í•©ë‹ˆë‹¤.'; if (!ds) return 'date_startëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'; if (!title) return 'titleì€ í•„ìˆ˜ì…ë‹ˆë‹¤.';
    return '';
  }
  
  function renderAddPreviewFromText_(){
    const lines = splitNonEmptyLines_(add.line.value);
    if (!lines.length){ add.preview.textContent = '(ì…ë ¥ ë°ì´í„° ì—†ìŒ)'; add.status.textContent = ''; return; }
    if (lines.length === 1){
      try{
        const obj = parsePipeLineStrict_(lines[0]); obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
        const err = validateAddObj_(obj); if (err) throw new Error(err);
        add.preview.textContent = ADD_COLS.map(k => `${k}: ${obj[k] ?? ''}`).join('\n'); add.status.textContent = '';
      }catch(e){ add.preview.textContent = 'ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + (e?.message ? e.message : String(e)); }
      return;
    }
    const out = []; out.push(`ì´ ${lines.length}í–‰ ë°ì´í„° ê²€ì¦ ì¤‘...`); out.push('---');
    let okCount = 0;
    lines.forEach((line, idx) => {
      try{
        const obj = parsePipeLineStrict_(line); obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
        const err = validateAddObj_(obj); if (err) throw new Error(err);
        okCount++; const range = (obj.date_end && String(obj.date_end).trim()) ? ` ~ ${obj.date_end}` : '';
        out.push(`[${idx+1}] âœ… ${obj.date_start}${range} | ${obj.title} | tags=${obj.tags || ''}`);
      }catch(e){ out.push(`[${idx+1}] âŒ ${e?.message ? e.message : String(e)}`); }
    });
    out.push('---'); out.push(`í˜•ì‹ ê²€ì¦ í†µê³¼: ${okCount} / ${lines.length}`); add.preview.textContent = out.join('\n');
  }

  add.line.addEventListener('input', renderAddPreviewFromText_);
  add.clear.addEventListener('click', ()=>{ add.line.value = ''; add.preview.textContent = '(ì…ë ¥ ë°ì´í„° ì—†ìŒ)'; add.status.textContent = ''; });
  
  async function postAppendEvents_(lines){
    const params = new URLSearchParams(); params.set('mode','appendEvents');
    if (TG_ADMIN_KEY) params.set('key', TG_ADMIN_KEY);
    try{
      const res = await fetch(`${API_BASE}?${params.toString()}`, { method: 'POST', body: JSON.stringify({ lines }), cache: 'no-store', credentials: 'omit' });
      const text = await res.text(); let data = null; try { data = JSON.parse(text); } catch(_){ }
      if (!res.ok) return { ok:false, error:`HTTP ${res.status}: ${text.slice(0,300)}` };
      if (!data) return { ok:false, error:`JSON ì•„ë‹˜: ${text.slice(0,300)}` };
      return { ok:true, data };
    }catch(e){ return { ok:false, error: e && e.message ? e.message : String(e) }; }
  }

  function replaceIdInLine_(line, newId){
    const parts = String(line || '').split('|'); while(parts.length < 11) parts.push('');
    parts[0] = String(newId || '').trim(); return parts.slice(0,11).join('|');
  }

  add.save.addEventListener('click', async ()=>{
    try{
      const lines = splitNonEmptyLines_(add.line.value);
      const lines2 = lines.map(line=>{
        const obj = parsePipeLineStrict_(line); obj.content_raw = autoInsertBrInContentRaw_(obj.content_raw);
        ADD_COLS.forEach(k => { obj[k] = safePipe_(obj[k]); });
        return ADD_COLS.map(k => String(obj[k] ?? "")).join("|");
      });
      if (!lines.length) { alert('ì…ë ¥ ë¼ì¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }

      const BATCH = 200; const allResults = [];
      add.status.textContent = `ì¼ê´„ ì €ì¥ ì²˜ë¦¬ ì¤‘... (0/${lines.length})`;

      for (let s=0; s<lines.length; s+=BATCH){
        const chunk = lines2.slice(s, s+BATCH); add.status.textContent = `ì €ì¥ ì¤‘... (${Math.min(s+BATCH, lines.length)}/${lines.length})`;
        const r = await postAppendEvents_(chunk);
        if (!r.ok) throw new Error(r.error || 'BULK_SAVE_FAILED');
        const results = Array.isArray(r.data && r.data.results) ? r.data.results : [];
        if (!results.length) throw new Error('ì„œë²„ ì‘ë‹µ ëˆ„ë½');
        allResults.push(...results);
        if (!results.every(x => x && x.ok === true)) break;
      }

      const newLines = lines2.map((line, i)=>{
        const rr = allResults[i]; if (rr && rr.ok === true && rr.id) return replaceIdInLine_(line, rr.id); return line;
      });
      add.line.value = newLines.join('\n');
      const okCount = allResults.filter(x => x && x.ok === true).length;
      const failIdx = []; allResults.forEach((x, i)=>{ if (!x || x.ok !== true) failIdx.push(i+1); });
      for (let i=allResults.length; i<lines.length; i++){ failIdx.push(i+1); }

      renderAddPreviewFromText_();
      if (failIdx.length){ add.status.textContent = `ë¶€ë¶„ ì‹¤íŒ¨: ì„±ê³µ ${okCount}/${lines.length}`; alert(`ì¼ë¶€ í•­ëª© ì €ì¥ ì‹¤íŒ¨. (í–‰: ${failIdx.join(', ')})`); return; }
      add.status.textContent = `âœ… ì¼ê´„ ì €ì¥ ì™„ë£Œ (${okCount}/${lines.length})`;
    }catch(e){
      add.status.textContent = ''; renderAddPreviewFromText_(); alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (e && e.message ? e.message : String(e)));
    }
  });

  renderAddPreviewFromText_();

  function readBlobAsBase64_(blob){
    return new Promise((resolve, reject) => {
      try{
        const fr = new FileReader();
        fr.onload = () => { const s = String(fr.result || ""); const i = s.indexOf(","); resolve(i >= 0 ? s.slice(i + 1) : s); };
        fr.onerror = () => reject(fr.error || new Error("FileReader failed"));
        fr.readAsDataURL(blob);
      }catch(e){ reject(e); }
    });
  }

  function extractImportantLabelsFromTags_(tagsStr){
    const tags = String(tagsStr || "").split(",").map(s => String(s).trim()).filter(Boolean);
    const out = [];
    tags.forEach(t => { const m = /^important(?:-(.+))?$/i.exec(t); if (!m) return; const label = String(m[1] || "").trim(); if (label) out.push(label); });
    return out;
  }

  function extractMnForceLabelsFromTags_(tagsStr){
    const tags = String(tagsStr || "").split(",").map(s => String(s).trim()).filter(Boolean);
    const out = [];
    tags.forEach(t => { const m = /^mnforce-(.+)$/i.exec(t); if (!m) return; const label = String(m[1] || "").trim(); if (label) out.push(label); });
    return out;
  }
    
  function buildListUrlForSuggest_(){
    const year  = String(el.year.value || "").trim(); const month = String(el.month.value || "").trim();
    const day   = String(el.day.value || "").trim(); const start = String(el.start.value || "").trim(); const end   = String(el.end.value || "").trim();
    if (!day && !start && !end && (!year || !month)) throw new Error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë²”ìœ„ë¥¼ ê¸€ë¡œë²Œ í•„í„°ì—ì„œ ì§€ì •í•´ ì£¼ì„¸ìš”.");
    const params = new URLSearchParams(); params.set("mode", "listEvents"); params.set("limit", "800");
    if (day) params.set("day", day); else if (start || end) { if (start) params.set("start", start); if (end) params.set("end", end); } else { params.set("year", year); params.set("month", month); }
    params.set("includeHidden", "false"); if (TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);
    return `${API_BASE}?${params.toString()}`;
  }

  async function autoSuggestMonthNote_(){
    const topN = Math.min(Math.max(Number(mn.topN?.value || 8), 3), 20);
    const url = buildListUrlForSuggest_();
    const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
    if (!res.ok) throw new Error("API ì‹¤íŒ¨ (HTTP " + res.status + ")");
    const data = await safeReadJson_(res);
    if (!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "UNKNOWN_ERROR");
    const items = Array.isArray(data.items) ? data.items : [];
    
    const forced = []; const forcedSet = new Set();
    items.forEach(it=>{
      extractMnForceLabelsFromTags_(it.tags || "").forEach(lb=>{ if (!forcedSet.has(lb)){ forcedSet.add(lb); forced.push(lb); } });
    });
    
    const freq = new Map();
    items.forEach(it => { extractImportantLabelsFromTags_(it.tags || "").forEach(lb => freq.set(lb, (freq.get(lb) || 0) + 1)); });
    
    const ranked = Array.from(freq.entries()).sort((a,b) => (b[1] - a[1]) || String(a[0]).localeCompare(String(b[0]), "ko")).map(x=>x[0]).filter(lb => !forcedSet.has(lb));
    const picked = forced.slice(0, topN).concat(ranked.slice(0, Math.max(0, topN - forced.length)));

    const y = String(el.year.value || "").trim(); const m = String(el.month.value || "").trim();
    if (y && m && !el.day.value && !el.start.value && !el.end.value) mn.title.value = `${y}ë…„ ${m}ì›” í•µì‹¬ í‚¤ì›Œë“œ`; else mn.title.value = `ë²”ìœ„ í•µì‹¬ í‚¤ì›Œë“œ`;
    mn.tags.value = picked.join("\n"); mn.desc.value = `â€» ì¤‘ìš”ë„ ê¸°ë°˜ ì¶”ì²œ ì™„ë£Œ`;
    buildMonthNote(); saveMonthNote();
  }

  if (mn.auto){
    mn.auto.addEventListener("click", async (e)=>{
      e.preventDefault();
      try{ await autoSuggestMonthNote_(); alert("ì¶”ì²œ í‚¤ì›Œë“œê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤."); }
      catch(err){ alert("ìë™ ì¶”ì²œ ì‹¤íŒ¨: " + (err && err.message ? err.message : String(err))); }
    });
  }
    
  /* =========================================
     AI ë¶„ì„ ê´€ë ¨ ë¡œì§ (ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° + API í˜¸ì¶œ)
     ========================================= */
  let currentAiBase64 = null;
  const aiTextEl = document.getElementById('ai_input_text');
  if(aiTextEl){
    aiTextEl.addEventListener('paste', function(e){
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          e.preventDefault();
          const blob = items[i].getAsFile(); const reader = new FileReader();
          reader.onload = function(event){
            currentAiBase64 = event.target.result;
            document.getElementById('ai_image_preview').src = currentAiBase64;
            document.getElementById('ai_image_preview_area').style.display = 'block';
          };
          reader.readAsDataURL(blob);
        }
      }
    });
  }

  function clearAiImage(){
    currentAiBase64 = null;
    document.getElementById('ai_image_preview').src = "";
    document.getElementById('ai_image_preview_area').style.display = 'none';
  }

  async function runAiAnalysis() {
    const textVal = document.getElementById('ai_input_text').value.trim();
    if (!textVal && !currentAiBase64) { alert("ë¶„ì„í•  í…ìŠ¤íŠ¸ë‚˜ ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

    const btn = document.getElementById('btn_ai_analyze');
    const originalBtnText = btn.innerText;
    btn.disabled = true; btn.innerText = "â³ AI ë¶„ì„ ì¤‘... (ìµœëŒ€ 20ì´ˆ ì†Œìš”)";

    try {
      const payload = { mode: "analyzeArticle", text: textVal, image: currentAiBase64 };
      const params = new URLSearchParams(); params.set("mode", "analyzeArticle");
      if (typeof TG_ADMIN_KEY !== 'undefined' && TG_ADMIN_KEY) params.set("key", TG_ADMIN_KEY);
      
      const res = await fetch(`${API_BASE}?${params.toString()}`, { method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
      const json = await res.json();

      if (json.ok) {
        const targetInput = document.getElementById('addLine');
        if(targetInput) {
          targetInput.value = json.result;
          alert("âœ… ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê²°ê³¼ ë¼ì¸ì„ í™•ì¸í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
          targetInput.focus(); targetInput.dispatchEvent(new Event('input'));
        }
      } else throw new Error(json.error || json.detail || "Unknown Error");
    } catch (err) { alert("AI ë¶„ì„ ì‹¤íŒ¨: " + err.message); console.error(err); } 
    finally { btn.disabled = false; btn.innerText = originalBtnText; }
  }
    
  /* =========================================
     ìˆ˜ë™ ì´ë²¤íŠ¸ ë“±ë¡ ëª¨ë‹¬ (Modal) ì œì–´ ë¡œì§
  ========================================= */
  const manualInputModal = document.getElementById('manualInputModal');

  // 1. ëª¨ë‹¬ ì—´ê¸° (HTMLì˜ onclick="openManualModal()" ëŒ€ì‘)
  function openManualModal() {
    if (manualInputModal) {
      manualInputModal.classList.add('open');
    }
  }

  // 2. ëª¨ë‹¬ ë‹«ê¸° (HTMLì˜ onclick="closeManualModal()" ëŒ€ì‘)
  function closeManualModal() {
    if (manualInputModal) {
      manualInputModal.classList.remove('open');
    }
  }

  // 3. ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­ ì‹œ ë‹«ê¸°
  if (manualInputModal) {
    manualInputModal.addEventListener('click', (e) => {
      if (e.target === manualInputModal) {
        closeManualModal();
      }
    });
  }

  // 4. ì‘ì„±í•œ í¼ ë°ì´í„°ë¥¼ ì‹¤ì œ textareaë¡œ ë„˜ê¸°ê¸° (HTMLì˜ onclick="applyManualModal()" ëŒ€ì‘)
  function applyManualModal() {
    const title = document.getElementById('m_title').value.trim();
    const start = document.getElementById('m_start').value;
    
    // í•„ìˆ˜ê°’ ì²´í¬
    if (!title || !start) {
      alert('ì œëª©(title)ê³¼ ì‹œì‘ì¼(date_start)ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
      return;
    }
    
    const end = document.getElementById('m_end').value;
    const content = document.getElementById('m_content').value;
    const party = document.getElementById('m_party').value.trim();
    const isForeign = document.getElementById('m_foreign').value;
    const country = document.getElementById('m_country').value.trim();
    const tags = document.getElementById('m_tags').value.trim();
    
    // íŒŒì´í”„ë¼ì¸ í˜•ì‹(11ì¹¸): id|date_type|date_start|date_end|title|content_raw|party|is_foreign|country|tags|created_at
    // (AUTOë¡œ ì„¤ì •í•´ë‘ë©´ ì €ì¥ ì‹œ ì„œë²„ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì¸ì‹í•˜ì—¬ ìë™ ìƒì„±í•©ë‹ˆë‹¤.)
    const dateType = (start && end) ? 'range' : 'single';
    const contentFormatted = content.replace(/\n/g, '<br>'); // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ì¹˜í™˜
    
    const newLine = `AUTO|${dateType}|${start}|${end}|${title}|${contentFormatted}|${party}|${isForeign}|${country}|${tags}|`;
    
    const addLineTextarea = document.getElementById('addLine');
    if (addLineTextarea) {
      const currentVal = addLineTextarea.value.trim();
      addLineTextarea.value = currentVal ? currentVal + '\n' + newLine : newLine;
      // ì…ë ¥ ì´ë²¤íŠ¸ ë°œìƒ (ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ ìš©)
      addLineTextarea.dispatchEvent(new Event('input'));
    }
    
    // í¼ ì´ˆê¸°í™”
    document.getElementById('m_title').value = '';
    document.getElementById('m_start').value = '';
    document.getElementById('m_end').value = '';
    document.getElementById('m_content').value = '';
    document.getElementById('m_party').value = '';
    document.getElementById('m_foreign').value = 'FALSE';
    document.getElementById('m_country').value = '';
    document.getElementById('m_tags').value = '';
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeManualModal();
  }

/* =========================================
     ëª¨ë°”ì¼ ê²€ìƒ‰ í•„í„° íƒ­ ì œì–´ ë¡œì§
  ========================================= */
  const filterTabBtns = document.querySelectorAll('.filter-tab-btn');
  const filterPanels = document.querySelectorAll('.filter-panel');

  if (filterTabBtns.length > 0) {
    filterTabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // ëª¨ë“  íƒ­ê³¼ íŒ¨ë„ì˜ í™œì„±í™” ìƒíƒœ í•´ì œ
        filterTabBtns.forEach(b => b.classList.remove('active'));
        filterPanels.forEach(p => p.classList.remove('active'));
        
        // í´ë¦­í•œ íƒ­ê³¼ ì—°ê²°ëœ íŒ¨ë„ë§Œ í™œì„±í™”
        btn.classList.add('active');
        const targetId = btn.getAttribute('data-target');
        const targetPanel = document.getElementById(targetId);
        if (targetPanel) {
          targetPanel.classList.add('active');
        }
      });
    });
  }

  /* =========================================
     ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„(ë²„ì „ ë°°ì§€) ìë™ í‘œì‹œ ë¡œì§
  ========================================= */
  const versionBadge = document.getElementById('versionBadge');
  if (versionBadge) {
    // ë¸Œë¼ìš°ì €ê°€ ì¸ì‹í•œ ë¬¸ì„œì˜ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const lastMod = new Date(document.lastModified);
    
    // ë‚ ì§œê°€ ì •ìƒì ì¸ì§€ í™•ì¸ í›„ í¬ë§·íŒ…
    if (!isNaN(lastMod.getTime())) {
      const yy = String(lastMod.getFullYear()).slice(-2);
      const mm = String(lastMod.getMonth() + 1).padStart(2, '0');
      const dd = String(lastMod.getDate()).padStart(2, '0');
      const hh = String(lastMod.getHours()).padStart(2, '0');
      const min = String(lastMod.getMinutes()).padStart(2, '0');
      
      // ì¶œë ¥ í˜•ì‹ ì„¤ì • (ì˜ˆ: v26.02.20 15:30)
      versionBadge.textContent = `v${yy}.${mm}.${dd} ${hh}:${min}`;
    } else {
      versionBadge.textContent = "ë²„ì „ ì •ë³´ ì—†ìŒ";
    }
  }
</script>
</body>
</html>

