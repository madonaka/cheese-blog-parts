<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Log Export</title>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.12); --shadow:0 10px 28px rgba(15,23,42,0.10);
      --r:18px; --r2:12px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .wrap{ max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); padding: 18px;
    }
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin-bottom: 12px;
    }
    h1{ margin:0; font-size:18px; letter-spacing:-0.2px; }
    .desc{ margin:6px 0 0; color:var(--sub); font-size:13px; line-height:1.45; }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 1fr 1.2fr 1.6fr;
      gap: 10px;
      margin-top: 14px;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{ font-size:12px; color:var(--sub); }
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background:#fff;
    }
    input:focus, textarea:focus{ border-color: rgba(15,23,42,0.25); }
    .row{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top: 12px;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      background: #111827; color:#fff; border-color:#111827;
    }
    .btn:active{ transform: translateY(1px); }
    .hint{
      color: var(--sub);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.6;
    }
    .hint code{
      background: rgba(15,23,42,0.06);
      border: 1px solid var(--line);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
    }
    .meta{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-size:12px;
      color: var(--sub);
      background: rgba(15,23,42,0.04);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    textarea#output{
      margin-top: 12px;
      min-height: 360px;
      resize: vertical;
      line-height: 1.55;
    }
    .foot{
      margin-top: 12px;
      color: var(--sub);
      font-size: 12px;
      line-height: 1.6;
    }
    .warn{ color:#b45309; }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .top{ flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Daily Log Export</h1>
          <p class="desc">
            daily_events 시트에서 HTML을 뽑아옵니다. 월/일/ID 필터로 추출할 수 있어요.
          </p>
        </div>
      </div>

      <!-- ✅ 설정 -->
      <div class="field">
        <label>WebApp URL (끝이 /exec 로 끝나는 주소)</label>
        <input id="apiBase" type="text" class="mono"
               placeholder="https://script.google.com/macros/s/XXXXX/exec" />
      </div>

      <!-- ✅ 필터 -->
      <div class="grid">
        <div class="field">
          <label>연도 (월 추출용)</label>
          <input id="year" type="number" value="2026" />
        </div>
        <div class="field">
          <label>월 (월 추출용)</label>
          <input id="month" type="number" min="1" max="12" value="1" />
        </div>
        <div class="field">
          <label>일 (일별 추출용, YYYY-MM-DD)</label>
          <input id="day" type="text" placeholder="2026-01-07" class="mono" />
        </div>
        <div class="field">
          <label>ID (단일 또는 콤마 구분)</label>
          <input id="ids" type="text" placeholder="EVT001,EVT002" class="mono" />
        </div>
      </div>

      <div class="row">
        <button id="btnGenerate" class="btn primary">HTML 생성</button>
        <button id="btnCopy" class="btn">복사</button>
        <button id="btnOpen" class="btn">요청 URL 열기</button>
        <button id="btnClear" class="btn">비우기</button>
      </div>

      <div class="hint">
        - <code>day</code>가 있으면 일별 추출이 우선 적용됩니다.<br/>
        - <code>id</code>는 단일 또는 <code>EVT001,EVT002</code> 처럼 콤마로 여러 개를 넣을 수 있어요.<br/>
        - 월 추출은 <code>year</code> + <code>month</code>가 필요합니다.
      </div>

      <div class="meta">
        <span class="pill">마지막 요청 URL: <span id="lastUrl" class="mono">-</span></span>
        <span class="pill">상태: <span id="status">대기</span></span>
      </div>

      <textarea id="output" class="mono" placeholder="여기에 결과 HTML이 표시됩니다."></textarea>

      <div class="foot">
        <span class="warn">주의:</span> API가 HTML 화면(전체 문서)을 반환하면, 서버의 <code>doGet(e)</code> 분기에서
        <code>mode=exportDailyLog</code>가 제대로 처리되는지 확인하세요.
      </div>
    </div>
  </div>

  <script>
    // === 기본값: 이전에 사용한 주소가 있으면 재사용 ===
    const LS_KEY = "DAILY_LOG_EXPORT_API_BASE";
    const apiBaseEl = document.getElementById("apiBase");
    apiBaseEl.value = localStorage.getItem(LS_KEY) || "";

    // === UI 요소 ===
    const el = {
      year: document.getElementById("year"),
      month: document.getElementById("month"),
      day: document.getElementById("day"),
      ids: document.getElementById("ids"),
      output: document.getElementById("output"),
      lastUrl: document.getElementById("lastUrl"),
      status: document.getElementById("status"),
      btnGenerate: document.getElementById("btnGenerate"),
      btnCopy: document.getElementById("btnCopy"),
      btnOpen: document.getElementById("btnOpen"),
      btnClear: document.getElementById("btnClear"),
    };

    let lastRequestUrl = "";

    el.btnGenerate.addEventListener("click", generate);
    el.btnCopy.addEventListener("click", copyOutput);
    el.btnOpen.addEventListener("click", openLastUrl);
    el.btnClear.addEventListener("click", () => {
      el.output.value = "";
      setStatus("비움");
    });

    apiBaseEl.addEventListener("change", () => {
      const v = apiBaseEl.value.trim();
      localStorage.setItem(LS_KEY, v);
    });

    function setStatus(text) {
      el.status.textContent = text;
    }

    function buildUrl() {
      const base = apiBaseEl.value.trim();
      if (!base) throw new Error("WebApp URL이 비어 있습니다.");

      const year  = String(el.year.value || "").trim();
      const month = String(el.month.value || "").trim();
      const day   = String(el.day.value || "").trim();
      const ids   = String(el.ids.value || "").trim();

      // 월 or 일 조건 체크
      if (!day && (!year || !month)) {
        throw new Error("월 추출은 연도/월이 필요하고, 일별 추출은 day(YYYY-MM-DD)가 필요합니다.");
      }

      const params = new URLSearchParams();
      params.set("mode", "exportDailyLog");

      if (day) {
        params.set("day", day);
      } else {
        params.set("year", year);
        params.set("month", month);
      }

      if (ids) params.set("id", ids);

      return base + "?" + params.toString();
    }

    async function generate() {
      try {
        setStatus("요청 준비");
        el.output.value = "";

        const url = buildUrl();
        lastRequestUrl = url;
        el.lastUrl.textContent = url;

        // 저장
        localStorage.setItem(LS_KEY, apiBaseEl.value.trim());

        setStatus("요청 중...");
        el.output.value = "생성 중...";

        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error("API 호출 실패 (HTTP " + res.status + ")");

        const text = await res.text();

        // 서버 분기 실패 감지(전체 HTML 문서가 내려오는 경우)
        if (text && /<!doctype html|<html/i.test(text)) {
          el.output.value = "";
          throw new Error("API가 화면용 HTML을 반환했습니다. (서버 doGet 분기/배포 확인 필요)");
        }

        el.output.value = text || "<!-- empty -->";
        setStatus("완료");
      } catch (e) {
        el.output.value = "";
        setStatus("실패");
        alert("실패: " + (e && e.message ? e.message : String(e)));
      }
    }

    async function copyOutput() {
      const val = (el.output.value || "").trim();
      if (!val) {
        alert("복사할 내용이 없습니다.");
        return;
      }
      try {
        await navigator.clipboard.writeText(el.output.value);
        setStatus("복사 완료");
      } catch (e) {
        // fallback
        el.output.focus();
        el.output.select();
        document.execCommand("copy");
        setStatus("복사 완료");
      }
    }

    function openLastUrl() {
      if (!lastRequestUrl) {
        try {
          lastRequestUrl = buildUrl();
          el.lastUrl.textContent = lastRequestUrl;
        } catch (e) {
          alert("열 수 있는 URL이 없습니다: " + e.message);
          return;
        }
      }
      window.open(lastRequestUrl, "_blank", "noopener,noreferrer");
      setStatus("URL 열기");
    }
  </script>
</body>
</html>
