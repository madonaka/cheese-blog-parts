<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사건 입력/수정 · Knowledge DB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js" defer></script>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:rgba(15,23,42,.12); --shadow:0 10px 28px rgba(15,23,42,.10);
      --r:18px; --primary:#111827; --ok:#16a34a; --bad:#ef4444;
      --soft:#e0f2fe; --label:#0b1220;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    .page-wrap{ max-width:1100px; margin:0 auto; padding:18px 18px 40px; box-sizing:border-box; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; }
    .h{ padding:16px 16px 12px; border-bottom:1px solid var(--line);
      display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .h .title{ font-weight:950; font-size:18px; letter-spacing:-.2px; }
    .h .sub{ font-size:13px; color:var(--muted); margin-top:2px; }
    .b{ padding:16px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; }
    .full{ grid-column: 1 / -1; }

    label{ display:block; font-size:14px; font-weight:900; color:var(--label);
      margin:0 0 8px; letter-spacing:-.2px; }
    .label-sub{ font-weight:800; color:var(--muted); font-size:12px; margin-left:6px; }

    input[type="text"], input[type="number"], textarea, select{
      width:100%; padding:12px 12px; border:1.5px solid var(--line); border-radius:14px;
      background:#fff; color:var(--text); outline:none; font-size:14px; box-sizing:border-box;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(17,24,39,.35);
      box-shadow: 0 0 0 4px rgba(17,24,39,.08);
    }
    textarea{ min-height:130px; resize:vertical; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:14px; padding:12px 16px; cursor:pointer; font-weight:950; font-size:14px; min-height:44px;
      white-space:nowrap;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:rgba(0,0,0,.2); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px; border:1.5px solid var(--line); border-radius:14px; background:#fff;
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); border-radius:999px; padding:7px 11px;
      font-size:13px; background:var(--soft); font-weight:800;
    }
    .chip button{ border:none; background:transparent; cursor:pointer; font-weight:950; color:var(--muted); font-size:14px; }

    .hint{ font-size:12.5px; color:var(--muted); margin-top:7px; line-height:1.4; }

    .status{
      font-size:13px; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-weight:900; min-height:44px;
      display:inline-flex; align-items:center;
    }
    .status.ok{ border-color: rgba(22,163,74,.35); color: var(--ok); }
    .status.bad{ border-color: rgba(239,68,68,.35); color: var(--bad); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:12px; color:var(--muted); }
    .sep{ height:1px; background:var(--line); margin:14px 0; }
  </style>
</head>

<body>
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP","MGR","FIN","ADMIN"];
  </script>

  <div id="admin-header-slot"></div>
  <div class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <main>
      <div class="page-wrap">

        <div class="card">
          <div class="h">
            <div>
              <div class="title">사건 입력/수정</div>
              <div class="sub">
                URL event_id: <span id="qsId" class="mono">(없음)</span>
              </div>
            </div>
            <div class="row">
              <span id="uiStatus" class="status">대기</span>
              <button class="btn" type="button" id="btnReload">불러오기</button>
              <button class="btn" type="button" id="btnNew">새 사건</button>
              <button class="btn primary" type="button" id="btnSave">저장</button>
            </div>
          </div>

          <div class="b">
            <div class="grid3">
              <div>
                <label>사건 ID<span class="label-sub">(event_id)</span></label>
                <input type="text" id="event_id" class="mono" placeholder="예: E_19190301_SAM" />
                <div class="hint">비워두면 저장 시 자동으로 생성합니다.</div>
              </div>
              <div>
                <label>상태<span class="label-sub">(status)</span></label>
                <select id="status">
                  <option value="draft">초안(draft)</option>
                  <option value="published">공개(published)</option>
                </select>
              </div>
              <div>
                <label>중요도<span class="label-sub">(1~5)</span></label>
                <input type="number" id="importance" min="1" max="5" value="3" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="grid">
              <div>
                <label>사건 제목(한국어)<span class="label-sub">(title_ko)</span></label>
                <input type="text" id="title_ko" placeholder="예: 3·1 운동" />
              </div>
              <div>
                <label>사건 제목(일본어)<span class="label-sub">(title_ja)</span></label>
                <input type="text" id="title_ja" placeholder="예: 三・一運動 (선택)" />
              </div>
              <div>
                <label>사건 제목(중국어)<span class="label-sub">(title_zh)</span></label>
                <input type="text" id="title_zh" placeholder="예: 三一运动 (선택)" />
              </div>
              <div>
                <label>분류<span class="label-sub">(category)</span></label>
                <select id="category">
                  <option value="">(선택)</option>
                  <option value="politics">정치(politics)</option>
                  <option value="war">전쟁/군사(war)</option>
                  <option value="diplomacy">외교(diplomacy)</option>
                  <option value="economy">경제(economy)</option>
                  <option value="society">사회(society)</option>
                  <option value="culture">문화(culture)</option>
                </select>
              </div>

              <div>
                <label>시작 시점<span class="label-sub">(date_start)</span></label>
                <input type="text" id="date_start" class="mono" placeholder="예: 1919-03-01 / 1919-03 / 1919 / BCE 233 / 기원전 233" />
              </div>
              <div>
                <label>종료 시점<span class="label-sub">(date_end)</span></label>
                <input type="text" id="date_end" class="mono" placeholder="예: 1945-08-15 / 1945-08 / 1945 (선택)" />
              </div>

              <div>
                <label>날짜 정확도<span class="label-sub">(date_precision)</span></label>
                <select id="date_precision">
                  <option value="day">일 단위(day)</option>
                  <option value="month">월 단위(month)</option>
                  <option value="year">연 단위(year)</option>
                </select>
              </div>

              <div class="full">
                <label>관련 국가<span class="label-sub">(countries)</span></label>
                <div class="row">
                  <input type="text" id="countries_input" placeholder="예: KR|JP  또는  KR,JP" />
                  <button class="btn" type="button" id="countries_apply">적용</button>
                </div>
                <div class="chips" id="countries_chips"></div>
              </div>

              <div class="full">
                <label>당대 국가/정권/왕조<span class="label-sub">(polities)</span></label>
                <div class="row">
                  <input type="text" id="polities_input" placeholder="예: 고구려|조선|청  또는  명,조선" />
                  <button class="btn" type="button" id="polities_apply">적용</button>
                </div>
                <div class="chips" id="polities_chips"></div>
              </div>

              <div class="full">
                <label>태그<span class="label-sub">(tags)</span></label>
                <div class="row">
                  <input type="text" id="tags_input" placeholder="예: 독립운동|외교|시위" />
                  <button class="btn" type="button" id="tags_apply">적용</button>
                </div>
                <div class="chips" id="tags_chips"></div>
              </div>

              <div class="full">
                <label>관련 엔티티 ID<span class="label-sub">(entity_refs)</span></label>
                <div class="row">
                  <input type="text" id="entity_refs_input" class="mono" placeholder="예: P_ANK|O_SINGANHOE|L_SEOUL" />
                  <button class="btn" type="button" id="entity_refs_apply">적용</button>
                </div>
                <div class="chips" id="entity_refs_chips"></div>
              </div>

              <div class="full">
                <label>출처 ID<span class="label-sub">(source_refs)</span></label>
                <div class="row">
                  <input type="text" id="source_refs_input" class="mono" placeholder="예: S_WEB_001|S_BOOK_010" />
                  <button class="btn" type="button" id="source_refs_apply">적용</button>
                </div>
                <div class="chips" id="source_refs_chips"></div>
              </div>

              <div class="full">
                <label>요약<span class="label-sub">(summary)</span></label>
                <textarea id="summary"></textarea>
              </div>

              <div class="full">
                <label>상세 설명<span class="label-sub">(body)</span></label>
                <textarea id="body"></textarea>
              </div>

              <div class="full">
                <label>생성/수정 시각<span class="label-sub">(created_at / updated_at)</span></label>
                <div class="grid3">
                  <input type="text" id="created_at" />
                  <input type="text" id="updated_at" />
                  <button class="btn" type="button" id="btnStampNow">지금 시각 입력</button>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card">
          <div class="h">
            <div>
              <div class="title">미리보기(JSON)</div>
              <div class="sub">요청/응답/에러까지 여기서 확인</div>
            </div>
            <div class="row">
              <button class="btn" type="button" id="btnCopyJson">JSON 복사</button>
              <button class="btn" type="button" id="btnExportTsv">TSV 1줄 복사</button>
            </div>
          </div>
          <div class="b">
            <pre id="preview" class="mono small" style="white-space:pre-wrap; margin:0;"></pre>
          </div>
        </div>

      </div>
    </main>
  </div>

<script>
  const $ = (id)=> document.getElementById(id);

  // ✅ 여기서 API를 "상수로 고정" (admin-common.js가 덮어써도 상관없게)
  const API_BASE =
    "https://script.google.com/macros/s/AKfycbxm0AbCRq2oa6BkNuLFDueE5nts9lomLoxm3_IpXrlb-mft-iTZh9Lz8SYm1MOfCOYXzw/exec";

  function setUiStatus(text, kind=""){
    const el = $("uiStatus");
    if (!el) return;
    el.textContent = text;
    el.className = "status" + (kind ? (" " + kind) : "");
  }

  function nowText(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function splitList(s){
    if (!s) return [];
    return s.split(/[\|\,,\n]+/g).map(v=>v.trim()).filter(Boolean);
  }
  function uniq(arr){ return Array.from(new Set(arr)); }
  const toPipe = (items)=> (items || []).join("|");

  function renderChips(container, items, onRemove){
    if (!container) return;
    if (!items || items.length === 0){
      container.innerHTML = "";
      container.style.display = "none";
      return;
    }
    container.style.display = "flex";
    container.innerHTML = "";
    items.forEach((v, idx)=>{
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<span>${escapeHtml(v)}</span><button type="button">×</button>`;
      chip.querySelector("button").addEventListener("click", ()=> onRemove(idx));
      container.appendChild(chip);
    });
  }

  const state = { countries:[], polities:[], tags:[], entity_refs:[], source_refs:[] };

  function setChips(key, arr){
    state[key] = uniq((arr||[]).map(x=>String(x).trim()).filter(Boolean));
  }

  function applyFromInput(inputId, key, chipsId){
    const input = $(inputId);
    const chips = $(chipsId);
    if (!input || !chips) return;
    setChips(key, splitList(input.value));
    renderChips(chips, state[key], (idx)=>{
      state[key].splice(idx,1);
      renderChips(chips, state[key], ()=>{});
      syncPreview();
    });
    syncPreview();
    setUiStatus("적용 완료", "ok");
  }

  function normalizeDateText(s){ return (s||"").trim(); }
  function autoSetPrecisionFromText(){
    const s = normalizeDateText($("date_start")?.value);
    const sel = $("date_precision");
    if (!sel) return;
    if (/^-?\d{1,6}-\d{2}-\d{2}$/.test(s)) sel.value = "day";
    else if (/^-?\d{1,6}-\d{2}$/.test(s)) sel.value = "month";
    else sel.value = "year";
  }

  function makeEventId(dateStartText){
    const raw = String(dateStartText||"").trim();
    const isBce = /^(bce|bc|기원전)/i.test(raw);
    const rand = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4).padEnd(4,'X');
    const y = raw.match(/(\d{1,6})/);
    const year = y ? String(y[1]).padStart(4,"0") : "0000";
    return isBce ? `E_B${year}_${rand}` : `E_${year}0000_${rand}`;
  }

  function collectPayload(){
    autoSetPrecisionFromText();
    return {
      event_id: $("event_id")?.value.trim() || "",
      title_ko: $("title_ko")?.value.trim() || "",
      title_ja: $("title_ja")?.value.trim() || "",
      title_zh: $("title_zh")?.value.trim() || "",
      date_start: normalizeDateText($("date_start")?.value),
      date_end: normalizeDateText($("date_end")?.value),
      date_precision: $("date_precision")?.value || "year",
      countries: toPipe(state.countries),
      polities: toPipe(state.polities),
      category: $("category")?.value || "",
      importance: Number($("importance")?.value || 0),
      status: $("status")?.value || "draft",
      summary: $("summary")?.value.trim() || "",
      body: $("body")?.value.trim() || "",
      tags: toPipe(state.tags),
      entity_refs: toPipe(state.entity_refs),
      source_refs: toPipe(state.source_refs),
      created_at: $("created_at")?.value.trim() || "",
      updated_at: $("updated_at")?.value.trim() || "",
    };
  }

  function syncPreview(extra=null){
    const pre = $("preview");
    if (!pre) return;
    const base = { form: collectPayload() };
    pre.textContent = JSON.stringify(extra ? {...base, ...extra} : base, null, 2);
  }

  async function apiPost(json){
    // ✅ 디버그용: 요청도 같이 찍기
    syncPreview({ request: json, api_base: API_BASE });

    const res = await fetch(API_BASE, { method:"POST", body: JSON.stringify(json) });
    const text = await res.text();

    let data;
    try { data = JSON.parse(text); }
    catch(_) { data = { ok: res.ok, raw: text }; }

    // ✅ 응답도 같이 찍기
    syncPreview({ request: json, response: data, http_ok: res.ok });

    if (!res.ok || data?.ok === false){
      throw new Error(data?.message || `HTTP ${res.status}`);
    }
    return data;
  }

  function getQueryEventId(){
    const sp = new URLSearchParams(location.search);
    return (sp.get("event_id") || "").trim();
  }

  function fillForm(item){
    $("event_id").value = item.event_id || "";
    $("title_ko").value = item.title_ko || "";
    $("title_ja").value = item.title_ja || "";
    $("title_zh").value = item.title_zh || "";
    $("date_start").value = item.date_start || "";
    $("date_end").value = item.date_end || "";
    $("date_precision").value = item.date_precision || "year";
    $("category").value = item.category || "";
    $("importance").value = (item.importance ?? 3);
    $("status").value = item.status || "draft";
    $("summary").value = item.summary || "";
    $("body").value = item.body || "";
    $("created_at").value = item.created_at || "";
    $("updated_at").value = item.updated_at || "";

    setChips("countries", splitList((item.countries||"").replaceAll("|", ",")));
    setChips("polities",  splitList((item.polities||"").replaceAll("|", ",")));
    setChips("tags",      splitList((item.tags||"").replaceAll("|", ",")));
    setChips("entity_refs", splitList((item.entity_refs||"").replaceAll("|", ",")));
    setChips("source_refs", splitList((item.source_refs||"").replaceAll("|", ",")));

    $("countries_input").value   = toPipe(state.countries);
    $("polities_input").value    = toPipe(state.polities);
    $("tags_input").value        = toPipe(state.tags);
    $("entity_refs_input").value = toPipe(state.entity_refs);
    $("source_refs_input").value = toPipe(state.source_refs);

    renderChips($("countries_chips"), state.countries, (idx)=>{ state.countries.splice(idx,1); renderChips($("countries_chips"), state.countries, ()=>{}); syncPreview(); });
    renderChips($("polities_chips"),  state.polities,  (idx)=>{ state.polities.splice(idx,1);  renderChips($("polities_chips"), state.polities, ()=>{}); syncPreview(); });
    renderChips($("tags_chips"),      state.tags,      (idx)=>{ state.tags.splice(idx,1);      renderChips($("tags_chips"), state.tags, ()=>{}); syncPreview(); });
    renderChips($("entity_refs_chips"), state.entity_refs, (idx)=>{ state.entity_refs.splice(idx,1); renderChips($("entity_refs_chips"), state.entity_refs, ()=>{}); syncPreview(); });
    renderChips($("source_refs_chips"), state.source_refs, (idx)=>{ state.source_refs.splice(idx,1); renderChips($("source_refs_chips"), state.source_refs, ()=>{}); syncPreview(); });

    syncPreview();
  }

  async function loadFromQuery(){
    const id = getQueryEventId();
    $("qsId").textContent = id || "(없음)";
    if (!id){
      setUiStatus("새 사건 모드", "");
      return;
    }

    setUiStatus("불러오는 중…", "");
    try{
      const out = await apiPost({ mode:"events.get", event_id: id });
      if (!out?.item) throw new Error("응답에 item이 없습니다.");
      fillForm(out.item);
      setUiStatus("불러오기 완료", "ok");
    }catch(err){
      setUiStatus(err?.message || "불러오기 실패", "bad");
    }
  }

  function tsvEscape(v){
    return String(v ?? "").replace(/\t/g," ").replace(/\r?\n/g," ").trim();
  }

  window.addEventListener("DOMContentLoaded", ()=>{
    $("countries_apply")?.addEventListener("click", ()=> applyFromInput("countries_input","countries","countries_chips"));
    $("polities_apply")?.addEventListener("click",  ()=> applyFromInput("polities_input","polities","polities_chips"));
    $("tags_apply")?.addEventListener("click",      ()=> applyFromInput("tags_input","tags","tags_chips"));
    $("entity_refs_apply")?.addEventListener("click",()=> applyFromInput("entity_refs_input","entity_refs","entity_refs_chips"));
    $("source_refs_apply")?.addEventListener("click",()=> applyFromInput("source_refs_input","source_refs","source_refs_chips"));

    $("btnReload")?.addEventListener("click", loadFromQuery);

    $("btnStampNow")?.addEventListener("click", ()=>{
      const t = nowText();
      if (!$("created_at").value) $("created_at").value = t;
      $("updated_at").value = t;
      syncPreview();
    });

    $("btnNew")?.addEventListener("click", ()=>{
      ["event_id","title_ko","title_ja","title_zh","date_start","date_end","summary","body","created_at","updated_at",
       "countries_input","polities_input","tags_input","entity_refs_input","source_refs_input"
      ].forEach(id => { if ($(id)) $(id).value = ""; });

      $("date_precision").value = "year";
      $("importance").value = 3;
      $("status").value = "draft";
      $("category").value = "";

      state.countries=[]; state.polities=[]; state.tags=[]; state.entity_refs=[]; state.source_refs=[];
      renderChips($("countries_chips"), state.countries, ()=>{});
      renderChips($("polities_chips"),  state.polities,  ()=>{});
      renderChips($("tags_chips"),      state.tags,      ()=>{});
      renderChips($("entity_refs_chips"), state.entity_refs, ()=>{});
      renderChips($("source_refs_chips"), state.source_refs, ()=>{});

      history.replaceState({}, "", "./events_editor.html");
      $("qsId").textContent = "(없음)";
      setUiStatus("새 사건 작성", "");
      syncPreview();
    });

    $("btnCopyJson")?.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText($("preview").textContent);
        setUiStatus("JSON 복사됨", "ok");
      }catch(_){
        setUiStatus("복사 실패", "bad");
      }
    });

    $("btnExportTsv")?.addEventListener("click", async ()=>{
      const p = collectPayload();
      if (!p.event_id){
        p.event_id = makeEventId(p.date_start);
        $("event_id").value = p.event_id;
      }
      const cols = [
        "event_id","title_ko","title_ja","title_zh","date_start","date_end","date_precision",
        "countries","polities","category","importance","status","summary","body","tags",
        "entity_refs","source_refs","created_at","updated_at"
      ];
      const line = cols.map(k => tsvEscape(p[k])).join("\t");
      try{
        await navigator.clipboard.writeText(line);
        setUiStatus("TSV 1줄 복사됨", "ok");
      }catch(_){
        setUiStatus("TSV 복사 실패", "bad");
      }
      syncPreview();
    });

    $("btnSave")?.addEventListener("click", async ()=>{
      try{
        setUiStatus("저장 중…", "");
        $("btnSave").disabled = true;

        const p = collectPayload();
        if (!p.title_ko) throw new Error("사건 제목(한국어)은 필수입니다.");
        if (!p.date_start) throw new Error("시작 시점은 필수입니다.");

        if (!p.event_id){
          p.event_id = makeEventId(p.date_start);
          $("event_id").value = p.event_id;
        }
        if (!p.created_at) $("created_at").value = nowText();
        $("updated_at").value = nowText();

        const payload = collectPayload();
        const req = { mode:"events.upsert", payload };
        const out = await apiPost(req);

        setUiStatus("저장 완료", "ok");
        history.replaceState({}, "", `./events_editor.html?event_id=${encodeURIComponent(payload.event_id)}`);
        $("qsId").textContent = payload.event_id;

      }catch(err){
        setUiStatus(err?.message || "저장 실패", "bad");
      }finally{
        $("btnSave").disabled = false;
      }
    });

    // 초기
    syncPreview();
    loadFromQuery();
  });
</script>
</body>
</html>
