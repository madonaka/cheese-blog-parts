<!-- events_editor.html (v1) : EVENTS 입력/수정 페이지 (메뉴/헤더 슬롯 포함 버전)
  ✅ 고정 골격 포함
  - window.CHEESE_ADMIN_REQUIRED_ROLES
  - .admin-shell / #admin-menu-slot / #admin-header-slot / .admin-main

  ✅ 해야 할 것
  1) window.CHEESE_ADMIN_API_BASE 에 Apps Script exec URL(또는 프록시 API) 넣기
  2) 서버(Apps Script)에서 mode=events.upsert 처리
-->

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Events Editor · Knowledge DB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 공통 CSS -->
  <link rel="stylesheet" href="./admin.css" />

  <!-- 공통 로더(메뉴/헤더 슬롯 주입용) -->
  <!-- 너의 프로젝트에서 쓰는 파일명이 다르면 교체 -->
  <script src="./admin-common.js" defer></script>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:rgba(15,23,42,.10); --shadow:0 10px 28px rgba(15,23,42,.10);
      --r:18px; --primary:#111827; --ok:#16a34a; --bad:#ef4444; --soft:#e0f2fe;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    /* ✅ admin-shell 안에서 콘텐츠 영역 */
    .admin-content{
      width:100%;
      box-sizing:border-box;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:18px 18px 40px; box-sizing:border-box; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; }
    .h{ padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .h .title{ font-weight:900; font-size:15px; }
    .h .sub{ font-size:12px; color:var(--muted); }
    .b{ padding:14px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .full{ grid-column: 1 / -1; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%; padding:10px 11px; border:1px solid var(--line);
      border-radius:12px; background:#fff; color:var(--text); outline:none;
    }
    textarea{ min-height:120px; resize:vertical; }

    .row{ display:flex; gap:10px; align-items:center; }
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:rgba(0,0,0,.2); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff;
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px;
      background:var(--soft);
    }
    .chip button{
      border:none; background:transparent; cursor:pointer; font-weight:900; color:var(--muted);
    }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35; }
    .status{ font-size:12px; padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--muted); }
    .status.ok{ border-color: rgba(22,163,74,.3); color: var(--ok); }
    .status.bad{ border-color: rgba(239,68,68,.3); color: var(--bad); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size:12px; color:var(--muted); }
    .sep{ height:1px; background:var(--line); margin:12px 0; }
  </style>

  <script>
    // ✅ 너의 Apps Script WebApp exec URL 또는 프록시 API로 바꿔 넣기
    window.CHEESE_ADMIN_API_BASE = ""; // TODO
  </script>
</head>

<body>
  <!-- ✅ 권한별 접근 제어(요청한 고정 구조) -->
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "FIN", "ADMIN"];
  </script>

  <div class="admin-shell">
    <!-- ✅ 공통 메뉴 슬롯(요청한 고정 구조) -->
    <div id="admin-menu-slot"></div>

    <div class="admin-main">
      <!-- ✅ 공통 헤더 슬롯(요청한 고정 구조) -->
      <div id="admin-header-slot"></div>

      <!-- ✅ 페이지 콘텐츠 영역 -->
      <div class="admin-content">
        <div class="wrap">

          <div class="card">
            <div class="h">
              <div>
                <div class="title">EVENTS 입력/수정</div>
                <div class="sub">v1 · 연표용 사건 데이터 + 블로그 글 재료 저장</div>
              </div>
              <div class="row">
                <span id="uiStatus" class="status">대기</span>
                <button class="btn" type="button" id="btnNew">새 사건</button>
                <button class="btn primary" type="button" id="btnSave">저장</button>
              </div>
            </div>

            <div class="b">
              <div class="grid3">
                <div>
                  <label>event_id</label>
                  <input type="text" id="event_id" class="mono" placeholder="E_YYYYMMDD_XXXX" />
                  <div class="hint">비워두면 저장 시 자동 생성합니다.</div>
                </div>

                <div>
                  <label>status</label>
                  <select id="status">
                    <option value="draft">draft</option>
                    <option value="published">published</option>
                  </select>
                </div>

                <div>
                  <label>importance (1~5)</label>
                  <input type="number" id="importance" min="1" max="5" value="3" />
                </div>
              </div>

              <div class="sep"></div>

              <div class="grid">
                <div>
                  <label>title_ko</label>
                  <input type="text" id="title_ko" placeholder="사건 한국어 표제" />
                </div>
                <div>
                  <label>title_ja</label>
                  <input type="text" id="title_ja" placeholder="일본어 표기(선택)" />
                </div>
                <div>
                  <label>title_zh</label>
                  <input type="text" id="title_zh" placeholder="중국어 표기(선택)" />
                </div>
                <div>
                  <label>category</label>
                  <select id="category">
                    <option value="">(선택)</option>
                    <option value="politics">politics</option>
                    <option value="war">war</option>
                    <option value="diplomacy">diplomacy</option>
                    <option value="economy">economy</option>
                    <option value="society">society</option>
                    <option value="culture">culture</option>
                  </select>
                  <div class="hint">v1은 큰 분류만 1개로 제한하는 걸 추천.</div>
                </div>

                <div>
                  <label>date_start</label>
                  <input type="date" id="date_start" />
                </div>
                <div>
                  <label>date_end</label>
                  <input type="date" id="date_end" />
                </div>
                <div>
                  <label>date_precision</label>
                  <select id="date_precision">
                    <option value="day">day</option>
                    <option value="month">month</option>
                    <option value="year">year</option>
                  </select>
                </div>

                <div class="full">
                  <label>countries (KR|CN|JP)</label>
                  <div class="row">
                    <input type="text" id="countries_input" placeholder="예: KR|JP  또는  KR,JP" />
                    <button class="btn" type="button" id="countries_apply">적용</button>
                  </div>
                  <div class="chips" id="countries_chips"></div>
                  <div class="hint">파이프(|) 또는 콤마(,)로 입력 → “적용” 누르면 칩으로 변환됩니다.</div>
                </div>

                <div class="full">
                  <label>tags</label>
                  <div class="row">
                    <input type="text" id="tags_input" placeholder="예: 독립운동|외교|시위" />
                    <button class="btn" type="button" id="tags_apply">적용</button>
                  </div>
                  <div class="chips" id="tags_chips"></div>
                </div>

                <div class="full">
                  <label>entity_refs (P_/O_/L_/C_...)</label>
                  <div class="row">
                    <input type="text" id="entity_refs_input" class="mono" placeholder="예: P_ANK|O_SINGANHOE|L_SEOUL" />
                    <button class="btn" type="button" id="entity_refs_apply">적용</button>
                  </div>
                  <div class="chips" id="entity_refs_chips"></div>
                  <div class="hint">v1은 일단 직접 입력 방식. 이후 ENTITIES 검색 팝업으로 확장 가능.</div>
                </div>

                <div class="full">
                  <label>source_refs (S_...)</label>
                  <div class="row">
                    <input type="text" id="source_refs_input" class="mono" placeholder="예: S_WEB_001|S_BOOK_010" />
                    <button class="btn" type="button" id="source_refs_apply">적용</button>
                  </div>
                  <div class="chips" id="source_refs_chips"></div>
                </div>

                <div class="full">
                  <label>summary</label>
                  <textarea id="summary" placeholder="연표 카드용 2~3줄 요약"></textarea>
                </div>

                <div class="full">
                  <label>body</label>
                  <textarea id="body" placeholder="상세 설명(블로그 본문 재료)"></textarea>
                </div>

                <div class="full">
                  <label>created_at / updated_at</label>
                  <div class="grid3">
                    <input type="text" id="created_at" placeholder="YYYY-MM-DD HH:mm" />
                    <input type="text" id="updated_at" placeholder="YYYY-MM-DD HH:mm" />
                    <button class="btn" type="button" id="btnStampNow">지금 시각 입력</button>
                  </div>
                  <div class="hint">서버에서 자동 처리해도 됩니다. (화면은 선택)</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 디버그/내보내기 -->
          <div class="card">
            <div class="h">
              <div>
                <div class="title">미리보기(JSON)</div>
                <div class="sub">저장 전에 payload를 확인할 수 있습니다.</div>
              </div>
              <div class="row">
                <button class="btn" type="button" id="btnCopyJson">JSON 복사</button>
                <button class="btn" type="button" id="btnExportTsv">TSV 1줄 내보내기</button>
              </div>
            </div>
            <div class="b">
              <pre id="preview" class="mono small" style="white-space:pre-wrap; margin:0;"></pre>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Utils
    // =========================
    const $ = (id) => document.getElementById(id);

    function nowText(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function setUiStatus(text, kind=""){
      const el = $("uiStatus");
      el.textContent = text;
      el.className = "status" + (kind ? (" " + kind) : "");
    }

    function splitList(s){
      if (!s) return [];
      return s
        .split(/[\|\,,\n]+/g)
        .map(v => v.trim())
        .filter(Boolean);
    }

    function uniq(arr){
      return Array.from(new Set(arr));
    }

    function renderChips(container, items, onRemove){
      container.innerHTML = "";
      if (!items.length){
        container.innerHTML = `<span class="small" style="color:var(--muted);">비어 있음</span>`;
        return;
      }
      items.forEach((v, idx)=>{
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `<span>${escapeHtml(v)}</span><button type="button" aria-label="remove">×</button>`;
        chip.querySelector("button").addEventListener("click", ()=> onRemove(idx));
        container.appendChild(chip);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function makeEventId(dateStart){
      const d = dateStart ? new Date(dateStart) : new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const ymd = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
      const rand = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4).padEnd(4,'X');
      return `E_${ymd}_${rand}`;
    }

    function toPipe(items){
      return items.join("|");
    }

    function tsvEscape(v){
      const s = String(v ?? "");
      return s.replace(/\t/g, " ").replace(/\r?\n/g, " ").trim();
    }

    // =========================
    // State
    // =========================
    const state = {
      countries: [],
      tags: [],
      entity_refs: [],
      source_refs: [],
    };

    // =========================
    // Bind chip controls
    // =========================
    function applyFromInput(inputId, key, chipsId){
      const items = uniq(splitList($(inputId).value));
      state[key] = items;
      renderChips($(chipsId), state[key], (idx)=>{
        state[key].splice(idx,1);
        renderChips($(chipsId), state[key], ()=>{});
        syncPreview();
      });
      syncPreview();
    }

    $("countries_apply").addEventListener("click", ()=> applyFromInput("countries_input","countries","countries_chips"));
    $("tags_apply").addEventListener("click", ()=> applyFromInput("tags_input","tags","tags_chips"));
    $("entity_refs_apply").addEventListener("click", ()=> applyFromInput("entity_refs_input","entity_refs","entity_refs_chips"));
    $("source_refs_apply").addEventListener("click", ()=> applyFromInput("source_refs_input","source_refs","source_refs_chips"));

    // =========================
    // Form → Payload
    // =========================
    function collectPayload(){
      return {
        event_id: $("event_id").value.trim() || "",
        title_ko: $("title_ko").value.trim(),
        title_ja: $("title_ja").value.trim(),
        title_zh: $("title_zh").value.trim(),
        date_start: $("date_start").value || "",
        date_end: $("date_end").value || "",
        date_precision: $("date_precision").value,
        countries: toPipe(state.countries),
        category: $("category").value,
        importance: Number($("importance").value || 0),
        status: $("status").value,
        summary: $("summary").value.trim(),
        body: $("body").value.trim(),
        tags: toPipe(state.tags),
        entity_refs: toPipe(state.entity_refs),
        source_refs: toPipe(state.source_refs),
        created_at: $("created_at").value.trim(),
        updated_at: $("updated_at").value.trim(),
      };
    }

    function syncPreview(){
      $("preview").textContent = JSON.stringify(collectPayload(), null, 2);
    }

    ["event_id","title_ko","title_ja","title_zh","date_start","date_end","date_precision","category","importance","status","summary","body","created_at","updated_at"]
      .forEach(id => $(id).addEventListener("input", syncPreview));

    // =========================
    // Buttons
    // =========================
    $("btnStampNow").addEventListener("click", ()=>{
      const t = nowText();
      if (!$("created_at").value) $("created_at").value = t;
      $("updated_at").value = t;
      syncPreview();
    });

    $("btnNew").addEventListener("click", ()=>{
      ["event_id","title_ko","title_ja","title_zh","date_start","date_end","summary","body","created_at","updated_at","countries_input","tags_input","entity_refs_input","source_refs_input"]
        .forEach(id => $(id).value = "");
      $("date_precision").value = "day";
      $("importance").value = 3;
      $("status").value = "draft";
      $("category").value = "";

      state.countries = [];
      state.tags = [];
      state.entity_refs = [];
      state.source_refs = [];
      renderChips($("countries_chips"), [], ()=>{});
      renderChips($("tags_chips"), [], ()=>{});
      renderChips($("entity_refs_chips"), [], ()=>{});
      renderChips($("source_refs_chips"), [], ()=>{});

      setUiStatus("새 사건 작성", "");
      syncPreview();
    });

    $("btnCopyJson").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText($("preview").textContent);
        setUiStatus("JSON 복사됨", "ok");
      }catch(e){
        setUiStatus("복사 실패(권한)", "bad");
      }
    });

    $("btnExportTsv").addEventListener("click", async ()=>{
      const p = collectPayload();
      const cols = [
        "event_id","title_ko","title_ja","title_zh","date_start","date_end","date_precision",
        "countries","category","importance","status","summary","body","tags","entity_refs","source_refs","created_at","updated_at"
      ];
      if (!p.event_id){
        p.event_id = makeEventId(p.date_start);
        $("event_id").value = p.event_id;
      }
      const line = cols.map(k => tsvEscape(p[k])).join("\t");
      try{
        await navigator.clipboard.writeText(line);
        setUiStatus("TSV 1줄 복사됨", "ok");
      }catch(e){
        setUiStatus("TSV 복사 실패", "bad");
      }
      syncPreview();
    });

    // =========================
    // Save (API)
    // =========================
    async function apiPost(json){
      const base = (window.CHEESE_ADMIN_API_BASE || "").trim();
      if (!base){
        throw new Error("API Base가 비어 있습니다. window.CHEESE_ADMIN_API_BASE 를 설정하세요.");
      }
      const res = await fetch(base, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(json),
      });
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch(_){ data = { ok: res.ok, raw: text }; }
      if (!res.ok || data?.ok === false){
        throw new Error(data?.message || `HTTP ${res.status}`);
      }
      return data;
    }

    $("btnSave").addEventListener("click", async ()=>{
      try{
        setUiStatus("저장 중…", "");
        $("btnSave").disabled = true;

        const p = collectPayload();

        if (!p.title_ko) throw new Error("title_ko는 필수입니다.");
        if (!p.date_start) throw new Error("date_start는 필수입니다.");
        if (!p.event_id){
          p.event_id = makeEventId(p.date_start);
          $("event_id").value = p.event_id;
        }
        if (!p.created_at) $("created_at").value = nowText();
        $("updated_at").value = nowText();

        const payload = collectPayload();
        const req = { mode: "events.upsert", payload };

        const out = await apiPost(req);
        setUiStatus("저장 완료", "ok");
        $("preview").textContent = JSON.stringify({ request:req, response:out }, null, 2);

      }catch(err){
        setUiStatus(err?.message || "저장 실패", "bad");
      }finally{
        $("btnSave").disabled = false;
      }
    });

    // init
    renderChips($("countries_chips"), [], ()=>{});
    renderChips($("tags_chips"), [], ()=>{});
    renderChips($("entity_refs_chips"), [], ()=>{});
    renderChips($("source_refs_chips"), [], ()=>{});
    syncPreview();
  </script>
</body>
</html>
