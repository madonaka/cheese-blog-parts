<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Cheese Admin · 결재</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f3f4f6;
      }
      .shell {
        max-width: 960px;
        margin: 1.5rem auto;
        padding: 1.5rem 1.25rem 2.5rem;
        border-radius: 18px;
        background: #ffffff;
        box-shadow: 0 14px 45px rgba(15, 23, 42, 0.12);
      }
      h1 {
        margin: 0 0 0.75rem;
        font-size: 1.5rem;
        letter-spacing: -0.02em;
      }
      .subtitle {
        margin: 0 0 1.5rem;
        font-size: 0.9rem;
        color: #6b7280;
      }
      .tabs {
        display: inline-flex;
        border-radius: 999px;
        background: #e5e7eb;
        padding: 0.15rem;
        margin-bottom: 1rem;
      }
      .tab-btn {
        border: 0;
        background: transparent;
        padding: 0.4rem 0.95rem;
        border-radius: 999px;
        font-size: 0.85rem;
        cursor: pointer;
        color: #4b5563;
      }
      .tab-btn.active {
        background: #111827;
        color: #f9fafb;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 0.5rem;
      }
      thead {
        background: #f9fafb;
      }
      th, td {
        padding: 0.55rem 0.6rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }
      th {
        font-weight: 600;
        color: #4b5563;
      }
      tbody tr:nth-child(even) {
        background: #f9fafb;
      }
      tbody tr:hover {
        background: #eef2ff;
      }
      .amount {
        text-align: right;
      }
      .btn {
        border-radius: 999px;
        border: 0;
        padding: 0.3rem 0.9rem;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .btn-primary {
        background: #2563eb;
        color: #f9fafb;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .loading {
        font-size: 0.85rem;
        color: #6b7280;
        margin: 0.25rem 0 0.35rem;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <h1>Cheese Admin · 결재</h1>
      <p class="subtitle">
        구글 시트의 예산요청 / 지출정산 데이터를 읽어와서 여기서 바로 승인할 수 있는 간단한 관리 화면입니다.
      </p>

      <div class="tabs">
        <button id="tab-req" class="tab-btn active" onclick="switchTab('req')">
          예산요청 (submitted)
        </button>
        <button id="tab-exp" class="tab-btn" onclick="switchTab('exp')">
          지출정산 (submitted)
        </button>
      </div>

      <!-- 예산요청 테이블 -->
      <div id="view-req">
        <div id="req-status" class="loading">예산요청 목록을 불러오는 중...</div>
        <table>
          <thead>
            <tr>
              <th>request_id</th>
              <th>budget_id</th>
              <th>제목</th>
              <th>금액</th>
              <th>요청자</th>
              <th>요청일</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="req-tbody"></tbody>
        </table>
      </div>

      <!-- 지출 정산 테이블 -->
      <div id="view-exp" style="display:none;">
        <div id="exp-status" class="loading">지출 정산 목록을 불러오는 중...</div>
        <table>
          <thead>
            <tr>
              <th>expense_id</th>
              <th>request_id</th>
              <th>거래처</th>
              <th>금액</th>
              <th>요청자</th>
              <th>요청일</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="exp-tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // Apps Script Web App URL ( /exec 까지 복붙 )
      // 실제 배포된 Web App의 /exec URL로 바꿔 주세요.
      const API_BASE = 'https://script.google.com/macros/s/___YOUR_WEB_APP_ID___/exec';

      // 탭 전환
      function switchTab(tab) {
        document.getElementById('view-req').style.display = (tab === 'req') ? '' : 'none';
        document.getElementById('view-exp').style.display = (tab === 'exp') ? '' : 'none';

        document.getElementById('tab-req').classList.toggle('active', tab === 'req');
        document.getElementById('tab-exp').classList.toggle('active', tab === 'exp');
      }

      // ===== 예산요청 목록 로딩 =====
      async function loadBudgetRequests() {
        const statusEl = document.getElementById('req-status');
        const tbody = document.getElementById('req-tbody');

        statusEl.textContent = '예산요청 목록을 불러오는 중...';
        tbody.innerHTML = '';

        try {
          const res = await fetch(API_BASE + '?mode=budgetList');
          if (!res.ok) throw new Error('HTTP ' + res.status);

          const json = await res.json();
          if (!json.ok) {
            throw new Error(json.error || 'API 에러');
          }

          const rows = json.data || [];

          if (!rows.length) {
            statusEl.textContent = '결재 대기 중인 예산요청이 없습니다.';
            return;
          }

          statusEl.textContent = '';

          rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.request_id}</td>
              <td>${r.budget_id}</td>
              <td>${r.title}</td>
              <td class="amount">${r.amount}</td>
              <td>${r.requester}</td>
              <td>${r.requested_at ? new Date(r.requested_at).toLocaleDateString() : ''}</td>
              <td>
                <button class="btn btn-primary" onclick="approveBudget('${r.request_id}')">
                  승인
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

        } catch (err) {
          console.error('loadBudgetRequests ERROR:', err);
          alert('예산요청 목록 로딩 실패:\n' + err.message);
          statusEl.textContent = '목록 로딩 중 에러';
        }
      }

      // ===== 지출 정산 목록 로딩 =====
      async function loadExpenses() {
        const statusEl = document.getElementById('exp-status');
        const tbody = document.getElementById('exp-tbody');

        statusEl.textContent = '지출 정산 목록을 불러오는 중...';
        tbody.innerHTML = '';

        try {
          const res = await fetch(API_BASE + '?mode=expenseList');
          if (!res.ok) throw new Error('HTTP ' + res.status);

          const json = await res.json();
          if (!json.ok) {
            throw new Error(json.error || 'API 에러');
          }

          const rows = json.data || [];

          if (!rows.length) {
            statusEl.textContent = '결재 대기 중인 지출 정산이 없습니다.';
            return;
          }

          statusEl.textContent = '';

          rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${r.expense_id}</td>
              <td>${r.request_id}</td>
              <td>${r.date}</td>
              <td>${r.vendor}</td>
              <td class="amount">${r.amount}</td>
              <td>${r.requester}</td>
              <td>${r.requested_at ? new Date(r.requested_at).toLocaleDateString() : ''}</td>
              <td>
                <button class="btn btn-primary" onclick="approveExpense('${r.expense_id}')">
                  승인
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });

        } catch (err) {
          console.error('loadExpenses ERROR:', err);
          alert('지출 정산 목록 로딩 실패:\n' + err.message);
          statusEl.textContent = '목록 로딩 중 에러';
        }
      }

      // ===== 예산요청 승인 (fetch) =====
      async function approveBudget(requestId) {
        if (!confirm(`예산요청 ${requestId} 를 승인하시겠습니까?`)) return;

        try {
          const res = await fetch(
            API_BASE + '?mode=approveBudget&requestId=' + encodeURIComponent(requestId)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'API 에러');

          alert('승인 완료: ' + (json.data && json.data.message ? json.data.message : 'ok'));
          await loadBudgetRequests();  // 목록 다시 로딩

        } catch (err) {
          console.error('approveBudget ERROR:', err);
          alert('예산요청 승인 실패:\n' + err.message);
        }
      }

      // ===== 지출 정산 승인 (fetch) =====
      async function approveExpense(expenseId) {
        if (!confirm(`지출 정산 ${expenseId} 를 승인하시겠습니까?`)) return;

        try {
          const res = await fetch(
            API_BASE + '?mode=approveExpense&expenseId=' + encodeURIComponent(expenseId)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || 'API 에러');

          alert('승인 완료: ' + (json.data && json.data.message ? json.data.message : 'ok'));
          await loadExpenses();

        } catch (err) {
          console.error('approveExpense ERROR:', err);
          alert('지출 정산 승인 실패:\n' + err.message);
        }
      }

      // 페이지 로드시 두 목록 모두 로딩
      document.addEventListener('DOMContentLoaded', () => {
        loadBudgetRequests();
        loadExpenses();
      });
    </script>
  </body>
</html>
