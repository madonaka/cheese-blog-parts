<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Cheese Admin · 결재</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f3f4f6;
      }
      .shell {
        max-width: 960px;
        margin: 1.5rem auto;
        padding: 1.5rem;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(15,23,42,0.12);
      }
      h1 {
        font-size: 1.4rem;
        margin: 0 0 0.5rem;
      }
      .sub {
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 1.2rem;
      }
      .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .tab-btn {
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        font-size: 0.85rem;
        cursor: pointer;
      }
      .tab-btn.active {
        background: #1f2937;
        color: #f9fafb;
        border-color: #1f2937;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      thead {
        background: #f3f4f6;
      }
      th, td {
        padding: 0.4rem 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }
      th {
        font-weight: 600;
        color: #374151;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-size: 0.7rem;
        background: #fef3c7;
        color: #92400e;
      }
      .btn {
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .btn-primary {
        background: #2563eb;
        border-color: #2563eb;
        color: #ffffff;
      }
      .empty {
        font-size: 0.85rem;
        color: #9ca3af;
        padding: 0.6rem 0;
      }
      .loading {
        font-size: 0.85rem;
        color: #6b7280;
        padding: 0.6rem 0;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <h1>Cheese Admin · 결재</h1>
      <div class="sub">
        구글 시트의 예산요청 / 지출정산 데이터를 읽어와서
        여기서 바로 <strong>승인</strong>할 수 있는 간단한 관리 화면입니다.
      </div>

      <div class="tabs">
        <button class="tab-btn active" id="tab-req" onclick="switchTab('req')">
          예산요청 (submitted)
        </button>
        <button class="tab-btn" id="tab-exp" onclick="switchTab('exp')">
          지출정산 (submitted)
        </button>
      </div>

      <!-- 예산요청 테이블 -->
      <div id="view-req">
        <div id="req-status" class="loading">예산요청 목록을 불러오는 중...</div>
        <table>
          <thead>
            <tr>
              <th>request_id</th>
              <th>budget_id</th>
              <th>제목</th>
              <th>금액</th>
              <th>요청자</th>
              <th>요청일</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="req-tbody"></tbody>
        </table>
      </div>

      <!-- 지출정산 테이블 -->
      <div id="view-exp" style="display:none;">
        <div id="exp-status" class="loading">지출 정산 목록을 불러오는 중...</div>
        <table>
          <thead>
            <tr>
              <th>expense_id</th>
              <th>request_id</th>
              <th>거래처</th>
              <th>금액</th>
              <th>요청자</th>
              <th>요청일</th>
              <th>동작</th>
            </tr>
          </thead>
          <tbody id="exp-tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      function switchTab(tab) {
        document.getElementById('view-req').style.display = (tab === 'req') ? '' : 'none';
        document.getElementById('view-exp').style.display = (tab === 'exp') ? '' : 'none';

        document.getElementById('tab-req').classList.toggle('active', tab === 'req');
        document.getElementById('tab-exp').classList.toggle('active', tab === 'exp');
      }

      // ===== 예산요청 목록 로딩 =====
      function loadBudgetRequests() {
        document.getElementById('req-status').textContent = '예산요청 목록을 불러오는 중...';
      
        google.script.run
          .withSuccessHandler(function(rows) {
            const tbody = document.getElementById('req-tbody');
            tbody.innerHTML = '';
      
            if (!rows || rows.length === 0) {
              document.getElementById('req-status').textContent = '결재 대기 중인 예산요청이 없습니다.';
              return;
            }
            document.getElementById('req-status').textContent = '';
      
            rows.forEach(function(r) {
              const tr = document.createElement('tr');
      
              tr.innerHTML = `
                <td>${r.request_id}</td>
                <td>${r.budget_id}</td>
                <td>${r.title || ''}</td>
                <td>${(r.amount || '').toLocaleString()}</td>
                <td>${r.requester || ''}</td>
                <td>${r.requested_at || ''}</td>
                <td>
                  <button class="btn btn-primary" onclick="approveRequest('${r.request_id}')">
                    승인
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          })
          .withFailureHandler(function(err) {
            console.error(err);
            alert('예산요청 목록을 불러오다가 에러가 발생했습니다:\n' + err);
            document.getElementById('req-status').textContent = '목록 로딩 중 에러';
          })
          .getSubmittedBudgetRequestsForWeb();
      }

      function approveRequest(requestId) {
        if (!confirm('이 예산요청을 승인할까요?\nrequest_id: ' + requestId)) return;

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result !== 'ok') {
              alert(result);
            } else {
              alert('승인 완료: ' + requestId);
            }
            loadBudgetRequests(); // 목록 갱신
          })
          .approveBudgetRequestById(requestId);
      }

      // ===== 지출정산 목록 로딩 =====
      function loadExpenses() {
        document.getElementById('exp-status').textContent = '지출 정산 목록을 불러오는 중...';
      
        google.script.run
          .withSuccessHandler(function(rows) {
            const tbody = document.getElementById('exp-tbody');
            tbody.innerHTML = '';
      
            if (!rows || rows.length === 0) {
              document.getElementById('exp-status').textContent = '결재 대기 중인 지출 정산이 없습니다.';
              return;
            }
            document.getElementById('exp-status').textContent = '';
      
            rows.forEach(function(r) {
              const tr = document.createElement('tr');
      
              tr.innerHTML = `
                <td>${r.expense_id}</td>
                <td>${r.request_id}</td>
                <td>${r.vendor || ''}</td>
                <td>${(r.amount || '').toLocaleString()}</td>
                <td>${r.requester || ''}</td>
                <td>${r.requested_at || ''}</td>
                <td>
                  <button class="btn btn-primary" onclick="approveExpense('${r.expense_id}')">
                    승인
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          })
          .withFailureHandler(function(err) {
            console.error(err);
            alert('지출 정산 목록을 불러오다가 에러가 발생했습니다:\n' + err);
            document.getElementById('exp-status').textContent = '목록 로딩 중 에러';
          })
          .getSubmittedExpensesForWeb();
      }

      function approveExpense(expenseId) {
        if (!confirm('이 지출 정산을 승인할까요?\nexpense_id: ' + expenseId)) return;

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result !== 'ok') {
              alert(result);
            } else {
              alert('승인 완료: ' + expenseId);
            }
            loadExpenses(); // 목록 갱신
          })
          .approveExpenseById(expenseId);
      }

      // 페이지 로드 시 자동 실행
      document.addEventListener('DOMContentLoaded', function() {
        loadBudgetRequests();
        loadExpenses();
      });
    </script>
  </body>
</html>
