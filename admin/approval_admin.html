<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>결재 관리 · Cheese Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- 공통 관리자 스타일 -->
    <link rel="stylesheet" href="./admin.css" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
      }

      .approval-shell {
        padding: 1.5rem 1.5rem 2rem;
        box-sizing: border-box;
      }

      .approval-header-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0 0 0.4rem;
        letter-spacing: -0.02em;
      }

      .approval-header-sub {
        margin: 0 0 1.2rem;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .approval-tabs {
        display: inline-flex;
        border-radius: 999px;
        background: #e5e7eb;
        padding: 0.15rem;
        margin-bottom: 1rem;
      }

      .approval-tab-btn {
        border: 0;
        background: transparent;
        padding: 0.4rem 0.95rem;
        border-radius: 999px;
        font-size: 0.8rem;
        cursor: pointer;
        color: #4b5563;
      }

      .approval-tab-btn.active {
        background: #111827;
        color: #f9fafb;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
      }

      .approval-loading {
        font-size: 0.8rem;
        color: #6b7280;
        margin: 0.2rem 0 0.4rem;
      }

      .approval-table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-top: 0.25rem;
        border-radius: 0.75rem;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        background: #ffffff;
      }

      .approval-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
        min-width: 720px;
      }

      .approval-table thead {
        background: #f9fafb;
      }

      .approval-table th,
      .approval-table td {
        padding: 0.55rem 0.6rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }

      .approval-table th {
        font-weight: 600;
        color: #4b5563;
      }

      .approval-table tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      .approval-table tbody tr:hover {
        background: #eef2ff;
      }

      .approval-amount {
        text-align: right;
      }

      .btn {
        border-radius: 999px;
        border: 0;
        padding: 0.3rem 0.9rem;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .btn-primary {
        background: #2563eb;
        color: #f9fafb;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-ghost {
        background: transparent;
        color: #4b5563;
      }

      @media (max-width: 768px) {
        .admin-main {
          flex-direction: column;
        }
        .admin-sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #e5e7eb;
        }
        .admin-content {
          width: 100%;
          padding: 1rem;
          box-sizing: border-box;
        }
        .approval-shell {
          padding: 1rem 0.5rem 1.5rem;
        }
        .approval-header-title {
          font-size: 1.15rem;
        }
        .approval-header-sub {
          font-size: 0.8rem;
        }
        .approval-tabs {
          width: 100%;
          justify-content: space-between;
        }
        .approval-tab-btn {
          flex: 1 1 0;
          text-align: center;
          padding: 0.45rem 0.3rem;
          font-size: 0.78rem;
        }
        .approval-table-wrapper {
          margin: 0.3rem -0.5rem 0;
          padding: 0 0.5rem;
          border-radius: 0.5rem;
        }
        .approval-table {
          min-width: 640px;
          font-size: 0.78rem;
        }
        .btn {
          padding: 0.25rem 0.7rem;
          font-size: 0.78rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- 화면 권한 제어 -->
    <script>
      window.CHEESE_ADMIN_REQUIRED_ROLES = ["FIN", "MGR", "ADMIN"];
    </script>

    <div class="admin-shell">
      <div id="admin-header-slot"></div>

      <div class="admin-main">
        <aside id="admin-menu-slot" class="admin-sidebar"></aside>

        <main class="admin-content">
          <div class="approval-shell">
            <h1 class="approval-header-title">결재 관리</h1>
            <p class="approval-header-sub">
              구글 시트의 예산요청 / 지출정산 시트를 읽어와, 제출된 항목만 여기서
              바로 승인할 수 있습니다.
            </p>

            <div class="approval-tabs">
              <button
                id="tab-req"
                class="approval-tab-btn active"
                onclick="switchTab('req')"
              >
                예산요청 (submitted)
              </button>
              <button
                id="tab-exp"
                class="approval-tab-btn"
                onclick="switchTab('exp')"
              >
                지출정산 (submitted)
              </button>
            </div>

            <section id="view-req">
              <div id="req-status" class="approval-loading">
                예산요청 목록을 불러오는 중...
              </div>
              <div class="approval-table-wrapper">
                <table class="approval-table">
                  <thead>
                    <tr>
                      <th>request_id</th>
                      <th>budget_id</th>
                      <th>제목</th>
                      <th>금액</th>
                      <th>요청자</th>
                      <th>요청일</th>
                      <th>동작</th>
                    </tr>
                  </thead>
                  <tbody id="req-tbody"></tbody>
                </table>
              </div>
            </section>

            <section id="view-exp" style="display: none">
              <div id="exp-status" class="approval-loading">
                지출 정산 목록을 불러오는 중...
              </div>
              <div class="approval-table-wrapper">
                <table class="approval-table">
                  <thead>
                    <tr>
                      <th>expense_id</th>
                      <th>request_id</th>
                      <th>거래처</th>
                      <th>금액</th>
                      <th>증빙</th>
                      <th>요청자</th>
                      <th>요청일</th>
                      <th>동작</th>
                    </tr>
                  </thead>
                  <tbody id="exp-tbody"></tbody>
                </table>
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>

    <script src="./admin-common.js" defer></script>

    <script>
      const API_BASE =
        "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";

      // ✅ 결재자 식별자 가져오기 (결재선 steps.userId가 employeeId라면 이 값이 맞아야 함)
      function getActor_() {
        return (window.CHEESE_ADMIN_EMPLOYEE_ID ||
          window.CHEESE_ADMIN_LOGIN_ID ||
          "").trim();
      }

      function switchTab(tab) {
        document.getElementById("view-req").style.display =
          tab === "req" ? "" : "none";
        document.getElementById("view-exp").style.display =
          tab === "exp" ? "" : "none";

        document
          .getElementById("tab-req")
          .classList.toggle("active", tab === "req");
        document
          .getElementById("tab-exp")
          .classList.toggle("active", tab === "exp");
      }

      // ---------------- 예산요청 목록 로딩 ----------------
      async function loadBudgetRequests() {
        const statusEl = document.getElementById("req-status");
        const tbody = document.getElementById("req-tbody");

        statusEl.textContent = "예산요청 목록을 불러오는 중...";
        tbody.innerHTML = "";

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE + "?mode=budgetInbox&actor=" + encodeURIComponent(actor)
          );
          if (!res.ok) throw new Error("HTTP " + res.status);

          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const rows = json.data || [];
          if (!rows.length) {
            statusEl.textContent = "결재 대기 중인 예산요청이 없습니다.";
            return;
          }

          statusEl.textContent = "";

          rows.forEach((r) => {
            const tr = document.createElement("tr");

            const actorKey = String(actor).trim().toLowerCase();
            const currentId = String(r.current_approver_id || "")
              .trim()
              .toLowerCase();

            const canAct =
              r.status === "submitted" &&
              actorKey &&
              currentId &&
              actorKey === currentId;

            const actionHtml = canAct
              ? `
                <button class="btn btn-primary" onclick="approveBudget('${r.request_id}')">승인</button>
                <button class="btn" onclick="rejectBudget('${r.request_id}')">반려</button>
              `
              : `<span style="color:#6b7280;font-size:0.78rem;">대기중: ${
                  r.current_approver || "-"
                }</span>`;

            tr.innerHTML = `
              <td>${r.request_id ?? ""}</td>
              <td>${r.budget_id ?? ""}</td>
              <td>${r.title ?? ""}</td>
              <td class="approval-amount">${r.requested_amount ?? ""}</td>
              <td>${r.requester ?? ""}</td>
              <td>${
                r.requested_at ? new Date(r.requested_at).toLocaleDateString() : ""
              }</td>
              <td>${actionHtml}</td>
            `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("loadBudgetRequests ERROR:", err);
          alert("예산요청 목록 로딩 실패:\n" + err.message);
          statusEl.textContent = "목록 로딩 중 에러";
        }
      }

      // ---------------- 지출정산 목록 로딩 ----------------
      async function loadExpenses() {
        const statusEl = document.getElementById("exp-status");
        const tbody = document.getElementById("exp-tbody");

        statusEl.textContent = "지출 정산 목록을 불러오는 중...";
        tbody.innerHTML = "";

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE + "?mode=expenseInbox&actor=" + encodeURIComponent(actor)
          );
          if (!res.ok) throw new Error("HTTP " + res.status);

          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const rows = json.data || [];
          if (!rows.length) {
            statusEl.textContent = "결재 대기 중인 지출 정산이 없습니다.";
            return;
          }

          statusEl.textContent = "";

          rows.forEach((r) => {
            const tr = document.createElement("tr");

            const actorKey = String(actor).trim().toLowerCase();
            const currentId = String(r.current_approver_id || "")
              .trim()
              .toLowerCase();

            const canAct =
              r.status === "submitted" &&
              actorKey &&
              currentId &&
              actorKey === currentId;

            const evidenceHtml = r.evidence_link
              ? `<a href="${r.evidence_link}" target="_blank" rel="noopener noreferrer">보기</a>`
              : "-";

            const actionHtml = canAct
              ? `
                <button class="btn btn-primary" onclick="approveExpense('${r.expense_id}')">승인</button>
                <button class="btn btn-ghost" type="button" onclick="rejectExpense('${r.expense_id}')">반려</button>
              `
              : `<span style="color:#6b7280;font-size:0.78rem;">대기중: ${
                  r.current_approver || "-"
                }</span>`;

            tr.innerHTML = `
              <td>${r.expense_id ?? ""}</td>
              <td>${r.request_id ?? ""}</td>
              <td>${r.vendor ?? r.merchant ?? ""}</td>
              <td class="approval-amount">${r.requested_amount ?? r.amount ?? ""}</td>
              <td>${evidenceHtml}</td>
              <td>${r.requester ?? ""}</td>
              <td>${
                r.requested_at ? new Date(r.requested_at).toLocaleDateString() : ""
              }</td>
              <td>${actionHtml}</td>
            `;

            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error("loadExpenses ERROR:", err);
          alert("지출 정산 목록 로딩 실패:\n" + err.message);
          statusEl.textContent = "목록 로딩 중 에러";
        }
      }

      // ---------------- 예산요청 승인 ----------------
      async function approveBudget(requestId) {
        if (!confirm(`예산요청 ${requestId} 를 승인하시겠습니까?`)) return;

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE +
              "?mode=approveBudget" +
              "&requestId=" +
              encodeURIComponent(requestId) +
              "&actor=" +
              encodeURIComponent(actor)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          alert("승인 완료");
          await loadBudgetRequests();
        } catch (err) {
          console.error("approveBudget ERROR:", err);
          alert("예산요청 승인 실패:\n" + err.message);
        }
      }

      // ---------------- 예산요청 반려 ----------------
      async function rejectBudget(requestId) {
        const reason = prompt(
          `예산요청 ${requestId} 를 반려합니다.\n반려 사유를 입력해 주세요:`
        );
        if (reason === null) return;

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE +
              "?mode=rejectBudget" +
              "&requestId=" +
              encodeURIComponent(requestId) +
              "&reason=" +
              encodeURIComponent(reason) +
              "&actor=" +
              encodeURIComponent(actor)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          alert("반려 완료");
          await loadBudgetRequests();
        } catch (err) {
          console.error("rejectBudget ERROR:", err);
          alert("예산요청 반려 실패:\n" + err.message);
        }
      }

      // ---------------- 지출정산 승인 ----------------
      async function approveExpense(expenseId) {
        if (!confirm(`지출 정산 ${expenseId} 를 승인하시겠습니까?`)) return;

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE +
              "?mode=approveExpense" +
              "&expenseId=" +
              encodeURIComponent(expenseId) +
              "&actor=" +
              encodeURIComponent(actor)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          alert("승인 완료");
          await loadExpenses();
        } catch (err) {
          console.error("approveExpense ERROR:", err);
          alert("지출 정산 승인 실패:\n" + err.message);
        }
      }

      // ---------------- 지출정산 반려 ----------------
      async function rejectExpense(expenseId) {
        const reason = prompt(
          `지출 정산 ${expenseId} 를 반려합니다.\n반려 사유를 입력해 주세요:`
        );
        if (reason === null) return;

        try {
          const actor = getActor_();
          const res = await fetch(
            API_BASE +
              "?mode=rejectExpense" +
              "&expenseId=" +
              encodeURIComponent(expenseId) +
              "&reason=" +
              encodeURIComponent(reason) +
              "&actor=" +
              encodeURIComponent(actor)
          );
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          alert("반려 완료");
          await loadExpenses();
        } catch (err) {
          console.error("rejectExpense ERROR:", err);
          alert("지출 정산 반려 실패:\n" + err.message);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadBudgetRequests();
        loadExpenses();
      });
    </script>
  </body>
</html>
