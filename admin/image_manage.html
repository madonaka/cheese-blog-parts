<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>이미지 관리 툴</title>

  <!-- ✅ 메인 관리자 CSS 재사용 (head에 두는 게 안전) -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles (admin.css 위에 얹는 최소 스타일) ===== */
    .im-wrap{ padding:14px; }
    .im-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .im-title{ font-weight:900; font-size:16px; margin:0 0 10px; }
    .im-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0; }
    .im-label{ font-weight:800; min-width:120px; }
    .im-input{ padding:10px 12px; border:1px solid rgba(15,23,42,0.2); border-radius:10px; }
    .im-range{ width:220px; }
    .im-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .im-btn.primary{
      background:rgba(59,130,246,.12);
      border-color:rgba(59,130,246,.35);
    }
    .im-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .im-help{ opacity:.75; font-size:12px; line-height:1.4; }

    .im-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .im-grid{ grid-template-columns:1fr; }
      .im-label{ min-width:auto; }
    }

    .im-chiprow{ display:flex; gap:8px; flex-wrap:wrap; }
    .im-chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.2);
      background:#fff;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .im-chip.on{
      background:rgba(59,130,246,.15);
      border-color:rgba(59,130,246,.35);
      font-weight:900;
    }

    /* 선택 강조 */
    .im-selected{
      outline:3px solid rgba(59,130,246,.9);
      border-radius:12px;
    }

    /* 이미지 클릭 안내 */
    .im-clickhint{
      opacity:.7;
      font-weight:700;
      font-size:12px;
      margin-left:6px;
    }

    /* 이미지가 링크라는 걸 더 명확히 */
    .im-preview-link img{ cursor:zoom-in; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="im-wrap">

          <div class="im-card">
            <h1 class="im-title">이미지 40% / 50% / 60% 미리보기 (클릭 시 새 창)</h1>
            <p class="im-help">
              업로드 전에 브라우저에서 리사이즈 + (선택) 블러 + (선택) 워터마크를 적용한 결과물을 생성합니다.
              미리보기 이미지를 클릭하면 새 창(탭)에서 원본 크기로 확인할 수 있습니다.
            </p>

            <div class="im-row">
              <div class="im-label">원본 이미지</div>
              <input id="imgFile" class="im-input" type="file" accept="image/*" />
            </div>

            <div class="im-row">
              <div class="im-label">워터마크 PNG</div>
              <input id="wmFile" class="im-input" type="file" accept="image/png" />
              <label style="display:flex; gap:8px; align-items:center;">
                <input id="wmOn" type="checkbox" checked />
                워터마크 적용
              </label>
            </div>

            <div class="im-row">
              <div class="im-label">JPEG 품질</div>
              <input id="jpegQ" class="im-range" type="range" min="0.4" max="0.9" step="0.01" value="0.72" />
              <span id="jpegQVal" style="font-weight:900;">0.72</span>
              <span class="im-help">낮을수록 용량↓ / 글자 뭉개짐↑</span>
            </div>

            <div class="im-row">
              <div class="im-label">미세 블러(px)</div>
              <input id="blurPx" class="im-range" type="range" min="0" max="1.2" step="0.1" value="0.5" />
              <span id="blurPxVal" style="font-weight:900;">0.5</span>
              <span class="im-help">0.4~0.6부터 권장</span>
            </div>

            <div class="im-row">
              <div class="im-label">워터마크 투명도</div>
              <input id="wmAlpha" class="im-range" type="range" min="0.00" max="1.00" step="0.01" value="0.25" />
              <span id="wmAlphaVal" style="font-weight:900;">0.25</span>
              <span class="im-help">낮을수록 약하게 보임 (1.00 = 워터마크 원본 그대로)</span>
            </div>

            <!-- ✅ 문구(사용자 입력) + 버전 표기 옵션 -->
            <div class="im-row">
              <div class="im-label">표시 문구</div>
              <input id="noteText" class="im-input" type="text"
                     value="원본은 고화질입니다"
                     placeholder="예: 원본은 고화질입니다" />
              <label style="display:flex; gap:8px; align-items:center;">
                <input id="noteOn" type="checkbox" checked />
                우측 상단 표시
              </label>
              <span class="im-help">자동으로 “원본 대비 % / 블러 px”가 붙고, 위에 “VYYYYMMDD”가 표시됩니다.</span>
            </div>

            <div class="im-row" style="margin-top:12px;">
              <button id="btnMakePreviews" class="im-btn primary" type="button">
                40% / 50% / 60% 미리보기 생성
              </button>
              <button id="btnUploadSelected" class="im-btn" type="button" disabled>
                선택한 미리보기 업로드
              </button>
            </div>

            <div class="im-row">
              <div class="im-label">업로드 선택</div>
              <div id="scalePick" class="im-chiprow"></div>
              <span class="im-help">칩(40/50/60)을 눌러 업로드 대상을 바꿀 수 있어요.</span>
            </div>

            <div id="previewGrid" class="im-grid"></div>
          </div>

          <div class="im-card">
            <h2 class="im-title" style="font-size:14px;">업로드 연결 안내</h2>
            <p class="im-help">
              현재 파일은 “미리보기 생성 + 새 창 확인 + 업로드 대상 선택”까지 포함합니다.
              “선택한 미리보기 업로드” 버튼 클릭 시점에 Apps Script(WebApp)로 전송하는 코드를 붙이면 끝입니다.
            </p>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

  <script>
  (() => {
    // ====== DOM ======
    const $file   = document.getElementById("imgFile");
    const $wmFile = document.getElementById("wmFile");
    const $wmOn   = document.getElementById("wmOn");

    const $jpegQ = document.getElementById("jpegQ");
    const $jpegQVal = document.getElementById("jpegQVal");
    const $blurPx = document.getElementById("blurPx");
    const $blurPxVal = document.getElementById("blurPxVal");

    const $wmAlpha = document.getElementById("wmAlpha");
    const $wmAlphaVal = document.getElementById("wmAlphaVal");

    // ✅ 문구/표시 옵션
    const $noteText = document.getElementById("noteText");
    const $noteOn = document.getElementById("noteOn");

    const $btnMake = document.getElementById("btnMakePreviews");
    const $btnUpload = document.getElementById("btnUploadSelected");
    const $grid = document.getElementById("previewGrid");
    const $scalePick = document.getElementById("scalePick");

    $jpegQ.addEventListener("input", () => $jpegQVal.textContent = Number($jpegQ.value).toFixed(2));
    $blurPx.addEventListener("input", () => $blurPxVal.textContent = Number($blurPx.value).toFixed(1));
    $wmAlpha.addEventListener("input", () => $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2));
    $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2);

    // ====== 상태 ======
    const SCALES = [0.4, 0.5, 0.6];
    let sourceImg = null;     // HTMLImageElement
    let watermarkImg = null;  // HTMLImageElement

    // previews: scale -> { blob, url, w, h, bytes }
    const previews = new Map();
    let selectedScale = null;

    function revokeAllPreviewUrls() {
      for (const v of previews.values()) {
        if (v.url) URL.revokeObjectURL(v.url);
      }
      previews.clear();
    }

    function loadFileAsImage(file) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("image load fail")); };
        img.src = url;
      });
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function versionToday() {
      const d = new Date();
      return `V${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    }

    function drawTopRightLabel(ctx, tw, th, lines) {
      // lines: ["V20260126", "문구 ..."]
      const pad = Math.max(10, Math.round(tw * 0.015));
      const fontSize = Math.max(12, Math.round(tw * 0.024));
      const lineGap = Math.max(4, Math.round(fontSize * 0.25));

      ctx.save();
      ctx.font = `900 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = "top";

      // 각 줄 너비 측정
      const measures = lines.map(t => ({ t, w: Math.ceil(ctx.measureText(t).width) }));
      const boxW = Math.max(...measures.map(m => m.w));
      const boxH = Math.ceil(lines.length * fontSize * 1.15 + (lines.length - 1) * lineGap);

      const x = tw - pad - boxW;
      const y = pad;

      // 배경 박스
      ctx.globalAlpha = 0.55;
      ctx.fillStyle = "#000";
      ctx.fillRect(x - 10, y - 8, boxW + 20, boxH + 16);

      // 텍스트
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#fff";

      let cy = y;
      for (const m of measures) {
        // 우측 정렬(줄마다 길이 달라도 오른쪽 맞춤)
        const tx = tw - pad - m.w;
        ctx.fillText(m.t, tx, cy);
        cy += Math.ceil(fontSize * 1.15) + lineGap;
      }

      ctx.restore();
    }

    async function renderPreviewBlob(scale) {
      if (!sourceImg) throw new Error("source image not loaded");

      const blur = Number($blurPx.value) || 0;
      const q = Number($jpegQ.value) || 0.72;

      const sw = sourceImg.naturalWidth;
      const sh = sourceImg.naturalHeight;

      const tw = Math.max(1, Math.round(sw * scale));
      const th = Math.max(1, Math.round(sh * scale));

      const canvas = document.createElement("canvas");
      canvas.width = tw;
      canvas.height = th;

      const ctx = canvas.getContext("2d", { alpha: false });

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      // 1) 다운스케일 + (선택) 블러
      ctx.filter = blur > 0 ? `blur(${blur}px)` : "none";
      ctx.drawImage(sourceImg, 0, 0, tw, th);
      ctx.filter = "none";

      // 2) 워터마크 오버레이(cover)
      if ($wmOn.checked && watermarkImg) {
        const WM_ALPHA = Number($wmAlpha.value);
        ctx.globalAlpha = Number.isFinite(WM_ALPHA) ? WM_ALPHA : 0.25;

        const iw = watermarkImg.naturalWidth;
        const ih = watermarkImg.naturalHeight;

        const s = Math.max(tw / iw, th / ih);
        const dw = iw * s;
        const dh = ih * s;

        const dx = (tw - dw) / 2;
        const dy = (th - dh) / 2;

        ctx.drawImage(watermarkImg, dx, dy, dw, dh);
        ctx.globalAlpha = 1;
      }

      // 3) 버전 + 사용자 문구(우측 상단)
      if ($noteOn?.checked) {
        const pct = Math.round(scale * 100);
        const base = ($noteText?.value || "").trim() || "원본은 고화질입니다";
        const blurPart = blur > 0 ? ` · 블러 ${blur.toFixed(1)}px` : "";
        const line1 = versionToday();
        const line2 = `${base} · 게시용: 원본 대비 ${pct}%${blurPart}`;
        drawTopRightLabel(ctx, tw, th, [line1, line2]);
      }

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), "image/jpeg", q);
      });

      if (!blob) throw new Error("toBlob failed");
      return { blob, w: tw, h: th, bytes: blob.size };
    }

    function makePreviewCard({ scale, url, w, h, bytes }) {
      const pct = Math.round(scale * 100);
      const sizeKB = Math.round(bytes / 1024);

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px;">
          ${pct}% · ${w}×${h} · ${sizeKB}KB
          <span class="im-clickhint">(이미지 클릭 → 새 창)</span>
        </div>

        <div class="cheese-img-wrapper" data-scale="${scale}">
          <div class="cheese-img-inner">
            <a class="im-preview-link" href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="">
            </a>
          </div>
          <div class="im-help" style="margin-top:6px;">
            업로드 대상: 아래 칩(40/50/60) 선택 또는 카드 선택 버튼 사용
          </div>
        </div>

        <button type="button" class="im-btn pick-btn" style="margin-top:8px; width:100%;">
          이 버전 선택(업로드 대상)
        </button>
      `;

      wrap.querySelector(".pick-btn").addEventListener("click", () => {
        selectedScale = scale;
        highlightSelected();
        $btnUpload.disabled = false;
      });

      return wrap;
    }

    function renderScaleChips() {
      $scalePick.innerHTML = SCALES.map(s => {
        const pct = Math.round(s * 100);
        const on = selectedScale === s;
        return `<span class="im-chip ${on ? "on" : ""}" data-scale="${s}">${pct}%</span>`;
      }).join("");

      // 칩 클릭 시 선택 변경
      $scalePick.querySelectorAll(".im-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const sc = Number(chip.getAttribute("data-scale"));
          if (!previews.has(sc)) return; // 미리보기 생성 전이면 무시
          selectedScale = sc;
          highlightSelected();
          $btnUpload.disabled = false;
        });
      });
    }

    function highlightSelected() {
      const wrappers = $grid.querySelectorAll(".cheese-img-wrapper");
      wrappers.forEach(el => {
        const sc = Number(el.getAttribute("data-scale"));
        el.classList.toggle("im-selected", selectedScale === sc);
      });
      renderScaleChips();
    }

    // ====== 이벤트 ======
    $file.addEventListener("change", async () => {
      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";

      const f = $file.files?.[0];
      if (!f) return;

      try {
        sourceImg = await loadFileAsImage(f);
      } catch (e) {
        sourceImg = null;
        alert("원본 이미지 로딩 실패");
      }
    });

    $wmFile.addEventListener("change", async () => {
      const f = $wmFile.files?.[0];
      try {
        watermarkImg = f ? await loadFileAsImage(f) : null;
      } catch (e) {
        watermarkImg = null;
        alert("워터마크 이미지 로딩 실패");
      }
    });

    $btnMake.addEventListener("click", async () => {
      if (!sourceImg) {
        alert("원본 이미지를 먼저 선택해줘.");
        return;
      }

      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";

      try {
        // 40/50/60 모두 생성해 비교 가능하게 표시
        for (const s of SCALES) {
          const r = await renderPreviewBlob(s);
          const url = URL.createObjectURL(r.blob);
          previews.set(s, { ...r, url });
        }

        for (const s of SCALES) {
          const v = previews.get(s);
          $grid.appendChild(makePreviewCard({
            scale: s, url: v.url, w: v.w, h: v.h, bytes: v.bytes
          }));
        }

        // 기본 선택: 50%
        selectedScale = 0.5;
        renderScaleChips();
        highlightSelected();
        $btnUpload.disabled = false;

      } catch (e) {
        console.error(e);
        alert("미리보기 생성 실패: " + (e?.message || e));
      }
    });

    // ====== 업로드 연결 포인트 ======
    $btnUpload.addEventListener("click", async () => {
      if (selectedScale == null) return;
      const v = previews.get(selectedScale);
      if (!v) return;

      // TODO: 여기서 Apps Script WebApp 업로드 함수 연결
      // 예: await uploadToDrive(v.blob, { scale: selectedScale, ... });

      alert(
        `업로드 대상: ${Math.round(selectedScale*100)}%\n` +
        `크기: ${v.w}×${v.h}\n` +
        `용량: ${(v.bytes/1024).toFixed(0)}KB\n\n` +
        `※ 현재는 업로드 연결 전(데모) 상태`
      );
    });

    window.addEventListener("beforeunload", revokeAllPreviewUrls);
  })();
  </script>
</body>
</html>
