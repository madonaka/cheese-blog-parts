<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì´ë¯¸ì§€ ê´€ë¦¬ íˆ´</title>

  <!-- âœ… ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* [1. ë ˆì´ì•„ì›ƒ & ê³µí†µ ì»´í¬ë„ŒíŠ¸] */
    body { background-color: #f2f4f6; color: #333d4b; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-font-smoothing: antialiased; }
    .im-wrap { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .im-card { background: #fff; border: none; border-radius: 24px; padding: 28px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
    .im-title { font-weight: 700; font-size: 22px; color: #191f28; margin: 0 0 16px; letter-spacing: -0.4px; }
    .im-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 16px 0; }
    .im-label { font-weight: 600; min-width: 120px; color: #4e5968; font-size: 15px; }
    .im-help { color: #8b95a1; font-size: 13px; line-height: 1.6; margin-top: 4px; }
    .im-status { display: inline-block; padding: 6px 12px; border-radius: 8px; background: #f9fafb; font-weight: 700; font-size: 12px; color: #4e5968; }
    .im-status.ok { background: #e8f3ee; color: #00814d; }
    .im-status.bad { background: #fdf0f0; color: #e52e2e; }
  
    /* [2. ì…ë ¥ í¼ & ë²„íŠ¼] */
    .im-input { background-color: #f9fafb; border: 1px solid transparent; border-radius: 12px; padding: 14px 16px; transition: all 0.2s; font-size: 15px; width: 100%; box-sizing: border-box; }
    .im-input:focus { background-color: #fff; border-color: #3182f6; outline: none; box-shadow: 0 0 0 3px rgba(49,130,246,0.1); }
    .im-range { width: 220px; accent-color: #3182f6; cursor: pointer; }
    .im-btn { border: none; background: #f2f4f6; color: #4e5968; border-radius: 14px; padding: 14px 24px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
    .im-btn.primary { background: #3182f6; color: #fff; box-shadow: 0 4px 12px rgba(49,130,246,0.2); } 
    .im-btn:hover { filter: brightness(0.96); transform: translateY(-1px); }
    .im-btn:active { transform: scale(0.97); }
    .im-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    .im-smallbtn { background: #f2f4f6; border: none; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; font-size: 13px; color: #4e5968; }
  
    /* [3. ë¯¸ë¦¬ë³´ê¸° & ì¹© UI] */
    .im-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 24px; }
    .im-chiprow { display: flex; gap: 8px; flex-wrap: wrap; }
    .im-chip { padding: 10px 16px; border-radius: 12px; background: #f2f4f6; color: #4e5968; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; }
    .im-chip.on { background: #3182f6; color: #fff; box-shadow: 0 4px 10px rgba(49,130,246,0.15); }
    .im-selected { border: 3px solid #3182f6; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 24px rgba(49,130,246,0.2); }
    .im-clickhint { color: #8b95a1; font-weight: 500; font-size: 12px; margin-left: 6px; }
    .im-preview-link img { cursor: zoom-in; border-radius: 16px; width: 100%; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .im-preview-link img:hover { transform: scale(1.03); }
  
    /* [4. ê²°ê³¼ & ì•Œë¦¼] */
    .im-result { margin-top: 20px; padding: 24px; border-radius: 18px; background: #f9fafb; font-size: 14px; line-height: 1.6; color: #333d4b; border: 1px solid #edf1f5; }
    .im-toast { position: fixed; right: 24px; top: 24px; z-index: 10000; min-width: 300px; padding: 18px 24px; border-radius: 20px; background: #fff; box-shadow: 0 12px 40px rgba(0,0,0,0.15); font-weight: 700; font-size: 15px; opacity: 0; transform: translateY(-20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; border: none; }
    .im-toast.show { opacity: 1; transform: translateY(0); }
    .im-toast.ok { color: #00814d; border-left: 5px solid #00814d; }
    .im-toast.bad { color: #e52e2e; border-left: 5px solid #e52e2e; }
  
    /* [5. íƒ­ & ë‹¨ê³„ íë¦„ ì œì–´] */
    .im-tabs { display: flex; gap: 8px; margin-bottom: 28px; background: #e8eaed; padding: 6px; border-radius: 18px; width: fit-content; }
    .im-tab { border: none; background: transparent; border-radius: 14px; padding: 10px 22px; cursor: pointer; font-weight: 700; color: #8b95a1; transition: all 0.25s; font-size: 14px; }
    .im-tab.on { background: #fff; color: #3182f6; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .im-panel { display: none; }
    .im-panel.on { display: block; animation: slideUp 0.4s ease-out; }
    
    /* [6. ëª©ë¡ ë¦¬ìŠ¤íŠ¸] */
    .im-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .im-item { border: none; border-radius: 24px; padding: 24px; background: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.03); transition: all 0.3s; }
    .im-item:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .im-thumb { width: 100%; border-radius: 16px; display: block; margin: 16px 0; border: 1px solid #f2f4f6; }
    .im-item-fname { font-weight: 700; font-size: 18px; color: #191f28; line-height: 1.4; margin-bottom: 6px; }
    .im-item-id { font-weight: 600; font-size: 14px; color: #adb5bd; }
  
    /* [7. ìœ í‹¸ë¦¬í‹° & ì• ë‹ˆë©”ì´ì…˜] */
    .im-hidden { position: fixed; left: -9999px; visibility: hidden; }
    .im-hr { height: 1px; background: #f2f4f6; margin: 24px 0; border: none; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 980px) { .im-grid, .im-list { grid-template-columns: 1fr; } .im-label { min-width: auto; margin-bottom: 6px; } .im-row { flex-direction: column; align-items: flex-start; } .im-tabs { width: 100%; overflow-x: auto; } }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="im-wrap">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 8px; padding: 0 10px;">
            <span id="sysVersion" style="font-size: 11px; color: #8b95a1; font-weight: 700;"></span>
          </div>
          
       <!--âœ… íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="im-tabs">
          <button class="im-tab on" data-tab="1" type="button">1. íŒŒì¼ ì„ íƒ</button>
          <button class="im-tab" data-tab="2" type="button">2. í¸ì§‘ ì„¤ì •</button>
          <button class="im-tab" data-tab="3" type="button">3. ë¯¸ë¦¬ë³´ê¸°/ì „ì†¡</button>
          <button class="im-tab" data-tab="4" type="button">4. ë³´ê´€í•¨</button>
        </div>

       <!--âœ… Step 1: íŒŒì¼ ì„ íƒ íŒ¨ë„ (ID ë° íŒŒì¼ ì„ íƒ) -->
        <div id="panel-1" class="im-panel on">
          <div class="im-card">
            <h1 class="im-title">1. ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°</h1>
            <p class="im-help">ê°€ê³µí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ì €ì¥ ì˜µì…˜ì„ ì„¤ì •í•˜ì„¸ìš”.</p>
        
            <div class="im-row">
              <div class="im-label">íŒŒì¼ëª…(ê¸°ë³¸)</div>
              <input id="baseName" class="im-input" type="text" placeholder="ì˜ˆ: ìˆ™ì¢…_í™˜êµ­ì •ì¹˜_ë„í‘œ" value="" />
              <span class="im-help">íŒŒì¼ëª… ê·œì¹™: (ê¸°ë³¸ëª…)__Vë‚ ì§œ__Q%__ID.jpg</span>
            </div>
        
            <div class="im-row" style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 20px;">
              <div class="im-label">ì´ë¯¸ì§€ íŒŒì¼</div>
              <input id="imgFile" class="im-input" type="file" accept="image/*" style="width: 100%;" />
              
              <label style="display: flex; align-items: center; gap: 10px; padding: 8px 4px; cursor: pointer;">
                <input id="saveOrigOn" type="checkbox" checked style="width: 20px; height: 20px; accent-color: #3182f6;" />
                <span style="font-size: 15px; color: #4e5968; font-weight: 800;">Google Driveì— ì›ë³¸ ë³„ë„ ì €ì¥</span>
              </label>
            </div>
        
            <div style="text-align: right; margin-top: 24px;">
              <button type="button" class="im-btn primary" onclick="moveTab(2)" style="width: 200px;">
                ë‹¤ìŒ ë‹¨ê³„ (í¸ì§‘ ì„¤ì •) â†’
              </button>
            </div>
          </div>
        </div>

        <!--âœ… Step 2: í¸ì§‘ ì„¤ì • íŒ¨ë„ (ì›Œí„°ë§ˆí¬, í’ˆì§ˆ, ë¸”ëŸ¬) -->
        <div id="panel-2" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">2. ì´ë¯¸ì§€ ê°€ê³µ ì„¤ì •</h1>
            <p class="im-help">í’ˆì§ˆ, ë¸”ëŸ¬, ì›Œí„°ë§ˆí¬ ë° ë¬¸êµ¬ í‘œì‹œ ì„¤ì •ì„ ì¡°ì •í•˜ì„¸ìš”.</p>
        
            <div class="im-row">
              <div class="im-label">ì›Œí„°ë§ˆí¬ PNG</div>
              <input id="wmFile" class="im-input" type="file" accept="image/png" />
              <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input id="wmOn" type="checkbox" checked /> ì›Œí„°ë§ˆí¬ ì ìš©
              </label>
            </div>
        
            <div class="im-row">
              <div class="im-label">JPEG í’ˆì§ˆ</div>
              <input id="jpegQ" class="im-range" type="range" min="0.4" max="0.9" step="0.01" value="0.72" />
              <span id="jpegQVal" style="font-weight:900;">0.72</span>
              <span class="im-help">ë‚®ì„ìˆ˜ë¡ ìš©ëŸ‰â†“ / ê¸€ì ë­‰ê°œì§â†‘</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">ë¯¸ì„¸ ë¸”ëŸ¬(px)</div>
              <input id="blurPx" class="im-range" type="range" min="0" max="1.2" step="0.1" value="0.5" />
              <span id="blurPxVal" style="font-weight:900;">0.5</span>
              <span class="im-help">0.4~0.6ë¶€í„° ê¶Œì¥</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">ì›Œí„°ë§ˆí¬ íˆ¬ëª…ë„</div>
              <input id="wmAlpha" class="im-range" type="range" min="0.00" max="1.00" step="0.01" value="0.25" />
              <span id="wmAlphaVal" style="font-weight:900;">0.25</span>
            </div>
        
            <div class="im-row">
              <div class="im-label">í‘œì‹œ ë¬¸êµ¬</div>
              <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                <textarea id="noteText" class="im-input" rows="3" placeholder="ì˜ˆ: Â© Cheesehistory.com&#10;{VER} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ {PCT}%{BLUR}">Â© Cheesehistory.com
        {VER} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ {PCT}%{BLUR}</textarea>
                <div id="notePreview" class="im-help" style="border:1px solid rgba(15,23,42,.12); border-radius:12px; padding:10px; white-space:pre-wrap; font-weight:900;"></div>
              </div>
            </div>
        
            <div class="im-row">
              <div class="im-label">ë¬¸êµ¬ ì„¸ë¶€ì„¤ì •</div>
              <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input id="noteOn" type="checkbox" checked /> í‘œì‹œ
              </label>
              <select id="notePos" class="im-input" style="max-width:140px;">
                <option value="tr" selected>ìš°ì¸¡ ìƒë‹¨</option>
                <option value="tl">ì¢Œì¸¡ ìƒë‹¨</option>
                <option value="br">ìš°ì¸¡ í•˜ë‹¨</option>
                <option value="bl">ì¢Œì¸¡ í•˜ë‹¨</option>
              </select>
            </div>
        
            <div class="im-row">
              <div class="im-label">ê¸€ì í¬ê¸°</div>
              <input id="noteFont" class="im-range" type="range" min="10" max="48" step="1" value="18" />
              <span id="noteFontVal" style="font-weight:900;">18px</span>
            </div>
        
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:24px;">
              <button type="button" class="im-btn" onclick="moveTab(1)" style="width: 120px;">ì´ì „</button>
              <button type="button" class="im-btn primary" onclick="moveTab(3)" style="width: 180px;">
                í¸ì§‘ ì™„ë£Œ (ë¯¸ë¦¬ë³´ê¸°) â†’
              </button>
            </div>
          </div>
        </div>  

        <!--âœ… Step 3: ì—…ë¡œë“œ ë° í™•ì¸ íŒ¨ë„ (ë¯¸ë¦¬ë³´ê¸° ë° ì „ì†¡) -->
        <div id="panel-3" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">3. ìµœì¢… í™•ì¸ ë° ì—…ë¡œë“œ</h1>
            <p class="im-help">ê°€ê³µëœ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•˜ê³  ì„œë²„(Google Drive/DB)ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.</p>
        
            <div class="im-row" style="margin-top:20px; gap:12px;">
              <button id="btnMakePreviews" class="im-btn primary" type="button" style="flex:1;">
                40% / 50% / 60% ë¯¸ë¦¬ë³´ê¸° ìƒì„±
              </button>
              <button id="btnUploadSelected" class="im-btn primary" type="button" disabled style="flex:1; background-color: #3182f6;">
                ì„ íƒí•œ ë²„ì „ ì—…ë¡œë“œ(ì €ì¥)
              </button>
            </div>
        
            <div class="im-row" style="margin-top:20px;">
              <div class="im-label">ì—…ë¡œë“œ ëŒ€ìƒ</div>
              <div id="scalePick" class="im-chiprow"></div>
              <span class="im-help">ì¹©ì„ ëˆŒëŸ¬ ì „ì†¡í•  í’ˆì§ˆì„ ì„ íƒí•˜ì„¸ìš”.</span>
            </div>
        
            <div id="previewGrid" class="im-grid"></div>
        
            <div class="im-hr"></div>
        
            <div class="im-row" style="justify-content:space-between;">
              <div class="im-help">ì—…ë¡œë“œ ì„±ê³µ ì‹œ ìƒì„±ëœ HTML ìŠ¤ë‹ˆí«ì„ í™•ì¸í•˜ì„¸ìš”.</div>
              <button id="btnCopySnippet" class="im-smallbtn" type="button" disabled>ìŠ¤ë‹ˆí« ë³µì‚¬</button>
            </div>
            <div id="uploadResult" class="im-result" style="display:none;"></div>
        
            <div id="toast" class="im-toast" aria-live="polite"></div>
        
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:24px;">
              <button type="button" class="im-btn" onclick="moveTab(2)" style="width: 120px;">ì´ì „ (í¸ì§‘)</button>
              <button type="button" class="im-btn primary" onclick="moveTab(4)" style="width: 180px; background-color: #111827;">
                ë³´ê´€í•¨ìœ¼ë¡œ ê°€ê¸° â†’
              </button>
            </div>
        
            <iframe id="uploadFrame" name="uploadFrame" class="im-hidden"></iframe>
            <form id="uploadForm" class="im-hidden" method="POST" target="uploadFrame"
                  action="https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec">
              <input type="hidden" name="__form" value="1" />
              <input type="hidden" name="payload" id="formPayload" value="" />
            </form>
          </div>
        </div>

        <!--âœ… Step 4: ë³´ê´€í•¨ íŒ¨ë„ (ê¸°ì¡´ ëª©ë¡) -->
        <div id="panel-4" class="im-panel">
          <div class="im-card">
            <h1 class="im-title">4. ì´ë¯¸ì§€ ë³´ê´€í•¨</h1>
            
            <div class="im-row" style="justify-content:space-between; align-items: flex-end;">
              <div>
                <p class="im-help">ìµœê·¼ ì—…ë¡œë“œëœ 50ê°œì˜ ì´ë¯¸ì§€ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.</p>
              </div>
              <button id="btnReloadList" class="im-btn primary" type="button" style="width: 140px;">
                ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              </button>
            </div>
        
            <div class="im-row" style="margin-top: 20px;">
              <div class="im-label">ê²€ìƒ‰(ID/íŒŒì¼ëª…)</div>
              <input id="listFilter" class="im-input" type="text" placeholder="ì˜ˆ: IMG000123 ë˜ëŠ” ìˆ™ì¢…_í™˜êµ­ì •ì¹˜" style="flex:1;" />
              <span id="listCount" class="im-status ok">0</span>
            </div>
        
            <div id="listArea" class="im-list" style="margin-top: 16px; min-height: 300px;">
              </div>
        
            <p class="im-help" style="margin-top:16px;">
              â€» ëª©ë¡ì€ Apps Scriptë¥¼ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ë©°, í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ì™€ ìŠ¤ë‹ˆí«ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        
            <div style="text-align: left; margin-top: 24px;">
              <button type="button" class="im-btn" onclick="moveTab(3)" style="width: 150px;">
                â† ì´ì „ (ì—…ë¡œë“œ)
              </button>
            </div>
          </div>
        </div>

        </div>
      </main>
    </div>
  </div>

  <!-- âœ… ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•˜ëŠ” ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ -->
  <script src="./admin-common.js"></script>

  <script>
  (() => {
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec";

    // ====== DOM ======
    const $baseName = document.getElementById("baseName");    
    const $file   = document.getElementById("imgFile");
    const $wmFile = document.getElementById("wmFile");
    const $wmOn   = document.getElementById("wmOn");

    const $jpegQ = document.getElementById("jpegQ");
    const $jpegQVal = document.getElementById("jpegQVal");
    const $blurPx = document.getElementById("blurPx");
    const $blurPxVal = document.getElementById("blurPxVal");

    const $wmAlpha = document.getElementById("wmAlpha");
    const $wmAlphaVal = document.getElementById("wmAlphaVal");

    const $noteText = document.getElementById("noteText");
    const $noteOn = document.getElementById("noteOn");
    const $notePos = document.getElementById("notePos");
    const $noteFont = document.getElementById("noteFont");
    const $notePreview = document.getElementById("notePreview");
    
    const $noteFontVal = document.getElementById("noteFontVal");

    const $btnMake = document.getElementById("btnMakePreviews");
    const $btnUpload = document.getElementById("btnUploadSelected");
    const $grid = document.getElementById("previewGrid");
    const $scalePick = document.getElementById("scalePick");

    const $result = document.getElementById("uploadResult");
    const $btnCopy = document.getElementById("btnCopySnippet");
    const $toast  = document.getElementById("toast");

    // form/iframe
    const $form = document.getElementById("uploadForm");
    const $formPayload = document.getElementById("formPayload");

    // tabs
    const $tabUpload = document.getElementById("tabUpload");
    const $tabList = document.getElementById("tabList");
    const $panelUpload = document.getElementById("panelUpload");
    const $panelList = document.getElementById("panelList");

    // list UI
    const $btnReloadList = document.getElementById("btnReloadList");
    const $listFilter = document.getElementById("listFilter");
    const $listArea = document.getElementById("listArea");
    const $listCount = document.getElementById("listCount");

    $jpegQ.addEventListener("input", () => $jpegQVal.textContent = Number($jpegQ.value).toFixed(2));
    $blurPx.addEventListener("input", () => $blurPxVal.textContent = Number($blurPx.value).toFixed(1));
    $wmAlpha.addEventListener("input", () => $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2));
    $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2);

    $noteFont.addEventListener("input", () => $noteFontVal.textContent = `${Number($noteFont.value)}px`);

    function refreshNotePreview_(){
      if (!$notePreview) return;
      const t = ($noteText.value || "").replace(/\r\n/g, "\n");
      $notePreview.textContent = t;
    }
    $noteText.addEventListener("input", refreshNotePreview_);
    refreshNotePreview_();
    
    $noteFontVal.textContent = `${Number($noteFont.value)}px`;

    // ====== ìƒíƒœ ======
    const SCALES = [0.4, 0.5, 0.6];
    let sourceImg = null;
    let watermarkImg = null;

    const previews = new Map();
    let selectedScale = null;

    let lastSnippetText = "";
    let currentUploadNonce = "";

    let currentListNonce = "";
    let lastListItems = [];

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function revokeAllPreviewUrls() {
      for (const v of previews.values()) {
        if (v.url) URL.revokeObjectURL(v.url);
      }
      previews.clear();
    }

    function resetUploadResult() {
      lastSnippetText = "";
      $btnCopy.disabled = true;
      $result.style.display = "none";
      $result.textContent = "";
    }

    function loadFileAsImage(file) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("image load fail")); };
        img.src = url;
      });
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function yyyymmdd() {
      const d = new Date();
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    }
    function versionToday() { return `V${yyyymmdd()}`; }

    function ellipsisToFit(ctx, text, maxW) {
      if (ctx.measureText(text).width <= maxW) return text;
      const E = "â€¦";
      let lo = 0, hi = text.length;
      while (lo < hi) {
        const mid = Math.floor((lo + hi) / 2);
        const t = text.slice(0, mid) + E;
        if (ctx.measureText(t).width <= maxW) lo = mid + 1;
        else hi = mid;
      }
      return text.slice(0, Math.max(0, lo - 1)) + E;
    }
    
    function drawCornerTextNoBg(ctx, tw, th, lines, fontSizePx, pos) {
      const pad = Math.max(10, Math.round(tw * 0.015));
      const lineGap = Math.max(3, Math.round(fontSizePx * 0.25));
    
      ctx.save();
      ctx.font = `900 ${fontSizePx}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = "top";
      ctx.fillStyle = "#000";
      ctx.globalAlpha = 1;
    
      const maxW = tw - pad * 2;
      const fitted = lines.map(t => ellipsisToFit(ctx, t, maxW));
    
      const lineH = Math.ceil(fontSizePx * 1.15);
      const totalH = fitted.length * lineH + (fitted.length - 1) * lineGap;
    
      const p = (pos || "tr");
      const isTop = p.includes("t");
      const isLeft = p.includes("l");
    
      let y = isTop ? pad : Math.max(pad, th - pad - totalH);
    
      for (const t of fitted) {
        const w = ctx.measureText(t).width;
        const x = isLeft ? pad : Math.max(pad, tw - pad - w);
        ctx.fillText(t, x, y);
        y += lineH + lineGap;
      }
      ctx.restore();
    }

    async function renderPreviewBlob(scale) {
      if (!sourceImg) throw new Error("source image not loaded");

      const blur = Number($blurPx.value) || 0;
      const q = Number($jpegQ.value) || 0.72;

      const sw = sourceImg.naturalWidth;
      const sh = sourceImg.naturalHeight;

      const tw = Math.max(1, Math.round(sw * scale));
      const th = Math.max(1, Math.round(sh * scale));

      const canvas = document.createElement("canvas");
      canvas.width = tw;
      canvas.height = th;

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      ctx.filter = blur > 0 ? `blur(${blur}px)` : "none";
      ctx.drawImage(sourceImg, 0, 0, tw, th);
      ctx.filter = "none";

      if ($wmOn.checked && watermarkImg) {
        const WM_ALPHA = Number($wmAlpha.value);
        ctx.globalAlpha = Number.isFinite(WM_ALPHA) ? WM_ALPHA : 0.25;

        const iw = watermarkImg.naturalWidth;
        const ih = watermarkImg.naturalHeight;

        const s = Math.max(tw / iw, th / ih);
        const dw = iw * s;
        const dh = ih * s;

        const dx = (tw - dw) / 2;
        const dy = (th - dh) / 2;

        ctx.drawImage(watermarkImg, dx, dy, dw, dh);
        ctx.globalAlpha = 1;
      }

      if ($noteOn.checked) {
        const pct = Math.round(scale * 100);
        const ver = versionToday();
        const blurToken = blur > 0 ? ` Â· ë¯¸ì„¸ë¸”ëŸ¬ ${blur.toFixed(1)}px` : "";
        
        let raw = ($noteText.value || "").replace(/\r\n/g, "\n").trim();
        if (!raw) raw = "Â© Cheesehistory.com";

        // âœ… ì‚¬ìš©ìê°€ í’ˆì§ˆ ë¬¸êµ¬ë¥¼ ì•ˆ ë„£ì—ˆìœ¼ë©´ ìë™ìœ¼ë¡œ í•œ ì¤„ ì¶”ê°€
        if (!/\{PCT\}|\bì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ\b/.test(raw)) raw += `\n{VER} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ {PCT}%{BLUR}`;
        
        // í† í° ì¹˜í™˜(ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ìœ„ì¹˜ì— ë°°ì¹˜ ê°€ëŠ¥)
        raw = raw
          .replace(/\{VER\}/g, ver)
          .replace(/\{PCT\}/g, String(pct))
          .replace(/\{BLUR\}/g, blurToken);
        
        // ì¤„ë°”ê¿ˆ ë¼ì¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const lines = raw
          .split("\n")
          .map(s => s.trim())
          .filter(s => s.length > 0);
        
      const fontSizePx = Math.max(10, Math.min(80, Number($noteFont.value) || 18));
      drawCornerTextNoBg(ctx, tw, th, lines, fontSizePx, ($notePos && $notePos.value) ? $notePos.value : "tr");
      }

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), "image/jpeg", q);
      });
      if (!blob) throw new Error("toBlob failed");
      return { blob, w: tw, h: th, bytes: blob.size };
    }

    function makePreviewCard({ scale, url, w, h, bytes }) {
      const pct = Math.round(scale * 100);
      const sizeKB = Math.round(bytes / 1024);

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px;">
          ${pct}% Â· ${w}Ã—${h} Â· ${sizeKB}KB
          <span class="im-clickhint">(ì´ë¯¸ì§€ í´ë¦­ â†’ ìƒˆ ì°½)</span>
        </div>

        <div class="cheese-img-wrapper" data-scale="${scale}">
          <div class="cheese-img-inner">
            <a class="im-preview-link" href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="">
            </a>
          </div>
          <div class="im-help" style="margin-top:6px;">
            ì—…ë¡œë“œ ëŒ€ìƒ: ì•„ë˜ ì¹©(40/50/60) ì„ íƒ ë˜ëŠ” ì¹´ë“œ ì„ íƒ ë²„íŠ¼ ì‚¬ìš©
          </div>
        </div>

        <button type="button" class="im-btn pick-btn" style="margin-top:8px; width:100%;">
          ì´ ë²„ì „ ì„ íƒ(ì—…ë¡œë“œ ëŒ€ìƒ)
        </button>
      `;

      wrap.querySelector(".pick-btn").addEventListener("click", () => {
        selectedScale = scale;
        highlightSelected();
        $btnUpload.disabled = false;
      });

      return wrap;
    }

    function renderScaleChips() {
      $scalePick.innerHTML = SCALES.map(s => {
        const pct = Math.round(s * 100);
        const on = selectedScale === s;
        return `<span class="im-chip ${on ? "on" : ""}" data-scale="${s}">${pct}%</span>`;
      }).join("");

      $scalePick.querySelectorAll(".im-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const sc = Number(chip.getAttribute("data-scale"));
          if (!previews.has(sc)) return;
          selectedScale = sc;
          highlightSelected();
          $btnUpload.disabled = false;
        });
      });
    }

    function highlightSelected() {
      const wrappers = $grid.querySelectorAll(".cheese-img-wrapper");
      wrappers.forEach(el => {
        const sc = Number(el.getAttribute("data-scale"));
        el.classList.toggle("im-selected", selectedScale === sc);
      });
      renderScaleChips();
    }

    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result;
          const b64 = String(dataUrl).split(",")[1] || "";
          resolve(b64);
        };
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    function safeTrim(s){ return (s == null ? "" : String(s)).trim(); }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (e2) {
          return false;
        }
      }
    }

    function makeNonce_() {
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }
    let toastTimer = null;
    let watchdogTimer = null;

    function toast_(msg, type = "sub") {
      if (!$toast) return;

      $toast.textContent = String(msg || "");
      $toast.classList.remove("ok","bad","sub","show");
      $toast.classList.add(type);

      void $toast.offsetWidth;
      $toast.classList.add("show");

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        $toast.classList.remove("show");
      }, 2600);
    }

    function startUploadWatchdog_() {
      clearTimeout(watchdogTimer);
      watchdogTimer = setTimeout(() => {
        if (currentUploadNonce) {
          toast_("ì‘ë‹µì„ ì•„ì§ ë°›ì§€ ëª»í–ˆì–´ìš”. ì €ì¥ì€ ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ê²°ê³¼ ì˜ì—­/Driveë¥¼ í™•ì¸í•´ì¤˜.", "bad");
          $btnUpload.disabled = false;
        }
      }, 15000);
    }

    function stopUploadWatchdog_() {
      clearTimeout(watchdogTimer);
      watchdogTimer = null;
    }

    function showUploadResult_(json) {
      lastSnippetText = json.snippet || "";
      $btnCopy.disabled = !lastSnippetText;

      $result.style.display = "block";
      $result.textContent =
        `ì—…ë¡œë“œ ì™„ë£Œ!\n` +
        `DB ID: ${json.id}\n` +
        `Drive: ${json.drive_view_url}\n` +
        `Orig Drive: ${json.orig_drive_view_url || "(ì—†ìŒ)"}\n` +   // âœ… ì¶”ê°€
        `IMG_SRC: ${json.img_src}\n` +
        `IMG_HREF: ${json.img_href}\n\n` +
        `HTML ìŠ¤ë‹ˆí«(ë³µì‚¬í•´ì„œ ë°”ë¡œ ì‚¬ìš©):\n` +
        `${lastSnippetText}`;
    }

    // ====== íƒ­ ======
    function setTab(name){
      const isUpload = name === "upload";
      $tabUpload.classList.toggle("on", isUpload);
      $tabList.classList.toggle("on", !isUpload);
      $panelUpload.classList.toggle("on", isUpload);
      $panelList.classList.toggle("on", !isUpload);

      if (!isUpload) loadList();
    }

    $tabUpload.addEventListener("click", () => setTab("upload"));
    $tabList.addEventListener("click", () => setTab("list"));

    // ====== ëª©ë¡ ë Œë”ë§ ======
    function renderList(items){
      const q = String($listFilter.value || "").trim().toLowerCase();
      const filtered = !q ? items : items.filter(it => {
        const a = String(it.id || "").toLowerCase();
        const b = String(it.base_name || "").toLowerCase();
        const c = String(it.drive_name || "").toLowerCase();
        return a.includes(q) || b.includes(q) || c.includes(q);
      });

      $listCount.textContent = String(filtered.length);
      $listArea.innerHTML = "";

      for (const it of filtered) {
        const card = document.createElement("div");
        card.className = "im-item";

        const created = it.created_at ? String(it.created_at).replace("T"," ").slice(0,19) : "";
        const title = it.base_name || it.drive_name || it.id || "";

        const driveLink = it.drive_view_url || it.img_href || "#";
        const thumbSrc = it.img_src || "";

        card.innerHTML = `
          <div class="im-item-head">
            <div style="min-width:0;">
              <div class="im-item-fname" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
              <div class="im-item-id">${escapeHtml(it.id || "")}</div>
              <div class="im-muted">${escapeHtml(created)}</div>
            </div>
            <a class="im-smallbtn" href="${driveLink}" target="_blank" rel="noopener">Drive</a>
          </div>

          <a href="${driveLink}" target="_blank" rel="noopener">
            <img class="im-thumb" src="${thumbSrc}" alt="">
          </a>

          <div class="im-actions">
            <button type="button" class="im-smallbtn btnCopy">ìŠ¤ë‹ˆí« ë³µì‚¬</button>
            <button type="button" class="im-smallbtn btnGet">ìƒì„¸ ë³´ê¸°</button>
          </div>
        `;

        card.querySelector(".btnCopy").addEventListener("click", async () => {
          const got = await loadOne(it.id);
          const snip = got?.snippet || "";
          if (!snip) {
            alert("ìŠ¤ë‹ˆí«ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´. (get ì‹¤íŒ¨)");
            return;
          }
          const ok = await copyToClipboard(snip);
          alert(ok ? "ìŠ¤ë‹ˆí« ë³µì‚¬ ì™„ë£Œ!" : "ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)");
        });

        card.querySelector(".btnGet").addEventListener("click", async () => {
          const got = await loadOne(it.id);
          if (!got) return;
          alert(
            `ID: ${got.id}\n` +
            `Drive: ${got.drive_view_url}\n` +
            `IMG_SRC: ${got.img_src}\n` +
            `IMG_HREF: ${got.img_href}\n\n` +
            `ìŠ¤ë‹ˆí«ì€ 'ìŠ¤ë‹ˆí« ë³µì‚¬' ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬ ê°€ëŠ¥`
          );
        });

        $listArea.appendChild(card);
      }
    }

    $listFilter.addEventListener("input", () => renderList(lastListItems));
    $btnReloadList.addEventListener("click", () => loadList());

    // ====== JSONP í˜¸ì¶œ (ëª©ë¡/ìƒì„¸) ======
    // Apps Script JSON ì‘ë‹µì€ CORS í—¤ë”ê°€ ì—†ì–´ì„œ fetchê°€ ë§‰íˆëŠ” ê²½ìš°ê°€ ë§ìŒ.
    // ê·¸ë˜ì„œ <script src="..."> ë°©ì‹(JSONP)ìœ¼ë¡œ í˜¸ì¶œí•œë‹¤. (iframe ë¶ˆí•„ìš”)
    function jsonpCall_(url, cbName, timeoutMs = 12000){
      return new Promise((resolve) => {
        let done = false;
        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"timeout" });
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data) => {
          if (done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + `_=${Date.now()}`; // cache-bust
        script.onerror = () => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"script_load_failed" });
        };
        document.head.appendChild(script);
      });
    }

    async function loadList(){
      currentListNonce = makeNonce_();
      const cb = `__im_list_cb_${currentListNonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${WEBAPP_URL}?mode=list&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(currentListNonce)}`;

      toast_("ëª©ë¡ ìš”ì²­ ì „ì†¡â€¦", "sub");
      const data = await jsonpCall_(url, cb, 12000);

      if (data && data.ok) {
        lastListItems = Array.isArray(data.items) ? data.items : [];
        renderList(lastListItems);
        toast_(`ëª©ë¡ ë¡œë“œ ì™„ë£Œ (${lastListItems.length}ê°œ)`, "ok");
      } else {
        toast_("ëª©ë¡ ì‘ë‹µ ì—†ìŒ.", "bad");
        alert("ëª©ë¡ ì‘ë‹µ ì—†ìŒ.\n\nê°€ëŠ¥ì„±ì´ í° ì›ì¸:\n- Apps Script ë°°í¬ê°€ ìµœì‹ ì´ ì•„ë‹˜\n- Apps Scriptì— JSONP(mode=list&callback=...) ë¼ìš°íŠ¸ê°€ ì—†ìŒ\n- ë„¤ ë„ë©”ì¸/ë¸Œë¼ìš°ì €ì—ì„œ script ë¡œë“œê°€ ì°¨ë‹¨(CSP)\n\nì¡°ì¹˜:\n- Apps Scriptì— JSONP ë¼ìš°íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  ì¬ë°°í¬\n- ë¸Œë¼ìš°ì € ì½˜ì†”(Network)ì—ì„œ script ìš”ì²­ì´ 200ì¸ì§€ í™•ì¸");
      }
    }

    function loadOne(id){
      const nonce = makeNonce_();
      const cb = `__im_get_cb_${nonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${WEBAPP_URL}?mode=get&id=${encodeURIComponent(id)}&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(nonce)}`;
      toast_("ìƒì„¸ ìš”ì²­â€¦", "sub");

      return new Promise(async (resolve) => {
        const data = await jsonpCall_(url, cb, 12000);
        if (data && data.ok && data.item) resolve(data.item);
        else {
          resolve(null);
          toast_("ìƒì„¸ ì‘ë‹µ ì—†ìŒ(ì„œë²„ ë¼ìš°íŠ¸/ë°°í¬ í™•ì¸)", "bad");
          alert("ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + (data?.error || "unknown"));
        }
      });
    }

    // âœ… Apps Script (iframe form ì—…ë¡œë“œ) ì‘ë‹µ ìˆ˜ì‹ 
    window.addEventListener("message", (ev) => {
      let data = ev.data;

      if (typeof data === "string") {
        try { data = JSON.parse(data); } catch (e) { return; }
      }
      if (!data || typeof data !== "object") return;
      if (!("ok" in data)) return;

      const nonce = data.nonce || "";

      if (nonce && currentUploadNonce && nonce === currentUploadNonce) {
        stopUploadWatchdog_();

        if (data.ok) {
          showUploadResult_(data);
          toast_(`ì—…ë¡œë“œ ì™„ë£Œ! DB ID: ${data.id}`, "ok");
          alert(`ì—…ë¡œë“œ ì™„ë£Œ!
DB ID: ${data.id}
Drive: ${data.drive_view_url}`);
        } else {
          toast_("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (data.error || "unknown"), "bad");
          alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (data.error || "unknown"));
        }

        $btnUpload.disabled = false;
        currentUploadNonce = "";
        return;
      }
    });

    // ====== ì´ë²¤íŠ¸ ======
    $file.addEventListener("change", async () => {
      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";
      resetUploadResult();

      const f = $file.files?.[0];
      if (!f) return;

      try {
        sourceImg = await loadFileAsImage(f);
      } catch (e) {
        sourceImg = null;
        alert("ì›ë³¸ ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨");
      }
    });

    $wmFile.addEventListener("change", async () => {
      const f = $wmFile.files?.[0];
      try {
        watermarkImg = f ? await loadFileAsImage(f) : null;
      } catch (e) {
        watermarkImg = null;
        alert("ì›Œí„°ë§ˆí¬ ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨");
      }
    });

    $btnMake.addEventListener("click", async () => {
      if (!sourceImg) {
        alert("ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜.");
        return;
      }

      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";
      resetUploadResult();

      try {
        for (const s of SCALES) {
          const r = await renderPreviewBlob(s);
          const url = URL.createObjectURL(r.blob);
          previews.set(s, { ...r, url });
        }

        for (const s of SCALES) {
          const v = previews.get(s);
          $grid.appendChild(makePreviewCard({
            scale: s, url: v.url, w: v.w, h: v.h, bytes: v.bytes
          }));
        }

        selectedScale = 0.5;
        renderScaleChips();
        highlightSelected();
        $btnUpload.disabled = false;

      } catch (e) {
        console.error(e);
        alert("ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì‹¤íŒ¨: " + (e?.message || e));
      }
    });

    // ====== ì—…ë¡œë“œ (Drive + DB) ======
    $btnUpload.addEventListener("click", async () => {
      const baseName = safeTrim($baseName.value);
      if (!baseName) {
        alert("íŒŒì¼ëª…(ê¸°ë³¸)ì„ ì…ë ¥í•´ì¤˜. (ì˜ˆ: ìˆ™ì¢…_í™˜êµ­ì •ì¹˜_ë„í‘œ)");
        $btnUpload.disabled = false;
        return;
      }

      if (selectedScale == null) return;
      const v = previews.get(selectedScale);
      if (!v) return;

      try {
        $btnUpload.disabled = true;

        const b64 = await blobToBase64(v.blob);

        // 1. ì›ë³¸ ì €ì¥ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ (UIì—ì„œ ì¶”ê°€í•œ ì²´í¬ë°•ìŠ¤ ID)
        const shouldSaveOrig = document.getElementById("saveOrigOn").checked;
        const origFile = $file.files?.[0] || null;
        
        // 2. ì²´í¬ë°•ìŠ¤ê°€ ì¼œì ¸ ìˆê³  íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì›ë³¸ ë°ì´í„° ì¤€ë¹„
        const orig_base64 = (shouldSaveOrig && origFile) ? await blobToBase64(origFile) : "";
        const orig_mime = (shouldSaveOrig && origFile) ? origFile.type : "";
        const orig_filename = (shouldSaveOrig && origFile) ? (origFile.name || "") : "";
        
        const origW = sourceImg?.naturalWidth || 0;
        const origH = sourceImg?.naturalHeight || 0;

        const label = (safeTrim($noteText.value).split("\n")[0] || "").trim() || "Â© Cheesehistory.com";
        const version = versionToday();

        const pct = Math.round(selectedScale * 100);
        const blur = Number($blurPx.value) || 0;

        const alt = `${label} Â· ì›ë³¸ ëŒ€ë¹„ í’ˆì§ˆ ${pct}%${blur > 0 ? ` Â· ë¯¸ì„¸ë¸”ëŸ¬ ${blur.toFixed(1)}px` : ""}`;
        const title = alt;

        const baseName2 = safeTrim($baseName.value);

        currentUploadNonce = makeNonce_();

        const payload = {
          mode: "upload",
          filename: `img_${version}_${pct}.jpg`,
          mime: "image/jpeg",
          base64: b64,
          orig_base64,
          orig_mime,
          orig_filename,
          
          meta: {
            base_name: baseName2,
            label,
            version,
            scale: selectedScale,
            scale_pct: pct,
            blur_px: blur,
            wm_alpha: Number($wmAlpha.value) || 0,
            orig_w: origW,
            orig_h: origH,
            out_w: v.w,
            out_h: v.h,
            bytes: v.bytes,
            nonce: currentUploadNonce,
            save_orig: shouldSaveOrig // âœ… ì„œë²„ì—ì„œ ì›ë³¸ ì €ì¥ ì—¬ë¶€ë¥¼ íŒë‹¨í•  í”Œë˜ê·¸ ì¶”ê°€
          }
        };

        $form.action = WEBAPP_URL;
        $formPayload.value = JSON.stringify(payload);
        toast_("ì—…ë¡œë“œ ìš”ì²­ ì „ì†¡â€¦ (ì™„ë£Œ ì‹ í˜¸ ëŒ€ê¸° ì¤‘)", "sub");
        $form.submit();
        startUploadWatchdog_();

      } catch (e) {
        console.error(e);
        stopUploadWatchdog_();
        currentUploadNonce = "";
        $btnUpload.disabled = false;
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (e?.message || e));
      }
    });

    $btnCopy.addEventListener("click", async () => {
      if (!lastSnippetText) return;
      const ok = await copyToClipboard(lastSnippetText);
      alert(ok ? "ìŠ¤ë‹ˆí« ë³µì‚¬ ì™„ë£Œ!" : "ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)");
    });

    window.addEventListener("beforeunload", revokeAllPreviewUrls);
// âœ… 1. ë¬¸ì„œ ìˆ˜ì •ì¼ì‹œ í‘œì‹œ (ìƒë‹¨)
    (function showVersion(){
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      if (isNaN(d.getTime())) { el.textContent = "V. UNKNOWN"; return; }
      const z = (n) => (n < 10 ? "0" + n : n);
      const vStr = d.getFullYear() + z(d.getMonth() + 1) + z(d.getDate()) + "_" + z(d.getHours()) + z(d.getMinutes());
      el.textContent = "V." + vStr;
    })();

  })(); // ğŸ‘ˆ ì—¬ê¸°ì„œ ê¸°ì¡´ ë©”ì¸ IIFEê°€ ëë‚©ë‹ˆë‹¤.

  // âœ… 2. íƒ­ ì „í™˜ í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ êº¼ë‚´ì•¼ HTML onclickì´ ì¸ì‹í•¨)
  window.moveTab = function(tabNum) {
    // ëª¨ë“  ë²„íŠ¼ê³¼ íŒ¨ë„ ì´ˆê¸°í™”
    document.querySelectorAll('.im-tab').forEach(btn => btn.classList.remove('on'));
    document.querySelectorAll('.im-panel').forEach(panel => panel.classList.remove('on'));

    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const targetTab = document.querySelector(`.im-tab[data-tab="${tabNum}"]`);
    const targetPanel = document.getElementById(`panel-${tabNum}`);
    
    if (targetTab) targetTab.classList.add('on');
    if (targetPanel) targetPanel.classList.add('on');

    // 4ë²ˆ íƒ­(ë³´ê´€í•¨) í´ë¦­ ì‹œ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ê°•ì œ í´ë¦­
    if (tabNum == 4) {
      const reloadBtn = document.getElementById("btnReloadList");
      if (reloadBtn) reloadBtn.click();
    }
  };

  // âœ… 3. ìƒë‹¨ íƒ­ ë²„íŠ¼ë“¤ ì´ë²¤íŠ¸ ì§ì ‘ ì—°ê²° (ì¤‘ë³µ ë°©ì§€)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.im-tab').forEach(btn => {
      btn.addEventListener('click', function() {
        const num = this.getAttribute('data-tab');
        if(num) window.moveTab(num);
      });
    });
  });

  </script>
</body>
</html>
