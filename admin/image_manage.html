<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>이미지 관리 툴</title>

  <!-- ✅ 메인 관리자 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles (admin.css 위에 얹는 최소 스타일) ===== */
    .im-wrap{ padding:14px; }
    .im-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .im-title{ font-weight:900; font-size:16px; margin:0 0 10px; }
    .im-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0; }
    .im-label{ font-weight:800; min-width:120px; }
    .im-input{ padding:10px 12px; border:1px solid rgba(15,23,42,0.2); border-radius:10px; }
    .im-range{ width:220px; }
    .im-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .im-btn.primary{
      background:rgba(59,130,246,.12);
      border-color:rgba(59,130,246,.35);
    }
    .im-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .im-help{ opacity:.75; font-size:12px; line-height:1.4; }

    .im-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .im-grid{ grid-template-columns:1fr; }
      .im-label{ min-width:auto; }
    }

    .im-chiprow{ display:flex; gap:8px; flex-wrap:wrap; }
    .im-chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.2);
      background:#fff;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .im-chip.on{
      background:rgba(59,130,246,.15);
      border-color:rgba(59,130,246,.35);
      font-weight:900;
    }

    /* 선택 강조 */
    .im-selected{
      outline:3px solid rgba(59,130,246,.9);
      border-radius:12px;
    }

    /* 이미지 클릭 안내 */
    .im-clickhint{
      opacity:.7;
      font-weight:700;
      font-size:12px;
      margin-left:6px;
    }

    /* 이미지가 링크라는 걸 더 명확히 */
    .im-preview-link img{ cursor:zoom-in; }

    /* 업로드 결과 */
    .im-result{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.03);
      font-size:12px;
      line-height:1.5;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .im-smallbtn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }

    /* 상태 라벨 */
    .im-status{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      font-weight:900;
      font-size:12px;
    }
    .im-status.ok{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); }
    .im-status.bad{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.35); }

    /* 숨김 iframe */
    .im-hidden{
      position:fixed;
      left:-9999px;
      top:-9999px;
      width:1px;
      height:1px;
      overflow:hidden;
    }

    /* 토스트 알림 */
    .im-toast{
      position:fixed;
      right:16px;
      top:16px;
      z-index:99999;
      min-width:240px;
      max-width:420px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      box-shadow:0 14px 30px rgba(15,23,42,.12);
      font-weight:900;
      font-size:13px;
      line-height:1.35;

      opacity:0;
      transform:translateY(-8px);
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    .im-toast.show{
      opacity:1;
      transform:translateY(0);
    }
    .im-toast.ok{
      background:rgba(34,197,94,.12);
      border-color:rgba(34,197,94,.35);
    }
    .im-toast.bad{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.35);
    }
    .im-toast.sub{
      background:rgba(59,130,246,.10);
      border-color:rgba(59,130,246,.25);
    }
    /* ===== tabs ===== */
    .im-tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .im-tab{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }
    .im-tab.on{
      background:rgba(59,130,246,.12);
      border-color:rgba(59,130,246,.35);
    }
    .im-panel{ display:none; }
    .im-panel.on{ display:block; }

    /* 목록 카드 */
    .im-list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){
      .im-list{ grid-template-columns:1fr; }
    }
    .im-item{
      border:1px solid rgba(15,23,42,.14);
      border-radius:14px;
      padding:12px;
      background:#fff;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .im-thumb{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      display:block;
    }
    .im-item-head{
      display:flex; justify-content:space-between; gap:8px; align-items:center;
      margin-bottom:8px;
    }
    .im-item-id{ font-weight:900; }
    /* ✅ 목록: 파일명(가장 크게) */
    .im-item-fname{
      font-weight:900;
      font-size:16px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:320px;
    }
    
    /* ✅ 목록: ID는 보조(작게) */
    .im-item-id{
      font-weight:900;
      font-size:12px;
      opacity:.75;
    }
    .im-muted{ opacity:.75; font-size:12px; }
    .im-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="im-wrap">

          <div class="im-tabs">
            <button id="tabUpload" class="im-tab on" type="button">업로드</button>
            <button id="tabList" class="im-tab" type="button">업로드 목록</button>
          </div>

          <!-- ✅ 패널: 업로드 -->
          <section id="panelUpload" class="im-panel on">
            <div class="im-card">
              <h1 class="im-title">이미지 40% / 50% / 60% 미리보기 (클릭 시 새 창)</h1>
              <p class="im-help">
                업로드 전에 브라우저에서 리사이즈 + (선택) 블러 + (선택) 워터마크(오버레이) + (선택) 문구를 적용합니다.
                미리보기 이미지를 클릭하면 새 창(탭)에서 확인할 수 있습니다.
              </p>

              <div class="im-row" style="justify-content:space-between;">
                <div class="im-help">
                  업로드 방식: <b>폼(iframe)</b> 업로드 (CORS 회피, 실패율 낮음)
                </div>
                <span id="uploadModeBadge" class="im-status ok">FORM</span>
              </div>

              <div class="im-row">
                <div class="im-label">파일명(기본)</div>
                <input id="baseName" class="im-input" type="text"
                       placeholder="예: 숙종_환국정치_도표"
                       value="" />
                <span class="im-help">
                  드라이브 파일명: (기본명)__V날짜__Q%__IMG000123.jpg
                </span>
              </div>

              <div class="im-row">
                <div class="im-label">원본 이미지</div>
                <input id="imgFile" class="im-input" type="file" accept="image/*" />
              </div>

              <div class="im-row">
                <div class="im-label">워터마크 PNG</div>
                <input id="wmFile" class="im-input" type="file" accept="image/png" />
                <label style="display:flex; gap:8px; align-items:center;">
                  <input id="wmOn" type="checkbox" checked />
                  워터마크 적용
                </label>
              </div>

              <div class="im-row">
                <div class="im-label">JPEG 품질</div>
                <input id="jpegQ" class="im-range" type="range" min="0.4" max="0.9" step="0.01" value="0.72" />
                <span id="jpegQVal" style="font-weight:900;">0.72</span>
                <span class="im-help">낮을수록 용량↓ / 글자 뭉개짐↑</span>
              </div>

              <div class="im-row">
                <div class="im-label">미세 블러(px)</div>
                <input id="blurPx" class="im-range" type="range" min="0" max="1.2" step="0.1" value="0.5" />
                <span id="blurPxVal" style="font-weight:900;">0.5</span>
                <span class="im-help">0.4~0.6부터 권장</span>
              </div>

              <div class="im-row">
                <div class="im-label">워터마크 투명도</div>
                <input id="wmAlpha" class="im-range" type="range" min="0.00" max="1.00" step="0.01" value="0.25" />
                <span id="wmAlphaVal" style="font-weight:900;">0.25</span>
                <span class="im-help">낮을수록 약하게 보임 (1.00 = 워터마크 원본 그대로)</span>
              </div>

              <div class="im-row">
                <div class="im-label">표시 문구</div>
                <textarea id="noteText" class="im-input" rows="3"
                  placeholder="예: © Cheesehistory.com&#10;{VER} · 원본 대비 품질 {PCT}%{BLUR}"
                >© Cheesehistory.com
                {VER} · 원본 대비 품질 {PCT}%{BLUR}</textarea>
                
                <div id="notePreview" class="im-help"
                  style="border:1px solid rgba(15,23,42,.12); border-radius:12px; padding:10px; white-space:pre-wrap; font-weight:900;">
                  <!-- 실시간 미리보기 -->
                </div>
                <label style="display:flex; gap:8px; align-items:center;">
                  <input id="noteOn" type="checkbox" checked />
                  표시
                </label>

                <!-- ✅ 추가: 라벨 위치 선택 -->
                <select id="notePos" class="im-input" style="max-width:140px;">
                  <option value="tr" selected>우측 상단</option>
                  <option value="tl">좌측 상단</option>
                  <option value="br">우측 하단</option>
                  <option value="bl">좌측 하단</option>
                </select>
                
                  <span class="im-help">  줄바꿈(Enter)로 라인 배치 가능. 토큰: {VER} / {PCT} / {BLUR}</span>
              </div>

              <div class="im-row">
                <div class="im-label">글자 크기</div>
                <input id="noteFont" class="im-range" type="range" min="10" max="48" step="1" value="18" />
                <span id="noteFontVal" style="font-weight:900;">18px</span>
                <span class="im-help">배경 없음(투명) / 글자 검정</span>
              </div>

              <div class="im-row" style="margin-top:12px;">
                <button id="btnMakePreviews" class="im-btn primary" type="button">
                  40% / 50% / 60% 미리보기 생성
                </button>
                <button id="btnUploadSelected" class="im-btn" type="button" disabled>
                  선택한 미리보기 업로드(DB 저장)
                </button>
              </div>

              <div class="im-row">
                <div class="im-label">업로드 선택</div>
                <div id="scalePick" class="im-chiprow"></div>
                <span class="im-help">칩(40/50/60)을 눌러 업로드 대상을 바꿀 수 있어요.</span>
              </div>

              <div id="previewGrid" class="im-grid"></div>

              <div class="im-row" style="justify-content:space-between; margin-top:12px;">
                <div class="im-help">
                  업로드가 성공하면 아래에 “HTML 스니펫”이 나오고, 바로 복사할 수 있습니다.
                </div>
                <button id="btnCopySnippet" class="im-smallbtn" type="button" disabled>스니펫 복사</button>
              </div>
              <div id="uploadResult" class="im-result" style="display:none;"></div>

              <div id="toast" class="im-toast" aria-live="polite"></div>

              <!-- ✅ CORS 회피용 hidden form + iframe -->
              <iframe id="uploadFrame" name="uploadFrame" class="im-hidden"></iframe>
              <form id="uploadForm" class="im-hidden" method="POST" target="uploadFrame"
                    action="https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec">
                <input type="hidden" name="__form" value="1" />
                <input type="hidden" name="payload" id="formPayload" value="" />
              </form>

              <!-- ✅ 목록/상세 조회는 JSONP로 호출 (iframe 불필요) -->
            </div>

            <div class="im-card">
              <h2 class="im-title" style="font-size:14px;">업로드 연결(현재 활성)</h2>
              <p class="im-help">
                업로드는 <b>폼(iframe)</b>로 Apps Script의 <code>__form=1</code> 경로를 호출합니다.
                성공 시 Apps Script가 <code>parent.postMessage(...)</code>로 결과를 보내고, 여기서 결과를 받아 스니펫을 표시합니다.
              </p>
            </div>
          </section>

          <!-- ✅ 패널: 업로드 목록 -->
          <section id="panelList" class="im-panel">
            <div class="im-card">
              <h2 class="im-title" style="font-size:14px;">업로드된 이미지 목록</h2>

              <div class="im-row" style="justify-content:space-between;">
                <div class="im-help">최근 50개를 불러옵니다. (검색은 현재 화면에서 로컬 필터)</div>
                <button id="btnReloadList" class="im-btn primary" type="button">목록 새로고침</button>
              </div>

              <div class="im-row">
                <div class="im-label">검색(ID/파일명)</div>
                <input id="listFilter" class="im-input" type="text" placeholder="예: IMG000123 또는 숙종_환국정치" />
                <span id="listCount" class="im-status">0</span>
              </div>

              <div id="listArea" class="im-list"></div>

              <p class="im-help" style="margin-top:10px;">
                ※ 목록 탭은 Apps Script의 <code>mode=list</code>/<code>mode=get</code>를 <b>JSONP</b>로 호출합니다. (CORS/iframe 차단 회피)
              </p>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

  <script>
  (() => {
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyIsoT-0JY2nxCPFx2JH-G3Ja8tztjlJ6fiVAyxLgd-8Mzxjob8YDGgRO-biOCXe5WU/exec";

    // ====== DOM ======
    const $baseName = document.getElementById("baseName");    
    const $file   = document.getElementById("imgFile");
    const $wmFile = document.getElementById("wmFile");
    const $wmOn   = document.getElementById("wmOn");

    const $jpegQ = document.getElementById("jpegQ");
    const $jpegQVal = document.getElementById("jpegQVal");
    const $blurPx = document.getElementById("blurPx");
    const $blurPxVal = document.getElementById("blurPxVal");

    const $wmAlpha = document.getElementById("wmAlpha");
    const $wmAlphaVal = document.getElementById("wmAlphaVal");

    const $noteText = document.getElementById("noteText");
    const $noteOn = document.getElementById("noteOn");
    const $notePos = document.getElementById("notePos");
    const $noteFont = document.getElementById("noteFont");
    const $notePreview = document.getElementById("notePreview");
    
    const $noteFontVal = document.getElementById("noteFontVal");

    const $btnMake = document.getElementById("btnMakePreviews");
    const $btnUpload = document.getElementById("btnUploadSelected");
    const $grid = document.getElementById("previewGrid");
    const $scalePick = document.getElementById("scalePick");

    const $result = document.getElementById("uploadResult");
    const $btnCopy = document.getElementById("btnCopySnippet");
    const $toast  = document.getElementById("toast");

    // form/iframe
    const $form = document.getElementById("uploadForm");
    const $formPayload = document.getElementById("formPayload");

    // tabs
    const $tabUpload = document.getElementById("tabUpload");
    const $tabList = document.getElementById("tabList");
    const $panelUpload = document.getElementById("panelUpload");
    const $panelList = document.getElementById("panelList");

    // list UI
    const $btnReloadList = document.getElementById("btnReloadList");
    const $listFilter = document.getElementById("listFilter");
    const $listArea = document.getElementById("listArea");
    const $listCount = document.getElementById("listCount");

    $jpegQ.addEventListener("input", () => $jpegQVal.textContent = Number($jpegQ.value).toFixed(2));
    $blurPx.addEventListener("input", () => $blurPxVal.textContent = Number($blurPx.value).toFixed(1));
    $wmAlpha.addEventListener("input", () => $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2));
    $wmAlphaVal.textContent = Number($wmAlpha.value).toFixed(2);

    $noteFont.addEventListener("input", () => $noteFontVal.textContent = `${Number($noteFont.value)}px`);

    function refreshNotePreview_(){
      if (!$notePreview) return;
      const t = ($noteText.value || "").replace(/\r\n/g, "\n");
      $notePreview.textContent = t;
    }
    $noteText.addEventListener("input", refreshNotePreview_);
    refreshNotePreview_();
    
    $noteFontVal.textContent = `${Number($noteFont.value)}px`;

    // ====== 상태 ======
    const SCALES = [0.4, 0.5, 0.6];
    let sourceImg = null;
    let watermarkImg = null;

    const previews = new Map();
    let selectedScale = null;

    let lastSnippetText = "";
    let currentUploadNonce = "";

    let currentListNonce = "";
    let lastListItems = [];

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function revokeAllPreviewUrls() {
      for (const v of previews.values()) {
        if (v.url) URL.revokeObjectURL(v.url);
      }
      previews.clear();
    }

    function resetUploadResult() {
      lastSnippetText = "";
      $btnCopy.disabled = true;
      $result.style.display = "none";
      $result.textContent = "";
    }

    function loadFileAsImage(file) {
      return new Promise((resolve, reject) => {
        if (!file) return reject(new Error("no file"));
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("image load fail")); };
        img.src = url;
      });
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function yyyymmdd() {
      const d = new Date();
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    }
    function versionToday() { return `V${yyyymmdd()}`; }

    function ellipsisToFit(ctx, text, maxW) {
      if (ctx.measureText(text).width <= maxW) return text;
      const E = "…";
      let lo = 0, hi = text.length;
      while (lo < hi) {
        const mid = Math.floor((lo + hi) / 2);
        const t = text.slice(0, mid) + E;
        if (ctx.measureText(t).width <= maxW) lo = mid + 1;
        else hi = mid;
      }
      return text.slice(0, Math.max(0, lo - 1)) + E;
    }
    
    function drawCornerTextNoBg(ctx, tw, th, lines, fontSizePx, pos) {
      const pad = Math.max(10, Math.round(tw * 0.015));
      const lineGap = Math.max(3, Math.round(fontSizePx * 0.25));
    
      ctx.save();
      ctx.font = `900 ${fontSizePx}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = "top";
      ctx.fillStyle = "#000";
      ctx.globalAlpha = 1;
    
      const maxW = tw - pad * 2;
      const fitted = lines.map(t => ellipsisToFit(ctx, t, maxW));
    
      const lineH = Math.ceil(fontSizePx * 1.15);
      const totalH = fitted.length * lineH + (fitted.length - 1) * lineGap;
    
      const p = (pos || "tr");
      const isTop = p.includes("t");
      const isLeft = p.includes("l");
    
      let y = isTop ? pad : Math.max(pad, th - pad - totalH);
    
      for (const t of fitted) {
        const w = ctx.measureText(t).width;
        const x = isLeft ? pad : Math.max(pad, tw - pad - w);
        ctx.fillText(t, x, y);
        y += lineH + lineGap;
      }
      ctx.restore();
    }

    async function renderPreviewBlob(scale) {
      if (!sourceImg) throw new Error("source image not loaded");

      const blur = Number($blurPx.value) || 0;
      const q = Number($jpegQ.value) || 0.72;

      const sw = sourceImg.naturalWidth;
      const sh = sourceImg.naturalHeight;

      const tw = Math.max(1, Math.round(sw * scale));
      const th = Math.max(1, Math.round(sh * scale));

      const canvas = document.createElement("canvas");
      canvas.width = tw;
      canvas.height = th;

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      ctx.filter = blur > 0 ? `blur(${blur}px)` : "none";
      ctx.drawImage(sourceImg, 0, 0, tw, th);
      ctx.filter = "none";

      if ($wmOn.checked && watermarkImg) {
        const WM_ALPHA = Number($wmAlpha.value);
        ctx.globalAlpha = Number.isFinite(WM_ALPHA) ? WM_ALPHA : 0.25;

        const iw = watermarkImg.naturalWidth;
        const ih = watermarkImg.naturalHeight;

        const s = Math.max(tw / iw, th / ih);
        const dw = iw * s;
        const dh = ih * s;

        const dx = (tw - dw) / 2;
        const dy = (th - dh) / 2;

        ctx.drawImage(watermarkImg, dx, dy, dw, dh);
        ctx.globalAlpha = 1;
      }

      if ($noteOn.checked) {
        const pct = Math.round(scale * 100);
        const ver = versionToday();
        const blurToken = blur > 0 ? ` · 미세블러 ${blur.toFixed(1)}px` : "";
        
        let raw = ($noteText.value || "").replace(/\r\n/g, "\n").trim();
        if (!raw) raw = "© Cheesehistory.com";

        // ✅ 사용자가 품질 문구를 안 넣었으면 자동으로 한 줄 추가
        if (!/\{PCT\}|\b원본 대비 품질\b/.test(raw)) raw += `\n{VER} · 원본 대비 품질 {PCT}%{BLUR}`;
        
        // 토큰 치환(사용자가 원하는 위치에 배치 가능)
        raw = raw
          .replace(/\{VER\}/g, ver)
          .replace(/\{PCT\}/g, String(pct))
          .replace(/\{BLUR\}/g, blurToken);
        
        // 줄바꿈 라인 그대로 사용
        const lines = raw
          .split("\n")
          .map(s => s.trim())
          .filter(s => s.length > 0);
        
      const fontSizePx = Math.max(10, Math.min(80, Number($noteFont.value) || 18));
      drawCornerTextNoBg(ctx, tw, th, lines, fontSizePx, ($notePos && $notePos.value) ? $notePos.value : "tr");
      }

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), "image/jpeg", q);
      });
      if (!blob) throw new Error("toBlob failed");
      return { blob, w: tw, h: th, bytes: blob.size };
    }

    function makePreviewCard({ scale, url, w, h, bytes }) {
      const pct = Math.round(scale * 100);
      const sizeKB = Math.round(bytes / 1024);

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div style="font-weight:900; margin-bottom:6px;">
          ${pct}% · ${w}×${h} · ${sizeKB}KB
          <span class="im-clickhint">(이미지 클릭 → 새 창)</span>
        </div>

        <div class="cheese-img-wrapper" data-scale="${scale}">
          <div class="cheese-img-inner">
            <a class="im-preview-link" href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="">
            </a>
          </div>
          <div class="im-help" style="margin-top:6px;">
            업로드 대상: 아래 칩(40/50/60) 선택 또는 카드 선택 버튼 사용
          </div>
        </div>

        <button type="button" class="im-btn pick-btn" style="margin-top:8px; width:100%;">
          이 버전 선택(업로드 대상)
        </button>
      `;

      wrap.querySelector(".pick-btn").addEventListener("click", () => {
        selectedScale = scale;
        highlightSelected();
        $btnUpload.disabled = false;
      });

      return wrap;
    }

    function renderScaleChips() {
      $scalePick.innerHTML = SCALES.map(s => {
        const pct = Math.round(s * 100);
        const on = selectedScale === s;
        return `<span class="im-chip ${on ? "on" : ""}" data-scale="${s}">${pct}%</span>`;
      }).join("");

      $scalePick.querySelectorAll(".im-chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const sc = Number(chip.getAttribute("data-scale"));
          if (!previews.has(sc)) return;
          selectedScale = sc;
          highlightSelected();
          $btnUpload.disabled = false;
        });
      });
    }

    function highlightSelected() {
      const wrappers = $grid.querySelectorAll(".cheese-img-wrapper");
      wrappers.forEach(el => {
        const sc = Number(el.getAttribute("data-scale"));
        el.classList.toggle("im-selected", selectedScale === sc);
      });
      renderScaleChips();
    }

    async function blobToBase64(blob){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result;
          const b64 = String(dataUrl).split(",")[1] || "";
          resolve(b64);
        };
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }

    function safeTrim(s){ return (s == null ? "" : String(s)).trim(); }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        } catch (e2) {
          return false;
        }
      }
    }

    function makeNonce_() {
      return `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }
    let toastTimer = null;
    let watchdogTimer = null;

    function toast_(msg, type = "sub") {
      if (!$toast) return;

      $toast.textContent = String(msg || "");
      $toast.classList.remove("ok","bad","sub","show");
      $toast.classList.add(type);

      void $toast.offsetWidth;
      $toast.classList.add("show");

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        $toast.classList.remove("show");
      }, 2600);
    }

    function startUploadWatchdog_() {
      clearTimeout(watchdogTimer);
      watchdogTimer = setTimeout(() => {
        if (currentUploadNonce) {
          toast_("응답을 아직 받지 못했어요. 저장은 되었을 수 있으니 결과 영역/Drive를 확인해줘.", "bad");
          $btnUpload.disabled = false;
        }
      }, 15000);
    }

    function stopUploadWatchdog_() {
      clearTimeout(watchdogTimer);
      watchdogTimer = null;
    }

    function showUploadResult_(json) {
      lastSnippetText = json.snippet || "";
      $btnCopy.disabled = !lastSnippetText;

      $result.style.display = "block";
      $result.textContent =
        `업로드 완료!\n` +
        `DB ID: ${json.id}\n` +
        `Drive: ${json.drive_view_url}\n` +
        `Orig Drive: ${json.orig_drive_view_url || "(없음)"}\n` +   // ✅ 추가
        `IMG_SRC: ${json.img_src}\n` +
        `IMG_HREF: ${json.img_href}\n\n` +
        `HTML 스니펫(복사해서 바로 사용):\n` +
        `${lastSnippetText}`;
    }

    // ====== 탭 ======
    function setTab(name){
      const isUpload = name === "upload";
      $tabUpload.classList.toggle("on", isUpload);
      $tabList.classList.toggle("on", !isUpload);
      $panelUpload.classList.toggle("on", isUpload);
      $panelList.classList.toggle("on", !isUpload);

      if (!isUpload) loadList();
    }

    $tabUpload.addEventListener("click", () => setTab("upload"));
    $tabList.addEventListener("click", () => setTab("list"));

    // ====== 목록 렌더링 ======
    function renderList(items){
      const q = String($listFilter.value || "").trim().toLowerCase();
      const filtered = !q ? items : items.filter(it => {
        const a = String(it.id || "").toLowerCase();
        const b = String(it.base_name || "").toLowerCase();
        const c = String(it.drive_name || "").toLowerCase();
        return a.includes(q) || b.includes(q) || c.includes(q);
      });

      $listCount.textContent = String(filtered.length);
      $listArea.innerHTML = "";

      for (const it of filtered) {
        const card = document.createElement("div");
        card.className = "im-item";

        const created = it.created_at ? String(it.created_at).replace("T"," ").slice(0,19) : "";
        const title = it.base_name || it.drive_name || it.id || "";

        const driveLink = it.drive_view_url || it.img_href || "#";
        const thumbSrc = it.img_src || "";

        card.innerHTML = `
          <div class="im-item-head">
            <div style="min-width:0;">
              <div class="im-item-fname" title="${escapeHtml(title)}">${escapeHtml(title)}</div>
              <div class="im-item-id">${escapeHtml(it.id || "")}</div>
              <div class="im-muted">${escapeHtml(created)}</div>
            </div>
            <a class="im-smallbtn" href="${driveLink}" target="_blank" rel="noopener">Drive</a>
          </div>

          <a href="${driveLink}" target="_blank" rel="noopener">
            <img class="im-thumb" src="${thumbSrc}" alt="">
          </a>

          <div class="im-actions">
            <button type="button" class="im-smallbtn btnCopy">스니펫 복사</button>
            <button type="button" class="im-smallbtn btnGet">상세 보기</button>
          </div>
        `;

        card.querySelector(".btnCopy").addEventListener("click", async () => {
          const got = await loadOne(it.id);
          const snip = got?.snippet || "";
          if (!snip) {
            alert("스니펫을 가져오지 못했어. (get 실패)");
            return;
          }
          const ok = await copyToClipboard(snip);
          alert(ok ? "스니펫 복사 완료!" : "복사 실패(브라우저 권한 확인)");
        });

        card.querySelector(".btnGet").addEventListener("click", async () => {
          const got = await loadOne(it.id);
          if (!got) return;
          alert(
            `ID: ${got.id}\n` +
            `Drive: ${got.drive_view_url}\n` +
            `IMG_SRC: ${got.img_src}\n` +
            `IMG_HREF: ${got.img_href}\n\n` +
            `스니펫은 '스니펫 복사' 버튼으로 복사 가능`
          );
        });

        $listArea.appendChild(card);
      }
    }

    $listFilter.addEventListener("input", () => renderList(lastListItems));
    $btnReloadList.addEventListener("click", () => loadList());

    // ====== JSONP 호출 (목록/상세) ======
    // Apps Script JSON 응답은 CORS 헤더가 없어서 fetch가 막히는 경우가 많음.
    // 그래서 <script src="..."> 방식(JSONP)으로 호출한다. (iframe 불필요)
    function jsonpCall_(url, cbName, timeoutMs = 12000){
      return new Promise((resolve) => {
        let done = false;
        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"timeout" });
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (data) => {
          if (done) return;
          done = true;
          cleanup();
          resolve(data);
        };

        const script = document.createElement("script");
        script.src = url + (url.includes("?") ? "&" : "?") + `_=${Date.now()}`; // cache-bust
        script.onerror = () => {
          if (done) return;
          done = true;
          cleanup();
          resolve({ ok:false, error:"script_load_failed" });
        };
        document.head.appendChild(script);
      });
    }

    async function loadList(){
      currentListNonce = makeNonce_();
      const cb = `__im_list_cb_${currentListNonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${WEBAPP_URL}?mode=list&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(currentListNonce)}`;

      toast_("목록 요청 전송…", "sub");
      const data = await jsonpCall_(url, cb, 12000);

      if (data && data.ok) {
        lastListItems = Array.isArray(data.items) ? data.items : [];
        renderList(lastListItems);
        toast_(`목록 로드 완료 (${lastListItems.length}개)`, "ok");
      } else {
        toast_("목록 응답 없음.", "bad");
        alert("목록 응답 없음.\n\n가능성이 큰 원인:\n- Apps Script 배포가 최신이 아님\n- Apps Script에 JSONP(mode=list&callback=...) 라우트가 없음\n- 네 도메인/브라우저에서 script 로드가 차단(CSP)\n\n조치:\n- Apps Script에 JSONP 라우트를 추가하고 재배포\n- 브라우저 콘솔(Network)에서 script 요청이 200인지 확인");
      }
    }

    function loadOne(id){
      const nonce = makeNonce_();
      const cb = `__im_get_cb_${nonce.replace(/[^a-zA-Z0-9_]/g,"_")}`;
      const url = `${WEBAPP_URL}?mode=get&id=${encodeURIComponent(id)}&callback=${encodeURIComponent(cb)}&nonce=${encodeURIComponent(nonce)}`;
      toast_("상세 요청…", "sub");

      return new Promise(async (resolve) => {
        const data = await jsonpCall_(url, cb, 12000);
        if (data && data.ok && data.item) resolve(data.item);
        else {
          resolve(null);
          toast_("상세 응답 없음(서버 라우트/배포 확인)", "bad");
          alert("상세 불러오기 실패: " + (data?.error || "unknown"));
        }
      });
    }

    // ✅ Apps Script (iframe form 업로드) 응답 수신
    window.addEventListener("message", (ev) => {
      let data = ev.data;

      if (typeof data === "string") {
        try { data = JSON.parse(data); } catch (e) { return; }
      }
      if (!data || typeof data !== "object") return;
      if (!("ok" in data)) return;

      const nonce = data.nonce || "";

      if (nonce && currentUploadNonce && nonce === currentUploadNonce) {
        stopUploadWatchdog_();

        if (data.ok) {
          showUploadResult_(data);
          toast_(`업로드 완료! DB ID: ${data.id}`, "ok");
          alert(`업로드 완료!
DB ID: ${data.id}
Drive: ${data.drive_view_url}`);
        } else {
          toast_("업로드 실패: " + (data.error || "unknown"), "bad");
          alert("업로드 실패: " + (data.error || "unknown"));
        }

        $btnUpload.disabled = false;
        currentUploadNonce = "";
        return;
      }
    });

    // ====== 이벤트 ======
    $file.addEventListener("change", async () => {
      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";
      resetUploadResult();

      const f = $file.files?.[0];
      if (!f) return;

      try {
        sourceImg = await loadFileAsImage(f);
      } catch (e) {
        sourceImg = null;
        alert("원본 이미지 로딩 실패");
      }
    });

    $wmFile.addEventListener("change", async () => {
      const f = $wmFile.files?.[0];
      try {
        watermarkImg = f ? await loadFileAsImage(f) : null;
      } catch (e) {
        watermarkImg = null;
        alert("워터마크 이미지 로딩 실패");
      }
    });

    $btnMake.addEventListener("click", async () => {
      if (!sourceImg) {
        alert("원본 이미지를 먼저 선택해줘.");
        return;
      }

      revokeAllPreviewUrls();
      $grid.innerHTML = "";
      selectedScale = null;
      $btnUpload.disabled = true;
      $scalePick.innerHTML = "";
      resetUploadResult();

      try {
        for (const s of SCALES) {
          const r = await renderPreviewBlob(s);
          const url = URL.createObjectURL(r.blob);
          previews.set(s, { ...r, url });
        }

        for (const s of SCALES) {
          const v = previews.get(s);
          $grid.appendChild(makePreviewCard({
            scale: s, url: v.url, w: v.w, h: v.h, bytes: v.bytes
          }));
        }

        selectedScale = 0.5;
        renderScaleChips();
        highlightSelected();
        $btnUpload.disabled = false;

      } catch (e) {
        console.error(e);
        alert("미리보기 생성 실패: " + (e?.message || e));
      }
    });

    // ====== 업로드 (Drive + DB) ======
    $btnUpload.addEventListener("click", async () => {
      const baseName = safeTrim($baseName.value);
      if (!baseName) {
        alert("파일명(기본)을 입력해줘. (예: 숙종_환국정치_도표)");
        $btnUpload.disabled = false;
        return;
      }

      if (selectedScale == null) return;
      const v = previews.get(selectedScale);
      if (!v) return;

      try {
        $btnUpload.disabled = true;

        const b64 = await blobToBase64(v.blob);

        // ✅ (추가) 원본 파일도 base64로 변환해서 함께 전송
        const origFile = $file.files?.[0] || null;
        const orig_filename = origFile?.name || "";

        const orig_base64 = origFile ? await blobToBase64(origFile) : "";
        const orig_mime = origFile?.type || "";
        
        const origW = sourceImg?.naturalWidth || 0;
        const origH = sourceImg?.naturalHeight || 0;

        const label = (safeTrim($noteText.value).split("\n")[0] || "").trim() || "© Cheesehistory.com";
        const version = versionToday();

        const pct = Math.round(selectedScale * 100);
        const blur = Number($blurPx.value) || 0;

        const alt = `${label} · 원본 대비 품질 ${pct}%${blur > 0 ? ` · 미세블러 ${blur.toFixed(1)}px` : ""}`;
        const title = alt;

        const baseName2 = safeTrim($baseName.value);

        currentUploadNonce = makeNonce_();

        const payload = {
          mode: "upload",
          filename: `img_${version}_${pct}.jpg`,
          mime: "image/jpeg",
          base64: b64,
          // ✅ (추가) 원본도 같이 보냄
          orig_base64,
          orig_mime,
          orig_filename,
          
          meta: {
            base_name: baseName2,
            label,
            version,
            scale: selectedScale,
            scale_pct: pct,
            blur_px: blur,
            wm_alpha: Number($wmAlpha.value) || 0,
            orig_w: origW,
            orig_h: origH,
            out_w: v.w,
            out_h: v.h,
            bytes: v.bytes,
            nonce: currentUploadNonce
          }
        };

        $form.action = WEBAPP_URL;
        $formPayload.value = JSON.stringify(payload);
        toast_("업로드 요청 전송… (완료 신호 대기 중)", "sub");
        $form.submit();
        startUploadWatchdog_();

      } catch (e) {
        console.error(e);
        stopUploadWatchdog_();
        currentUploadNonce = "";
        $btnUpload.disabled = false;
        alert("업로드 실패: " + (e?.message || e));
      }
    });

    $btnCopy.addEventListener("click", async () => {
      if (!lastSnippetText) return;
      const ok = await copyToClipboard(lastSnippetText);
      alert(ok ? "스니펫 복사 완료!" : "복사 실패(브라우저 권한 확인)");
    });

    window.addEventListener("beforeunload", revokeAllPreviewUrls);
  })();
  </script>
</body>
</html>
