<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>월말 지출결의 · Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 공통 CSS -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
    }

    .wrap {
      max-width: 980px;
      margin: 1.5rem auto 2.5rem;
      padding: 1.75rem 1.5rem;
      border-radius: 1.25rem;
      background: #fff;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
      box-sizing: border-box;
    }

    .title {
      font-size: 1.35rem;
      font-weight: 700;
      margin: 0 0 .25rem;
      letter-spacing: -0.02em;
    }
    .sub {
      margin: 0 0 1.25rem;
      color: #6b7280;
      font-size: .92rem;
      line-height: 1.45;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 860px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      border-radius: 14px;
      padding: 14px;
    }
    .card h2 {
      margin: 0 0 10px;
      font-size: 1rem;
      font-weight: 700;
      color: #111827;
    }

    .field { margin-bottom: 10px; }
    .label {
      display: block;
      font-size: .82rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 6px;
    }
    .input, .textarea, .select {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: .6rem .65rem;
      font-size: .9rem;
      outline: none;
      background: #fff;
    }
    .textarea { min-height: 84px; resize: vertical; }
    .hint {
      margin-top: 4px;
      font-size: .75rem;
      color: #9ca3af;
      line-height: 1.35;
    }

    .approval-line-preview {
      margin-top: 10px;
      border: 1px dashed #cbd5e1;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      color: #334155;
      font-size: .85rem;
      min-height: 44px;
    }
    .approval-line-input-group {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .approval-line-input-group .input { flex: 1; }

    .btn {
      border-radius: 999px;
      border: 0;
      padding: .5rem 1.05rem;
      font-size: .82rem;
      cursor: pointer;
      font-weight: 600;
      background: #e5e7eb;
      color: #111827;
    }
    .btn:hover { filter: brightness(0.98); }
    .btn-primary { background: #2563eb; color: #f9fafb; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-ghost { background: transparent; color: #4b5563; }
    .btn-outline { background: #fff; border: 1px solid #d1d5db; color: #111827; }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    .table th, .table td {
      padding: 10px 10px;
      border-bottom: 1px solid #f1f5f9;
      font-size: .86rem;
      vertical-align: top;
    }
    .table th {
      background: #f8fafc;
      color: #374151;
      text-align: left;
      font-weight: 700;
      font-size: .82rem;
    }
    .table tr:last-child td { border-bottom: 0; }

    .row-actions { display: flex; gap: 6px; flex-wrap: wrap; }

    .status {
      margin-top: 12px;
      font-size: .85rem;
      color: #6b7280;
      white-space: pre-line;
    }
    .status.error { color: #dc2626; }
    .status.ok { color: #166534; }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .footer .left, .footer .right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: .82rem;
      color: #374151;
    }

    .alloc-lines { margin-top: 10px; }
    .alloc-row {
      display: grid;
      grid-template-columns: 1.2fr .8fr auto;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    @media (max-width: 680px) {
      .alloc-row { grid-template-columns: 1fr; }
    }
    .alloc-total {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px dashed #e5e7eb;
      color: #111827;
      font-weight: 700;
      font-size: .9rem;
    }
  </style>
</head>

<body>
  <!-- 권한 -->
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "FIN", "ADMIN"];
  </script>

  <!-- 헤더/메뉴 활성 표시용 -->
  <script>
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "월말 지출결의";
    window.CHEESE_ADMIN_PAGE_BADGE    = "expense_monthly";
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "expense_monthly";
  </script>

  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="wrap">
          <h1 class="title">월말 지출결의</h1>
          <p class="sub">
            한 달 동안의 지출을 “영수증 단위로 정리”한 뒤, 마지막에 일괄 제출합니다.<br/>
            ※ 현재 Web 지출 제출은 <code>request_id</code> 단위로 제출되므로, 영수증 1장에 여러 항목이 있으면
            분할 라인 수만큼 자동으로 여러 건이 제출됩니다(증빙 링크/설명은 동일하게 복사).
          </p>

          <!-- 월 설정 + 기본값 -->
          <div class="grid">
            <section class="card">
              <h2>1) 월 기본 설정</h2>

              <div class="field">
                <label class="label" for="monthKey">대상 월</label>
                <input class="input" id="monthKey" type="month" />
                <div class="hint">예: 2025-12</div>
              </div>

              <div class="field">
                <label class="label" for="monthEvidence">월 증빙 링크(기본값)</label>
                <input class="input" id="monthEvidence" type="url" placeholder="예: 드라이브 폴더/월말 스캔 PDF 링크" />
                <div class="hint">영수증별 링크를 비우면, 이 기본 링크가 사용됩니다.</div>
              </div>

              <div class="field">
                <label class="label" for="monthMemoPrefix">설명 프리픽스(선택)</label>
                <input class="input" id="monthMemoPrefix" placeholder="예: 12월 지출결의 -" />
              </div>

              <div class="pill" id="draftPill">Draft: (없음)</div>
            </section>

            <!-- 결재선 -->
            <section class="card">
              <h2>2) 결재선</h2>

              <input type="hidden" id="approvalLineJson" name="approvalLineJson" value="" />
              <input type="hidden" id="drafterId" name="drafterId" value="" />

              <div id="approval-line-preview" class="approval-line-preview"></div>

              <div class="approval-line-input-group">
                <input
                  type="text"
                  id="expense-approval-line-name"
                  name="approvalLineName"
                  class="input"
                  placeholder="결재선을 선택해주세요"
                  readonly
                />
                <input
                  type="hidden"
                  id="expense-approval-line-id"
                  name="approvalLineId"
                />
                <button
                  type="button"
                  class="btn btn-outline approval-line-open-btn"
                  data-approval-line-id="expense-approval-line-id"
                  data-approval-line-name="expense-approval-line-name"
                  data-approval-line-preview="approval-line-preview"
                >
                  결재선 선택
                </button>
              </div>

              <!-- 결재선 모달 루트 (admin-common.js가 사용) -->
              <div id="approval-line-modal-root"></div>

              <div class="hint">
                결재선 선택 버튼은 기존 지출 페이지와 동일한 클래스/데이터 속성을 사용합니다. :contentReference[oaicite:13]{index=13}
              </div>
            </section>
          </div>

          <!-- 영수증 입력 -->
          <section class="card" style="margin-top:14px;">
            <h2>3) 영수증 추가</h2>

            <div class="grid">
              <div>
                <div class="field">
                  <label class="label" for="rDate">영수증 날짜</label>
                  <input class="input" id="rDate" type="date" />
                </div>

                <div class="field">
                  <label class="label" for="rVendor">거래처 / 상호</label>
                  <input class="input" id="rVendor" placeholder="예: 구글코리아 / 네이버파이낸셜" />
                </div>

                <div class="field">
                  <label class="label" for="rEvidence">영수증 링크(선택)</label>
                  <input class="input" id="rEvidence" type="url" placeholder="비우면 월 기본 링크 사용" />
                </div>

                <div class="field">
                  <label class="label" for="rMemo">영수증 메모(선택)</label>
                  <textarea class="textarea" id="rMemo" placeholder="예: 카드승인번호/구매내역 요약 등"></textarea>
                </div>
              </div>

              <div>
                <div class="field">
                  <label class="label">분할 라인 (request_id / 금액)</label>

                  <datalist id="approvedRequestList"></datalist>

                  <div id="allocWrap" class="alloc-lines"></div>

                  <div class="row-actions">
                    <button type="button" class="btn" id="btnAddAlloc">+ 라인 추가</button>
                    <button type="button" class="btn btn-ghost" id="btnClearAlloc">라인 초기화</button>
                  </div>

                  <div class="alloc-total">
                    <span>영수증 합계</span>
                    <span id="allocTotal">0 원</span>
                  </div>

                  <div class="hint">
                    승인된 <code>request_id</code>를 직접 입력하거나 목록에서 선택하세요.
                  </div>
                </div>

                <div class="row-actions">
                  <button type="button" class="btn btn-primary" id="btnAddReceipt">영수증 목록에 추가</button>
                  <button type="button" class="btn btn-ghost" id="btnResetReceipt">영수증 입력 초기화</button>
                </div>
              </div>
            </div>
          </section>

          <!-- 목록 -->
          <section class="card" style="margin-top:14px;">
            <h2>4) 월말 목록</h2>

            <table class="table">
              <thead>
                <tr>
                  <th style="width: 140px;">날짜</th>
                  <th>거래처 / 메모</th>
                  <th style="width: 160px;">분할</th>
                  <th style="width: 120px;">합계</th>
                  <th style="width: 160px;">액션</th>
                </tr>
              </thead>
              <tbody id="receiptTbody">
                <tr>
                  <td colspan="5" style="color:#6b7280;">아직 추가된 영수증이 없습니다.</td>
                </tr>
              </tbody>
            </table>

            <div class="footer">
              <div class="left">
                <button type="button" class="btn" id="btnSaveDraft">임시저장</button>
                <button type="button" class="btn" id="btnLoadDraft">불러오기</button>
                <button type="button" class="btn btn-ghost" id="btnClearDraft">초기화</button>
              </div>
              <div class="right">
                <button type="button" class="btn btn-primary" id="btnSubmitAll">월말 일괄 제출</button>
              </div>
            </div>

            <div id="status" class="status"></div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- 공통 -->
  <script src="./admin-common.js" defer></script>

  <script>
    // ✅ API_BASE는 expense_request.html의 값을 그대로 복사해서 쓰세요. :contentReference[oaicite:14]{index=14}
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";
    window.CHEESE_ADMIN_API_BASE = API_BASE;

    // ===== 상태 UI =====
    function setStatus(msg, type) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.classList.remove("error", "ok");
      if (type === "error") el.classList.add("error");
      if (type === "ok") el.classList.add("ok");
    }

    // ===== 숫자 처리 =====
    function toNumber(v) {
      const n = String(v || "").replace(/[^\d.-]/g, "");
      return Number(n || 0);
    }
    function fmtWon(n) {
      try { return Number(n || 0).toLocaleString() + " 원"; }
      catch { return String(n || 0) + " 원"; }
    }

    // ===== 세션 기반 actor (expense_request가 쓰는 방식과 동일 계열로) =====
    function getActor() {
      // admin-common 쪽에서 로그인 후 세션에 role/empNo 등을 저장해 쓰는 구조라(cheese_admin_role 등) :contentReference[oaicite:15]{index=15}
      // 여기서는 emp_no 우선, 없으면 drafterId(페이지에서 세팅)로 fallback.
      const empNo = sessionStorage.getItem("cheese_admin_emp_no") || "";
      const drafter = document.getElementById("drafterId").value || "";
      return empNo || drafter;
    }

    // ===== Draft 저장 =====
    function draftKey() {
      const m = document.getElementById("monthKey").value || "";
      return "cheese_expense_monthly_draft_" + (m || "no_month");
    }
    function updateDraftPill() {
      const m = document.getElementById("monthKey").value || "(미선택)";
      document.getElementById("draftPill").textContent = "Draft: " + m;
    }

    // ===== 데이터 =====
    let receipts = []; // {date,vendor,evidence,memo, lines:[{requestId, amount}]}

    // ===== 분할 라인 UI =====
    function allocRowTemplate(line = {requestId:"", amount:""}) {
      const div = document.createElement("div");
      div.className = "alloc-row";
      div.innerHTML = `
        <input class="input alloc-request" list="approvedRequestList" placeholder="request_id" value="${escapeHtml(line.requestId || "")}" />
        <input class="input alloc-amount" inputmode="numeric" placeholder="금액(원)" value="${escapeHtml(line.amount || "")}" />
        <button type="button" class="btn btn-ghost alloc-del">삭제</button>
      `;
      div.querySelector(".alloc-del").addEventListener("click", () => {
        div.remove();
        recalcAllocTotal();
      });
      div.querySelector(".alloc-amount").addEventListener("input", recalcAllocTotal);
      div.querySelector(".alloc-request").addEventListener("input", recalcAllocTotal);
      return div;
    }

    function recalcAllocTotal() {
      const rows = document.querySelectorAll("#allocWrap .alloc-row");
      let sum = 0;
      rows.forEach(r => {
        sum += toNumber(r.querySelector(".alloc-amount").value);
      });
      document.getElementById("allocTotal").textContent = fmtWon(sum);
    }

    function resetAllocLines() {
      const wrap = document.getElementById("allocWrap");
      wrap.innerHTML = "";
      wrap.appendChild(allocRowTemplate());
      recalcAllocTotal();
    }

    // ===== 영수증 입력 초기화 =====
    function resetReceiptInputs() {
      document.getElementById("rDate").value = "";
      document.getElementById("rVendor").value = "";
      document.getElementById("rEvidence").value = "";
      document.getElementById("rMemo").value = "";
      resetAllocLines();
    }

    // ===== 목록 렌더 =====
    function renderReceiptTable() {
      const tb = document.getElementById("receiptTbody");
      if (!receipts.length) {
        tb.innerHTML = `<tr><td colspan="5" style="color:#6b7280;">아직 추가된 영수증이 없습니다.</td></tr>`;
        return;
      }

      tb.innerHTML = "";
      receipts.forEach((r, idx) => {
        const total = r.lines.reduce((a, b) => a + Number(b.amount || 0), 0);
        const splitText = r.lines.map(x => `${x.requestId}:${fmtWon(x.amount)}`).join("\n");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.date || "")}</td>
          <td>
            <div style="font-weight:700; color:#111827;">${escapeHtml(r.vendor || "")}</div>
            <div style="margin-top:4px; color:#6b7280; white-space:pre-line;">${escapeHtml(r.memo || "")}</div>
            ${r.evidence ? `<div style="margin-top:6px;"><a href="${escapeHtml(r.evidence)}" target="_blank" rel="noopener noreferrer">증빙 링크</a></div>` : ``}
          </td>
          <td style="white-space:pre-line; color:#374151;">${escapeHtml(splitText)}</td>
          <td style="font-weight:700;">${fmtWon(total)}</td>
          <td>
            <div class="row-actions">
              <button type="button" class="btn btn-ghost" data-act="up">위</button>
              <button type="button" class="btn btn-ghost" data-act="down">아래</button>
              <button type="button" class="btn" data-act="edit">편집</button>
              <button type="button" class="btn btn-ghost" data-act="del">삭제</button>
            </div>
          </td>
        `;

        tr.querySelectorAll("button[data-act]").forEach(btn => {
          btn.addEventListener("click", () => {
            const act = btn.getAttribute("data-act");
            if (act === "del") {
              receipts.splice(idx, 1);
              renderReceiptTable();
              return;
            }
            if (act === "up" && idx > 0) {
              const tmp = receipts[idx - 1]; receipts[idx - 1] = receipts[idx]; receipts[idx] = tmp;
              renderReceiptTable(); return;
            }
            if (act === "down" && idx < receipts.length - 1) {
              const tmp = receipts[idx + 1]; receipts[idx + 1] = receipts[idx]; receipts[idx] = tmp;
              renderReceiptTable(); return;
            }
            if (act === "edit") {
              // 간단 편집: 입력 폼으로 되돌리고 기존 건 삭제
              const item = receipts[idx];
              receipts.splice(idx, 1);

              document.getElementById("rDate").value = item.date || "";
              document.getElementById("rVendor").value = item.vendor || "";
              document.getElementById("rEvidence").value = item.evidence || "";
              document.getElementById("rMemo").value = item.memo || "";

              const wrap = document.getElementById("allocWrap");
              wrap.innerHTML = "";
              item.lines.forEach(line => wrap.appendChild(allocRowTemplate({
                requestId: line.requestId,
                amount: String(line.amount || "")
              })));
              if (!item.lines.length) wrap.appendChild(allocRowTemplate());
              recalcAllocTotal();

              renderReceiptTable();
            }
          });
        });

        tb.appendChild(tr);
      });
    }

    // ===== 검증 =====
    function validateBeforeSubmitAll() {
      const approvalLineId = document.getElementById("expense-approval-line-id").value || "";
      const approvalLineName = document.getElementById("expense-approval-line-name").value || "";
      const approvalLineJson = document.getElementById("approvalLineJson").value || "";

      if (!approvalLineId || !approvalLineName || !approvalLineJson) {
        return "결재선을 먼저 선택해주세요.";
      }
      if (!receipts.length) {
        return "제출할 영수증이 없습니다.";
      }
      for (const r of receipts) {
        if (!r.date) return "영수증 날짜가 비어있는 항목이 있습니다.";
        if (!r.vendor) return "거래처/상호가 비어있는 항목이 있습니다.";
        if (!r.lines?.length) return "분할 라인이 없는 영수증이 있습니다.";
        for (const ln of r.lines) {
          if (!ln.requestId) return "request_id가 비어있는 라인이 있습니다.";
          if (!ln.amount || Number(ln.amount) <= 0) return "금액이 0 이하인 라인이 있습니다.";
        }
      }
      return "";
    }

    // ===== 기존 지출 제출( submitExpense ) 호출 =====
    async function postSubmitExpense(payload) {
      // expense_request.html이 submitExpense를 이 방식으로 POST합니다. :contentReference[oaicite:16]{index=16}
      const params = new URLSearchParams(payload);
      const res = await fetch(API_BASE, { method: "POST", body: params });
      const data = await res.json();
      if (!data || data.ok !== true) {
        throw new Error((data && (data.message || data.error)) || "submitExpense 실패");
      }
      return data;
    }

    // ===== 승인된 request_id datalist 로드(선택 도움) =====
    async function loadApprovedRequestIdsOnce() {
      try {
        const actor = getActor();
        if (!actor) return;

        // expense_request는 승인된 예산요청을 mode=myApprovedBudgetRequests 로 조회합니다. :contentReference[oaicite:17]{index=17}
        const url = `${API_BASE}?mode=myApprovedBudgetRequests&requester=${encodeURIComponent(actor)}&limit=50`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data || data.ok !== true) return;

        const list = Array.isArray(data.items) ? data.items : [];
        const dl = document.getElementById("approvedRequestList");
        dl.innerHTML = "";
        list.forEach(it => {
          const opt = document.createElement("option");
          opt.value = it.request_id || "";
          dl.appendChild(opt);
        });
      } catch (e) {
        // 추천 기능은 실패해도 핵심 흐름은 계속 진행
        console.warn("approved request list load failed:", e);
      }
    }

    // ===== 유틸 =====
    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    // ===== 이벤트 바인딩 =====
    document.addEventListener("DOMContentLoaded", () => {
      // 대상 월 기본값: 현재 월
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      document.getElementById("monthKey").value = ym;
      updateDraftPill();

      // 결재선/드래프트 연동
      document.getElementById("monthKey").addEventListener("change", () => {
        updateDraftPill();
      });

      // 라인 초기 세팅
      resetAllocLines();

      document.getElementById("btnAddAlloc").addEventListener("click", () => {
        document.getElementById("allocWrap").appendChild(allocRowTemplate());
        recalcAllocTotal();
      });
      document.getElementById("btnClearAlloc").addEventListener("click", resetAllocLines);

      document.getElementById("btnResetReceipt").addEventListener("click", resetReceiptInputs);

      document.getElementById("btnAddReceipt").addEventListener("click", () => {
        const date = document.getElementById("rDate").value;
        const vendor = document.getElementById("rVendor").value.trim();
        const evidence = document.getElementById("rEvidence").value.trim();
        const memo = document.getElementById("rMemo").value.trim();

        const rows = document.querySelectorAll("#allocWrap .alloc-row");
        const lines = [];
        rows.forEach(r => {
          const requestId = (r.querySelector(".alloc-request").value || "").trim();
          const amount = toNumber(r.querySelector(".alloc-amount").value);
          if (requestId || amount) {
            lines.push({ requestId, amount });
          }
        });

        // 최소 검증
        if (!date) return setStatus("영수증 날짜를 입력해 주세요.", "error");
        if (!vendor) return setStatus("거래처/상호를 입력해 주세요.", "error");
        if (!lines.length) return setStatus("분할 라인을 1개 이상 입력해 주세요.", "error");
        for (const ln of lines) {
          if (!ln.requestId) return setStatus("분할 라인에 request_id가 비어있습니다.", "error");
          if (!ln.amount || ln.amount <= 0) return setStatus("분할 라인 금액이 0 이하입니다.", "error");
        }

        receipts.push({ date, vendor, evidence, memo, lines });
        renderReceiptTable();
        resetReceiptInputs();
        setStatus("영수증을 목록에 추가했습니다.", "ok");
      });

      // Draft 저장/불러오기/초기화
      document.getElementById("btnSaveDraft").addEventListener("click", () => {
        const payload = {
          monthKey: document.getElementById("monthKey").value || "",
          monthEvidence: document.getElementById("monthEvidence").value || "",
          monthMemoPrefix: document.getElementById("monthMemoPrefix").value || "",
          approvalLineId: document.getElementById("expense-approval-line-id").value || "",
          approvalLineName: document.getElementById("expense-approval-line-name").value || "",
          approvalLineJson: document.getElementById("approvalLineJson").value || "",
          receipts
        };
        localStorage.setItem(draftKey(), JSON.stringify(payload));
        setStatus("임시저장 완료(localStorage).", "ok");
      });

      document.getElementById("btnLoadDraft").addEventListener("click", () => {
        const raw = localStorage.getItem(draftKey());
        if (!raw) return setStatus("저장된 Draft가 없습니다.", "error");
        try {
          const data = JSON.parse(raw);
          document.getElementById("monthKey").value = data.monthKey || "";
          document.getElementById("monthEvidence").value = data.monthEvidence || "";
          document.getElementById("monthMemoPrefix").value = data.monthMemoPrefix || "";
          document.getElementById("expense-approval-line-id").value = data.approvalLineId || "";
          document.getElementById("expense-approval-line-name").value = data.approvalLineName || "";
          document.getElementById("approvalLineJson").value = data.approvalLineJson || "";
          receipts = Array.isArray(data.receipts) ? data.receipts : [];
          renderReceiptTable();
          updateDraftPill();
          setStatus("Draft 불러오기 완료.", "ok");
        } catch (e) {
          setStatus("Draft 파싱 실패: " + String(e), "error");
        }
      });

      document.getElementById("btnClearDraft").addEventListener("click", () => {
        receipts = [];
        renderReceiptTable();
        resetReceiptInputs();
        setStatus("화면/목록 초기화 완료.", "ok");
      });

      // 일괄 제출
      document.getElementById("btnSubmitAll").addEventListener("click", async () => {
        const err = validateBeforeSubmitAll();
        if (err) return setStatus(err, "error");

        const actor = getActor();
        if (!actor) return setStatus("로그인 사용자(actor)를 확인할 수 없습니다.", "error");

        const monthEvidence = (document.getElementById("monthEvidence").value || "").trim();
        const memoPrefix = (document.getElementById("monthMemoPrefix").value || "").trim();

        const approvalLineId = document.getElementById("expense-approval-line-id").value || "";
        const approvalLineName = document.getElementById("expense-approval-line-name").value || "";
        const approvalLineJson = document.getElementById("approvalLineJson").value || "";

        // 제출 진행
        let okCount = 0;
        let failCount = 0;
        const results = [];

        setStatus("월말 일괄 제출 중...", "");

        for (let i = 0; i < receipts.length; i++) {
          const r = receipts[i];
          const evidence = (r.evidence || "").trim() || monthEvidence;

          for (let j = 0; j < r.lines.length; j++) {
            const ln = r.lines[j];

            const descParts = [];
            if (memoPrefix) descParts.push(memoPrefix);
            descParts.push(`[영수증 ${i+1}] ${r.vendor}`);
            if (r.memo) descParts.push(r.memo);
            descParts.push(`(라인 ${j+1})`);

            const payload = {
              mode: "submitExpense",
              actor,
              requesterId: actor, // 서버에서 어떤 키를 쓰는지 환경마다 다를 수 있어 같이 보냄
              requestId: ln.requestId,
              date: r.date,
              vendor: r.vendor,
              amountTotal: String(ln.amount),
              receiptUrl: evidence,
              description: descParts.join(" "),
              approvalLineId,
              approvalLineName,
              approvalLineJson
            };

            try {
              const data = await postSubmitExpense(payload);
              okCount++;
              results.push({ ok: true, requestId: ln.requestId, amount: ln.amount, expenseId: data.expenseId || "" });
              setStatus(`제출 진행중... 성공 ${okCount} / 실패 ${failCount}`, "");
            } catch (e) {
              failCount++;
              results.push({ ok: false, requestId: ln.requestId, amount: ln.amount, error: String(e) });
              setStatus(`제출 진행중... 성공 ${okCount} / 실패 ${failCount}`, "error");
            }
          }
        }

        // 결과 요약
        const lines = [];
        lines.push(`월말 제출 완료`);
        lines.push(`- 성공: ${okCount}`);
        lines.push(`- 실패: ${failCount}`);
        if (failCount) {
          lines.push("");
          lines.push("실패 목록(상위 5개):");
          results.filter(x => !x.ok).slice(0, 5).forEach(x => {
            lines.push(`- ${x.requestId} / ${fmtWon(x.amount)} : ${x.error}`);
          });
        }

        setStatus(lines.join("\n"), failCount ? "error" : "ok");
      });

      // 승인 request_id 추천 로딩(선택 도움)
      loadApprovedRequestIdsOnce();

      // 기본 입력 초기화
      resetReceiptInputs();
      renderReceiptTable();
    });
  </script>
</body>
</html>
