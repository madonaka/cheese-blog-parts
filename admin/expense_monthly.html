<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>월말 지출결의 · Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 공통 관리자 스타일 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== 화면(관리자 UI) ===== */
    .page-wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      padding:14px;
    }
    .card h2{ margin:0 0 10px; font-size:16px; }
    .row{ display:flex; gap:10px; align-items:center; margin:10px 0; }
    .row > label{ width:110px; font-size:13px; color:#374151; }
    .row > input, .row > select, .row > textarea{
      flex:1;
      width:100%;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:10px;
      font-size:14px;
      background:#fff;
      box-sizing:border-box;
    }
    .row textarea{ min-height:70px; resize:vertical; }
    .btn-row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn.primary{
      border-color:#111827;
      background:#111827;
      color:#fff;
    }
    .btn.danger{
      border-color:#ef4444;
      color:#ef4444;
      background:#fff;
    }
    .hint{ font-size:12px; color:#6b7280; line-height:1.35; margin-top:8px; }
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:13px;
      color:#374151;
      white-space:pre-wrap;
    }
    .status.error{
      border-color:#fecaca;
      background:#fff1f2;
      color:#991b1b;
    }

    /* ===== 후보 지출 목록 ===== */
    .list-wrap{ margin-top:10px; }
    .list-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .list-toolbar .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mini{
      font-size:12px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:12px;
      border:1px solid #e5e7eb;
    }
    .table th, .table td{
      border-bottom:1px solid #e5e7eb;
      padding:8px 10px;
      font-size:12px;
      vertical-align:top;
    }
    .table th{
      background:#f9fafb;
      color:#111827;
      font-weight:800;
      text-align:left;
      white-space:nowrap;
    }
    .table td .sub{ display:block; color:#6b7280; font-size:11px; margin-top:2px; }
    .table td.money{ text-align:right; white-space:nowrap; font-variant-numeric: tabular-nums; }
    .table td.check{ width:32px; text-align:center; }
    .table td a{ color:#2563eb; text-decoration:none; }

    /* ===== 인쇄용 문서 ===== */
    .doc-wrap{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
      padding:14px;
    }
    .doc{
      max-width: 820px;
      margin: 0 auto;
      color:#111;
      font-family: "Malgun Gothic", "Apple SD Gothic Neo", system-ui, -apple-system, sans-serif;
    }
    .doc-title{
      text-align:center;
      font-size:22px;
      font-weight:900;
      letter-spacing:-0.03em;
      margin:8px 0 12px;
    }

    .doc-top{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px;
      align-items:stretch;
    }
    .box{
      border:1px solid #111;
    }
    .top-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .top-table th, .top-table td{
      border:1px solid #111;
      padding:6px 8px;
    }
    .top-table th{ width:90px; background:#f5f5f5; text-align:left; }

    .appr{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .appr th, .appr td{
      border:1px solid #111;
      padding:6px 4px;
      text-align:center;
    }
    .appr th{
      background:#f5f5f5;
      font-weight:900;
      width:56px;
    }
    .stamp{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:36px;
      height:36px;
      border:2px solid #ef4444;
      color:#ef4444;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      margin:2px auto 0;
      user-select:none;
    }
    .appr-name{
      font-size:11px;
      color:#111;
      margin-top:4px;
    }
    .appr-date{
      font-size:10px;
      color:#111;
      margin-top:4px;
    }

    .memo-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin:10px 0 12px;
    }
    .memo-row{
      border:1px solid #111;
      display:grid;
      grid-template-columns: 110px 1fr;
      font-size:12px;
    }
    .memo-row > div{
      border-right:1px solid #111;
      padding:8px;
      background:#f5f5f5;
      font-weight:900;
    }
    .memo-row > textarea{
      border:0;
      padding:8px;
      font-size:12px;
      resize:none;
      height:52px;
      outline:none;
    }

    .pay-head{
      border:1px solid #111;
      padding:6px 8px;
      background:#fff3a3;
      font-size:12px;
      font-weight:900;
      margin-top:6px;
    }

    .items{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .items th, .items td{
      border:1px solid #111;
      padding:7px 8px;
      vertical-align:top;
    }
    .items th{
      background:#f5f5f5;
      text-align:center;
      font-weight:900;
    }
    .items td.money{
      text-align:right;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .items td.vendor{ width:160px; }
    .items td.desc{ }
    .items td.money{ width:120px; }

    .sum{
      width:320px;
      margin-left:auto;
      margin-top:10px;
      border-collapse:collapse;
      font-size:12px;
    }
    .sum th, .sum td{
      border:1px solid #111;
      padding:7px 8px;
    }
    .sum th{ background:#f5f5f5; text-align:left; width:140px; }
    .sum td{ text-align:right; font-variant-numeric: tabular-nums; }

    .muted{ color:#6b7280; font-size:12px; text-align:center; padding:14px 0; }

    /* ===== Print ===== */
    
    /* 상태 표시(목록) */
    .status-chip{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      line-height:1.3;
      border:1px solid #cbd5e1;
      background:#fff;
      white-space:nowrap;
    }
    .status-approved{ border-color:#16a34a; color:#16a34a; }
    .status-submitted{ border-color:#2563eb; color:#2563eb; }
    .status-rejected{ border-color:#ef4444; color:#ef4444; }

@media print{
      /* 화면 UI 숨김 */
      #admin-header-slot, #admin-menu-slot, .page-wrap .card:not(.doc-wrap), .page-wrap .grid, .noprint { display:none !important; }
      body{ background:#fff !important; }
      .doc-wrap{ border:0; box-shadow:none; padding:0; }
      .doc{ max-width:none; }
      @page{ size:A4; margin: 10mm; }
    }
  </style>

  <script>
    // ✅ 사이드바 active 상태 표시 (admin-menu.html의 data-page 값과 맞추세요)
    window.CHEESE_ADMIN_ACTIVE_PAGE = "expense_monthly_resolution";
    window.CHEESE_ADMIN_PAGE_TITLE = "월말 지출결의";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "승인된 지출을 월 단위로 묶어 출력";
  </script>

  <script src="./admin-common.js"></script>
</head>
<body>
  <!-- 공통 헤더/메뉴 -->
  <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- 왼쪽 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- 오른쪽 메인 내용 -->
      <main>
      <div class="page-wrap">
        <div class="grid">
          <!-- ===== 좌측: 입력/조회 ===== -->
          <section class="card">
            <h2>월말 지출결의 생성</h2>

            <div class="row">
              <label>대상월</label>
              <input type="month" id="month" />
            </div>

            <div class="row">
              <label>요청자(사번)</label>
              <input type="text" id="requester" placeholder="예: CL25-0001" />
            </div>

            <div class="row">
              <label>작성부서</label>
              <input type="text" id="dept" placeholder="예: 운영팀-020" />
            </div>

            <div class="row">
              <label>작성자</label>
              <input type="text" id="writer" placeholder="예: 이주연" />
            </div>

            <div class="row">
              <label>문서번호</label>
              <input type="text" id="docNo" placeholder="예: EXP-2025-12-001" />
            </div>

            <div class="row">
              <label>검토의견</label>
              <textarea id="reviewMemo" placeholder="(선택)"></textarea>
            </div>

            <div class="row">
              <label>합의</label>
              <textarea id="agreeMemo" placeholder="(선택)"></textarea>
            </div>

            <div class="row">
              <label>집계 상태</label>
              <select id="statusFilter">
                <option value="approved">승인(approved)만</option>
                <option value="submitted">결재중(submitted)만</option>
                <option value="all">전체(승인+결재중+반려 포함)</option>
              </select>
            </div>

            <div class="btn-row">
              <button class="btn primary" id="btn-load">지출 불러오기</button>
              <button class="btn" id="btn-build">문서 미리보기 반영</button>
              <button class="btn" id="btn-print">인쇄</button>
              <button class="btn danger" id="btn-clear">선택 초기화</button>
            </div>

            <div class="hint">
              - 이 페이지는 <b>기존 Apps Script의 myExpenseList</b>를 호출해서, 해당 월의 지출을 <b>선택</b> 후
              “지출결의서(지급품의)” 형식으로 출력합니다.<br/>
              - <b>마감(집계)용</b>이라면, 여기서는 <b>추가 승인</b>을 요구하지 않고 출력만 하도록 설계했습니다.
            </div>

            <div id="status" class="status">준비됨</div>

            <div class="list-wrap">
              <div class="list-toolbar">
                <div class="left">
                  <button class="mini" id="btn-select-all">전체 선택</button>
                  <button class="mini" id="btn-select-none">전체 해제</button>
                </div>
                <div class="right" style="font-size:12px;color:#6b7280;">
                  선택 합계: <b id="selSum">0</b> 원
                </div>
              </div>

              <table class="table" id="expenseTable">
                <thead>
                  <tr>
                    <th class="check"></th>
                    <th>일자</th>
                    <th>거래처 / 사용내역</th>
                    <th class="money">금액</th>
                    <th>증빙</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted">지출을 불러오면 여기에 표시됩니다.</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- ===== 우측: 문서(인쇄영역) ===== -->
          <section class="doc-wrap">
            <div class="doc" id="doc">
              <div class="doc-title">지출결의서(지급품의)</div>

              <div class="doc-top">
                <!-- 좌측 상단 정보 -->
                <div class="box">
                  <table class="top-table">
                    <tbody>
                      <tr>
                        <th>문서번호</th>
                        <td id="p_docNo"></td>
                      </tr>
                      <tr>
                        <th>작성일</th>
                        <td id="p_writtenAt"></td>
                      </tr>
                      <tr>
                        <th>작성부서</th>
                        <td id="p_dept"></td>
                      </tr>
                      <tr>
                        <th>작성자</th>
                        <td id="p_writer"></td>
                      </tr>
                      <tr>
                        <th>작성사번</th>
                        <td id="p_requester"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- 우측 결재란 -->
                <div class="box">
                  <table class="appr">
                    <thead>
                      <tr><th colspan="3">결재</th></tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th>담당</th>
                        <th>부장</th>
                        <th>사장</th>
                      </tr>
                      <tr>
                        <td>
                          <div class="stamp">승인</div>
                          <div class="appr-name" id="p_appr1"></div>
                          <div class="appr-date" id="p_apprDate1"></div>
                        </td>
                        <td>
                          <div class="stamp" style="opacity:.2">승인</div>
                          <div class="appr-name" id="p_appr2"></div>
                          <div class="appr-date" id="p_apprDate2"></div>
                        </td>
                        <td>
                          <div class="stamp" style="opacity:.2">승인</div>
                          <div class="appr-name" id="p_appr3"></div>
                          <div class="appr-date" id="p_apprDate3"></div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="memo-grid">
                <div class="memo-row">
                  <div>검토의견</div>
                  <textarea id="p_reviewMemo" readonly></textarea>
                </div>
                <div class="memo-row">
                  <div>합의</div>
                  <textarea id="p_agreeMemo" readonly></textarea>
                </div>
              </div>

              <div class="pay-head">
                지급요청일: <span id="p_payDate"></span>
                <span style="float:right; font-weight:800;">당사 정기 결재일</span>
              </div>

              <table class="items" style="margin-top:6px;">
                <thead>
                  <tr>
                    <th style="width:160px;">거래처</th>
                    <th>사용내역 및 용도</th>
                    <th style="width:120px;">금액</th>
                  </tr>
                </thead>
                <tbody id="p_items">
                  <tr><td colspan="3" class="muted">좌측에서 지출을 선택한 뒤 “문서 미리보기 반영”을 누르세요.</td></tr>
                </tbody>
              </table>

              <table class="sum">
                <tbody>
                  <tr><th>합계</th><td id="p_sum_supply">0</td></tr>
                  <tr><th>부가가치세</th><td id="p_sum_vat">0</td></tr>
                  <tr><th>총 지출 합계</th><td id="p_sum_total">0</td></tr>
                </tbody>
              </table>
            </div>

            <div class="noprint" style="margin-top:10px; font-size:12px; color:#6b7280;">
              - 인쇄 시에는 이 문서 영역만 출력됩니다.
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ✅ 기존 페이지들에서 쓰는 API_BASE를 그대로 사용 (너의 배포 URL로 맞춰두기)
    const API_BASE = "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";
    window.CHEESE_ADMIN_API_BASE = API_BASE;

    // ===== 유틸 =====
    function setStatus(msg, isError){
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = String(msg || "");
      el.classList.toggle("error", !!isError);
    }
    function fmtMoney(n){
      const x = Number(n || 0);
      if (!isFinite(x)) return "0";
      return Math.round(x).toLocaleString("ko-KR");
    }
    function ymd(d){
      if (!d) return "";
      const dt = (d instanceof Date) ? d : new Date(d);
      if (isNaN(dt.getTime())) return "";
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const day = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function parseAnyDate(v){
      if (!v) return null;
      if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
      const s = String(v).trim();
      if (!s) return null;

      // yyyy-mm-dd / yyyy/mm/dd
      const m1 = s.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})/);
      if (m1){
        const dt = new Date(Number(m1[1]), Number(m1[2])-1, Number(m1[3]));
        return isNaN(dt.getTime()) ? null : dt;
      }

      // timestamp / ISO
      const dt = new Date(s);
      return isNaN(dt.getTime()) ? null : dt;
    }
    function monthKey(dt){
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    // ===== 상태/표시 유틸 =====
    function normalizeStatus(raw){
      const s = String(raw || '').trim();
      if (!s) return '';
      const low = s.toLowerCase();

      // 시트/표기 흔들림 방어 (예: '승인(approved)', '결재중(submitted)', '반려(rejected)')
      if (low === 'approved' || low.includes('approved') || s.includes('승인')) return 'approved';
      if (low === 'submitted' || low.includes('submitted') || s.includes('결재') || s.includes('진행') || s.includes('대기')) return 'submitted';
      if (low === 'rejected' || low.includes('rejected') || s.includes('반려') || s.includes('거절')) return 'rejected';

      return low;
    }

    function statusText(key){
      if (key === 'approved') return '승인';
      if (key === 'submitted') return '결재중';
      if (key === 'rejected') return '반려';
      return key || '알수없음';
    }

    // 예산요청 제목 매핑(요청ID → 제목). EXPENSES에는 제목이 없을 수 있어, 화면에서 보강함.
    let reqTitleMap = {};
    async function loadRequestTitleMap(requesterId){
      reqTitleMap = {};
      const pageSize = 200;

      for (let page = 1; page <= 5; page++){
        const url = `${API_BASE}?mode=myBudgetList&requesterId=${encodeURIComponent(requesterId)}&page=${page}&pageSize=${pageSize}`;
        try{
          const res = await fetch(url, { method: 'GET', cache: 'no-store' });
          const j = await res.json();
          if (!j || !j.ok || !Array.isArray(j.items) || j.items.length === 0) break;

          for (const it of j.items){
            const rid = it && it.request_id ? String(it.request_id).trim() : '';
            const title = it && it.title ? String(it.title).trim() : '';
            if (rid && title) reqTitleMap[rid] = title;
          }

          if (j.items.length < pageSize) break;
        } catch (e){
          break;
        }
      }
    }

    // ===== 전역 상태 =====
    let allExpenses = [];       // API에서 가져온 전체(해당 requester)
    let filtered = [];          // 해당월 + 상태필터
    const selected = new Set(); // expense_id

    function getActorEmpNo(){
      return (window.CHEESE_ADMIN_EMP_NO || sessionStorage.getItem("cheese_admin_emp_no") || "").trim();
    }
    function getDefaultMonth(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }
    function genDocNo(mon){
      // EXP-YYYY-MM-XXX
      const base = (mon || getDefaultMonth()).replace("-", "");
      const rnd = String(Math.floor(Math.random()*900)+100);
      return `EXP-${base.slice(0,4)}-${base.slice(4,6)}-${rnd}`;
    }

    async function apiGetJson(params){
      const usp = new URLSearchParams(params);
      const res = await fetch(API_BASE + "?" + usp.toString(), { method:"GET" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "API 에러");
      return json.data;
    }

    async function loadExpensesForRequester(requester){
      // 페이지네이션 모두 수집 (size 크게)
      const size = 200;
      let page = 1;
      const out = [];
      for (let guard = 0; guard < 50; guard++){ // 안전장치
        const data = await apiGetJson({
          mode: "myExpenseList",
          requester,
          page: String(page),
          size: String(size),
        });

        const items = (data && data.items) ? data.items : [];
        out.push(...items);

        if (items.length < size) break;
        page += 1;
      }
      return out;
    }

    function applyFilter(){
      const mon = (document.getElementById("month").value || "").trim();
      const st = (document.getElementById("statusFilter").value || "approved").trim();

      filtered = allExpenses.filter(x => {
        const dt = parseAnyDate(x.date || x.requested_at);
        if (!dt) return false;
        if (monthKey(dt) !== mon) return false;

        if (st === "all") return true;
        const key = normalizeStatus(x.status);
        return key === st;
      });

      // 선택 유지: 현재 필터에 없는 선택은 해제
      const keep = new Set(filtered.map(x => String(x.expense_id || "").trim()).filter(Boolean));
      for (const id of Array.from(selected)){
        if (!keep.has(id)) selected.delete(id);
      }

      renderExpenseTable();
      updateSelectedSum();
    }

    function updateSelectedSum(){
      let sum = 0;
      for (const id of selected){
        const it = filtered.find(x => String(x.expense_id||"").trim() === id);
        if (!it) continue;
        sum += Number(it.amount_total || 0);
      }
      document.getElementById("selSum").textContent = fmtMoney(sum);
    }

    function renderExpenseTable(){
      const tbody = document.querySelector("#expenseTable tbody");
      tbody.innerHTML = "";

      if (!filtered.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="muted">조건에 맞는 지출이 없습니다.</td>`;
        tbody.appendChild(tr);
        return;
      }

      for (const it of filtered){
        const id = String(it.expense_id || "").trim();
        const statusKey = normalizeStatus(it.status);
        const statusLabel = statusText(statusKey);

        const reqId = String(it.request_id || "").trim();
        const titleText = (reqId && reqTitleMap[reqId]) ? String(reqTitleMap[reqId]) : String(it.request_title || it.title || "").trim();

        const dt = parseAnyDate(it.date || it.requested_at);
        const checked = selected.has(id);

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="check"><input type="checkbox" data-id="${id}" ${checked ? "checked":""}></td>
          <td>${ymd(dt)}</td>
          <td>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <b>${escapeHtml(String(it.vendor || "")) || (titleText ? escapeHtml(titleText) : "(거래처 미입력)")}</b>
              ${statusKey ? `<span class="status-chip status-${statusKey}">${escapeHtml(statusLabel)}</span>` : ""}
            </div>
            <span class="sub">${escapeHtml(titleText || String(it.description || "")) || "(사용내역 미입력)"}</span>
            <span class="sub">expense_id: ${escapeHtml(id)} · request_id: ${escapeHtml(reqId)}</span>
          </td>
          <td class="money">${fmtMoney(it.amount_total)}원</td>
          <td>${renderEvidenceLink(it.evidence_link)}</td>
        `;

        tbody.appendChild(tr);
      }

      tbody.querySelectorAll("input[type=checkbox][data-id]").forEach(chk => {
        chk.addEventListener("change", (e) => {
          const id = String(e.target.dataset.id || "").trim();
          if (!id) return;
          if (e.target.checked) selected.add(id);
          else selected.delete(id);
          updateSelectedSum();
        });
      });
    }

    function renderEvidenceLink(url){
      const u = String(url || "").trim();
      if (!u) return `<span class="sub">-</span>`;
      const safe = escapeHtml(u);
      return `<a href="${safe}" target="_blank" rel="noopener">열기</a>`;
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function buildDocPreview(){
      const mon = (document.getElementById("month").value || "").trim();
      const requester = (document.getElementById("requester").value || "").trim();
      const dept = (document.getElementById("dept").value || "").trim();
      const writer = (document.getElementById("writer").value || "").trim();
      const docNo = (document.getElementById("docNo").value || "").trim();
      const reviewMemo = (document.getElementById("reviewMemo").value || "").trim();
      const agreeMemo = (document.getElementById("agreeMemo").value || "").trim();

      document.getElementById("p_docNo").textContent = docNo;
      document.getElementById("p_writtenAt").textContent = ymd(new Date());
      document.getElementById("p_dept").textContent = dept;
      document.getElementById("p_writer").textContent = writer;
      document.getElementById("p_requester").textContent = requester;
      document.getElementById("p_reviewMemo").value = reviewMemo;
      document.getElementById("p_agreeMemo").value = agreeMemo;

      // 지급요청일: 해당월 말일
      let payDate = "";
      if (mon){
        const [y,m] = mon.split("-").map(Number);
        const last = new Date(y, m, 0); // m은 1~12, day=0 => 전월 말일
        payDate = ymd(last);
      }
      document.getElementById("p_payDate").textContent = payDate || ymd(new Date());

      // 결재자 칸(현재는 비워둠: 필요하면 입력 UI 추가)
      document.getElementById("p_appr1").textContent = "";
      document.getElementById("p_appr2").textContent = "";
      document.getElementById("p_appr3").textContent = "";
      document.getElementById("p_apprDate1").textContent = "";
      document.getElementById("p_apprDate2").textContent = "";
      document.getElementById("p_apprDate3").textContent = "";

      // 선택된 항목
      const items = filtered.filter(x => selected.has(String(x.expense_id||"").trim()));
      const tbody = document.getElementById("p_items");
      tbody.innerHTML = "";

      if (!items.length){
        tbody.innerHTML = `<tr><td colspan="3" class="muted">선택된 지출이 없습니다.</td></tr>`;
        document.getElementById("p_sum_supply").textContent = "0";
        document.getElementById("p_sum_vat").textContent = "0";
        document.getElementById("p_sum_total").textContent = "0";
        setStatus("선택된 지출이 없어 문서가 비었습니다.", true);
        return;
      }

      let sumTotal = 0, sumSupply = 0, sumVat = 0;
      for (const it of items){
        const vendor = String(it.vendor || "").trim();
        const desc = String(it.description || "").trim();
        const amtTotal = Number(it.amount_total || 0);
        const amtSupply = Number(it.amount_supply || 0);
        const amtVat = Number(it.amount_vat || 0);

        sumTotal += amtTotal;
        sumSupply += amtSupply;
        sumVat += amtVat;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="vendor">${escapeHtml(vendor)}</td>
          <td class="desc">
            ${escapeHtml(desc || "-")}
            <div class="sub" style="color:#6b7280;margin-top:4px;">(expense_id: ${escapeHtml(it.expense_id)} / request_id: ${escapeHtml(it.request_id||"")})</div>
          </td>
          <td class="money">${fmtMoney(amtTotal)}</td>
        `;
        tbody.appendChild(tr);
      }

      // supply/vat이 비어있으면(0) 총액 기준으로 합계 표를 자연스럽게
      // - 공급가/부가세가 전부 0이면: 합계=총액, VAT=0
      const hasSupplyOrVat = (sumSupply > 0 || sumVat > 0);
      const showSupply = hasSupplyOrVat ? sumSupply : sumTotal;
      const showVat = hasSupplyOrVat ? sumVat : 0;

      document.getElementById("p_sum_supply").textContent = fmtMoney(showSupply);
      document.getElementById("p_sum_vat").textContent = fmtMoney(showVat);
      document.getElementById("p_sum_total").textContent = fmtMoney(sumTotal);

      setStatus(`미리보기 반영 완료\n선택 ${items.length}건 / 총액 ${fmtMoney(sumTotal)}원`, false);
    }

    // ===== 이벤트 =====
    document.addEventListener("DOMContentLoaded", async () => {
      // 기본값 채우기
      const monthEl = document.getElementById("month");
      const requesterEl = document.getElementById("requester");
      const docNoEl = document.getElementById("docNo");

      if (monthEl && !monthEl.value) monthEl.value = getDefaultMonth();

      const empNo = getActorEmpNo();
      if (requesterEl && !requesterEl.value && empNo) requesterEl.value = empNo;

      if (docNoEl && !docNoEl.value) docNoEl.value = genDocNo(monthEl.value);

      // 기본 문서 상단 반영
      document.getElementById("p_writtenAt").textContent = ymd(new Date());
      document.getElementById("p_payDate").textContent = ymd(new Date());
      document.getElementById("p_docNo").textContent = (docNoEl.value || "");
      document.getElementById("p_requester").textContent = (requesterEl.value || "");

      // 필터 변경 시 테이블 갱신
      document.getElementById("month").addEventListener("change", applyFilter);
      document.getElementById("statusFilter").addEventListener("change", applyFilter);

      // 버튼들
      document.getElementById("btn-load").addEventListener("click", async () => {
        try{
          const requester = (requesterEl.value || "").trim();
          if (!requester){
            setStatus("요청자(사번)를 입력해 주세요.", true);
            return;
          }
          setStatus("지출을 불러오는 중...", false);

          allExpenses = await loadExpensesForRequester(requester);

          // 예산요청 제목 매핑도 함께 로드(목록에 '요청 제목' 표시)
          await loadRequestTitleMap(requester);

          // 선택 초기화
          selected.clear();
          applyFilter();

          setStatus(`불러오기 완료: ${allExpenses.length}건 (표시: ${filtered.length}건)
(대상월/상태 조건으로 자동 필터링됩니다)`, false);
// 문서 상단도 반영
          document.getElementById("p_requester").textContent = requester;
        }catch(err){
          console.error(err);
          setStatus("불러오기 실패: " + err.message, true);
        }
      });

      document.getElementById("btn-build").addEventListener("click", () => {
        const docNo = (docNoEl.value || "").trim();
        if (!docNo){
          docNoEl.value = genDocNo((monthEl.value||"").trim());
        }
        // 상단 즉시 반영
        document.getElementById("p_docNo").textContent = docNoEl.value.trim();
        document.getElementById("p_dept").textContent = (document.getElementById("dept").value||"").trim();
        document.getElementById("p_writer").textContent = (document.getElementById("writer").value||"").trim();
        document.getElementById("p_requester").textContent = (requesterEl.value||"").trim();
        document.getElementById("p_reviewMemo").value = (document.getElementById("reviewMemo").value||"").trim();
        document.getElementById("p_agreeMemo").value = (document.getElementById("agreeMemo").value||"").trim();

        buildDocPreview();
      });

      document.getElementById("btn-print").addEventListener("click", () => {
        // 인쇄 직전에 미리보기 반영
        buildDocPreview();
        window.print();
      });

      document.getElementById("btn-clear").addEventListener("click", () => {
        selected.clear();
        renderExpenseTable();
        updateSelectedSum();
        setStatus("선택을 초기화했습니다.", false);
      });

      document.getElementById("btn-select-all").addEventListener("click", () => {
        for (const it of filtered){
          const id = String(it.expense_id||"").trim();
          if (id) selected.add(id);
        }
        renderExpenseTable();
        updateSelectedSum();
      });

      document.getElementById("btn-select-none").addEventListener("click", () => {
        selected.clear();
        renderExpenseTable();
        updateSelectedSum();
      });

      // 최초 자동 필터 적용(아직 데이터 없음)
      applyFilter();
    });
  </script>
</body>
</html>
