<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¬¸ì„œ ì•„ì¹´ì´ë¸Œ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
    
    // ğŸš¨ í•„ìˆ˜ ì„¤ì •: ìƒì„±ëœ ë¬¸ì„œ(íŒŒì¼)ê°€ ì €ì¥ë  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID
    const ARCHIVE_FOLDER_ID = "1MpTCfw8B1Y-77QFr4k5SCPfVQgso8fKi"; 
  </script>
  <script src="./admin-common.js"></script>

  <style>
    /* ì•„ì¹´ì´ë¸Œ ì „ìš© ìŠ¤íƒ€ì¼ */
    .archive-header { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .archive-title h2 { font-size: 1.8rem; color: #1e293b; margin: 0 0 8px 0; letter-spacing: -0.5px; }
    .archive-title p { color: #64748b; margin: 0; font-size: 0.95rem; }
    
    .report-controls { 
        display: flex; flex-wrap: wrap; gap: 8px; align-items: center; 
        background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .report-date-group { display: flex; align-items: center; gap: 8px; margin-right: 8px; }
    .report-date-group label { font-size: 0.9rem; font-weight: 700; color: #475569; }
    
    .btn-gen { padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; color: #475569; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-gen:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
    .btn-gen.btn-new { background: #3b82f6; color: #fff; border: none; margin-left: auto; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
    .btn-gen.btn-new:hover { background: #2563eb; }

    /* ë¬¸ì„œ ê·¸ë¦¬ë“œ */
    .doc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 12px; position: relative; overflow: hidden; min-height: 180px; }
    .doc-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
    
    .doc-type-badge { position: absolute; top: 16px; right: 16px; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .doc-card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 14px; }
    .doc-card-date { font-size: 0.85rem; color: #94a3b8; margin-top: auto; }
    .doc-card-actions { display: flex; gap: 8px; margin-top: 12px; border-top: 1px solid #f1f5f9; padding-top: 12px; }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    
    /* ëª¨ë‹¬ ë ˆì´ì–´ ê³„ì¸µ */
    #doc-modal { z-index: 2000; }
    #idea-select-modal, #schedule-maker-modal { z-index: 2100; }

    .modal-box { background: #fff; padding: 0; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); position: relative; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-box.large-modal { max-width: 1000px; height: 90vh; }

    .modal-header-custom { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .modal-title-custom { font-size: 1.2rem; font-weight: 700; color: #1e293b; }
    .modal-body-custom { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer-custom { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; background: #f8fafc; }

    /* í¼ ìš”ì†Œ */
    .styled-input, .styled-textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; font-family: inherit; box-sizing: border-box; }
    .styled-input:focus, .styled-textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 6px; }

    /* ì•„ì´ë””ì–´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .idea-select-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; transition: 0.2s; }
    .idea-select-item:hover { border-color: #ea580c; background: #fff7ed; }
    .idea-select-item input[type="checkbox"] { margin-top: 4px; transform: scale(1.2); cursor: pointer; }
    .idea-select-content { flex: 1; }
    .idea-select-title { font-weight: 700; color: #1e293b; font-size: 0.95rem; margin-bottom: 4px; }
    .idea-select-desc { font-size: 0.85rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

	/* ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì½”ë“œë“¤ ì‚¬ì´ì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš” */
	.tox-tinymce-aux { z-index: 99999 !important; }

    /* ì¸ì‡„ ìµœì í™” */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      .modal-box.large-modal { position: absolute; top: 0; left: 0; width: 100%; height: auto; box-shadow: none; }
    }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
       <div class="archive-header">
          <div class="archive-title">
            <h2>ğŸ“‚ ë³´ê³ ì„œ & ê¸°íšì„œ ì•„ì¹´ì´ë¸Œ</h2>
            <p>ë‚´ìš©ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì•ˆì „í•˜ê²Œ, ê´€ë¦¬ëŠ” ê°€ë³ê²Œ!</p>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
          </div>
          
          <div class="report-controls">
            <div class="report-date-group">
              <label for="report-base-date">ê¸°ì¤€ì¼</label>
              <input type="date" id="report-base-date" class="styled-input" style="padding: 6px 10px; width: 140px; font-weight: 600; color: #1e293b;">
            </div>

            <div style="width:1px; height:24px; background:#cbd5e1; margin:0 10px;"></div>

            <div style="display:flex; gap:6px; align-items:center;">
                <span style="font-size:0.8rem; font-weight:700; color:#3b82f6;">REPORT</span>
                <button class="btn-gen" onclick="generateAutoReport('daily')">ğŸ“ ì¼ì¼</button>
                <button class="btn-gen" onclick="generateAutoReport('weekly')">ğŸ“Š ì£¼ê°„</button>
                <button class="btn-gen" onclick="generateAutoReport('monthly')">ğŸ“… ì›”ê°„</button>
            </div>

            <div style="width:1px; height:24px; background:#cbd5e1; margin:0 10px;"></div>

            <div style="display:flex; gap:6px; align-items:center;">
                <span style="font-size:0.8rem; font-weight:700; color:#ea580c;">PLANNING</span>
                <button class="btn-gen" style="background:#fff7ed; color:#ea580c; border-color:#fed7aa;" onclick="generateProposalTemplate()">ğŸ’¡ 1-Page ê¸°íšì„œ</button>
                <button class="btn-gen" style="background:#fff7ed; color:#c2410c; border-color:#fed7aa;" onclick="openIdeaSelector('new')">âœ¨ ì•„ì´ë””ì–´ë¡œ ê¸°íš</button>
				<button class="btn-gen" style="background:#f5f3ff; color:#7c3aed; border-color:#ddd6fe;" onclick="openAIPromptModal()">ğŸ¤– AI ìë™ ê¸°íš</button>
            </div>
            
            <div style="flex:1;"></div>
            <button class="btn-gen btn-new" onclick="openDocModal(null, '', '', 'ì¼ë°˜')">+ ë¹ˆ ë¬¸ì„œ</button>
          </div>
        </div>

        <div class="doc-grid" id="doc-grid">
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 0; color: #94a3b8;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>

      </div>
    </section>
  </main>
</div>

<div id="doc-modal" class="custom-modal">
  <div class="modal-box large-modal">
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="doc-modal-title">ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
    </div>
    
    <form id="doc-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin:0;">
      <div class="modal-body-custom">
        <input type="hidden" id="doc-id" value="">
        <input type="hidden" id="doc-drive-id" value="">
        
        <div style="display:flex; gap:16px; margin-bottom:20px;">
          <div style="flex: 1;">
            <label class="input-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="doc-title" class="styled-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required style="font-size:1.1rem; font-weight:700;">
          </div>
          <div style="width: 160px;">
            <label class="input-label">ë¬¸ì„œ ìœ í˜•</label>
            <select id="doc-type" class="styled-input">
              <option value="ë³´ê³ ì„œ">ğŸ“Š ë³´ê³ ì„œ</option>
              <option value="ê¸°íšì„œ">ğŸ’¡ ê¸°íšì„œ</option>
              <option value="ì¼ë°˜">ğŸ“„ ì¼ë°˜</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; flex:1;">
          <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="doc-content" style="height: 600px; width: 100%;"></textarea>
        </div>
      </div>

      <div class="modal-footer-custom" style="justify-content: space-between;">
        <div id="modal-tools-left" style="display: flex; gap: 8px;">
            <button type="button" class="btn" onclick="openIdeaSelector('insert')" style="padding:10px 16px; border-radius:10px; border:1px solid #fed7aa; background:#fff7ed; color:#ea580c; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px;">
                âœ¨ ì•„ì´ë””ì–´ ë„£ê¸°
            </button>
            <button type="button" class="btn" onclick="openScheduleMaker()" style="padding:10px 16px; border-radius:10px; border:1px solid #bae6fd; background:#f0f9ff; color:#0284c7; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px;">
                ğŸ“… ì¼ì •í‘œ ë„£ê¸°
            </button>
        </div>

        <div style="display: flex; gap: 8px;">
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; color:#64748b; font-weight:700; cursor:pointer;" onclick="closeModal('doc-modal')">ì·¨ì†Œ</button>
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #3b82f6; background:#fff; color:#3b82f6; font-weight:700; cursor:pointer;" onclick="printReport()">ğŸ–¨ï¸ PDF</button>
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #10b981; background:#fff; color:#10b981; font-weight:700; cursor:pointer;" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
            <button type="submit" class="btn" id="btn-save-doc" style="padding:12px 24px; border-radius:12px; border:none; background:#3b82f6; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(59,130,246,0.3);">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="idea-select-modal" class="custom-modal">
  <div class="modal-box" style="width: 500px; max-width: 90vw; background: #fff; border-radius: 16px;">
    <div class="modal-header-custom" style="background:#fff7ed; border-bottom:1px solid #fed7aa;">
      <span class="modal-title-custom" style="color:#c2410c;">âœ¨ ì•„ì´ë””ì–´ ì„ íƒ</span>
      <button type="button" class="btn" onclick="document.getElementById('idea-select-modal').classList.remove('open')" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body-custom" style="padding: 20px; overflow-y: auto;">
      <p style="margin-top:0; color:#64748b; font-size:0.9rem; margin-bottom:12px;">ëª©ë¡ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
      <div id="idea-list-container" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn" onclick="document.getElementById('idea-select-modal').classList.remove('open')" style="padding:10px 20px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
      <button type="button" class="btn" onclick="confirmIdeaSelection()" style="padding:10px 20px; border-radius:8px; border:none; background:#ea580c; color:#fff; font-weight:700; cursor:pointer;">ì„ íƒ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<div id="schedule-maker-modal" class="custom-modal">
  <div class="modal-box" style="width: 1000px; max-width: 95vw; background: #fff; border-radius: 16px;">
    <div class="modal-header-custom" style="background:#f0f9ff; border-bottom:1px solid #bae6fd;">
      <span class="modal-title-custom" style="color:#0369a1;">ğŸ“… í”„ë¡œì íŠ¸ ì¼ì •í‘œ ë§Œë“¤ê¸° (Auto-Gantt)</span>
      <button type="button" class="btn" onclick="closeScheduleMaker()" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body-custom" style="padding: 24px; overflow-y: auto; max-height: 70vh;">
      <div style="background:#fff; border:2px solid #e0f2fe; border-radius:12px; padding:16px; margin-bottom:20px; display:flex; gap:20px; align-items:flex-end;">
        <div style="flex:0 0 180px;">
            <label style="display:block; font-size:0.85rem; color:#0284c7; font-weight:700; margin-bottom:6px;">ì°¨íŠ¸ ì‹œì‘ ì›”(Month)</label>
            <input type="month" id="sch-start-month" class="styled-input" style="padding:8px 12px; font-weight:600;">
        </div>
        <div style="flex:1;">
            <label style="display:block; font-size:0.85rem; color:#64748b; font-weight:700; margin-bottom:6px;">í”„ë¡œì íŠ¸ëª…</label>
            <input type="text" id="sch-project-name" class="styled-input" value="ë¸”ë¡œê·¸ ì´ê´€ í”„ë¡œì íŠ¸" style="padding:8px 12px;">
        </div>
        <div>
            <button type="button" class="btn" onclick="loadSchedulePreset()" style="padding:10px 16px; background:#f0f9ff; color:#0284c7; border:1px solid #bae6fd; font-weight:700; border-radius:8px; cursor:pointer;">âš¡ ì˜ˆì œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:12px; overflow:hidden;">
		<table style="width:100%; border-collapse: collapse; font-size:0.95rem;">
		  <thead>
			  <tr style="background:#f8fafc; color:#475569; text-align:left;">
				  <th style="padding:12px 10px; width:120px;">ë‹¨ê³„ (Category)</th>
				  <th style="padding:12px 10px;">ì‘ì—… ë‚´ìš© (Task)</th>
				  <th style="padding:12px 10px; width:130px;">ì‹œì‘ì¼</th>
				  <th style="padding:12px 0px; width:15px; text-align:center;">~</th>
				  <th style="padding:12px 10px; width:130px;">ì¢…ë£Œì¼</th>
				  <th style="padding:12px 10px; width:150px;">ê²°ê³¼ë¬¼ (Output)</th>
				  <th style="padding:12px 10px; width:50px; text-align:center;">ì‚­ì œ</th>
				  <th style="padding:12px 10px; width:80px; text-align:center;">ê´€ë¦¬</th>
			  </tr>
		  </thead>
		  <tbody id="sch-input-list" onpaste="handleTablePaste(event)"></tbody>
		</table>
      </div>
      <button type="button" onclick="addScheduleRow()" style="width:100%; margin-top:16px; padding:14px; border:2px dashed #cbd5e1; background:#fff; color:#64748b; font-weight:700; border-radius:12px; cursor:pointer; transition:0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">+ ì‘ì—… ì¶”ê°€í•˜ê¸°</button>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn" onclick="closeScheduleMaker()" style="padding:12px 24px; border-radius:12px; background:#f1f5f9; color:#64748b; border:none; cursor:pointer; font-weight:600;">ë‹«ê¸°</button>
      <button type="button" class="btn" onclick="insertSmartSchedule()" style="padding:12px 24px; border-radius:12px; background:#0284c7; color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(2, 132, 199, 0.3);">âœ¨ ì¼ì •í‘œ ì‚½ì…</button>
    </div>
  </div>
</div>


<div id="ai-prompt-modal" class="custom-modal">
  <div class="modal-box" style="width: 500px; max-width: 90vw; background: #fff; border-radius: 16px;">
    <div class="modal-header-custom" style="background:#f5f3ff; border-bottom:1px solid #ddd6fe;">
      <span class="modal-title-custom" style="color:#7c3aed;">ğŸ¤– AI ê¸°íšì„œ ìë™ ìƒì„±</span>
      <button type="button" class="btn" onclick="closeModal('ai-prompt-modal')" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body-custom" style="padding: 20px;">
      <label class="input-label" style="color:#6b7280; font-size:0.95rem;">ì–´ë–¤ í”„ë¡œì íŠ¸ë¥¼ ê¸°íší•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</label>
      <textarea id="ai-prompt-input" class="styled-textarea" style="height: 120px; margin-top: 8px;" placeholder="ì˜ˆ: í‹°ìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ì›Œë“œí”„ë ˆìŠ¤ë¡œ ì˜®ê¸¸ ê±´ë°, SEO ìœ ì‹¤ì´ ê±±ì •ë˜ê³  3ì›” ì´ˆê¹Œì§€ ëë‚´ì•¼ í•´."></textarea>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn" onclick="closeModal('ai-prompt-modal')" style="padding:10px 20px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
      <button type="button" class="btn" onclick="requestAIProposal()" style="padding:10px 20px; border-radius:8px; border:none; background:#7c3aed; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(124, 58, 237, 0.4);">âœ¨ ë§ˆë²• ë¶€ë¦¬ê¸°</button>
    </div>
  </div>
</div>


<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "report_archive"; 
  
  let g_docs = [];
  let g_logs = [];
  let g_goals = [];
  let g_tasks = [];
  
  let CURRENT_EDITING_SCHEDULE_EL = null; 
  let CURRENT_IDEA_MODE = 'new'; 

  document.addEventListener('DOMContentLoaded', () => {
    tinymce.init({
      selector: '#doc-content',
      height: 600,
      language: 'ko_KR', 
      plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
      
      // ğŸ‘‡ íˆ´ë°” ì„¤ì • (ë‘ ì¤„ë¡œ ê¹”ë”í•˜ê²Œ ë°°ì¹˜)
      toolbar: [
        'fontfamily fontsize blocks | bold italic underline strikethrough | forecolor backcolor removeformat',
        'alignleft aligncenter alignright alignjustify | bullist numlist | outdent indent | table link image | undo redo code fullscreen'
      ],
      
      // ğŸ”¥ ì  ì„¸ ê°œ(ë”ë³´ê¸°) ë©”ë‰´ë¥¼ ì—†ì• ê³  ì°½ í¬ê¸°ì— ë§ì¶° ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ ë˜ë„ë¡ ì„¤ì •
      toolbar_mode: 'wrap', 
      
      menubar: false,
      branding: false,
      font_family_formats: 'Pretendard=Pretendard,sans-serif; ë§‘ì€ ê³ ë”•=Malgun Gothic,sans-serif; ë‹ì›€=Dotum,sans-serif; êµ´ë¦¼=Gulim,sans-serif; Arial=arial,helvetica,sans-serif;',
      valid_elements: '*[*]',
      extended_valid_elements: '*[*]',
      verify_html: false, 
	  setup: function (editor) {
        editor.on('init', function () {
          const todayStr = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
          document.getElementById('report-base-date').value = todayStr;
          loadAllData();
        });
        
        // ğŸš¨ [ì¶”ê°€ëœ ë¶€ë¶„] TinyMCE ì•ˆì—ì„œ 'ìˆ˜ì •' ë²„íŠ¼ í´ë¦­ ì‹œ ë°–ìœ¼ë¡œ ì‹ í˜¸ ë³´ë‚´ê¸°
        editor.on('click', function(e) {
		  const btn = editor.dom.getParent(e.target, '.btn-edit-schedule');
          if (btn) {
            const wrapper = editor.dom.getParent(btn, '.schedule-section');
            if (wrapper) {
              window.editEmbeddedSchedule(wrapper);
            }
          }
        });
      }
    });
  });

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_logs = json.logs || []; g_goals = json.goals || []; g_tasks = json.tasks || [];
        g_docs = g_tasks.filter(t => t['ìœ í˜•'] === 'ë³´ê³ ì„œ' || t['ìœ í˜•'] === 'ê¸°íšì„œ');
        g_docs.sort((a, b) => b.ID.localeCompare(a.ID)); 
        renderDocs();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function renderDocs() {
    const root = document.getElementById('doc-grid');
    root.innerHTML = "";
    
    if(g_docs.length === 0) {
        root.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 60px; color:#94a3b8; background:#f8fafc; border-radius:16px; border:2px dashed #cbd5e1; font-weight:600;">ë³´ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>`;
        return;
    }

    g_docs.forEach(doc => {
      const card = document.createElement('div'); card.className = "doc-card";
      const isReport = doc['ìœ í˜•'] === 'ë³´ê³ ì„œ';
      const badgeColor = isReport ? '#eff6ff' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? '#fff7ed' : '#f1f5f9');
      const textColor = isReport ? '#2563eb' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? '#c2410c' : '#475569');
      const rawDate = doc['ê¸°í•œ'] ? doc['ê¸°í•œ'].split('T')[0] : 'ë‚ ì§œ ì—†ìŒ';

      card.innerHTML = `
        <div class="doc-type-badge" style="background:${badgeColor}; color:${textColor};">${doc['ìœ í˜•']}</div>
        <h3 class="doc-card-title">${doc['ì œëª©'] || '(ì œëª© ì—†ìŒ)'}</h3>
        <div class="doc-card-date">ğŸ—“ ìµœì¢… ìˆ˜ì •: ${rawDate}</div>
        <div style="flex:1; display:flex; align-items:center; justify-content:center;">
            <span style="font-size:3rem;">${doc['ìœ í˜•'] === 'ë³´ê³ ì„œ' ? 'ğŸ“Š' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? 'ğŸ’¡' : 'ğŸ“„')}</span>
        </div>
        <div class="doc-card-actions">
           <button class="btn" style="background:#f1f5f9; color:#475569; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="openDocModal('${doc.ID}'); event.stopPropagation();">ğŸ“ ì—´ê¸°</button>
           <button class="btn" style="background:#fff1f2; color:#ef4444; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="deleteDoc('${doc.ID}'); event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      `;
      card.onclick = () => openDocModal(doc.ID);
      root.appendChild(card);
    });
  }

  function generateAutoReport(rangeType) {
    const baseDateStr = document.getElementById('report-base-date').value;
    if (!baseDateStr) { alert("ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    
    const targetEndDate = new Date(baseDateStr); targetEndDate.setHours(23,59,59,999);
    let startDate = new Date(baseDateStr); startDate.setHours(0,0,0,0);
    
    let titlePrefix = "";
    if (rangeType === 'daily') {
        titlePrefix = `[ë³´ê³ ì„œ] ğŸ§€ Cheese Lab Daily Log(ì¼) - ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ${targetEndDate.getDate()}ì¼`;
    } else if (rangeType === 'weekly') {
        const day = startDate.getDay() || 7; startDate.setDate(startDate.getDate() - day + 1);
        titlePrefix = `[ë³´ê³ ì„œ] ğŸ§€ Cheese Lab Weekly Insight(ì£¼) -  ${targetEndDate.getMonth()+1}ì›” ${Math.ceil(targetEndDate.getDate()/7)}ì£¼ì°¨`;
    } else if (rangeType === 'monthly') {
        startDate.setDate(1); 
        titlePrefix = `[ë³´ê³ ì„œ] ğŸ§€ Cheese Lab Monthly Review(ì›”) -  ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ê²°ì‚°`;
    }

    const targetLogs = g_logs.filter(log => {
        if (!log['ë‚ ì§œ']) return false;
        const d = new Date(log['ë‚ ì§œ']); return d >= startDate && d <= targetEndDate;
    });

    const activeBigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && g['ìƒíƒœ'] !== 'ì™„ë£Œ');
    
    let ideaCreateLogs = [], ideaRealizeLogs = [];
    let bugCreateLogs = [], bugFixLogs = [];
    let publishLogs = [];
	let reportTagLogs = []; 
	let projectTagLogs = [];   // âœ… í”„ë¡œì íŠ¸ ë§ˆê° ë¡œê·¸
    let doneLogs = [];
    let postCount = 0;

    const BUG_IDS = new Set(
      (g_tasks || [])
        .filter(t => (t['ìœ í˜•'] || t['type'] || '') === 'ë²„ê·¸')
        .map(t => t.ID)
    );
    
    function getTag(log){ return (log['íƒœê·¸'] || log['tags'] || "").toString().trim(); }
    function getTitle(log){ return (log['ì œëª©'] || log['title'] || "").toString(); }
    function getContent(log){ return (log['ë‚´ìš©'] || log['content'] || "").toString(); }
    function extractAfterLabel(text, label) {
      if (!text) return "";
      const idx = text.indexOf(label);
      if (idx === -1) return "";
      return text.slice(idx + label.length).trim();
    }
    function getRelatedId(log){
      return (log['ê´€ë ¨_ëª©í‘œID'] || log['relatedId'] || log['ê´€ë ¨ID'] || log['ê´€ë ¨_ì‘ì—…ID'] || log['related_id'] || "").toString().trim();
    }
    function pickMeaningTitle(log) {
      const title = getTitle(log).trim();
      const content = getContent(log);
      const byTitleLabel = extractAfterLabel(content, "ì œëª©:");
      if (byTitleLabel) return byTitleLabel;
      const byWorkLabel = extractAfterLabel(content, "ì‘ì—…ëª…:");
      if (byWorkLabel) return byWorkLabel;
      const byGoalLabel = extractAfterLabel(content, "ëª©í‘œëª…:");
      if (byGoalLabel) return byGoalLabel;
      return title || content.replace(/\n/g, " ").trim();
    }
  function escapeHtml(s){
	  return (s ?? "").toString()
	    .replace(/&/g,"&amp;")
	    .replace(/</g,"&lt;")
	    .replace(/>/g,"&gt;")
	    .replace(/"/g,"&quot;")
	    .replace(/'/g,"&#39;");
	}
	function toHtmlWithNewlines(text){
	  return escapeHtml(text).replace(/\r?\n/g, "<br/>");
	}

    targetLogs.forEach(log => {
      const tag = getTag(log);
      const title = getTitle(log);
      const content = getContent(log);
      const relId = getRelatedId(log);
    
      const isIdeaCreate = tag === 'ì•„ì´ë””ì–´' || tag === 'Idea' || title.includes('ğŸ’¡') || content.includes('ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      const isBugCreate = tag === 'ë²„ê·¸' || tag === 'BugReport' || title.includes('ğŸ') || title.includes('ë²„ê·¸') || content.includes('ğŸ ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±ë¨:');
      const isPublishBase = (tag === 'Publish');
      const isReportTag = /(^|[,\s])report($|[,\s])/i.test(tag);
	  const isProjectTag = /(^|[,\s])project($|[,\s])/i.test(tag); // âœ… ì¶”ê°€
      const isIdeaRealize = tag === 'Realization' || title.includes('ì•„ì´ë””ì–´ ì‹¤í˜„') || title.includes('ğŸš€') || content.includes('ì•„ì´ë””ì–´ê°€ êµ¬ì²´ì ì¸ ì‘ì—…ìœ¼ë¡œ ë³€í™˜');
      const publishText = (title + "\n" + content);
      const isRealPublish = isPublishBase && /ë°œí–‰/.test(publishText) && !/ì´ˆì•ˆ|ìˆ˜ì •|ì—…ë°ì´íŠ¸/.test(publishText);
      const isPublish = isRealPublish;
    
      if (isIdeaCreate) { ideaCreateLogs.push(log); return; }
      if (isIdeaRealize){ ideaRealizeLogs.push(log); return; }
      if (isBugCreate)  { bugCreateLogs.push(log);  return; }
      if (isPublish) { postCount++; publishLogs.push(log); return; }
	  if (isProjectTag) { projectTagLogs.push(log); return; }  // âœ… reportë³´ë‹¤ ìœ„ì— ë‘ëŠ” ê±¸ ì¶”ì²œ
      if (isReportTag) { reportTagLogs.push(log); return; }

      const isBugFix = BUG_IDS.has(relId) && (tag === 'Done' || tag === 'ì™„ë£Œ' || title.includes('ì™„ë£Œ') || title.includes('í•´ê²°') || title.includes('Fix') || content.includes('ì™„ë£Œ') || content.includes('í•´ê²°'));
      if (isBugFix) { bugFixLogs.push(log); return; }
      doneLogs.push(log);
    });

    let signalHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
    if (activeBigGoals.length > 0) {
        activeBigGoals.forEach(bg => {
            const percent = getReportGoalProgress(bg.ID, true, targetEndDate);
            const ddayBadge = getReportDday(bg['ë§ˆê°ì¼'], targetEndDate);
            let statusColor = percent === 100 ? "#10b981" : (percent > 0 ? "#3b82f6" : "#64748b");
            
            signalHtml += `<li style="margin-bottom: 12px; list-style: none;">
                <div style="font-weight:700; color:#1e293b; margin-bottom:4px;">ğŸ¯ ${bg['ì œëª©']} ${ddayBadge}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="flex:1; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                        <div style="width:${percent}%; background:${statusColor}; height:100%;"></div>
                    </div>
                    <span style="font-size:0.85em; font-weight:800; color:${statusColor}">${percent}%</span>
                </div>
            </li>`;
        });
    } else {
        signalHtml += `<li>ğŸš€ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í•µì‹¬ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
    }
    signalHtml += `</ul>`;

    let bottleneckHtml = `<ul style="padding-left: 20px; margin: 0; color: #b91c1c; line-height: 1.6;">`;
    let riskCount = 0;
    const autoRisks = analyzeProjectRisks(activeBigGoals, targetEndDate);
    if (autoRisks.length > 0) {
        autoRisks.forEach(risk => { bottleneckHtml += `<li style="margin-bottom:6px;">${risk}</li>`; riskCount++; });
    }
    if (bugCreateLogs.length > 0) {
      bottleneckHtml += `
        <li style="margin-bottom:6px; color:#ef4444;">
          <b>ğŸ í’ˆì§ˆ ì´ìŠˆ ë°œê²¬:</b> ${bugCreateLogs.length}ê±´ (ê¸°ì¤€ì¼ ìƒì„±)
          <div style="margin-top:6px; padding-left:14px; color:#b91c1c; font-weight:600;">
            ${bugCreateLogs.slice(0,5).map(b => `- ${pickMeaningTitle(b)}`).join('<br/>')}
            ${bugCreateLogs.length > 5 ? `<br/>...ì™¸ ${bugCreateLogs.length-5}ê±´` : ``}
          </div>
        </li>`;
      riskCount++;
    }
    if (bugFixLogs.length > 0) {
      bottleneckHtml += `
        <li style="margin-bottom:6px; color:#16a34a; list-style:none;">
          âœ… <b>ìˆ˜ì • ì™„ë£Œ:</b> ${bugFixLogs.length}ê±´
          <div style="margin-top:6px; padding-left:14px; color:#14532d; font-weight:600;">
            ${bugFixLogs.slice(0,5).map(b => `- ${pickMeaningTitle(b)}`).join('<br/>')}
            ${bugFixLogs.length > 5 ? `<br/>...ì™¸ ${bugFixLogs.length-5}ê±´` : ``}
          </div>
        </li>`;
      riskCount++;
    }
    if (riskCount === 0) bottleneckHtml = `<div style="text-align:center; color:#10b981; padding:20px;">âœ¨ <b>No Bottlenecks</b><br>í˜„ì¬ ì‹ë³„ëœ ì§€ì—° ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    else bottleneckHtml += `</ul>`;

    let velocityHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
	if (projectTagLogs.length > 0) {
	  velocityHtml += `
		<li style="margin-bottom:10px; list-style:none;">
		  <div style="
			border:2px solid #f59e0b;
			background:#fffbeb;
			border-radius:12px;
			padding:12px 14px;
			font-weight:900;
			color:#92400e;
		  ">
			ğŸ <b>[Project Closed]</b> í”„ë¡œì íŠ¸ ë§ˆê° ${projectTagLogs.length}ê±´
			<div style="margin-top:8px; padding-left:10px; color:#1e293b; font-weight:700;">
			  ${projectTagLogs.slice(0,5).map(p => `- ${pickMeaningTitle(p)}`).join('<br/>')}
			  ${projectTagLogs.length > 5 ? `<br/>...ì™¸ ${projectTagLogs.length-5}ê±´` : ``}
			</div>
		  </div>
		</li>
	  `;
	}
    if (publishLogs.length > 0) {
      velocityHtml += `
        <li style="margin-bottom:6px; color:#2563eb; font-weight:800; list-style:none;">
          ğŸ“ <b>[Shipped]</b> ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ${publishLogs.length}ê±´ ë°œí–‰
          <div style="margin-top:6px; padding-left:14px; color:#1e293b; font-weight:600;">
            ${publishLogs.slice(0,5).map(p => `- ${pickMeaningTitle(p)}`).join('<br/>')}
            ${publishLogs.length > 5 ? `<br/>...ì™¸ ${publishLogs.length-5}ê±´` : ``}
          </div>
        </li>
      `;
    }
    if (ideaCreateLogs.length > 0) {
      velocityHtml += `
        <li style="margin-bottom:6px; color:#ea580c; font-weight:800; list-style:none;">
          ğŸ’¡ <b>Innovation</b> ì•„ì´ë””ì–´ ${ideaCreateLogs.length}ê±´ ìƒì„±
          <div style="margin-top:6px; padding-left:14px; color:#1e293b; font-weight:600;">
            ${ideaCreateLogs.slice(0,5).map(i => `- ${pickMeaningTitle(i)}`).join('<br/>')}
            ${ideaCreateLogs.length > 5 ? `<br/>...ì™¸ ${ideaCreateLogs.length-5}ê±´` : ``}
          </div>
        </li>
      `;
    }
    if (ideaRealizeLogs.length > 0) {
      velocityHtml += `
        <li style="margin-bottom:6px; color:#16a34a; font-weight:800; list-style:none;">
          ğŸš€ <b>Innovation</b> ì•„ì´ë””ì–´ ${ideaRealizeLogs.length}ê±´ ì‹¤í˜„
          <div style="margin-top:6px; padding-left:14px; color:#1e293b; font-weight:600;">
            ${ideaRealizeLogs.slice(0,5).map(i => `- ${pickMeaningTitle(i)}`).join('<br/>')}
            ${ideaRealizeLogs.length > 5 ? `<br/>...ì™¸ ${ideaRealizeLogs.length-5}ê±´` : ``}
          </div>
        </li>
      `;
    }
    if (reportTagLogs.length > 0) {
      velocityHtml += `
        <li style="margin-bottom:6px; color:#0f172a; font-weight:800; list-style:none;">
          ğŸ·ï¸ <b>Report</b> ê¼­ ê¸°ë¡í•  ì‚¬í•­ ${reportTagLogs.length}ê±´
          <div style="margin-top:6px; padding-left:14px; color:#1e293b; font-weight:600;">
            ${reportTagLogs.slice(0,5).map(r => {
			  const t = getTitle(r).trim();
			  const c = getContent(r).trim();
			  const header = t ? escapeHtml(t) : "ğŸ“ (ì œëª© ì—†ìŒ)";
			  const body = c ? toHtmlWithNewlines(c) : "(ë‚´ìš© ì—†ìŒ)";
			  return `- <b>${header}</b><div style="margin:4px 0 10px 0; padding-left:12px; color:#475569; font-weight:600;">${body}</div>`;
			}).join('')}
            ${reportTagLogs.length > 5 ? `<br/>...ì™¸ ${reportTagLogs.length-5}ê±´` : ``}
          </div>
        </li>
      `;
    }
    if (publishLogs.length === 0 && ideaCreateLogs.length === 0 && ideaRealizeLogs.length === 0) {
      velocityHtml += `<li style="color:#94a3b8;">ê¸ˆì¼ ê¸°ë¡ëœ ì„±ê³¼(í¬ìŠ¤íŒ…/ì•„ì´ë””ì–´)ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
    }
    velocityHtml += `</ul>`;

    let algoHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
    algoHtml += `<li style="margin-bottom:6px;"><b>âš¡ Optimization (íš¨ìœ¨í™”):</b><br/>(ë°˜ë³µ ì‘ì—… ì œê±° ë˜ëŠ” ìë™í™” í•  ë¶€ë¶„ ì‘ì„±)</li>
    <li><b>â© Next Critical Path (ë‚´ì¼ í•  ì¼):</b><br/>(ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ë°˜ë“œì‹œ ì²˜ë¦¬í•´ì•¼ í•  1ìˆœìœ„ ì‘ì—…)</li></ul>`;

    const htmlTemplate = `
      <div style="font-family:'Pretendard','Malgun Gothic',sans-serif; max-width:900px; margin:0 auto; color:#1e293b;">
        <h2 style="text-align:center; color:#0f172a; margin-bottom:24px; font-size:1.6rem; letter-spacing:-0.5px;">${titlePrefix}</h2>
        <table style="width:100%; border-collapse:collapse; table-layout:fixed; border:2px solid #cbd5e1;">
          <tr>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1rem; border-bottom:2px solid #cbd5e1; padding-bottom:8px;">1. ğŸ¯ The Signal (í•µì‹¬ ëª©í‘œ í˜„í™©)</h3>${signalHtml}</td>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fef2f2;"><h3 style="margin:0 0 12px 0; color:#b91c1c; font-size:1.1rem; border-bottom:2px solid #fca5a5; padding-bottom:8px;">2. ğŸ›‘ The Bottlenecks (ë¦¬ìŠ¤í¬ & ë°©í•´ìš”ì†Œ)</h3>${bottleneckHtml}</td>
          </tr>
          <tr>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f0f9ff;"><h3 style="margin:0 0 12px 0; color:#0369a1; font-size:1.1rem; border-bottom:2px solid #bae6fd; padding-bottom:8px;">3. âš¡ Velocity (ì‹¤í–‰ ì†ë„ & ì„±ê³¼)</h3>${velocityHtml}</td>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1rem; border-bottom:2px solid #cbd5e1; padding-bottom:8px;">4. âš™ï¸ The Algorithm (ìµœì í™” & Next Step)</h3>${algoHtml}</td>
          </tr>
        </table>
        <p style="text-align:right; color:#94a3b8; font-size:0.8rem; margin-top:12px;">â€» Generated by Cheese Lab (ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„± ë¨)</p>
      </div>`;

    openDocModal(null, titlePrefix, htmlTemplate, 'ë³´ê³ ì„œ');
  }

  async function openDocModal(docId = null, defaultTitle = "", defaultHtml = "", defaultType = "ë³´ê³ ì„œ") {
    const modal = document.getElementById('doc-modal');
    modal.classList.add('open');
    document.getElementById('doc-form').reset();
    document.getElementById('doc-drive-id').value = ""; 
    
    // âœ… TinyMCE ë‚´ìš© ë¹„ìš°ê¸° (ì—ë””í„°ê°€ ë¡œë“œëœ ìƒíƒœì¸ì§€ í™•ì¸)
    if(tinymce.get('doc-content')) {
        tinymce.get('doc-content').setContent('');
    }

    const header = modal.querySelector('.modal-header-custom');
    const titleEl = document.getElementById('doc-modal-title');
    const toolsLeft = document.getElementById('modal-tools-left');
    const saveBtn = document.getElementById('btn-save-doc');

    const setModalTheme = (type) => {
        if (type === 'ê¸°íšì„œ') {
            header.style.background = '#fff7ed';
            header.style.borderBottom = '1px solid #fed7aa';
            titleEl.style.color = '#c2410c';
            titleEl.innerHTML = 'ğŸ“™ ê¸°íšì„œ ì‘ì„± (Planning)';
            toolsLeft.style.display = 'flex';
            saveBtn.style.background = '#ea580c';
        } else {
            header.style.background = '#eff6ff';
            header.style.borderBottom = '1px solid #bfdbfe';
            titleEl.style.color = '#1e40af';
            titleEl.innerHTML = 'ğŸ“˜ ë³´ê³ ì„œ ì‘ì„± (Report)';
            toolsLeft.style.display = 'none';
            saveBtn.style.background = '#3b82f6';
        }
    };

    if (docId) {
        const doc = g_docs.find(d => d.ID === docId);
        if (doc) {
            setModalTheme(doc['ìœ í˜•']);
            document.getElementById('doc-id').value = doc.ID;
            document.getElementById('doc-title').value = doc['ì œëª©'];
            document.getElementById('doc-type').value = doc['ìœ í˜•'];
            
            if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
                const fileId = doc['ìƒì„¸ë‚´ìš©'].split("DRIVE:")[1];
                document.getElementById('doc-drive-id').value = fileId;
                if(typeof showAdminLoading==='function') showAdminLoading("ë¬¸ì„œ ë¡œë”© ì¤‘...");
                try {
                    const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "getReportContent", fileId: fileId }) });
                    const json = await res.json();
                    if(json.result === "success" && tinymce.get('doc-content')) {
                        tinymce.get('doc-content').setContent(json.content);
                    }
                } catch(e) { alert("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨"); } 
                finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
            } else {
                if(tinymce.get('doc-content')) tinymce.get('doc-content').setContent(doc['ìƒì„¸ë‚´ìš©'] || "");
            }
        }
    } else {
        setModalTheme(defaultType);
        document.getElementById('doc-id').value = "";
        document.getElementById('doc-title').value = defaultTitle;
        document.getElementById('doc-type').value = defaultType;
        if(defaultHtml && tinymce.get('doc-content')) tinymce.get('doc-content').setContent(defaultHtml);
    }
  }

  document.getElementById('doc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save-doc');
    const originalText = btn.textContent;
    btn.textContent = "ì €ì¥ ì¤‘..."; btn.disabled = true;

    try {
        const docId = document.getElementById('doc-id').value;
        const title = document.getElementById('doc-title').value;
        const type = document.getElementById('doc-type').value;
        // âœ… TinyMCE ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const contentHtml = tinymce.get('doc-content') ? tinymce.get('doc-content').getContent() : "";
        const driveId = document.getElementById('doc-drive-id').value;
        const now = new Date().toISOString().split('T')[0];

        if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
        
        const drivePayload = {
            mode: "uploadReportContent",
            folderId: ARCHIVE_FOLDER_ID,
            fileId: driveId,
            title: title,
            content: contentHtml
        };
        const driveRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(drivePayload) });
        const driveJson = await driveRes.json();
        let savedFileId = driveId;
        if (driveJson.result === "success") savedFileId = driveJson.fileId;
        else throw new Error("ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì‹¤íŒ¨");

        const dbPayload = {
            mode: docId ? "editItem" : "addItem",
            id: docId, type: type, title: title,
            detail: "DRIVE:" + savedFileId,
            priority: "ë³´í†µ", dueDate: now, connectedId: "", color: ""
        };
        const dbRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(dbPayload) });
        const dbJson = await dbRes.json();
        
        if(dbJson.result === "success") {
            closeModal('doc-modal');
            await loadAllData(); 
        } else alert("DB ì €ì¥ ì‹¤íŒ¨");
    } catch(err) { console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message); } 
    finally {
        btn.textContent = originalText; btn.disabled = false;
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

  function deleteDoc(id) {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) })
    .then(()=>loadAllData()).finally(()=>{ if(typeof hideAdminLoading==='function') hideAdminLoading(); });
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function printReport() {
    const content = tinymce.get('doc-content') ? tinymce.get('doc-content').getContent() : "";
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>${document.getElementById('doc-title').value}</title><style>body{font-family:'Pretendard',sans-serif;padding:40px;}table{width:100%;border-collapse:collapse;border:2px solid #cbd5e1}td{border:1px solid #cbd5e1;padding:20px;}</style></head><body>${content}<script>window.onload=function(){window.print();setTimeout(function(){window.close();},100);}<\/script></body></html>`);
    printWindow.document.close();
  }

  async function saveAsImage() {
    const title = document.getElementById('doc-title').value || "report";
    const contentHtml = tinymce.get('doc-content') ? tinymce.get('doc-content').getContent() : "";
    
    if (!contentHtml || contentHtml === "<p><br></p>" || contentHtml === "") { 
        alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); 
        return; 
    }

    const printContainer = document.createElement('div');
    printContainer.style.position = 'fixed'; 
    printContainer.style.top = '0';
    printContainer.style.left = '0';
    printContainer.style.zIndex = '99999'; 
    printContainer.style.width = '1200px'; 
    printContainer.style.height = 'auto';
    printContainer.style.minHeight = '100vh';
    printContainer.style.padding = '60px'; 
    printContainer.style.background = '#ffffff';
    printContainer.style.boxSizing = 'border-box';
    
    printContainer.innerHTML = `
		<style>
		  .temp-wrap { 
		    font-family: 'Arial', 'Malgun Gothic', sans-serif !important; 
		    color: #1e293b !important; 
		    line-height: 1.6 !important; 
		    width: 100% !important;
		  }
		
		  /* âœ… ê¸°ë³¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì¼ë°˜ í‘œìš©) */
		  .temp-wrap table { 
		    width: 100% !important; 
		    border-collapse: collapse !important; 
		    border: 2px solid #cbd5e1 !important; 
		    table-layout: fixed !important; 
		  }
		  .temp-wrap td, .temp-wrap th { 
		    border: 1px solid #cbd5e1 !important; 
		    padding: 10px !important; 
		    vertical-align: top !important;
		    overflow: visible !important; 
		    position: relative !important;
		  }
		
		  /* âœ… (ì¤‘ìš”) ìŠ¤ì¼€ì¤„ í‘œëŠ” ë ˆì´ì•„ì›ƒì´ ë¯¼ê°í•˜ë‹ˆ ì €ì¥ ì‹œ ì›ë˜ ì˜ë„ëŒ€ë¡œ ë³µêµ¬ */
		  .temp-wrap .schedule-section table{
		    border-collapse: collapse !important;
		    table-layout: fixed !important;
		  }
		
		  /* ìŠ¤ì¼€ì¤„: í—¤ë”/ì¢Œì¸¡ 3ì¹¸(êµ¬ë¶„/Task/ê²°ê³¼ë¬¼)ì€ íŒ¨ë”© ìœ ì§€ */
		  .temp-wrap .schedule-section thead th{
		    padding: 8px !important;
		  }
		  .temp-wrap .schedule-section tbody td:nth-child(-n+3){
		    padding: 6px 10px !important;
		  }
		
		  /* ìŠ¤ì¼€ì¤„: ê¸°ê°„ ë§‰ëŒ€ê°€ ë“¤ì–´ê°€ëŠ” ê·¸ë¦¬ë“œ ì…€(4ë²ˆì§¸ ì´í›„)ì€ padding 0ìœ¼ë¡œ ë³µêµ¬ */
		  .temp-wrap .schedule-section tbody td:nth-child(n+4){
		    padding: 0 !important;
		  }
		  
		 .temp-wrap .schedule-section{
		   padding-right: 90px !important;
		   overflow: visible !important;
	     }
		 
		  .temp-wrap * { box-sizing: border-box !important; }
		  .temp-wrap h1, .temp-wrap h2, .temp-wrap h3, .temp-wrap h4 { margin-top: 0 !important; }
		</style>

        <div class="temp-wrap">${contentHtml}</div>
    `;
    
    document.body.appendChild(printContainer);

    if(typeof showAdminLoading === 'function') showAdminLoading("ê³ í™”ì§ˆ ì´ë¯¸ì§€ ìƒì„± ì¤‘...");

    try {
        const canvas = await html2canvas(printContainer, {
            scale: 2, 
            useCORS: true, 
            backgroundColor: '#ffffff',
            width: printContainer.offsetWidth,
            height: printContainer.offsetHeight,
            x: 0, y: 0, scrollX: 0, scrollY: 0,
            windowWidth: document.documentElement.offsetWidth,
            windowHeight: document.documentElement.offsetHeight,
            onclone: (clonedDoc) => {
                const spans = clonedDoc.querySelectorAll('span');
                spans.forEach(s => s.style.fontVariantNumeric = 'tabular-nums'); 
            }
        });

        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `${title}.png`;
        link.click();
        
    } catch (err) { 
        console.error("Image Save Error:", err); 
        alert("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: " + err.message); 
    } finally { 
        document.body.removeChild(printContainer); 
        if(typeof hideAdminLoading === 'function') hideAdminLoading(); 
    }
  }

  function openIdeaSelector(mode = 'new') {
      CURRENT_IDEA_MODE = mode;
      const container = document.getElementById('idea-list-container');
      container.innerHTML = "";
      const ideas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' || (t['ì œëª©'] && t['ì œëª©'].includes('ğŸ’¡')));
      if (ideas.length === 0) { alert("ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      ideas.sort((a, b) => b.ID.localeCompare(a.ID));
      
      ideas.forEach(idea => {
          const div = document.createElement('div');
          div.className = 'idea-select-item';
          div.onclick = (e) => { if(e.target.type !== 'checkbox') div.querySelector('input').click(); };
          const desc = idea['ìƒì„¸ë‚´ìš©'] ? idea['ìƒì„¸ë‚´ìš©'].replace(/<[^>]*>?/gm, '').substring(0, 60) : '(ë‚´ìš© ì—†ìŒ)';
          div.innerHTML = `<input type="checkbox" class="idea-chk" value="${idea.ID}"><div class="idea-select-content"><div class="idea-select-title">${idea['ì œëª©']}</div><div class="idea-select-desc">${desc}</div></div>`;
          container.appendChild(div);
      });
      document.getElementById('idea-select-modal').classList.add('open');
  }

  function confirmIdeaSelection() {
      const checkboxes = document.querySelectorAll('.idea-chk:checked');
      if (checkboxes.length === 0) { alert("ì„ íƒëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      let selectedIdeas = [];
      checkboxes.forEach(chk => {
          const idea = g_tasks.find(t => t.ID === chk.value);
          if (idea) selectedIdeas.push(idea);
      });
      document.getElementById('idea-select-modal').classList.remove('open');

      if (CURRENT_IDEA_MODE === 'insert') {
          let insertHtml = "";
          selectedIdeas.forEach(idea => {
              const desc = idea['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ";
              insertHtml += `<div style="margin-bottom:16px; padding:16px; background:#fff7ed; border-left:4px solid #ea580c; border-radius:4px;"><h4 style="margin:0 0 8px 0; color:#c2410c;">ğŸ’¡ ${idea['ì œëª©']}</h4><div style="font-size:0.95rem; color:#431407; line-height:1.6;">${desc}</div></div><br/>`;
          });
          // âœ… TinyMCE ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
          if(tinymce.get('doc-content')) tinymce.get('doc-content').insertContent(insertHtml);
      } else {
          generateProposalFromIdeas(selectedIdeas);
      }
  }

  function openScheduleMaker() {
    CURRENT_EDITING_SCHEDULE_EL = null; 
    document.getElementById('schedule-maker-modal').classList.add('open');
    const today = new Date();
    document.getElementById('sch-start-month').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('sch-input-list').innerHTML = ""; 
    addScheduleRow(); 
  }
  
  function closeScheduleMaker() { 
      document.getElementById('schedule-maker-modal').classList.remove('open'); 
      CURRENT_EDITING_SCHEDULE_EL = null; 
  }

// âœ¨ ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ë¡œ targetTr(ì–´ëŠ ì¤„ ì•„ë˜ì— ì¶”ê°€í• ì§€)ì„ ë°›ë„ë¡ ìˆ˜ì •
function addScheduleRow(cat="", task="", sDate="", eDate="", output="", targetTr=null) {
    const tbody = document.getElementById('sch-input-list');
    const tr = document.createElement('tr');
    tr.style.borderBottom = "1px solid #f1f5f9";
    
    tr.innerHTML = `
        <td style="padding:8px 10px;"><input type="text" class="styled-input sch-cat" value="${cat}" placeholder="ë‹¨ê³„" style="width:100%;"></td>
        <td style="padding:8px 10px;"><input type="text" class="styled-input sch-task" value="${task}" placeholder="í•  ì¼" style="width:100%;"></td>
        <td style="padding:8px 10px;"><input type="date" class="styled-input sch-sdate" value="${sDate}" style="width:100%;"></td>
        <td style="text-align:center;">âœ</td>
        <td style="padding:8px 10px;"><input type="date" class="styled-input sch-edate" value="${eDate}" style="width:100%;"></td>
        
        <td style="padding:8px 10px;"><input type="text" class="styled-input sch-output" value="${output}" placeholder="ì‚°ì¶œë¬¼" style="width:100%;"></td>
        
        <td style="padding:8px 10px;">
            <div style="display:flex; justify-content:center; gap:6px;">
                <button type="button" onclick="addScheduleRow('', '', '', '', '', this.closest('tr'))" style="border:none; background:#eff6ff; color:#3b82f6; width:28px; height:28px; border-radius:6px; cursor:pointer; font-weight:bold; flex-shrink:0; display:flex; align-items:center; justify-content:center;" title="ì´ ì¤„ ì•„ë˜ì— ìƒˆ ì‘ì—… ì¶”ê°€">+</button>
                <button type="button" onclick="this.closest('tr').remove()" style="border:none; background:#fff1f2; color:#ef4444; width:28px; height:28px; border-radius:6px; cursor:pointer; font-weight:bold; flex-shrink:0; display:flex; align-items:center; justify-content:center;" title="ì´ ì‘ì—… ì‚­ì œ">Ã—</button>
            </div>
        </td>
    `;
    
    // íŠ¹ì • ì¤„ ì•„ë˜(+)ë¥¼ ëˆŒë €ë‹¤ë©´ ê·¸ ë‹¤ìŒ ì¤„ì— ì‚½ì…, ì•„ë‹ˆë©´ ë§¨ ë°‘ì— ì¶”ê°€
    if (targetTr) {
        targetTr.parentNode.insertBefore(tr, targetTr.nextSibling);
    } else {
        tbody.appendChild(tr);
    }
}

// âœ¨ íŒŒë¼ë¯¸í„°ë¥¼ btnì´ ì•„ë‹ˆë¼ wrapperë¡œ ì§ì ‘ ë°›ë„ë¡ ë³€ê²½
  window.editEmbeddedSchedule = function(wrapper) {
      if (!wrapper) return;
      const configRaw = wrapper.getAttribute('data-config');
      if (!configRaw) { alert("ë°ì´í„° ì†ìƒ"); return; }
      try {
          const config = JSON.parse(decodeURIComponent(configRaw));
          CURRENT_EDITING_SCHEDULE_EL = wrapper; 
          document.getElementById('schedule-maker-modal').classList.add('open');
          document.getElementById('sch-start-month').value = config.startMonth;
          document.getElementById('sch-project-name').value = config.projectName || "í”„ë¡œì íŠ¸";
          document.getElementById('sch-input-list').innerHTML = ""; 
          
          config.rows.forEach(r => {
              const sDate = r.s ? r.s.split('T')[0] : "";
              const eDate = r.e ? r.e.split('T')[0] : "";
              // ğŸš¨ ê²°ê³¼ë¬¼(output) íŒŒë¼ë¯¸í„°ë¥¼ r.outputìœ¼ë¡œ ì˜ ë¶ˆëŸ¬ì˜¤ë„ë¡ 5ë²ˆì§¸ ì¸ì ì¶”ê°€!
              addScheduleRow(r.cat, r.task, sDate, eDate, r.output || '');
          });
      } catch(e) { console.error(e); }
  };

  function loadSchedulePreset() {
      if(document.getElementById('sch-input-list').children.length > 0 && !confirm("ì´ˆê¸°í™” í›„ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")) return;
      document.getElementById('sch-input-list').innerHTML = "";
      document.getElementById('sch-start-month').value = "2026-01";
      addScheduleRow("1ë‹¨ê³„", "íˆ´ ë³´ì™„", "2026-01-28", "2026-02-02");
      addScheduleRow("", "í…ŒìŠ¤íŠ¸ ì´ê´€", "2026-01-28", "2026-02-02");
      addScheduleRow("2ë‹¨ê³„", "ê°€ê³„ë„ ì´ê´€", "2026-02-03", "2026-02-09");
      addScheduleRow("3ë‹¨ê³„", "ìµœì¢… ë§ˆê°", "2026-02-10", "2026-02-14");
  }

  function insertSmartSchedule() {
    const startMonthVal = document.getElementById('sch-start-month').value;
    const projectName = document.getElementById('sch-project-name').value;
    if(!startMonthVal) { alert("ì‹œì‘ ì›” ì„ íƒ í•„ìš”"); return; }

    let maxDate = new Date(startMonthVal + "-01"); maxDate.setMonth(maxDate.getMonth() + 1); 
    const rows = [];
    const saveRows = []; 

    document.querySelectorAll('#sch-input-list tr').forEach(tr => {
        const sVal = tr.querySelector('.sch-sdate').value;
        const eVal = tr.querySelector('.sch-edate').value;
        if(eVal) { const e = new Date(eVal); if(e > maxDate) maxDate = e; }
		const rowData = { 
		  cat: tr.querySelector('.sch-cat').value, 
		  task: tr.querySelector('.sch-task').value, 
		  // âœ¨ output ì¶”ê°€
		  output: tr.querySelector('.sch-output').value, 
		  s: sVal?new Date(sVal):null, 
		  e: eVal?new Date(eVal):null 
		};
		rows.push(rowData);
        saveRows.push({ ...rowData, s: sVal, e: eVal });
    });

    const configData = encodeURIComponent(JSON.stringify({ startMonth: startMonthVal, projectName: projectName, rows: saveRows }));

    let gridHtml = "", subHeaderHtml = "";
    let currentIterDate = new Date(startMonthVal + "-01");
    const gridMap = [];
    while (currentIterDate <= maxDate) {
        const y = currentIterDate.getFullYear(), m = currentIterDate.getMonth(), lastDay = new Date(y, m+1, 0).getDate();
        const weeks = Math.ceil(lastDay / 7); 
        gridHtml += `<th colspan="${weeks}" style="border:1px solid #cbd5e1; background:#f0f9ff; padding:8px; font-size:0.9rem; color:#0369a1;">${m+1}ì›”</th>`;
        for(let w=1; w<=weeks; w++) {
            subHeaderHtml += `<th style="border:1px solid #e2e8f0; background:#f8fafc; padding:4px; font-size:0.75rem; color:#64748b; width:30px; text-align:center;">${w}</th>`;
            gridMap.push({ y: y, m: m, w: w });
        }
        currentIterDate.setMonth(currentIterDate.getMonth() + 1);
    }

let tbodyHtml = "";
    rows.forEach(item => {
        let cols = "";
        let startIdx = -1, endIdx = -1;
        if (item.s && item.e) {
            const sY=item.s.getFullYear(), sM=item.s.getMonth(), sW=Math.ceil(item.s.getDate()/7);
            startIdx = gridMap.findIndex(g=>g.y===sY && g.m===sM && g.w===sW);
            const eY=item.e.getFullYear(), eM=item.e.getMonth(), eW=Math.ceil(item.e.getDate()/7);
            for(let i=gridMap.length-1; i>=0; i--) if(gridMap[i].y===eY && gridMap[i].m===eM && gridMap[i].w===eW) { endIdx=i; break; }
        }

        // âœ¨ 1. ìƒìœ„/í•˜ìœ„ ì—…ë¬´ íŒë³„ (êµ¬ë¶„(cat)ì´ ë¹„ì–´ìˆìœ¼ë©´ í•˜ìœ„ ì—…ë¬´ë¡œ ê°„ì£¼)
        const isSubTask = !item.cat; 
        
        // âœ¨ 2. ë§‰ëŒ€ë°” ë””ìì¸ ë¶„ê¸° (í•˜ìœ„ ì—…ë¬´ëŠ” ì–‡ê³  ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒìœ¼ë¡œ)
        const barBgColor = isSubTask ? "#94a3b8" : "#3b82f6"; // í•˜ìœ„ëŠ” ìŠ¬ë ˆì´íŠ¸ íšŒìƒ‰, ìƒìœ„ëŠ” íŒŒë€ìƒ‰
        const barHeight = isSubTask ? "6px" : "10px"; // í•˜ìœ„ëŠ” ì–‡ê²Œ
        const barMargin = isSubTask ? "8px" : "6px"; // ì–‡ì•„ì§„ ë§Œí¼ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ ë³´ì •
        
        const startStr = item.s ? formatMMDD(item.s) : "";
        const endStr = item.e ? formatMMDD(item.e) : "";

        for(let i=0; i<gridMap.length; i++) {
            if (startIdx!==-1 && endIdx!==-1 && i>=startIdx && i<=endIdx) {
                // ë§‰ëŒ€ ìŠ¤íƒ€ì¼ ë³€ìˆ˜ ì ìš©
                let style = `background:${barBgColor}; height:${barHeight}; margin-top:${barMargin}; opacity:0.8;`;
                let content = "";
                
                // í°íŠ¸ ìƒ‰ìƒë„ ë§‰ëŒ€ ìƒ‰ìƒì— ë§ì¶¤
                const fontStyle = `position:absolute; top:-3px; font-size:10px; color:${barBgColor}; font-weight:800; white-space:nowrap;`;

                if(startIdx===endIdx) {
                    style+="border-radius:5px;"; 
                    content += `<span style="${fontStyle} right:100%; margin-right:5px;">${startStr}</span>`;
                    content += `<span style="${fontStyle} left:100%; margin-left:5px;">${endStr}</span>`;
                } else if(i===startIdx) {
                    style+="border-radius:5px 0 0 5px;"; 
                    content += `<span style="${fontStyle} right:100%; margin-right:5px;">${startStr}</span>`;
                } else if(i===endIdx) {
                    style+="border-radius:0 5px 5px 0;"; 
                    content += `<span style="${fontStyle} left:100%; margin-left:5px;">${endStr}</span>`;
                }
                
                cols += `<td style="border:1px solid #e2e8f0; padding:0; vertical-align:middle; text-align:left; line-height:1;"><div style="${style} position:relative;">${content}</div></td>`;
            } else cols += `<td style="border:1px solid #e2e8f0; background:#fff;"></td>`;
        }
        
        // âœ¨ 3. Task ì»¬ëŸ¼ ë Œë”ë§ ë¶„ê¸° (ë“¤ì—¬ì“°ê¸° ë° 'â””' ì•„ì´ì½˜ ì ìš©)
        let taskContent = isSubTask
            ? `<div style="padding-left: 15px; color: #475569; font-size: 0.85rem;"><span style="color:#cbd5e1; margin-right:4px;">â””</span> ${item.task}</div>`
            : `<div style="font-weight: 700; color: #1e293b; font-size: 0.9rem;"><span style="color:#94a3b8; margin-right:4px;">â—¼</span> ${item.task}</div>`;

		tbodyHtml += `<tr>
		  <td style="border:1px solid #cbd5e1; padding:8px; font-size:0.85rem; text-align:center; vertical-align:middle; ${item.cat?'font-weight:700; background:#e0f2fe; color:#0369a1;':'background:#fff;'}">${item.cat || ''}</td>
		  <td style="border:1px solid #cbd5e1; padding:6px 10px;">${taskContent}</td>
		  <td style="border:1px solid #cbd5e1; padding:6px 10px; font-size:0.85rem; color:#64748b;">${item.output || ''}</td>
		  ${cols}
		</tr>`;
    });

    const scheduleHtml = `
      <div class="schedule-section" data-config="${configData}" style="font-family:'Pretendard',sans-serif; margin-top:20px; page-break-inside:avoid; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #bbf7d0; padding-bottom:8px; margin-bottom:12px;">
            <h3 style="margin:0; color:#16a34a; font-size:1.15rem;">5. ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule) <span style="font-size:0.8em; color:#64748b; font-weight:normal;">- ${projectName}</span></h3>
            <button type="button" class="btn-edit-schedule" contenteditable="false" style="background:#f0fdf4; border:1px solid #bbf7d0; color:#16a34a; border-radius:4px; padding:2px 8px; font-size:0.8rem; cursor:pointer; font-weight:600;">âœï¸ ìˆ˜ì •</button>
        </div>
			<table style="width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid #cbd5e1;">
			  <thead>
			    <tr>
			      <th rowspan="2" style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; width:80px;">êµ¬ë¶„</th>
			      <th rowspan="2" style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; width:200px;">Task</th>
			      <th rowspan="2" style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; width:120px;">ê²°ê³¼ë¬¼</th>
			      ${gridHtml}
			    </tr>
			    <tr>${subHeaderHtml}</tr>
			  </thead>
			  <tbody>${tbodyHtml}</tbody>
			</table>
        <div style="margin-top:8px; font-size:0.8rem; color:#94a3b8; text-align:right;">* ê° ì¹¸ì€ í•´ë‹¹ ì›”ì˜ ì£¼ì°¨(Week)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</div>
      </div><br/>
    `;

    if (CURRENT_EDITING_SCHEDULE_EL) {
        if(tinymce.get('doc-content')) {
            const currentCode = tinymce.get('doc-content').getContent();
            const parser = new DOMParser(); const doc = parser.parseFromString(currentCode, 'text/html');
            const oldSection = Array.from(doc.querySelectorAll('.schedule-section')).find(el => el.getAttribute('data-config') === CURRENT_EDITING_SCHEDULE_EL.getAttribute('data-config'));
            if(oldSection) {
                const tempDiv = doc.createElement('div'); tempDiv.innerHTML = scheduleHtml; oldSection.replaceWith(tempDiv);
                tinymce.get('doc-content').setContent(doc.body.innerHTML);
            }
        }
        CURRENT_EDITING_SCHEDULE_EL = null;
    } 
    else {
        if(tinymce.get('doc-content')) {
            const currentCode = tinymce.get('doc-content').getContent();
            if (currentCode.includes('id="schedule-placeholder"')) {
                const parser = new DOMParser(); const doc = parser.parseFromString(currentCode, 'text/html');
                const placeholder = doc.getElementById('schedule-placeholder');
                if (placeholder) {
                    const tempDiv = doc.createElement('div'); tempDiv.innerHTML = scheduleHtml; placeholder.replaceWith(tempDiv);
                    tinymce.get('doc-content').setContent(doc.body.innerHTML);
                } else {
                    tinymce.get('doc-content').insertContent(scheduleHtml);
                }
            } else {
                tinymce.get('doc-content').insertContent(scheduleHtml);
            }
        }
    }
    
    closeScheduleMaker();
  }

// ğŸ“… ë‚ ì§œë¥¼ MM/DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function formatMMDD(dateObj) {
  if (!dateObj) return '';
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const day = String(dateObj.getDate()).padStart(2, '0');
  return `${m}/${day}`;
}
	
  function generateProposalTemplate() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
    const htmlTemplate = `<div style="font-family:'Pretendard','Malgun Gothic',sans-serif; max-width:900px; margin:0 auto; color:#1e293b;"><h2 style="text-align:center; color:#ea580c; margin-bottom:12px; font-size:1.8rem; letter-spacing:-0.5px;">[ê¸°íšì„œ] ${document.getElementById('sch-project-name').value || "ìƒˆë¡œìš´ í”„ë¡œì íŠ¸"}</h2><div style="text-align:right; margin-bottom:16px; font-size:0.9rem; color:#64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: OOO</div><table style="width:100%; border-collapse:collapse; table-layout:fixed; border:2px solid #cbd5e1;"><tr><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">1. ê¸°íš ë°°ê²½ ë° ëª©ì  (Why)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>ë°°ê²½:</b> ì™œ ì´ ê¸°íšì„ í•˜ê²Œ ë˜ì—ˆëŠ”ê°€?</li><li><b>ëª©ì :</b> ì´ ê¸°íšì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œëŠ”?</li></ul></td><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì  (What)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>í˜„ì¬ ìƒí™©:</b> í˜„ì¬ ì—…ë¬´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìƒíƒœëŠ” ì–´ë– í•œê°€?</li><li><b>ë¬¸ì œì :</b> í•´ê²°í•´ì•¼ í•  ê°€ì¥ í° ë³‘ëª©ì´ë‚˜ ì›ì¸ì€?</li></ul></td></tr><tr><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ (How)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.6;"><li><b>í•µì‹¬ ì†”ë£¨ì…˜:</b> ë¬¸ì œë¥¼ ì–´ë–»ê²Œ íƒ€ê°œí•  ê²ƒì¸ê°€?</li><li><b>ì‹¤í–‰ ì „ëµ:</b> íƒ€ ë¶€ì„œ í˜‘ì—…, ë¦¬ìŠ¤í¬ ëŒ€ë¹„ì±… ë“± ìƒì„¸ ì „ëµ</li></ul></td><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">4. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚° (ROI)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>ì •ëŸ‰ì  íš¨ê³¼:</b> ë§¤ì¶œ X% ì¦ëŒ€, ë¦¬ë“œíƒ€ì„ Yì‹œê°„ ë‹¨ì¶• ë“±</li><li><b>ì†Œìš” ì˜ˆì‚°:</b> íˆ¬ì…ë˜ì–´ì•¼ í•  ì¸ë ¥ ë° ì˜ˆì‚°</li></ul></td></tr></table><div id="schedule-placeholder" style="margin-top:30px; padding:40px; border:2px dashed #e2e8f0; border-radius:12px; text-align:center; color:#94a3b8; background:#f8fafc;"><p style="font-size:1.1rem; font-weight:bold; margin-bottom:8px;">ğŸ“… ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule)</p><p style="font-size:0.9rem;">ìƒë‹¨ì˜ [ğŸ“… ì¼ì •í‘œ ë„£ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ê³³ì— ë¡œë“œë§µì„ ì±„ì›Œì£¼ì„¸ìš”.</p></div></div>`;
    openDocModal(null, "[ê¸°íšì„œ] ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ê¸°íš", htmlTemplate, 'ê¸°íšì„œ');
  }

  function getReportGoalProgress(goalId, isBigGoal, refDateObj) {
      let tasks = [];
      if (isBigGoal) {
          const midGoalIds = g_goals.filter(m => m['ìƒìœ„ID'] === goalId).map(m => m.ID);
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
      } else {
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === goalId);
      }
      
      if (tasks.length === 0) return 0;

      const targetDate = refDateObj ? new Date(refDateObj) : new Date();
      targetDate.setHours(23, 59, 59, 999);

      const today = new Date(); today.setHours(0,0,0,0);

      const doneCount = tasks.filter(t => {
          if (t['ìƒíƒœ'] !== 'ì™„ë£Œ') return false;
          if (targetDate >= today) return true;
          if (t['ì™„ë£Œì¼']) { return new Date(t['ì™„ë£Œì¼']) <= targetDate; }
          const doneLog = g_logs.find(l => {
            const relId = l['ê´€ë ¨_ëª©í‘œID'] || l['relatedId'] || l['ê´€ë ¨ID'] || l['ê´€ë ¨_ì‘ì—…ID'] || "";
            if (relId !== t.ID) return false;
            const raw = l['ë‚ ì§œ'] || l['date'];
            if (!raw) return false;
            const lDate = new Date(raw);
            if (isNaN(lDate.getTime())) return false;
            if (lDate > targetDate) return false;
            const status = (l['ìƒíƒœ'] || "").toString();
            const tag = (l['íƒœê·¸'] || l['tags'] || "").toString();
            const title = (l['ì œëª©'] || l['title'] || "").toString();
            return (
              status === 'ì™„ë£Œ' || status === 'Done' ||
              tag === 'Done' || tag === 'Publish' || tag === 'ì™„ë£Œ' || tag === 'ë°°í¬' ||
              title.includes('ì™„ë£Œ') || title.includes('ë‹¬ì„±') || title.includes('ë°°í¬') ||
              title.includes('í•´ê²°') || title.includes('Finish') || title.includes('ì„±ê³µ') || title.includes('ì‘ì—… ë')
            );
          });
          return !!doneLog; 
      }).length;

      return Math.round((doneCount / tasks.length) * 100);
  }

  function getReportDday(dateStr, baseDateObj) {
      if (!dateStr) return `<span style="color:#94a3b8; font-size:0.85em; margin-left:6px; font-weight:normal;">(ë§ˆê° ë¯¸ì •)</span>`;
      
      const targetDate = new Date(dateStr); targetDate.setHours(0,0,0,0);
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date(); refDate.setHours(0,0,0,0);
      const diffDays = Math.ceil((targetDate - refDate) / (1000 * 60 * 60 * 24));
      
      const badgeStyle = "display:inline-flex; align-items:center; justify-content:center; width:fit-content; white-space:nowrap; word-break:keep-all; color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 8px; border-radius:4px;";
      
      if (diffDays > 0) return `<span style="${badgeStyle}">D-${diffDays}</span>`;
      if (diffDays === 0) return `<span style="${badgeStyle}">D-Day</span>`;
      return `<span style="${badgeStyle}">D+${Math.abs(diffDays)} ì§€ì—°</span>`;
  }

  function getSmartLogTitle(log) {
      let displayTitle = log['ì œëª©'];
      if (!displayTitle || displayTitle.trim() === "") {
          const content = log['ë‚´ìš©'] || "";
          displayTitle = content.replace(/\n/g, " ").trim().substring(0, 30);
          if (content.length > 30) displayTitle += "...";
      }
      if (!displayTitle || displayTitle.trim() === "") displayTitle = "(ë‚´ìš© ì—†ìŒ)";
      return displayTitle;
  }

  function analyzeProjectRisks(activeBigGoals, baseDateObj) {
      let issues = [];
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date(); refDate.setHours(0,0,0,0);
      activeBigGoals.forEach(bg => {
          const percent = getReportGoalProgress(bg.ID, true, refDate);
          let diffDays = 999;
          if (bg['ë§ˆê°ì¼']) {
             const target = new Date(bg['ë§ˆê°ì¼']); target.setHours(0,0,0,0);
             diffDays = Math.ceil((target - refDate) / (1000 * 60 * 60 * 24));
          }
          if (diffDays < 0 && percent < 100) issues.push(`ğŸš¨ <b>[ì§€ì—°]</b> '${bg['ì œëª©']}' í”„ë¡œì íŠ¸ì˜ ì¼ì •ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. (ì§„ì²™ë¥  ${percent}%)`);
          else if (diffDays >= 0 && diffDays <= 3 && percent < 50) issues.push(`âš ï¸ <b>[ë¦¬ìŠ¤í¬]</b> '${bg['ì œëª©']}' ëª©í‘œ ë‹¬ì„±ì´ ë¶ˆíˆ¬ëª…í•©ë‹ˆë‹¤. ì§‘ì¤‘ì ì¸ ë¦¬ì†ŒìŠ¤ íˆ¬ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
      });
      return issues;
  }

  // âœ¨ ì—‘ì…€/í‘œ ì—°ì† ë¶™ì—¬ë„£ê¸° ì²˜ë¦¬ í•¨ìˆ˜
function handleTablePaste(e) {
  // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ì°¨ë‹¨
  e.preventDefault(); 
  
  // í´ë¦½ë³´ë“œ ë°ì´í„° í…ìŠ¤íŠ¸ë¡œ ê°€ì ¸ì˜¤ê¸°
  let pasteData = (e.clipboardData || window.clipboardData).getData('text');
  if (!pasteData) return;

  // ì—‘ì…€ ë°ì´í„°ëŠ” íƒ­(\t)ìœ¼ë¡œ ì—´ì´, ì¤„ë°”ê¿ˆ(\n)ìœ¼ë¡œ í–‰ì´ êµ¬ë¶„ë¨
  const rows = pasteData.trim().split('\n');
  
  // ì²« í–‰ì´ í—¤ë”(ë‹¨ê³„, ì‘ì—… ë‚´ìš© ë“±)ë¼ë©´ ë¬´ì‹œí• ì§€ ë¬»ê¸° (ì„ íƒ ì‚¬í•­)
  let startIndex = 0;
  if (rows.length > 0 && rows[0].includes('ë‹¨ê³„') && rows[0].includes('ì‘ì—… ë‚´ìš©')) {
      startIndex = 1; 
  }

  // ê¸°ì¡´ ë¹ˆ í–‰ì´ í•˜ë‚˜ ìˆë‹¤ë©´ ì‚­ì œ (ê¹”ë”í•˜ê²Œ ë¶™ì—¬ë„£ê¸° ìœ„í•´)
  const tbody = document.getElementById('sch-input-list');
  const existingRows = tbody.querySelectorAll('tr');
  if (existingRows.length === 1 && !existingRows[0].querySelector('.sch-task').value) {
      existingRows[0].remove();
  }

  // í•œ ì¤„ì”© íŒŒì‹±í•´ì„œ í–‰ ì¶”ê°€
  for (let i = startIndex; i < rows.length; i++) {
      const cols = rows[i].split('\t').map(c => c.trim());
      
      // ì—‘ì…€ ì»¬ëŸ¼ ìˆœì„œ: 0:ë‹¨ê³„, 1:ì‘ì—…ë‚´ìš©, 2:ì‹œì‘ì¼, 3:ì¢…ë£Œì¼, 4:ê²°ê³¼ë¬¼
      const cat = cols[0] || "";
      const task = cols[1] || "";
      
      // ë‚ ì§œ í¬ë§· ë³€í™˜ (ex: "01/28" -> "2026-01-28")
      let sDate = cols[2] || "";
      let eDate = cols[3] || "";
      const year = document.getElementById('sch-start-month').value.split('-')[0] || new Date().getFullYear();
      
      if (sDate.includes('/')) {
          const parts = sDate.split('/');
          sDate = `${year}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
      }
      if (eDate.includes('/')) {
          const parts = eDate.split('/');
          eDate = `${year}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
      }

      const output = cols[4] || "";

      addScheduleRow(cat, task, sDate, eDate, output);
  }
}
  
  (function showVersion() {
    const el = document.getElementById("sysVersion");
    if (!el) return;
    const d = new Date(document.lastModified); 
    const pad = (n) => String(n).padStart(2, '0');
    const versionStr = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())} [Final-TinyMCE]`;
    
    el.textContent = `Ver: ${versionStr}`;
    el.style.color = "#3b82f6";
    el.style.fontWeight = "bold";
  })();
</script>
	
<script>
// ğŸš¨ AIê°€ ë§Œë“  ë°ì´í„°ë¥¼ ì„ì‹œ ë³´ê´€í•  ì „ì—­ ë³€ìˆ˜
window.tempAIProposalData = null;

function openAIPromptModal() {
    document.getElementById('ai-prompt-input').value = "";
    document.getElementById('ai-prompt-modal').classList.add('open');
}

async function requestAIProposal() {
    const promptText = document.getElementById('ai-prompt-input').value.trim();
    if(!promptText) { alert("ê¸°íš ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”!"); return; }

    closeModal('ai-prompt-modal');
    if(typeof showAdminLoading==='function') showAdminLoading("AIê°€ ê¸°íšì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤... ğŸ¤–âœ¨");

    try {
        const res = await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({ mode: "generateProposal", rawIdea: promptText })
        });
        const json = await res.json();
        
        if(json.result === "success") {
            // ì„±ê³µ ì‹œ ì„ì‹œ ë³€ìˆ˜ì— ì €ì¥í•˜ê³  'ë¯¸ë¦¬ë³´ê¸°' í™”ë©´ ë„ìš°ê¸°
            window.tempAIProposalData = json.data;
            renderAIToEditor(json.data);
        } else {
            alert("AI ìƒì„± ì‹¤íŒ¨: " + json.msg);
        }
    } catch(e) {
        console.error(e); alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
}

function renderAIToEditor(aiData) {
    const today = new Date();
    const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
    
	 // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] í…ìŠ¤íŠ¸ë¥¼ ê³ ì • ì„¤ëª…ë¬¸(Bold)ê³¼ í•˜ìœ„ ê¸€ë¨¸ë¦¬(Sub-bullet)ë¡œ ìª¼ê°œê³ , 'ì¤‘ë³µ ì œëª©'ì„ ë³‘í•©í•˜ëŠ” í•¨ìˆ˜
	const formatToSubBullets = (text) => {
	    if (!text) return "";
	    
	    const headers = {
	        "ë°°ê²½": "ë°°ê²½: ì™œ ì´ ê¸°íšì„ í•˜ê²Œ ë˜ì—ˆëŠ”ê°€?",
	        "ëª©ì ": "ëª©ì : ì´ ê¸°íšì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œëŠ”?",
	        "í˜„ìƒ": "í˜„ì¬ ìƒí™©: í˜„ì¬ ì—…ë¬´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìƒíƒœëŠ” ì–´ë– í•œê°€?",
	        "ë¬¸ì œì ": "ë¬¸ì œì : í•´ê²°í•´ì•¼ í•  ê°€ì¥ í° ë³‘ëª©ì´ë‚˜ ì›ì¸ì€?",
	        "í•´ê²°ë°©ì•ˆ": "í•µì‹¬ ì†”ë£¨ì…˜: ë¬¸ì œë¥¼ ì–´ë–»ê²Œ íƒ€ê°œí•  ê²ƒì¸ê°€?",
	        "ì‹¤í–‰ì „ëµ": "ì‹¤í–‰ ì „ëµ: íƒ€ ë¶€ì„œ í˜‘ì—…, ë¦¬ìŠ¤í¬ ëŒ€ë¹„ì±… ë“± ìƒì„¸ ì „ëµ",
	        "ê¸°ëŒ€íš¨ê³¼": "ì •ëŸ‰ì  íš¨ê³¼: ë§¤ì¶œ X% ì¦ëŒ€, ë¦¬ë“œíƒ€ì„ Yì‹œê°„ ë‹¨ì¶• ë“±",
	        "ì†Œìš”ì˜ˆì‚°": "ì†Œìš” ì˜ˆì‚°: íˆ¬ì…ë˜ì–´ì•¼ í•  ì¸ë ¥ ë° ì˜ˆì‚°"
	    };
	
	    let resultHtml = "";
	    let currentList = "";
	    let currentKey = ""; // ğŸ‘ˆ [ì¶”ê°€] ë°©ê¸ˆ ì¶œë ¥í•œ ì œëª©ì´ ë¬´ì—‡ì¸ì§€ ê¸°ì–µí•˜ëŠ” ë³€ìˆ˜
	
	    const lines = text.split('\n');
	    
	    lines.forEach(line => {
	        let cleanLine = line.trim();
	        if (!cleanLine) return;
	
	        const match = cleanLine.match(/^-\s*\[(.*?)\](.*)/);
	        
	        if (match) {
	            let key = match[1].replace(/\s/g, ''); // ê³µë°± ì œê±° (ì˜ˆ: "í•´ê²° ë°©ì•ˆ" -> "í•´ê²°ë°©ì•ˆ")
	            let content = match[2].trim();
	            
	            // ğŸš¨ ì´ì „ ì¤„ê³¼ 'ë‹¤ë¥¸ ì œëª©'ì¼ ë•Œë§Œ ìƒˆ ì œëª©(Bold)ì„ ì¶œë ¥í•©ë‹ˆë‹¤!
	            if (key !== currentKey) {
	                // ì´ì „ í•­ëª©ì˜ ê¸€ë¨¸ë¦¬ê¸°í˜¸ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
	                if (currentList !== "") {
	                    resultHtml += `<ul style="padding-left:20px; margin:4px 0 16px 0; line-height:1.6; color:#333;">${currentList}</ul>`;
	                    currentList = "";
	                }
	                
	                let headerText = headers[key] || `${key}:`; 
	                resultHtml += `<div style="margin-top:8px;"><b>${headerText}</b></div>`; // ì œëª© ì¶œë ¥
	                currentKey = key; // ë°©ê¸ˆ ì¶œë ¥í•œ ì œëª© ê¸°ì–µí•˜ê¸°
	            }
	            
	            // ë‚´ìš©ì€ ì œëª© ì¶œë ¥ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ê³„ì† ì¶”ê°€
	            if (content) {
	                if(content.startsWith('-')) content = content.substring(1).trim();
	                content = content.replace(/^(ë°°ê²½ì€|ëª©ì ì€|í˜„ìƒì€|ë¬¸ì œì ì€|í•µì‹¬ ì†”ë£¨ì…˜ì€|ì‹¤í–‰ ì „ëµì€|ê¸°ëŒ€ íš¨ê³¼ëŠ”|ì†Œìš” ì˜ˆì‚°ì€)\s*/, '');
	                currentList += `<li style="margin-bottom:4px;">${content}</li>`;
	            }
	        } else {
	            // [í‚¤ì›Œë“œ] ì—†ì´ ë‚´ìš©ë§Œ ì´ì–´ì§€ëŠ” ì¤„ì€ í˜„ì¬ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
	            let content = cleanLine;
	            if (content.startsWith('-')) content = content.substring(1).trim();
	            if (content) {
	                currentList += `<li style="margin-bottom:4px;">${content}</li>`;
	            }
	        }
	    });
	    
	    // ë§ˆì§€ë§‰ ë¦¬ìŠ¤íŠ¸ ë‹«ê¸°
	    if (currentList !== "") {
	        resultHtml += `<ul style="padding-left:20px; margin:4px 0 8px 0; line-height:1.6; color:#333;">${currentList}</ul>`;
	    }
	    
	    return resultHtml;
	};

    let htmlTemplate = `
    <div style="font-family:'Pretendard','Malgun Gothic',sans-serif; max-width:900px; margin:0 auto; color:#1e293b;">
        <h2 style="text-align:center; color:#7c3aed; margin-bottom:12px; font-size:1.8rem; letter-spacing:-0.5px;">[ê¸°íšì„œ] ${aiData.title || "AI ìƒì„± í”„ë¡œì íŠ¸"}</h2>
        <div style="text-align:right; margin-bottom:16px; font-size:0.9rem; color:#64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: AI Assistant</div>
        <table style="width:100%; border-collapse:collapse; table-layout:fixed; border:2px solid #cbd5e1;">
            <tr>
                <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;">
                    <h3 style="margin:0 0 12px 0; color:#7c3aed; font-size:1.15rem; border-bottom:2px solid #ddd6fe; padding-bottom:8px;">1. ê¸°íš ë°°ê²½ ë° ëª©ì </h3>
                    <div style="font-size:1rem;">${formatToSubBullets(aiData.background_purpose)}</div>
                </td>
                <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;">
                    <h3 style="margin:0 0 12px 0; color:#7c3aed; font-size:1.15rem; border-bottom:2px solid #ddd6fe; padding-bottom:8px;">2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì </h3>
                    <div style="font-size:1rem;">${formatToSubBullets(aiData.current_issue)}</div>
                </td>
            </tr>
            <tr>
                <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;">
                    <h3 style="margin:0 0 12px 0; color:#7c3aed; font-size:1.15rem; border-bottom:2px solid #ddd6fe; padding-bottom:8px;">3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ</h3>
                    <div style="font-size:1rem;">${formatToSubBullets(aiData.strategy)}</div>
                </td>
                <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;">
                    <h3 style="margin:0 0 12px 0; color:#7c3aed; font-size:1.15rem; border-bottom:2px solid #ddd6fe; padding-bottom:8px;">4. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚°</h3>
                    <div style="font-size:1rem;">${formatToSubBullets(aiData.roi)}</div>
                </td>
            </tr>
        </table>
        
        <div id="schedule-placeholder" style="margin-top:30px;"></div>
    </div>`;

    openDocModal(null, aiData.title, htmlTemplate, 'ê¸°íšì„œ');

    const footer = document.querySelector('#doc-modal .modal-footer-custom');
    if(footer) {
        let oldBtn = document.getElementById('ai-confirm-btn');
        if(oldBtn) oldBtn.remove();
        
        let confirmBtn = document.createElement('button');
        confirmBtn.id = 'ai-confirm-btn';
        confirmBtn.className = 'btn';
        confirmBtn.style.cssText = 'background: #7c3aed; color: #fff; font-weight: bold; border: none; padding: 10px 20px; margin-right: auto;';
        confirmBtn.innerHTML = 'âœ¨ ì´ëŒ€ë¡œ DB í™•ì • ë° ì¼ì • ìƒì„±';
        confirmBtn.onclick = confirmAndSaveAIProposal;
        footer.insertBefore(confirmBtn, footer.firstChild); 
    }

	// (ê¸°ì¡´ ì½”ë“œ) ì¼ì •í‘œ(Gantt) ìë™ ì‚½ì… íŠ¸ë¦¬ê±°
    if(aiData.schedule && aiData.schedule.length > 0) {
        document.getElementById('sch-start-month').value = aiData.schedule[0].start_date.substring(0, 7);
        document.getElementById('sch-project-name').value = aiData.title;
        document.getElementById('sch-input-list').innerHTML = ""; 
        
        aiData.schedule.forEach(task => {
            // ğŸš¨ "AI ìƒì„±"ì´ë¼ëŠ” ê³ ì • ë‹¨ì–´ë¥¼ ì§€ìš°ê³ , AIê°€ ë³´ë‚´ì¤€ ì¹´í…Œê³ ë¦¬ ê³µì •ëª…ì„ ì”ë‹ˆë‹¤!
            const categoryName = task.category || "ê¸°ë³¸ ì‘ì—…";
            addScheduleRow(categoryName, task.task_name, task.start_date, task.end_date, "");
        });
        
        setTimeout(() => { insertSmartSchedule(); }, 500); 
    }
}
// ğŸš¨ ì‚¬ìš©ìê°€ "DB í™•ì •" ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì§„ì§œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
async function confirmAndSaveAIProposal() {
    if(!window.tempAIProposalData) return;
    
    if(typeof showAdminLoading==='function') showAdminLoading("DBì— ê¸°íšì„œì™€ ì¼ì •ì„ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤... ğŸ’¾");
    
    try {
        const res = await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({ mode: "saveProposal", pData: window.tempAIProposalData })
        });
        const json = await res.json();
        
        if(json.result === "success") {
            alert("âœ¨ ê¸°íšì„œì™€ ì„¸ë¶€ ì¼ì •ì´ DBì— ì™„ë²½í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            closeModal('doc-modal'); // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('ai-confirm-btn')?.remove(); // ë²„íŠ¼ ì§€ìš°ê¸°
            if(typeof loadAllData === 'function') await loadAllData(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + json.msg);
        }
    } catch(e) {
        console.error(e); alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
}

// -------------------------------------------------------------
// ğŸ”¥ [ì‹ ê·œ] ê¸°íšì„œ ì—´ëŒ ì‹œ ì‹¤ì‹œê°„ Todo ë¦¬ìŠ¤íŠ¸(Task) ì—°ë™ ê¸°ëŠ¥
// -------------------------------------------------------------
const originalOpenDocModal = window.openDocModal; // ê¸°ì¡´ ëª¨ë‹¬ ì—¬ëŠ” í•¨ìˆ˜ ê°€ë¡œì±„ê¸°(Hook)

window.openDocModal = function(docId, title, content, type) {
    // 1. ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ê¸°íšì„œ ëª¨ë‹¬ì„ ë¨¼ì € ì—½ë‹ˆë‹¤.
    if(typeof originalOpenDocModal === 'function') {
        originalOpenDocModal(docId, title, content, type);
    }

    // ğŸš¨ [í•µì‹¬ ì¶”ê°€] í˜¹ì‹œ ì˜ˆì „ì— ì—´ì–´ë‘” ë‹¤ë¥¸ ë¬¸ì„œì˜ Todo í‘œê°€ ë‚¨ì•„ìˆë‹¤ë©´ ê¹”ë”í•˜ê²Œ ì§€ìš°ê¸° (ì¤‘ë³µ ë°©ì§€)
    const oldContainer = document.getElementById('realtime-todo-container');
    if (oldContainer) oldContainer.remove();

    // 2. ë§Œì•½ ì—´ë¦° ë¬¸ì„œê°€ 'ê¸°íšì„œ'ì´ê³ , DBì— ì •ì‹ìœ¼ë¡œ ì €ì¥ëœ ë¬¸ì„œë¼ë©´?
    if (type === 'ê¸°íšì„œ' && docId) {
        // ğŸš¨ [í•µì‹¬ ìˆ˜ì •] ì—ë””í„°(textarea) ì•ˆì´ ì•„ë‹ˆë¼, "ëª¨ë‹¬ ë³¸ë¬¸ ì˜ì—­(modal-body-custom)"ì„ ì°¾ì•„ì„œ ê·¸ ë§¨ ë°‘ì— ë¶™ì…ë‹ˆë‹¤!
        const modalBody = document.querySelector('#doc-modal .modal-body-custom');
        
        if (modalBody) {
            const todoContainer = document.createElement('div');
            todoContainer.id = 'realtime-todo-container';
            todoContainer.style.marginTop = "20px"; // ì—ë””í„°ì™€ ê°„ê²© ë„ìš°ê¸°
            todoContainer.innerHTML = '<div style="text-align:center; padding: 30px; color:#64748b; font-weight:bold;">â³ í˜„ì¥ì˜ ì‹¤ì‹œê°„ ì§„í–‰ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            // ëª¨ë‹¬ ë³¸ë¬¸ ìŠ¤í¬ë¡¤ ì˜ì—­ ë§¨ ì•„ë˜ì— Todo í‘œ ì‚½ì…
            modalBody.appendChild(todoContainer);

            // êµ¬ê¸€ DBì—ì„œ ìµœì‹  ë°ì´í„° ê¸ì–´ì˜¤ê¸° ì‹¤í–‰!
            fetchAndRenderRealtimeTodos(docId);
        }
    }
};

async function fetchAndRenderRealtimeTodos(proposalId) {
    try {
        // êµ¬ê¸€ ì•± ìŠ¤í¬ë¦½íŠ¸ APIë¥¼ í˜¸ì¶œí•´ ìµœì‹  ëª©í‘œì™€ í•  ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
        const json = await res.json();
        
        if(json.result !== "success") throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
        
        const goals = json.goals || [];
        const tasks = json.tasks || [];
        
        // 1. ì´ ê¸°íšì„œ(proposalId)ì™€ ì—°ê²°ëœ 'ì¤‘ê°„ ëª©í‘œ(ê³µì •)' ì°¾ê¸°
        const relatedMidGoals = goals.filter(g => g['ë¹„ê³ '] === proposalId);
        const midGoalIds = relatedMidGoals.map(g => g['ID']);
        
        if (midGoalIds.length === 0) {
            document.getElementById('realtime-todo-container').innerHTML = ''; 
            return;
        }
        
        // 2. ê·¸ ê³µì •ë“¤ì— ë§¤ë‹¬ë¦° 'ì‹¤ì œ í•  ì¼(Tasks)' ëª¨ë‘ ì°¾ê¸°
        const relatedTasks = tasks.filter(t => midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
        
        // ë‚ ì§œ(ê¸°í•œ)ê°€ ë¹ ë¥¸ ìˆœì„œëŒ€ë¡œ ì •ë ¬
        relatedTasks.sort((a, b) => (a['ê¸°í•œ'] || '').localeCompare(b['ê¸°í•œ'] || ''));

        // 3. UI/UX ë Œë”ë§ (ì˜ˆìœ í‘œë¡œ ê·¸ë¦¬ê¸°)
        let html = `
        <div style="margin-top: 50px; padding-top: 25px; border-top: 2px dashed #cbd5e1; font-family:'Pretendard','Malgun Gothic',sans-serif;">
            <h3 style="color: #4f46e5; margin-bottom: 16px; font-size: 1.3rem; display:flex; align-items:center; gap:8px;">
                <span>ğŸ”¥</span> ì‹¤ì œ ì§„í–‰ ì¤‘ì¸ ì„¸ë¶€ Todo ë¦¬ìŠ¤íŠ¸ (ì‹¤ì‹œê°„)
            </h3>
        `;
        
        if (relatedTasks.length === 0) {
            html += `<div style="background:#f8fafc; padding:20px; border-radius:8px; color:#64748b; font-size:0.95rem; text-align:center;">
                        ì•„ì§ í˜„ì¥ì—ì„œ ì¶”ê°€ëœ ì„¸ë¶€ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. <br><b>í•  ì¼ ê´€ë¦¬(Todo)</b> ë©”ë‰´ì—ì„œ ì´ í”„ë¡œì íŠ¸ì— í•  ì¼ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”!
                     </div>`;
        } else {
            html += `
            <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                <table style="width:100%; border-collapse:collapse; text-align:left;">
                    <thead>
                        <tr style="background:#f8fafc; color:#475569; font-size:0.9rem;">
                            <th style="padding:12px 15px; border-bottom:1px solid #e2e8f0; width: 80px; text-align:center;">ìƒíƒœ</th>
                            <th style="padding:12px 15px; border-bottom:1px solid #e2e8f0;">ì‘ì—…ëª…</th>
                            <th style="padding:12px 15px; border-bottom:1px solid #e2e8f0; width: 120px;">ê¸°í•œ</th>
                            <th style="padding:12px 15px; border-bottom:1px solid #e2e8f0; width: 250px;">ì—°ê²°ëœ ê³µì • (ì¤‘ê°„ëª©í‘œ)</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            relatedTasks.forEach(t => {
                const status = t['ìƒíƒœ'] || 'ëŒ€ê¸°';
                let badgeColor = '#94a3b8'; // ëŒ€ê¸°(íšŒìƒ‰)
                if(status === 'ì§„í–‰ì¤‘') badgeColor = '#3b82f6'; // íŒŒë€ìƒ‰
                if(status === 'ì™„ë£Œ') badgeColor = '#22c55e'; // ì´ˆë¡ìƒ‰
                
                // ì¤‘ê°„ ëª©í‘œ ì´ë¦„ ë§¤í•‘
                const parentGoal = relatedMidGoals.find(g => g['ID'] === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']);
                const parentName = parentGoal ? parentGoal['ì œëª©'] : '-';
                
                html += `
                    <tr style="border-bottom:1px solid #f1f5f9; font-size:0.95rem; background:#fff;">
                        <td style="padding:12px 15px; text-align:center;">
                            <span style="background:${badgeColor}; color:#fff; padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                                ${status}
                            </span>
                        </td>
                        <td style="padding:12px 15px; color:#1e293b; font-weight:500;">${t['ì œëª©']}</td>
                        <td style="padding:12px 15px; color:#64748b; font-size:0.9rem;">${t['ê¸°í•œ'] || '-'}</td>
                        <td style="padding:12px 15px; color:#64748b; font-size:0.85rem;">${parentName}</td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>`;
        }
        
        html += `</div>`;
        document.getElementById('realtime-todo-container').innerHTML = html;
        
    } catch(e) {
        console.error(e);
        document.getElementById('realtime-todo-container').innerHTML = `
            <div style="background:#fee2e2; color:#ef4444; padding:15px; border-radius:8px; text-align:center; margin-top:20px;">
                âŒ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            </div>`;
    }
}
</script>
</body>
</html>
