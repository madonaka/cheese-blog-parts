<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¬¸ì„œ ì•„ì¹´ì´ë¸Œ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ (todo_manageì™€ ë™ì¼)
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* --- ì•„ì¹´ì´ë¸Œ ì „ìš© ë””ìì¸ --- */
    .archive-header {
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0;
    }
    .archive-title h2 { margin: 0 0 8px 0; font-size: 1.5rem; color: #1e293b; font-weight: 800; }
    .archive-title p { margin: 0; color: #64748b; font-size: 0.95rem; }
    
    .report-generator-group {
      display: flex; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;
    }
    .btn-gen {
      background: #fff; color: #3b82f6; border: 1px solid #bfdbfe; font-weight: 700; padding: 8px 16px;
      border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .btn-gen:hover { background: #eff6ff; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(59,130,246,0.1); }
    .btn-new { background: #3b82f6; color: white; border: none; }
    .btn-new:hover { background: #2563eb; }

    /* ë¬¸ì„œ ê·¸ë¦¬ë“œ ë·° */
    .doc-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
    }
    .doc-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; position: relative; cursor: pointer;
      display: flex; flex-direction: column; height: 220px;
    }
    .doc-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #cbd5e1; }
    .doc-type-badge {
      position: absolute; top: 20px; right: 20px; background: #f1f5f9; color: #475569; font-size: 0.75rem;
      padding: 4px 8px; border-radius: 4px; font-weight: 700;
    }
    .doc-card-title { font-size: 1.15rem; font-weight: 800; color: #1e293b; margin: 0 0 10px 0; padding-right: 50px; line-height: 1.4; }
    .doc-card-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 12px; }
    .doc-card-preview { font-size: 0.9rem; color: #64748b; line-height: 1.5; flex: 1; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    
    .doc-card-actions { margin-top: 16px; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px solid #f1f5f9; padding-top: 12px; }
    
    /* ì—ë””í„° ëª¨ë‹¬ (ë„“ê²Œ ì¾Œì í•˜ê²Œ) */
    .modal-box.large-modal { max-width: 900px; height: 90vh; display: flex; flex-direction: column; }
    .note-editor.note-frame { border-color: #e2e8f0; border-radius: 8px; overflow: hidden; }
  </style>
</head>
<body>

<div class="admin-container">
  <div id="header-slot"></div>
  
  <div class="admin-main">
    <div id="menu-slot"></div>
    
    <div class="content-area">
      <div class="content-header"></div>
      
      <div class="archive-header">
        <div class="archive-title">
          <h2>ğŸ“‚ ë³´ê³ ì„œ & ê¸°íšì„œ ì•„ì¹´ì´ë¸Œ</h2>
          <p>ì‘ì—… ë¡œê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ ìë™ ìƒì„±í•˜ê³  ë¬¸ì„œë¥¼ ë³´ê´€í•˜ì„¸ìš”.</p>
        </div>
        <div class="report-generator-group">
          <button class="btn-gen" onclick="generateAutoReport('daily')">ğŸ“ ì¼ì¼ ë³´ê³ ì„œ</button>
          <button class="btn-gen" onclick="generateAutoReport('weekly')">ğŸ“Š ì£¼ê°„ ë³´ê³ ì„œ</button>
          <button class="btn-gen" onclick="generateAutoReport('monthly')">ğŸ“… ì›”ê°„ ë³´ê³ ì„œ</button>
          <div style="width:1px; background:#e2e8f0; margin: 0 4px;"></div>
          <button class="btn-gen btn-new" onclick="openDocModal()">+ ë¹ˆ ë¬¸ì„œ ì‘ì„±</button>
        </div>
      </div>

      <div class="doc-grid" id="doc-grid">
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 0; color: #94a3b8;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
    </div>
  </div>
</div>

<div id="doc-modal" class="custom-modal">
  <div class="modal-box large-modal">
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="doc-modal-title">ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
    </div>
    
    <form id="doc-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin:0;">
      <div class="modal-body-custom" style="flex: 1; overflow-y: auto; padding-bottom: 20px;">
        <input type="hidden" id="doc-id" value="">
        
        <div class="field" style="display:flex; gap:12px; margin-bottom:16px;">
          <div style="flex: 1;">
            <label class="input-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="doc-title" class="styled-input" placeholder="ë³´ê³ ì„œ ë˜ëŠ” ê¸°íšì„œ ì œëª©" required style="font-size:1.1rem; font-weight:700;">
          </div>
          <div style="width: 150px;">
            <label class="input-label">ë¬¸ì„œ ìœ í˜•</label>
            <select id="doc-type" class="styled-input">
              <option value="ë³´ê³ ì„œ">ğŸ“Š ë³´ê³ ì„œ</option>
              <option value="ê¸°íšì„œ">ğŸ’¡ ê¸°íšì„œ</option>
            </select>
          </div>
        </div>

        <div class="field" style="flex: 1; display:flex; flex-direction:column;">
          <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="doc-content" required></textarea>
        </div>
      </div>
      
      <div class="modal-footer-custom" style="justify-content: flex-end; padding-top: 16px;">
        <button type="button" class="btn-close-custom" onclick="closeModal('doc-modal')">ì·¨ì†Œ</button>
        <button type="submit" class="btn-save-custom" id="btn-save-doc" style="background:#3b82f6;">ğŸ’¾ ë¬¸ì„œ ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<script>
  let g_docs = [];
  let g_logs = [];
  let g_goals = [];
  let g_tasks = [];

  // ==========================================
  // 1. ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
  // ==========================================
  $(document).ready(async function() {
    await loadHeaderMenu();
    
    // ì—ë””í„° ì´ˆê¸°í™”
    $('#doc-content').summernote({
      height: 450,
      lang: 'ko-KR',
      toolbar: [
        ['style', ['style']],
        ['font', ['bold', 'underline', 'clear']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']],
        ['insert', ['link']],
        ['view', ['codeview']]
      ]
    });

    loadAllData();
  });

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_logs = json.logs || [];
        g_goals = json.goals || [];
        g_tasks = json.tasks || [];
        
        // ê¸°ì¡´ task_masterì—ì„œ ìœ í˜•ì´ 'ë³´ê³ ì„œ'ë‚˜ 'ê¸°íšì„œ'ì¸ ê²ƒë§Œ ê±¸ëŸ¬ë‚´ì–´ ë¬¸ì„œë¡œ ì·¨ê¸‰
        g_docs = g_tasks.filter(t => t['ìœ í˜•'] === 'ë³´ê³ ì„œ' || t['ìœ í˜•'] === 'ê¸°íšì„œ');
        
        // ìµœì‹ ìˆœ ì •ë ¬
        g_docs.sort((a, b) => b.ID.localeCompare(a.ID));
        renderDocs();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // ==========================================
  // 2. ì•„ì¹´ì´ë¸Œ ë Œë”ë§ (ì¹´ë“œ UI)
  // ==========================================
  function renderDocs() {
    const root = document.getElementById('doc-grid');
    root.innerHTML = "";
    
    if(g_docs.length === 0) {
        root.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 60px; color:#94a3b8; background:#f8fafc; border-radius:12px; border:2px dashed #cbd5e1;">ë³´ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ë³´ê³ ì„œë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”!</div>`;
        return;
    }

    g_docs.forEach(doc => {
      const card = document.createElement('div');
      card.className = "doc-card";
      
      const isReport = doc['ìœ í˜•'] === 'ë³´ê³ ì„œ';
      const badgeColor = isReport ? '#eff6ff' : '#f0fdf4';
      const textColor = isReport ? '#2563eb' : '#16a34a';
      
      // HTML íƒœê·¸ ì œê±°í•˜ì—¬ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (ë¯¸ë¦¬ë³´ê¸° ìš©ë„)
      const plainText = (doc['ìƒì„¸ë‚´ìš©'] || "").replace(/<[^>]+>/g, '').replace(/&nbsp;/g, ' ');
      
      // ë‚ ì§œ ì¶”ì¶œ (ID ê¸°ë°˜ ë˜ëŠ” ì˜¤ëŠ˜ë‚ ì§œ)
      const rawDate = doc['ê¸°í•œ'] ? doc['ê¸°í•œ'].split('T')[0] : (doc['ì‹œì‘ì¼'] ? doc['ì‹œì‘ì¼'].split('T')[0] : 'ë‚ ì§œ ì—†ìŒ');

      card.innerHTML = `
        <div class="doc-type-badge" style="background:${badgeColor}; color:${textColor};">${isReport ? 'ğŸ“Š ë³´ê³ ì„œ' : 'ğŸ’¡ ê¸°íšì„œ'}</div>
        <h3 class="doc-card-title">${doc['ì œëª©'] || '(ì œëª© ì—†ìŒ)'}</h3>
        <div class="doc-card-date">ğŸ—“ ìµœì¢… ìˆ˜ì •: ${rawDate}</div>
        <div class="doc-card-preview">${plainText || 'ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
        <div class="doc-card-actions">
           <button class="btn" style="background:#f1f5f9; color:#475569; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;" onclick="openDocModal('${doc.ID}'); event.stopPropagation();">ìˆ˜ì •</button>
           <button class="btn" style="background:#fee2e2; color:#ef4444; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;" onclick="deleteDoc('${doc.ID}'); event.stopPropagation();">ì‚­ì œ</button>
        </div>
      `;
      
      card.onclick = () => openDocModal(doc.ID);
      root.appendChild(card);
    });
  }

  // ==========================================
  // 3. ìë™ ë³´ê³ ì„œ ìƒì„± ë¡œì§
  // ==========================================
  function generateAutoReport(rangeType) {
    const today = new Date();
    today.setHours(23,59,59,999);
    
    let startDate = new Date();
    startDate.setHours(0,0,0,0);
    let titlePrefix = "";

    if (rangeType === 'daily') {
        titlePrefix = `[ì¼ì¼ ë³´ê³ ì„œ] ${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
    } 
    else if (rangeType === 'weekly') {
        // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ê³„ì‚°
        const day = startDate.getDay() || 7; 
        startDate.setDate(startDate.getDate() - day + 1);
        titlePrefix = `[ì£¼ê°„ ë³´ê³ ì„œ] ${today.getMonth()+1}ì›” ${Math.ceil(today.getDate()/7)}ì£¼ì°¨`;
    } 
    else if (rangeType === 'monthly') {
        startDate.setDate(1); // ì´ë‹¬ 1ì¼
        titlePrefix = `[ì›”ê°„ ë³´ê³ ì„œ] ${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ê²°ì‚°`;
    }

    // 1. í•´ë‹¹ ê¸°ê°„ì˜ ë¡œê·¸ ì¶”ì¶œ
    const targetLogs = g_logs.filter(log => {
        if (!log['ë‚ ì§œ']) return false;
        const d = new Date(log['ë‚ ì§œ']);
        return d >= startDate && d <= today;
    });

    if (targetLogs.length === 0) {
        alert("ì„ íƒí•˜ì‹  ê¸°ê°„ ë‚´ì— ì‘ì„±ëœ ë¡œê·¸(ì‘ì—… ê¸°ë¡)ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // 2. ëª©í‘œë³„ë¡œ ë¡œê·¸ ë¬¶ê¸°
    const grouped = {};
    let totalLogs = 0;
    
    targetLogs.forEach(log => {
        const goalId = log['ê´€ë ¨_ëª©í‘œID'] || 'ê¸°íƒ€ ì—…ë¬´';
        if (!grouped[goalId]) grouped[goalId] = [];
        grouped[goalId].push(log);
        totalLogs++;
    });

    // 3. HTML í…œí”Œë¦¿ ì‘ì„±
    let htmlStr = `
        <div style="font-family: sans-serif; color: #333;">
            <h2 style="color: #2563eb; border-bottom: 2px solid #bfdbfe; padding-bottom: 10px;">${titlePrefix}</h2>
            <p><strong>ğŸ”¹ ìš”ì•½:</strong> ì„¤ì •ëœ ê¸°ê°„ ë‚´ ì´ <strong>${totalLogs}ê±´</strong>ì˜ ì‘ì—… ë¡œê·¸ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <br/>
            <h3 style="background: #f1f5f9; padding: 8px 12px; border-left: 4px solid #3b82f6;">ìƒì„¸ ì—…ë¬´ ë‚´ì—­</h3>
    `;

    for (const [gId, logs] of Object.entries(grouped)) {
        let goalName = "ê¸°íƒ€ (ë¯¸ë¶„ë¥˜ ì‘ì—…)";
        if (gId !== 'ê¸°íƒ€ ì—…ë¬´') {
            const goalObj = g_goals.find(g => g.ID === gId) || g_tasks.find(t => t.ID === gId);
            if (goalObj) goalName = `[${goalObj['ìœ í˜•']}] ${goalObj['ì œëª©']}`;
        }
        
        htmlStr += `<h4 style="color: #1e293b; margin-top: 20px;">ğŸ“Œ ${goalName}</h4>`;
        htmlStr += `<ul style="line-height: 1.6; color: #475569;">`;
        
        logs.forEach(l => {
            const dateStr = l['ë‚ ì§œ'] ? l['ë‚ ì§œ'].substring(5,10) : '';
            const duration = l['ì†Œìš”ì‹œê°„'] ? `<span style="color:#059669; font-size:0.9em;">(â±${l['ì†Œìš”ì‹œê°„']})</span>` : '';
            const logTitle = l['ì œëª©'] ? `<b>${l['ì œëª©']}</b> - ` : '';
            const logContent = l['ë‚´ìš©'].replace(/\\n/g, ' ');
            htmlStr += `<li style="margin-bottom: 6px;">[${dateStr}] ${logTitle}${logContent} ${duration}</li>`;
        });
        htmlStr += `</ul>`;
    }

    htmlStr += `<br/><p style="color:#94a3b8; font-size:0.85em;">â€» ì´ ë³´ê³ ì„œëŠ” ì‘ì—… ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div>`;

    // ì—ë””í„° ì—´ê³  ë‚´ìš© ì„¸íŒ…
    openDocModal(null, titlePrefix, htmlStr, 'ë³´ê³ ì„œ');
  }

  // ==========================================
  // 4. ëª¨ë‹¬ ì œì–´ ë° ì €ì¥ ë¡œì§
  // ==========================================
  function openDocModal(docId = null, defaultTitle = "", defaultHtml = "", defaultType = "ë³´ê³ ì„œ") {
    const modal = document.getElementById('doc-modal');
    modal.classList.add('open');
    document.getElementById('doc-form').reset();
    $('#doc-content').summernote('code', '');

    if (docId) {
        // ê¸°ì¡´ ë¬¸ì„œ ì—´ê¸°
        const doc = g_docs.find(d => d.ID === docId);
        if (doc) {
            document.getElementById('doc-modal-title').textContent = "ë¬¸ì„œ ìˆ˜ì •";
            document.getElementById('doc-id').value = doc.ID;
            document.getElementById('doc-title').value = doc['ì œëª©'];
            document.getElementById('doc-type').value = doc['ìœ í˜•'];
            $('#doc-content').summernote('code', doc['ìƒì„¸ë‚´ìš©'] || "");
        }
    } else {
        // ìƒˆ ë¬¸ì„œ (ë˜ëŠ” ìë™ ìƒì„±)
        document.getElementById('doc-modal-title').textContent = "ìƒˆ ë¬¸ì„œ ì‘ì„±";
        document.getElementById('doc-id').value = "";
        document.getElementById('doc-title').value = defaultTitle;
        document.getElementById('doc-type').value = defaultType;
        if(defaultHtml) $('#doc-content').summernote('code', defaultHtml);
    }
  }

  // ì €ì¥ ì´ë²¤íŠ¸
  document.getElementById('doc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save-doc');
    const originalText = btn.textContent;
    btn.textContent = "ì €ì¥ ì¤‘..."; btn.disabled = true;

    try {
        const docId = document.getElementById('doc-id').value;
        const title = document.getElementById('doc-title').value;
        const type = document.getElementById('doc-type').value;
        const content = $('#doc-content').summernote('code');
        const now = new Date().toISOString().split('T')[0];

        // todo_manageì˜ task_master ì €ì¥ êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš© (í˜¸í™˜ì„± 100%)
        const payload = {
            mode: docId ? "editItem" : "addItem",
            id: docId,
            type: type, // "ë³´ê³ ì„œ" ë˜ëŠ” "ê¸°íšì„œ"
            title: title,
            detail: content,
            priority: "ë³´í†µ",
            dueDate: now, // ìµœì¢… ìˆ˜ì •ì¼ ì¶”ì ìš©ìœ¼ë¡œ ê¸°í•œ ì»¬ëŸ¼ í™œìš©
            connectedId: "",
            color: ""
        };

        if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
        
        const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
        const json = await res.json();
        
        if(json.result === "success") {
            closeModal('doc-modal');
            await loadAllData(); // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ ê°±ì‹ 
        } else {
            alert("ì €ì¥ ì‹¤íŒ¨: " + json.msg);
        }
    } catch(err) {
        console.error(err); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        btn.textContent = originalText; btn.disabled = false;
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

  // ì‚­ì œ ë¡œì§
  async function deleteDoc(id) {
    if(!confirm("ì´ ë¬¸ì„œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) });
      await loadAllData();
    } catch(e) { console.error(e); alert("ì‚­ì œ ì˜¤ë¥˜"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
</script>

</body>
</html>
