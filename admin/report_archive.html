<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¬¸ì„œ ì•„ì¹´ì´ë¸Œ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
    
    // ğŸš¨ í•„ìˆ˜ ì„¤ì •: ìƒì„±ëœ ë¬¸ì„œ(íŒŒì¼)ê°€ ì €ì¥ë  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID
    const ARCHIVE_FOLDER_ID = "1MpTCfw8B1Y-77QFr4k5SCPfVQgso8fKi"; 
  </script>
  <script src="./admin-common.js"></script>

  <style>
    /* ì•„ì¹´ì´ë¸Œ ì „ìš© ìŠ¤íƒ€ì¼ */
    .archive-header { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .archive-title h2 { font-size: 1.8rem; color: #1e293b; margin: 0 0 8px 0; letter-spacing: -0.5px; }
    .archive-title p { color: #64748b; margin: 0; font-size: 0.95rem; }
    
    .report-controls { 
        display: flex; flex-wrap: wrap; gap: 8px; align-items: center; 
        background: #fff; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    
    .report-date-group { display: flex; align-items: center; gap: 8px; margin-right: 8px; }
    .report-date-group label { font-size: 0.9rem; font-weight: 700; color: #475569; }
    
    .btn-gen { padding: 8px 14px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; color: #475569; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-gen:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
    .btn-gen.btn-new { background: #3b82f6; color: #fff; border: none; margin-left: auto; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
    .btn-gen.btn-new:hover { background: #2563eb; }

    /* ë¬¸ì„œ ê·¸ë¦¬ë“œ */
    .doc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 12px; position: relative; overflow: hidden; min-height: 180px; }
    .doc-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
    
    .doc-type-badge { position: absolute; top: 16px; right: 16px; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .doc-card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 14px; }
    .doc-card-date { font-size: 0.85rem; color: #94a3b8; margin-top: auto; }
    .doc-card-actions { display: flex; gap: 8px; margin-top: 12px; border-top: 1px solid #f1f5f9; padding-top: 12px; }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    
    /* ëª¨ë‹¬ ë ˆì´ì–´ ê³„ì¸µ */
    #doc-modal { z-index: 2000; }
    #idea-select-modal, #schedule-maker-modal { z-index: 2100; }

    .modal-box { background: #fff; padding: 0; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); position: relative; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-box.large-modal { max-width: 1000px; height: 90vh; }

    .modal-header-custom { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .modal-title-custom { font-size: 1.2rem; font-weight: 700; color: #1e293b; }
    .modal-body-custom { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer-custom { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; justify-content: flex-end; background: #f8fafc; }

    /* í¼ ìš”ì†Œ */
    .styled-input, .styled-textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; font-family: inherit; box-sizing: border-box; }
    .styled-input:focus, .styled-textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 6px; }

    /* ì•„ì´ë””ì–´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .idea-select-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; transition: 0.2s; }
    .idea-select-item:hover { border-color: #ea580c; background: #fff7ed; }
    .idea-select-item input[type="checkbox"] { margin-top: 4px; transform: scale(1.2); cursor: pointer; }
    .idea-select-content { flex: 1; }
    .idea-select-title { font-weight: 700; color: #1e293b; font-size: 0.95rem; margin-bottom: 4px; }
    .idea-select-desc { font-size: 0.85rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* ì¸ì‡„ ìµœì í™” */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      .modal-box.large-modal { position: absolute; top: 0; left: 0; width: 100%; height: auto; box-shadow: none; }
    }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
       <div class="archive-header">
          <div class="archive-title">
            <h2>ğŸ“‚ ë³´ê³ ì„œ & ê¸°íšì„œ ì•„ì¹´ì´ë¸Œ</h2>
            <p>ë‚´ìš©ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì•ˆì „í•˜ê²Œ, ê´€ë¦¬ëŠ” ê°€ë³ê²Œ!</p>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
          </div>
          
          <div class="report-controls">
            <div class="report-date-group">
              <label for="report-base-date">ê¸°ì¤€ì¼</label>
              <input type="date" id="report-base-date" class="styled-input" style="padding: 6px 10px; width: 140px; font-weight: 600; color: #1e293b;">
            </div>

            <div style="width:1px; height:24px; background:#cbd5e1; margin:0 10px;"></div>

            <div style="display:flex; gap:6px; align-items:center;">
                <span style="font-size:0.8rem; font-weight:700; color:#3b82f6;">REPORT</span>
                <button class="btn-gen" onclick="generateAutoReport('daily')">ğŸ“ ì¼ì¼</button>
                <button class="btn-gen" onclick="generateAutoReport('weekly')">ğŸ“Š ì£¼ê°„</button>
                <button class="btn-gen" onclick="generateAutoReport('monthly')">ğŸ“… ì›”ê°„</button>
            </div>

            <div style="width:1px; height:24px; background:#cbd5e1; margin:0 10px;"></div>

            <div style="display:flex; gap:6px; align-items:center;">
                <span style="font-size:0.8rem; font-weight:700; color:#ea580c;">PLANNING</span>
                <button class="btn-gen" style="background:#fff7ed; color:#ea580c; border-color:#fed7aa;" onclick="generateProposalTemplate()">ğŸ’¡ 1-Page ê¸°íšì„œ</button>
                <button class="btn-gen" style="background:#fff7ed; color:#c2410c; border-color:#fed7aa;" onclick="openIdeaSelector('new')">âœ¨ ì•„ì´ë””ì–´ë¡œ ê¸°íš</button>
            </div>
            
            <div style="flex:1;"></div>
            <button class="btn-gen btn-new" onclick="openDocModal(null, '', '', 'ì¼ë°˜')">+ ë¹ˆ ë¬¸ì„œ</button>
          </div>
        </div>

        <div class="doc-grid" id="doc-grid">
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 0; color: #94a3b8;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>

      </div>
    </section>
  </main>
</div>

<div id="doc-modal" class="custom-modal">
  <div class="modal-box large-modal">
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="doc-modal-title">ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
    </div>
    
    <form id="doc-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin:0;">
      <div class="modal-body-custom">
        <input type="hidden" id="doc-id" value="">
        <input type="hidden" id="doc-drive-id" value="">
        
        <div style="display:flex; gap:16px; margin-bottom:20px;">
          <div style="flex: 1;">
            <label class="input-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="doc-title" class="styled-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required style="font-size:1.1rem; font-weight:700;">
          </div>
          <div style="width: 160px;">
            <label class="input-label">ë¬¸ì„œ ìœ í˜•</label>
            <select id="doc-type" class="styled-input">
              <option value="ë³´ê³ ì„œ">ğŸ“Š ë³´ê³ ì„œ</option>
              <option value="ê¸°íšì„œ">ğŸ’¡ ê¸°íšì„œ</option>
              <option value="ì¼ë°˜">ğŸ“„ ì¼ë°˜</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column; flex:1;">
          <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="doc-content" required></textarea>
        </div>
      </div>

      <div class="modal-footer-custom" style="justify-content: space-between;">
        <div id="modal-tools-left" style="display: flex; gap: 8px;">
            <button type="button" class="btn" onclick="openIdeaSelector('insert')" style="padding:10px 16px; border-radius:10px; border:1px solid #fed7aa; background:#fff7ed; color:#ea580c; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px;">
                âœ¨ ì•„ì´ë””ì–´ ë„£ê¸°
            </button>
            <button type="button" class="btn" onclick="openScheduleMaker()" style="padding:10px 16px; border-radius:10px; border:1px solid #bae6fd; background:#f0f9ff; color:#0284c7; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px;">
                ğŸ“… ì¼ì •í‘œ ë„£ê¸°
            </button>
        </div>

        <div style="display: flex; gap: 8px;">
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; color:#64748b; font-weight:700; cursor:pointer;" onclick="closeModal('doc-modal')">ì·¨ì†Œ</button>
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #3b82f6; background:#fff; color:#3b82f6; font-weight:700; cursor:pointer;" onclick="printReport()">ğŸ–¨ï¸ PDF</button>
            <button type="button" class="btn" style="padding:12px 20px; border-radius:12px; border:1px solid #10b981; background:#fff; color:#10b981; font-weight:700; cursor:pointer;" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€</button>
            <button type="submit" class="btn" id="btn-save-doc" style="padding:12px 24px; border-radius:12px; border:none; background:#3b82f6; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(59,130,246,0.3);">ğŸ’¾ ì €ì¥</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div id="idea-select-modal" class="custom-modal">
  <div class="modal-box" style="width: 500px; max-width: 90vw; background: #fff; border-radius: 16px;">
    <div class="modal-header-custom" style="background:#fff7ed; border-bottom:1px solid #fed7aa;">
      <span class="modal-title-custom" style="color:#c2410c;">âœ¨ ì•„ì´ë””ì–´ ì„ íƒ</span>
      <button type="button" class="btn" onclick="document.getElementById('idea-select-modal').classList.remove('open')" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body-custom" style="padding: 20px; overflow-y: auto;">
      <p style="margin-top:0; color:#64748b; font-size:0.9rem; margin-bottom:12px;">ëª©ë¡ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
      <div id="idea-list-container" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn" onclick="document.getElementById('idea-select-modal').classList.remove('open')" style="padding:10px 20px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
      <button type="button" class="btn" onclick="confirmIdeaSelection()" style="padding:10px 20px; border-radius:8px; border:none; background:#ea580c; color:#fff; font-weight:700; cursor:pointer;">ì„ íƒ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<div id="schedule-maker-modal" class="custom-modal">
  <div class="modal-box" style="width: 1000px; max-width: 95vw; background: #fff; border-radius: 16px;">
    <div class="modal-header-custom" style="background:#f0f9ff; border-bottom:1px solid #bae6fd;">
      <span class="modal-title-custom" style="color:#0369a1;">ğŸ“… í”„ë¡œì íŠ¸ ì¼ì •í‘œ ë§Œë“¤ê¸° (Auto-Gantt)</span>
      <button type="button" class="btn" onclick="closeScheduleMaker()" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
    </div>
    <div class="modal-body-custom" style="padding: 24px; overflow-y: auto; max-height: 70vh;">
      <div style="background:#fff; border:2px solid #e0f2fe; border-radius:12px; padding:16px; margin-bottom:20px; display:flex; gap:20px; align-items:flex-end;">
        <div style="flex:0 0 180px;">
            <label style="display:block; font-size:0.85rem; color:#0284c7; font-weight:700; margin-bottom:6px;">ì°¨íŠ¸ ì‹œì‘ ì›”(Month)</label>
            <input type="month" id="sch-start-month" class="styled-input" style="padding:8px 12px; font-weight:600;">
        </div>
        <div style="flex:1;">
            <label style="display:block; font-size:0.85rem; color:#64748b; font-weight:700; margin-bottom:6px;">í”„ë¡œì íŠ¸ëª…</label>
            <input type="text" id="sch-project-name" class="styled-input" value="ë¸”ë¡œê·¸ ì´ê´€ í”„ë¡œì íŠ¸" style="padding:8px 12px;">
        </div>
        <div>
            <button type="button" class="btn" onclick="loadSchedulePreset()" style="padding:10px 16px; background:#f0f9ff; color:#0284c7; border:1px solid #bae6fd; font-weight:700; border-radius:8px; cursor:pointer;">âš¡ ì˜ˆì œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:12px; overflow:hidden;">
          <table style="width:100%; border-collapse: collapse; font-size:0.95rem;">
            <thead>
                <tr style="background:#f8fafc; color:#475569; text-align:left;">
                    <th style="padding:12px 16px; width:140px;">ë‹¨ê³„ (Category)</th>
                    <th style="padding:12px 16px;">ì‘ì—… ë‚´ìš© (Task)</th>
                    <th style="padding:12px 16px; width:160px;">ì‹œì‘ì¼</th>
                    <th style="padding:12px 16px; width:20px; text-align:center;">~</th>
                    <th style="padding:12px 16px; width:160px;">ì¢…ë£Œì¼</th>
                    <th style="padding:12px 16px; width:60px; text-align:center;">ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody id="sch-input-list"></tbody>
          </table>
      </div>
      <button type="button" onclick="addScheduleRow()" style="width:100%; margin-top:16px; padding:14px; border:2px dashed #cbd5e1; background:#fff; color:#64748b; font-weight:700; border-radius:12px; cursor:pointer; transition:0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">+ ì‘ì—… ì¶”ê°€í•˜ê¸°</button>
    </div>
    <div class="modal-footer-custom">
      <button type="button" class="btn" onclick="closeScheduleMaker()" style="padding:12px 24px; border-radius:12px; background:#f1f5f9; color:#64748b; border:none; cursor:pointer; font-weight:600;">ë‹«ê¸°</button>
      <button type="button" class="btn" onclick="insertSmartSchedule()" style="padding:12px 24px; border-radius:12px; background:#0284c7; color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(2, 132, 199, 0.3);">âœ¨ ì¼ì •í‘œ ì‚½ì…</button>
    </div>
  </div>
</div>

<script>
// âœ… ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„±í™” ì¸ì‹ìš© ë³€ìˆ˜
  window.CHEESE_ADMIN_ACTIVE_PAGE = "report_archive"; 
  
  let g_docs = [];
  let g_logs = [];
  let g_goals = [];
  let g_tasks = [];
  
  // ì „ì—­ ë³€ìˆ˜
  let CURRENT_EDITING_SCHEDULE_EL = null; 
  let CURRENT_IDEA_MODE = 'new'; 

  document.addEventListener('DOMContentLoaded', () => {
    // ì¸ë¨¸ë…¸íŠ¸ ì´ˆê¸°í™”
    $('#doc-content').summernote({
      height: 600, lang: 'ko-KR',
      toolbar: [
        ['style', ['style']], ['font', ['bold', 'underline', 'clear']],
        ['color', ['color']], ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']], ['insert', ['link']], ['view', ['codeview', 'fullscreen']]
      ]
    });
    
    const todayStr = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    document.getElementById('report-base-date').value = todayStr;

    loadAllData();
  });

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_logs = json.logs || []; g_goals = json.goals || []; g_tasks = json.tasks || [];
        g_docs = g_tasks.filter(t => t['ìœ í˜•'] === 'ë³´ê³ ì„œ' || t['ìœ í˜•'] === 'ê¸°íšì„œ');
        g_docs.sort((a, b) => b.ID.localeCompare(a.ID)); 
        renderDocs();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function renderDocs() {
    const root = document.getElementById('doc-grid');
    root.innerHTML = "";
    
    if(g_docs.length === 0) {
        root.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 60px; color:#94a3b8; background:#f8fafc; border-radius:16px; border:2px dashed #cbd5e1; font-weight:600;">ë³´ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>`;
        return;
    }

    g_docs.forEach(doc => {
      const card = document.createElement('div'); card.className = "doc-card";
      const isReport = doc['ìœ í˜•'] === 'ë³´ê³ ì„œ';
      const badgeColor = isReport ? '#eff6ff' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? '#fff7ed' : '#f1f5f9');
      const textColor = isReport ? '#2563eb' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? '#c2410c' : '#475569');
      const rawDate = doc['ê¸°í•œ'] ? doc['ê¸°í•œ'].split('T')[0] : 'ë‚ ì§œ ì—†ìŒ';

      card.innerHTML = `
        <div class="doc-type-badge" style="background:${badgeColor}; color:${textColor};">${doc['ìœ í˜•']}</div>
        <h3 class="doc-card-title">${doc['ì œëª©'] || '(ì œëª© ì—†ìŒ)'}</h3>
        <div class="doc-card-date">ğŸ—“ ìµœì¢… ìˆ˜ì •: ${rawDate}</div>
        <div style="flex:1; display:flex; align-items:center; justify-content:center;">
            <span style="font-size:3rem;">${doc['ìœ í˜•'] === 'ë³´ê³ ì„œ' ? 'ğŸ“Š' : (doc['ìœ í˜•'] === 'ê¸°íšì„œ' ? 'ğŸ’¡' : 'ğŸ“„')}</span>
        </div>
        <div class="doc-card-actions">
           <button class="btn" style="background:#f1f5f9; color:#475569; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="openDocModal('${doc.ID}'); event.stopPropagation();">ğŸ“ ì—´ê¸°</button>
           <button class="btn" style="background:#fff1f2; color:#ef4444; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="deleteDoc('${doc.ID}'); event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      `;
      card.onclick = () => openDocModal(doc.ID);
      root.appendChild(card);
    });
  }

  // ==========================================
  // [NEW] ì¼ë¡  ë¨¸ìŠ¤í¬ ìŠ¤íƒ€ì¼ ìë™ ë³´ê³ ì„œ ë¡œì§ (íƒ€ì„ë¨¸ì‹  ì§„ì²™ë¥  ì ìš©)
  // ==========================================
  function generateAutoReport(rangeType) {
    const baseDateStr = document.getElementById('report-base-date').value;
    if (!baseDateStr) { alert("ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    
    // ê¸°ì¤€ ë‚ ì§œ ì„¤ì • (í•´ë‹¹ì¼ì˜ 23:59:59 ê¹Œì§€ í¬í•¨)
    const targetEndDate = new Date(baseDateStr); targetEndDate.setHours(23,59,59,999);
    let startDate = new Date(baseDateStr); startDate.setHours(0,0,0,0);
    
    let titlePrefix = "";
    if (rangeType === 'daily') {
        titlePrefix = `[Daily Report] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ${targetEndDate.getDate()}ì¼`;
    } else if (rangeType === 'weekly') {
        const day = startDate.getDay() || 7; startDate.setDate(startDate.getDate() - day + 1);
        titlePrefix = `[Weekly Report] ${targetEndDate.getMonth()+1}ì›” ${Math.ceil(targetEndDate.getDate()/7)}ì£¼ì°¨`;
    } else if (rangeType === 'monthly') {
        startDate.setDate(1); 
        titlePrefix = `[Monthly Report] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ê²°ì‚°`;
    }

    const targetLogs = g_logs.filter(log => {
        if (!log['ë‚ ì§œ']) return false;
        const d = new Date(log['ë‚ ì§œ']); return d >= startDate && d <= targetEndDate;
    });

    const activeBigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && g['ìƒíƒœ'] !== 'ì™„ë£Œ');
    
    // âœ… â€œìƒì„±â€ê³¼ â€œì¼ë°˜ ê¸°ë¡â€ì„ ë¶„ë¦¬
    let ideaCreateLogs = [], bugCreateLogs = [], publishLogs = [];
    let doneLogs = [];
    let postCount = 0;
    
    function getTag(log){
      return (log['íƒœê·¸'] || log['tags'] || "").toString().trim();
    }
    function getTitle(log){
      return (log['ì œëª©'] || log['title'] || "").toString();
    }
    function getContent(log){
      return (log['ë‚´ìš©'] || log['content'] || "").toString();
    }
    
    targetLogs.forEach(log => {
      const tag = getTag(log);
      const title = getTitle(log);
      const content = getContent(log);
    
      // âœ… todo_manage ìë™ë¡œê·¸ ì»¤ë²„: BugReport / Idea :contentReference[oaicite:6]{index=6}
      const isIdeaCreate =
        tag === 'ì•„ì´ë””ì–´' || tag === 'Idea' ||
        title.includes('ğŸ’¡') || content.includes('ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    
      const isBugCreate =
        tag === 'ë²„ê·¸' || tag === 'BugReport' ||
        title.includes('ğŸ') || title.includes('ë²„ê·¸') ||
        content.includes('ğŸ ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±ë¨:'); // log-formì´ ë³¸ë¬¸ì— ì‹¬ëŠ” ì‹œìŠ¤í…œ ë¬¸êµ¬
    
      const isPublish = (tag === 'Publish');
    
      if (isIdeaCreate) { ideaCreateLogs.push(log); return; }
      if (isBugCreate)  { bugCreateLogs.push(log);  return; }
    
      if (isPublish) {
        postCount++;
        publishLogs.push(log);   // âœ… ëª©ë¡ìš©ìœ¼ë¡œë„ ë³´ê´€
        return;                  // âœ… doneLogsì— ì„ì§€ ì•Šê¸°(ì›í•˜ë©´ return ì œê±°)
      }
    
      doneLogs.push(log);
    });


    // 1. Signal (í•µì‹¬ ëª©í‘œ) - ì§„ì²™ë¥  ê³„ì‚° ì‹œ targetEndDate ì „ë‹¬
    let signalHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
    if (activeBigGoals.length > 0) {
        activeBigGoals.forEach(bg => {
            const percent = getReportGoalProgress(bg.ID, true, targetEndDate);
            const ddayBadge = getReportDday(bg['ë§ˆê°ì¼'], targetEndDate);
            let statusColor = percent === 100 ? "#10b981" : (percent > 0 ? "#3b82f6" : "#64748b");
            
            signalHtml += `<li style="margin-bottom: 12px; list-style: none;">
                <div style="font-weight:700; color:#1e293b; margin-bottom:4px;">ğŸ¯ ${bg['ì œëª©']} ${ddayBadge}</div>
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="flex:1; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                        <div style="width:${percent}%; background:${statusColor}; height:100%;"></div>
                    </div>
                    <span style="font-size:0.85em; font-weight:800; color:${statusColor}">${percent}%</span>
                </div>
            </li>`;
        });
    } else {
        signalHtml += `<li>ğŸš€ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í•µì‹¬ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
    }
    signalHtml += `</ul>`;

    // 2. Bottlenecks
    let bottleneckHtml = `<ul style="padding-left: 20px; margin: 0; color: #b91c1c; line-height: 1.6;">`;
    let riskCount = 0;
    const autoRisks = analyzeProjectRisks(activeBigGoals, targetEndDate);
    if (autoRisks.length > 0) {
        autoRisks.forEach(risk => { bottleneckHtml += `<li style="margin-bottom:6px;">${risk}</li>`; riskCount++; });
    }
    if (bugCreateLogs.length > 0) {
      bottleneckHtml += `
        <li style="margin-bottom:6px; color:#ef4444;">
          <b>ğŸ í’ˆì§ˆ ì´ìŠˆ ë°œê²¬:</b> ${bugCreateLogs.length}ê±´ (ê¸°ì¤€ì¼ ìƒì„±)
          <div style="margin-top:6px; padding-left:14px; color:#b91c1c; font-weight:600;">
            ${bugCreateLogs.slice(0,5).map(b => `- ${getSmartLogTitle(b)}`).join('<br/>')}
            ${bugCreateLogs.length > 5 ? `<br/>...ì™¸ ${bugCreateLogs.length-5}ê±´` : ``}
          </div>
        </li>`;
      riskCount++;
    }
    if (riskCount === 0) bottleneckHtml = `<div style="text-align:center; color:#10b981; padding:20px;">âœ¨ <b>No Bottlenecks</b><br>í˜„ì¬ ì‹ë³„ëœ ì§€ì—° ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    else bottleneckHtml += `</ul>`;

    // 3. Velocity
    let velocityHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
    if (postCount > 0) velocityHtml += `<li style="margin-bottom:10px; color:#2563eb; font-weight:bold; list-style:none;">ğŸ“ <b>[Shipped]</b> ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ${postCount}ê±´ ë°œí–‰ ì™„ë£Œ</li>`;
    doneLogs.slice(0, 7).forEach(l => { const title = getSmartLogTitle(l); velocityHtml += `<li style="margin-bottom:4px;">${title}</li>`; });
    if (doneLogs.length > 7) velocityHtml += `<li style="color:#64748b; list-style:none;">...ì™¸ ${doneLogs.length - 7}ê±´ì˜ ì„¸ë¶€ ì‘ì—… ì™„ë£Œ</li>`;
    if (doneLogs.length === 0 && postCount === 0) velocityHtml += `<li style="color:#94a3b8;">ê¸ˆì¼ ê¸°ë¡ëœ ì™„ë£Œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
    velocityHtml += `</ul>`;

    // 4. Algorithm
    let algoHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
    if (ideaCreateLogs.length > 0) {
      algoHtml += `<li style="margin-bottom:8px; color:#ea580c;"><b>ğŸ’¡ Innovation (ì•„ì´ë””ì–´):</b><br/>`;
      ideaCreateLogs.slice(0, 7).forEach(i => {
        algoHtml += `- ${getSmartLogTitle(i)}<br/>`;
      });
      if (ideaCreateLogs.length > 7) algoHtml += `...ì™¸ ${ideaCreateLogs.length - 7}ê±´<br/>`;
      algoHtml += `</li>`;
    }
    algoHtml += `<li style="margin-bottom:6px;"><b>âš¡ Optimization (íš¨ìœ¨í™”):</b><br/>(ë°˜ë³µ ì‘ì—… ì œê±° ë˜ëŠ” ìë™í™” í•  ë¶€ë¶„ ì‘ì„±)</li>
    <li><b>â© Next Critical Path (ë‚´ì¼ í•  ì¼):</b><br/>(ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ë°˜ë“œì‹œ ì²˜ë¦¬í•´ì•¼ í•  1ìˆœìœ„ ì‘ì—…)</li></ul>`;

    const htmlTemplate = `
      <div style="font-family:'Pretendard','Malgun Gothic',sans-serif; max-width:900px; margin:0 auto; color:#1e293b;">
        <h2 style="text-align:center; color:#0f172a; margin-bottom:24px; font-size:1.6rem; letter-spacing:-0.5px;">${titlePrefix}</h2>
        <table style="width:100%; border-collapse:collapse; table-layout:fixed; border:2px solid #cbd5e1;">
          <tr>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1rem; border-bottom:2px solid #cbd5e1; padding-bottom:8px;">1. ğŸ¯ The Signal (í•µì‹¬ ëª©í‘œ í˜„í™©)</h3>${signalHtml}</td>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fef2f2;"><h3 style="margin:0 0 12px 0; color:#b91c1c; font-size:1.1rem; border-bottom:2px solid #fca5a5; padding-bottom:8px;">2. ğŸ›‘ The Bottlenecks (ë¦¬ìŠ¤í¬ & ë°©í•´ìš”ì†Œ)</h3>${bottleneckHtml}</td>
          </tr>
          <tr>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f0f9ff;"><h3 style="margin:0 0 12px 0; color:#0369a1; font-size:1.1rem; border-bottom:2px solid #bae6fd; padding-bottom:8px;">3. âš¡ Velocity (ì‹¤í–‰ ì†ë„ & ì„±ê³¼)</h3>${velocityHtml}</td>
            <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#1e293b; font-size:1.1rem; border-bottom:2px solid #cbd5e1; padding-bottom:8px;">4. âš™ï¸ The Algorithm (ìµœì í™” & Next Step)</h3>${algoHtml}</td>
          </tr>
        </table>
        <p style="text-align:right; color:#94a3b8; font-size:0.8rem; margin-top:12px;">â€» Generated by Cheese Lab (Elon Musk Style Action-Report)</p>
      </div>`;

    openDocModal(null, titlePrefix, htmlTemplate, 'ë³´ê³ ì„œ');
  }

  // ... (ê¸°ì¡´ ëª¨ë‹¬/ì €ì¥ ë¡œì§ ìœ ì§€) ...
  async function openDocModal(docId = null, defaultTitle = "", defaultHtml = "", defaultType = "ë³´ê³ ì„œ") {
    const modal = document.getElementById('doc-modal');
    modal.classList.add('open');
    document.getElementById('doc-form').reset();
    document.getElementById('doc-drive-id').value = ""; 
    $('#doc-content').summernote('code', '');

    const header = modal.querySelector('.modal-header-custom');
    const titleEl = document.getElementById('doc-modal-title');
    const toolsLeft = document.getElementById('modal-tools-left');
    const saveBtn = document.getElementById('btn-save-doc');

    const setModalTheme = (type) => {
        if (type === 'ê¸°íšì„œ') {
            header.style.background = '#fff7ed';
            header.style.borderBottom = '1px solid #fed7aa';
            titleEl.style.color = '#c2410c';
            titleEl.innerHTML = 'ğŸ“™ ê¸°íšì„œ ì‘ì„± (Planning)';
            toolsLeft.style.display = 'flex';
            saveBtn.style.background = '#ea580c';
        } else {
            header.style.background = '#eff6ff';
            header.style.borderBottom = '1px solid #bfdbfe';
            titleEl.style.color = '#1e40af';
            titleEl.innerHTML = 'ğŸ“˜ ë³´ê³ ì„œ ì‘ì„± (Report)';
            toolsLeft.style.display = 'none';
            saveBtn.style.background = '#3b82f6';
        }
    };

    if (docId) {
        const doc = g_docs.find(d => d.ID === docId);
        if (doc) {
            setModalTheme(doc['ìœ í˜•']);
            document.getElementById('doc-id').value = doc.ID;
            document.getElementById('doc-title').value = doc['ì œëª©'];
            document.getElementById('doc-type').value = doc['ìœ í˜•'];
            
            if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
                const fileId = doc['ìƒì„¸ë‚´ìš©'].split("DRIVE:")[1];
                document.getElementById('doc-drive-id').value = fileId;
                if(typeof showAdminLoading==='function') showAdminLoading("ë¬¸ì„œ ë¡œë”© ì¤‘...");
                try {
                    const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "getReportContent", fileId: fileId }) });
                    const json = await res.json();
                    if(json.result === "success") $('#doc-content').summernote('code', json.content);
                } catch(e) { alert("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨"); } 
                finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
            } else {
                $('#doc-content').summernote('code', doc['ìƒì„¸ë‚´ìš©'] || "");
            }
        }
    } else {
        setModalTheme(defaultType);
        document.getElementById('doc-id').value = "";
        document.getElementById('doc-title').value = defaultTitle;
        document.getElementById('doc-type').value = defaultType;
        if(defaultHtml) $('#doc-content').summernote('code', defaultHtml);
    }
  }

  document.getElementById('doc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save-doc');
    const originalText = btn.textContent;
    btn.textContent = "ì €ì¥ ì¤‘..."; btn.disabled = true;

    try {
        const docId = document.getElementById('doc-id').value;
        const title = document.getElementById('doc-title').value;
        const type = document.getElementById('doc-type').value;
        const contentHtml = $('#doc-content').summernote('code');
        const driveId = document.getElementById('doc-drive-id').value;
        const now = new Date().toISOString().split('T')[0];

        if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
        
        const drivePayload = {
            mode: "uploadReportContent",
            folderId: ARCHIVE_FOLDER_ID,
            fileId: driveId,
            title: title,
            content: contentHtml
        };
        const driveRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(drivePayload) });
        const driveJson = await driveRes.json();
        let savedFileId = driveId;
        if (driveJson.result === "success") savedFileId = driveJson.fileId;
        else throw new Error("ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì‹¤íŒ¨");

        const dbPayload = {
            mode: docId ? "editItem" : "addItem",
            id: docId, type: type, title: title,
            detail: "DRIVE:" + savedFileId,
            priority: "ë³´í†µ", dueDate: now, connectedId: "", color: ""
        };
        const dbRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(dbPayload) });
        const dbJson = await dbRes.json();
        
        if(dbJson.result === "success") {
            closeModal('doc-modal');
            await loadAllData(); 
        } else alert("DB ì €ì¥ ì‹¤íŒ¨");
    } catch(err) { console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message); } 
    finally {
        btn.textContent = originalText; btn.disabled = false;
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

  function deleteDoc(id) {
    if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) })
    .then(()=>loadAllData()).finally(()=>{ if(typeof hideAdminLoading==='function') hideAdminLoading(); });
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function printReport() {
    const content = $('#doc-content').summernote('code');
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>${document.getElementById('doc-title').value}</title><style>body{font-family:'Pretendard',sans-serif;padding:40px;}table{width:100%;border-collapse:collapse;border:2px solid #cbd5e1}td{border:1px solid #cbd5e1;padding:20px;}</style></head><body>${content}<script>window.onload=function(){window.print();setTimeout(function(){window.close();},100);}<\/script></body></html>`);
    printWindow.document.close();
  }

  async function saveAsImage() {
    const title = document.getElementById('doc-title').value || "report";
    const contentHtml = $('#doc-content').summernote('code');
    const printContainer = document.createElement('div');
    printContainer.style.position = 'fixed'; printContainer.style.left = '-9999px'; printContainer.style.width = '900px'; 
    printContainer.style.padding = '40px'; printContainer.style.background = '#ffffff';
    printContainer.innerHTML = `<style>.temp-wrap{font-family:'Pretendard',sans-serif;color:#1e293b}.temp-wrap table{width:100%;border-collapse:collapse;border:2px solid #cbd5e1}.temp-wrap td{border:1px solid #cbd5e1;padding:20px;vertical-align:top}</style><div class="temp-wrap">${contentHtml}</div>`;
    document.body.appendChild(printContainer);
    if(typeof showAdminLoading === 'function') showAdminLoading("ì´ë¯¸ì§€ ìƒì„± ì¤‘...");
    try {
        const canvas = await html2canvas(printContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
        const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = `${title}.png`; link.click();
    } catch (err) { console.error(err); alert("ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜"); } 
    finally { document.body.removeChild(printContainer); if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  }

  // ==========================================
  // [ê¸°íšì„œ] ì•„ì´ë””ì–´ ì„ íƒ & ì‚½ì…
  // ==========================================
  function openIdeaSelector(mode = 'new') {
      CURRENT_IDEA_MODE = mode;
      const container = document.getElementById('idea-list-container');
      container.innerHTML = "";
      const ideas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' || (t['ì œëª©'] && t['ì œëª©'].includes('ğŸ’¡')));
      if (ideas.length === 0) { alert("ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      ideas.sort((a, b) => b.ID.localeCompare(a.ID));
      
      ideas.forEach(idea => {
          const div = document.createElement('div');
          div.className = 'idea-select-item';
          div.onclick = (e) => { if(e.target.type !== 'checkbox') div.querySelector('input').click(); };
          const desc = idea['ìƒì„¸ë‚´ìš©'] ? idea['ìƒì„¸ë‚´ìš©'].replace(/<[^>]*>?/gm, '').substring(0, 60) : '(ë‚´ìš© ì—†ìŒ)';
          div.innerHTML = `<input type="checkbox" class="idea-chk" value="${idea.ID}"><div class="idea-select-content"><div class="idea-select-title">${idea['ì œëª©']}</div><div class="idea-select-desc">${desc}</div></div>`;
          container.appendChild(div);
      });
      document.getElementById('idea-select-modal').classList.add('open');
  }

  function confirmIdeaSelection() {
      const checkboxes = document.querySelectorAll('.idea-chk:checked');
      if (checkboxes.length === 0) { alert("ì„ íƒëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      let selectedIdeas = [];
      checkboxes.forEach(chk => {
          const idea = g_tasks.find(t => t.ID === chk.value);
          if (idea) selectedIdeas.push(idea);
      });
      document.getElementById('idea-select-modal').classList.remove('open');

      if (CURRENT_IDEA_MODE === 'insert') {
          let insertHtml = "";
          selectedIdeas.forEach(idea => {
              const desc = idea['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ";
              insertHtml += `<div style="margin-bottom:16px; padding:16px; background:#fff7ed; border-left:4px solid #ea580c; border-radius:4px;"><h4 style="margin:0 0 8px 0; color:#c2410c;">ğŸ’¡ ${idea['ì œëª©']}</h4><div style="font-size:0.95rem; color:#431407; line-height:1.6;">${desc}</div></div><br/>`;
          });
          $('#doc-content').summernote('pasteHTML', insertHtml);
      } else {
          generateProposalFromIdeas(selectedIdeas);
      }
  }

  // ==========================================
  // [ê¸°íšì„œ] ìŠ¤ë§ˆíŠ¸ ì¼ì • ìƒì„±ê¸°
  // ==========================================
  
  function openScheduleMaker() {
    CURRENT_EDITING_SCHEDULE_EL = null; 
    document.getElementById('schedule-maker-modal').classList.add('open');
    const today = new Date();
    document.getElementById('sch-start-month').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('sch-input-list').innerHTML = ""; 
    addScheduleRow(); 
  }
  
  function closeScheduleMaker() { 
      document.getElementById('schedule-maker-modal').classList.remove('open'); 
      CURRENT_EDITING_SCHEDULE_EL = null; 
  }

  function addScheduleRow(cat="", task="", sDate="", eDate="") {
    const tbody = document.getElementById('sch-input-list');
    const tr = document.createElement('tr');
    tr.style.borderBottom = "1px solid #f1f5f9";
    tr.innerHTML = `<td style="padding:8px 12px;"><input type="text" class="styled-input sch-cat" value="${cat}" placeholder="ë‹¨ê³„" style="width:100%;"></td><td style="padding:8px 12px;"><input type="text" class="styled-input sch-task" value="${task}" placeholder="í•  ì¼" style="width:100%;"></td><td style="padding:8px 12px;"><input type="date" class="styled-input sch-sdate" value="${sDate}" style="width:100%;"></td><td style="text-align:center;">âœ</td><td style="padding:8px 12px;"><input type="date" class="styled-input sch-edate" value="${eDate}" style="width:100%;"></td><td style="padding:8px 12px; text-align:center;"><button type="button" onclick="this.closest('tr').remove()" style="border:none; background:#fff1f2; color:#ef4444; width:30px; height:30px; border-radius:6px; cursor:pointer;">Ã—</button></td>`;
    tbody.appendChild(tr);
  }

  window.editEmbeddedSchedule = function(btn) {
      const wrapper = btn.closest('.schedule-section');
      if (!wrapper) return;
      const configRaw = wrapper.getAttribute('data-config');
      if (!configRaw) { alert("ë°ì´í„° ì†ìƒ"); return; }
      try {
          const config = JSON.parse(decodeURIComponent(configRaw));
          CURRENT_EDITING_SCHEDULE_EL = wrapper; 
          document.getElementById('schedule-maker-modal').classList.add('open');
          document.getElementById('sch-start-month').value = config.startMonth;
          document.getElementById('sch-project-name').value = config.projectName || "í”„ë¡œì íŠ¸";
          document.getElementById('sch-input-list').innerHTML = ""; 
          config.rows.forEach(r => {
              const sDate = r.s ? r.s.split('T')[0] : "";
              const eDate = r.e ? r.e.split('T')[0] : "";
              addScheduleRow(r.cat, r.task, sDate, eDate);
          });
      } catch(e) { console.error(e); }
  };

  function loadSchedulePreset() {
      if(document.getElementById('sch-input-list').children.length > 0 && !confirm("ì´ˆê¸°í™” í›„ ì˜ˆì œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.")) return;
      document.getElementById('sch-input-list').innerHTML = "";
      document.getElementById('sch-start-month').value = "2026-01";
      addScheduleRow("1ë‹¨ê³„", "íˆ´ ë³´ì™„", "2026-01-28", "2026-02-02");
      addScheduleRow("", "í…ŒìŠ¤íŠ¸ ì´ê´€", "2026-01-28", "2026-02-02");
      addScheduleRow("2ë‹¨ê³„", "ê°€ê³„ë„ ì´ê´€", "2026-02-03", "2026-02-09");
      addScheduleRow("3ë‹¨ê³„", "ìµœì¢… ë§ˆê°", "2026-02-10", "2026-02-14");
  }

  function insertSmartSchedule() {
    const startMonthVal = document.getElementById('sch-start-month').value;
    const projectName = document.getElementById('sch-project-name').value;
    if(!startMonthVal) { alert("ì‹œì‘ ì›” ì„ íƒ í•„ìš”"); return; }

    let maxDate = new Date(startMonthVal + "-01"); maxDate.setMonth(maxDate.getMonth() + 1); 
    const rows = [];
    const saveRows = []; 

    document.querySelectorAll('#sch-input-list tr').forEach(tr => {
        const sVal = tr.querySelector('.sch-sdate').value;
        const eVal = tr.querySelector('.sch-edate').value;
        if(eVal) { const e = new Date(eVal); if(e > maxDate) maxDate = e; }
        const rowData = { cat: tr.querySelector('.sch-cat').value, task: tr.querySelector('.sch-task').value, s: sVal?new Date(sVal):null, e: eVal?new Date(eVal):null };
        rows.push(rowData);
        saveRows.push({ ...rowData, s: sVal, e: eVal });
    });

    const configData = encodeURIComponent(JSON.stringify({ startMonth: startMonthVal, projectName: projectName, rows: saveRows }));

    let gridHtml = "", subHeaderHtml = "";
    let currentIterDate = new Date(startMonthVal + "-01");
    const gridMap = [];
    while (currentIterDate <= maxDate) {
        const y = currentIterDate.getFullYear(), m = currentIterDate.getMonth(), lastDay = new Date(y, m+1, 0).getDate();
        const weeks = Math.ceil(lastDay / 7); 
        gridHtml += `<th colspan="${weeks}" style="border:1px solid #cbd5e1; background:#f0f9ff; padding:8px; font-size:0.9rem; color:#0369a1;">${m+1}ì›”</th>`;
        for(let w=1; w<=weeks; w++) {
            subHeaderHtml += `<th style="border:1px solid #e2e8f0; background:#f8fafc; padding:4px; font-size:0.75rem; color:#64748b; width:30px; text-align:center;">${w}</th>`;
            gridMap.push({ y: y, m: m, w: w });
        }
        currentIterDate.setMonth(currentIterDate.getMonth() + 1);
    }

    let tbodyHtml = "";
    rows.forEach(item => {
        let cols = "";
        let startIdx = -1, endIdx = -1;
        if (item.s && item.e) {
            const sY=item.s.getFullYear(), sM=item.s.getMonth(), sW=Math.ceil(item.s.getDate()/7);
            startIdx = gridMap.findIndex(g=>g.y===sY && g.m===sM && g.w===sW);
            const eY=item.e.getFullYear(), eM=item.e.getMonth(), eW=Math.ceil(item.e.getDate()/7);
            for(let i=gridMap.length-1; i>=0; i--) if(gridMap[i].y===eY && gridMap[i].m===eM && gridMap[i].w===eW) { endIdx=i; break; }
        }
        for(let i=0; i<gridMap.length; i++) {
            if (startIdx!==-1 && endIdx!==-1 && i>=startIdx && i<=endIdx) {
                let style = "background:#3b82f6; height:10px; margin-top:6px; opacity:0.8;";
                let content = "";
                if(startIdx===endIdx) style+="border-radius:5px;"; else if(i===startIdx) style+="border-radius:5px 0 0 5px;"; else if(i===endIdx) { style+="border-radius:0 5px 5px 0;"; content="â–¶"; }
                cols += `<td style="border:1px solid #e2e8f0; padding:0; vertical-align:middle; text-align:right; font-size:8px; line-height:1; color:#3b82f6;"><div style="${style} position:relative;"><span style="position:absolute; right:-3px; top:-4px; font-size:12px;">${content}</span></div></td>`;
            } else cols += `<td style="border:1px solid #e2e8f0; background:#fff;"></td>`;
        }
        tbodyHtml += `<tr><td style="border:1px solid #cbd5e1; padding:8px; font-size:0.85rem; text-align:center; vertical-align:middle; ${item.cat?'font-weight:700; background:#e0f2fe; color:#0369a1;':'background:#fff;'}">${item.cat}</td><td style="border:1px solid #cbd5e1; padding:6px 10px; font-size:0.9rem; color:#1e293b; font-weight:500;"><span style="color:#cbd5e1;">â—»</span> ${item.task}</td>${cols}</tr>`;
    });

    const scheduleHtml = `
      <div class="schedule-section" data-config="${configData}" style="font-family:'Pretendard',sans-serif; margin-top:20px; page-break-inside:avoid; position:relative;">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; border-bottom:2px solid #bbf7d0; padding-bottom:8px; margin-bottom:12px;">
            <h3 style="margin:0; color:#16a34a; font-size:1.15rem;">5. ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule) <span style="font-size:0.8em; color:#64748b; font-weight:normal;">- ${projectName}</span></h3>
            <button type="button" onclick="editEmbeddedSchedule(this)" style="background:#f0fdf4; border:1px solid #bbf7d0; color:#16a34a; border-radius:4px; padding:2px 8px; font-size:0.8rem; cursor:pointer; font-weight:600;">âœï¸ ìˆ˜ì •</button>
        </div>
        <table style="width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid #cbd5e1;">
            <thead><tr><th rowspan="2" style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; width:100px;">êµ¬ë¶„</th><th rowspan="2" style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; width:220px;">Task</th>${gridHtml}</tr><tr>${subHeaderHtml}</tr></thead>
            <tbody>${tbodyHtml}</tbody>
        </table>
        <div style="margin-top:8px; font-size:0.8rem; color:#94a3b8; text-align:right;">* ê° ì¹¸ì€ í•´ë‹¹ ì›”ì˜ ì£¼ì°¨(Week)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</div>
      </div><br/>
    `;

    if (CURRENT_EDITING_SCHEDULE_EL) {
        $(CURRENT_EDITING_SCHEDULE_EL).replaceWith(scheduleHtml);
        CURRENT_EDITING_SCHEDULE_EL = null;
    } 
    else {
        const currentCode = $('#doc-content').summernote('code');
        if (currentCode.includes('id="schedule-placeholder"')) {
            const parser = new DOMParser(); const doc = parser.parseFromString(currentCode, 'text/html');
            const placeholder = doc.getElementById('schedule-placeholder');
            if (placeholder) {
                const tempDiv = doc.createElement('div'); tempDiv.innerHTML = scheduleHtml; placeholder.replaceWith(tempDiv);
                $('#doc-content').summernote('code', doc.body.innerHTML);
            } else $('#doc-content').summernote('pasteHTML', scheduleHtml);
        } else $('#doc-content').summernote('pasteHTML', scheduleHtml);
    }
    
    closeScheduleMaker();
  }

  function generateProposalTemplate() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
    const htmlTemplate = `<div style="font-family:'Pretendard','Malgun Gothic',sans-serif; max-width:900px; margin:0 auto; color:#1e293b;"><h2 style="text-align:center; color:#ea580c; margin-bottom:12px; font-size:1.8rem; letter-spacing:-0.5px;">[ê¸°íšì„œ] ${document.getElementById('sch-project-name').value || "ìƒˆë¡œìš´ í”„ë¡œì íŠ¸"}</h2><div style="text-align:right; margin-bottom:16px; font-size:0.9rem; color:#64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: OOO</div><table style="width:100%; border-collapse:collapse; table-layout:fixed; border:2px solid #cbd5e1;"><tr><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">1. ê¸°íš ë°°ê²½ ë° ëª©ì  (Why)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>ë°°ê²½:</b> ì™œ ì´ ê¸°íšì„ í•˜ê²Œ ë˜ì—ˆëŠ”ê°€?</li><li><b>ëª©ì :</b> ì´ ê¸°íšì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œëŠ”?</li></ul></td><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì  (What)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>í˜„ì¬ ìƒí™©:</b> í˜„ì¬ ì—…ë¬´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìƒíƒœëŠ” ì–´ë– í•œê°€?</li><li><b>ë¬¸ì œì :</b> í•´ê²°í•´ì•¼ í•  ê°€ì¥ í° ë³‘ëª©ì´ë‚˜ ì›ì¸ì€?</li></ul></td></tr><tr><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ (How)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.6;"><li><b>í•µì‹¬ ì†”ë£¨ì…˜:</b> ë¬¸ì œë¥¼ ì–´ë–»ê²Œ íƒ€ê°œí•  ê²ƒì¸ê°€?</li><li><b>ì‹¤í–‰ ì „ëµ:</b> íƒ€ ë¶€ì„œ í˜‘ì—…, ë¦¬ìŠ¤í¬ ëŒ€ë¹„ì±… ë“± ìƒì„¸ ì „ëµ</li></ul></td><td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;"><h3 style="margin:0 0 12px 0; color:#ea580c; font-size:1.15rem; border-bottom:2px solid #fed7aa; padding-bottom:8px;">4. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚° (ROI)</h3><ul style="padding-left:20px; margin:0; font-size:1rem; color:#333; line-height:1.8;"><li><b>ì •ëŸ‰ì  íš¨ê³¼:</b> ë§¤ì¶œ X% ì¦ëŒ€, ë¦¬ë“œíƒ€ì„ Yì‹œê°„ ë‹¨ì¶• ë“±</li><li><b>ì†Œìš” ì˜ˆì‚°:</b> íˆ¬ì…ë˜ì–´ì•¼ í•  ì¸ë ¥ ë° ì˜ˆì‚°</li></ul></td></tr></table><div id="schedule-placeholder" style="margin-top:30px; padding:40px; border:2px dashed #e2e8f0; border-radius:12px; text-align:center; color:#94a3b8; background:#f8fafc;"><p style="font-size:1.1rem; font-weight:bold; margin-bottom:8px;">ğŸ“… ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule)</p><p style="font-size:0.9rem;">ìƒë‹¨ì˜ [ğŸ“… ì¼ì •í‘œ ë„£ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ê³³ì— ë¡œë“œë§µì„ ì±„ì›Œì£¼ì„¸ìš”.</p></div></div>`;
    openDocModal(null, "[ê¸°íšì„œ] ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ê¸°íš", htmlTemplate, 'ê¸°íšì„œ');
  }

  // âœ… [ìµœì¢… ìˆ˜ì •] ì§„ì²™ë¥  íƒ€ì„ë¨¸ì‹  í•¨ìˆ˜ (ë¡œê·¸ ê²€ìƒ‰ ì¡°ê±´ ëŒ€í­ ì™„í™”)
  function getReportGoalProgress(goalId, isBigGoal, refDateObj) {
      let tasks = [];
      if (isBigGoal) {
          const midGoalIds = g_goals.filter(m => m['ìƒìœ„ID'] === goalId).map(m => m.ID);
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
      } else {
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === goalId);
      }
      
      if (tasks.length === 0) return 0;

      // ê¸°ì¤€ì¼ (í•´ë‹¹ì¼ì˜ 23:59:59)
      const targetDate = refDateObj ? new Date(refDateObj) : new Date();
      targetDate.setHours(23, 59, 59, 999);

      const today = new Date(); today.setHours(0,0,0,0);

      const doneCount = tasks.filter(t => {
          // 1. í˜„ì¬ ë¯¸ì™„ë£Œë¼ë©´ -> ê³¼ê±°ì—ë„ ë¯¸ì™„ë£Œ (ë‹¨ìˆœí™”)
          if (t['ìƒíƒœ'] !== 'ì™„ë£Œ') return false;

          // 2. ê¸°ì¤€ì¼ì´ ì˜¤ëŠ˜/ë¯¸ë˜ë¼ë©´ -> í˜„ì¬ ìƒíƒœ ì¸ì •
          if (targetDate >= today) return true;

          // 3. [ìš°ì„ ìˆœìœ„ 1] ì™„ë£Œì¼ ë°ì´í„° í™•ì¸ (DBì— ì™„ë£Œì¼ì´ ìˆë‹¤ë©´ ê·¸ê±¸ ìµœìš°ì„ ìœ¼ë¡œ)
          if (t['ì™„ë£Œì¼']) {
              return new Date(t['ì™„ë£Œì¼']) <= targetDate;
          }

          // 4. [ìš°ì„ ìˆœìœ„ 2] ë¡œê·¸ ê´‘ë²”ìœ„ ê²€ìƒ‰ (ì¡°ê±´ ì™„í™”)
          // - í•´ë‹¹ íƒœìŠ¤í¬ì™€ ê´€ë ¨ëœ 'ì™„ë£Œ' í”ì ì„ ì°¾ìŒ
          // - ìƒíƒœ ë³€ê²½ ë¿ë§Œ ì•„ë‹ˆë¼ íƒœê·¸, ì œëª© ë“±ì—ì„œ 'ì™„ë£Œ' ì‹œê·¸ë„ì„ ëª¨ë‘ ì°¾ìŒ
          const doneLog = g_logs.find(l => {
            // 0) ê´€ë ¨ ID í‚¤ í˜¸í™˜ (ì„œë²„/ë²„ì „ ì°¨ì´ ëŒ€ë¹„)
            const relId =
              l['ê´€ë ¨_ëª©í‘œID'] ||
              l['relatedId'] ||
              l['ê´€ë ¨ID'] ||
              l['ê´€ë ¨_ì‘ì—…ID'] ||
              "";
          
            if (relId !== t.ID) return false;
          
            // 1) ë‚ ì§œ íŒŒì‹±/ë¹„êµ ì•ˆì •í™”
            const raw = l['ë‚ ì§œ'] || l['date'];
            if (!raw) return false;
            const lDate = new Date(raw);
            if (isNaN(lDate.getTime())) return false;
            if (lDate > targetDate) return false;
          
            // 2) ì™„ë£Œ ì‹œê·¸ë„ í™•ì¥ (todo_manage ìë™ë¡œê·¸ íƒœê·¸ Done ì»¤ë²„)
            const status = (l['ìƒíƒœ'] || "").toString();
            const tag = (l['íƒœê·¸'] || l['tags'] || "").toString();
            const title = (l['ì œëª©'] || l['title'] || "").toString();
          
            return (
              status === 'ì™„ë£Œ' || status === 'Done' ||
              tag === 'Done' || tag === 'Publish' || tag === 'ì™„ë£Œ' || tag === 'ë°°í¬' ||
              title.includes('ì™„ë£Œ') || title.includes('ë‹¬ì„±') || title.includes('ë°°í¬') ||
              title.includes('í•´ê²°') || title.includes('Finish') || title.includes('ì„±ê³µ') || title.includes('ì‘ì—… ë')
            );
          });


          // ë¡œê·¸ê°€ í•˜ë‚˜ë¼ë„ ë°œê²¬ë˜ë©´ ì¸ì •
          return !!doneLog; 
      }).length;

      return Math.round((doneCount / tasks.length) * 100);
  }

  function getReportDday(dateStr, baseDateObj) {
      if (!dateStr) return `<span style="color:#94a3b8; font-size:0.85em; margin-left:6px; font-weight:normal;">(ë§ˆê° ë¯¸ì •)</span>`;
      const targetDate = new Date(dateStr); targetDate.setHours(0,0,0,0);
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date(); refDate.setHours(0,0,0,0);
      const diffDays = Math.ceil((targetDate - refDate) / (1000 * 60 * 60 * 24));
      if (diffDays > 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-${diffDays}</span>`;
      if (diffDays === 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-Day</span>`;
      return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D+${Math.abs(diffDays)} ì§€ì—°</span>`;
  }

  function getSmartLogTitle(log) {
      let displayTitle = log['ì œëª©'];
      if (!displayTitle || displayTitle.trim() === "") {
          const content = log['ë‚´ìš©'] || "";
          displayTitle = content.replace(/\n/g, " ").trim().substring(0, 30);
          if (content.length > 30) displayTitle += "...";
      }
      if (!displayTitle || displayTitle.trim() === "") displayTitle = "(ë‚´ìš© ì—†ìŒ)";
      return displayTitle;
  }

  function analyzeProjectRisks(activeBigGoals, baseDateObj) {
      let issues = [];
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date(); refDate.setHours(0,0,0,0);
      activeBigGoals.forEach(bg => {
          const percent = getReportGoalProgress(bg.ID, true, refDate);
          let diffDays = 999;
          if (bg['ë§ˆê°ì¼']) {
             const target = new Date(bg['ë§ˆê°ì¼']); target.setHours(0,0,0,0);
             diffDays = Math.ceil((target - refDate) / (1000 * 60 * 60 * 24));
          }
          if (diffDays < 0 && percent < 100) issues.push(`ğŸš¨ <b>[ì§€ì—°]</b> '${bg['ì œëª©']}' í”„ë¡œì íŠ¸ì˜ ì¼ì •ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. (ì§„ì²™ë¥  ${percent}%)`);
          else if (diffDays >= 0 && diffDays <= 3 && percent < 50) issues.push(`âš ï¸ <b>[ë¦¬ìŠ¤í¬]</b> '${bg['ì œëª©']}' ëª©í‘œ ë‹¬ì„±ì´ ë¶ˆíˆ¬ëª…í•©ë‹ˆë‹¤. ì§‘ì¤‘ì ì¸ ë¦¬ì†ŒìŠ¤ íˆ¬ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
      });
      return issues;
  }
  
  let velocityHtml = `<ul style="padding-left: 20px; margin: 0; color: #333; line-height: 1.6;">`;
  
  // ğŸ“ Shipped ëª©ë¡
  if (publishLogs.length > 0) {
    velocityHtml += `
      <li style="margin-bottom:10px; color:#2563eb; font-weight:bold; list-style:none;">
        ğŸ“ <b>[Shipped]</b> ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ${publishLogs.length}ê±´ ë°œí–‰
        <div style="margin-top:6px; padding-left:14px; color:#1e40af; font-weight:600;">
          ${publishLogs.slice(0,5).map(p => `- ${getSmartLogTitle(p)}`).join('<br/>')}
          ${publishLogs.length > 5 ? `<br/>...ì™¸ ${publishLogs.length-5}ê±´` : ``}
        </div>
      </li>`;
  }
  
  // ğŸ’¡ ì•„ì´ë””ì–´ ìƒì„± ëª©ë¡ (ê¸°ì¤€ì¼)
  if (ideaCreateLogs.length > 0) {
    velocityHtml += `
      <li style="margin-bottom:10px; color:#ea580c; font-weight:bold; list-style:none;">
        ğŸ’¡ <b>[Ideas Created]</b> ${ideaCreateLogs.length}ê±´ ìƒì„±
        <div style="margin-top:6px; padding-left:14px; color:#9a3412; font-weight:600;">
          ${ideaCreateLogs.slice(0,5).map(i => `- ${getSmartLogTitle(i)}`).join('<br/>')}
          ${ideaCreateLogs.length > 5 ? `<br/>...ì™¸ ${ideaCreateLogs.length-5}ê±´` : ``}
        </div>
      </li>`;
  }
  
  // ë‚˜ë¨¸ì§€ done ë¡œê·¸
  doneLogs.slice(0, 7).forEach(l => {
    const title = getSmartLogTitle(l);
    velocityHtml += `<li style="margin-bottom:4px;">${title}</li>`;
  });
  if (doneLogs.length > 7) velocityHtml += `<li style="color:#64748b; list-style:none;">...ì™¸ ${doneLogs.length - 7}ê±´ì˜ ì„¸ë¶€ ì‘ì—… ì™„ë£Œ</li>`;
  
  if (doneLogs.length === 0 && publishLogs.length === 0 && ideaCreateLogs.length === 0) {
    velocityHtml += `<li style="color:#94a3b8;">ê¸°ì¤€ì¼ ê¸°ë¡ëœ ì„±ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
  }
  velocityHtml += `</ul>`;

  
  (function showVersion() {
    const el = document.getElementById("sysVersion"); if(!el) return;
    const d = new Date(document.lastModified);
    const pad = (n) => String(n).padStart(2, '0');
    el.textContent = `Version: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} [Ver 2.1 - Fix]`;
  })();
</script>
</body>
</html>
