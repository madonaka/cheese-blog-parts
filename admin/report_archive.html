<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¬¸ì„œ ì•„ì¹´ì´ë¸Œ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
    
    // ğŸš¨ í•„ìˆ˜ ì„¤ì •: ìƒì„±ëœ ë¬¸ì„œ(íŒŒì¼)ê°€ ì €ì¥ë  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID (ê¼­ ë³¸ì¸ì˜ í´ë” IDë¡œ ë³€ê²½í•˜ì„¸ìš”!)
    const ARCHIVE_FOLDER_ID = "1MpTCfw8B1Y-77QFr4k5SCPfVQgso8fKi"; 
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* --- ì•„ì¹´ì´ë¸Œ ì „ìš© ë””ìì¸ --- */
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; }
    
    .archive-header {
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0;
      flex-wrap: wrap; gap: 16px;
    }
    .archive-title h2 { margin: 0 0 8px 0; font-size: 1.8rem; color: #1e293b; font-weight: 800; }
    .archive-title p { margin: 0; color: #64748b; font-size: 0.95rem; }
    
    /* ì‹œìŠ¤í…œ ë²„ì „ í‘œì‹œ ë±ƒì§€ */
    .sys-version-large {
      font-size: 0.95rem;
      font-weight: 800;
      color: #ef4444; 
      background: #fee2e2;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      margin-top: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .report-generator-group {
      display: flex; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .btn-gen {
      background: #fff; color: #3b82f6; border: 1px solid #bfdbfe; font-weight: 700; padding: 8px 16px;
      border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .btn-gen:hover { background: #eff6ff; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(59,130,246,0.1); }
    .btn-new { background: #3b82f6; color: white; border: none; }
    .btn-new:hover { background: #2563eb; }

    /* ë¬¸ì„œ ê·¸ë¦¬ë“œ ë·° */
    .doc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; position: relative; cursor: pointer;
      display: flex; flex-direction: column; height: 240px;
    }
    .doc-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: #cbd5e1; }
    .doc-type-badge {
      position: absolute; top: 20px; right: 20px; background: #f1f5f9; color: #475569; font-size: 0.75rem;
      padding: 4px 10px; border-radius: 6px; font-weight: 700;
    }
    .doc-card-title { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin: 0 0 10px 0; padding-right: 60px; line-height: 1.4; }
    .doc-card-date { font-size: 0.85rem; color: #94a3b8; margin-bottom: 12px; font-weight: 500; }
    
    .doc-card-actions { margin-top: auto; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px dashed #e2e8f0; padding-top: 16px; }
    
    /* ì—ë””í„° ëª¨ë‹¬ */
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box.large-modal { background: #fff; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 900px; max-width: 95vw; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    
    .modal-header-custom { flex-shrink: 0; padding: 20px 32px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .modal-title-custom { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
    .modal-body-custom { flex: 1; overflow-y: auto; padding: 32px; background: #f8fafc; }
    .modal-footer-custom { flex-shrink: 0; padding: 20px 32px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; }
    
    .input-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 700; color: #475569; }
    .styled-input { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; font-size: 1rem; transition: 0.2s; }
    .styled-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    .note-editor.note-frame { border-color: #e2e8f0; border-radius: 12px; overflow: hidden; background: #fff; }

    /* ì•„ì´ë””ì–´ ì„ íƒ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .idea-select-item {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;
      background: #fff; cursor: pointer; transition: 0.2s;
    }
    .idea-select-item:hover { border-color: #ea580c; background: #fff7ed; }
    .idea-select-item input[type="checkbox"] { margin-top: 4px; transform: scale(1.2); cursor: pointer; }
    .idea-select-content { flex: 1; }
    .idea-select-title { font-weight: 700; color: #1e293b; font-size: 0.95rem; margin-bottom: 4px; }
    .idea-select-desc { font-size: 0.85rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    /* ğŸ–¨ï¸ ì¸ì‡„ ë° PDF ì €ì¥ ìµœì í™” ì„¤ì • */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      .modal-box.large-modal { position: absolute; top: 0; left: 0; width: 100%; height: auto; box-shadow: none; }
    }
    
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
       <div class="archive-header">
          <div class="archive-title">
            <h2>ğŸ“‚ ë³´ê³ ì„œ & ê¸°íšì„œ ì•„ì¹´ì´ë¸Œ</h2>
            <p>ë‚´ìš©ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì•ˆì „í•˜ê²Œ, ê´€ë¦¬ëŠ” ê°€ë³ê²Œ!</p>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
          </div>
          <div class="report-generator-group" style="align-items: center;">
            <div style="display: flex; align-items: center; gap: 6px; margin-right: 8px; border-right: 2px solid #e2e8f0; padding-right: 14px;">
              <span style="font-size: 0.9rem; font-weight: 700; color: #475569;">ğŸ“… ê¸°ì¤€ì¼:</span>
              <input type="date" id="report-base-date" class="styled-input" style="padding: 6px 10px; width: 140px; font-weight: 600; color: #1e293b;">
            </div>
            
            <button class="btn-gen" onclick="generateAutoReport('daily')">ğŸ“ ì¼ì¼ ë³´ê³ ì„œ</button>
            <button class="btn-gen" onclick="generateAutoReport('weekly')">ğŸ“Š ì£¼ê°„ ë³´ê³ ì„œ</button>
            <button class="btn-gen" onclick="generateAutoReport('monthly')">ğŸ“… ì›”ê°„ ë³´ê³ ì„œ</button>
            <div style="width:1px; background:#e2e8f0; margin: 0 4px;"></div>
            <button class="btn-gen" style="background:#f0fdf4; color:#16a34a; border-color:#bbf7d0;" onclick="generateProposalTemplate()">ğŸ’¡ 1-Page ê¸°íšì„œ</button>
            <button class="btn-gen" style="background:#fff7ed; color:#ea580c; border-color:#fed7aa;" onclick="openIdeaSelector()">âœ¨ ì•„ì´ë””ì–´ë¡œ ê¸°íš</button>
            <button class="btn-gen" style="background:#fdf2f8; color:#db2777; border-color:#fbcfe8;" onclick="openScheduleMaker()">ğŸ“… ì¼ì •í‘œ ë§Œë“¤ê¸°</button>
            <button class="btn-gen btn-new" onclick="openDocModal()">+ ë¹ˆ ë¬¸ì„œ</button>
          </div>
        </div>

        <div class="doc-grid" id="doc-grid">
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 0; color: #94a3b8;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>

      </div>
    </section>
  </main>
</div>

<div id="doc-modal" class="custom-modal">
  <div class="modal-box large-modal">
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="doc-modal-title">ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
    </div>
    
    <form id="doc-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin:0;">
      <div class="modal-body-custom">
        <input type="hidden" id="doc-id" value="">
        <input type="hidden" id="doc-drive-id" value="">
        
        <div style="display:flex; gap:16px; margin-bottom:20px;">
          <div style="flex: 1;">
            <label class="input-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="doc-title" class="styled-input" placeholder="ë³´ê³ ì„œ ë˜ëŠ” ê¸°íšì„œ ì œëª©" required style="font-size:1.1rem; font-weight:700;">
          </div>
          <div style="width: 160px;">
            <label class="input-label">ë¬¸ì„œ ìœ í˜•</label>
            <select id="doc-type" class="styled-input">
              <option value="ë³´ê³ ì„œ">ğŸ“Š ë³´ê³ ì„œ</option>
              <option value="ê¸°íšì„œ">ğŸ’¡ ê¸°íšì„œ</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column;">
          <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="doc-content" required></textarea>
        </div>
      </div>

        
    <div id="idea-select-modal" class="custom-modal">
      <div class="modal-box" style="width: 500px; max-width: 90vw; background: #fff; border-radius: 16px; display:flex; flex-direction:column; max-height:80vh;">
        <div class="modal-header-custom" style="background:#fff7ed; border-bottom:1px solid #fed7aa;">
          <span class="modal-title-custom" style="color:#c2410c;">âœ¨ êµ¬ì²´í™”í•  ì•„ì´ë””ì–´ ì„ íƒ</span>
        </div>
        
        <div class="modal-body-custom" style="padding: 20px; overflow-y: auto;">
          <p style="margin-top:0; color:#64748b; font-size:0.9rem; margin-bottom:12px;">
            ë“±ë¡ëœ ì•„ì´ë””ì–´ ì¤‘ ê¸°íšì„œë¡œ ë°œì „ì‹œí‚¬ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.<br/>
            (ì„ íƒí•œ ë‚´ìš©ì€ ê¸°íšì„œì˜ 'í•´ê²° ë°©ì•ˆ'ì— ìë™ ì…ë ¥ë©ë‹ˆë‹¤.)
          </p>
          <div id="idea-list-container" style="display:flex; flex-direction:column; gap:8px;">
            </div>
        </div>
        
        <div class="modal-footer-custom" style="background:#fff; border-top:1px solid #f1f5f9;">
          <button type="button" class="btn" onclick="document.getElementById('idea-select-modal').classList.remove('open')" style="padding:10px 20px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; font-weight:600; cursor:pointer;">ì·¨ì†Œ</button>
          <button type="button" class="btn" onclick="confirmIdeaSelection()" style="padding:10px 20px; border-radius:8px; border:none; background:#ea580c; color:#fff; font-weight:700; cursor:pointer;">ğŸš€ ê¸°íšì„œ ìƒì„±</button>
        </div>
      </div>
    </div>

    <div id="schedule-maker-modal" class="custom-modal">
      <div class="modal-box" style="width: 800px; max-width: 95vw; background: #fff; border-radius: 16px;">
        <div class="modal-header-custom" style="background:#fdf2f8; border-bottom:1px solid #fbcfe8;">
          <span class="modal-title-custom" style="color:#be185d;">ğŸ“… í”„ë¡œì íŠ¸ ì¼ì •í‘œ ìƒì„±ê¸°</span>
          <button type="button" class="btn" onclick="closeScheduleMaker()" style="background:transparent; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
        </div>
        
        <div class="modal-body-custom" style="padding: 20px; overflow-y: auto; max-height: 70vh;">
          <div style="display:flex; gap:10px; margin-bottom:16px; background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
            <div style="flex:1;">
              <label style="display:block; font-size:0.8rem; color:#64748b; margin-bottom:4px;">í”„ë¡œì íŠ¸ ì‹œì‘ì¼ (ì²« ì¹¸ ë‚ ì§œ)</label>
              <input type="date" id="sch-start-date" class="form-input" style="width:100%;">
            </div>
            <div style="flex:2;">
              <label style="display:block; font-size:0.8rem; color:#64748b; margin-bottom:4px;">í”„ë¡œì íŠ¸ëª…</label>
              <input type="text" id="sch-project-name" class="form-input" value="ë¸”ë¡œê·¸ ì´ê´€ í”„ë¡œì íŠ¸" style="width:100%;">
            </div>
            <div style="flex:0 0 auto; display:flex; align-items:flex-end;">
                <button type="button" class="btn" onclick="loadSchedulePreset()" style="padding:8px 12px; background:#fff; border:1px solid #cbd5e1; font-size:0.85rem; border-radius:6px; cursor:pointer;">ğŸ”„ ì˜ˆì œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
          </div>
    
          <table style="width:100%; border-collapse: collapse; font-size:0.9rem;">
            <thead>
                <tr style="background:#f1f5f9; color:#475569;">
                    <th style="padding:8px; width:120px;">êµ¬ë¶„ (ë‹¨ê³„)</th>
                    <th style="padding:8px;">ì‘ì—… ë‚´ìš© (Task)</th>
                    <th style="padding:8px; width:80px;">ì‹œì‘ì¹¸<br>(0~5)</th>
                    <th style="padding:8px; width:80px;">ê¸°ê°„<br>(ì¹¸ìˆ˜)</th>
                    <th style="padding:8px; width:50px;">ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody id="sch-input-list">
                </tbody>
          </table>
          
          <button type="button" onclick="addScheduleRow()" style="width:100%; margin-top:10px; padding:10px; border:2px dashed #cbd5e1; background:#fff; color:#64748b; font-weight:bold; border-radius:8px; cursor:pointer;">+ ì‘ì—… í–‰ ì¶”ê°€í•˜ê¸°</button>
        </div>
        
        <div class="modal-footer-custom">
          <button type="button" class="btn" onclick="closeScheduleMaker()" style="padding:10px 20px; border-radius:8px; background:#f1f5f9; color:#64748b; border:none; cursor:pointer;">ì·¨ì†Œ</button>
          <button type="button" class="btn" onclick="insertCustomSchedule()" style="padding:10px 20px; border-radius:8px; background:#db2777; color:#fff; border:none; font-weight:700; cursor:pointer;">âœ¨ ì—ë””í„°ì— ì‚½ì…</button>
        </div>
      </div>
    </div>
      
      <div class="modal-footer-custom">
        <button type="button" class="btn" style="padding:12px 24px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; color:#64748b; font-weight:700; cursor:pointer;" onclick="closeModal('doc-modal')">ì·¨ì†Œ</button>
        <button type="submit" class="btn" id="btn-save-doc" style="padding:12px 24px; border-radius:12px; border:none; background:#3b82f6; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(59,130,246,0.3);">ğŸ’¾ ë“œë¼ì´ë¸Œì— ì €ì¥</button>
        <button type="button" class="btn" style="padding:12px 24px; border-radius:12px; border:1px solid #3b82f6; background:#fff; color:#3b82f6; font-weight:700; cursor:pointer;" onclick="printReport()">ğŸ–¨ï¸ PDF ì €ì¥</button>
        <button type="button" class="btn" style="padding:12px 24px; border-radius:12px; border:1px solid #10b981; background:#fff; color:#10b981; font-weight:700; cursor:pointer;" onclick="saveAsImage()">ğŸ–¼ï¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<script>
// âœ… ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„±í™” ì¸ì‹ìš© ë³€ìˆ˜
  window.CHEESE_ADMIN_ACTIVE_PAGE = "report_archive"; 
  
  let g_docs = [];
  let g_logs = [];
  let g_goals = [];
  let g_tasks = [];

  document.addEventListener('DOMContentLoaded', () => {
    // ì¸ë¨¸ë…¸íŠ¸ ì—ë””í„° ì´ˆê¸°í™”
    $('#doc-content').summernote({
      height: 600, lang: 'ko-KR',
      toolbar: [
        ['style', ['style']], ['font', ['bold', 'underline', 'clear']],
        ['color', ['color']], ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']], ['insert', ['link']], ['view', ['codeview', 'fullscreen']]
      ]
    });
    
    // ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ 'ì˜¤ëŠ˜'ë¡œ ìë™ ì„¸íŒ…
    const todayStr = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    document.getElementById('report-base-date').value = todayStr;

    loadAllData();
  });

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_logs = json.logs || []; g_goals = json.goals || []; g_tasks = json.tasks || [];
        g_docs = g_tasks.filter(t => t['ìœ í˜•'] === 'ë³´ê³ ì„œ' || t['ìœ í˜•'] === 'ê¸°íšì„œ');
        g_docs.sort((a, b) => b.ID.localeCompare(a.ID)); 
        renderDocs();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // ==========================================
  // 2. ì•„ì¹´ì´ë¸Œ ë Œë”ë§
  // ==========================================
  function renderDocs() {
    const root = document.getElementById('doc-grid');
    root.innerHTML = "";
    
    if(g_docs.length === 0) {
        root.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 60px; color:#94a3b8; background:#f8fafc; border-radius:16px; border:2px dashed #cbd5e1; font-weight:600;">ë³´ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>`;
        return;
    }

    g_docs.forEach(doc => {
      const card = document.createElement('div'); card.className = "doc-card";
      const isReport = doc['ìœ í˜•'] === 'ë³´ê³ ì„œ';
      const badgeColor = isReport ? '#eff6ff' : '#f0fdf4';
      const textColor = isReport ? '#2563eb' : '#16a34a';
      const rawDate = doc['ê¸°í•œ'] ? doc['ê¸°í•œ'].split('T')[0] : 'ë‚ ì§œ ì—†ìŒ';

      let previewHtml = "";
      if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
          previewHtml = `
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
              <div style="background:#f8fafc; color:#3b82f6; padding:12px 20px; border-radius:12px; font-weight:800; font-size:0.95rem; border:1px solid #e2e8f0;">
                â˜ï¸ ë“œë¼ì´ë¸Œ ì—°ë™ íŒŒì¼
              </div>
            </div>`;
      } else {
          previewHtml = `<div style="flex:1; color:#ef4444; font-size:0.85rem; padding:10px;">(êµ¬í˜• ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤)</div>`;
      }

      card.innerHTML = `
        <div class="doc-type-badge" style="background:${badgeColor}; color:${textColor};">${doc['ìœ í˜•']}</div>
        <h3 class="doc-card-title">${doc['ì œëª©'] || '(ì œëª© ì—†ìŒ)'}</h3>
        <div class="doc-card-date">ğŸ—“ ìµœì¢… ìˆ˜ì •: ${rawDate}</div>
        ${previewHtml}
        <div class="doc-card-actions">
           <button class="btn" style="background:#f1f5f9; color:#475569; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="openDocModal('${doc.ID}'); event.stopPropagation();">ğŸ“ ì—´ê¸°</button>
           <button class="btn" style="background:#fff1f2; color:#ef4444; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="deleteDoc('${doc.ID}'); event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      `;
      card.onclick = () => openDocModal(doc.ID);
      root.appendChild(card);
    });
  }

  // ==========================================
  // 3. ëª¨ë‹¬ ì œì–´
  // ==========================================
  async function openDocModal(docId = null, defaultTitle = "", defaultHtml = "", defaultType = "ë³´ê³ ì„œ") {
    const modal = document.getElementById('doc-modal');
    modal.classList.add('open');
    document.getElementById('doc-form').reset();
    document.getElementById('doc-drive-id').value = ""; 
    $('#doc-content').summernote('code', '');

    if (docId) {
        const doc = g_docs.find(d => d.ID === docId);
        if (doc) {
            document.getElementById('doc-modal-title').textContent = "ë¬¸ì„œ í™•ì¸ ë° ìˆ˜ì •";
            document.getElementById('doc-id').value = doc.ID;
            document.getElementById('doc-title').value = doc['ì œëª©'];
            document.getElementById('doc-type').value = doc['ìœ í˜•'];
            
            if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
                const fileId = doc['ìƒì„¸ë‚´ìš©'].split("DRIVE:")[1];
                document.getElementById('doc-drive-id').value = fileId;
                
                if(typeof showAdminLoading==='function') showAdminLoading("êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì›ë³¸ ë‹¤ìš´ë¡œë“œ ì¤‘...");
                try {
                    const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "getReportContent", fileId: fileId }) });
                    const json = await res.json();
                    if(json.result === "success") $('#doc-content').summernote('code', json.content);
                    else throw new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨");
                } catch(e) {
                    alert("ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                } finally {
                    if(typeof hideAdminLoading==='function') hideAdminLoading();
                }
            } else {
                $('#doc-content').summernote('code', doc['ìƒì„¸ë‚´ìš©'] || "");
            }
        }
    } else {
        document.getElementById('doc-modal-title').textContent = "ìƒˆ ë¬¸ì„œ ì‘ì„±";
        document.getElementById('doc-id').value = "";
        document.getElementById('doc-title').value = defaultTitle;
        document.getElementById('doc-type').value = defaultType;
        if(defaultHtml) $('#doc-content').summernote('code', defaultHtml);
    }
  }

  // ==========================================
  // 4. ì €ì¥ ë¡œì§
  // ==========================================
  document.getElementById('doc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save-doc');
    const originalText = btn.textContent;
    btn.textContent = "ì²˜ë¦¬ ì¤‘..."; btn.disabled = true;

    try {
        const docId = document.getElementById('doc-id').value;
        const title = document.getElementById('doc-title').value;
        const type = document.getElementById('doc-type').value;
        const contentHtml = $('#doc-content').summernote('code');
        const driveId = document.getElementById('doc-drive-id').value;
        const now = new Date().toISOString().split('T')[0];

        if(typeof showAdminLoading==='function') showAdminLoading("êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì•ˆì „í•˜ê²Œ ë³´ê´€ ì¤‘...");
        let savedFileId = driveId;
        
        const drivePayload = {
            mode: "uploadReportContent",
            folderId: ARCHIVE_FOLDER_ID,
            fileId: driveId,
            title: title,
            content: contentHtml
        };
        const driveRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(drivePayload) });
        const driveJson = await driveRes.json();
        
        if (driveJson.result === "success") {
            savedFileId = driveJson.fileId;
        } else {
            throw new Error("ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì‹¤íŒ¨");
        }

        if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„°ë² ì´ìŠ¤ ë©”íƒ€ë°ì´í„° ê¸°ë¡ ì¤‘...");
        const dbPayload = {
            mode: docId ? "editItem" : "addItem",
            id: docId,
            type: type,
            title: title,
            detail: "DRIVE:" + savedFileId,
            priority: "ë³´í†µ",
            dueDate: now, 
            connectedId: "",
            color: ""
        };
        
        const dbRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(dbPayload) });
        const dbJson = await dbRes.json();
        
        if(dbJson.result === "success") {
            closeModal('doc-modal');
            await loadAllData(); 
        } else {
            alert("DB ì €ì¥ ì‹¤íŒ¨: " + dbJson.msg);
        }
    } catch(err) {
        console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    } finally {
        btn.textContent = originalText; btn.disabled = false;
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

  // ==========================================
  // 5. ë³´ì¡° í•¨ìˆ˜ (D-Day(ê¸°ì¤€ì¼ ë°˜ì˜), ì§„ì²™ë¥ , ìŠ¤ë§ˆíŠ¸ì œëª©)
  // ==========================================
  
  // ğŸš€ [ìˆ˜ì •] ê¸°ì¤€ ë‚ ì§œ(baseDate)ë¥¼ ë°›ì•„ì„œ D-Dayë¥¼ ê³„ì‚°í•˜ë„ë¡ ë³€ê²½
  function getReportDday(dateStr, baseDateObj) {
      if (!dateStr) return `<span style="color:#94a3b8; font-size:0.85em; margin-left:6px; font-weight:normal;">(ë§ˆê° ë¯¸ì •)</span>`;
      
      const targetDate = new Date(dateStr);
      targetDate.setHours(0,0,0,0);
      
      // ê¸°ì¤€ì¼ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜, ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ ì‚¬ìš©
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date();
      refDate.setHours(0,0,0,0);
      
      const diffDays = Math.ceil((targetDate - refDate) / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-${diffDays}</span>`;
      if (diffDays === 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-Day</span>`;
      return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D+${Math.abs(diffDays)} ì§€ì—°</span>`;
  }

  function getReportGoalProgress(goalId, isBigGoal) {
      let tasks = [];
      if (isBigGoal) {
          const midGoalIds = g_goals.filter(m => m['ìƒìœ„ID'] === goalId).map(m => m.ID);
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
      } else {
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === goalId);
      }
      if (tasks.length === 0) return 0;
      const doneCount = tasks.filter(t => t['ìƒíƒœ'] === 'ì™„ë£Œ').length;
      return Math.round((doneCount / tasks.length) * 100);
  }

  function getSmartLogTitle(log) {
      let displayTitle = log['ì œëª©'];
      if (!displayTitle || displayTitle.trim() === "") {
          const content = log['ë‚´ìš©'] || "";
          displayTitle = content.replace(/\n/g, " ").trim().substring(0, 30);
          if (content.length > 30) displayTitle += "...";
      }
      if (!displayTitle || displayTitle.trim() === "") {
          displayTitle = "(ë‚´ìš© ì—†ìŒ)";
      }
      return displayTitle;
  }

  // ğŸš€ [ìˆ˜ì •] ìë™ ì§„ë‹¨ ì‹œì—ë„ ê¸°ì¤€ ë‚ ì§œ(baseDate)ë¥¼ ë°˜ì˜
  function analyzeProjectRisks(activeBigGoals, baseDateObj) {
      let issues = [];
      const refDate = baseDateObj ? new Date(baseDateObj) : new Date();
      refDate.setHours(0,0,0,0);

      activeBigGoals.forEach(bg => {
          const percent = getReportGoalProgress(bg.ID, true);
          let diffDays = 999;
          if (bg['ë§ˆê°ì¼']) {
             const target = new Date(bg['ë§ˆê°ì¼']);
             target.setHours(0,0,0,0);
             diffDays = Math.ceil((target - refDate) / (1000 * 60 * 60 * 24));
          }

          // 1. ì§€ì—° ê°ì§€ (ê¸°ì¤€ì¼ ë‹¹ì‹œì— ì§€ì—°ì´ì—ˆëŠ”ì§€)
          if (diffDays < 0 && percent < 100) {
              issues.push(`ğŸš¨ <b>[ì§€ì—°]</b> '${bg['ì œëª©']}' í”„ë¡œì íŠ¸ì˜ ì¼ì •ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. (ì§„ì²™ë¥  ${percent}%)`);
          }
          // 2. ë¦¬ìŠ¤í¬ ê°ì§€ (ê¸°ì¤€ì¼ ë‹¹ì‹œì— ë§ˆê° ì„ë°•)
          else if (diffDays >= 0 && diffDays <= 3 && percent < 50) {
              issues.push(`âš ï¸ <b>[ë¦¬ìŠ¤í¬]</b> '${bg['ì œëª©']}' ëª©í‘œ ë‹¬ì„±ì´ ë¶ˆíˆ¬ëª…í•©ë‹ˆë‹¤. ì§‘ì¤‘ì ì¸ ë¦¬ì†ŒìŠ¤ íˆ¬ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
          }
      });
      return issues;
  }

  // ==========================================
  // 6. 1 Page 4ë¶„í•  ìë™ ë³´ê³ ì„œ ìƒì„± (ìµœì¢… ì—…ê·¸ë ˆì´ë“œ)
  // ==========================================
  function generateAutoReport(rangeType) {
    const baseDateStr = document.getElementById('report-base-date').value;
    if (!baseDateStr) { alert("ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    
    // ğŸš€ ë³´ê³ ì„œ ê¸°ì¤€ ë‚ ì§œ ì„¤ì •
    const targetEndDate = new Date(baseDateStr); targetEndDate.setHours(23,59,59,999);
    let startDate = new Date(baseDateStr); startDate.setHours(0,0,0,0);
    
    let titlePrefix = "";
    if (rangeType === 'daily') {
        titlePrefix = `[ì¼ì¼ ë³´ê³ ì„œ] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ${targetEndDate.getDate()}ì¼`;
    } else if (rangeType === 'weekly') {
        const day = startDate.getDay() || 7; startDate.setDate(startDate.getDate() - day + 1);
        titlePrefix = `[ì£¼ê°„ ë³´ê³ ì„œ] ${targetEndDate.getMonth()+1}ì›” ${Math.ceil(targetEndDate.getDate()/7)}ì£¼ì°¨`;
    } else if (rangeType === 'monthly') {
        startDate.setDate(1); 
        titlePrefix = `[ì›”ê°„ ë³´ê³ ì„œ] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ê²°ì‚°`;
    }

    const targetLogs = g_logs.filter(log => {
        if (!log['ë‚ ì§œ']) return false;
        const d = new Date(log['ë‚ ì§œ']); return d >= startDate && d <= targetEndDate;
    });

    const hierarchyMap = {}; 
    let ideaLogs = [];
    let bugLogs = [];
    let postPublishCount = 0;
    let totalLogs = 0;
    let otherLogs = [];

    targetLogs.forEach(log => {
        totalLogs++;
        const isIdea = log['íƒœê·¸'] === 'ì•„ì´ë””ì–´' || (log['ì œëª©'] && log['ì œëª©'].includes('ğŸ’¡'));
        const isBug = log['íƒœê·¸'] === 'ë²„ê·¸' || (log['ì œëª©'] && log['ì œëª©'].includes('ğŸ'));
        const isPublish = log['íƒœê·¸'] === 'Publish'; 
        
        if (isIdea) { ideaLogs.push(log); return; }
        if (isBug) { bugLogs.push(log); return; }
        if (isPublish) postPublishCount++;

        const relId = log['ê´€ë ¨_ëª©í‘œID'];
        let bigGoalObj = null;
        let midGoalObj = null;

        if (relId) {
            const obj = g_tasks.find(t => t.ID === relId) || g_goals.find(g => g.ID === relId);
            if (obj) {
                if (obj['ìœ í˜•'] === 'í•  ì¼' || obj['ìœ í˜•'] === 'ë²„ê·¸') {
                    midGoalObj = g_goals.find(g => g.ID === obj['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']);
                    if (midGoalObj) bigGoalObj = g_goals.find(g => g.ID === midGoalObj['ìƒìœ„ID']);
                } else if (obj['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') {
                    midGoalObj = obj;
                    bigGoalObj = g_goals.find(g => g.ID === midGoalObj['ìƒìœ„ID']);
                } else if (obj['ìœ í˜•'] === 'í° ëª©í‘œ') {
                    bigGoalObj = obj;
                }
            }
        }

        const bigId = bigGoalObj ? bigGoalObj.ID : "OTHER";
        const bigTitle = bigGoalObj ? bigGoalObj['ì œëª©'] : "ê¸°íƒ€ (ë¯¸ë¶„ë¥˜ í”„ë¡œì íŠ¸)";
        const bigDday = bigGoalObj ? bigGoalObj['ë§ˆê°ì¼'] : null;
        const midId = midGoalObj ? midGoalObj.ID : "DIRECT";
        const midTitle = midGoalObj ? midGoalObj['ì œëª©'] : "â†³ ì§ì ‘ ìˆ˜í–‰ / ê¸°íƒ€";

        if (!hierarchyMap[bigId]) {
            hierarchyMap[bigId] = { title: bigTitle, dday: bigDday, mids: {}, activeLogs: [] };
        }
        if (!hierarchyMap[bigId].mids[midId]) {
            hierarchyMap[bigId].mids[midId] = { title: midTitle, count: 0 };
        }
        
        hierarchyMap[bigId].mids[midId].count++;
        hierarchyMap[bigId].activeLogs.push(log);
        
        if (bigId === "OTHER") otherLogs.push(log);
    });

    // =========================================
    // [Q1] ëª©í‘œ ë° í•µì‹¬ ìš”ì•½
    // =========================================
    let breakdownHtml = `<ul style="margin: 6px 0 12px 0; padding-left: 20px; font-size: 0.9em; color: #475569; list-style-type: none;">`;
    
    if (postPublishCount > 0) {
        breakdownHtml += `<li style="margin-bottom:8px; color: #2563eb; font-weight:bold; font-size: 1rem; border-bottom:1px dashed #bfdbfe; padding-bottom:4px;">
            ğŸ† [ì„±ê³¼] ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ${postPublishCount}ê±´ ë°œí–‰ ì™„ë£Œ
        </li>`;
    } else {
        breakdownHtml += `<li style="margin-bottom:8px; color: #94a3b8; font-size: 0.9rem;">
            ğŸ“‰ ê¸ˆì¼ ë°œí–‰ëœ í¬ìŠ¤íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.
        </li>`;
    }

    breakdownHtml += `<li style="margin-bottom: 8px;"><b>ì´ í™œë™ ê±´ìˆ˜:</b> ${totalLogs}ê±´</li>`;

    for (const [bigId, bigData] of Object.entries(hierarchyMap)) {
        if (bigId === "OTHER") continue; 
        // ğŸš€ D-Day ê³„ì‚° ì‹œ 'ê¸°ì¤€ ë‚ ì§œ(targetEndDate)' ì „ë‹¬
        const ddayBadge = getReportDday(bigData.dday, targetEndDate); 
        breakdownHtml += `<li style="margin-top: 6px; margin-bottom: 2px; color: #1e293b;">
            <b>${bigData.title}</b> ${ddayBadge}
        </li>`;
        for (const [midId, midData] of Object.entries(bigData.mids)) {
             breakdownHtml += `<li style="padding-left: 12px; margin-bottom: 2px; color: #64748b;">
                ${midData.title}: <b>${midData.count}</b>ê±´
             </li>`;
        }
    }
    breakdownHtml += `</ul>`;


    // =========================================
    // [Q2] í”„ë¡œì íŠ¸ í˜„í™© ë° ìˆ˜í–‰ ë‚´ì—­
    // =========================================
    let progressHtml = `<ul style="padding-left: 16px; margin: 0; font-size: 0.95rem; color: #333; line-height: 1.6;">`;
    const activeBigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && g['ìƒíƒœ'] !== 'ì™„ë£Œ');
    
    // ğŸš€ ë¦¬ìŠ¤í¬ ë¶„ì„ ì‹œì—ë„ 'ê¸°ì¤€ ë‚ ì§œ' ì „ë‹¬
    const autoRisks = analyzeProjectRisks(activeBigGoals, targetEndDate);

    if (activeBigGoals.length > 0) {
        activeBigGoals.forEach(bg => {
            const percent = getReportGoalProgress(bg.ID, true);
            // ğŸš€ D-Day ê³„ì‚° ì‹œ 'ê¸°ì¤€ ë‚ ì§œ' ì „ë‹¬
            const ddayBadge = getReportDday(bg['ë§ˆê°ì¼'], targetEndDate);
            let statusColor = percent === 100 ? "#10b981" : (percent > 0 ? "#3b82f6" : "#64748b");
            
            progressHtml += `<li style="margin-bottom: 16px; list-style: none;">
                <div style="margin-bottom: 4px;">
                    <b>${bg['ì œëª©']}</b> ${ddayBadge}
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <div style="flex:1; background:#f1f5f9; height:8px; border-radius:4px; overflow:hidden;">
                        <div style="width:${percent}%; background:${statusColor}; height:100%;"></div>
                    </div>
                    <span style="font-size:0.8em; font-weight:bold; color:${statusColor}">${percent}%</span>
                </div>`;
            
            if (hierarchyMap[bg.ID] && hierarchyMap[bg.ID].activeLogs.length > 0) {
                 progressHtml += `<ul style="padding-left: 14px; margin: 0; color: #475569; font-size: 0.9em; list-style-type: square;">`;
                 hierarchyMap[bg.ID].activeLogs.forEach(l => {
                     const displayTitle = getSmartLogTitle(l);
                     progressHtml += `<li style="margin-bottom: 3px;">${displayTitle}</li>`;
                 });
                 progressHtml += `</ul>`;
            } else {
                progressHtml += `<div style="color:#cbd5e1; font-size:0.85em; padding-left:14px;">(ê¸ˆì¼ í™œë™ ì—†ìŒ)</div>`;
            }
            progressHtml += `</li>`;
        });
    } else {
        progressHtml += `<li>ì§„í–‰ ì¤‘ì¸ í° ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
    }
    progressHtml += `</ul>`;


    // =========================================
    // [Q3] ì•„ì´ë””ì–´ / ë²„ê·¸ / ê¸°íƒ€ í™œë™
    // =========================================
    let otherHtml = `<div style="font-size: 0.95rem; padding-bottom: 10px;">`;
    if (ideaLogs.length > 0) {
        otherHtml += `<h4 style="margin: 4px 0 6px 0; color: #16a34a; font-size: 0.95rem;">ğŸ’¡ ì‹ ê·œ ì•„ì´ë””ì–´ (${ideaLogs.length}ê±´)</h4>`;
        otherHtml += `<ul style="padding-left: 16px; margin: 0; color: #475569; line-height: 1.6; list-style-type: circle;">`;
        ideaLogs.forEach(l => {
             const t = getSmartLogTitle(l);
             otherHtml += `<li style="margin-bottom: 4px;"><b>${t}</b></li>`;
        });
        otherHtml += `</ul><div style="height:12px;"></div>`;
    }
    if (bugLogs.length > 0) {
        otherHtml += `<h4 style="margin: 4px 0 6px 0; color: #ef4444; font-size: 0.95rem;">ğŸ ë²„ê·¸ ë°œê²¬ ë° ë¦¬í¬íŠ¸ (${bugLogs.length}ê±´)</h4>`;
        otherHtml += `<ul style="padding-left: 16px; margin: 0; color: #475569; line-height: 1.6; list-style-type: circle;">`;
        bugLogs.forEach(l => {
             const t = getSmartLogTitle(l);
             otherHtml += `<li style="margin-bottom: 4px;"><b>${t}</b></li>`;
        });
        otherHtml += `</ul><div style="height:12px;"></div>`;
    }
    if (otherLogs.length > 0) {
        otherHtml += `<h4 style="margin: 4px 0 6px 0; color: #64748b; font-size: 0.95rem;">ğŸ“‚ ê¸°íƒ€ ì—…ë¬´ (${otherLogs.length}ê±´)</h4>`;
        otherHtml += `<ul style="padding-left: 16px; margin: 0; color: #94a3b8; line-height: 1.6; list-style-type: circle;">`;
        otherLogs.forEach(l => {
             const t = getSmartLogTitle(l);
             otherHtml += `<li style="margin-bottom: 4px;">${t}</li>`;
        });
        otherHtml += `</ul>`;
    }
    if (ideaLogs.length === 0 && bugLogs.length === 0 && otherLogs.length === 0) {
        otherHtml += `<p style="color:#94a3b8; margin:0;">íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë³„ë„ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    }
    otherHtml += `</div>`;


    // =========================================
    // [Q4] ìë™ ê°œì„ ì  ì œì•ˆ (Auto Insight)
    // =========================================
    let improveHtml = `<ul style="padding-left: 20px; margin: 0; font-size: 0.95rem; color: #333; line-height: 1.8;">`;
    
    if (autoRisks.length > 0) {
        autoRisks.forEach(risk => {
            improveHtml += `<li style="margin-bottom:6px;">${risk}</li>`;
        });
    } else {
        improveHtml += `<li style="margin-bottom:6px; color:#10b981;">âœ… í˜„ì¬ ì£¼ìš” í”„ë¡œì íŠ¸ë“¤ì´ ìˆœì¡°ë¡­ê²Œ ì§„í–‰ë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>`;
    }
    
    if (bugLogs.length >= 3) {
        improveHtml += `<li style="margin-bottom:6px;">ğŸ <b>[í’ˆì§ˆ ì´ìŠˆ]</b> ê¸ˆì¼ ë²„ê·¸ ë¦¬í¬íŠ¸ê°€ ë‹¤ìˆ˜ ë°œìƒí–ˆìŠµë‹ˆë‹¤. QA ì‹œê°„ì„ í™•ë³´í•˜ì„¸ìš”.</li>`;
    }
    
    improveHtml += `
        <li>ë‚´ì¼ ì§„í–‰í•  í•µì‹¬ ëª©í‘œ 1: (ì§ì ‘ ì…ë ¥)</li>
        <li>í•´ê²°í•´ì•¼ í•  ì•¡ì…˜ ì•„ì´í…œ: (ì§ì ‘ ì…ë ¥)</li>
    </ul>`;


    // HTML í…œí”Œë¦¿ ì¡°ë¦½
    let htmlTemplate = `
      <div style="font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 900px; margin: 0 auto; color: #1e293b;">
        <h2 style="text-align: center; color: #0f172a; margin-bottom: 24px; font-size: 1.6rem; letter-spacing: -0.5px;">${titlePrefix}</h2>
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">1. ëª©í‘œ ë° í•µì‹¬ ìš”ì•½</h3>
              ${breakdownHtml}
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">2. í”„ë¡œì íŠ¸ í˜„í™© ë° ìˆ˜í–‰ ë‚´ì—­</h3>
              ${progressHtml}
            </td>
          </tr>
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">3. ì•„ì´ë””ì–´ / ë²„ê·¸ / ê¸°íƒ€ í™œë™</h3>
              ${otherHtml}
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">4. ê°œì„ ì  ë° í–¥í›„ ê³„íš (Insight)</h3>
              ${improveHtml}
            </td>
          </tr>
        </table>
        <p style="text-align: right; color: #94a3b8; font-size: 0.8rem; margin-top: 12px;">â€» ë³¸ ë³´ê³ ì„œëŠ” Cheese Lab ì‹œìŠ¤í…œì— ì˜í•´ <b>${baseDateStr}</b> ê¸°ì¤€ìœ¼ë¡œ ìë™ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      </div>
    `;

    openDocModal(null, titlePrefix, htmlTemplate, 'ë³´ê³ ì„œ');
  }

  // ==========================================
  // [ì‹ ê·œ] ìœ ë‹ˆí´ë¡œì‹ 1-Page ê¸°íšì„œ í…œí”Œë¦¿ ìƒì„±
  // ==========================================
  function generateProposalTemplate() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
    let htmlTemplate = `
      <div style="font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 900px; margin: 0 auto; color: #1e293b;">
        <h2 style="text-align: center; color: #0f172a; margin-bottom: 12px; font-size: 1.8rem; letter-spacing: -0.5px;">[í”„ë¡œì íŠ¸ëª…] ê¸°íšì„œ</h2>
        <div style="text-align: right; margin-bottom: 16px; font-size: 0.9rem; color: #64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: OOO</div>
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">1. ê¸°íš ë°°ê²½ ë° ëª©ì  (Why)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>ë°°ê²½:</b> ì™œ ì´ ê¸°íšì„ í•˜ê²Œ ë˜ì—ˆëŠ”ê°€?</li>
                  <li><b>ëª©ì :</b> ì´ ê¸°íšì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œëŠ”?</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì  (What)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>í˜„ì¬ ìƒí™©:</b> í˜„ì¬ ì—…ë¬´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìƒíƒœëŠ” ì–´ë– í•œê°€?</li>
                  <li><b>ë¬¸ì œì (Pain Point):</b> í•´ê²°í•´ì•¼ í•  ê°€ì¥ í° ë³‘ëª©ì´ë‚˜ ì›ì¸ì€?</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ (How)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>í•µì‹¬ ì†”ë£¨ì…˜:</b> ë¬¸ì œë¥¼ ì–´ë–»ê²Œ íƒ€ê°œí•  ê²ƒì¸ê°€?</li>
                  <li><b>ì‹¤í–‰ ì „ëµ:</b> íƒ€ ë¶€ì„œ í˜‘ì—…, ë¦¬ìŠ¤í¬ ëŒ€ë¹„ì±… ë“± ìƒì„¸ ì „ëµ</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">4. ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>W1 (1ì£¼ì°¨):</b> ì‚¬ì „ ì¤€ë¹„ ë° ê¸°íšì•ˆ í™•ì •</li>
                  <li><b>W2 (2ì£¼ì°¨):</b> ë³¸ê²© ì‹¤í–‰ ë° 1ì°¨ ë°°í¬</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td colspan="2" style="vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f0fdf4;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">5. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚° (ROI)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>ì •ëŸ‰ì  íš¨ê³¼:</b> ë§¤ì¶œ X% ì¦ëŒ€, ë¦¬ë“œíƒ€ì„ Yì‹œê°„ ë‹¨ì¶• ë“±</li>
                  <li><b>ì†Œìš” ì˜ˆì‚°:</b> íˆ¬ì…ë˜ì–´ì•¼ í•  ì¸ë ¥ ë° ì˜ˆì‚°</li>
              </ul>
            </td>
          </tr>
        </table>
      </div>
    `;
    openDocModal(null, "[ê¸°íšì„œ] ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ê¸°íš", htmlTemplate, 'ê¸°íšì„œ');
  }

  function deleteDoc(id) {
    if(!confirm("ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë“œë¼ì´ë¸Œì˜ ì›ë³¸ HTML íŒŒì¼ì€ ë³´ì¡´ë©ë‹ˆë‹¤)")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) })
      .then(()=>loadAllData());
    } catch(e) { alert("ì‚­ì œ ì˜¤ë¥˜"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  (function showVersion() {
    const el = document.getElementById("sysVersion");
    if (!el) return;
    const d = new Date(document.lastModified);
    const pad = (n) => String(n).padStart(2, '0');
    el.textContent = `Version: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [ìˆ˜ì •]`;
  })();

  function printReport() {
    const content = $('#doc-content').summernote('code');
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>${document.getElementById('doc-title').value}</title><style>body{font-family:'Pretendard',sans-serif;padding:40px;line-height:1.6}table{width:100%;border-collapse:collapse;border:2px solid #cbd5e1}td{border:1px solid #cbd5e1;padding:20px;vertical-align:top}ul{padding-left:20px}@page{size:A4;margin:0}</style></head><body>${content}<script>window.onload=function(){window.print();setTimeout(function(){window.close();},100);}<\/script></body></html>`);
    printWindow.document.close();
  }

  async function saveAsImage() {
    const title = document.getElementById('doc-title').value || "report";
    const contentHtml = $('#doc-content').summernote('code');
    if (!contentHtml || contentHtml === "<p><br></p>") { alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    const printContainer = document.createElement('div');
    printContainer.style.position = 'fixed'; printContainer.style.left = '-9999px'; printContainer.style.width = '900px'; 
    printContainer.style.padding = '40px'; printContainer.style.background = '#ffffff';
    printContainer.innerHTML = `<style>.temp-wrap{font-family:'Pretendard',sans-serif;color:#1e293b}.temp-wrap table{width:100%;border-collapse:collapse;border:2px solid #cbd5e1}.temp-wrap td{border:1px solid #cbd5e1;padding:20px;vertical-align:top}</style><div class="temp-wrap">${contentHtml}</div>`;
    document.body.appendChild(printContainer);
    if(typeof showAdminLoading === 'function') showAdminLoading("ì´ë¯¸ì§€ íŒŒì¼ ìƒì„± ì¤‘...");
    try {
        const canvas = await html2canvas(printContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false });
        const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = `${title}.png`; link.click();
    } catch (err) { console.error("Image Save Error:", err); alert("ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜"); } 
    finally { document.body.removeChild(printContainer); if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  }
  // ==========================================
  // [ì‹ ê·œ] ì•„ì´ë””ì–´ ì„ íƒ ë° ê¸°íšì„œ ë³€í™˜ ë¡œì§
  // ==========================================
  
  // 1. ì•„ì´ë””ì–´ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
  function openIdeaSelector() {
      const container = document.getElementById('idea-list-container');
      container.innerHTML = "";
      
      // 'ì•„ì´ë””ì–´' ìœ í˜•ì´ê±°ë‚˜ ì œëª©ì— ì „êµ¬(ğŸ’¡)ê°€ ìˆëŠ” íƒœìŠ¤í¬ í•„í„°ë§
      const ideas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' || (t['ì œëª©'] && t['ì œëª©'].includes('ğŸ’¡')));
      
      if (ideas.length === 0) {
          alert("ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'í•  ì¼ ê´€ë¦¬'ì—ì„œ ì•„ì´ë””ì–´ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
          return;
      }

      // ìµœì‹ ìˆœ ì •ë ¬ í›„ ë Œë”ë§
      ideas.sort((a, b) => b.ID.localeCompare(a.ID));
      
      ideas.forEach(idea => {
          const div = document.createElement('div');
          div.className = 'idea-select-item';
          div.onclick = (e) => {
              // div í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€ (ì²´í¬ë°•ìŠ¤ ìì²´ í´ë¦­ ì œì™¸)
              if(e.target.type !== 'checkbox') {
                  const chk = div.querySelector('input');
                  chk.checked = !chk.checked;
              }
          };
          
          const desc = idea['ìƒì„¸ë‚´ìš©'] ? idea['ìƒì„¸ë‚´ìš©'].replace(/<[^>]*>?/gm, '').substring(0, 60) : '(ë‚´ìš© ì—†ìŒ)';
          
          div.innerHTML = `
              <input type="checkbox" class="idea-chk" value="${idea.ID}">
              <div class="idea-select-content">
                  <div class="idea-select-title">${idea['ì œëª©']}</div>
                  <div class="idea-select-desc">${desc}</div>
              </div>
          `;
          container.appendChild(div);
      });
      
      document.getElementById('idea-select-modal').classList.add('open');
  }

  // 2. ì„ íƒëœ ì•„ì´ë””ì–´ë¡œ 4ë¶„í•  ê¸°íšì„œ ìƒì„±
  function confirmIdeaSelection() {
      const checkboxes = document.querySelectorAll('.idea-chk:checked');
      if (checkboxes.length === 0) {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì•„ì´ë””ì–´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
          return;
      }

      let selectedIdeas = [];
      checkboxes.forEach(chk => {
          const idea = g_tasks.find(t => t.ID === chk.value);
          if (idea) selectedIdeas.push(idea);
      });

      document.getElementById('idea-select-modal').classList.remove('open');
      generateProposalFromIdeas(selectedIdeas);
  }

  // 3. í…œí”Œë¦¿ì— ë°ì´í„° ì£¼ì…
  function generateProposalFromIdeas(ideas) {
      const today = new Date();
      const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
      
      // ì œëª© ì¡°í•© (ì²« ë²ˆì§¸ ì•„ì´ë””ì–´ ì œëª© í™œìš©)
      const mainTitle = ideas.length === 1 ? ideas[0]['ì œëª©'] : `${ideas[0]['ì œëª©']} ì™¸ ${ideas.length-1}ê±´ êµ¬ì²´í™” ê¸°íš`;
      
      // ì•„ì´ë””ì–´ ë‚´ìš©ì„ HTML ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
      let ideaListHtml = "";
      let solutionHtml = "";
      
      ideas.forEach(idea => {
          const desc = idea['ìƒì„¸ë‚´ìš©'] || "(ìƒì„¸ ë‚´ìš© ì—†ìŒ)";
          // ë°°ê²½ì— ë„£ì„ ìš”ì•½
          ideaListHtml += `<li><b>${idea['ì œëª©']}:</b> í˜„ì¬ ì•„ì´ë””ì–´ ë‹¨ê³„ë¡œ, êµ¬ì²´ì ì¸ ì‹¤í–‰ ê³„íš ìˆ˜ë¦½ì´ í•„ìš”í•¨.</li>`;
          // ì†”ë£¨ì…˜ì— ë„£ì„ ìƒì„¸
          solutionHtml += `<li style="margin-bottom:8px;"><b>[${idea['ì œëª©']}] êµ¬í˜„:</b><br/>${desc}<br/><span style="color:#ea580c; font-size:0.9em;">ğŸ‘‰ (ì—¬ê¸°ì— êµ¬ì²´ì  ì‹¤í–‰ ë°©ë²•ì„ ë³´ì™„í•˜ì„¸ìš”)</span></li>`;
      });

      // ìœ ë‹ˆí´ë¡œ 4ë¶„í•  í…œí”Œë¦¿ì— ì£¼ì…
      let htmlTemplate = `
      <div style="font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 900px; margin: 0 auto; color: #1e293b;">
        <h2 style="text-align: center; color: #ea580c; margin-bottom: 12px; font-size: 1.8rem; letter-spacing: -0.5px;">[ê¸°íšì„œ] ${mainTitle}</h2>
        <div style="text-align: right; margin-bottom: 16px; font-size: 0.9rem; color: #64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: OOO</div>
        
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #ea580c; font-size: 1.15rem; border-bottom: 2px solid #fed7aa; padding-bottom: 8px;">1. ê¸°íš ë°°ê²½ ë° ëª©ì  (Why)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  ${ideaListHtml}
                  <li><b>ëª©ì :</b> ìœ„ ì•„ì´ë””ì–´ë¥¼ ì‹¤í˜„í•˜ì—¬ ì—…ë¬´ íš¨ìœ¨ ì¦ëŒ€ ë° ê°€ì¹˜ ì°½ì¶œ</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff7ed;">
              <h3 style="margin: 0 0 12px 0; color: #ea580c; font-size: 1.15rem; border-bottom: 2px solid #fed7aa; padding-bottom: 8px;">2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì  (What)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>Pain Point:</b> í˜„ì¬ í•´ë‹¹ ì•„ì´ë””ì–´ê°€ ë¶€ì¬í•˜ì—¬ ë°œìƒí•˜ëŠ” ë¶ˆí¸í•¨ì€?</li>
                  <li><b>ë‹ˆì¦ˆ:</b> (ì—¬ê¸°ì— ë¬¸ì œì ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”)</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff7ed;">
              <h3 style="margin: 0 0 12px 0; color: #ea580c; font-size: 1.15rem; border-bottom: 2px solid #fed7aa; padding-bottom: 8px;">3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ (How)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.6;">
                  ${solutionHtml}
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #ea580c; font-size: 1.15rem; border-bottom: 2px solid #fed7aa; padding-bottom: 8px;">4. ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>Step 1:</b> ê¸°íš êµ¬ì²´í™” ë° ì„¤ê³„ (~MM.DD)</li>
                  <li><b>Step 2:</b> ê°œë°œ ë° ì œì‘ (~MM.DD)</li>
                  <li><b>Step 3:</b> í…ŒìŠ¤íŠ¸ ë° ë°°í¬ (~MM.DD)</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td colspan="2" style="vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fdf2f8;">
              <h3 style="margin: 0 0 12px 0; color: #db2777; font-size: 1.15rem; border-bottom: 2px solid #fbcfe8; padding-bottom: 8px;">5. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚° (ROI)</h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>ì˜ˆìƒ íš¨ê³¼:</b> (ì´ ì•„ì´ë””ì–´ê°€ ì‹¤í˜„ë˜ë©´ ë¬´ì—‡ì´ ì¢‹ì•„ì§€ë‚˜ìš”?)</li>
                  <li><b>í•„ìš” ìì›:</b> ì¸ë ¥ Oëª…, ì˜ˆì‚° OOOì›</li>
              </ul>
            </td>
          </tr>
        </table>
      </div>
      `;

      openDocModal(null, "[ê¸°íšì„œ] " + mainTitle, htmlTemplate, 'ê¸°íšì„œ');
  }



  // ==========================================
  // [ì‹ ê·œ] ì»¤ìŠ¤í…€ ì¼ì • ìƒì„±ê¸° ë¡œì§
  // ==========================================
  
  // 1. ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  function openScheduleMaker() {
    document.getElementById('schedule-maker-modal').classList.add('open');
    // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ ì„¸íŒ…
    if(!document.getElementById('sch-start-date').value) {
        document.getElementById('sch-start-date').value = new Date().toISOString().split('T')[0];
    }
    // ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í–‰ í•˜ë‚˜ ì¶”ê°€
    if(document.getElementById('sch-input-list').children.length === 0) {
        addScheduleRow(); 
    }
  }
  
  function closeScheduleMaker() {
    document.getElementById('schedule-maker-modal').classList.remove('open');
  }

  // 2. ì…ë ¥ í–‰ ì¶”ê°€
  function addScheduleRow(cat="", task="", start=0, dur=1) {
    const tbody = document.getElementById('sch-input-list');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td style="padding:4px;"><input type="text" class="form-input sch-cat" value="${cat}" placeholder="ì˜ˆ: 1ë‹¨ê³„" style="width:100%;"></td>
        <td style="padding:4px;"><input type="text" class="form-input sch-task" value="${task}" placeholder="ì‘ì—…ëª… ì…ë ¥" style="width:100%;"></td>
        <td style="padding:4px;"><input type="number" class="form-input sch-start" value="${start}" min="0" max="5" style="width:100%; text-align:center;"></td>
        <td style="padding:4px;"><input type="number" class="form-input sch-dur" value="${dur}" min="1" max="6" style="width:100%; text-align:center;"></td>
        <td style="padding:4px; text-align:center;"><button onclick="this.closest('tr').remove()" style="border:none; background:none; cursor:pointer; color:#ef4444;">ğŸ—‘ï¸</button></td>
    `;
    tbody.appendChild(tr);
  }

  // 3. ì˜ˆì œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì‚¬ìš©ìë‹˜ ë¡œë“œë§µ)
  function loadSchedulePreset() {
      if(!confirm("ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì‚¬ë¼ì§€ê³  ì˜ˆì œë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
      const tbody = document.getElementById('sch-input-list');
      tbody.innerHTML = "";
      
      // ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ ë°ì´í„°
      addScheduleRow("1ë‹¨ê³„<br>(ì•ˆì •í™”)", "íˆ´ ë¶ˆí¸ í¬ì¸íŠ¸ ë³´ì™„", 0, 1);
      addScheduleRow("", "í…ŒìŠ¤íŠ¸ ê¸€ 5~10ê°œ ì´ì „", 0, 2);
      addScheduleRow("", "ì´ë¯¸ì§€ ì •ì±… ë¬¸ì„œí™”", 1, 1);
      addScheduleRow("2ë‹¨ê³„<br>(ê°€ê³„ë„)", "ì‹œë¦¬ì¦ˆ ë„¤ë¹„ê²Œì´ì…˜ ì™„ì„±", 2, 1);
      addScheduleRow("", "ê°€ê³„ë„ ê¸€ ìš°ì„ ìˆœìœ„ ì´ì „", 2, 2);
      addScheduleRow("", "ë§í¬/ë¬¸êµ¬ ì •ì±… í†µì¼", 3, 1);
      addScheduleRow("3ë‹¨ê³„<br>(ë§ˆê°)", "í•œì¤‘ì¼ ì—°í‘œ ìƒì„±íˆ´ í…ŒìŠ¤íŠ¸", 4, 1);
      addScheduleRow("", "ì”ì—¬ ê¸€ ì¼ê´„ ì´ì „", 4, 2);
      addScheduleRow("", "ìµœì¢… í’ˆì§ˆ ì ê²€ (SEO)", 5, 1);
  }

  // 4. ìµœì¢… HTML ìƒì„± ë° ì‚½ì…
  function insertCustomSchedule() {
    const startDateVal = document.getElementById('sch-start-date').value;
    const projectName = document.getElementById('sch-project-name').value;
    
    if(!startDateVal) { alert("ì‹œì‘ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }

    // (A) í—¤ë” ë‚ ì§œ ê³„ì‚° (3ì¼ ë‹¨ìœ„ 6ì¹¸)
    const headers = [];
    const startObj = new Date(startDateVal);
    
    for(let i=0; i<6; i++) {
        const s = new Date(startObj); s.setDate(s.getDate() + (i*3));
        const e = new Date(s); e.setDate(e.getDate() + 2); // 3ì¼ ê°„ê²©
        const sStr = `${s.getMonth()+1}/${s.getDate()}`;
        const eStr = `${e.getDate()}`;
        headers.push(`${sStr}~${eStr}`);
    }
    
    let headerHtml = "";
    headers.forEach(h => {
        headerHtml += `<th style="border:1px solid #cbd5e1; background:#f1f5f9; padding:8px; font-size:0.85rem; color:#475569; width:60px;">${h}</th>`;
    });

    // (B) ë°”ë”” ìƒì„±
    let rowsHtml = "";
    const rows = document.querySelectorAll('#sch-input-list tr');
    
    rows.forEach(tr => {
        const cat = tr.querySelector('.sch-cat').value;
        const task = tr.querySelector('.sch-task').value;
        const start = parseInt(tr.querySelector('.sch-start').value) || 0;
        const dur = parseInt(tr.querySelector('.sch-dur').value) || 1;
        
        const catStyle = cat ? "font-weight:800; color:#3b82f6; background:#eff6ff;" : "color:#fff;";
        
        let cols = "";
        for(let i=0; i<6; i++) {
            if (i >= start && i < start + dur) {
                // ë°” ìŠ¤íƒ€ì¼ë§ (í™”ì‚´í‘œ)
                let barStyle = "background:#3b82f6; height:12px; margin-top:6px; opacity:0.8;";
                let content = "";
                
                // ì‹œì‘/ì¤‘ê°„/ë ëª¨ì–‘ ì²˜ë¦¬
                if (dur === 1) barStyle += "border-radius:6px;"; 
                else if (i === start) barStyle += "border-radius:6px 0 0 6px;"; 
                else if (i === start + dur - 1) { barStyle += "border-radius:0 6px 6px 0;"; content = "â–¶"; }
                else barStyle += "border-radius:0;"; 
                
                cols += `<td style="border:1px solid #e2e8f0; padding:0; text-align:right; vertical-align:middle; color:#3b82f6; font-size:10px; line-height:1;">
                            <div style="${barStyle} position:relative;">
                                <span style="position:absolute; right:-4px; top:-5px; font-size:14px;">${content}</span>
                            </div>
                         </td>`;
            } else {
                cols += `<td style="border:1px solid #e2e8f0; background:#fff;"></td>`;
            }
        }

        rowsHtml += `
        <tr>
            <td style="border:1px solid #cbd5e1; padding:10px; font-size:0.9rem; text-align:center; vertical-align:middle; ${catStyle}">${cat}</td>
            <td style="border:1px solid #cbd5e1; padding:8px 12px; font-size:0.95rem; font-weight:600; color:#1e293b;">
                <span style="color:#cbd5e1; margin-right:6px;">â—»</span> ${task}
            </td>
            ${cols}
        </tr>`;
    });

    // (C) ìµœì¢… í…œí”Œë¦¿
    const finalHtml = `
      <div style="font-family: 'Pretendard', sans-serif; margin-bottom: 30px;">
        <h3 style="color:#1e293b; font-size:1.4rem; border-left:5px solid #db2777; padding-left:12px; margin-bottom:12px;">ğŸ“… ${projectName} ë¡œë“œë§µ</h3>
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <thead>
            <tr>
              <th style="border:1px solid #cbd5e1; background:#f1f5f9; padding:10px; width:100px;">êµ¬ë¶„</th>
              <th style="border:1px solid #cbd5e1; background:#f1f5f9; padding:10px; width:220px;">Task (ì‘ì—…ëª…)</th>
              ${headerHtml}
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
        <div style="text-align:right; font-size:0.8rem; color:#94a3b8; margin-top:4px;">* ì²´í¬ë°•ìŠ¤(â—»)ë¥¼ í´ë¦­í•˜ì—¬ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½í•˜ì„¸ìš”.</div>
      </div><br/>
    `;

    // ì—ë””í„°ì— ì‚½ì…
    $('#doc-content').summernote('pasteHTML', finalHtml);
    closeScheduleMaker();
  }
</script>

</body>
</html>
