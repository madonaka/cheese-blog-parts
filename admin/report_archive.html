<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¬¸ì„œ ì•„ì¹´ì´ë¸Œ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    // âœ… ì„œë²„ API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
    
    // ğŸš¨ í•„ìˆ˜ ì„¤ì •: ìƒì„±ëœ ë¬¸ì„œ(íŒŒì¼)ê°€ ì €ì¥ë  êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë” ID (ê¼­ ë³¸ì¸ì˜ í´ë” IDë¡œ ë³€ê²½í•˜ì„¸ìš”!)
    const ARCHIVE_FOLDER_ID = "1MpTCfw8B1Y-77QFr4k5SCPfVQgso8fKi"; 
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* --- ì•„ì¹´ì´ë¸Œ ì „ìš© ë””ìì¸ --- */
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; }
    
    .archive-header {
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e2e8f0;
      flex-wrap: wrap; gap: 16px;
    }
    .archive-title h2 { margin: 0 0 8px 0; font-size: 1.8rem; color: #1e293b; font-weight: 800; }
    .archive-title p { margin: 0; color: #64748b; font-size: 0.95rem; }
    
    /* ì‹œìŠ¤í…œ ë²„ì „ í‘œì‹œ ë±ƒì§€ */
    .sys-version-large {
      font-size: 0.95rem;
      font-weight: 800;
      color: #ef4444; 
      background: #fee2e2;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      margin-top: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .report-generator-group {
      display: flex; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .btn-gen {
      background: #fff; color: #3b82f6; border: 1px solid #bfdbfe; font-weight: 700; padding: 8px 16px;
      border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .btn-gen:hover { background: #eff6ff; border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(59,130,246,0.1); }
    .btn-new { background: #3b82f6; color: white; border: none; }
    .btn-new:hover { background: #2563eb; }

    /* ë¬¸ì„œ ê·¸ë¦¬ë“œ ë·° */
    .doc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .doc-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 24px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.2s; position: relative; cursor: pointer;
      display: flex; flex-direction: column; height: 240px;
    }
    .doc-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: #cbd5e1; }
    .doc-type-badge {
      position: absolute; top: 20px; right: 20px; background: #f1f5f9; color: #475569; font-size: 0.75rem;
      padding: 4px 10px; border-radius: 6px; font-weight: 700;
    }
    .doc-card-title { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin: 0 0 10px 0; padding-right: 60px; line-height: 1.4; }
    .doc-card-date { font-size: 0.85rem; color: #94a3b8; margin-bottom: 12px; font-weight: 500; }
    
    .doc-card-actions { margin-top: auto; display: flex; justify-content: flex-end; gap: 8px; border-top: 1px dashed #e2e8f0; padding-top: 16px; }
    
    /* ì—ë””í„° ëª¨ë‹¬ */
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box.large-modal { background: #fff; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 900px; max-width: 95vw; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
    
    .modal-header-custom { flex-shrink: 0; padding: 20px 32px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .modal-title-custom { font-size: 1.5rem; font-weight: 800; color: #1e293b; }
    .modal-body-custom { flex: 1; overflow-y: auto; padding: 32px; background: #f8fafc; }
    .modal-footer-custom { flex-shrink: 0; padding: 20px 32px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 12px; }
    
    .input-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 700; color: #475569; }
    .styled-input { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; font-size: 1rem; transition: 0.2s; }
    .styled-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    .note-editor.note-frame { border-color: #e2e8f0; border-radius: 12px; overflow: hidden; background: #fff; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
       <div class="archive-header">
          <div class="archive-title">
            <h2>ğŸ“‚ ë³´ê³ ì„œ & ê¸°íšì„œ ì•„ì¹´ì´ë¸Œ</h2>
            <p>ë‚´ìš©ì€ êµ¬ê¸€ ë“œë¼ì´ë¸Œë¡œ ì•ˆì „í•˜ê²Œ, ê´€ë¦¬ëŠ” ê°€ë³ê²Œ!</p>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
          </div>
          <div class="report-generator-group" style="align-items: center;">
            <div style="display: flex; align-items: center; gap: 6px; margin-right: 8px; border-right: 2px solid #e2e8f0; padding-right: 14px;">
              <span style="font-size: 0.9rem; font-weight: 700; color: #475569;">ğŸ“… ê¸°ì¤€ì¼:</span>
              <input type="date" id="report-base-date" class="styled-input" style="padding: 6px 10px; width: 140px; font-weight: 600; color: #1e293b;">
            </div>
            
            <button class="btn-gen" onclick="generateAutoReport('daily')">ğŸ“ ì¼ì¼ ë³´ê³ ì„œ</button>
            <button class="btn-gen" onclick="generateAutoReport('weekly')">ğŸ“Š ì£¼ê°„ ë³´ê³ ì„œ</button>
            <button class="btn-gen" onclick="generateAutoReport('monthly')">ğŸ“… ì›”ê°„ ë³´ê³ ì„œ</button>
            <div style="width:1px; background:#e2e8f0; margin: 0 4px;"></div>
            <button class="btn-gen" style="background:#f0fdf4; color:#16a34a; border-color:#bbf7d0;" onclick="generateProposalTemplate()">ğŸ’¡ 1-Page ê¸°íšì„œ</button>
            <button class="btn-gen btn-new" onclick="openDocModal()">+ ë¹ˆ ë¬¸ì„œ</button>
          </div>
        </div>

        <div class="doc-grid" id="doc-grid">
          <div style="grid-column: 1 / -1; text-align: center; padding: 60px 0; color: #94a3b8;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>

      </div>
    </section>
  </main>
</div>

<div id="doc-modal" class="custom-modal">
  <div class="modal-box large-modal">
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="doc-modal-title">ìƒˆ ë¬¸ì„œ ì‘ì„±</span>
    </div>
    
    <form id="doc-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin:0;">
      <div class="modal-body-custom">
        <input type="hidden" id="doc-id" value="">
        <input type="hidden" id="doc-drive-id" value="">
        
        <div style="display:flex; gap:16px; margin-bottom:20px;">
          <div style="flex: 1;">
            <label class="input-label">ë¬¸ì„œ ì œëª©</label>
            <input type="text" id="doc-title" class="styled-input" placeholder="ë³´ê³ ì„œ ë˜ëŠ” ê¸°íšì„œ ì œëª©" required style="font-size:1.1rem; font-weight:700;">
          </div>
          <div style="width: 160px;">
            <label class="input-label">ë¬¸ì„œ ìœ í˜•</label>
            <select id="doc-type" class="styled-input">
              <option value="ë³´ê³ ì„œ">ğŸ“Š ë³´ê³ ì„œ</option>
              <option value="ê¸°íšì„œ">ğŸ’¡ ê¸°íšì„œ</option>
            </select>
          </div>
        </div>

        <div style="display:flex; flex-direction:column;">
          <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
          <textarea id="doc-content" required></textarea>
        </div>
      </div>
      
      <div class="modal-footer-custom">
        <button type="button" class="btn" style="padding:12px 24px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; color:#64748b; font-weight:700; cursor:pointer;" onclick="closeModal('doc-modal')">ì·¨ì†Œ</button>
        <button type="submit" class="btn" id="btn-save-doc" style="padding:12px 24px; border-radius:12px; border:none; background:#3b82f6; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 4px 6px -1px rgba(59,130,246,0.3);">ğŸ’¾ ë“œë¼ì´ë¸Œì— ì €ì¥</button>
      </div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "report_archive"; 
  
  let g_docs = [];
  let g_logs = [];
  let g_goals = [];
  let g_tasks = [];

document.addEventListener('DOMContentLoaded', () => {
    $('#doc-content').summernote({
      height: 600, lang: 'ko-KR', // 4ë¶„í•  ë³´ê³ ì„œë¥¼ ìœ„í•´ ì—ë””í„° ë†’ì´ë¥¼ 600ìœ¼ë¡œ ëŠ˜ë ¸ìŠµë‹ˆë‹¤
      toolbar: [
        ['style', ['style']], ['font', ['bold', 'underline', 'clear']],
        ['color', ['color']], ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']], ['insert', ['link']], ['view', ['codeview', 'fullscreen']]
      ]
    });
    
    // âœ… [ì‹ ê·œ] ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ 'ì˜¤ëŠ˜'ë¡œ ìë™ ì„¸íŒ…
    const todayStr = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    document.getElementById('report-base-date').value = todayStr;

    loadAllData();
  });

  // âœ… [ì‹ ê·œ] ë³´ê³ ì„œìš© ëª©í‘œ ì§„ì²™ë¥ (%) ê³„ì‚° ìœ í‹¸ë¦¬í‹°
  function getReportGoalProgress(goalId, isBigGoal) {
      let tasks = [];
      if (isBigGoal) {
          const midGoalIds = g_goals.filter(m => m['ìƒìœ„ID'] === goalId).map(m => m.ID);
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
      } else {
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === goalId);
      }
      if (tasks.length === 0) return 0;
      const doneCount = tasks.filter(t => t['ìƒíƒœ'] === 'ì™„ë£Œ').length;
      return Math.round((doneCount / tasks.length) * 100);
  }

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_logs = json.logs || []; g_goals = json.goals || []; g_tasks = json.tasks || [];
        g_docs = g_tasks.filter(t => t['ìœ í˜•'] === 'ë³´ê³ ì„œ' || t['ìœ í˜•'] === 'ê¸°íšì„œ');
        g_docs.sort((a, b) => b.ID.localeCompare(a.ID)); 
        renderDocs();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function renderDocs() {
    const root = document.getElementById('doc-grid');
    root.innerHTML = "";
    
    if(g_docs.length === 0) {
        root.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding: 60px; color:#94a3b8; background:#f8fafc; border-radius:16px; border:2px dashed #cbd5e1; font-weight:600;">ë³´ê´€ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë¬¸ì„œë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>`;
        return;
    }

    g_docs.forEach(doc => {
      const card = document.createElement('div'); card.className = "doc-card";
      const isReport = doc['ìœ í˜•'] === 'ë³´ê³ ì„œ';
      const badgeColor = isReport ? '#eff6ff' : '#f0fdf4';
      const textColor = isReport ? '#2563eb' : '#16a34a';
      const rawDate = doc['ê¸°í•œ'] ? doc['ê¸°í•œ'].split('T')[0] : 'ë‚ ì§œ ì—†ìŒ';

      let previewHtml = "";
      if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
          previewHtml = `
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
              <div style="background:#f8fafc; color:#3b82f6; padding:12px 20px; border-radius:12px; font-weight:800; font-size:0.95rem; border:1px solid #e2e8f0;">
                â˜ï¸ ë“œë¼ì´ë¸Œ ì—°ë™ íŒŒì¼
              </div>
            </div>`;
      } else {
          previewHtml = `<div style="flex:1; color:#ef4444; font-size:0.85rem; padding:10px;">(êµ¬í˜• ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤)</div>`;
      }

      card.innerHTML = `
        <div class="doc-type-badge" style="background:${badgeColor}; color:${textColor};">${doc['ìœ í˜•']}</div>
        <h3 class="doc-card-title">${doc['ì œëª©'] || '(ì œëª© ì—†ìŒ)'}</h3>
        <div class="doc-card-date">ğŸ—“ ìµœì¢… ìˆ˜ì •: ${rawDate}</div>
        ${previewHtml}
        <div class="doc-card-actions">
           <button class="btn" style="background:#f1f5f9; color:#475569; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="openDocModal('${doc.ID}'); event.stopPropagation();">ğŸ“ ì—´ê¸°</button>
           <button class="btn" style="background:#fff1f2; color:#ef4444; border:none; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:600;" onclick="deleteDoc('${doc.ID}'); event.stopPropagation();">ğŸ—‘ï¸</button>
        </div>
      `;
      card.onclick = () => openDocModal(doc.ID);
      root.appendChild(card);
    });
  }

  async function openDocModal(docId = null, defaultTitle = "", defaultHtml = "", defaultType = "ë³´ê³ ì„œ") {
    const modal = document.getElementById('doc-modal');
    modal.classList.add('open');
    document.getElementById('doc-form').reset();
    document.getElementById('doc-drive-id').value = ""; 
    $('#doc-content').summernote('code', '');

    if (docId) {
        const doc = g_docs.find(d => d.ID === docId);
        if (doc) {
            document.getElementById('doc-modal-title').textContent = "ë¬¸ì„œ í™•ì¸ ë° ìˆ˜ì •";
            document.getElementById('doc-id').value = doc.ID;
            document.getElementById('doc-title').value = doc['ì œëª©'];
            document.getElementById('doc-type').value = doc['ìœ í˜•'];
            
            if (doc['ìƒì„¸ë‚´ìš©'] && doc['ìƒì„¸ë‚´ìš©'].startsWith("DRIVE:")) {
                const fileId = doc['ìƒì„¸ë‚´ìš©'].split("DRIVE:")[1];
                document.getElementById('doc-drive-id').value = fileId;
                
                if(typeof showAdminLoading==='function') showAdminLoading("êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì›ë³¸ ë‹¤ìš´ë¡œë“œ ì¤‘...");
                try {
                    const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "getReportContent", fileId: fileId }) });
                    const json = await res.json();
                    if(json.result === "success") $('#doc-content').summernote('code', json.content);
                    else throw new Error("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨");
                } catch(e) {
                    alert("ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                } finally {
                    if(typeof hideAdminLoading==='function') hideAdminLoading();
                }
            } else {
                $('#doc-content').summernote('code', doc['ìƒì„¸ë‚´ìš©'] || "");
            }
        }
    } else {
        document.getElementById('doc-modal-title').textContent = "ìƒˆ ë¬¸ì„œ ì‘ì„±";
        document.getElementById('doc-id').value = "";
        document.getElementById('doc-title').value = defaultTitle;
        document.getElementById('doc-type').value = defaultType;
        if(defaultHtml) $('#doc-content').summernote('code', defaultHtml);
    }
  }

  document.getElementById('doc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save-doc');
    const originalText = btn.textContent;
    btn.textContent = "ì²˜ë¦¬ ì¤‘..."; btn.disabled = true;

    try {
        const docId = document.getElementById('doc-id').value;
        const title = document.getElementById('doc-title').value;
        const type = document.getElementById('doc-type').value;
        const contentHtml = $('#doc-content').summernote('code');
        const driveId = document.getElementById('doc-drive-id').value;
        const now = new Date().toISOString().split('T')[0];

        if(typeof showAdminLoading==='function') showAdminLoading("êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì•ˆì „í•˜ê²Œ ë³´ê´€ ì¤‘...");
        let savedFileId = driveId;
        
        const drivePayload = {
            mode: "uploadReportContent",
            folderId: ARCHIVE_FOLDER_ID,
            fileId: driveId,
            title: title,
            content: contentHtml
        };
        const driveRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(drivePayload) });
        const driveJson = await driveRes.json();
        
        if (driveJson.result === "success") {
            savedFileId = driveJson.fileId;
        } else {
            throw new Error("ë“œë¼ì´ë¸Œ ì—…ë¡œë“œ ì‹¤íŒ¨");
        }

        if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„°ë² ì´ìŠ¤ ë©”íƒ€ë°ì´í„° ê¸°ë¡ ì¤‘...");
        const dbPayload = {
            mode: docId ? "editItem" : "addItem",
            id: docId,
            type: type,
            title: title,
            detail: "DRIVE:" + savedFileId,
            priority: "ë³´í†µ",
            dueDate: now, 
            connectedId: "",
            color: ""
        };
        
        const dbRes = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(dbPayload) });
        const dbJson = await dbRes.json();
        
        if(dbJson.result === "success") {
            closeModal('doc-modal');
            await loadAllData(); 
        } else {
            alert("DB ì €ì¥ ì‹¤íŒ¨: " + dbJson.msg);
        }
    } catch(err) {
        console.error(err); alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    } finally {
        btn.textContent = originalText; btn.disabled = false;
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

// ==========================================
  // [ì‹ ê·œ] D-Day ê³„ì‚° ìœ í‹¸ë¦¬í‹° (ë³´ê³ ì„œìš©)
  // ==========================================
  function getReportDday(dateStr) {
      if (!dateStr) return `<span style="color:#94a3b8; font-size:0.85em; margin-left:6px; font-weight:normal;">(ë§ˆê° ë¯¸ì •)</span>`;
      const targetDate = new Date(dateStr);
      const today = new Date();
      targetDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
      
      const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-${diffDays}</span>`;
      if (diffDays === 0) return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D-Day</span>`;
      return `<span style="color:#ef4444; font-size:0.85em; font-weight:900; margin-left:6px; background:#fee2e2; padding:2px 6px; border-radius:4px;">D+${Math.abs(diffDays)} ì§€ì—°</span>`;
  }

// ==========================================
  // 5. 1 Page 4ë¶„í•  ìë™ ë³´ê³ ì„œ ìƒì„± ë¡œì§ (ë¶„ë¥˜ ë³‘í•© ìµœì í™”)
  // ==========================================
  function generateAutoReport(rangeType) {
    const baseDateStr = document.getElementById('report-base-date').value;
    if (!baseDateStr) { alert("ë³´ê³ ì„œ ê¸°ì¤€ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
    
    const targetEndDate = new Date(baseDateStr); targetEndDate.setHours(23,59,59,999);
    let startDate = new Date(baseDateStr); startDate.setHours(0,0,0,0);
    
    let titlePrefix = "";
    if (rangeType === 'daily') {
        titlePrefix = `[ì¼ì¼ ë³´ê³ ì„œ] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ${targetEndDate.getDate()}ì¼`;
    } else if (rangeType === 'weekly') {
        const day = startDate.getDay() || 7; startDate.setDate(startDate.getDate() - day + 1);
        titlePrefix = `[ì£¼ê°„ ë³´ê³ ì„œ] ${targetEndDate.getMonth()+1}ì›” ${Math.ceil(targetEndDate.getDate()/7)}ì£¼ì°¨`;
    } else if (rangeType === 'monthly') {
        startDate.setDate(1); 
        titlePrefix = `[ì›”ê°„ ë³´ê³ ì„œ] ${targetEndDate.getFullYear()}ë…„ ${targetEndDate.getMonth()+1}ì›” ê²°ì‚°`;
    }

    const targetLogs = g_logs.filter(log => {
        if (!log['ë‚ ì§œ']) return false;
        const d = new Date(log['ë‚ ì§œ']); return d >= startDate && d <= targetEndDate;
    });

    // ğŸš€ [í•µì‹¬ ìˆ˜ì •] IDê°€ ì•„ë‹Œ 'ì´ë¦„'ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¤‘ë³µ ìª¼ê°œì§ ë°©ì§€
    const groupedLogsByName = {}; 
    let totalLogs = 0;

    targetLogs.forEach(log => {
        let categoryName = "ê¸°íƒ€ (ë¯¸ë¶„ë¥˜ ì—…ë¬´)";
        const gId = log['ê´€ë ¨_ëª©í‘œID'];

        // IDê°€ ì¡´ì¬í•  ê²½ìš° ì‹¤ì œ ëª©í‘œì˜ ì œëª©ì„ ì°¾ì•„ì˜´
        if (gId && String(gId).trim() !== "") {
            const goalObj = g_goals.find(g => g.ID === gId) || g_tasks.find(t => t.ID === gId);
            // ì‹œíŠ¸ ì—ëŸ¬(#ERROR!)ê°€ ì•„ë‹ˆê³  ì •ìƒì ì¸ ì œëª©ì´ ìˆì„ ë•Œë§Œ ë°˜ì˜
            if (goalObj && goalObj['ì œëª©'] && !String(goalObj['ì œëª©']).includes('#ERROR!')) {
                categoryName = goalObj['ì œëª©']; 
            }
        }

        // ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ ë°°ì—´ ìƒì„± ë° í‘¸ì‹œ (ë™ì¼í•œ ì´ë¦„ì€ í•˜ë‚˜ë¡œ ì™„ë²½íˆ í•©ì³ì§)
        if (!groupedLogsByName[categoryName]) {
            groupedLogsByName[categoryName] = [];
        }
        groupedLogsByName[categoryName].push(log);
        totalLogs++;
    });

    // í™”ë©´ì— ë³´ì—¬ì¤„ ë•Œ 'ê¸°íƒ€' í•­ëª©ì„ í•­ìƒ ë§¨ ë°‘ìœ¼ë¡œ ë³´ë‚´ê¸° ìœ„í•œ ì •ë ¬ ë°°ì—´
    const sortedCategories = Object.keys(groupedLogsByName).sort((a, b) => {
        if (a === "ê¸°íƒ€ (ë¯¸ë¶„ë¥˜ ì—…ë¬´)") return 1;
        if (b === "ê¸°íƒ€ (ë¯¸ë¶„ë¥˜ ì—…ë¬´)") return -1;
        return a.localeCompare(b);
    });

    // âœ… [Q1] í•µì‹¬ ìš”ì•½: ë³‘í•©ëœ ê±´ìˆ˜ ì¶œë ¥
    let breakdownHtml = `<li><b>ì´ ì‘ì—… ê±´ìˆ˜:</b> ì´ ${totalLogs}ê±´ ì™„ë£Œ</li>`;
    if (totalLogs > 0) {
        breakdownHtml += `<ul style="margin: 6px 0 12px 0; padding-left: 20px; font-size: 0.9em; color: #475569; list-style-type: circle;">`;
        sortedCategories.forEach(catName => {
            breakdownHtml += `<li style="margin-bottom:2px;">${catName}: <b>${groupedLogsByName[catName].length}</b>ê±´</li>`;
        });
        breakdownHtml += `</ul>`;
    }

    // âœ… [Q2] í”„ë¡œì íŠ¸ í˜„í™©: ëª©í‘œ ë‹¬ì„±ë¥  + D-Day ì‹œê°í™”
    let progressHtml = `<ul style="padding-left: 20px; margin: 0; font-size: 0.95rem; color: #333; line-height: 1.6;">`;
    const activeBigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && g['ìƒíƒœ'] !== 'ì™„ë£Œ');
    
    if (activeBigGoals.length > 0) {
        activeBigGoals.forEach(bg => {
            const percent = getReportGoalProgress(bg.ID, true);
            const ddayBadge = getReportDday(bg['ë§ˆê°ì¼']);
            let statusColor = percent === 100 ? "#10b981" : (percent > 0 ? "#3b82f6" : "#64748b");
            
            progressHtml += `<li style="margin-bottom: 12px;">
                <b>${bg['ì œëª©']}</b> ${ddayBadge}<br/>
                <span style="color:${statusColor}; font-weight:800; font-size: 0.9em; display:inline-block; margin-top:2px;">â†³ ${percent}% ì§„í–‰</span>
            </li>`;
        });
    } else {
        progressHtml += `<li>ì§„í–‰ ì¤‘ì¸ í° ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
    }
    progressHtml += `</ul>`;

    // âœ… [Q3] ìƒì„¸ ì§„í–‰ ë‚´ì—­: ë³‘í•©ëœ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ì‚¬ìš©
    let logHtml = `<div style="font-size: 0.95rem; padding-bottom: 10px;">`;
    if (totalLogs === 0) {
        logHtml += `<p style="color:#94a3b8; margin:0;">í•´ë‹¹ ê¸°ê°„ì— ì‘ì„±ëœ ì‘ì—… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
    } else {
        sortedCategories.forEach(catName => {
            logHtml += `<h4 style="margin: 14px 0 6px 0; color: #1e293b; font-size: 0.95rem;">ğŸ“Œ ${catName}</h4>`;
            logHtml += `<ul style="padding-left: 16px; margin: 0; color: #475569; line-height: 1.6; list-style-type: square;">`;
            groupedLogsByName[catName].forEach(l => {
                const dateStr = l['ë‚ ì§œ'] ? l['ë‚ ì§œ'].substring(5,10) : '';
                const logTitle = l['ì œëª©'] || (l['ë‚´ìš©'] ? l['ë‚´ìš©'].substring(0, 20) + "..." : "(ë‚´ìš© ì—†ìŒ)");
                logHtml += `<li style="margin-bottom: 4px;">[${dateStr}] <b>${logTitle}</b></li>`;
            });
            logHtml += `</ul>`;
        });
    }
    logHtml += `</div>`;

    // HTML í…œí”Œë¦¿ ì¡°ë¦½ (4ë¶„í• )
    let htmlTemplate = `
      <div style="font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 900px; margin: 0 auto; color: #1e293b;">
        <h2 style="text-align: center; color: #0f172a; margin-bottom: 24px; font-size: 1.6rem; letter-spacing: -0.5px;">${titlePrefix}</h2>
        
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">
                1. ëª©í‘œ ë° í•µì‹¬ ìš”ì•½
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 0.95rem; color: #333; line-height: 1.8;">
                  <li><b>ë³´ê³  ê¸°ê°„:</b> ${startDate.toLocaleDateString()} ~ ${targetEndDate.toLocaleDateString()}</li>
                  ${breakdownHtml}
                  <li><b>ì£¼ìš” ì´ìŠˆ:</b> (íŠ¹ì´ì‚¬í•­ì„ ìš”ì•½í•´ ì£¼ì„¸ìš”)</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">
                2. í”„ë¡œì íŠ¸ ì§„í–‰ í˜„í™© (ëª©í‘œ ë‹¬ì„±ë¥ )
              </h3>
              ${progressHtml}
            </td>
          </tr>
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">
                3. ìƒì„¸ ì§„í–‰ ë‚´ì—­ (Task List)
              </h3>
              ${logHtml}
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #2563eb; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; padding-bottom: 8px;">
                4. í–¥í›„ ê³„íš ë° Action Item
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 0.95rem; color: #333; line-height: 1.8;">
                  <li>ë‚´ì¼/ì°¨ì£¼ ì§„í–‰í•  í•µì‹¬ ëª©í‘œ 1...</li>
                  <li>í•´ê²°í•´ì•¼ í•  ì•¡ì…˜ ì•„ì´í…œ ì‘ì„±...</li>
              </ul>
            </td>
          </tr>
        </table>
        
        <p style="text-align: right; color: #94a3b8; font-size: 0.8rem; margin-top: 12px;">
          â€» ë³¸ ë³´ê³ ì„œëŠ” Cheese Lab ì‹œìŠ¤í…œì— ì˜í•´ <b>${baseDateStr}</b> ê¸°ì¤€ìœ¼ë¡œ ìë™ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.
        </p>
      </div>
    `;

    openDocModal(null, titlePrefix, htmlTemplate, 'ë³´ê³ ì„œ');
  }
// ==========================================
  // [ì‹ ê·œ] ìœ ë‹ˆí´ë¡œì‹ 1-Page ê¸°íšì„œ í…œí”Œë¦¿ ìƒì„± ë¡œì§
  // ==========================================
  function generateProposalTemplate() {
    const today = new Date();
    const dateStr = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;

    // ğŸ’¡ ë…¼ë¦¬ì  íë¦„(Why -> What -> How -> Schedule -> ROI)ì„ ë‹´ì€ 5ë¸”ë¡ í…Œì´ë¸”
    let htmlTemplate = `
      <div style="font-family: 'Pretendard', 'Malgun Gothic', sans-serif; max-width: 900px; margin: 0 auto; color: #1e293b;">
        <h2 style="text-align: center; color: #0f172a; margin-bottom: 12px; font-size: 1.8rem; letter-spacing: -0.5px;">[í”„ë¡œì íŠ¸ëª…] ê¸°íšì„œ</h2>
        <div style="text-align: right; margin-bottom: 16px; font-size: 0.9rem; color: #64748b;">ì‘ì„±ì¼: ${dateStr} / ì‘ì„±ì: OOO</div>
        
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; border: 2px solid #cbd5e1;">
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">
                1. ê¸°íš ë°°ê²½ ë° ëª©ì  (Why)
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>ë°°ê²½:</b> ì™œ ì´ ê¸°íšì„ í•˜ê²Œ ë˜ì—ˆëŠ”ê°€? (ì‹œì¥ ë³€í™”, ë‚´ë¶€ ë‹ˆì¦ˆ ë“±)</li>
                  <li><b>ëª©ì :</b> ì´ ê¸°íšì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œëŠ”?</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">
                2. í˜„ìƒ ë° í•µì‹¬ ë¬¸ì œì  (What)
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>í˜„ì¬ ìƒí™©:</b> í˜„ì¬ ì—…ë¬´ë‚˜ ì„œë¹„ìŠ¤ì˜ ìƒíƒœëŠ” ì–´ë– í•œê°€?</li>
                  <li><b>ë¬¸ì œì (Pain Point):</b> í•´ê²°í•´ì•¼ í•  ê°€ì¥ í° ë³‘ëª©ì´ë‚˜ ì›ì¸ì€?</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f8fafc;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">
                3. í•´ê²° ë°©ì•ˆ ë° í•µì‹¬ ì „ëµ (How)
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>í•µì‹¬ ì†”ë£¨ì…˜:</b> ë¬¸ì œë¥¼ ì–´ë–»ê²Œ íƒ€ê°œí•  ê²ƒì¸ê°€?</li>
                  <li><b>ì‹¤í–‰ ì „ëµ:</b> íƒ€ ë¶€ì„œ í˜‘ì—…, ë¦¬ìŠ¤í¬ ëŒ€ë¹„ì±… ë“± ìƒì„¸ ì „ëµ</li>
              </ul>
            </td>
            <td style="width: 50%; vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #fff;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">
                4. ì„¸ë¶€ ì‹¤í–‰ ì¼ì • (Schedule)
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>W1 (1ì£¼ì°¨):</b> ì‚¬ì „ ì¤€ë¹„ ë° ê¸°íšì•ˆ í™•ì •</li>
                  <li><b>W2 (2ì£¼ì°¨):</b> ë³¸ê²© ì‹¤í–‰ ë° 1ì°¨ ë°°í¬</li>
                  <li><b>W3 (3ì£¼ì°¨):</b> ê²°ê³¼ ë°ì´í„° ì¸¡ì • ë° í”¼ë“œë°±</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td colspan="2" style="vertical-align: top; border: 1px solid #cbd5e1; padding: 20px; background: #f0fdf4;">
              <h3 style="margin: 0 0 12px 0; color: #16a34a; font-size: 1.15rem; border-bottom: 2px solid #bbf7d0; padding-bottom: 8px;">
                5. ê¸°ëŒ€ íš¨ê³¼ ë° ì†Œìš” ì˜ˆì‚° (Expected Effect / ROI)
              </h3>
              <ul style="padding-left: 20px; margin: 0; font-size: 1rem; color: #333; line-height: 1.8;">
                  <li><b>ì •ëŸ‰ì  íš¨ê³¼:</b> ë§¤ì¶œ X% ì¦ëŒ€, ë¦¬ë“œíƒ€ì„ Yì‹œê°„ ë‹¨ì¶• ë“± (ìˆ˜ì¹˜í™” í•„ìˆ˜)</li>
                  <li><b>ì •ì„±ì  íš¨ê³¼:</b> ê³ ê° ê²½í—˜ ê°œì„ , ì—…ë¬´ íš¨ìœ¨ì„± ì¦ëŒ€ ë“±</li>
                  <li><b>ì†Œìš” ì˜ˆì‚° / í•„ìš” ìì›:</b> íˆ¬ì…ë˜ì–´ì•¼ í•  ì¸ë ¥ ë° ì˜ˆì‚°</li>
              </ul>
            </td>
          </tr>
        </table>
      </div>
    `;

    openDocModal(null, "[ê¸°íšì„œ] ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ê¸°íš", htmlTemplate, 'ê¸°íšì„œ');
  }

  
  async function deleteDoc(id) {
    if(!confirm("ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë“œë¼ì´ë¸Œì˜ ì›ë³¸ HTML íŒŒì¼ì€ ë³´ì¡´ë©ë‹ˆë‹¤)")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) });
      await loadAllData();
    } catch(e) { alert("ì‚­ì œ ì˜¤ë¥˜"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  (function showVersion() {
    const el = document.getElementById("sysVersion");
    if (!el) return;
    const d = new Date(document.lastModified);
    const pad = (n) => String(n).padStart(2, '0');
    el.textContent = `Version: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [ìˆ˜ì •]`;
  })();
</script>

</body>
</html>
