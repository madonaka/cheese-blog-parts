<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>예산 항목 · Cheese Admin</title>

  <!-- 공통 관리자 스타일 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* 이 페이지 전용 스타일 (prefix: budget-) */

    .budget-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: end;
      margin: 0 0 1rem;
    }

    .budget-field {
      display: grid;
      gap: 0.35rem;
      min-width: 180px;
    }

    .budget-field label {
      font-size: 0.85rem;
      color: #475569;
      font-weight: 600;
    }

    .budget-field select,
    .budget-field input {
      height: 40px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      padding: 0 0.75rem;
      background: #fff;
      outline: none;
    }

    .budget-actions {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }

    .budget-btn {
      height: 40px;
      padding: 0 0.9rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    .budget-btn.primary {
      border-color: transparent;
      background: #111827;
      color: #fff;
    }

    .budget-kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.75rem;
      margin: 0 0 1rem;
    }

    .budget-kpi {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 0.9rem 1rem;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    .budget-kpi .k {
      color: #64748b;
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 0.35rem;
    }

    .budget-kpi .v {
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: #0f172a;
    }

    .budget-panels {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 0.75rem;
      align-items: start;
    }

    .budget-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
    }

    .budget-card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin: 0 0 0.75rem;
    }

    .budget-card-title h3 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 900;
      letter-spacing: -0.02em;
      color: #0f172a;
    }

    .budget-hint {
      margin: 0;
      color: #64748b;
      font-size: 0.88rem;
      line-height: 1.45;
    }

    /* ====== 막대 차트 (외부 라이브러리 없이) ====== */
    .budget-bars {
      display: grid;
      gap: 0.5rem;
      margin-top: 0.8rem;
    }

    .budget-bar {
      display: grid;
      grid-template-columns: 180px 1fr 120px;
      gap: 0.75rem;
      align-items: center;
    }

    .budget-bar .label {
      font-weight: 800;
      color: #0f172a;
      font-size: 0.92rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .budget-bar .track {
      height: 14px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      overflow: hidden;
      position: relative;
    }

    .budget-bar .fill {
      height: 100%;
      width: 0;
      background: #111827;
      border-radius: 999px;
      transition: width 260ms ease;
    }

    .budget-bar .value {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      color: #0f172a;
      font-size: 0.92rem;
    }

    /* ====== 표 ====== */
    .budget-table-wrap {
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
    }

    .budget-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
      background: #fff;
    }

    .budget-table th,
    .budget-table td {
      padding: 0.75rem 0.8rem;
      border-bottom: 1px solid #e2e8f0;
      vertical-align: top;
      font-size: 0.92rem;
    }

    .budget-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f8fafc;
      color: #334155;
      font-weight: 900;
      text-align: left;
    }

    .budget-table td.mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.86rem;
    }

    .budget-table td.right {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
    }

    .budget-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.18rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #0f172a;
      font-weight: 900;
      font-size: 0.82rem;
      white-space: nowrap;
    }

    .budget-empty {
      padding: 0.75rem;
      color: #64748b;
      font-size: 0.92rem;
    }

    @media (max-width: 1100px) {
      .budget-panels { grid-template-columns: 1fr; }
      .budget-kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .budget-bar { grid-template-columns: 1fr; gap: 0.35rem; }
      .budget-bar .value { text-align: left; }
    }

    @media (max-width: 640px) {
      .budget-kpis { grid-template-columns: 1fr; }
      .budget-actions { margin-left: 0; width: 100%; }
      .budget-actions .budget-btn { flex: 1; }
      .budget-field { min-width: 0; width: 100%; }
    }
  </style>
</head>

<body data-page="budgets">
  <div class="admin-shell">
    <!-- 좌측 메뉴 -->
    <aside class="admin-sidebar">
      <div id="admin-menu-slot"></div>
    </aside>

    <main class="admin-main">
      <!-- 상단 헤더 -->
      <div id="admin-header-slot"></div>

      <!-- 본문 -->
      <section class="admin-content">
        <div class="budget-toolbar">
          <div class="budget-field">
            <label for="budget-year">년도</label>
            <select id="budget-year"></select>
          </div>

          <div class="budget-field">
            <label for="budget-dept">부서</label>
            <select id="budget-dept"></select>
          </div>

          <div class="budget-field" style="min-width:260px;">
            <label for="budget-q">검색 (예산ID/카테고리/메모)</label>
            <input id="budget-q" type="text" placeholder="예: 클라우드, AWS, 임차료..." />
          </div>

          <div class="budget-actions">
            <button class="budget-btn" id="btn-reset" type="button">초기화</button>
            <button class="budget-btn primary" id="btn-reload" type="button">새로고침</button>
          </div>
        </div>

        <div class="budget-kpis">
          <div class="budget-kpi"><div class="k">총 예산</div><div class="v" id="kpi-total">-</div></div>
          <div class="budget-kpi"><div class="k">예산 항목 수</div><div class="v" id="kpi-count">-</div></div>
          <div class="budget-kpi"><div class="k">부서 수</div><div class="v" id="kpi-depts">-</div></div>
          <div class="budget-kpi"><div class="k">카테고리 수</div><div class="v" id="kpi-cats">-</div></div>
        </div>

        <div class="budget-panels">
          <div class="budget-card">
            <div class="budget-card-title">
              <h3 id="chart-title">부서별 예산 비중</h3>
              <span class="budget-badge" id="chart-badge">대상: 전체</span>
            </div>
            <p class="budget-hint">
              막대는 선택된 조건(년도/부서/검색) 기준으로 자동 집계됩니다. (라이브러리 없이 동작)
            </p>
            <div class="budget-bars" id="chart-bars"></div>
            <div class="budget-empty" id="chart-empty" style="display:none;">표시할 데이터가 없습니다.</div>
          </div>

          <div class="budget-card">
            <div class="budget-card-title">
              <h3>요약</h3>
              <span class="budget-badge" id="summary-badge">-</span>
            </div>
            <p class="budget-hint" id="summary-text">-</p>
            <div style="height:0.5rem"></div>
            <div class="budget-table-wrap">
              <table class="budget-table" style="min-width: 520px;">
                <thead>
                  <tr>
                    <th>구분</th>
                    <th style="width:120px;">항목 수</th>
                    <th style="width:140px;">합계</th>
                  </tr>
                </thead>
                <tbody id="summary-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="height: 0.9rem"></div>

        <div class="budget-card">
          <div class="budget-card-title">
            <h3>예산 항목 목록</h3>
            <span class="budget-badge" id="list-badge">-</span>
          </div>

          <div class="budget-table-wrap">
            <table class="budget-table">
              <thead>
                <tr>
                  <th style="width: 190px;">예산ID</th>
                  <th style="width: 90px;">년도</th>
                  <th style="width: 120px;">부서</th>
                  <th style="width: 180px;">카테고리</th>
                  <th style="width: 140px;">예산액</th>
                  <th>메모</th>
                </tr>
              </thead>
              <tbody id="budget-tbody"></tbody>
            </table>
          </div>

          <div class="budget-empty" id="list-empty" style="display:none;">조건에 맞는 항목이 없습니다.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- 공통 스크립트 -->
  <script>
    // ✅ 너의 Apps Script Web App URL로 교체
    const API_BASE = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
    window.CHEESE_ADMIN_API_BASE = API_BASE;

    // (권장) 이 페이지 접근 권한
    window.CHEESE_ADMIN_REQUIRED_ROLES = ['MGR','FIN','ADMIN'];

    // 좌측 메뉴 active 처리
    window.CHEESE_ADMIN_ACTIVE_PAGE = 'budgets';

    // 헤더 텍스트
    window.CHEESE_ADMIN_HEADER_TITLE = '예산 항목';
    window.CHEESE_ADMIN_HEADER_SUBTITLE = '부서/카테고리별 예산을 한눈에';
    window.CHEESE_ADMIN_HEADER_BADGE = 'budgets';
  </script>
  <script src="./admin-common.js"></script>

  <script>
    const elYear = document.getElementById('budget-year');
    const elDept = document.getElementById('budget-dept');
    const elQ    = document.getElementById('budget-q');

    const elKpiTotal = document.getElementById('kpi-total');
    const elKpiCount = document.getElementById('kpi-count');
    const elKpiDepts = document.getElementById('kpi-depts');
    const elKpiCats  = document.getElementById('kpi-cats');

    const elChartTitle = document.getElementById('chart-title');
    const elChartBadge = document.getElementById('chart-badge');
    const elChartBars  = document.getElementById('chart-bars');
    const elChartEmpty = document.getElementById('chart-empty');

    const elSummaryBadge = document.getElementById('summary-badge');
    const elSummaryText  = document.getElementById('summary-text');
    const elSummaryBody  = document.getElementById('summary-body');

    const elListBadge = document.getElementById('list-badge');
    const elTbody     = document.getElementById('budget-tbody');
    const elListEmpty = document.getElementById('list-empty');

    const btnReload = document.getElementById('btn-reload');
    const btnReset  = document.getElementById('btn-reset');

    let RAW = [];

    function won(n) {
      const v = Number(n || 0);
      return v.toLocaleString('ko-KR') + '원';
    }

    function safeStr(x) { return (x == null) ? '' : String(x); }

    function pickYears(rows) {
      const years = Array.from(new Set(rows.map(r => safeStr(r.year).trim()).filter(Boolean))).sort();
      return years;
    }

    function pickDepts(rows, year) {
      const list = rows
        .filter(r => !year || safeStr(r.year).trim() === year)
        .map(r => safeStr(r.department).trim())
        .filter(Boolean);
      return Array.from(new Set(list)).sort();
    }

    function matchQuery(row, q) {
      if (!q) return true;
      const t = q.toLowerCase();
      const hay = [row.budget_id, row.category, row.memo, row.department, row.year]
        .map(safeStr)
        .join(' ')
        .toLowerCase();
      return hay.includes(t);
    }

    function currentFilter() {
      const year = elYear.value === '__ALL__' ? '' : elYear.value;
      const dept = elDept.value === '__ALL__' ? '' : elDept.value;
      const q = safeStr(elQ.value).trim();
      return { year, dept, q };
    }

    function applyFilter(rows) {
      const { year, dept, q } = currentFilter();
      return rows.filter(r => {
        if (year && safeStr(r.year).trim() !== year) return false;
        if (dept && safeStr(r.department).trim() !== dept) return false;
        if (!matchQuery(r, q)) return false;
        return true;
      });
    }

    function groupSum(rows, keyFn) {
      const map = new Map();
      for (const r of rows) {
        const k = keyFn(r);
        const amt = Number(r.budget_amount || 0);
        map.set(k, (map.get(k) || 0) + amt);
      }
      return Array.from(map.entries()).map(([k, sum]) => ({ k, sum }));
    }

    function renderBars(items) {
      elChartBars.innerHTML = '';
      const max = Math.max(0, ...items.map(x => x.sum));
      if (!items.length || max <= 0) {
        elChartEmpty.style.display = 'block';
        return;
      }
      elChartEmpty.style.display = 'none';

      for (const it of items) {
        const row = document.createElement('div');
        row.className = 'budget-bar';
        row.innerHTML = `
          <div class="label" title="${escapeHtml(it.k)}">${escapeHtml(it.k)}</div>
          <div class="track"><div class="fill"></div></div>
          <div class="value">${won(it.sum)}</div>
        `;
        elChartBars.appendChild(row);
        const fill = row.querySelector('.fill');
        const pct = (it.sum / max) * 100;
        requestAnimationFrame(() => { fill.style.width = pct.toFixed(2) + '%'; });
      }
    }

    function escapeHtml(str) {
      return safeStr(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderList(rows) {
      elTbody.innerHTML = '';
      if (!rows.length) {
        elListEmpty.style.display = 'block';
        elListBadge.textContent = '0건';
        return;
      }
      elListEmpty.style.display = 'none';
      elListBadge.textContent = rows.length.toLocaleString('ko-KR') + '건';

      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${escapeHtml(r.budget_id)}</td>
          <td>${escapeHtml(r.year)}</td>
          <td>${escapeHtml(r.department)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td class="right">${won(r.budget_amount)}</td>
          <td>${escapeHtml(r.memo || '')}</td>
        `;
        elTbody.appendChild(tr);
      }
    }

    function renderKPIs(rowsAllYear) {
      const total = rowsAllYear.reduce((a, r) => a + Number(r.budget_amount || 0), 0);
      const depts = new Set(rowsAllYear.map(r => safeStr(r.department).trim()).filter(Boolean));
      const cats  = new Set(rowsAllYear.map(r => safeStr(r.category).trim()).filter(Boolean));

      elKpiTotal.textContent = won(total);
      elKpiCount.textContent = rowsAllYear.length.toLocaleString('ko-KR') + '건';
      elKpiDepts.textContent = depts.size.toLocaleString('ko-KR') + '개';
      elKpiCats.textContent  = cats.size.toLocaleString('ko-KR') + '개';
    }

    function renderSummary(rows) {
      const byDept = groupSum(rows, r => safeStr(r.department).trim() || '(미지정)')
        .sort((a, b) => b.sum - a.sum);

      const byCat = groupSum(rows, r => safeStr(r.category).trim() || '(미지정)')
        .sort((a, b) => b.sum - a.sum);

      const total = rows.reduce((a, r) => a + Number(r.budget_amount || 0), 0);

      elSummaryBadge.textContent = won(total);
      elSummaryText.textContent = `부서 ${new Set(rows.map(r => safeStr(r.department).trim()).filter(Boolean)).size}개, 카테고리 ${new Set(rows.map(r => safeStr(r.category).trim()).filter(Boolean)).size}개 기준으로 집계된 요약입니다.`;

      // 표는 상위 6개 부서 + 상위 6개 카테고리
      const topDept = byDept.slice(0, 6);
      const topCat  = byCat.slice(0, 6);

      elSummaryBody.innerHTML = '';

      const addRow = (label, cnt, sum) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(label)}</td>
          <td class="right">${cnt.toLocaleString('ko-KR')}건</td>
          <td class="right">${won(sum)}</td>
        `;
        elSummaryBody.appendChild(tr);
      };

      for (const d of topDept) {
        const cnt = rows.filter(r => safeStr(r.department).trim() === d.k).length;
        addRow('부서 · ' + d.k, cnt, d.sum);
      }
      for (const c of topCat) {
        const cnt = rows.filter(r => safeStr(r.category).trim() === c.k).length;
        addRow('카테고리 · ' + c.k, cnt, c.sum);
      }

      // 막대 차트는 "부서별"을 기본. 단, 부서를 선택하면 "카테고리별"로 전환
      const { dept } = currentFilter();
      if (dept) {
        elChartTitle.textContent = '카테고리별 예산 비중';
        elChartBadge.textContent = '대상: ' + dept;
        const items = groupSum(rows, r => safeStr(r.category).trim() || '(미지정)')
          .sort((a, b) => b.sum - a.sum);
        renderBars(items);
      } else {
        elChartTitle.textContent = '부서별 예산 비중';
        elChartBadge.textContent = '대상: 전체';
        const items = groupSum(rows, r => safeStr(r.department).trim() || '(미지정)')
          .sort((a, b) => b.sum - a.sum);
        renderBars(items);
      }
    }

    function refreshUI() {
      const { year } = currentFilter();
      const rowsForYear = year ? RAW.filter(r => safeStr(r.year).trim() === year) : RAW;
      const filtered = applyFilter(RAW);

      // KPI는 (년도 선택만 반영) / 목록은 전체 필터 반영
      renderKPIs(rowsForYear);
      renderSummary(filtered);
      renderList(filtered);

      // 부서 드롭다운은 년도에 따라 갱신
      rebuildDeptOptions();
    }

    function rebuildYearOptions() {
      const years = pickYears(RAW);
      elYear.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__ALL__';
      optAll.textContent = '전체';
      elYear.appendChild(optAll);

      for (const y of years) {
        const o = document.createElement('option');
        o.value = y;
        o.textContent = y;
        elYear.appendChild(o);
      }

      // 기본값: 가장 최신 연도(마지막)
      if (years.length) {
        elYear.value = years[years.length - 1];
      }
    }

    function rebuildDeptOptions() {
      const year = elYear.value === '__ALL__' ? '' : elYear.value;
      const depts = pickDepts(RAW, year);
      const prev = elDept.value;

      elDept.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '__ALL__';
      optAll.textContent = '전체';
      elDept.appendChild(optAll);

      for (const d of depts) {
        const o = document.createElement('option');
        o.value = d;
        o.textContent = d;
        elDept.appendChild(o);
      }

      // 기존 선택 유지 (가능하면)
      if (prev && prev !== '__ALL__' && depts.includes(prev)) {
        elDept.value = prev;
      } else {
        elDept.value = '__ALL__';
      }
    }

    async function apiGet_(mode) {
      const url = new URL(API_BASE);
      url.searchParams.set('mode', mode);

      // 토큰이 있으면 헤더로 넣음 (없어도 동작하도록)
      const token = localStorage.getItem('CHEESE_ADMIN_TOKEN') || '';
      const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

      const res = await fetch(url.toString(), { method: 'GET', headers });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (!data || data.ok !== true) {
        throw new Error((data && data.message) ? data.message : 'API 응답이 ok가 아닙니다.');
      }
      return data;
    }

    async function loadBudgets() {
      // budgets 응답 형태: {ok:true, items:[...]}
      const data = await apiGet_('budgets');
      RAW = Array.isArray(data.items) ? data.items : [];

      // 숫자 normalize
      RAW = RAW.map(r => ({
        budget_id: safeStr(r.budget_id).trim(),
        year: safeStr(r.year).trim(),
        department: safeStr(r.department).trim(),
        category: safeStr(r.category).trim(),
        budget_amount: Number(r.budget_amount || 0),
        memo: safeStr(r.memo).trim()
      }));

      rebuildYearOptions();
      rebuildDeptOptions();
      refreshUI();
    }

    function resetFilters() {
      elQ.value = '';
      elDept.value = '__ALL__';
      refreshUI();
    }

    // 이벤트
    elYear.addEventListener('change', () => {
      // 연도 바뀌면 부서 선택은 초기화(강제)
      elDept.value = '__ALL__';
      refreshUI();
    });

    elDept.addEventListener('change', refreshUI);
    elQ.addEventListener('input', () => {
      // 너무 잦은 렌더링은 피하고 싶으면 debounce 가능
      refreshUI();
    });

    btnReload.addEventListener('click', async () => {
      btnReload.disabled = true;
      btnReload.textContent = '불러오는 중...';
      try {
        await loadBudgets();
      } catch (err) {
        alert('불러오기 실패: ' + (err && err.message ? err.message : String(err)));
      } finally {
        btnReload.disabled = false;
        btnReload.textContent = '새로고침';
      }
    });

    btnReset.addEventListener('click', resetFilters);

    // 시작
    (async () => {
      try {
        await loadBudgets();
      } catch (err) {
        console.error(err);
        alert('불러오기 실패: ' + (err && err.message ? err.message : String(err)));
      }
    })();
  </script>
</body>
</html>
