<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>재직증명서 발급 · Cheese Lab Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 관리자 공통 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* 이 페이지 전용으로 필요한 것만 약간 추가 */
    .cert-note {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    .cert-result {
      margin-top: 1rem;
      padding: 0.85rem 0.9rem;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.88rem;
      display: none;
    }

    .cert-result-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 0.3rem;
    }

    .cert-result-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .cert-result-tag {
      font-size: 0.75rem;
      padding: 0.05rem 0.6rem;
      border-radius: 999px;
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .cert-result-body {
      color: #4b5563;
      margin-bottom: 0.5rem;
    }

    .cert-result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .cert-alert {
      margin-top: 0.9rem;
      padding: 0.8rem 0.85rem;
      border-radius: 0.75rem;
      border: 1px solid #fecaca;
      background: #fef2f2;
      font-size: 0.85rem;
      color: #b91c1c;
      display: none;
      white-space: pre-line;
    }

    .cert-status {
      font-size: 0.8rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      min-height: 1.2rem;
    }

    .cert-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .cert-status.is-loading .cert-status-dot {
      animation: cert-pulse 1.2s infinite ease-in-out;
      background: #2563eb;
    }

    @keyframes cert-pulse {
      0%, 100% { transform: scale(1); opacity: 0.35; }
      50% { transform: scale(1.4); opacity: 0.9; }
    }
  </style>
</head>
<body>
  <div class="admin-shell">
    <!-- 헤더 슬롯 (admin-common.js에서 채움) -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- 왼쪽 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- 오른쪽 메인 내용 -->
      <main>
        <!-- 이 페이지 고유 섹션 -->
        <section class="admin-section active" data-section="employmentCert">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">재직증명서 발급</div>
                <div class="card-subtitle">
                  직원번호와 발급 용도를 입력하면, 구글 드라이브에 PDF 재직증명서를 생성합니다.
                </div>
                <p class="cert-note">
                  · 재직 상태인 직원만 발급 가능하며, 발급 이력은 <code>issued_cert</code> 시트에 저장됩니다.
                </p>
              </div>
            </div>

            <!-- 입력 폼 -->
            <form id="certForm">
              <div class="field-row">
                <div class="field">
                  <label for="employeeId">직원번호</label>
                  <input
                    id="employeeId"
                    name="employeeId"
                    type="text"
                    placeholder="예: CL25-0001"
                    autocomplete="off"
                    required
                  />
                </div>

                <div class="field">
                  <label for="purpose">발급 용도 (선택)</label>
                  <select id="purpose" name="purpose">
                    <option value="">선택 안 함</option>
                    <option value="은행제출">은행 제출용</option>
                    <option value="비자신청">비자 신청용</option>
                    <option value="입사지원">입사 지원용</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
              </div>

              <div class="field-row" style="justify-content: space-between; align-items: center; margin-top: 0.75rem;">
                <div id="cert-status" class="cert-status">
                  <span class="cert-status-dot"></span>
                  준비되었습니다.
                </div>

                <button type="submit" id="btn-issue-cert" class="btn btn-primary">
                  <span id="btn-issue-text">재직증명서 발급</span>
                </button>
              </div>
            </form>

            <!-- 에러 알림 -->
            <div id="cert-alert" class="cert-alert"></div>

            <!-- 발급 결과 -->
            <div id="cert-result" class="cert-result">
              <div class="cert-result-header">
                <div class="cert-result-title" id="cert-result-title"></div>
                <div class="cert-result-tag">발급 완료</div>
              </div>
              <div class="cert-result-body" id="cert-result-body"></div>
              <div class="cert-result-actions">
                <a href="#" id="cert-pdf-link" target="_blank" rel="noopener noreferrer" class="btn btn-ghost">
                  PDF 열기
                </a>
                <button type="button" id="btn-copy-link" class="btn">
                  링크 복사
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 페이지별 제목/뱃지 설정 (헤더/메뉴용) -->
  <script>
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "재직증명서 발급";
    window.CHEESE_ADMIN_PAGE_BADGE    = "employment";
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "employmentCert";
  </script>

  <!-- API 베이스 주소 -->
  <script>
    window.CHEESE_ADMIN_API_BASE =
      "https://script.google.com/macros/s/AKfycbxZDeXrK5LZQPpK1Qfs9WdDdIznqDQpxl-uQyT5Fq-Sgxrs1LW8BrhznCdO6WynKXshDQ/exec";
  </script>

  <!-- 헤더/메뉴 공통 스크립트 -->
  <script src="./admin-common.js"></script>

  <!-- 이 페이지 전용 스크립트 -->
  <script>
    const form          = document.getElementById('certForm');
    const btnIssue      = document.getElementById('btn-issue-cert');
    const btnIssueText  = document.getElementById('btn-issue-text');
    const statusEl      = document.getElementById('cert-status');
    const alertBox      = document.getElementById('cert-alert');
    const resultBox     = document.getElementById('cert-result');
    const resultTitleEl = document.getElementById('cert-result-title');
    const resultBodyEl  = document.getElementById('cert-result-body');
    const pdfLinkEl     = document.getElementById('cert-pdf-link');
    const btnCopyLink   = document.getElementById('btn-copy-link');

    function setLoading(isLoading, message) {
      if (isLoading) {
        btnIssue.disabled = true;
        btnIssueText.textContent = '발급 중...';
        statusEl.classList.add('is-loading');
        statusEl.innerHTML =
          '<span class="cert-status-dot"></span>' +
          (message || '재직증명서를 발급하는 중입니다...');
      } else {
        btnIssue.disabled = false;
        btnIssueText.textContent = '재직증명서 발급';
        statusEl.classList.remove('is-loading');
        statusEl.innerHTML =
          '<span class="cert-status-dot"></span>준비되었습니다.';
      }
    }

    function showError(message) {
      alertBox.textContent = message || '알 수 없는 오류가 발생했습니다.';
      alertBox.style.display = 'block';
      resultBox.style.display = 'none';
    }

    function clearError() {
      alertBox.style.display = 'none';
      alertBox.textContent = '';
    }

    function showResult(data) {
      if (!data) return;

      const empId = data.employeeId || '';
      const name  = data.name || '';
      const url   = data.fileUrl || '#';

      resultTitleEl.textContent = `${name} (${empId})`;
      resultBodyEl.textContent =
        'PDF 재직증명서가 생성되었습니다. 링크를 눌러 문서를 확인하거나, 링크를 복사해 제출처에 전달할 수 있습니다.';
      pdfLinkEl.href = url;

      resultBox.style.display = 'block';
      alertBox.style.display  = 'none';

      statusEl.innerHTML =
        '<span class="cert-status-dot"></span>마지막 발급: ' +
        new Date().toLocaleString();
    }

    async function handleSubmit(event) {
      event.preventDefault();
      clearError();
      resultBox.style.display = 'none';

      const employeeId = document.getElementById('employeeId').value.trim();
      const purpose    = document.getElementById('purpose').value.trim();

      if (!employeeId) {
        showError('직원번호를 입력해주세요.');
        return;
      }

      setLoading(true);

      try {
        const params = new URLSearchParams({
          mode: 'employmentCert',
          employeeId: employeeId
        });
        if (purpose) params.append('purpose', purpose);

        const url = window.CHEESE_ADMIN_API_BASE + '?' + params.toString();

        const res = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }

        const data = await res.json();

        if (!data.ok) {
          const msg =
            (data.message || '') +
            (data.detail && typeof data.detail === 'string'
              ? '\n' + data.detail
              : '');
          showError(msg || '발급 처리 중 오류가 발생했습니다.');
        } else {
          showResult(data);
        }
      } catch (err) {
        showError('통신 중 오류가 발생했습니다.\n\n' + String(err));
      } finally {
        setLoading(false);
      }
    }

    form.addEventListener('submit', handleSubmit);

    btnCopyLink.addEventListener('click', async () => {
      const url = pdfLinkEl.href;
      if (!url || url === '#') return;

      try {
        await navigator.clipboard.writeText(url);
        btnCopyLink.textContent = '복사 완료!';
        setTimeout(() => {
          btnCopyLink.textContent = '링크 복사';
        }, 1500);
      } catch (err) {
        alert('클립보드 복사에 실패했습니다.\nURL: ' + url);
      }
    });
  </script>
</body>
</html>
