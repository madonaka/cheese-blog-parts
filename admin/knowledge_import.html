<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knowledge DB · Import</title>

  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "knowledge_import";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "Knowledge DB";
    window.CHEESE_ADMIN_PAGE_BADGE    = "Import";
  </script>

  <link rel="stylesheet" href="./admin.css" />
  <script defer src="./admin-common.js"></script>

  <style>
    .admin-main, .notice-wrap { height:auto !important; min-height:0 !important; }
    .notice-wrap { overflow:visible !important; padding-bottom:24px !important; }

    .card{
      background:#fff; border:1px solid rgba(15,23,42,.10);
      border-radius:18px; box-shadow:0 10px 28px rgba(15,23,42,.10);
      overflow:hidden; margin-bottom:14px;
    }
    .h{ padding:14px 14px 12px; border-bottom:1px solid rgba(15,23,42,.10); }
    .h-title{ margin:0; font-size:16px; font-weight:900; color:#0f172a; }
    .h-desc{ margin:6px 0 0; font-size:12px; color:#64748b; line-height:1.4; }

    .body{ padding:14px; display:grid; gap:12px; }
    .label{ font-size:12px; font-weight:900; color:#0f172a; }
    .input, .select, .textarea{
      width:100%;
      border:1px solid rgba(15,23,42,.14);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      background:#fff; color:#0f172a;
    }
    .textarea{
      min-height:220px; resize:vertical; line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .tools{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      padding:12px 14px; border-top:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
    }
    .btn{
      height:34px; border-radius:12px; border:1px solid rgba(15,23,42,.14);
      background:#fff; padding:0 12px; font-size:13px; font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none;
    }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900;
      background:rgba(15,23,42,.06); color:#0f172a;
      white-space:nowrap;
      border:1px solid rgba(15,23,42,.10);
    }
    .pill input{ transform: translateY(1px); }

    .muted{ font-size:12px; color:#64748b; }
    .err{
      padding:10px 14px; color:#b91c1c; background:rgba(185,28,28,.06);
      border-top:1px solid rgba(185,28,28,.18);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
    .ok{
      padding:10px 14px; color:#166534; background:rgba(22,101,52,.06);
      border-top:1px solid rgba(22,101,52,.18);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }

    .mini{
      margin-top:6px;
      font-size:12px; color:#475569;
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.10);
      border-radius:12px;
      padding:10px 12px;
      overflow:auto;
      max-height:220px;
      white-space:pre;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="notice-wrap">
        <section class="card">
          <div class="h">
            <p class="h-title">Import (대량입력)</p>
            <p class="h-desc">
              CSV/TSV 붙여넣기 → 미리보기(검증) → OK만 Firestore 반영(JSONP).
            </p>
          </div>

          <div class="body">
            <div class="grid2">
              <div>
                <div class="label">API Base (exec)</div>
                <input id="api" class="input" />
                <div class="muted">URL 파라미터 <b>api</b>가 있으면 우선 적용됩니다.</div>
              </div>

              <div>
                <div class="label">관리 토큰(반영용)</div>
                <input id="token" class="input" placeholder="ADMIN_TOKEN" />
                <div class="muted">브라우저에 저장(localStorage).</div>
              </div>
            </div>

            <div class="grid2">
              <div>
                <div class="label">포맷</div>
                <select id="format" class="select">
                  <option value="csv" selected>CSV (comma ,)</option>
                  <option value="tsv">TSV (tab)</option>
                </select>
              </div>

              <div>
                <div class="label">샘플 헤더</div>
                <div class="mini" id="sample"></div>
              </div>
            </div>

            <div>
              <div class="label">붙여넣기</div>
              <textarea id="text" class="textarea" placeholder="여기에 CSV/TSV를 그대로 붙여넣기"></textarea>
              <div class="muted">필수: sortStart(YYYY-MM-DD), title, domain</div>
            </div>

            <div>
              <div class="label">미리보기 결과</div>
              <div class="mini" id="preview">아직 실행 전</div>
            </div>
          </div>

          <div class="tools">
            <button id="btnPreview" class="btn">미리보기</button>
            <button id="btnCommit" class="btn primary">반영</button>

            <label class="pill" title="체크하면 실제 반영 없이 검증/처리 결과만 반환합니다.">
              <input id="dryRun" type="checkbox" />
              dryRun (미반영 테스트)
            </label>

            <a class="btn" href="./knowledge_db_hub.html" style="margin-left:auto;">허브로</a>
            <a class="btn" href="./knowledge_library.html">Library</a>
          </div>

          <div id="ok" class="ok"></div>
          <div id="err" class="err"></div>
        </section>

        <script>
          // ✅ 네 exec URL 기본값
          const API_BASE_DEFAULT =
            "https://script.google.com/macros/s/AKfycbxowBj0yNZHZVjamJhn3tk9I8GoWSWMr67i2wVkjBF9aSEqNjbanbmyLa0qKYRtyZEMcw/exec";

          const $ = (id)=>document.getElementById(id);
          const ui = {
            api: $("api"),
            token: $("token"),
            format: $("format"),
            text: $("text"),
            sample: $("sample"),
            preview: $("preview"),
            btnPreview: $("btnPreview"),
            btnCommit: $("btnCommit"),
            dryRun: $("dryRun"),   // ✅ 존재함
            ok: $("ok"),
            err: $("err"),
          };

          let busy = false; // 중복 클릭 방지

          function setErr(msg){
            ui.err.style.display = msg ? "block" : "none";
            ui.err.textContent = msg || "";
          }
          function setOk(msg){
            ui.ok.style.display = msg ? "block" : "none";
            ui.ok.textContent = msg || "";
          }

          function getApiBase(){
            const usp = new URLSearchParams(location.search);
            return (usp.get("api") || "").trim()
              || ui.api.value.trim()
              || API_BASE_DEFAULT;
          }

          // ✅ JSONP (cb=... 자동 부착)
          function jsonp(url){
            return new Promise((resolve, reject)=>{
              const cb = "cb_" + Math.random().toString(36).slice(2);
              const s = document.createElement("script");
              const sep = url.includes("?") ? "&" : "?";
              s.src = url + sep + "cb=" + cb;
              s.async = true;

              const timeout = setTimeout(()=>{
                cleanup();
                reject(new Error("JSONP load error"));
              }, 20000);

              window[cb] = (data)=>{
                cleanup();
                resolve(data);
              };

              function cleanup(){
                clearTimeout(timeout);
                delete window[cb];
                if (s.parentNode) s.parentNode.removeChild(s);
              }

              s.onerror = ()=>{
                cleanup();
                reject(new Error("JSONP load error"));
              };

              document.body.appendChild(s);
            });
          }

          function sampleHeader(){
            return [
              "sortStart,displayDate,title,domain,eventType,importance,intraOrder,datePrecision,memo,entityName,entityType,role,confidence",
              "1927-01-01,1927년 1월,신간회 창립,정치,조직/인사,4,100,month,연표 항목,신간회,ORG,대상,확실"
            ].join("\\n");
          }

          // ✅ 미리보기(JSONP GET)
          async function preview(){
            if (busy) return;
            busy = true;

            setErr(""); setOk("");
            const api = getApiBase();
            const format = ui.format.value;
            const text = ui.text.value;

            ui.btnPreview.disabled = true;
            ui.btnCommit.disabled = true;

            try{
              if (!api) throw new Error("API Base가 비어 있습니다.");
              if (!text.trim()) throw new Error("텍스트가 비었습니다.");

              const url = api + "?" + new URLSearchParams({
                fn:"importPreview",
                format,
                text
              }).toString();

              const data = await jsonp(url);
              if (!data) throw new Error("응답이 비었습니다.");
              if (data.ok === false) throw new Error(data.message || "API 오류");

              ui.preview.textContent =
                `total=${data.total}\\nOK=${data.okCount} / NG=${data.ngCount}\\n\\n` +
                `[sampleOk]\\n${JSON.stringify(data.sampleOk||[], null, 2)}\\n\\n` +
                `[sampleNg]\\n${JSON.stringify(data.sampleNg||[], null, 2)}`;

              setOk("미리보기 완료");
            }catch(e){
              setErr(e.message || String(e));
            }finally{
              ui.btnPreview.disabled = false;
              ui.btnCommit.disabled = false;
              busy = false;
            }
          }

          // ✅ 반영(JSONP GET) : CORS/Failed to fetch 회피
          async function commit(){
            if (busy) return;
            busy = true;

            setErr(""); setOk("");

            const api = getApiBase();
            const token = ui.token.value.trim();
            const format = ui.format.value;
            const text = ui.text.value;
            const dryRun = ui.dryRun.checked ? "1" : "0";

            ui.btnPreview.disabled = true;
            ui.btnCommit.disabled = true;

            try{
              if (!api) throw new Error("API Base가 비어 있습니다.");
              if (!token) throw new Error("관리 토큰이 비었습니다.");
              if (!text.trim()) throw new Error("텍스트가 비었습니다.");

              const url = api + "?" + new URLSearchParams({
                fn:"importCommit",
                token,
                format,
                text,
                dryRun
              }).toString();

              const data = await jsonp(url);
              if (!data) throw new Error("응답이 비었습니다.");
              if (data.ok === false) throw new Error(data.message || "API 오류");

              localStorage.setItem("CHEESE_ADMIN_TOKEN", token);

              ui.preview.textContent =
                `total=${data.total}\nOK=${data.okCount} / NG=${data.ngCount}\ncommitted=${data.committed}\nfailed=${data.failed}\n` +
                `dryRun=${data.dryRun}\n\n` +
                `[results(첫 200건)]\n${JSON.stringify(data.results||[], null, 2)}`;

              setOk(dryRun === "1" ? "dryRun 완료(미반영)" : "반영 완료");
            }catch(e){
              setErr(e.message || String(e));
            }finally{
              ui.btnPreview.disabled = false;
              ui.btnCommit.disabled = false;
              busy = false;
            }
          }

          (function init(){
            ui.api.value = getApiBase();
            ui.sample.textContent = sampleHeader();

            const savedToken = localStorage.getItem("CHEESE_ADMIN_TOKEN") || "";
            if (savedToken) ui.token.value = savedToken;

            ui.text.value = sampleHeader();

            ui.btnPreview.addEventListener("click", preview);
            ui.btnCommit.addEventListener("click", commit);
          })();
        </script>
      </main>
    </div>
  </div>
</body>
</html>
