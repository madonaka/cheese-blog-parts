<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knowledge DB · Editor</title>

  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "knowledge_editor";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "Knowledge DB";
    window.CHEESE_ADMIN_PAGE_BADGE    = "Editor";
  </script>

  <link rel="stylesheet" href="./admin.css" />
  <script defer src="./admin-common.js"></script>

  <style>
    .admin-main, .notice-wrap { height:auto !important; min-height:0 !important; }
    .notice-wrap { overflow:visible !important; padding-bottom:24px !important; }

    .card{
      background:#fff; border:1px solid rgba(15,23,42,.10);
      border-radius:18px; box-shadow:0 10px 28px rgba(15,23,42,.10);
      overflow:hidden; margin-bottom:14px;
    }
    .h{ padding:14px 14px 12px; border-bottom:1px solid rgba(15,23,42,.10); }
    .h-title{ margin:0; font-size:16px; font-weight:900; color:#0f172a; }
    .h-desc{ margin:6px 0 0; font-size:12px; color:#64748b; line-height:1.4; }

    .body{ padding:14px; display:grid; gap:12px; }
    .row{ display:grid; gap:8px; }
    .label{ font-size:12px; font-weight:900; color:#0f172a; }
    .input, .select, .textarea{
      width:100%;
      border:1px solid rgba(15,23,42,.14);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      background:#fff; color:#0f172a;
    }
    .textarea{ min-height:120px; resize:vertical; line-height:1.45; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 860px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .tools{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      padding:12px 14px; border-top:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.02);
    }
    .btn{
      height:34px; border-radius:12px; border:1px solid rgba(15,23,42,.14);
      background:#fff; padding:0 12px; font-size:13px; font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none;
    }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900;
      background:rgba(15,23,42,.06); color:#0f172a;
      white-space:nowrap;
    }
    .muted{ font-size:12px; color:#64748b; }
    .err{
      padding:10px 14px; color:#b91c1c; background:rgba(185,28,28,.06);
      border-top:1px solid rgba(185,28,28,.18);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
    .ok{
      padding:10px 14px; color:#166534; background:rgba(22,101,52,.06);
      border-top:1px solid rgba(22,101,52,.18);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="notice-wrap">
        <section class="card">
          <div class="h">
            <p class="h-title">Editor (상세/수정)</p>
            <p class="h-desc">
              Library에서 선택한 id를 불러와 수정하고 저장합니다.
              <span class="pill">JSONP</span>
            </p>
          </div>

          <div class="body">
            <div class="row">
              <div class="label">API Base (exec)</div>
              <input id="api" class="input" />
              <div class="muted">URL 파라미터 api 가 있으면 우선 적용됩니다. (예: ?id=E...&api=...)</div>
            </div>

            <div class="grid2">
              <div class="row">
                <div class="label">문서 ID</div>
                <input id="id" class="input" placeholder="events/{id}" />
              </div>

              <div class="row">
                <div class="label">관리 토큰(저장용)</div>
                <input id="token" class="input" placeholder="ADMIN_TOKEN" />
                <div class="muted">브라우저에만 저장(localStorage). GitHub에 올릴 땐 주의.</div>
              </div>
            </div>

            <div class="row">
              <div class="label">제목</div>
              <input id="title" class="input" />
            </div>

            <div class="grid2">
              <div class="row">
                <div class="label">sortStart (YYYY-MM-DD)</div>
                <input id="sortStart" class="input" placeholder="1927-01-01" />
              </div>

              <div class="row">
                <div class="label">displayDate</div>
                <input id="displayDate" class="input" placeholder="1927년 1월" />
              </div>
            </div>

            <div class="grid2">
              <div class="row">
                <div class="label">domain</div>
                <input id="domain" class="input" placeholder="정치" />
              </div>

              <div class="row">
                <div class="label">eventType</div>
                <input id="eventType" class="input" placeholder="조직/인사" />
              </div>
            </div>

            <div class="grid2">
              <div class="row">
                <div class="label">datePrecision</div>
                <select id="datePrecision" class="select">
                  <option value="day">day</option>
                  <option value="month">month</option>
                  <option value="year">year</option>
                </select>
              </div>

              <div class="row">
                <div class="label">importance / intraOrder</div>
                <div style="display:flex; gap:8px;">
                  <input id="importance" class="input" style="width:120px;" type="number" min="0" max="5" />
                  <input id="intraOrder" class="input" style="width:160px;" type="number" min="0" />
                </div>
              </div>
            </div>

            <div class="row">
              <div class="label">memo</div>
              <textarea id="memo" class="textarea"></textarea>
            </div>
          </div>

          <div class="tools">
            <button id="btnLoad" class="btn">불러오기</button>
            <button id="btnSave" class="btn primary">저장</button>
            <a class="btn" href="./knowledge_library.html" style="margin-left:auto;">Library로</a>
            <a class="btn" href="./knowledge_db_hub.html">허브로</a>
          </div>

          <div id="ok" class="ok"></div>
          <div id="err" class="err"></div>
        </section>

        <script>
          const API_BASE_DEFAULT = "https://script.google.com/macros/s/AKfycbxowBj0yNZHZVjamJhn3tk9I8GoWSWMr67i2wVkjBF9aSEqNjbanbmyLa0qKYRtyZEMcw/exec";

          const $ = (id)=>document.getElementById(id);
          const ui = {
            api: $("api"),
            id: $("id"),
            token: $("token"),
            title: $("title"),
            sortStart: $("sortStart"),
            displayDate: $("displayDate"),
            domain: $("domain"),
            eventType: $("eventType"),
            datePrecision: $("datePrecision"),
            importance: $("importance"),
            intraOrder: $("intraOrder"),
            memo: $("memo"),
            btnLoad: $("btnLoad"),
            btnSave: $("btnSave"),
            ok: $("ok"),
            err: $("err"),
          };

          function setErr(msg){
            ui.err.style.display = msg ? "block" : "none";
            ui.err.textContent = msg || "";
          }
          function setOk(msg){
            ui.ok.style.display = msg ? "block" : "none";
            ui.ok.textContent = msg || "";
          }

          function getApiBase(){
            const usp = new URLSearchParams(location.search);
            return (usp.get("api") || "").trim()
              || ui.api.value.trim()
              || API_BASE_DEFAULT;
          }

          function jsonp(url){
            return new Promise((resolve, reject)=>{
              const cb = "cb_" + Math.random().toString(36).slice(2);
              const s = document.createElement("script");
              const sep = url.includes("?") ? "&" : "?";
              s.src = url + sep + "cb=" + cb;
              s.async = true;

              const timeout = setTimeout(()=>{
                cleanup();
                reject(new Error("JSONP load error"));
              }, 12000);

              window[cb] = (data)=>{
                cleanup();
                resolve(data);
              };

              function cleanup(){
                clearTimeout(timeout);
                delete window[cb];
                if (s.parentNode) s.parentNode.removeChild(s);
              }

              s.onerror = ()=>{
                cleanup();
                reject(new Error("JSONP load error"));
              };

              document.body.appendChild(s);
            });
          }

          function fillForm(it){
            ui.id.value = it.id || "";
            ui.title.value = it.title || "";
            ui.sortStart.value = it.sortStart || "";
            ui.displayDate.value = it.displayDate || "";
            ui.domain.value = it.domain || "";
            ui.eventType.value = it.eventType || "";
            ui.datePrecision.value = it.datePrecision || "day";
            ui.importance.value = (it.importance ?? 0);
            ui.intraOrder.value = (it.intraOrder ?? 0);
            ui.memo.value = it.memo || "";
          }

          function readForm(){
            return {
              id: ui.id.value.trim(),
              title: ui.title.value.trim(),
              sortStart: ui.sortStart.value.trim(),
              displayDate: ui.displayDate.value.trim(),
              domain: ui.domain.value.trim(),
              eventType: ui.eventType.value.trim(),
              datePrecision: ui.datePrecision.value,
              importance: Number(ui.importance.value || 0),
              intraOrder: Number(ui.intraOrder.value || 0),
              memo: ui.memo.value.trim(),
            };
          }

          async function loadEvent(){
            setErr(""); setOk("");
            const api = getApiBase();
            const usp = new URLSearchParams(location.search);
            const id = (ui.id.value.trim() || usp.get("id") || "").trim();
            if (!id) { setErr("id가 비었습니다."); return; }

            ui.btnLoad.disabled = true;
            try{
              const url = api + "?" + new URLSearchParams({ fn:"getEvent", id }).toString();
              const data = await jsonp(url);
              if (data.ok === false) throw new Error(data.message || "API 오류");
              fillForm(data.item || {});
              setOk("불러오기 완료");
            }catch(e){
              setErr(e.message || String(e));
            }finally{
              ui.btnLoad.disabled = false;
            }
          }

          async function saveEvent(){
            setErr(""); setOk("");
            const api = getApiBase();
            const token = ui.token.value.trim();
            const d = readForm();

            if (!d.id) return setErr("id가 비었습니다.");
            if (!token) return setErr("저장용 토큰이 비었습니다.");
            if (!/^\d{4}-\d{2}-\d{2}$/.test(d.sortStart)) return setErr("sortStart는 YYYY-MM-DD 형식이어야 합니다.");
            if (!d.title) return setErr("title이 비었습니다.");
            if (!d.domain) return setErr("domain이 비었습니다.");

            ui.btnSave.disabled = true;
            try{
              const url = api + "?" + new URLSearchParams({
                fn:"updateEvent",
                token,
                id: d.id,
                title: d.title,
                sortStart: d.sortStart,
                displayDate: d.displayDate,
                domain: d.domain,
                eventType: d.eventType,
                datePrecision: d.datePrecision,
                importance: String(d.importance),
                intraOrder: String(d.intraOrder),
                memo: d.memo
              }).toString();

              const data = await jsonp(url);
              if (data.ok === false) throw new Error(data.message || "API 오류");

              localStorage.setItem("CHEESE_ADMIN_TOKEN", token);
              setOk("저장 완료");
            }catch(e){
              setErr(e.message || String(e));
            }finally{
              ui.btnSave.disabled = false;
            }
          }

          // 초기 값
          (function init(){
            const usp = new URLSearchParams(location.search);
            ui.api.value = getApiBase();

            const id = (usp.get("id") || "").trim();
            if (id) ui.id.value = id;

            const savedToken = localStorage.getItem("CHEESE_ADMIN_TOKEN") || "";
            if (savedToken) ui.token.value = savedToken;

            ui.btnLoad.addEventListener("click", loadEvent);
            ui.btnSave.addEventListener("click", saveEvent);

            if (id) loadEvent();
          })();
        </script>
      </main>
    </div>
  </div>
</body>
</html>
