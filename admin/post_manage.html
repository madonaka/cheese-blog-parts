<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>포스트 관리</title>

  <!-- ✅ 메인 관리자 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    /* ===== page local styles ===== */
    .pm-wrap{ padding: 14px; }

    .pm-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }

    .pm-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .pm-label{ font-weight:800; }

    .pm-input, .pm-select{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:10px;
      min-width:280px;
      background:#fff;
    }

    .pm-title{ min-width:420px; }

    .pm-textarea{
      width:100%;
      min-height:420px;
      padding:12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;
      line-height:1.45;
    }

    .pm-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.18);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }

    .pm-btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .pm-btn.danger{ background:#b91c1c; color:#fff; border-color:#b91c1c; }

    .pm-muted{ color:#6b7280; font-size:13px; }
    .pm-status{ margin-top:10px; font-size:13px; }
    .pm-status.ok{ color:#047857; }
    .pm-status.err{ color:#b91c1c; }

    .pm-meta{ display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; margin-top:10px; }
    .pm-meta div{ padding:6px 0; }

    .pm-link{ color:#2563eb; font-weight:800; text-decoration:none; }

    .pm-pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.15);
      font-size:12px;
      margin-left:8px;
    }

    .pm-small{ font-size:12px; color:#6b7280; }

    .pm-banner{
      margin: 0 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185,28,28,0.25);
      background: rgba(185,28,28,0.06);
      color:#7f1d1d;
      font-weight:800;
      font-size:13px;
      display:none;
      white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="pm-wrap">
          <h2 style="margin:0 0 12px;">
            포스트 관리 <span class="pm-pill">Sheet DB + Drive HTML</span>
          </h2>

          <div id="banner" class="pm-banner"></div>

          <section class="pm-card">
            <div class="pm-row">
              <div class="pm-label">Post 선택</div>
              <select id="postSelect" class="pm-select"></select>

              <button id="btnRefresh" class="pm-btn">목록 새로고침</button>
              <button id="btnLoad" class="pm-btn primary">불러오기</button>
            </div>

            <div class="pm-row" style="margin-top:10px;">
              <div class="pm-label">ID</div>
              <input id="id" class="pm-input" type="text" placeholder="예: NM_20260121_01" disabled />
              <button id="btnSetFromSelect" class="pm-btn">선택값을 ID에 반영</button>
            </div>
            
            <div class="pm-row" style="margin-top:10px;">
              <div class="pm-label">분류</div>
              <select id="category" class="pm-select">
                <option value="">분류 선택...</option>
                <option value="monthly_news">주요 사건, 이슈, 뉴스 월별 총정리</option>
                <option value="timeline_kr_cn_jp">한국사+중국사+일본사 연표</option>
                <option value="genealogy_series">가계도시리즈</option>
                <option value="etc">기타</option>
                <option value="manual">수동입력</option>
              </select>
              <button id="btnRegenId" class="pm-btn">ID 새로 생성</button>
              <div class="pm-muted pm-small">※ 분류 선택 시 ID 자동생성. “수동입력”만 직접 입력 가능.</div>
            </div>


            <div id="status" class="pm-status pm-muted">준비됨</div>

            <div class="pm-meta">
              <div class="pm-muted">Drive fileId</div><div id="driveFileId" class="pm-muted">-</div>
              <div class="pm-muted">Drive url</div><div id="driveUrl" class="pm-muted">-</div>
              <div class="pm-muted">Updated</div><div id="updatedAt" class="pm-muted">-</div>
            </div>

            <div class="pm-row" style="margin-top:10px;">
              <a id="openDriveLink" class="pm-link" href="#" target="_blank" style="display:none;">Drive 파일 열기</a>
            </div>
          </section>

          <section class="pm-card">
            <div class="pm-row">
              <div class="pm-label">Title</div>
              <input id="title" class="pm-input pm-title" type="text" placeholder="글 제목" />
              <div class="pm-muted" id="charCount">0 chars</div>
            </div>

            <div style="margin-top:10px;">
              <div class="pm-label" style="margin-bottom:6px;">HTML</div>
              <textarea id="html" class="pm-textarea" placeholder="여기에 최종 HTML을 편집하세요"></textarea>
            </div>

            <div class="pm-row" style="margin-top:12px;">
              <button id="btnDriveUpsert" class="pm-btn">Drive로 저장/업데이트</button>
              <button id="btnDriveRead" class="pm-btn">Drive에서 불러오기</button>
              <button id="btnClear" class="pm-btn danger">편집창 비우기</button>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  let current = null;

  // ✅ 고정: Apps Script 주소
  const API_BASE =
    "https://script.google.com/macros/s/AKfycbzj5LUEUKMyQqJfVsVlftO1f4CTYb3NhAQMT2QL6VADBlnjleAXLtBVVhuVHOfwkhQYqQ/exec";

  function setStatus(msg, ok=true){
    const el = $("status");
    el.textContent = msg;
    el.className = "pm-status " + (ok ? "ok" : "err");
  }

  function showBanner(msg){
    const b = $("banner");
    b.textContent = msg;
    b.style.display = "block";
  }

  function setMeta(post){
    $("driveFileId").textContent = post.drive_file_id || "-";
    $("driveUrl").textContent = post.drive_url || "-";
    $("updatedAt").textContent = post.updated_at || "-";

    const link = $("openDriveLink");
    if (post.drive_url){
      link.href = post.drive_url;
      link.style.display = "inline";
    } else {
      link.style.display = "none";
    }
  }

  function syncCharCount(){
    $("charCount").textContent = ($("html").value || "").length + " chars";
  }
  $("html").addEventListener("input", syncCharCount);

  function buildUrl(mode, paramsObj){
    const params = new URLSearchParams();
    params.set("mode", mode);
    params.set("_ts", String(Date.now()));

    if (paramsObj && typeof paramsObj === "object"){
      for (const [k,v] of Object.entries(paramsObj)){
        if (v === undefined || v === null) continue;
        params.set(k, String(v));
      }
    }
    return `${API_BASE}?${params.toString()}`;
  }

  async function apiGet(mode, paramsObj){
    const url = buildUrl(mode, paramsObj);
    const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"omit" });
    const text = await res.text().catch(()=> "");
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0,500)}`);
    try { return JSON.parse(text); }
    catch { throw new Error("JSON_PARSE_FAILED\n" + text.slice(0,500)); }
  }

  async function apiPost(mode, bodyObj){
    const url = `${API_BASE}?_ts=${Date.now()}`;
    const body = new URLSearchParams();
    body.set("mode", String(mode || ""));
    if (bodyObj && typeof bodyObj === "object"){
      for (const [k,v] of Object.entries(bodyObj)){
        if (v === undefined || v === null) continue;
        body.set(k, String(v));
      }
    }
    const res = await fetch(url, { method:"POST", body, cache:"no-store", credentials:"omit" });
    const text = await res.text().catch(()=> "");
    let data = null;
    try { data = JSON.parse(text); } catch(_){}
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
    if (!data)   throw new Error(`JSON 아님: ${text.slice(0,300)}`);
    return data;
  }

  function setFromSelect(){
    const v = $("postSelect").value;
    if (v) $("id").value = v;
  }

  function getTargetId(){
    const fromSelect = $("postSelect").value;
    const fromInput  = $("id").value.trim();
    return fromInput || fromSelect || "";
  }

  async function refreshList(selectId){
    try{
      setStatus("목록 불러오는 중...", true);
      const res = await apiGet("listPosts");
      if (!res || !res.ok) return setStatus("목록 불러오기 실패: " + (res?.message||""), false);

      const sel = $("postSelect");
      sel.innerHTML = "";
      const items = res.items || [];

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "선택...";
      sel.appendChild(opt0);

      for (const it of items){
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.id + (it.title ? ` — ${it.title}` : "");
        sel.appendChild(opt);
      }

      if (selectId){
        sel.value = selectId;
        $("id").value = selectId;
      }

      setStatus(`목록 ${items.length}건`, true);
    }catch(e){
      setStatus("목록 불러오기 오류: " + e.message, false);
      showBanner(String(e && e.stack ? e.stack : e));
    }
  }

  async function loadPost(){
    const id = getTargetId();
    if (!id) return setStatus("id를 선택하거나 입력하세요.", false);
  
    try{
      setStatus(`불러오는 중: ${id}`, true);
      const res = await apiGet("getPost", { id });
  
      if (!res || !res.ok) return setStatus("불러오기 실패: " + (res?.message||""), false);
  
      current = res.post;
  
      $("id").value = current.id;
      $("title").value = current.title || "";
      $("html").value = current.html || "";
      syncCharCount();
      setMeta(current);
  
      setStatus("불러오기 완료", true);
    }catch(e){
      setStatus("불러오기 오류: " + e.message, false);
    }
  }
  
  async function exportToDrive(){
    const id = getTargetId();
    if (!id) return setStatus("id가 필요합니다.", false);
  
    const payload = {
      id,
      title: $("title").value.trim(),
      html: $("html").value
    };
  
    try{
      setStatus("Drive 저장/업데이트 중...", true);
      const res = await apiPost("driveUpsert", payload);
  
      if (!res || !res.ok) return setStatus("Drive 저장 실패: " + (res?.message||""), false);
  
      setStatus(`Drive 저장 완료: ${res.file?.name || ""}`, true);
      await refreshList(id);
      await loadPost();
    }catch(e){
      setStatus("Drive 저장 오류: " + e.message, false);
    }
  }
  
  async function importFromDrive(){
    const id = getTargetId();
    if (!id) return setStatus("id가 필요합니다.", false);
  
    try{
      setStatus("Drive에서 불러오는 중...", true);
      const res = await apiGet("driveReadById", { id });
  
      if (!res || !res.ok) return setStatus("Drive 불러오기 실패: " + (res?.message||""), false);
  
      $("html").value = res.html || "";
      syncCharCount();
  
      // 메타(Drive url/fileId) 등도 최신으로 반영
      await loadPost();
      setStatus("Drive 불러오기 완료", true);
    }catch(e){
      setStatus("Drive 불러오기 오류: " + e.message, false);
    }
  }
  
  function clearEditor(){
    $("title").value = "";
    $("html").value = "";
    syncCharCount();
    setStatus("편집창을 비웠습니다.", true);
  }
  
  /* =========================
     버튼 연결 (시트 저장 제거)
  ========================= */
  $("btnRefresh").addEventListener("click", ()=>refreshList());
  $("btnLoad").addEventListener("click", loadPost);
  $("btnSetFromSelect").addEventListener("click", setFromSelect);
  
  // ❌ 제거: $("btnSaveSheet")...  / saveToSheet()
  
  $("btnDriveUpsert").addEventListener("click", exportToDrive);
  $("btnDriveRead").addEventListener("click", importFromDrive);
  $("btnClear").addEventListener("click", clearEditor);
  
  // init
  refreshList();

})();
</script>

</body>
</html>
