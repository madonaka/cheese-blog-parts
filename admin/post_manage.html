<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>포스트 관리 v2</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --line:rgba(15,23,42,.14);
      --text:#0f172a;
      --muted:#6b7280;
      --ok:#047857;
      --err:#b91c1c;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; }
    .wrap{ padding:14px; max-width:1100px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .label{ font-weight:800; }
    input, select, textarea{
      border:1px solid rgba(15,23,42,.2);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      font-size:14px;
    }
    select, input{ min-width:260px; }
    .title{ min-width:520px; }
    textarea{
      width:100%;
      min-height:460px;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:13px;
      line-height:1.45;
      border-radius:12px;
    }
    .btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,.18);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .btn.danger{ background:#b91c1c; color:#fff; border-color:#b91c1c; }
    .muted{ color:var(--muted); font-size:13px; }
    .status{ margin-top:10px; font-size:13px; }
    .status.ok{ color:var(--ok); }
    .status.err{ color:var(--err); }
    .meta{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:8px 12px;
      margin-top:10px;
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.15);
      font-size:12px;
      margin-left:8px;
    }
    .link{ color:#2563eb; font-weight:800; text-decoration:none; }
    .banner{
      display:none;
      margin:0 0 12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(185,28,28,.25);
      background:rgba(185,28,28,.06);
      color:#7f1d1d;
      font-weight:800;
      font-size:13px;
      white-space:pre-line;
    }
    .spacer{ flex:1; }
    .small{ font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 12px;">
      포스트 관리 v2 <span class="pill">Sheet: meta / Drive: html</span>
    </h2>

    <div id="banner" class="banner"></div>

    <section class="card">
      <div class="row">
        <div class="label">검색</div>
        <input id="q" type="text" placeholder="id 또는 title 키워드" />
        <button class="btn" onclick="refreshList()">목록 새로고침</button>

        <div class="spacer"></div>
        <span class="small" id="env"></span>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="label">Post 선택</div>
        <select id="postSelect"></select>

        <button class="btn primary" onclick="loadMeta()">메타 불러오기</button>
        <button class="btn" onclick="loadHtmlFromDrive()">Drive HTML 불러오기</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="label">ID</div>
        <input id="id" type="text" placeholder="예: P001 또는 커스텀 ID" />
        <button class="btn" onclick="setIdFromSelect()">선택값 ID 반영</button>
        <button class="btn" onclick="getNextId()">다음 ID</button>
        <button class="btn" onclick="createEmpty()">신규(빈 포스트) 생성</button>
      </div>

      <div id="status" class="status muted">준비됨</div>

      <div class="meta">
        <div class="muted">drive_file_id</div><div id="metaFileId" class="muted">-</div>
        <div class="muted">drive_url</div><div id="metaUrl" class="muted">-</div>
        <div class="muted">updated_at</div><div id="metaUpdated" class="muted">-</div>
      </div>

      <div style="margin-top:10px;">
        <a id="openDrive" class="link" href="#" target="_blank" style="display:none;">Drive 파일 열기</a>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <div class="label">Title</div>
        <input id="title" class="title" type="text" placeholder="글 제목" />
        <div class="muted" id="count">0 chars</div>
      </div>

      <div style="margin-top:10px;">
        <div class="label" style="margin-bottom:6px;">HTML (Drive에 저장될 본문)</div>
        <textarea id="html" placeholder="여기에 최종 HTML을 편집하세요"></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn primary" onclick="saveMetaToSheet()">시트에 저장(메타)</button>
        <button class="btn" onclick="saveHtmlToDrive()">Drive에 저장(HTML)</button>
        <button class="btn danger" onclick="clearEditor()">편집창 비우기</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        권장 흐름: (1) 시트에 메타 저장 → (2) Drive에 HTML 저장(업데이트) → (3) 필요 시 Drive에서 다시 불러오기
      </div>
    </section>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ✅ WebApp에서 이 HTML을 열면, 같은 /exec로 붙게 되어 CORS 없이 안정적
  const API_BASE = (() => {
    const u = new URL(window.location.href);
    u.search = "";
    u.hash = "";
    return u.toString();
  })();

  let current = null;

  function showBanner(msg){
    const b = $("banner");
    b.textContent = msg;
    b.style.display = "block";
  }
  function hideBanner(){
    const b = $("banner");
    b.textContent = "";
    b.style.display = "none";
  }
  function setStatus(msg, ok=true){
    const el = $("status");
    el.textContent = msg;
    el.className = "status " + (ok ? "ok" : "err");
  }
  function syncCount(){
    $("count").textContent = ($("html").value || "").length + " chars";
  }
  $("html").addEventListener("input", syncCount);

  function buildUrl(mode, paramsObj){
    const params = new URLSearchParams();
    params.set("mode", mode);
    params.set("_ts", String(Date.now()));
    if (paramsObj && typeof paramsObj === "object"){
      for (const [k,v] of Object.entries(paramsObj)){
        if (v === undefined || v === null) continue;
        params.set(k, String(v));
      }
    }
    return `${API_BASE}?${params.toString()}`;
  }

  async function apiGet(mode, paramsObj){
    const url = buildUrl(mode, paramsObj);
    const res = await fetch(url, { method:"GET", cache:"no-store", credentials:"include" });
    const text = await res.text().catch(()=> "");
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0,500)}`);
    try { return JSON.parse(text); }
    catch { throw new Error("JSON_PARSE_FAILED\n" + text.slice(0,500)); }
  }

  async function apiPost(mode, bodyObj){
    const url = `${API_BASE}?_ts=${Date.now()}`;
    const body = new URLSearchParams();
    body.set("mode", String(mode || ""));
    if (bodyObj && typeof bodyObj === "object"){
      for (const [k,v] of Object.entries(bodyObj)){
        if (v === undefined || v === null) continue;
        body.set(k, String(v));
      }
    }
    const res = await fetch(url, { method:"POST", body, cache:"no-store", credentials:"include" });
    const text = await res.text().catch(()=> "");
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0,500)}`);
    try { return JSON.parse(text); }
    catch { throw new Error("JSON_PARSE_FAILED\n" + text.slice(0,500)); }
  }

  function setMeta(meta){
    $("metaFileId").textContent = meta?.drive_file_id || "-";
    $("metaUrl").textContent = meta?.drive_url || "-";
    $("metaUpdated").textContent = meta?.updated_at || "-";

    const link = $("openDrive");
    if (meta?.drive_url){
      link.href = meta.drive_url;
      link.style.display = "inline";
    }else{
      link.style.display = "none";
    }
  }

  function getId(){
    const v = $("id").value.trim();
    const s = $("postSelect").value;
    return v || s || "";
  }

  function setIdFromSelect(){
    const v = $("postSelect").value;
    if (v) $("id").value = v;
  }

  // ─────────────────────────────────────────────
  // 목록 / 메타 / Drive HTML
  // ─────────────────────────────────────────────

  async function refreshList(){
    hideBanner();
    try{
      setStatus("목록 불러오는 중...", true);
      const q = $("q").value.trim();

      // ✅ 서버 구현에 따라 파라미터가 q 또는 keyword일 수 있어 q로 통일
      const res = await apiGet("listPosts", q ? { q } : undefined);

      if (!res?.ok) return setStatus("목록 실패: " + (res?.message || ""), false);

      const items = res.items || [];
      const sel = $("postSelect");
      sel.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "선택...";
      sel.appendChild(opt0);

      for (const it of items){
        const id = it.id || it.post_id || it.postId || "";      // ✅ 호환
        const title = it.title || "";
        if (!id) continue;

        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = title ? `${id} — ${title}` : id;
        sel.appendChild(opt);
      }

      setStatus(`목록 ${items.length}건`, true);
    }catch(e){
      setStatus("목록 오류: " + e, false);
      showBanner(String(e));
    }
  }

  // ✅ 시트 메타만 불러오기 (HTML은 Drive에서 별도)
  async function loadMeta(){
    hideBanner();
    const id = getId();
    if (!id) return setStatus("ID를 선택하거나 입력하세요.", false);

    try{
      setStatus("메타 불러오는 중...", true);

      // 서버가 id 기준이면 {id}, post_id 기준이면 {post_id}
      // ✅ 둘 다 보내서 호환
      const res = await apiGet("getPost", { id, post_id: id });

      if (!res?.ok) return setStatus("메타 실패: " + (res?.message || ""), false);

      const post = res.post || res.data || res.item || {};
      current = {
        id: post.id || post.post_id || id,
        title: post.title || "",
        // html은 굳이 자동 로드하지 않음(Drive가 기준)
        html: post.html || post.body || "",
        drive_file_id: post.drive_file_id || post.driveFileId || "",
        drive_url: post.drive_url || post.driveUrl || "",
        updated_at: post.updated_at || ""
      };

      $("id").value = current.id;
      $("title").value = current.title || "";

      // 서버가 html 컬럼도 주면(백업) textarea에 넣을지 여부 선택
      // 기본: 비워두고 Drive에서 불러오도록 유도
      if (!($("html").value || "").trim() && (current.html || "").trim()){
        $("html").value = current.html;  // ✅ 원하면 주석 처리 가능
        syncCount();
      }

      setMeta(current);
      setStatus("메타 불러오기 완료", true);
    }catch(e){
      setStatus("메타 오류: " + e, false);
      showBanner(String(e));
    }
  }

  // ✅ Drive에 저장된 HTML 불러오기
  async function loadHtmlFromDrive(){
    hideBanner();
    const id = getId();
    if (!id) return setStatus("ID가 필요합니다.", false);

    try{
      setStatus("Drive HTML 불러오는 중...", true);

      // 서버에 이 mode가 있어야 함: driveReadById 또는 driveReadByPostId 등
      // ✅ 둘 다 시도할 수 있게 1차/2차 폴백
      let res;
      try{
        res = await apiGet("driveReadById", { id, post_id: id });
      }catch(_){
        res = await apiGet("driveReadByPostId", { postId: id });
      }

      if (!res?.ok) return setStatus("Drive 불러오기 실패: " + (res?.message || ""), false);

      const html = res.html || res.content || "";
      $("html").value = html;
      syncCount();

      // file info 반영
      const file = res.file || {};
      if (!current) current = { id };
      if (file.id) current.drive_file_id = file.id;
      if (file.url) current.drive_url = file.url;
      if (res.updated_at) current.updated_at = res.updated_at;

      setMeta(current);
      setStatus("Drive HTML 불러오기 완료", true);
    }catch(e){
      setStatus("Drive 불러오기 오류: " + e, false);
      showBanner(String(e));
    }
  }

  // ─────────────────────────────────────────────
  // 저장: 메타(시트) / HTML(Drive)
  // ─────────────────────────────────────────────

  // ✅ 시트 저장: id/title/(선택)html + drive 메타가 있으면 같이
  async function saveMetaToSheet(){
    hideBanner();
    const id = getId();
    const title = $("title").value.trim();
    if (!id) return setStatus("ID가 필요합니다.", false);
    if (!title) return setStatus("Title이 필요합니다.", false);

    try{
      setStatus("시트 저장 중...", true);

      // 서버 savePost가 post_id/title/html을 받는 형태면 호환 가능
      // ✅ id와 post_id를 둘 다 보내고, html은 컬럼을 쓸 거면 같이 보냄(원하면 제거)
      const payload = {
        id,
        post_id: id,
        title,
        html: $("html").value, // ✅ html 컬럼을 “백업”으로 쓰려면 유지, 완전 Drive-only면 빈 문자열로 보내도 됨
        drive_file_id: current?.drive_file_id || "",
        drive_url: current?.drive_url || ""
      };

      const res = await apiPost("savePost", payload);
      if (!res?.ok) return setStatus("시트 저장 실패: " + (res?.message || ""), false);

      setStatus("시트 저장 완료", true);
      await refreshList();
    }catch(e){
      setStatus("시트 저장 오류: " + e, false);
      showBanner(String(e));
    }
  }

  // ✅ Drive 저장: HTML을 Drive 파일로 upsert 하고, 결과(fileId/url)를 시트에 반영(서버가 해줘야 함)
  async function saveHtmlToDrive(){
    hideBanner();
    const id = getId();
    const title = $("title").value.trim();
    const html = $("html").value;

    if (!id) return setStatus("ID가 필요합니다.", false);
    if (!title) return setStatus("Title이 필요합니다.", false);

    try{
      setStatus("Drive 저장(업데이트) 중...", true);

      // 서버에 driveUpsert(mode)가 있어야 함:
      // 입력: id/title/html/(옵션: drive_file_id)
      // 출력: {ok:true, file:{id,url,name}} 등
      const payload = {
        id,
        post_id: id,
        title,
        html,
        drive_file_id: current?.drive_file_id || ""
      };

      const res = await apiPost("driveUpsert", payload);
      if (!res?.ok) return setStatus("Drive 저장 실패: " + (res?.message || ""), false);

      const file = res.file || {};
      if (!current) current = { id, title };

      if (file.id) current.drive_file_id = file.id;
      if (file.url) current.drive_url = file.url;
      current.updated_at = res.updated_at || current.updated_at || "";

      setMeta(current);

      // ✅ Drive 저장 성공 후, 시트 메타도 같이 저장해서 동기화
      try{
        await apiPost("savePost", {
          id, post_id:id, title,
          html: "", // ✅ Drive-only 운영이면 시트 html은 비워도 됨
          drive_file_id: current.drive_file_id || "",
          drive_url: current.drive_url || ""
        });
      }catch(_){ /* 시트 저장은 서버에서 driveUpsert가 이미 했을 수도 있으니 무시 */ }

      setStatus("Drive 저장 완료", true);
      await refreshList();
    }catch(e){
      setStatus("Drive 저장 오류: " + e, false);
      showBanner(String(e));
    }
  }

  async function getNextId(){
    hideBanner();
    try{
      setStatus("다음 ID 조회 중...", true);
      // 서버에 getNextPostId가 있으면 그대로 사용
      const res = await apiGet("getNextPostId");
      if (!res?.ok) return setStatus("다음 ID 실패: " + (res?.message || ""), false);

      const next = res.next_post_id || res.nextId || "";
      if (!next) return setStatus("서버가 next id를 주지 않았습니다.", false);

      $("id").value = next;
      setStatus("다음 ID: " + next, true);
    }catch(e){
      setStatus("다음 ID 오류: " + e, false);
      showBanner(String(e));
    }
  }

  // “빈 포스트”를 시트에 생성(Drive는 아직 없음)
  async function createEmpty(){
    hideBanner();
    const id = getId();
    const title = $("title").value.trim();
    if (!id) return setStatus("ID가 필요합니다.", false);
    if (!title) return setStatus("Title이 필요합니다.", false);

    try{
      setStatus("신규 생성(시트) 중...", true);
      const res = await apiPost("savePost", {
        id, post_id:id, title,
        html: $("html").value || "",
        drive_file_id: "",
        drive_url: ""
      });
      if (!res?.ok) return setStatus("신규 생성 실패: " + (res?.message || ""), false);

      current = { id, title, drive_file_id:"", drive_url:"" };
      setMeta(current);

      setStatus("신규 생성 완료", true);
      await refreshList();
    }catch(e){
      setStatus("신규 생성 오류: " + e, false);
      showBanner(String(e));
    }
  }

  function clearEditor(){
    $("title").value = "";
    $("html").value = "";
    syncCount();
    setStatus("편집창을 비웠습니다.", true);
  }

  // init
  (function(){
    $("env").textContent = "API_BASE: " + API_BASE;
    // 목록 자동 로드
    refreshList();
  })();
</script>
</body>
</html>
