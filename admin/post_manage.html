<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>포스트 관리</title>

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    .pm-wrap{ padding: 14px; }
    .pm-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .pm-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pm-label{ font-weight:800; }
    .pm-input, .pm-select{
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:10px;
      min-width:280px;
      background:#fff;
    }
    .pm-title{ min-width:420px; }
    .pm-textarea{
      width:100%;
      min-height:420px;
      padding:12px;
      border:1px solid rgba(15,23,42,0.2);
      border-radius:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;
      line-height:1.45;
    }
    .pm-btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.18);
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    .pm-btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .pm-btn.danger{ background:#b91c1c; color:#fff; border-color:#b91c1c; }
    .pm-muted{ color:#6b7280; font-size:13px; }
    .pm-status{ margin-top:10px; font-size:13px; }
    .pm-status.ok{ color:#047857; }
    .pm-status.err{ color:#b91c1c; }
    .pm-meta{ display:grid; grid-template-columns: 140px 1fr; gap:8px 12px; margin-top:10px; }
    .pm-meta div{ padding:6px 0; }
    .pm-link{ color:#2563eb; font-weight:800; text-decoration:none; }
    .pm-pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.15);
      font-size:12px;
      margin-left:8px;
    }
    .pm-small{ font-size:12px; color:#6b7280; }
    .pm-banner{
      margin: 0 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185,28,28,0.25);
      background: rgba(185,28,28,0.06);
      color:#7f1d1d;
      font-weight:800;
      font-size:13px;
      display:none;
      white-space:pre-line;
    }
    .pm-banner .pm-banner-small{
      margin-top:8px;
      font-size:12px;
      font-weight:700;
      color:#7f1d1d;
      opacity:0.9;
    }
    .pm-actions-right{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="pm-wrap">
          <h2 style="margin:0 0 12px;">
            포스트 관리 <span class="pm-pill">Sheet DB + Drive HTML</span>
          </h2>

          <div id="banner" class="pm-banner"></div>

          <section class="pm-card">
            <div class="pm-row">
              <div class="pm-label">Post 선택</div>
              <select id="postSelect" class="pm-select"></select>

              <button class="pm-btn" onclick="refreshList()">목록 새로고침</button>
              <button class="pm-btn primary" onclick="loadPost()">불러오기</button>

              <div class="pm-actions-right">
                <span class="pm-small" id="envHint"></span>
              </div>
            </div>

            <div class="pm-row" style="margin-top:10px;">
              <div class="pm-label">카테고리</div>
              <select id="category" class="pm-select" style="min-width:360px;">
                <option value="">선택...</option>
                <option value="주요 사건, 이슈, 뉴스 월별 총정리">주요 사건, 이슈, 뉴스 월별 총정리</option>
                <option value="한국사+중국사+일본사 연표">한국사+중국사+일본사 연표</option>
                <option value="가계도 시리즈">가계도 시리즈</option>
                <option value="기타">기타</option>
              </select>

              <button class="pm-btn" onclick="createPostAuto()">ID 자동 생성 & 신규 생성</button>

              <div class="pm-small">생성 예: NM_20260121_01 / TL_20260121_01 / GD_20260121_01 / OT_20260121_01</div>
            </div>

            <div class="pm-row" style="margin-top:10px;">
              <div class="pm-label">Post ID</div>
              <input id="postId" class="pm-input" type="text" placeholder="자동 생성됨" />
              <button class="pm-btn" onclick="setFromSelect()">선택값을 ID에 반영</button>
            </div>

            <div id="status" class="pm-status pm-muted">준비됨</div>

            <div class="pm-meta">
              <div class="pm-muted">Category</div><div id="metaCategory" class="pm-muted">-</div>
              <div class="pm-muted">Drive fileId</div><div id="driveFileId" class="pm-muted">-</div>
              <div class="pm-muted">Drive url</div><div id="driveUrl" class="pm-muted">-</div>
              <div class="pm-muted">Updated</div><div id="updatedAt" class="pm-muted">-</div>
            </div>
          </section>

          <section class="pm-card">
            <div class="pm-row">
              <div class="pm-label">Title</div>
              <input id="title" class="pm-input pm-title" type="text" placeholder="글 제목" />
              <div class="pm-muted" id="charCount">0 chars</div>
            </div>

            <div style="margin-top:10px;">
              <div class="pm-label" style="margin-bottom:6px;">HTML</div>
              <textarea id="html" class="pm-textarea" placeholder="여기에 최종 HTML(또는 본문 HTML)을 편집하세요"></textarea>
            </div>

            <div class="pm-row" style="margin-top:12px;">
              <button class="pm-btn primary" onclick="saveToSheet()">시트에 저장</button>
              <button class="pm-btn" onclick="exportToDrive()">Drive로 저장/업데이트</button>
              <button class="pm-btn" onclick="importFromDrive()">Drive에서 불러오기</button>
              <button class="pm-btn danger" onclick="clearEditor()">편집창 비우기</button>
              <a id="openDriveLink" class="pm-link" href="#" target="_blank" style="display:none;">Drive 파일 열기</a>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- ✅ 반드시 포함해야 하는 공통 스크립트 유지 -->
  <script src="./admin-common.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    let current = null;

    // ✅ WebApp 엔드포인트 (그대로 유지)
    const API_BASE =
      "https://script.google.com/macros/s/AKfycbwXqz1uMy3EOrisCEKIe0Fk7yu0P6MQ1ddHDvo7Sr_CPEYY0RHP2GyUBL8YhaBqxnmBJg/exec";

    function setStatus(msg, ok=true){
      const el = $("status");
      el.textContent = msg;
      el.className = "pm-status " + (ok ? "ok" : "err");
    }

    function showBanner(msg){
      const b = $("banner");
      b.innerHTML = "";
      b.style.display = "block";
      b.textContent = msg;
    }

    function hideBanner(){
      const b = $("banner");
      b.style.display = "none";
      b.textContent = "";
    }

    function setMeta(post){
      $("metaCategory").textContent = post.category || "-";
      $("driveFileId").textContent = post.drive_file_id || "-";
      $("driveUrl").textContent = post.drive_url || "-";
      $("updatedAt").textContent = post.updated_at || "-";

      const link = $("openDriveLink");
      if (post.drive_url){
        link.href = post.drive_url;
        link.style.display = "inline";
      } else {
        link.style.display = "none";
      }
    }

    function syncCharCount(){
      $("charCount").textContent = ($("html").value || "").length + " chars";
    }
    $("html").addEventListener("input", syncCharCount);

    function buildUrl(mode, paramsObj){
      const params = new URLSearchParams();
      params.set("mode", mode);
      params.set("_ts", String(Date.now())); // 캐시 방지

      if (paramsObj && typeof paramsObj === "object"){
        for (const [k,v] of Object.entries(paramsObj)){
          if (v === undefined || v === null) continue;
          params.set(k, String(v));
        }
      }
      return `${API_BASE}?${params.toString()}`;
    }

    // ✅ timeout 포함 fetch helper
    async function fetchWithTimeout(url, options, timeoutMs = 15000){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try{
        const res = await fetch(url, { ...options, signal: controller.signal });
        return res;
      } finally {
        clearTimeout(t);
      }
    }

    // ✅ GET(JSON) - 원인 파악 가능하게 "text -> JSON.parse" 패턴
    async function apiGet(mode, paramsObj){
      const url = buildUrl(mode, paramsObj);
      console.log("[apiGet] url =", url);

      let res;
      try{
        res = await fetchWithTimeout(url, {
          method: "GET",
          cache: "no-store",
          credentials: "include",   // ✅ 중요: 세션/쿠키 포함 시도
          redirect: "follow",
        }, 15000);
      }catch(e){
        // 여기서 터지면 대개 CORS/네트워크/확장프로그램/리다이렉트 차단 등
        console.error("[apiGet] fetch rejected:", e);
        throw new Error("FETCH_FAILED: " + (e && e.name ? e.name : e));
      }

      const text = await res.text().catch(()=> "");
      console.log("[apiGet] status =", res.status, res.statusText);
      console.log("[apiGet] body(head) =", text.slice(0, 200));

      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0, 500)}`);
      }

      try {
        return JSON.parse(text);
      } catch {
        // 로그인 HTML이 오거나, 에러 HTML이 오면 여기로 빠짐
        throw new Error("JSON_PARSE_FAILED\n" + text.slice(0, 500));
      }
    }

    // ✅ POST(JSON)
    async function apiPost(mode, bodyObj){
      const url = `${API_BASE}?_ts=${Date.now()}`; // 캐시 방지

      const body = new URLSearchParams();
      body.set("mode", String(mode || ""));

      if (bodyObj && typeof bodyObj === "object"){
        for (const [k,v] of Object.entries(bodyObj)){
          if (v === undefined || v === null) continue;
          body.set(k, String(v));
        }
      }

      console.log("[apiPost] url =", url, "mode =", mode);

      let res;
      try{
        res = await fetchWithTimeout(url, {
          method: "POST",
          body,                       // form-urlencoded (preflight 회피)
          cache: "no-store",
          credentials: "include",     // ✅ 기존 omit 제거
          redirect: "follow",
        }, 20000);
      }catch(e){
        console.error("[apiPost] fetch rejected:", e);
        throw new Error("FETCH_FAILED: " + (e && e.name ? e.name : e));
      }

      const text = await res.text().catch(()=> "");
      console.log("[apiPost] status =", res.status, res.statusText);
      console.log("[apiPost] body(head) =", text.slice(0, 200));

      if (!res.ok) {
        throw new Error(`HTTP ${res.status} ${res.statusText}\n${text.slice(0, 500)}`);
      }

      try {
        return JSON.parse(text);
      } catch {
        throw new Error("JSON_PARSE_FAILED\n" + text.slice(0, 500));
      }
    }

    function setFromSelect(){
      const v = $("postSelect").value;
      if (v) $("postId").value = v;
    }

    function getTargetPostId(){
      const fromSelect = $("postSelect").value;
      const fromInput  = $("postId").value.trim();
      return fromInput || fromSelect || "";
    }

    async function refreshList(selectId){
      hideBanner();
      try{
        setStatus("목록 불러오는 중...", true);
        const res = await apiGet("listPosts");

        if (!res || !res.ok) {
          return setStatus("목록 불러오기 실패: " + (res?.error || ""), false);
        }

        const sel = $("postSelect");
        sel.innerHTML = "";

        const items = res.items || [];
        items.sort((a,b)=> (a.id > b.id ? 1 : -1));

        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "선택...";
        sel.appendChild(opt0);

        for (const it of items){
          const opt = document.createElement("option");
          opt.value = it.id;
          const cat = it.category ? ` [${it.category}]` : "";
          opt.textContent = it.id + cat + (it.title ? ` — ${it.title}` : "");
          sel.appendChild(opt);
        }

        if (selectId){
          sel.value = selectId;
          $("postId").value = selectId;
        }

        setStatus(`목록 ${items.length}건`, true);
      }catch(e){
        setStatus("목록 불러오기 오류: " + e, false);

        // 실패 유형별 안내(가능한 범위 내)
        const hint =
          "가능한 원인:\n" +
          "1) WebApp 배포 접근권한이 '나만'이라 로그인/리다이렉트가 걸림\n" +
          "2) 다른 도메인에서 script.google.com으로 fetch 시 브라우저가 차단(CORS/리다이렉트 차단)\n" +
          "3) 광고차단/보안확장 프로그램이 script.google.com 요청을 차단\n\n" +
          "확인:\n" +
          "- 개발자도구 Network에서 listPosts 요청이 302/403/blocked로 뜨는지 확인\n" +
          "- WebApp 배포 설정: 실행자=나, 접근=링크가 있는 모든 사용자(또는 적절한 공개 설정)\n";

        showBanner(hint);
      }
    }

    async function loadPost(){
      hideBanner();
      const id = getTargetPostId();
      if (!id) return setStatus("postId를 선택하거나 입력하세요.", false);

      try{
        setStatus(`불러오는 중: ${id}`, true);
        const res = await apiGet("getPost", { postId: id });

        if (!res || !res.ok) return setStatus("불러오기 실패: " + (res?.error||""), false);

        current = res.post;

        $("postId").value = current.id;
        $("category").value = current.category || "";
        $("title").value = current.title || "";
        $("html").value = current.html || "";
        syncCharCount();
        setMeta(current);

        setStatus("불러오기 완료", true);
      }catch(e){
        setStatus("불러오기 오류: " + e, false);
      }
    }

    async function saveToSheet(){
      hideBanner();
      const id = getTargetPostId();
      if (!id) return setStatus("postId가 필요합니다.", false);

      const payload = {
        postId: id,
        category: $("category").value,
        title: $("title").value.trim(),
        html: $("html").value
      };

      try{
        setStatus("시트 저장 중...", true);
        const res = await apiPost("savePost", payload);

        if (!res || !res.ok) return setStatus("시트 저장 실패: " + (res?.error||""), false);

        setStatus("시트 저장 완료", true);
        await loadPost();
        await refreshList(id);
      }catch(e){
        setStatus("시트 저장 오류: " + e, false);
      }
    }

    async function exportToDrive(){
      hideBanner();
      const id = getTargetPostId();
      if (!id) return setStatus("postId가 필요합니다.", false);

      const payload = {
        postId: id,
        title: $("title").value.trim(),
        html: $("html").value
      };

      try{
        setStatus("Drive 저장/업데이트 중...", true);
        const res = await apiPost("driveUpsert", payload);

        if (!res || !res.ok) return setStatus("Drive 저장 실패: " + (res?.error||""), false);

        setStatus(`Drive 저장 완료: ${res.file?.name || ""}`, true);
        await loadPost();
        await refreshList(id);
      }catch(e){
        setStatus("Drive 저장 오류: " + e, false);
      }
    }

    async function importFromDrive(){
      hideBanner();
      const id = getTargetPostId();
      if (!id) return setStatus("postId가 필요합니다.", false);

      try{
        setStatus("Drive에서 불러오는 중...", true);
        const res = await apiGet("driveReadByPostId", { postId: id });

        if (!res || !res.ok) return setStatus("Drive 불러오기 실패: " + (res?.error||""), false);

        $("html").value = res.html || "";
        syncCharCount();

        if (res.file && current){
          current.drive_file_id = res.file.id;
          current.drive_url = res.file.url;
          current.drive_name = res.file.name;
          setMeta(current);
        }

        setStatus(`Drive 불러오기 완료: ${res.file?.name || ""}`, true);
      }catch(e){
        setStatus("Drive 불러오기 오류: " + e, false);
      }
    }

    function clearEditor(){
      $("title").value = "";
      $("html").value = "";
      syncCharCount();
      setStatus("편집창을 비웠습니다.", true);
    }

    async function createPostAuto(){
      hideBanner();
      const category = $("category").value;
      const title = $("title").value.trim();
      if (!category) return setStatus("카테고리를 선택하세요.", false);

      try{
        setStatus("ID 생성 & 신규 생성 중...", true);
        const res = await apiPost("createPostAuto", { category, title });

        if (!res || !res.ok) return setStatus("신규 생성 실패: " + (res?.error||""), false);

        const id = res.postId;
        $("postId").value = id;

        setStatus("신규 생성 완료: " + id, true);
        await refreshList(id);
        await loadPost();
      }catch(e){
        setStatus("신규 생성 오류: " + e, false);
      }
    }

    // 환경 표시(디버그용)
    (function(){
      const origin = location.origin;
      const hint = `현재 페이지: ${origin}`;
      $("envHint").textContent = hint;
    })();

    // init
    refreshList();
  </script>
</body>
</html>
