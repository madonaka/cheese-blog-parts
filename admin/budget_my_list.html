<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>예산 사용 • 지출 요청 목록 · Cheese Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- 공통 관리자 CSS -->
    <link rel="stylesheet" href="./admin.css" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
      }

      .my-shell {
        max-width: 960px;
        margin: 1.5rem auto 2.5rem;
        padding: 1.5rem 1.25rem 2rem;
        border-radius: 1.25rem;
        background: #ffffff;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
        box-sizing: border-box;
      }

      .my-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0 0 0.25rem;
        letter-spacing: -0.03em;
      }

      .my-sub {
        margin: 0 0 1.25rem;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .my-filter {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .my-filter-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
      }

      .my-filter-input {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        min-width: 220px;
      }

      .btn {
        border-radius: 999px;
        border: 0;
        padding: 0.4rem 1.1rem;
        font-size: 0.82rem;
        cursor: pointer;
        font-weight: 500;
      }

      .btn-primary {
        background: #2563eb;
        color: #f9fafb;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-ghost {
        background: transparent;
        color: #4b5563;
      }

      .my-section-title {
        margin: 1.5rem 0 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .my-section-title span.badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        background: #eff6ff;
        color: #1d4ed8;
      }

      .my-table-wrap {
        width: 100%;
        overflow-x: auto;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
      }

      table.my-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
        min-width: 720px;
      }

      table.my-table thead {
        background: #f9fafb;
      }

      table.my-table th,
      table.my-table td {
        padding: 0.5rem 0.6rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }

      table.my-table th {
        font-weight: 600;
        color: #4b5563;
        font-size: 0.78rem;
      }

      table.my-table tbody tr:hover {
        background: #f3f4ff;
      }

      .my-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.7rem;
        font-weight: 500;
      }

      .status-submitted {
        background: #eff6ff;
        color: #1d4ed8;
      }

      .status-approved {
        background: #ecfdf3;
        color: #15803d;
      }

      .status-rejected {
        background: #fef2f2;
        color: #b91c1c;
      }

      .my-pagination {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
        margin: 0.5rem 0 0.75rem;
        font-size: 0.78rem;
        color: #6b7280;
      }

      .my-pagination button {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        padding: 0.2rem 0.75rem;
        font-size: 0.76rem;
        cursor: pointer;
      }

      .my-pagination button:disabled {
        opacity: 0.4;
        cursor: default;
      }

      .my-pagination span.info {
        font-size: 0.76rem;
      }

      .my-status-text {
        margin-top: 0.5rem;
        font-size: 0.78rem;
        color: #6b7280;
      }

      .my-status-text.error {
        color: #b91c1c;
      }

      a.evidence-link {
        color: #2563eb;
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .my-shell {
          margin: 1rem 0.75rem 2rem;
          padding: 1.25rem 1rem 1.75rem;
        }

        .my-filter {
          flex-direction: column;
          align-items: stretch;
        }

        .my-filter-input {
          width: 100%;
        }

        .my-pagination {
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <!-- 권한별 접근 제어 -->
    <script>
      window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "FIN", "ADMIN"];
      window.CHEESE_ADMIN_ACTIVE_PAGE = "my-budget"; // 메뉴 활성용(이미 쓰고 있다면 유지)
    </script>
    
    <div class="admin-shell">
      <!-- 공통 헤더 -->
      <div id="admin-header-slot"></div>

      <div class="admin-main">
        <!-- 공통 왼쪽 메뉴 -->
        <aside id="admin-menu-slot" class="admin-sidebar"></aside>

        <!-- 본문 -->
        <main class="admin-content">
          <section class="my-shell">
            <h1 class="my-title">내 예산 · 지출 요청 현황</h1>
            <p class="my-sub">
              예산 사용 요청과 지출 정산 요청을 한 번에 확인할 수 있는 화면입니다.
              요청자 이메일을 기준으로 조회합니다.
            </p>

            <div class="my-filter">
              <label class="my-filter-label" for="my-email">요청자 이메일</label>
              <input
                id="my-email"
                class="my-filter-input"
                type="email"
                placeholder="예: kim@company.com"
              />
              <button class="btn btn-primary" type="button" id="btn-search">
                내 요청 조회
              </button>
            </div>

            <!-- 예산 사용 요청 목록 -->
            <h2 class="my-section-title">
              예산 사용 요청
              <span class="badge">BUDGET_REQUESTS</span>
            </h2>
            <div class="my-table-wrap">
              <table class="my-table" id="budget-table">
                <thead>
                  <tr>
                    <th>request_id</th>
                    <th>budget_id</th>
                    <th>제목</th>
                    <th>금액</th>
                    <th>요청일</th>
                    <th>상태</th>
                    <th>승인자</th>
                    <th>승인일</th>
                    <th>반려 사유</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="my-pagination" id="budget-pagination">
              <button type="button" id="budget-prev">이전</button>
              <span class="info" id="budget-page-info">0건</span>
              <button type="button" id="budget-next">다음</button>
            </div>

            <!-- 지출 정산 요청 목록 -->
            <h2 class="my-section-title">
              지출 정산 요청
              <span class="badge">EXPENSES</span>
            </h2>
            <div class="my-table-wrap">
              <table class="my-table" id="expense-table">
                <thead>
                  <tr>
                    <th>expense_id</th>
                    <th>request_id</th>
                    <th>지출일</th>
                    <th>거래처</th>
                    <th>금액</th>
                    <th>증빙</th>
                    <th>상태</th>
                    <th>승인자</th>
                    <th>승인/반려일</th>
                    <th>반려 사유</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="my-pagination" id="expense-pagination">
              <button type="button" id="expense-prev">이전</button>
              <span class="info" id="expense-page-info">0건</span>
              <button type="button" id="expense-next">다음</button>
            </div>

            <div id="my-status" class="my-status-text"></div>
          </section>
        </main>
      </div>
    </div>

    <!-- 공통 헤더/메뉴 스크립트 -->
    <script src="./admin-common.js" defer></script>

    <script>
      // ★ Apps Script Web App URL
      const API_BASE =
        "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";

      const PAGE_SIZE = 10;

      let currentRequester = "";
      let budgetPage = 1;
      let budgetTotalPages = 1;
      let expensePage = 1;
      let expenseTotalPages = 1;

      function setStatus(msg, isError) {
        const el = document.getElementById("my-status");
        el.textContent = msg || "";
        el.classList.toggle("error", !!isError);
      }

      function formatDate(value) {
        if (!value) return "";
        // 시트에서 Date 객체로 올 수도 있고, 문자열일 수도 있음
        const d = new Date(value);
        if (isNaN(d.getTime())) return String(value);
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const day = ("0" + d.getDate()).slice(-2);
        return y + "-" + m + "-" + day;
      }

      function formatAmount(n) {
        if (n === null || n === undefined || n === "") return "";
        const num = Number(n);
        if (isNaN(num)) return String(n);
        return num.toLocaleString("ko-KR") + "원";
      }

      function renderStatusBadge(status) {
        const s = (status || "").toString();
        const span = document.createElement("span");
        span.classList.add("my-status-badge");

        if (s === "approved") {
          span.classList.add("status-approved");
          span.textContent = "승인";
        } else if (s === "rejected") {
          span.classList.add("status-rejected");
          span.textContent = "반려";
        } else if (s === "submitted") {
          span.classList.add("status-submitted");
          span.textContent = "결재 대기";
        } else {
          span.textContent = s || "-";
        }
        return span;
      }

      function clearTable(tbody) {
        while (tbody.firstChild) {
          tbody.removeChild(tbody.firstChild);
        }
      }

      function renderBudgetTable(rows) {
        const tbody = document.querySelector("#budget-table tbody");
        clearTable(tbody);

        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 9;
          td.textContent = "조회된 예산 사용 요청이 없습니다.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = r.request_id || "";
          tr.appendChild(tdId);

          const tdBudget = document.createElement("td");
          tdBudget.textContent = r.budget_id || "";
          tr.appendChild(tdBudget);

          const tdTitle = document.createElement("td");
          tdTitle.textContent = r.title || "";
          tr.appendChild(tdTitle);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = formatAmount(r.amount);
          tr.appendChild(tdAmount);

          const tdReqAt = document.createElement("td");
          tdReqAt.textContent = formatDate(r.requested_at);
          tr.appendChild(tdReqAt);

          const tdStatus = document.createElement("td");
          tdStatus.appendChild(renderStatusBadge(r.status));
          tr.appendChild(tdStatus);

          const tdApprover = document.createElement("td");
          tdApprover.textContent = r.approver || "";
          tr.appendChild(tdApprover);

          const tdAppAt = document.createElement("td");
          tdAppAt.textContent = formatDate(r.approved_at);
          tr.appendChild(tdAppAt);

          const tdReject = document.createElement("td");
          tdReject.textContent = r.reject_reason || "";
          tr.appendChild(tdReject);

          tbody.appendChild(tr);
        });
      }

      function renderExpenseTable(rows) {
        const tbody = document.querySelector("#expense-table tbody");
        clearTable(tbody);

        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.textContent = "조회된 지출 정산 요청이 없습니다.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = r.expense_id || "";
          tr.appendChild(tdId);

          const tdReqId = document.createElement("td");
          tdReqId.textContent = r.request_id || "";
          tr.appendChild(tdReqId);

          const tdDate = document.createElement("td");
          tdDate.textContent = formatDate(r.date);
          tr.appendChild(tdDate);

          const tdVendor = document.createElement("td");
          tdVendor.textContent = r.vendor || "";
          tr.appendChild(tdVendor);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = formatAmount(r.amount);
          tr.appendChild(tdAmount);

          const tdEvidence = document.createElement("td");
          if (r.evidence_link) {
            const a = document.createElement("a");
            a.href = r.evidence_link;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "보기";
            a.className = "evidence-link";
            tdEvidence.appendChild(a);
          } else {
            tdEvidence.textContent = "-";
          }
          tr.appendChild(tdEvidence);

          const tdStatus = document.createElement("td");
          tdStatus.appendChild(renderStatusBadge(r.status));
          tr.appendChild(tdStatus);

          const tdApprover = document.createElement("td");
          tdApprover.textContent = r.approver || "";
          tr.appendChild(tdApprover);

          const tdDoneAt = document.createElement("td");
          // 승인일 또는 그대로 requested_at / 기타
          tdDoneAt.textContent =
            formatDate(r.approved_at || r.requested_at) || "";
          tr.appendChild(tdDoneAt);

          const tdReject = document.createElement("td");
          tdReject.textContent = r.reject_reason || "";
          tr.appendChild(tdReject);

          tbody.appendChild(tr);
        });
      }

      function updateBudgetPagination(total, page, size) {
        const info = document.getElementById("budget-page-info");
        const btnPrev = document.getElementById("budget-prev");
        const btnNext = document.getElementById("budget-next");

        const totalPages = Math.max(1, Math.ceil(total / size));
        budgetTotalPages = totalPages;
        budgetPage = page;

        info.textContent =
          total +
          "건 · " +
          page +
          " / " +
          totalPages +
          " 페이지";

        btnPrev.disabled = page <= 1;
        btnNext.disabled = page >= totalPages;
      }

      function updateExpensePagination(total, page, size) {
        const info = document.getElementById("expense-page-info");
        const btnPrev = document.getElementById("expense-prev");
        const btnNext = document.getElementById("expense-next");

        const totalPages = Math.max(1, Math.ceil(total / size));
        expenseTotalPages = totalPages;
        expensePage = page;

        info.textContent =
          total +
          "건 · " +
          page +
          " / " +
          totalPages +
          " 페이지";

        btnPrev.disabled = page <= 1;
        btnNext.disabled = page >= totalPages;
      }

      async function loadBudgetPage(page) {
        if (!currentRequester) return;
        try {
          const params = new URLSearchParams();
          params.set("mode", "myBudgetList");
          params.set("requester", currentRequester);
          params.set("page", String(page));
          params.set("size", String(PAGE_SIZE));

          const res = await fetch(API_BASE + "?" + params.toString(), {
            method: "GET",
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const data = json.data || {};
          const items = data.items || [];
          const total = data.total || 0;
          const pageNum = data.page || 1;
          const size = data.size || PAGE_SIZE;

          renderBudgetTable(items);
          updateBudgetPagination(total, pageNum, size);
        } catch (err) {
          console.error("loadBudgetPage ERROR:", err);
          setStatus("예산 요청 목록 조회 실패: " + err.message, true);
        }
      }

      async function loadExpensePage(page) {
        if (!currentRequester) return;
        try {
          const params = new URLSearchParams();
          params.set("mode", "myExpenseList");
          params.set("requester", currentRequester);
          params.set("page", String(page));
          params.set("size", String(PAGE_SIZE));

          const res = await fetch(API_BASE + "?" + params.toString(), {
            method: "GET",
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const data = json.data || {};
          const items = data.items || [];
          const total = data.total || 0;
          const pageNum = data.page || 1;
          const size = data.size || PAGE_SIZE;

          renderExpenseTable(items);
          updateExpensePagination(total, pageNum, size);
        } catch (err) {
          console.error("loadExpensePage ERROR:", err);
          setStatus("지출 정산 목록 조회 실패: " + err.message, true);
        }
      }

      async function loadAllFirstPage() {
        const emailInput = document.getElementById("my-email");
        const val = (emailInput.value || "").trim();
        if (!val) {
          setStatus("요청자 이메일을 입력해 주세요.", true);
          return;
        }
        currentRequester = val;
        setStatus("목록을 불러오는 중입니다...", false);

        budgetPage = 1;
        expensePage = 1;

        await Promise.all([loadBudgetPage(1), loadExpensePage(1)]);

        setStatus("조회 완료", false);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const btnSearch = document.getElementById("btn-search");
        const emailInput = document.getElementById("my-email");
        const btnBudgetPrev = document.getElementById("budget-prev");
        const btnBudgetNext = document.getElementById("budget-next");
        const btnExpensePrev = document.getElementById("expense-prev");
        const btnExpenseNext = document.getElementById("expense-next");

        btnSearch.addEventListener("click", loadAllFirstPage);
        emailInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            loadAllFirstPage();
          }
        });

        btnBudgetPrev.addEventListener("click", function () {
          if (budgetPage > 1) {
            loadBudgetPage(budgetPage - 1);
          }
        });
        btnBudgetNext.addEventListener("click", function () {
          if (budgetPage < budgetTotalPages) {
            loadBudgetPage(budgetPage + 1);
          }
        });

        btnExpensePrev.addEventListener("click", function () {
          if (expensePage > 1) {
            loadExpensePage(expensePage - 1);
          }
        });
        btnExpenseNext.addEventListener("click", function () {
          if (expensePage < expenseTotalPages) {
            loadExpensePage(expensePage + 1);
          }
        });
      });
    </script>
  </body>
</html>
