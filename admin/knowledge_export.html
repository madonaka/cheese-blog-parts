<!-- knowledge_export.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knowledge DB · Export</title>

  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE   = "knowledge_export";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "Export · 블로그 생성/초안";
    window.CHEESE_ADMIN_PAGE_BADGE    = "v0.1";
  </script>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    .wrap{ max-width:1200px; margin:0 auto; padding:18px 18px 28px; box-sizing:border-box; }
    .card{ background:#fff; border:1px solid rgba(15,23,42,.10); border-radius:18px; box-shadow:0 10px 28px rgba(15,23,42,.10); overflow:hidden; margin-bottom:14px; }
    .h{ padding:14px 14px; border-bottom:1px solid rgba(15,23,42,.08); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .h h2{ margin:0; font-size:16px; }
    .b{ padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    label{ display:block; font-size:12px; color:#475569; margin:0 0 6px; }
    input, select, textarea{
      width:100%; box-sizing:border-box;
      padding:10px 10px; border-radius:12px; border:1px solid rgba(15,23,42,.15);
      font:inherit; outline:none;
    }
    button{
      padding:10px 14px; border-radius:12px; border:1px solid rgba(15,23,42,.25);
      background:#111827; color:#fff; cursor:pointer;
    }
    button.secondary{ background:#fff; color:#111827; }
    .muted{ color:#64748b; font-size:12px; }
    .ok{ color:#16a34a; }
    .bad{ color:#ef4444; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#f1f5f9; font-size:12px; color:#334155; }
    .grid2{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }

    /* tabs */
    .tabs{ display:flex; gap:8px; padding:10px 14px; border-bottom:1px solid rgba(15,23,42,.08); background:#fff; }
    .tab{ padding:8px 10px; border-radius:12px; border:1px solid rgba(15,23,42,.15); background:#fff; cursor:pointer; font-size:13px; }
    .tab.active{ background:#111827; color:#fff; border-color:#111827; }
    .panel{ display:none; }
    .panel.active{ display:block; }

    /* list */
    .listBox{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:10px; background:#fff; }
    .item{ display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px; border:1px solid rgba(15,23,42,.08); margin-bottom:8px; }
    .item:last-child{ margin-bottom:0; }
    .itemTitle{ font-weight:700; }
    .itemMeta{ font-size:12px; color:#64748b; margin-top:4px; }
    .itemActions{ margin-left:auto; display:flex; gap:8px; }
    .miniBtn{ padding:7px 10px; font-size:12px; border-radius:10px; }

    .kpiGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 980px){ .kpiGrid{ grid-template-columns:1fr; } }
    .kpi{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:12px; background:#fff; }
    .kpi b{ display:block; font-size:13px; margin-bottom:6px; }
    .kpi .num{ font-size:22px; font-weight:800; }

    .suggestBox{ border:1px solid rgba(15,23,42,.10); border-radius:14px; padding:12px; background:#fff; }
    .suggestBox h3{ margin:0 0 8px; font-size:14px; }
    .ol{ margin:8px 0 0; padding-left:18px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="wrap">

          <section class="card">
            <div class="h">
              <h2>Knowledge DB · Export</h2>
              <span class="pill">Basket → Analyzer → Preview</span>
            </div>

            <div class="tabs">
              <button class="tab active" data-tab="basket">① Basket</button>
              <button class="tab" data-tab="analyzer">② Analyzer</button>
              <button class="tab" data-tab="preview">③ Preview/Publish</button>
              <span id="topMsg" class="muted" style="margin-left:auto;"></span>
            </div>

            <div class="b">

              <!-- =========================
                   ① Basket
                   ========================= -->
              <div class="panel active" id="panel-basket">
                <div class="grid2">

                  <!-- left: add items -->
                  <div class="card" style="box-shadow:none; border-radius:14px;">
                    <div class="h" style="border-radius:14px 14px 0 0;">
                      <h2 style="font-size:14px;">담기</h2>
                      <span class="pill">JSONP</span>
                    </div>
                    <div class="b">
                      <div class="row">
                        <div style="flex:2 1 300px;">
                          <label>엔티티로 담기 (이름/별칭)</label>
                          <input id="inEntityQ" placeholder="예: 신간회" />
                          <div class="muted" style="margin-top:6px;">
                            검색 → 첫 엔티티 선택 → 그 엔티티 사건들을 “한 번에 Basket에 추가”
                          </div>
                        </div>
                        <div style="flex:0 0 150px; align-self:flex-end;">
                          <button id="btnAddByEntity" type="button" style="width:100%;">엔티티 담기</button>
                        </div>
                      </div>

                      <div style="margin-top:14px;">
                        <label>이벤트ID 붙여넣기 (쉼표/줄바꿈 구분)</label>
                        <textarea id="inEventIds" placeholder="EV_xxxx, EV_yyyy ..."></textarea>
                        <div class="row" style="margin-top:8px;">
                          <button id="btnAddByIds" type="button" class="secondary">ID로 담기</button>
                          <button id="btnClearBasket" type="button" class="secondary">Basket 비우기</button>
                          <span class="muted" id="basketMsg"></span>
                        </div>
                      </div>

                      <div style="margin-top:14px;">
                        <label>최근 이벤트 목록(빠른 담기)</label>
                        <div class="row">
                          <div style="flex:1 1 200px;">
                            <input id="inQuickQ" placeholder="제목 검색(옵션)" />
                          </div>
                          <div style="flex:0 0 150px;">
                            <button id="btnLoadRecent" type="button" class="secondary" style="width:100%;">최근 불러오기</button>
                          </div>
                        </div>
                        <div id="recentBox" class="listBox" style="margin-top:10px; max-height:320px; overflow:auto;">
                          <div class="muted">아직 로드 안함</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- right: basket -->
                  <div class="card" style="box-shadow:none; border-radius:14px;">
                    <div class="h" style="border-radius:14px 14px 0 0;">
                      <h2 style="font-size:14px;">Basket</h2>
                      <span class="pill" id="basketCount">0</span>
                    </div>
                    <div class="b">
                      <div id="basketBox" class="listBox">
                        <div class="muted">담긴 항목이 없습니다.</div>
                      </div>
                      <div class="muted" style="margin-top:10px;">
                        ※ Basket은 브라우저 localStorage에 자동 저장됩니다.
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- =========================
                   ② Analyzer (MVP: Coverage / Timeline / Entity Focus)
                   ========================= -->
              <div class="panel" id="panel-analyzer">
                <div class="row" style="align-items:center;">
                  <button id="btnAnalyze" type="button">Basket 분석</button>
                  <span id="analyzeMsg" class="muted"></span>
                </div>

                <div style="margin-top:12px;" class="kpiGrid">
                  <div class="kpi">
                    <b>Coverage · 누락</b>
                    <div class="num" id="kpiMissing">-</div>
                    <div class="muted" id="kpiMissingDetail"></div>
                  </div>
                  <div class="kpi">
                    <b>Timeline · 기간</b>
                    <div class="num" id="kpiRange">-</div>
                    <div class="muted" id="kpiRangeDetail"></div>
                  </div>
                  <div class="kpi">
                    <b>Entity Focus · 중심</b>
                    <div class="num" id="kpiFocus">-</div>
                    <div class="muted" id="kpiFocusDetail"></div>
                  </div>
                </div>

                <div style="margin-top:12px;" class="grid2">
                  <div class="suggestBox">
                    <h3>진단 요약</h3>
                    <div id="diagBox" class="muted">분석 전</div>
                  </div>
                  <div class="suggestBox">
                    <h3>Article Suggestions</h3>
                    <div id="suggestBox" class="muted">분석 전</div>
                    <div class="row" style="margin-top:10px;">
                      <button id="btnSendToPreview" type="button" class="secondary">이대로 미리보기 만들기</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- =========================
                   ③ Preview/Publish
                   ========================= -->
              <div class="panel" id="panel-preview">
                <div class="grid2">
                  <div class="suggestBox">
                    <h3>초안(미리보기) 생성</h3>
                    <div class="muted" style="margin-bottom:8px;">
                      Analyzer의 추천을 기반으로 “서문 → 본론(3개) → 결론” 형태로 자동 구성합니다.
                    </div>
                    <textarea id="draftBox" style="min-height:320px;" placeholder="Analyzer에서 ‘이대로 미리보기 만들기’를 누르면 자동 채워집니다."></textarea>
                    <div class="row" style="margin-top:10px;">
                      <button id="btnCopyDraft" type="button" class="secondary">복사</button>
                      <button id="btnPublishDraft" type="button" disabled title="다음 단계(블로거 초안 저장 API)에서 연결">초안 저장(준비중)</button>
                      <span id="previewMsg" class="muted"></span>
                    </div>
                  </div>

                  <div class="suggestBox">
                    <h3>Basket 미리보기</h3>
                    <div id="previewBasketBox" class="muted">-</div>
                  </div>
                </div>
              </div>

            </div><!-- /.b -->
          </section>

        </div><!-- /.wrap -->
      </main>
    </div><!-- /.admin-main -->
  </div><!-- /.admin-shell -->

  <script src="./admin-common.js"></script>
  <script>
    /************************************************************
     * ✅ 여기만 네 값으로 변경
     ************************************************************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbxowBj0yNZHZVjamJhn3tk9I8GoWSWMr67i2wVkjBF9aSEqNjbanbmyLa0qKYRtyZEMcw/exec";
    const ADMIN_TOKEN = "CHANGE_ME";

    /************************************************************
     * JSONP
     ************************************************************/
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(16).slice(2);
        const s = document.createElement("script");
        const timer = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, 12000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cb]; } catch(e) {}
          s.remove();
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.src = url + (url.includes("?") ? "&" : "?") + "cb=" + cb;
        s.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
        document.body.appendChild(s);
      });
    }

    async function apiSearchEntity(q){
      return jsonp(`${API_BASE}?fn=searchEntity&q=${encodeURIComponent(q)}`);
    }
    async function apiEventsByEntity(entityId){
      return jsonp(`${API_BASE}?fn=eventsByEntity&entityId=${encodeURIComponent(entityId)}`);
    }
    async function apiListEvents(limit=50){
      return jsonp(`${API_BASE}?fn=listEvents&limit=${encodeURIComponent(String(limit))}`);
    }
    async function apiExportBundle(eventIds){
      const ids = (eventIds||[]).join(",");
      return jsonp(`${API_BASE}?fn=exportBundle&token=${encodeURIComponent(ADMIN_TOKEN)}&eventIds=${encodeURIComponent(ids)}`);
    }

    /************************************************************
     * Basket state
     ************************************************************/
    const LS_KEY = "knowledge_export_basket_v1";
    let basket = []; // [{id, sortStart, displayDate, title, domain}]

    function loadBasket(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        basket = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(basket)) basket = [];
      }catch(e){ basket = []; }
    }
    function saveBasket(){
      localStorage.setItem(LS_KEY, JSON.stringify(basket));
    }
    function addToBasket(items){
      const map = new Map(basket.map(x => [x.id, x]));
      (items||[]).forEach(it => { if (it && it.id) map.set(it.id, it); });
      basket = Array.from(map.values());
      saveBasket();
      renderBasket();
    }
    function removeFromBasket(id){
      basket = basket.filter(x => x.id !== id);
      saveBasket();
      renderBasket();
    }
    function clearBasket(){
      basket = [];
      saveBasket();
      renderBasket();
    }

    /************************************************************
     * UI render
     ************************************************************/
    function renderBasket(){
      const box = document.getElementById("basketBox");
      const cnt = document.getElementById("basketCount");
      cnt.textContent = String(basket.length);

      if (!basket.length){
        box.innerHTML = `<div class="muted">담긴 항목이 없습니다.</div>`;
        renderPreviewBasket();
        return;
      }

      box.innerHTML = basket
        .slice()
        .sort((a,b)=> (a.sortStart||"").localeCompare(b.sortStart||""))
        .map(ev => `
          <div class="item">
            <div>
              <div class="itemTitle">${escapeHtml(ev.title||"(no title)")}</div>
              <div class="itemMeta">${escapeHtml(ev.displayDate||"")} · ${escapeHtml(ev.domain||"")} · ${escapeHtml(ev.sortStart||"")} · <span class="muted">${escapeHtml(ev.id||"")}</span></div>
            </div>
            <div class="itemActions">
              <button class="miniBtn secondary" type="button" data-remove="${escapeAttr(ev.id)}">빼기</button>
            </div>
          </div>
        `).join("");

      box.querySelectorAll("[data-remove]").forEach(btn=>{
        btn.addEventListener("click", ()=> removeFromBasket(btn.dataset.remove));
      });

      renderPreviewBasket();
    }

    function renderPreviewBasket(){
      const box = document.getElementById("previewBasketBox");
      if (!basket.length){
        box.innerHTML = `<div class="muted">Basket 비어있음</div>`;
        return;
      }
      const sorted = basket.slice().sort((a,b)=> (a.sortStart||"").localeCompare(b.sortStart||""));
      box.innerHTML = `
        <ol class="ol">
          ${sorted.map(x=>`
            <li>${escapeHtml(x.displayDate||x.sortStart||"")} — <b>${escapeHtml(x.title||"")}</b> <span class="muted">(${escapeHtml(x.domain||"")})</span></li>
          `).join("")}
        </ol>
      `;
    }

    function renderRecent(list){
      const box = document.getElementById("recentBox");
      if (!list || !list.length){
        box.innerHTML = `<div class="muted">결과 없음</div>`;
        return;
      }

      box.innerHTML = list.map(ev => `
        <div class="item">
          <div>
            <div class="itemTitle">${escapeHtml(ev.title||"(no title)")}</div>
            <div class="itemMeta">${escapeHtml(ev.displayDate||"")} · ${escapeHtml(ev.domain||"")} · ${escapeHtml(ev.sortStart||"")} · <span class="muted">${escapeHtml(ev.id||"")}</span></div>
          </div>
          <div class="itemActions">
            <button class="miniBtn" type="button" data-add="${escapeAttr(ev.id)}">담기</button>
          </div>
        </div>
      `).join("");

      box.querySelectorAll("[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.add;
          const ev = list.find(x=>x.id===id);
          if (ev) addToBasket([ev]);
        });
      });
    }

    /************************************************************
     * Analyzer (client-side, using exportBundle)
     ************************************************************/
    let lastAnalysis = null;
    function analyzeBundle(bundle){
      const events = bundle.events || [];
      const links = bundle.links || [];
      const entities = bundle.entities || [];

      // maps
      const entMap = new Map(entities.map(e=>[e.id,e]));
      const linkByEvent = new Map();
      links.forEach(l=>{
        if (!linkByEvent.has(l.eventId)) linkByEvent.set(l.eventId, []);
        linkByEvent.get(l.eventId).push(l);
      });

      // Coverage
      let missingDisplayDate = 0;
      let missingMemo = 0;
      let missingLinks = 0;
      events.forEach(ev=>{
        if (!ev.displayDate) missingDisplayDate++;
        if (!ev.memo) missingMemo++;
        if (!linkByEvent.get(ev.id)?.length) missingLinks++;
      });

      // Timeline
      const dates = events.map(e=>e.sortStart).filter(Boolean).sort();
      const start = dates[0] || "";
      const end = dates[dates.length-1] || "";
      const sameDateCount = new Map();
      events.forEach(e=>{
        if (!e.sortStart) return;
        sameDateCount.set(e.sortStart, (sameDateCount.get(e.sortStart)||0) + 1);
      });
      const duplicates = Array.from(sameDateCount.entries()).filter(([d,c])=>c>=3).sort((a,b)=>b[1]-a[1]).slice(0,5);

      // Entity focus
      const entCount = new Map();
      links.forEach(l=>{
        entCount.set(l.entityId, (entCount.get(l.entityId)||0) + 1);
      });
      const totalLinks = links.length || 0;
      const top = Array.from(entCount.entries()).sort((a,b)=>b[1]-a[1])[0];
      const topId = top ? top[0] : "";
      const topCnt = top ? top[1] : 0;
      const topEnt = topId ? entMap.get(topId) : null;
      const focusRatio = totalLinks ? (topCnt/totalLinks) : 0;

      // Domain mix
      const domCount = new Map();
      events.forEach(e=>{
        domCount.set(e.domain||"미분류", (domCount.get(e.domain||"미분류")||0)+1);
      });
      const domSorted = Array.from(domCount.entries()).sort((a,b)=>b[1]-a[1]);

      // Suggestions (rule-based MVP)
      const type = (topEnt && topEnt.type==="ORG" && focusRatio>=0.35) ? "단체 연혁형" : "사건 묶음형(연표형)";
      const key5 = events.slice().sort((a,b)=> (a.sortStart||"").localeCompare(b.sortStart||"")).slice(0,5);

      const gapsHint = (duplicates.length>0)
        ? `동일 날짜 다건(${duplicates[0][0]} ${duplicates[0][1]}건) → intraOrder 정리 추천`
        : `큰 중복 날짜는 적음`;

      const s1 = `${topEnt ? (topEnt.name + " ") : ""}창립/등장 배경과 목표 (${domSorted[0]?.[0]||"도메인"} 비중 기반)`;
      const s2 = `핵심 사건 타임라인 5개 (${start}~${end}, ${gapsHint})`;
      const s3 = `해체/의미/후대 영향 (연결 엔티티 ${entities.length}개 기반)`;

      return {
        coverage:{ missingDisplayDate, missingMemo, missingLinks },
        timeline:{ start, end, duplicates },
        focus:{ topEnt, topCnt, totalLinks, focusRatio },
        domain:{ domSorted },
        suggestions:{ type, headings:[s1,s2,s3], topEntName: topEnt?.name || "" }
      };
    }

    function renderAnalysis(a){
      lastAnalysis = a;

      // KPI 1
      const missTotal = a.coverage.missingDisplayDate + a.coverage.missingMemo + a.coverage.missingLinks;
      document.getElementById("kpiMissing").textContent = String(missTotal);
      document.getElementById("kpiMissingDetail").textContent =
        `displayDate 없음 ${a.coverage.missingDisplayDate} · memo 없음 ${a.coverage.missingMemo} · link 없음 ${a.coverage.missingLinks}`;

      // KPI 2
      document.getElementById("kpiRange").textContent = (a.timeline.start && a.timeline.end) ? "OK" : "-";
      document.getElementById("kpiRangeDetail").textContent =
        (a.timeline.start && a.timeline.end) ? `${a.timeline.start} ~ ${a.timeline.end}` : "sortStart가 부족합니다.";

      // KPI 3
      const focusPct = Math.round((a.focus.focusRatio||0) * 100);
      document.getElementById("kpiFocus").textContent = a.focus.topEnt ? `${focusPct}%` : "-";
      document.getElementById("kpiFocusDetail").textContent =
        a.focus.topEnt ? `TOP: ${a.focus.topEnt.name} (${a.focus.topCnt}/${a.focus.totalLinks})` : "연결 엔티티가 없습니다.";

      // diag
      const warn = [];
      if (a.coverage.missingLinks>0) warn.push(`eventEntities link 없는 이벤트 ${a.coverage.missingLinks}건`);
      if (a.coverage.missingDisplayDate>0) warn.push(`displayDate 누락 ${a.coverage.missingDisplayDate}건`);
      if (a.coverage.missingMemo>0) warn.push(`memo 누락 ${a.coverage.missingMemo}건`);
      if (a.timeline.duplicates.length>0) warn.push(`동일 날짜 다건 상위: ${a.timeline.duplicates.map(x=>`${x[0]}(${x[1]})`).join(", ")}`);

      document.getElementById("diagBox").innerHTML =
        warn.length ? `<ul class="ol">${warn.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<span class="ok">큰 문제 없음</span>`;

      // suggestions
      document.getElementById("suggestBox").innerHTML = `
        <div><b>추천 글 타입:</b> ${escapeHtml(a.suggestions.type)}</div>
        <div style="margin-top:6px;"><b>추천 소제목:</b></div>
        <ol class="ol">
          ${a.suggestions.headings.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}
        </ol>
      `;
    }

    function buildDraftFromAnalysis(a){
      const name = a.suggestions.topEntName || "주제";
      const [h1,h2,h3] = a.suggestions.headings;

      return [
        `# ${name} 관련 글감 초안(자동 생성)`,
        ``,
        `## 서문`,
        `- 이번 글은 ${name} 중심으로 사건을 정리합니다.`,
        `- 기간: ${a.timeline.start || "?"} ~ ${a.timeline.end || "?"}`,
        ``,
        `## 본론`,
        `### 1) ${h1}`,
        `- (여기에 배경 설명/맥락을 추가)`,
        ``,
        `### 2) ${h2}`,
        `- (여기에 핵심 사건 5개를 표/리스트로 정리)`,
        ``,
        `### 3) ${h3}`,
        `- (여기에 의미/영향/후속 흐름 정리)`,
        ``,
        `## 결론`,
        `- 다음 글로 이어질 연결 포인트를 한 문장으로 제시`,
        ``,
      ].join("\n");
    }

    /************************************************************
     * Events
     ************************************************************/
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(x=>x.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("panel-"+btn.dataset.tab).classList.add("active");

        if (btn.dataset.tab === "analyzer"){
          // 탭 들어가면 자동 분석(가능하면)
          if (basket.length) document.getElementById("btnAnalyze").click();
        }
      });
    });

    document.getElementById("btnClearBasket").addEventListener("click", ()=>{
      if (!confirm("Basket을 비울까요?")) return;
      clearBasket();
    });

    document.getElementById("btnAddByIds").addEventListener("click", async ()=>{
      const raw = document.getElementById("inEventIds").value || "";
      const ids = raw.split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
      if (!ids.length) return;

      // Basket에 ID만 넣으면 Analyzer에서 bundle fetch 시 디테일을 채우도록 처리
      addToBasket(ids.map(id=>({id})));
      document.getElementById("basketMsg").textContent = `${ids.length}개 담음`;
    });

    document.getElementById("btnAddByEntity").addEventListener("click", async ()=>{
      const msg = document.getElementById("basketMsg");
      msg.textContent = "";
      const q = document.getElementById("inEntityQ").value.trim();
      if (!q) return;

      try{
        msg.textContent = "엔티티 검색 중...";
        const r1 = await apiSearchEntity(q);
        if (!r1.ok) throw new Error(r1.message || "searchEntity failed");
        const entity = r1.items?.[0];
        if (!entity) throw new Error("엔티티 결과 없음");

        msg.textContent = `사건 불러오는 중... (${entity.name})`;
        const r2 = await apiEventsByEntity(entity.id);
        if (!r2.ok) throw new Error(r2.message || "eventsByEntity failed");

        addToBasket((r2.items||[]).map(x=>({
          id:x.id, sortStart:x.sortStart, displayDate:x.displayDate, title:x.title, domain:x.domain, memo:x.memo
        })));

        msg.textContent = `완료: ${entity.name} 관련 ${r2.items?.length||0}개 담음`;
      }catch(e){
        msg.textContent = `에러: ${e.message}`;
      }
    });

    document.getElementById("btnLoadRecent").addEventListener("click", async ()=>{
      const q = document.getElementById("inQuickQ").value.trim().toLowerCase();
      document.getElementById("recentBox").innerHTML = `<div class="muted">불러오는 중...</div>`;
      try{
        const r = await apiListEvents(60);
        if (!r.ok) throw new Error(r.message || "listEvents failed");
        let items = r.items || [];
        if (q) items = items.filter(x => (x.title||"").toLowerCase().includes(q));
        renderRecent(items);
      }catch(e){
        document.getElementById("recentBox").innerHTML = `<div class="bad">에러: ${escapeHtml(e.message)}</div>`;
      }
    });

    document.getElementById("btnAnalyze").addEventListener("click", async ()=>{
      const msg = document.getElementById("analyzeMsg");
      msg.textContent = "";
      if (!basket.length){
        msg.textContent = "Basket이 비어있습니다.";
        return;
      }
      try{
        msg.textContent = "Export bundle 로드 중...";
        const ids = basket.map(x=>x.id).filter(Boolean);
        const bundle = await apiExportBundle(ids);
        if (!bundle.ok) throw new Error(bundle.message || "exportBundle failed");

        // Basket에 디테일 채우기(빈 값 보완)
        const map = new Map((bundle.events||[]).map(x=>[x.id,x]));
        basket = basket.map(x => map.get(x.id) ? map.get(x.id) : x);
        saveBasket();
        renderBasket();

        msg.textContent = "분석 중...";
        const analysis = analyzeBundle(bundle);
        renderAnalysis(analysis);
        msg.textContent = "완료";
      }catch(e){
        msg.textContent = `에러: ${e.message}`;
      }
    });

    document.getElementById("btnSendToPreview").addEventListener("click", ()=>{
      if (!lastAnalysis){
        alert("먼저 Analyzer에서 분석을 실행하세요.");
        return;
      }
      // Preview 탭으로 이동 + 초안 채우기
      document.querySelector(".tab[data-tab='preview']").click();
      document.getElementById("draftBox").value = buildDraftFromAnalysis(lastAnalysis);
      document.getElementById("previewMsg").textContent = "초안이 생성되었습니다.";
    });

    document.getElementById("btnCopyDraft").addEventListener("click", async ()=>{
      const v = document.getElementById("draftBox").value || "";
      if (!v.trim()) return;
      try{
        await navigator.clipboard.writeText(v);
        document.getElementById("previewMsg").textContent = "복사 완료";
      }catch(e){
        document.getElementById("previewMsg").textContent = "복사 실패(브라우저 권한 확인)";
      }
    });

    /************************************************************
     * Utils
     ************************************************************/
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // init
    loadBasket();
    renderBasket();
  </script>
</body>
</html>
