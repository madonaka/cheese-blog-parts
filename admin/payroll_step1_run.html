<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>급여 · RUN 실행/목록 (Step 1)</title>

  <link rel="stylesheet" href="./admin.css" />

  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --text:#0f172a; --muted:#64748b; --line:rgba(15,23,42,.10);
      --shadow:0 10px 28px rgba(15,23,42,.10); --primary:#111827; --ok:#16a34a; --bad:#ef4444;
      --r:18px;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--text);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 18px 32px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;margin-bottom:14px;}
    .h{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .t{font-size:14px;font-weight:900;margin:0}
    .d{font-size:12px;color:var(--muted)}
    .b{padding:14px;}
    .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin-bottom:10px;}
    .row label{font-size:12px;color:var(--muted)}
    .in{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 10px;background:#fff;outline:none}
    .btn{border:none;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:800;background:var(--primary);color:#fff}
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
    .btn.ok{background:var(--ok)}
    .btn.danger{background:var(--bad)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-size:12px;font-weight:900}
    .right{text-align:right}
    .stack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;}
    .mini{font-size:12px;color:var(--muted);line-height:1.45}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-weight:800;font-size:13px;box-shadow:0 10px 22px rgba(0,0,0,.2);display:none;z-index:50}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:2px 8px}
    .warn{border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.06); border-radius:14px; padding:12px;}
  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- ✅ 헤더 슬롯 -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- ✅ 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- ✅ 본문 -->
      <main class="admin-content">
        <div class="wrap">

          <!-- 상단: 로그인 세션 표시 -->
          <div class="card">
            <div class="h">
              <div>
                <div class="t">급여 (Step 1) RUN 실행 / RUN 목록</div>
                <div class="d">사번(empNo) + token은 로그인 세션에서 자동 사용</div>
              </div>
              <div class="stack">
                <span class="pill">
                  <span class="mini">사번</span>
                  <b id="viewEmpNo" class="mono">-</b>
                </span>
                <span class="pill">
                  <span class="mini">이름</span>
                  <b id="viewName">-</b>
                </span>
                <button class="btn ghost" id="btnTestList">연결 테스트</button>
                <button class="btn" id="btnReload">새로고침</button>
              </div>
            </div>
            <div class="b">
              <div class="mini">
                - WebApp URL: <span class="kbd">GAS_WEBAPP_URL</span> 를 너의 Apps Script <b>/exec</b> 주소로 교체해야 함<br/>
                - 이 페이지는 <b>actor를 직접 입력하지 않음</b> (로그인 세션의 empNo를 actor로 사용)
              </div>
              <div id="loginWarn" class="warn mini" style="margin-top:10px; display:none;">
                로그인 세션이 없습니다. 먼저 로그인 페이지에서 로그인한 뒤 다시 시도하세요.<br/>
                (필요 키: <span class="kbd">cheese_admin_token</span>, <span class="kbd">cheese_admin_emp_no</span>)
              </div>
            </div>
          </div>

          <!-- 1) RUN 실행 -->
          <div class="card">
            <div class="h">
              <div>
                <div class="t">1) RUN 실행</div>
                <div class="d">POST mode=runPayroll</div>
              </div>
              <div class="stack">
                <span class="mini">생성된 RUN:</span>
                <b id="createdRunId" class="mono">-</b>
              </div>
            </div>
            <div class="b">
              <div class="row">
                <label>기간 시작</label>
                <input class="in" id="periodStart" type="date" />
              </div>
              <div class="row">
                <label>기간 종료</label>
                <input class="in" id="periodEnd" type="date" />
              </div>
              <div class="row">
                <label>지급일</label>
                <input class="in" id="payDate" type="date" />
              </div>
              <div class="row">
                <label>메모</label>
                <input class="in" id="note" placeholder="예: 2025-12 급여 RUN" />
              </div>

              <div class="stack" style="margin-top:10px;">
                <button class="btn ok" id="btnRunPayroll">RUN 실행(자동 산출)</button>
                <button class="btn ghost" id="btnLoadRuns">RUN 목록 새로고침</button>
              </div>

              <div class="mini" style="margin-top:10px;">
                * 버튼이 성공하면 백엔드에서 RUN 생성 + 직원별 급여 라인 자동 산출이 수행되는 설계.
              </div>
            </div>
          </div>

          <!-- 2) RUN 목록 -->
          <div class="card">
            <div class="h">
              <div>
                <div class="t">2) RUN 목록</div>
                <div class="d">GET mode=payrollRunList</div>
              </div>
              <div class="stack">
                <span class="mini">page</span>
                <input id="page" class="in" style="width:90px" type="number" value="1" min="1" />
                <span class="mini">size</span>
                <input id="size" class="in" style="width:90px" type="number" value="20" min="1" />
              </div>
            </div>

            <div class="b">
              <table>
                <thead>
                  <tr>
                    <th style="width:140px;">payrollRunId</th>
                    <th>period</th>
                    <th style="width:120px;">payDate</th>
                    <th style="width:110px;">status</th>
                    <th class="right" style="width:130px;">totalGross</th>
                    <th class="right" style="width:130px;">totalDed</th>
                    <th class="right" style="width:130px;">totalNet</th>
                    <th style="width:220px;">작업</th>
                  </tr>
                </thead>
                <tbody id="runsTbody"></tbody>
              </table>

              <div class="mini" style="margin-top:10px;">
                다음 Step 2에서 “상세보기(payrollRunDetail)” 화면을 만들 예정이라, 여기선 상세 링크만 둠.
              </div>
            </div>
          </div>

        </div>

        <div class="toast" id="toast"></div>
      </main>
    </div>
  </div>

  <!-- ✅ 공통 스크립트 (헤더/메뉴 로드 등) -->
  <script src="./admin-common.js"></script>

  <script>
    /************************************************************
     * ✅ 너의 Apps Script WebApp /exec URL 로 교체
     ************************************************************/
    const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec';

    const $ = (id) => document.getElementById(id);

    const toast = (msg) => {
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.style.display='none', 2200);
    };

    const fmt = (n) => (Number(n||0)).toLocaleString('ko-KR');

    function getSession() {
      return {
        token: (sessionStorage.getItem('cheese_admin_token') || '').trim(),
        empNo: (sessionStorage.getItem('cheese_admin_emp_no') || '').trim(),
        displayName: (sessionStorage.getItem('cheese_admin_display_name') || '').trim(),
        loginId: (sessionStorage.getItem('cheese_admin_login_id') || '').trim(),
        role: (sessionStorage.getItem('cheese_admin_role') || '').trim(),
      };
    }

    function ensureLogin() {
      const s = getSession();
      const ok = !!(s.token && s.empNo);
      $('loginWarn').style.display = ok ? 'none' : 'block';
      // 버튼 비활성
      $('btnTestList').disabled = !ok;
      $('btnRunPayroll').disabled = !ok;
      $('btnLoadRuns').disabled = !ok;
      return s;
    }

    // actor = empNo 로 통일
    function getActorEmpNo() {
      const s = getSession();
      if (!s.empNo) throw new Error('로그인 세션 empNo가 없습니다.');
      return s.empNo;
    }

    function getToken() {
      const s = getSession();
      if (!s.token) throw new Error('로그인 세션 token이 없습니다.');
      return s.token;
    }

    // GET 호출: .../exec?mode=...&token=...&actor=...
    async function apiGet(mode, params = {}) {
      if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('XXXX')) {
        throw new Error('GAS_WEBAPP_URL을 먼저 /exec 주소로 교체하세요.');
      }
      const actor = getActorEmpNo();
      const token = getToken();

      const usp = new URLSearchParams({
        mode,
        actor,     // ✅ 사번
        token,     // ✅ 토큰(백엔드에서 검증하도록 확장 가능)
        ...params
      });

      const res = await fetch(GAS_WEBAPP_URL + '?' + usp.toString(), { method: 'GET' });
      const json = await res.json().catch(() => null);
      if (!json) throw new Error('JSON 파싱 실패(응답이 JSON이 아님)');
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.data;
    }

    // POST 호출
    async function apiPost(mode, params = {}) {
      if (!GAS_WEBAPP_URL || GAS_WEBAPP_URL.includes('XXXX')) {
        throw new Error('GAS_WEBAPP_URL을 먼저 /exec 주소로 교체하세요.');
      }
      const actor = getActorEmpNo();
      const token = getToken();

      const usp = new URLSearchParams({
        mode,
        actor,
        token,
        ...params
      });

      const res = await fetch(GAS_WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: usp.toString(),
      });

      const json = await res.json().catch(() => null);
      if (!json) throw new Error('JSON 파싱 실패(응답이 JSON이 아님)');
      if (!json.ok) throw new Error(json.error || 'API error');
      return json.data;
    }

    $('btnReload').addEventListener('click', () => location.reload());

    $('btnTestList').addEventListener('click', async () => {
      try {
        const data = await apiGet('payrollRunList', { page: 1, size: 5 });
        toast('연결 OK (payrollRunList)');
        console.log('[payrollRunList]', data);
        renderRuns(data.items || []);
      } catch (e) {
        console.error(e);
        toast('연결 실패: ' + (e.message || e));
      }
    });

    $('btnRunPayroll').addEventListener('click', async () => {
      try {
        const periodStart = $('periodStart').value;
        const periodEnd   = $('periodEnd').value;
        const payDate     = $('payDate').value;
        const note        = $('note').value;

        if (!periodStart || !periodEnd) {
          toast('기간 시작/종료를 입력해 주세요');
          return;
        }

        $('btnRunPayroll').disabled = true;

        const data = await apiPost('runPayroll', {
          periodStart,
          periodEnd,
          payDate,
          note
        });

        const runId = data && data.payrollRunId ? data.payrollRunId : '';
        $('createdRunId').textContent = runId || '-';

        toast('RUN 실행 완료');
        await loadRuns();
      } catch (e) {
        console.error(e);
        toast('RUN 실패: ' + (e.message || e));
      } finally {
        $('btnRunPayroll').disabled = false;
      }
    });

    $('btnLoadRuns').addEventListener('click', loadRuns);

    async function loadRuns() {
      const page = Math.max(1, parseInt($('page').value, 10) || 1);
      const size = Math.max(1, parseInt($('size').value, 10) || 20);
      const data = await apiGet('payrollRunList', { page, size });
      renderRuns(data.items || []);
      toast('RUN 목록 로드 완료');
    }

    function renderRuns(items) {
      const tb = $('runsTbody');
      tb.innerHTML = '';

      if (!items.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="mini">데이터가 없습니다.</td>`;
        tb.appendChild(tr);
        return;
      }

      items.forEach(r => {
        const tr = document.createElement('tr');

        const runId = r.payrollRunId || '';
        const period = `${r.periodStart || ''} ~ ${r.periodEnd || ''}`;
        const payDate = r.payDate || '';
        const status = r.status || '';
        const tg = fmt(r.totalGross);
        const td = fmt(r.totalDeductions);
        const tn = fmt(r.totalNet);

        const detailHref = `./payroll_step2_detail.html?runId=${encodeURIComponent(runId)}`;

        tr.innerHTML = `
          <td class="mono">${runId}</td>
          <td>${period}</td>
          <td>${payDate}</td>
          <td>${status}</td>
          <td class="right">${tg}</td>
          <td class="right">${td}</td>
          <td class="right"><b>${tn}</b></td>
          <td>
            <a class="btn ghost" style="text-decoration:none;display:inline-block" href="${detailHref}">
              상세(다음 Step)
            </a>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    (function init(){
      const s = ensureLogin();
      $('viewEmpNo').textContent = s.empNo || '-';
      $('viewName').textContent = s.displayName || s.loginId || '-';
      // 자동 목록 로드는 일부러 안 걸어둠(일단 연결테스트 버튼으로 확인)
    })();
  </script>
</body>
</html>
