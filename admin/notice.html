<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
    // âœ… API ì£¼ì†Œ ì—°ê²°
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
    
    // ğŸš¨ [í•µì‹¬ 1] index.html ë“±ì—ì„œ ë¡œê·¸ì¸ ì‹œ ë°œê¸‰ëœ ì„¸ì…˜(ë˜ëŠ” ë¡œì»¬) ê°’ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤!
    // ë§Œì•½ ì €ì¥í•˜ì‹  í‚¤ ì´ë¦„ì´ 'emp_no'ê°€ ì•„ë‹ˆë¼ 'userId' ë“±ì´ë¼ë©´ ì•„ë˜ ê´„í˜¸ ì•ˆì˜ ê¸€ìë¥¼ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
    window.CURRENT_USER_EMP_NO = sessionStorage.getItem("emp_no") || localStorage.getItem("emp_no") || "CL-ADMIN";
    window.CURRENT_USER_NAME = sessionStorage.getItem("display_name") || localStorage.getItem("display_name") || "ê´€ë¦¬ì";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --line-color: #eee; --text-dark: #333; --text-gray: #777; --primary: #3b82f6; --danger: #ef4444; --bg-gray: #f9f9f9; }
    .dashboard-layout { max-width: 1000px; margin: 0 auto; padding: 20px 10px 80px; }
    .sys-version-small { font-size: 0.75rem; color: #ccc; text-align: right; margin-bottom: 10px; }
    .view-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
    .view-category { color: var(--primary); font-weight: 800; font-size: 0.85rem; margin-bottom: 8px; }
    .view-title { font-size: 1.5rem; font-weight: 900; color: #000; margin: 0 0 12px 0; line-height: 1.4; word-break: break-all; }
    .view-meta { display: flex; gap: 12px; color: var(--text-gray); font-size: 0.85rem; align-items: center; flex-wrap: wrap; }
    .meta-sep { color: #ddd; }
    .view-content { min-height: 300px; line-height: 1.8; color: #333; font-size: 1rem; margin-bottom: 40px; padding: 10px 0; }
    .view-content img { max-width: 100%; height: auto; border-radius: 4px; margin: 15px 0; }
    .action-bar { display: flex; justify-content: space-between; border-top: 1px solid var(--line-color); padding-top: 20px; margin-bottom: 40px; }
    .btn-bbs { padding: 8px 16px; border-radius: 4px; font-size: 0.9rem; font-weight: 700; cursor: pointer; border: 1px solid #ddd; background: #fff; text-decoration: none; color: #333; display: inline-flex; align-items: center; }
    .comment-wrap { background: #fff; border: 1px solid var(--line-color); }
    .comment-header { background: var(--bg-gray); padding: 10px 15px; border-bottom: 1px solid var(--line-color); font-weight: 800; font-size: 0.9rem; }
    .comment-item { padding: 15px; border-bottom: 1px solid var(--line-color); }
    .comment-item.is-reply { background: #fcfcfc; padding-left: 40px; position: relative; }
    .comment-item.is-reply::before { content: 'â””'; position: absolute; left: 15px; top: 15px; color: #ccc; font-weight: bold; }
    .comment-user { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .user-name { font-weight: 800; color: #333; font-size: 0.85rem; }
    .comment-date { color: #999; font-size: 0.75rem; }
    .comment-text { font-size: 0.9rem; line-height: 1.6; color: #444; white-space: pre-wrap; }
    .comment-btns { margin-top: 8px; }
    .btn-comment-sm { background: none; border: none; padding: 0; margin-right: 10px; color: #888; font-size: 0.75rem; cursor: pointer; font-weight: 700; }
    .comment-form { padding: 15px; background: #fdfdfd; }
    .comment-textarea { width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-size: 0.9rem; resize: none; box-sizing: border-box; font-family: inherit; }
    .btn-submit { background: #555; color: #fff; border: none; padding: 8px 20px; border-radius: 4px; font-weight: 700; cursor: pointer; }
    .edit-box { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
    .styled-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-family: inherit; font-size: 0.95rem; box-sizing: border-box; }
    .m-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; font-weight: 800; color: #fff; vertical-align: middle; }
    .bg-danger { background: var(--danger); }
    .bg-primary { background: var(--primary); }
    .tox-tinymce-aux { z-index: 99999 !important; }
    @media (max-width: 600px) { .view-title { font-size: 1.25rem; } }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        <div class="sys-version-small" id="sysVersion">Verifying Content...</div>

        <div id="view-wrapper" style="display:none;">
          <div class="view-header">
            <div id="view-category" class="view-category"></div>
            <h2 id="view-title" class="view-title">ë¡œë”© ì¤‘...</h2>
            <div class="view-meta">
              <span id="view-author">--</span>
              <span class="meta-sep">|</span>
              <span id="view-date">--.--.--</span>
              <span class="meta-sep">|</span>
              <span>ì¡°íšŒ <span id="view-count">0</span></span>
            </div>
          </div>
          <div id="view-body" class="view-content"></div>
          
          <div class="action-bar">
            <a href="board.html" class="btn-bbs">ëª©ë¡</a>
            
            <div id="author-action-btns" style="display:none; gap:10px;">
              <button class="btn-bbs" style="color:var(--danger); border-color:var(--danger);" onclick="deleteNotice()">ì‚­ì œ</button>
              <button id="btn-edit-trigger" class="btn-bbs" onclick="enterEditMode()">ìˆ˜ì •</button>
            </div>
          </div>

          <div class="comment-wrap">
            <div class="comment-header">ëŒ“ê¸€ <span id="comment-total-count">0</span></div>
            <div id="comment-list-root"></div>
            <div class="comment-form">
              <textarea id="new-comment-body" class="comment-textarea" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
              <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button class="btn-submit" onclick="submitComment()">ë“±ë¡</button>
              </div>
            </div>
          </div>
        </div>

        <div id="edit-wrapper" style="display:none;">
          <div class="edit-box">
            <h3 id="edit-page-title" style="margin-top:0;">ê¸€ ì“°ê¸°</h3>
            <input type="text" id="edit-title" class="styled-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="font-weight:700; font-size:1.1rem;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
              <select id="edit-level" class="styled-input" style="flex:1; margin-bottom:0;">
                <option value="normal">ì¼ë°˜ ê³µì§€</option>
                <option value="warn">ì¤‘ìš” ê³µì§€</option>
                <option value="danger">ğŸš¨ í•„ë… ê³µì§€</option>
              </select>
              <label style="flex:1; display:flex; align-items:center; gap:5px; font-size:0.9rem; font-weight:700; cursor:pointer;">
                <input type="checkbox" id="edit-pinned"> ğŸ“Œ ìƒë‹¨ ê³ ì •
              </label>
            </div>
            <textarea id="notice-editor"></textarea>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
              <button class="btn-bbs" onclick="cancelEdit()">ì·¨ì†Œ</button>
              <div style="display:flex; gap:10px;">
                <button class="btn-bbs" onclick="saveNotice('draft')">ì„ì‹œì €ì¥</button>
                <button class="btn-bbs" style="background:#333; color:#fff; border:none;" onclick="saveNotice('published')">ì‘ì„± ì™„ë£Œ</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const targetNoticeId = urlParams.get('id') || urlParams.get('noticeId');
  let currentNotice = null;
  let currentComments = [];

  document.addEventListener('DOMContentLoaded', initPage);

  async function initPage() {
    if (!targetNoticeId || targetNoticeId === "null") {
      showEditMode(true);
    } else {
      showViewMode();
      await loadNoticeData();
    }
  }

  function showViewMode() {
    document.getElementById('view-wrapper').style.display = 'block';
    document.getElementById('edit-wrapper').style.display = 'none';
  }

  function showEditMode(isNew = false) {
    document.getElementById('view-wrapper').style.display = 'none';
    document.getElementById('edit-wrapper').style.display = 'block';
    if(isNew) document.getElementById('edit-page-title').textContent = "ìƒˆ ê³µì§€ ì‘ì„±";
    initTinyMCE();
  }

  async function initTinyMCE() {
    if (tinymce.get('notice-editor')) return;
    await tinymce.init({
      selector: '#notice-editor', height: 500, language: 'ko_KR', menubar: false,
      plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen table help wordcount',
      toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline | forecolor backcolor | alignleft aligncenter alignright | bullist numlist outdent indent | table link image | code',
      toolbar_mode: 'wrap', branding: false, valid_elements: '*[*]'
    });
  }

  function getV(obj, key) {
    if(!obj) return "";
    const foundKey = Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase());
    return foundKey ? obj[foundKey] : "";
  }

  async function loadNoticeData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ê³µì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const qId = String(targetNoticeId || "").trim();
      const fetchUrl = `${window.CHEESE_ADMIN_API_BASE}?mode=getAnnouncement&noticeId=${qId}`;
      const res = await fetch(fetchUrl);
      const json = await res.json();

      const noticeItem = json.notice || json.announcement || json.data || json.item;

      if(json.ok && noticeItem && typeof noticeItem === 'object') {
        currentNotice = noticeItem;
        renderNotice();
        await loadComments();
        
        fetch(window.CHEESE_ADMIN_API_BASE, { 
            method: 'POST', 
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
            body: JSON.stringify({ mode: 'incrementNoticeView', noticeId: qId }) 
        }).catch(e=>{});

      } else {
        alert("ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        location.href = 'board.html';
      }
    } catch(e) {
      alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally { 
      if(typeof hideAdminLoading==='function') hideAdminLoading(); 
    }
  }

  function renderNotice() {
    const l = String(getV(currentNotice, 'level')).toLowerCase();
    const cat = document.getElementById('view-category');
    if (l === 'danger') cat.innerHTML = '<span class="m-badge bg-danger">í•„ë…</span>';
    else if (l === 'warn') cat.innerHTML = '<span class="m-badge bg-primary">ì¤‘ìš”</span>';
    else cat.textContent = 'ê³µì§€';

    document.getElementById('view-title').textContent = getV(currentNotice, 'title') || "ì œëª© ì—†ìŒ";
    
    // ğŸš¨ [í•µì‹¬ 3] ì‘ì„±ì ë…¸ì¶œ ë° ê¶Œí•œ ê´€ë¦¬
    const authorEmp = getV(currentNotice, 'authorEmpNo');
    
    // ê¸°ë³¸ì ìœ¼ë¡œ ë‚¨ì˜ ê¸€ì´ë©´ ì‚¬ë²ˆì„ í‘œì‹œ, ë‚´ ê¸€ì´ë©´ ë‚´ ì„¸ì…˜ ì´ë¦„(display_name) í‘œì‹œ
    let displayAuthor = authorEmp;
    if (authorEmp === window.CURRENT_USER_EMP_NO) {
        displayAuthor = window.CURRENT_USER_NAME;
    }
    
    // ë§Œì•½ ë°±ì—”ë“œì—ì„œ authorName ì»¬ëŸ¼ì„ ë³„ë„ë¡œ ì¤€ë‹¤ë©´ ê·¸ê²ƒì„ 1ìˆœìœ„ë¡œ ì”ë‹ˆë‹¤.
    document.getElementById('view-author').textContent = getV(currentNotice, 'authorName') || displayAuthor || "ìµëª…";
    
    document.getElementById('view-date').textContent = String(getV(currentNotice, 'createdAt') || "--.--.--").substring(0, 16);
    document.getElementById('view-count').textContent = getV(currentNotice, 'viewCount') || 0;
    
    const bodyText = getV(currentNotice, 'body') || getV(currentNotice, 'content') || "";
    document.getElementById('view-body').innerHTML = bodyText;

    // ğŸš¨ [í•µì‹¬ 4] ë³¸ì¸ì´ ì“´ ê¸€ì¼ ë•Œë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ë…¸ì¶œì‹œí‚µë‹ˆë‹¤!
    const actionBtns = document.getElementById('author-action-btns');
    if (actionBtns) {
        if (authorEmp && authorEmp === window.CURRENT_USER_EMP_NO) {
            actionBtns.style.display = 'flex';
        } else {
            actionBtns.style.display = 'none';
        }
    }
  }

  function enterEditMode() {
    showEditMode(false);
    document.getElementById('edit-page-title').textContent = "ê³µì§€ ìˆ˜ì •";
    document.getElementById('edit-title').value = getV(currentNotice, 'title');
    document.getElementById('edit-level').value = getV(currentNotice, 'level') || "normal";
    document.getElementById('edit-pinned').checked = (getV(currentNotice, 'isPinned') == 1);
    setTimeout(() => {
      const editor = tinymce.get('notice-editor');
      if(editor) editor.setContent(getV(currentNotice, 'body') || getV(currentNotice, 'content') || "");
    }, 500);
  }

  function cancelEdit() { if(!targetNoticeId) location.href = 'board.html'; else showViewMode(); }

  // âœ… ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ (ì„œë²„ì— ìƒíƒœë¥¼ deletedë¡œ ì „ì†¡)
  async function deleteNotice() {
    if(!confirm("ì´ ê³µì§€ì‚¬í•­ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const payload = {
      mode: 'upsertAnnouncement',
      noticeId: targetNoticeId,
      title: getV(currentNotice, 'title'),
      body: getV(currentNotice, 'body') || getV(currentNotice, 'content') || "",
      level: getV(currentNotice, 'level') || "normal",
      isPinned: getV(currentNotice, 'isPinned') == 1 ? 1 : 0,
      status: 'deleted',
      authorEmpNo: getV(currentNotice, 'authorEmpNo') // ì‚­ì œ ì‹œì—ë„ ì›ì‘ì ì •ë³´ ìœ ì§€
    };

    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method:'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if(json.ok || json.result === "success") {
          alert("ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.href = 'board.html';
      } else {
          alert("ì‚­ì œ ì‹¤íŒ¨: " + (json.message || "ì›ì¸ ë¶ˆëª…"));
      }
    } catch(e) { 
      alert("ì‚­ì œ ì¤‘ ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
    }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  async function saveNotice(status) {
    const title = document.getElementById('edit-title').value.trim();
    const body = tinymce.get('notice-editor').getContent();
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const payload = {
      mode: 'upsertAnnouncement',
      noticeId: targetNoticeId || "",
      title: title, body: body,
      level: document.getElementById('edit-level').value,
      isPinned: document.getElementById('edit-pinned').checked ? 1 : 0,
      status: status, 
      // ğŸš¨ [í•µì‹¬ 5] DB ì €ì¥ ì‹œ ë¬´ì¡°ê±´ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ "ì‚¬ë²ˆ(EMP_NO)"ì„ ê¸°ì¤€ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤!
      authorEmpNo: window.CURRENT_USER_EMP_NO 
    };

    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method:'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      const json = await res.json();
      const newId = json.noticeId || json.id || targetNoticeId;
      location.href = `notice.html?id=${newId}`;
    } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

// âœ… 1. ëŒ“ê¸€ ë¡œë“œ (ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì‹¤ì‹œê°„ ë°˜ì˜ì„ ìœ„í•œ ìºì‹œ ë°©ì§€ ì ìš©)
  async function loadComments() {
    try {
      // ğŸš¨ [í•µì‹¬] êµ¬ê¸€ ì„œë²„ê°€ ì˜ˆì „ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ì§€ ëª»í•˜ë„ë¡ ì£¼ì†Œ ëì— 'í˜„ì¬ ì‹œê°„'ì„ ëª°ë˜ ë¶™ì—¬ ë¬´ì¡°ê±´ ìµœì‹  ë°ì´í„°ë¥¼ ê°•ì œ í˜¸ì¶œí•©ë‹ˆë‹¤.
      const timestamp = new Date().getTime();
      const res = await fetch(`${window.CHEESE_ADMIN_API_BASE}?mode=listComments&noticeId=${targetNoticeId}&_t=${timestamp}`);
      const json = await res.json();
      currentComments = json.comments || json.items || json.data || [];
      renderComments();
    } catch(e) { console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:", e); }
  }

  // âœ… 2. ëŒ“ê¸€ ë“±ë¡ (ì•ŒëŸ¿ì°½ ì¶”ê°€ & ì„œë²„ ì €ì¥ ì™„ë²½ ëŒ€ê¸°)
  async function submitComment(parentId = "") {
    const inputId = parentId ? `reply-text-${parentId}` : 'new-comment-body';
    const text = document.getElementById(inputId).value;
    
    if(!text.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    
    // ğŸš¨ [í•µì‹¬] ìš”ì²­í•˜ì‹  ë“±ë¡ í™•ì¸ ì•ŒëŸ¿ì°½ ì¶”ê°€!
    if(!confirm("ëŒ“ê¸€ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const payload = { 
      mode: 'addComment', 
      noticeId: targetNoticeId, 
      parentCommentId: parentId, 
      body: text, 
      authorEmpNo: window.CURRENT_USER_EMP_NO, 
      authorName: window.CURRENT_USER_NAME 
    };

    // ë¡œë”© í™”ë©´ì„ ë„ì›Œ ì¤‘ë³µ í´ë¦­ ë°©ì§€
    if(typeof showAdminLoading==='function') showAdminLoading("ëŒ“ê¸€ ë“±ë¡ ì¤‘...");
    
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { 
          method:'POST', 
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
          body: JSON.stringify(payload) 
      });
      
      // ğŸš¨ [í•µì‹¬] ì„œë²„ê°€ ì‹œíŠ¸ì— ì €ì¥ì„ 'ì™„ì „íˆ ëë§ˆì³¤ë‹¤'ê³  ì‘ë‹µí•  ë•Œê¹Œì§€ í™•ì‹¤í•˜ê²Œ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
      const json = await res.json(); 

      if(json.ok || json.result === "success") {
          document.getElementById(inputId).value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
          if(parentId) toggleReplyForm(parentId);      // ë‹µê¸€ ì°½ ë‹«ê¸°
          
          // ìƒˆë¡œê³ ì¹¨(F5) ì—†ì´ ì¦‰ì‹œ ìµœì‹  ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ë§Œ ì‹¹ ë‹¤ì‹œ ê·¸ë ¤ì¤ë‹ˆë‹¤!
          await loadComments();
      } else {
          alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ëŒ“ê¸€ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      }
    } catch(e) { 
      alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); 
    } finally {
      if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  }

  // âœ… 3. ëŒ“ê¸€ ì‚­ì œ (ì‹¤ì‹œê°„ ë°˜ì˜ë˜ë„ë¡ ë™ê¸°í™”)
  async function deleteComment(id) {
    if(!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { 
          method:'POST', 
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
          body: JSON.stringify({ mode:'setCommentStatus', commentId: id, status:'deleted' }) 
      });
      
      await res.json(); // ì‚­ì œ ì²˜ë¦¬ê°€ ì™„ì „íˆ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
      
      // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¦‰ì‹œ í™”ë©´ì—ì„œ ì§€ì›Œì§!
      await loadComments();
    } catch(e) { 
      alert("ì‚­ì œ ì‹¤íŒ¨"); 
    } finally {
      if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  }

  function renderComments() {
    const root = document.getElementById('comment-list-root');
    const countEl = document.getElementById('comment-total-count');
    root.innerHTML = "";
    const active = currentComments.filter(c => c.status !== 'deleted');
    countEl.textContent = active.length;
    if(active.length === 0) { root.innerHTML = '<div style="text-align:center; padding:30px; color:#999; font-size:0.9rem;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</div>'; return; }

    const isNull = (v) => !v || v === "" || v === "null" || v === "undefined";
    const parents = active.filter(c => isNull(getV(c, 'parentCommentId')));
    const children = active.filter(c => !isNull(getV(c, 'parentCommentId')));

    parents.sort((a,b) => new Date(getV(a, 'createdAt')) - new Date(getV(b, 'createdAt')));

    parents.forEach(p => {
      root.appendChild(createCommentEl(p, false));
      const pId = getV(p, 'commentId') || getV(p, 'id');
      const replies = children.filter(c => String(getV(c, 'parentCommentId')) === String(pId));
      replies.forEach(r => root.appendChild(createCommentEl(r, true)));
    });
  }

  function createCommentEl(c, isReply) {
    const div = document.createElement('div');
    div.className = `comment-item ${isReply ? 'is-reply' : ''}`;
    const cId = getV(c, 'commentId') || getV(c, 'id');
    div.innerHTML = `
      <div class="comment-user"><span class="user-name">${getV(c, 'authorName') || getV(c, 'authorEmpNo') || "ìµëª…"}</span><span class="comment-date">${getV(c, 'createdAt')}</span></div>
      <div class="comment-text">${getV(c, 'body')}</div>
      <div class="comment-btns">
        ${!isReply ? `<button class="btn-comment-sm" onclick="toggleReplyForm('${cId}')">ë‹µê¸€</button>` : ''}
        ${getV(c, 'authorEmpNo') === window.CURRENT_USER_EMP_NO ? `<button class="btn-comment-sm" style="color:var(--danger);" onclick="deleteComment('${cId}')">ì‚­ì œ</button>` : ''}
      </div>
      <div id="reply-form-${cId}" style="display:none; margin-top:10px;">
        <textarea class="comment-textarea" rows="2" id="reply-text-${cId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:5px;"><button class="btn-submit" style="padding:4px 12px; font-size:0.8rem;" onclick="submitComment('${cId}')">ë“±ë¡</button></div>
      </div>`;
    return div;
  }

  function toggleReplyForm(id) { const f = document.getElementById(`reply-form-${id}`); if(f) f.style.display = f.style.display === 'none' ? 'block' : 'none'; }

  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      el.textContent = `Ver: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [Auth&Delete-Fix]`;
  })();
</script>
</body>
</html>
