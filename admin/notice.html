<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ ìƒì„¸ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
    // âœ… ê³µì§€ì‚¬í•­ ì „ìš© API ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
    
    // ğŸš¨ ì„ì‹œ ì‘ì„±ì ì •ë³´ (ì‹¤ì œ ìš´ì˜ ì‹œ ì‚¬ë‚´ ë¡œê·¸ì¸ ì„¸ì…˜ ì •ë³´ë¡œ ì¹˜í™˜í•˜ì„¸ìš”)
    window.CURRENT_USER_EMP_NO = "CL-ADMIN";
    window.CURRENT_USER_NAME = "ìµœê³ ê´€ë¦¬ì";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    
    .dashboard-layout { display: block; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }
    
    /* ë²„ì „ í‘œì‹œ ë±ƒì§€ */
    .sys-version-large { font-size: 1.1rem; font-weight: 800; color: #ef4444; background: #fee2e2; display: inline-block; padding: 4px 12px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* ë²„íŠ¼ ë° í¼ */
    .btn-back { background: #f1f5f9; color: #475569; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-back:hover { background: #e2e8f0; color: #1e293b; }
    
    .btn-primary { background: #3b82f6; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
    .btn-primary:hover { background: #2563eb; transform: translateY(-2px); }

    .btn-secondary { background: #fff; color: #475569; border: 1px solid #cbd5e1; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; }
    .btn-secondary:hover { background: #f8fafc; border-color: #94a3b8; }

    .styled-input { width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; box-sizing: border-box; font-family: inherit; }
    .styled-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .input-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 700; color: #475569; }

    /* ë·° ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .notice-header-box { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); border-top: 4px solid #3b82f6; }
    .notice-title { font-size: 1.8rem; font-weight: 800; color: #1e293b; margin: 16px 0; line-height: 1.3; }
    .notice-meta { display: flex; flex-wrap: wrap; gap: 16px; color: #64748b; font-size: 0.9rem; font-weight: 500; border-top: 1px solid #f1f5f9; padding-top: 16px; }
    .meta-item { display: flex; align-items: center; gap: 6px; }

    /* ì—ë””í„° ë Œë”ë§ ì˜ì—­ (todo_manageì™€ ë™ì¼) */
    .view-content-box { 
      padding: 40px; background: #ffffff; border: 1px solid #cbd5e1; border-radius: 16px; 
      min-height: 300px; line-height: 1.8; color: #334155; font-size: 1.05rem; word-break: break-word; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); margin-bottom: 32px;
    }
    .view-content-box img { max-width: 100%; height: auto; border-radius: 8px; }
    .view-content-box h1, .view-content-box h2, .view-content-box h3 { color: #1e293b; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 800; }
    .view-content-box ul, .view-content-box ol { padding-left: 24px; margin: 12px 0; }
    .view-content-box blockquote { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0; color: #1e40af; font-style: italic; }
    .view-content-box table { width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; margin: 16px 0; }
    .view-content-box td, .view-content-box th { border: 1px solid #cbd5e1; padding: 12px; }

    /* ë±ƒì§€ */
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 800; display: inline-block; }
    .badge-danger { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; }
    .badge-warn { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
    .badge-normal { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

    /* ëŒ“ê¸€ ì„¹ì…˜ */
    .comment-section { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 32px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
    .comment-section-title { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
    
    .comment-input-area { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 24px; }
    
    .comment-list { display: flex; flex-direction: column; gap: 16px; }
    .comment-card { padding: 16px; border-bottom: 1px solid #f1f5f9; position: relative; }
    .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .comment-author { font-weight: 800; color: #334155; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
    .comment-author::before { content: 'ğŸ‘¤'; font-size: 1.1rem; }
    .comment-date { font-size: 0.8rem; color: #94a3b8; }
    .comment-body { color: #1e293b; line-height: 1.6; font-size: 0.95rem; white-space: pre-wrap; }
    
    .comment-actions { margin-top: 10px; display: flex; gap: 12px; }
    .reply-btn { background: none; border: none; color: #3b82f6; font-size: 0.85rem; font-weight: 700; cursor: pointer; padding: 0; }
    .reply-btn:hover { text-decoration: underline; }
    
    .reply-container { margin-left: 40px; padding-left: 16px; border-left: 3px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; margin-top: 12px; }
    .reply-card { background: #f8fafc; padding: 16px; border-radius: 12px; }
    
    .reply-input-box { margin-top: 12px; display: none; } /* ëŒ€ëŒ“ê¸€ ì…ë ¥ì°½ ìˆ¨ê¹€ ì²˜ë¦¬ */

    /* ì—ë””í„° í•„ìˆ˜ ì˜µì…˜ */
    .tox-tinymce-aux { z-index: 99999 !important; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px;">
            <button class="btn-back" onclick="location.href='board.html'">â† ëª©ë¡ìœ¼ë¡œ</button>
            <div id="sysVersion" class="sys-version-large">Checking version...</div>
        </div>

        <div id="view-wrapper" style="display: none;">
            <div class="notice-header-box">
                <div id="view-badges" style="margin-bottom: 12px;"></div>
                <h2 id="view-title" class="notice-title">ê³µì§€ì‚¬í•­ ì œëª©</h2>
                <div class="notice-meta">
                    <div class="meta-item">ğŸ‘¤ <span id="view-author">ê´€ë¦¬ì</span></div>
                    <div class="meta-item">ğŸ“… <span id="view-date">2026-01-01</span></div>
                    <div class="meta-item" style="margin-left: auto; color: #ef4444;">ğŸ‘ï¸ ì¡°íšŒ <span id="view-count">0</span></div>
                </div>
            </div>

            <div id="view-body" class="view-content-box"></div>

            <div style="text-align: right; margin-bottom: 32px;">
                <button id="btn-edit-notice" class="btn-secondary" onclick="enterEditMode()">âœï¸ ê³µì§€ ìˆ˜ì •í•˜ê¸°</button>
            </div>

            <div class="comment-section">
                <div class="comment-section-title">ğŸ’¬ ëŒ“ê¸€ <span id="comment-total-count" style="color: #3b82f6;">0</span>ê°œ</div>
                
                <div class="comment-input-area">
                    <textarea id="new-comment-body" class="styled-input" rows="3" placeholder="ê³µì§€ì‚¬í•­ì— ëŒ€í•œ ì˜ê²¬ì´ë‚˜ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”." style="resize: vertical;"></textarea>
                    <div style="text-align: right; margin-top: 12px;">
                        <button class="btn-primary" onclick="submitComment()">ëŒ“ê¸€ ë“±ë¡</button>
                    </div>
                </div>

                <div id="comment-list-root" class="comment-list">
                    </div>
            </div>
        </div>

        <div id="edit-wrapper" style="display: none;">
            <div class="notice-header-box" style="border-top-color: #10b981;">
                <h2 style="margin: 0 0 24px 0; font-weight: 800; color: #1e293b;" id="edit-page-title">ìƒˆ ê³µì§€ ì‘ì„±</h2>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <label class="input-label">ê³µì§€ ì œëª©</label>
                        <input type="text" id="edit-title" class="styled-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="font-size: 1.1rem; font-weight: 700;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label class="input-label">ì¤‘ìš”ë„ (ë±ƒì§€)</label>
                        <select id="edit-level" class="styled-input">
                            <option value="normal">ğŸ”µ ì¼ë°˜ ì•ˆë‚´</option>
                            <option value="warn">âš ï¸ ì¤‘ìš”</option>
                            <option value="danger">ğŸš¨ í•„ë… (ê¸´ê¸‰)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px; display: flex; align-items: center; padding-top: 24px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; color: #ef4444;">
                            <input type="checkbox" id="edit-pinned" style="transform: scale(1.3);">
                            ğŸ“Œ ê²Œì‹œíŒ ìƒë‹¨ì— ì¹´ë“œ í˜•íƒœë¡œ í•­ìƒ ê³ ì •í•˜ê¸°
                        </label>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label class="input-label">ë³¸ë¬¸ ë‚´ìš©</label>
                <textarea id="notice-editor" style="width: 100%; height: 600px;"></textarea>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="btn-cancel-edit" class="btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-secondary" onclick="saveNotice('draft')">ğŸ’¾ ì„ì‹œì €ì¥</button>
                    <button class="btn-primary" style="background: #10b981;" onclick="saveNotice('published')">ğŸš€ ê³µì§€ ë°œí–‰í•˜ê¸°</button>
                </div>
            </div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "board"; 
  
  const urlParams = new URLSearchParams(window.location.search);
  const targetNoticeId = urlParams.get('id');
  
  let currentNotice = null;
  let currentComments = [];
  let isTinyMCEInitialized = false;

  document.addEventListener('DOMContentLoaded', () => {
      initPage();
  });

  async function initPage() {
      if (!targetNoticeId) {
          // íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ 'ìƒˆ ê¸€ ì‘ì„±' ëª¨ë“œ
          document.getElementById('view-wrapper').style.display = 'none';
          document.getElementById('edit-wrapper').style.display = 'block';
          document.getElementById('edit-page-title').textContent = "âœ¨ ìƒˆ ê³µì§€ ì‘ì„±";
          await initTinyMCE();
      } else {
          // ê¸°ì¡´ ê¸€ 'ì¡°íšŒ' ëª¨ë“œ
          document.getElementById('view-wrapper').style.display = 'block';
          document.getElementById('edit-wrapper').style.display = 'none';
          await loadNoticeData();
      }
  }

  // âœ… TinyMCE ì§€ì—° ë¡œë”© (ëª¨ë‹¬ ì§¤ë¦¼ ë°©ì§€)
  async function initTinyMCE() {
      if (isTinyMCEInitialized) return;
      await tinymce.init({
          selector: '#notice-editor',
          height: 600,
          language: 'ko_KR',
          plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen table help wordcount',
          toolbar: [
            'fontfamily fontsize blocks | bold italic underline strikethrough | forecolor backcolor removeformat',
            'alignleft aligncenter alignright alignjustify | bullist numlist | outdent indent | table link image | code fullscreen'
          ],
          toolbar_mode: 'wrap',
          menubar: false,
          branding: false,
          font_family_formats: 'Pretendard=Pretendard,sans-serif; ë§‘ì€ ê³ ë”•=Malgun Gothic,sans-serif; ë‹ì›€=Dotum,sans-serif; êµ´ë¦¼=Gulim,sans-serif; Arial=arial,helvetica,sans-serif;',
          valid_elements: '*[*]',
          extended_valid_elements: '*[*]',
          verify_html: false
      });
      isTinyMCEInitialized = true;
  }

  // ==========================================
  // [ì¡°íšŒ ëª¨ë“œ] ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
  // ==========================================
  async function loadNoticeData() {
      if(typeof showAdminLoading==='function') showAdminLoading("ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
      try {
          // 1. ê³µì§€ ì¡°íšŒ
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAnnouncement&noticeId=" + targetNoticeId);
          const json = await res.json();
          
          if(json.ok && json.announcement) {
              currentNotice = json.announcement;
              renderViewMode();
              
              // 2. ì¡°íšŒìˆ˜ 1 ì¦ê°€ (ë¹„ë™ê¸° ì²˜ë¦¬)
              fetch(window.CHEESE_ADMIN_API_BASE, { 
                  method: 'POST', 
                  body: JSON.stringify({ mode: 'incrementNoticeView', noticeId: targetNoticeId })
              });

              // 3. ëŒ“ê¸€ ë¡œë“œ
              await loadCommentsData();
          } else {
              alert("ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³µì§€ì‚¬í•­ì…ë‹ˆë‹¤.");
              location.href = 'board.html';
          }
      } catch(e) {
          console.error(e);
          alert("ë°ì´í„° í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      } finally {
          if(typeof hideAdminLoading==='function') hideAdminLoading();
      }
  }

  function renderViewMode() {
      let badgeHtml = '';
      if (currentNotice.status === 'draft') badgeHtml += `<span class="badge badge-draft" style="margin-right:8px;">ğŸ“ ì„ì‹œì €ì¥</span>`;
      if (currentNotice.isPinned == 1) badgeHtml += `<span class="badge badge-danger" style="margin-right:8px;">ğŸ“Œ ìƒë‹¨ê³ ì •</span>`;
      
      if (currentNotice.level === 'danger') badgeHtml += `<span class="badge badge-danger">ğŸš¨ í•„ë…</span>`;
      else if (currentNotice.level === 'warn') badgeHtml += `<span class="badge badge-warn">âš ï¸ ì¤‘ìš”</span>`;
      else badgeHtml += `<span class="badge badge-normal">ğŸ”µ ì•ˆë‚´</span>`;

      document.getElementById('view-badges').innerHTML = badgeHtml;
      document.getElementById('view-title').textContent = currentNotice.title || "ì œëª© ì—†ìŒ";
      document.getElementById('view-author').textContent = currentNotice.authorEmpNo || "ì‹œìŠ¤í…œ";
      document.getElementById('view-date').textContent = currentNotice.createdAt || "";
      document.getElementById('view-count').textContent = parseInt(currentNotice.viewCount || 0) + 1; // ë°”ë¡œ 1 ë”í•´ì„œ ë³´ì—¬ì¤Œ

      // TinyMCEë¡œ ì €ì¥ëœ HTMLì„ ë·°ì–´ ë°•ìŠ¤ì— ê·¸ëŒ€ë¡œ ë Œë”ë§
      document.getElementById('view-body').innerHTML = currentNotice.body || "<p style='color:#94a3b8;'>ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
  }

  // ==========================================
  // [ìˆ˜ì • ëª¨ë“œ] ì „í™˜ ë° ì €ì¥
  // ==========================================
  async function enterEditMode() {
      document.getElementById('view-wrapper').style.display = 'none';
      document.getElementById('edit-wrapper').style.display = 'block';
      document.getElementById('edit-page-title').textContent = "âœï¸ ê³µì§€ì‚¬í•­ ìˆ˜ì •";
      
      await initTinyMCE();

      document.getElementById('edit-title').value = currentNotice.title || "";
      document.getElementById('edit-level').value = currentNotice.level || "normal";
      document.getElementById('edit-pinned').checked = (currentNotice.isPinned == 1);
      
      tinymce.get('notice-editor').setContent(currentNotice.body || "");
  }

  function cancelEdit() {
      if (!targetNoticeId) {
          location.href = 'board.html'; // ìƒˆ ê¸€ ì“°ë‹¤ ì·¨ì†Œí•˜ë©´ ëª©ë¡ìœ¼ë¡œ
      } else {
          document.getElementById('edit-wrapper').style.display = 'none';
          document.getElementById('view-wrapper').style.display = 'block'; // ìˆ˜ì • ì·¨ì†Œí•˜ë©´ ë·°ì–´ë¡œ
      }
  }

  async function saveNotice(statusToSave) {
      const title = document.getElementById('edit-title').value.trim();
      const level = document.getElementById('edit-level').value;
      const isPinned = document.getElementById('edit-pinned').checked ? 1 : 0;
      const bodyHTML = tinymce.get('notice-editor').getContent();

      if (!title) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (!bodyHTML || bodyHTML === "<p><br></p>") return alert("ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      const payload = {
          mode: 'upsertAnnouncement',
          noticeId: targetNoticeId || "", // ì—†ìœ¼ë©´ ìƒˆ ê¸€ ìƒì„±ë¨
          title: title,
          body: bodyHTML,
          level: level,
          isPinned: isPinned,
          status: statusToSave,
          authorEmpNo: window.CURRENT_USER_EMP_NO
      };

      if(typeof showAdminLoading==='function') showAdminLoading("ê³µì§€ì‚¬í•­ ì €ì¥ ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: 'POST', body: JSON.stringify(payload) });
          const json = await res.json();
          
          if(json.ok) {
              // ì €ì¥ ì„±ê³µ ì‹œ í•´ë‹¹ ê³µì§€ì‚¬í•­ì˜ ì¡°íšŒ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
              location.href = `notice.html?id=${json.noticeId || targetNoticeId}`;
          } else {
              alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + json.message);
          }
      } catch(e) {
          console.error(e);
          alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
          if(typeof hideAdminLoading==='function') hideAdminLoading();
      }
  }

  // ==========================================
  // [ëŒ“ê¸€ ì‹œìŠ¤í…œ] ë¡œë“œ ë° ë Œë”ë§
  // ==========================================
  async function loadCommentsData() {
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=listComments&noticeId=" + targetNoticeId);
          const json = await res.json();
          if(json.ok) {
              // active ìƒíƒœì¸ ëŒ“ê¸€ë§Œ í•„í„°ë§
              currentComments = (json.comments || []).filter(c => c.status === 'active');
              document.getElementById('comment-total-count').textContent = currentComments.length;
              renderCommentsUI();
          }
      } catch(e) { console.error("ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨", e); }
  }

  function renderCommentsUI() {
      const root = document.getElementById('comment-list-root');
      root.innerHTML = '';

      if (currentComments.length === 0) {
          root.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8; font-weight:600; background:#f8fafc; border-radius:12px;">ì•„ì§ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`;
          return;
      }

      // 1. ë¶€ëª¨ ëŒ“ê¸€ê³¼ ëŒ€ëŒ“ê¸€ ë¶„ë¦¬
      const parents = currentComments.filter(c => !c.parentCommentId);
      const children = currentComments.filter(c => c.parentCommentId);

      // ì‹œê°„ìˆœ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
      parents.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
      children.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));

      parents.forEach(parent => {
          // ë¶€ëª¨ ë Œë”ë§
          root.appendChild(createCommentHTML(parent, false));

          // í•´ë‹¹ ë¶€ëª¨ì˜ ëŒ€ëŒ“ê¸€ ë Œë”ë§
          const replies = children.filter(c => c.parentCommentId === parent.commentId);
          if (replies.length > 0) {
              const replyContainer = document.createElement('div');
              replyContainer.className = 'reply-container';
              replies.forEach(reply => {
                  replyContainer.appendChild(createCommentHTML(reply, true));
              });
              root.appendChild(replyContainer);
          }
      });
  }

  function createCommentHTML(item, isReply) {
      const el = document.createElement('div');
      el.className = isReply ? 'reply-card' : 'comment-card';

      const dateStr = item.createdAt || "";
      const author = item.authorName || item.authorEmpNo || "ìµëª…";

      // ì›ë³¸ ëŒ“ê¸€ì—ë§Œ 'ë‹µê¸€ ë‹¬ê¸°' ë²„íŠ¼ í‘œì‹œ
      const replyBtnHtml = !isReply ? `<button class="reply-btn" onclick="toggleReplyInput('${item.commentId}')">â†³ ë‹µê¸€ ë‹¬ê¸°</button>` : '';
      
      // ë‚´ ëŒ“ê¸€ì¸ ê²½ìš° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      const deleteBtnHtml = (item.authorEmpNo === window.CURRENT_USER_EMP_NO) 
          ? `<button class="reply-btn" style="color:#ef4444;" onclick="deleteComment('${item.commentId}')">ì‚­ì œ</button>` : '';

      el.innerHTML = `
          <div class="comment-header">
              <div class="comment-author">${author}</div>
              <div class="comment-date">${dateStr}</div>
          </div>
          <div class="comment-body">${(item.body || "").replace(/\n/g, '<br>')}</div>
          <div class="comment-actions">
              ${replyBtnHtml}
              ${deleteBtnHtml}
          </div>
          
          ${!isReply ? `
          <div id="reply-box-${item.commentId}" class="reply-input-box">
              <textarea id="reply-input-${item.commentId}" class="styled-input" rows="2" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
              <div style="text-align:right; margin-top:8px;">
                  <button class="btn-secondary" style="padding:8px 16px; font-size:0.85rem;" onclick="toggleReplyInput('${item.commentId}')">ì·¨ì†Œ</button>
                  <button class="btn-primary" style="padding:8px 16px; font-size:0.85rem;" onclick="submitComment('${item.commentId}')">ë‹µê¸€ ë“±ë¡</button>
              </div>
          </div>` : ''}
      `;
      return el;
  }

  function toggleReplyInput(commentId) {
      const box = document.getElementById(`reply-box-${commentId}`);
      if (box.style.display === 'block') {
          box.style.display = 'none';
      } else {
          // ë‹¤ë¥¸ ì—´ë¦° ì°½ë“¤ ë‹¤ ë‹«ê¸°
          document.querySelectorAll('.reply-input-box').forEach(el => el.style.display = 'none');
          box.style.display = 'block';
          document.getElementById(`reply-input-${commentId}`).focus();
      }
  }

  async function submitComment(parentCommentId = "") {
      const inputId = parentCommentId ? `reply-input-${parentCommentId}` : 'new-comment-body';
      const bodyText = document.getElementById(inputId).value.trim();

      if (!bodyText) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      const payload = {
          mode: 'addComment',
          noticeId: targetNoticeId,
          parentCommentId: parentCommentId,
          body: bodyText,
          authorEmpNo: window.CURRENT_USER_EMP_NO,
          authorName: window.CURRENT_USER_NAME
      };

      if(typeof showAdminLoading==='function') showAdminLoading("ëŒ“ê¸€ ë“±ë¡ ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: 'POST', body: JSON.stringify(payload) });
          const json = await res.json();
          
          if(json.ok) {
              document.getElementById(inputId).value = '';
              await loadCommentsData(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ëŒ“ê¸€ë§Œ ë‹¤ì‹œ ë¡œë“œ
          } else {
              alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: " + json.message);
          }
      } catch(e) {
          console.error(e);
          alert("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
          if(typeof hideAdminLoading==='function') hideAdminLoading();
      }
  }

  async function deleteComment(commentId) {
      if(!confirm("ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      
      const payload = {
          mode: 'setCommentStatus',
          commentId: commentId,
          status: 'deleted',
          authorEmpNo: window.CURRENT_USER_EMP_NO
      };

      if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
      try {
          const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method: 'POST', body: JSON.stringify(payload) });
          const json = await res.json();
          if(json.ok) {
              await loadCommentsData();
          } else {
              alert("ì‚­ì œ ì‹¤íŒ¨: " + json.message);
          }
      } catch(e) { console.error(e); } 
      finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // ==========================================
  // ë²„ì „ ì •ë³´ í‘œì‹œ í•¨ìˆ˜ (ì¦‰ì‹œ ì‹¤í–‰)
  // ==========================================
  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      const versionTag = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [Notice-Update]`;
      
      el.textContent = `Version: ${versionTag}`;
  })();
</script>
</body>
</html>
