<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³µì§€ ìƒì„¸ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    /* âœ… ì „ì²´ ì»¨í…ì¸  í­ì„ ë„“ê²Œ */
    .notice-wrap{
      max-width: 1240px;      /* â† ë„“í˜ */
      margin: 0 auto;
      padding: 14px 14px 28px;
      box-sizing: border-box;
    }

    .notice-grid{
      display: grid;
      grid-template-columns: 1fr 380px; /* âœ… ë³¸ë¬¸ ë„“ê²Œ + ëŒ“ê¸€ ì‚¬ì´ë“œ ê³ ì •í­ */
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 980px){
      .notice-grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(15,23,42,0.06);
    }
    .card-title{
      font-weight:1000; letter-spacing:-0.02em;
      font-size:16px; line-height:1.25;
    }
    .meta{
      margin-top:6px;
      color:var(--sub);
      font-size:12px;
      font-weight:750;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-b{ padding:14px; }

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10);
      background:rgba(15,23,42,0.04);
      white-space:nowrap;
    }
    .tag--warn{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.28); }
    .tag--ok{ background:rgba(34,197,94,0.10); border-color:rgba(34,197,94,0.25); }
    .tag--bad{ background:rgba(239,68,68,0.10); border-color:rgba(239,68,68,0.25); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-primary{
      background: rgba(15,23,42,0.92);
      color:#fff;
      border-color: rgba(15,23,42,0.92);
    }

    /* âœ… ë³¸ë¬¸ ê°€ë…ì„± + í­ í™•ë³´ */
    .notice-body{
      font-size:14px;
      font-weight:650;
      line-height:1.75;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
      padding: 2px 0;
      min-height: 260px; /* â† â€œë‚´ìš© ê³µê°„ì´ ì¢€ ë” ë„“ê²Œâ€ */
    }

    .divider{ height:1px; background:rgba(15,23,42,0.08); margin:12px 0; }

    .muted{ color:var(--sub); font-size:12px; font-weight:750; }

    .comment-box{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .comment-author{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.10);
      background:rgba(2,6,23,0.02);
      font-size:12px;
      font-weight:900;
      color:var(--sub);
    }
    .comment-author strong{ color: var(--text); }

    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,0.14);
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 650;
      outline: none;
      box-sizing: border-box;
      background:#fff;
    }

    .comment-list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;   /* ì›í•˜ëŠ” ë†’ì´ */
      overflow: auto;
      padding-right: 6px;  /* ìŠ¤í¬ë¡¤ë°” ì—¬ë°± */
    }
    .comment-item{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.10);
      background:rgba(2,6,23,0.02);
    }
    .comment-top{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .comment-who{
      font-size:12px;
      font-weight:950;
      color: var(--text);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .comment-when{
      font-size:12px;
      font-weight:800;
      color: var(--sub);
      white-space:nowrap;
    }
    .comment-body{
      font-size:13px;
      font-weight:650;
      line-height:1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text);
    }

    .skeleton{ height:12px; border-radius:999px; background:rgba(15,23,42,0.08); overflow:hidden; position:relative; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-60%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-60%);} 100%{transform:translateX(160%);} }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="notice-wrap">
        <div class="notice-grid">
          <!-- âœ… ê³µì§€ ë³¸ë¬¸(ë„“ê²Œ) -->
          <section class="card">
            <div class="card-h">
              <div>
                <div class="card-title" id="noticeTitle">ë¡œë”©ì¤‘â€¦</div>
                <div class="meta">
                  <span id="noticeLevelTag" class="tag">ê³µì§€</span>
                  <span id="noticeAuthor">ì‘ì„±ì: -</span>
                  <span id="noticeUpdatedAt">ì—…ë°ì´íŠ¸: -</span>
                  <span id="noticeViewCount">ì¡°íšŒ: -</span>
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button type="button" class="btn" id="btnBack">ëª©ë¡</button>
              </div>
            </div>
            <div class="card-b">
              <div class="notice-body" id="noticeBody"></div>
              <div class="divider"></div>
              <div class="muted" id="noticePeriod">ê²Œì‹œê¸°ê°„: -</div>
            </div>
          </section>

          <!-- âœ… ëŒ“ê¸€ ì‚¬ì´ë“œ -->
          <aside class="card">
            <div class="card-h">
              <div>
                <div class="card-title">ğŸ’¬ ëŒ“ê¸€</div>
                <div class="meta">
                  <span id="commentCountMeta">0ê°œ</span>
                  <span id="commentStatusMeta" class="tag tag--ok">í™œì„±</span>
                </div>
              </div>
              <div>
                <button type="button" class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>

            <div class="card-b">
              <div class="comment-box">
                <!-- âœ… ì‘ì„±ì ìë™ í‘œì‹œ(ì„¸ì…˜) -->
                <div class="comment-author" id="sessionUserBox">
                  <div>ì‘ì„±ì: <strong id="sessionUserText">-</strong></div>
                  <div class="muted" id="sessionUserHint"></div>
                </div>

                <textarea id="commentBody" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

                <button type="button" class="btn btn-primary" id="btnAddComment">
                  ëŒ“ê¸€ ë“±ë¡
                </button>

                <ul class="comment-list" id="commentList">
                  <li class="comment-item">
                    <div class="skeleton" style="width:78%"></div>
                    <div style="height:8px"></div>
                    <div class="skeleton" style="width:55%"></div>
                  </li>
                </ul>

                <div class="muted">* ëŒ€ëŒ“ê¸€(parentCommentId)ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ UI ë¶™ì´ë©´ ë¼.</div>
              </div>
            </div>
          </aside>
        </div>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    // âœ… ë„¤ WebApp ì£¼ì†Œ
    const API_BASE = window.ADMIN_API_URL || 'https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec';

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function qs(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || '';
    }

    //ì„¸ì…˜ ì •ë³´
    function getSessionUser_(){
      const empNo = (sessionStorage.getItem("cheese_admin_emp_no") || "").trim();
      const name  = (sessionStorage.getItem("cheese_admin_display_name") || "").trim();
      const loginId = (sessionStorage.getItem("cheese_admin_login_id") || "").trim();
      const role = (sessionStorage.getItem("cheese_admin_role") || "").trim();
    
      if(!empNo) return null;
    
      return {
        empNo,
        name,
        loginId,
        role
        // emailì€ í˜„ì¬ ì„¸ì…˜ì— ì—†ìœ¼ë‹ˆ ë¹ˆê°’ìœ¼ë¡œ ë³´ë‚´ë©´ ë¨
      };
    }

    function mountShell_(){
      // header
      const headerFn = window.renderAdminHeader || window.mountAdminHeader;
      if (typeof headerFn === 'function') {
        try{ headerFn({ mountId:'admin-header-slot', badgeText:'notice', subtitle:'ê³µì§€ ìƒì„¸' }); }catch(e){}
      }
      // menu
      const menuFn = window.renderAdminMenu || window.renderAdminSidebar || window.mountAdminMenu;
      if (typeof menuFn === 'function') {
        try{ menuFn({ mountId:'admin-menu-slot', active:'board' }); }catch(e){}
      }
    }

    function levelTag_(lvl){
      const v = String(lvl||'normal').toLowerCase();
      if (v === 'danger') return `<span class="tag tag--bad">í•„ë…</span>`;
      if (v === 'warn') return `<span class="tag tag--warn">ì¤‘ìš”</span>`;
      return `<span class="tag">ê³µì§€</span>`;
    }

    function setCommentStatusTag_(allowComments){
      const el = document.getElementById('commentStatusMeta');
      if (!el) return;
      if (Number(allowComments||0) === 1) {
        el.className = 'tag tag--ok';
        el.textContent = 'í™œì„±';
      } else {
        el.className = 'tag tag--bad';
        el.textContent = 'ë¹„í™œì„±';
      }
    }

    async function apiGet_(params){
      const url = API_BASE + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:'GET' });
      return await res.json();
    }

    async function apiPost_(params){
      const body = new URLSearchParams(params).toString();
      const res = await fetch(API_BASE, {
        method:'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
      return await res.json();
    }

    async function loadNotice_(noticeId){
      // ìƒì„¸ ì¡°íšŒ
      const j = await apiGet_({ mode:'getAnnouncement', noticeId });
      if(!j || j.ok !== true || !j.notice){
        document.getElementById('noticeTitle').textContent = 'ê³µì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('noticeBody').textContent = j && j.message ? String(j.message) : '';
        return null;
      }

      const n = j.notice;
      document.getElementById('noticeTitle').textContent = n.title || '(ì œëª© ì—†ìŒ)';
      document.getElementById('noticeLevelTag').outerHTML = levelTag_(n.level);
      document.getElementById('noticeAuthor').textContent = 'ì‘ì„±ì: ' + (n.authorEmpNo || '-');
      document.getElementById('noticeUpdatedAt').textContent = 'ì—…ë°ì´íŠ¸: ' + (n.updatedAt || n.createdAt || '-');
      document.getElementById('noticeViewCount').textContent = 'ì¡°íšŒ: ' + String(n.viewCount ?? '-');

      document.getElementById('noticeBody').textContent = n.body || '';
      const period = `ê²Œì‹œê¸°ê°„: ${n.startAt || '-'} ~ ${n.endAt || '-'}`;
      document.getElementById('noticePeriod').textContent = period;

      document.getElementById('commentCountMeta').textContent = (Number(n.commentCount||0)) + 'ê°œ';
      setCommentStatusTag_(n.allowComments);

      return n;
    }

    async function incrementView_(noticeId){
      // ì¡°íšŒìˆ˜ ì¦ê°€(ì‹¤íŒ¨í•´ë„ UX ì˜í–¥ ìµœì†Œ)
      try{ await apiPost_({ mode:'incrementNoticeView', noticeId }); }catch(e){}
    }

    async function loadComments_(noticeId){
      const list = document.getElementById('commentList');
      list.innerHTML = '';

      const j = await apiGet_({ mode:'listComments', noticeId, includeHidden:'0', includeDeleted:'0' });
      if(!j || j.ok !== true){
        list.innerHTML = `<li class="muted">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>`;
        return;
      }

      const items = Array.isArray(j.items) ? j.items : [];
      document.getElementById('commentCountMeta').textContent = items.length + 'ê°œ';

      if(items.length === 0){
        list.innerHTML = `<li class="muted">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</li>`;
        return;
      }

      items.forEach(c=>{
        const who = c.authorEmpNo || c.authorName || c.authorEmail || '-';
        const when = c.createdAt || '';
        const li = document.createElement('li');
        li.className = 'comment-item';
        li.innerHTML = `
          <div class="comment-top">
            <div class="comment-who">
              <span>${escapeHtml(who)}</span>
              ${c.authorName ? `<span class="muted">(${escapeHtml(c.authorName)})</span>` : ''}
            </div>
            <div class="comment-when">${escapeHtml(when)}</div>
          </div>
          <div class="comment-body">${escapeHtml(c.body || '')}</div>
        `;
        list.appendChild(li);
      });
    }

    function bindSessionUserUI_(){
      const u = getSessionUser_();
      const text = document.getElementById('sessionUserText');
      const hint = document.getElementById('sessionUserHint');
      const btn  = document.getElementById('btnAddComment');

      if(u && u.empNo){
        text.textContent = (u.empNo + (u.name ? (' ' + u.name) : ''));
        hint.textContent = '';
        btn.disabled = false;
        return u;
      } else {
        text.textContent = '-';
        hint.textContent = 'ë¡œê·¸ì¸ ì„¸ì…˜ì—ì„œ ì‚¬ë²ˆ/ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ëŒ“ê¸€ ë“±ë¡ ë¹„í™œì„±)';
        btn.disabled = true;
        return null;
      }
    }

    async function addComment_(noticeId, sessionUser){
      const textarea = document.getElementById('commentBody');
      const body = String(textarea.value || '').trim();
      if(!body) return;

      const btn = document.getElementById('btnAddComment');
      btn.disabled = true;

      try{
        const j = await apiPost_({
          mode:'addComment',
          noticeId,
          body,
          parentCommentId: '',
          authorEmpNo: sessionUser.empNo,   // âœ… ìë™
          authorName: sessionUser.name || '', // âœ… ìë™
          authorEmail: sessionUser.email || ''
        });

        if(!j || j.ok !== true){
          alert(j && j.message ? String(j.message) : 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
          return;
        }

        textarea.value = '';
        await loadComments_(noticeId);
      } finally {
        btn.disabled = false;
      }
    }

    (async function init(){
      mountShell_();

      const noticeId = qs('id') || qs('noticeId');
      if(!noticeId){
        document.getElementById('noticeTitle').textContent = 'noticeIdê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('noticeBody').textContent = 'ëª©ë¡ì—ì„œ ê³µì§€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.';
        document.getElementById('commentList').innerHTML = '<li class="muted">ê³µì§€ IDê°€ ì—†ì–´ì„œ ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }

      document.getElementById('btnBack').addEventListener('click', ()=> location.href = './board.html');
      document.getElementById('btnRefresh').addEventListener('click', ()=> loadComments_(noticeId));

      const sessionUser = bindSessionUserUI_();
      const notice = await loadNotice_(noticeId);

      // ëŒ“ê¸€ í—ˆìš© ì—¬ë¶€ì— ë”°ë¼ ì…ë ¥ ë¹„í™œì„±
      if (notice && Number(notice.allowComments||0) !== 1) {
        document.getElementById('btnAddComment').disabled = true;
        document.getElementById('commentBody').disabled = true;
        document.getElementById('commentBody').placeholder = 'ì´ ê³µì§€ëŠ” ëŒ“ê¸€ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
      }

      // ì¡°íšŒìˆ˜ ì¦ê°€(ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
      incrementView_(noticeId);

      await loadComments_(noticeId);

      document.getElementById('btnAddComment').addEventListener('click', ()=>{
        const u = getSessionUser_();
        if(!u || !u.empNo){
          alert('ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        addComment_(noticeId, u);
      });
    })();
  </script>
</body>
</html>
