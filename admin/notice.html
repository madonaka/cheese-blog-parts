<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지 상세 · Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <style>
    :root{ --bg:#f3f4f6; --card:#fff; --text:#0f172a; --sub:#475569; --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    .wrap{ padding:18px 18px 28px; box-sizing:border-box; max-width:980px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
    .card-h{ padding:14px 14px 10px; border-bottom:1px solid rgba(15,23,42,0.06); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start; }
    .title{ font-size:18px; font-weight:1000; letter-spacing:-0.02em; }
    .meta{ margin-top:8px; color:var(--sub); font-size:12px; font-weight:650; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }
    .tag--warn{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.28); }
    .tag--bad{ background:rgba(239,68,68,0.10); border-color:rgba(239,68,68,0.25); }
    .card-b{ padding:12px 14px 14px; }
    .body{ white-space:pre-wrap; line-height:1.55; font-size:14px; font-weight:650; }

    .row{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px 10px; border-radius:14px; border:1px solid rgba(15,23,42,0.08); background:rgba(2,6,23,0.02); }
    .muted{ color:var(--sub); font-size:12px; font-weight:650; }

    .form{ display:grid; gap:10px; margin-top:12px; }
    .inp, .ta{
      width:100%; box-sizing:border-box;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff; font-size:13px; font-weight:750;
      outline:none;
    }
    .ta{ min-height:92px; resize:vertical; }
    .btn{
      appearance:none; border:1px solid rgba(15,23,42,0.14);
      background:#fff; border-radius:14px; padding:10px 12px;
      font-size:13px; font-weight:900; cursor:pointer;
      width: fit-content;
    }
    .btn:active{ transform:translateY(1px); }

    .comments{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .c-left{ min-width:0; display:flex; flex-direction:column; gap:4px; }
    .c-title{ font-weight:1000; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .c-meta{ color:var(--sub); font-size:12px; font-weight:650; display:flex; gap:8px; flex-wrap:wrap; }
    .c-body{ white-space:pre-wrap; line-height:1.45; font-size:13px; font-weight:650; margin-top:6px; }

    .indent{ margin-left:22px; }
    .replyBtn{ border:none; background:transparent; color:var(--sub); font-weight:900; cursor:pointer; padding:0; font-size:12px; }
  </style>
</head>

<body>
  <div id="admin-header-mount"></div>

  <main class="wrap">
    <div class="card">
      <div class="card-h">
        <div style="min-width:0;">
          <div class="title" id="title">로딩중…</div>
          <div class="meta" id="meta"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;" id="badges"></div>
      </div>

      <div class="card-b">
        <div class="body" id="body"></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <div class="card-h">
        <div>
          <div class="title" style="font-size:16px;">댓글</div>
          <div class="meta" id="cMeta"></div>
        </div>
        <div><a class="muted" href="./board.html" style="text-decoration:none;">목록으로 →</a></div>
      </div>

      <div class="card-b">
        <div id="commentDisabled" class="muted" style="display:none;">이 공지는 댓글이 비활성화되어 있어요.</div>

        <div class="form" id="commentForm">
          <div class="row">
            <div style="flex:1; display:grid; gap:10px;">
              <input class="inp" id="empNo" placeholder="사번 (예: CL25-0001)" />
              <input class="inp" id="name" placeholder="이름(표시용, 선택)" />
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <div class="muted" id="replyTo" style="display:none;"></div>
              <textarea class="ta" id="commentBody" placeholder="댓글을 입력하세요"></textarea>
            </div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button class="btn" id="btnAdd" type="button">댓글 등록</button>
            <button class="btn" id="btnCancelReply" type="button" style="display:none;">답글 취소</button>
            <span class="muted" id="msg"></span>
          </div>
        </div>

        <div class="comments" id="comments"></div>
      </div>
    </div>
  </main>

  <script src="./admin-common.js"></script>
  <script>
    const API_BASE = window.ADMIN_API_URL || 'PASTE_YOUR_GAS_WEBAPP_EXEC_URL_HERE';

    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function esc(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
    function tag(level){
      const v = String(level||'').toLowerCase();
      if(v==='danger') return '<span class="tag tag--bad">필독</span>';
      if(v==='warn') return '<span class="tag tag--warn">중요</span>';
      return '<span class="tag">공지</span>';
    }
    function formEncode(obj){
      return Object.keys(obj).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(obj[k] ?? '')).join('&');
    }

    let __noticeId = '';
    let __allowComments = 0;
    let __replyParentId = '';

    function setReply(parentId, parentPreview){
      __replyParentId = parentId || '';
      const el = document.getElementById('replyTo');
      const btn = document.getElementById('btnCancelReply');
      if(__replyParentId){
        el.style.display = 'block';
        el.innerHTML = `답글 대상: <b>${esc(parentPreview||parentId)}</b>`;
        btn.style.display = 'inline-flex';
      }else{
        el.style.display = 'none';
        el.textContent = '';
        btn.style.display = 'none';
      }
    }

    function rememberAuthor(){
      localStorage.setItem('notice_author_empNo', document.getElementById('empNo').value || '');
      localStorage.setItem('notice_author_name', document.getElementById('name').value || '');
    }
    function loadRememberedAuthor(){
      document.getElementById('empNo').value = localStorage.getItem('notice_author_empNo') || '';
      document.getElementById('name').value = localStorage.getItem('notice_author_name') || '';
    }

    function renderCommentsTree(items){
      const root = [];
      const byId = new Map();
      (items||[]).forEach(c=>{
        byId.set(c.commentId, { ...c, children: [] });
      });
      (items||[]).forEach(c=>{
        const node = byId.get(c.commentId);
        const pid = c.parentCommentId || '';
        if(pid && byId.has(pid)) byId.get(pid).children.push(node);
        else root.push(node);
      });

      const container = document.getElementById('comments');
      container.innerHTML = '';

      if(!root.length){
        container.innerHTML = '<div class="muted">아직 댓글이 없어요.</div>';
        return;
      }

      function renderNode(node, depth){
        const wrap = document.createElement('div');
        wrap.className = 'row' + (depth ? ' indent' : '');
        const author = node.authorEmpNo || node.authorEmail || '';
        const title = `${author}${node.authorName ? ' · ' + node.authorName : ''}`;

        wrap.innerHTML = `
          <div class="c-left" style="flex:1; min-width:0;">
            <div class="c-title">${esc(title)}</div>
            <div class="c-meta">
              <span>${esc((node.createdAt||'').slice(0,16))}</span>
              <span>${esc(node.status || '')}</span>
              <button class="replyBtn" data-reply="${esc(node.commentId)}">답글</button>
            </div>
            <div class="c-body">${esc(node.body || '')}</div>
          </div>
        `;

        wrap.querySelector('[data-reply]').addEventListener('click', ()=>{
          setReply(node.commentId, (node.body||'').slice(0,30));
          window.scrollTo({ top: document.getElementById('commentForm').offsetTop - 10, behavior:'smooth' });
        });

        container.appendChild(wrap);
        (node.children||[]).forEach(ch=> renderNode(ch, depth+1));
      }

      root.forEach(n=> renderNode(n, 0));
    }

    async function loadNotice(){
      __noticeId = qs('id') || '';
      if(!__noticeId){
        document.getElementById('title').textContent = '공지 ID가 없습니다.';
        return;
      }
      if(!API_BASE || API_BASE.includes('PASTE_YOUR_')){
        document.getElementById('title').textContent = 'API URL을 설정해줘야 공지를 불러올 수 있어요.';
        return;
      }

      // 공지 상세
      const res = await fetch(API_BASE + '?mode=getAnnouncement&noticeId=' + encodeURIComponent(__noticeId));
      const json = await res.json();
      if(!json || json.ok !== true) throw new Error('getAnnouncement failed');

      const n = json.notice || {};
      __allowComments = Number(n.allowComments || 0);

      document.getElementById('title').textContent = n.title || '';
      document.getElementById('body').textContent = n.body || '';

      document.getElementById('badges').innerHTML = `
        ${tag(n.level)}
        ${Number(n.isPinned||0) === 1 ? '<span class="tag">고정</span>' : ''}
        ${__allowComments === 1 ? '<span class="tag">댓글</span>' : ''}
      `;

      document.getElementById('meta').innerHTML = `
        <span>${esc(n.noticeId || '')}</span>
        <span>·</span>
        <span>${esc(n.authorEmpNo || '')}</span>
        <span>·</span>
        <span>${esc((n.updatedAt || n.createdAt || '').slice(0,16))}</span>
        <span>·</span>
        <span>조회 ${Number(n.viewCount||0)}</span>
      `;

      document.getElementById('cMeta').innerHTML = `
        <span>댓글 ${Number(n.commentCount||0)}개</span>
        ${n.lastCommentAt ? `<span>· 최근 ${esc(String(n.lastCommentAt).slice(0,16))}</span>` : ''}
      `;

      // 조회수 +1 (실패해도 치명적이지 않음)
      fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: formEncode({ mode:'incrementNoticeView', noticeId: __noticeId })
      }).catch(()=>{});

      // 댓글 폼 토글
      if(__allowComments !== 1){
        document.getElementById('commentForm').style.display = 'none';
        document.getElementById('commentDisabled').style.display = 'block';
      }

      // 댓글 로드
      await loadComments();
    }

    async function loadComments(){
      const res = await fetch(API_BASE + '?mode=listComments&noticeId=' + encodeURIComponent(__noticeId));
      const json = await res.json();
      if(!json || json.ok !== true) throw new Error('listComments failed');
      renderCommentsTree(json.items || []);
    }

    async function addComment(){
      const empNo = (document.getElementById('empNo').value || '').trim();
      const name = (document.getElementById('name').value || '').trim();
      const body = (document.getElementById('commentBody').value || '').trim();
      const msg = document.getElementById('msg');

      msg.textContent = '';
      if(!empNo){ msg.textContent = '사번(empNo)을 입력해줘.'; return; }
      if(!body){ msg.textContent = '댓글 내용을 입력해줘.'; return; }

      rememberAuthor();

      const payload = {
        mode: 'addComment',
        noticeId: __noticeId,
        body,
        authorEmpNo: empNo,
        authorName: name,
        parentCommentId: __replyParentId
      };

      const res = await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: formEncode(payload)
      });
      const json = await res.json();
      if(!json || json.ok !== true){
        msg.textContent = (json && json.message) ? json.message : '댓글 등록 실패';
        return;
      }

      document.getElementById('commentBody').value = '';
      setReply('', '');
      msg.textContent = '등록 완료';
      await loadNotice(); // commentCount/lastCommentAt 갱신 반영까지 같이 새로고침
    }

    (function init(){
      try{
        if(typeof window.renderAdminHeader === 'function'){
          window.renderAdminHeader({ mountId:'admin-header-mount', badgeText:'notice', subtitle:'공지 상세' });
        }
      }catch(_){}

      loadRememberedAuthor();

      document.getElementById('btnAdd').addEventListener('click', ()=> addComment().catch(e=>{
        console.warn(e);
        document.getElementById('msg').textContent = '처리 중 오류';
      }));
      document.getElementById('btnCancelReply').addEventListener('click', ()=> setReply('', ''));

      loadNotice().catch(err=>{
        console.warn(err);
        document.getElementById('title').textContent = '공지 불러오기 실패 (API URL/권한 확인)';
        document.getElementById('body').textContent = '';
      });
    })();
  </script>
</body>
</html>
