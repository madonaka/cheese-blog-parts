<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ê³µì§€ì‚¬í•­ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec";
    window.CURRENT_USER_EMP_NO = "CL-ADMIN";
    window.CURRENT_USER_NAME = "ê´€ë¦¬ì";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root { --line-color: #eee; --text-dark: #333; --text-gray: #777; --primary: #3b82f6; --danger: #ef4444; --bg-gray: #f9f9f9; }
    .dashboard-layout { max-width: 1000px; margin: 0 auto; padding: 20px 10px 80px; }
    .sys-version-small { font-size: 0.75rem; color: #ccc; text-align: right; margin-bottom: 10px; }

    .view-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
    .view-category { color: var(--primary); font-weight: 800; font-size: 0.85rem; margin-bottom: 8px; }
    .view-title { font-size: 1.5rem; font-weight: 900; color: #000; margin: 0 0 12px 0; line-height: 1.4; word-break: break-all; }
    .view-meta { display: flex; gap: 12px; color: var(--text-gray); font-size: 0.85rem; align-items: center; flex-wrap: wrap; }
    .meta-sep { color: #ddd; }

    .view-content { min-height: 300px; line-height: 1.8; color: #333; font-size: 1rem; margin-bottom: 40px; padding: 10px 0; }
    .view-content img { max-width: 100%; height: auto; border-radius: 4px; margin: 15px 0; }
    
    .action-bar { display: flex; justify-content: space-between; border-top: 1px solid var(--line-color); padding-top: 20px; margin-bottom: 40px; }
    .btn-bbs { padding: 8px 16px; border-radius: 4px; font-size: 0.9rem; font-weight: 700; cursor: pointer; border: 1px solid #ddd; background: #fff; text-decoration: none; color: #333; display: inline-flex; align-items: center; }
    .btn-edit { background: var(--bg-gray); }

    .comment-wrap { background: #fff; border: 1px solid var(--line-color); }
    .comment-header { background: var(--bg-gray); padding: 10px 15px; border-bottom: 1px solid var(--line-color); font-weight: 800; font-size: 0.9rem; }
    .comment-item { padding: 15px; border-bottom: 1px solid var(--line-color); }
    .comment-item.is-reply { background: #fcfcfc; padding-left: 40px; position: relative; }
    .comment-item.is-reply::before { content: 'â””'; position: absolute; left: 15px; top: 15px; color: #ccc; font-weight: bold; }
    .comment-user { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .user-name { font-weight: 800; color: #333; font-size: 0.85rem; }
    .comment-date { color: #999; font-size: 0.75rem; }
    .comment-text { font-size: 0.9rem; line-height: 1.6; color: #444; white-space: pre-wrap; }
    .comment-btns { margin-top: 8px; }
    .btn-comment-sm { background: none; border: none; padding: 0; margin-right: 10px; color: #888; font-size: 0.75rem; cursor: pointer; font-weight: 700; }
    .btn-comment-sm:hover { color: var(--primary); text-decoration: underline; }

    .comment-form { padding: 15px; background: #fdfdfd; }
    .comment-textarea { width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-size: 0.9rem; resize: none; box-sizing: border-box; font-family: inherit; }
    .btn-submit { background: #555; color: #fff; border: none; padding: 8px 20px; border-radius: 4px; font-weight: 700; cursor: pointer; }

    .edit-box { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
    .styled-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-family: inherit; font-size: 0.95rem; box-sizing: border-box; }
    .m-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 3px; font-weight: 800; color: #fff; vertical-align: middle; }
    .bg-danger { background: var(--danger); }
    .bg-primary { background: var(--primary); }
    .tox-tinymce-aux { z-index: 99999 !important; }

    @media (max-width: 600px) { .view-title { font-size: 1.25rem; } }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div class="dashboard-layout">
        <div class="sys-version-small" id="sysVersion">Version Checking...</div>

        <div id="view-wrapper" style="display:none;">
          <div class="view-header">
            <div id="view-category" class="view-category"></div>
            <h2 id="view-title" class="view-title">ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            <div class="view-meta">
              <span id="view-author">--</span>
              <span class="meta-sep">|</span>
              <span id="view-date">--.--.--</span>
              <span class="meta-sep">|</span>
              <span>ì¡°íšŒ <span id="view-count">0</span></span>
            </div>
          </div>

          <div id="view-body" class="view-content"></div>

          <div class="action-bar">
            <a href="board.html" class="btn-bbs">ëª©ë¡</a>
            <button id="btn-edit-trigger" class="btn-bbs btn-edit" onclick="enterEditMode()">ìˆ˜ì •</button>
          </div>

          <div class="comment-wrap">
            <div class="comment-header">ëŒ“ê¸€ <span id="comment-total-count">0</span></div>
            <div id="comment-list-root"></div>
            <div class="comment-form">
              <textarea id="new-comment-body" class="comment-textarea" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
              <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                <button class="btn-submit" onclick="submitComment()">ë“±ë¡</button>
              </div>
            </div>
          </div>
        </div>

        <div id="edit-wrapper" style="display:none;">
          <div class="edit-box">
            <h3 id="edit-page-title" style="margin-top:0;">ê¸€ ì“°ê¸°</h3>
            <input type="text" id="edit-title" class="styled-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="font-weight:700; font-size:1.1rem;">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
              <select id="edit-level" class="styled-input" style="flex:1; margin-bottom:0;">
                <option value="normal">ì¼ë°˜ ê³µì§€</option>
                <option value="warn">ì¤‘ìš” ê³µì§€</option>
                <option value="danger">ğŸš¨ í•„ë… ê³µì§€</option>
              </select>
              <label style="flex:1; display:flex; align-items:center; gap:5px; font-size:0.9rem; font-weight:700; cursor:pointer;">
                <input type="checkbox" id="edit-pinned"> ğŸ“Œ ìƒë‹¨ ê³ ì •
              </label>
            </div>
            <textarea id="notice-editor"></textarea>
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
              <button class="btn-bbs" onclick="cancelEdit()">ì·¨ì†Œ</button>
              <div style="display:flex; gap:10px;">
                <button class="btn-bbs" onclick="saveNotice('draft')">ì„ì‹œì €ì¥</button>
                <button class="btn-bbs" style="background:#333; color:#fff; border:none;" onclick="saveNotice('published')">ì‘ì„± ì™„ë£Œ</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const targetNoticeId = urlParams.get('id');
  let currentNotice = null;
  let currentComments = [];

  document.addEventListener('DOMContentLoaded', initPage);

  async function initPage() {
    if (!targetNoticeId) {
      showEditMode(true);
    } else {
      showViewMode();
      await loadNoticeData();
    }
  }

  function showViewMode() {
    document.getElementById('view-wrapper').style.display = 'block';
    document.getElementById('edit-wrapper').style.display = 'none';
  }

  function showEditMode(isNew = false) {
    document.getElementById('view-wrapper').style.display = 'none';
    document.getElementById('edit-wrapper').style.display = 'block';
    if(isNew) document.getElementById('edit-page-title').textContent = "ìƒˆ ê³µì§€ ì‘ì„±";
    initTinyMCE();
  }

  async function initTinyMCE() {
    if (tinymce.get('notice-editor')) return;
    await tinymce.init({
      selector: '#notice-editor',
      height: 500,
      language: 'ko_KR',
      menubar: false,
      plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen table help wordcount',
      toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline | forecolor backcolor | alignleft aligncenter alignright | bullist numlist outdent indent | table link image | code',
      toolbar_mode: 'wrap',
      branding: false,
      valid_elements: '*[*]'
    });
  }

  // âœ… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë¡œì§ ê°•í™” (id, noticeId ë™ì‹œ ëŒ€ì‘ ë° ëª¨ë“  ì‘ë‹µ í‚¤ ì²´í¬)
  async function loadNoticeData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    try {
      const queryId = targetNoticeId;
      const res = await fetch(`${window.CHEESE_ADMIN_API_BASE}?mode=getAnnouncement&id=${queryId}&noticeId=${queryId}`);
      const json = await res.json();
      
      // ì„œë²„ì—ì„œ ì–´ë–¤ í‚¤ë¡œ ë°ì´í„°ë¥¼ ì¤„ì§€ ëª¨ë¥´ë‹ˆ ëª¨ë‘ ì²´í¬
      const data = json.announcement || json.data || json.item || json.result;

      if(data && (data.title || data.id || data.noticeId)) {
        currentNotice = data;
        renderNotice();
        await loadComments();
        // ì¡°íšŒìˆ˜ ì¦ê°€ëŠ” ì˜¤ë¥˜ê°€ ë‚˜ë„ ë³¸ë¬¸ ë¡œë”©ì„ ë§‰ì§€ ì•Šê²Œ ë¶„ë¦¬
        fetch(window.CHEESE_ADMIN_API_BASE, { 
          method:'POST', 
          body: JSON.stringify({ mode:'incrementNoticeView', id: queryId, noticeId: queryId }) 
        }).catch(e => console.log("ì¡°íšŒìˆ˜ ì¦ê°€ skip"));
      } else {
        alert("í•´ë‹¹ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        location.href = 'board.html';
      }
    } catch(e) { 
      console.error(e);
      alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function renderNotice() {
    const l = String(currentNotice.level || '').toLowerCase();
    const cat = document.getElementById('view-category');
    if (l === 'danger') cat.innerHTML = '<span class="m-badge bg-danger">í•„ë…</span>';
    else if (l === 'warn') cat.innerHTML = '<span class="m-badge bg-primary">ì¤‘ìš”</span>';
    else cat.textContent = 'ê³µì§€';

    document.getElementById('view-title').textContent = currentNotice.title || "ì œëª© ì—†ìŒ";
    document.getElementById('view-author').textContent = currentNotice.authorName || currentNotice.authorEmpNo || "ê´€ë¦¬ì";
    document.getElementById('view-date').textContent = (currentNotice.createdAt || "--.--.--").substring(0, 16);
    document.getElementById('view-count').textContent = currentNotice.viewCount || 0;
    document.getElementById('view-body').innerHTML = currentNotice.body || currentNotice.content || "";
  }

  function enterEditMode() {
    showEditMode(false);
    document.getElementById('edit-page-title').textContent = "ê³µì§€ ìˆ˜ì •";
    document.getElementById('edit-title').value = currentNotice.title || "";
    document.getElementById('edit-level').value = currentNotice.level || "normal";
    document.getElementById('edit-pinned').checked = (currentNotice.isPinned == 1);
    setTimeout(() => {
      if(tinymce.get('notice-editor')) tinymce.get('notice-editor').setContent(currentNotice.body || currentNotice.content || "");
    }, 500);
  }

  function cancelEdit() {
    if(!targetNoticeId) location.href = 'board.html';
    else showViewMode();
  }

  async function saveNotice(status) {
    const title = document.getElementById('edit-title').value.trim();
    const body = tinymce.get('notice-editor').getContent();
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const payload = {
      mode: 'upsertAnnouncement',
      noticeId: targetNoticeId || "",
      title: title,
      body: body,
      level: document.getElementById('edit-level').value,
      isPinned: document.getElementById('edit-pinned').checked ? 1 : 0,
      status: status,
      authorEmpNo: window.CURRENT_USER_EMP_NO
    };

    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method:'POST', body: JSON.stringify(payload) });
      const json = await res.json();
      const id = json.noticeId || json.id || targetNoticeId;
      location.href = `notice.html?id=${id}`;
    } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  async function loadComments() {
    try {
      const res = await fetch(`${window.CHEESE_ADMIN_API_BASE}?mode=listComments&id=${targetNoticeId}&noticeId=${targetNoticeId}`);
      const json = await res.json();
      currentComments = json.comments || json.data || json.items || [];
      renderComments();
    } catch(e) { console.error(e); }
  }

  function renderComments() {
    const root = document.getElementById('comment-list-root');
    const countEl = document.getElementById('comment-total-count');
    root.innerHTML = "";
    
    // ì‚­ì œë˜ì§€ ì•Šì€ ëŒ“ê¸€ë§Œ í‘œì‹œ
    const activeComments = currentComments.filter(c => c.status !== 'deleted');
    countEl.textContent = activeComments.length;

    if(activeComments.length === 0) {
      root.innerHTML = '<div style="text-align:center; padding:30px; color:#999; font-size:0.9rem;">ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”.</div>';
      return;
    }

    const isNullish = (v) => !v || v === "" || v === "null" || v === "undefined";
    const parents = activeComments.filter(c => isNullish(c.parentCommentId));
    const children = activeComments.filter(c => !isNullish(c.parentCommentId));

    parents.sort((a,b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));

    parents.forEach(p => {
      root.appendChild(createCommentEl(p, false));
      const pId = p.commentId || p.id;
      const replies = children.filter(c => String(c.parentCommentId) === String(pId));
      replies.forEach(r => root.appendChild(createCommentEl(r, true)));
    });
  }

  function createCommentEl(c, isReply) {
    const div = document.createElement('div');
    div.className = `comment-item ${isReply ? 'is-reply' : ''}`;
    const cId = c.commentId || c.id;
    div.innerHTML = `
      <div class="comment-user">
        <span class="user-name">${c.authorName || c.authorEmpNo || "ìµëª…"}</span>
        <span class="comment-date">${c.createdAt || ""}</span>
      </div>
      <div class="comment-text">${c.body || ""}</div>
      <div class="comment-btns">
        ${!isReply ? `<button class="btn-comment-sm" onclick="toggleReplyForm('${cId}')">ë‹µê¸€</button>` : ''}
        ${c.authorEmpNo === window.CURRENT_USER_EMP_NO ? `<button class="btn-comment-sm" style="color:var(--danger);" onclick="deleteComment('${cId}')">ì‚­ì œ</button>` : ''}
      </div>
      <div id="reply-form-${cId}" style="display:none; margin-top:10px;">
        <textarea class="comment-textarea" rows="2" id="reply-text-${cId}" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:5px;">
            <button class="btn-submit" style="padding:4px 12px; font-size:0.8rem;" onclick="submitComment('${cId}')">ë“±ë¡</button>
        </div>
      </div>
    `;
    return div;
  }

  function toggleReplyForm(id) {
    const f = document.getElementById(`reply-form-${id}`);
    if(f) f.style.display = f.style.display === 'none' ? 'block' : 'none';
  }

  async function submitComment(parentId = "") {
    const inputId = parentId ? `reply-text-${parentId}` : 'new-comment-body';
    const text = document.getElementById(inputId).value;
    if(!text.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const payload = {
      mode: 'addComment',
      noticeId: targetNoticeId,
      parentCommentId: parentId,
      body: text,
      authorEmpNo: window.CURRENT_USER_EMP_NO,
      authorName: window.CURRENT_USER_NAME
    };

    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method:'POST', body: JSON.stringify(payload) });
      const json = await res.json();
      if(json.ok || json.result === "success") {
        document.getElementById(inputId).value = "";
        if(parentId) toggleReplyForm(parentId);
        await loadComments();
      }
    } catch(e) { alert("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨"); }
  }

  async function deleteComment(id) {
    if(!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE, { method:'POST', body: JSON.stringify({ mode:'setCommentStatus', commentId: id, status:'deleted' }) });
      const json = await res.json();
      if(json.ok || json.result === "success") await loadComments();
    } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
  }

  (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      el.textContent = `Ver: ${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} [Notice-Final]`;
  })();
</script>
</body>
</html>
