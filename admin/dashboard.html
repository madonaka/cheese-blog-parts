<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€ì‹œë³´ë“œ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  <style>
    /* =========================================
       Modern Dashboard Specific Styles
       (admin.cssì˜ ì‹œìŠ¤í…œì„ í›¼ì†í•˜ì§€ ì•Šê³  í™•ì¥)
    ========================================= */
    .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .dash-title .t { font-size: 1.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em; line-height: 1.2; }
    .dash-title .s { font-size: 0.85rem; color: var(--text-sub); margin-top: 0.25rem; font-weight: 500; }
    
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #fff; border: 1px solid var(--border); color: var(--text-sub); box-shadow: 0 1px 2px rgba(0,0,0,0.02); }

    /* Bento Grid Layout */
    .bento-layout { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; align-items: start; }
    .bento-main { grid-column: span 8; display: flex; flex-direction: column; gap: 1.5rem; }
    .bento-side { grid-column: span 4; display: flex; flex-direction: column; gap: 1.5rem; }

    /* Custom Card Enhancements */
    .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02); padding: 1.5rem; border-radius: 1rem; }
    .card-header { border-bottom: none; padding-bottom: 0; margin-bottom: 1.2rem; }
    .card-title { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.01em; color: #0f172a; }
    .card-link { font-size: 0.8rem; color: var(--text-sub); text-decoration: none; font-weight: 600; transition: color 0.2s; }
    .card-link:hover { color: var(--primary); }

    /* Feed List (Notice, Rejected) */
    .feed-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 0.75rem; }
    .feed-item { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; padding: 0.75rem; border-radius: 0.75rem; background: #f8fafc; border: 1px solid transparent; transition: all 0.2s; }
    .feed-item:hover { background: #fff; border-color: var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.04); transform: translateY(-1px); }
    .feed-content { display: flex; flex-direction: column; gap: 0.25rem; min-width: 0; }
    .feed-title { font-weight: 600; font-size: 0.9rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .feed-meta { font-size: 0.75rem; color: var(--text-sub); }

    /* Tags */
    .tag { display: inline-flex; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; white-space: nowrap; }
    .tag.warn { background: #fef3c7; color: #d97706; }
    .tag.bad { background: #fee2e2; color: #dc2626; }
    .tag.info { background: #e0e7ff; color: #4f46e5; }
    .tag.ok { background: #dcfce7; color: #16a34a; }

    /* Modern Goal Tree (Notion Style) */
    .goal-group { border: 1px solid var(--border); border-radius: 0.75rem; margin-bottom: 1rem; background: #fff; overflow: hidden; transition: border-color 0.2s; }
    .goal-group:hover { border-color: #cbd5e1; }
    .goal-header { padding: 1rem 1.2rem; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: pointer; border-bottom: 1px solid transparent; }
    .goal-group.is-open .goal-header { border-bottom-color: var(--border); }
    .goal-header-title { font-weight: 700; font-size: 0.95rem; color: #0f172a; display: flex; align-items: center; gap: 0.5rem; }
    .goal-header-title::before { content: 'ğŸ¯'; font-size: 1.1rem; }
    .goal-date { font-size: 0.75rem; color: var(--text-sub); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; border: 1px solid #e2e8f0; }

    .mid-goal { border-top: 1px dashed var(--border); }
    .mid-goal:first-child { border-top: none; }
    .mid-header { padding: 0.75rem 1.2rem; font-size: 0.85rem; font-weight: 700; color: #475569; background: #fff; display: flex; align-items: center; gap: 0.4rem; }
    .mid-header::before { content: 'â†³'; color: #94a3b8; }

    /* Task List (Clean Minimalist) */
    .task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1.2rem 0.6rem 2.5rem; font-size: 0.9rem; transition: background 0.15s; }
    .task-item:hover { background: #f8fafc; }
    .task-item:last-child { padding-bottom: 1rem; }
    
    .checkbox { width: 18px; height: 18px; border: 2px solid #cbd5e1; border-radius: 6px; cursor: pointer; position: relative; transition: all 0.2s; flex-shrink: 0; }
    .checkbox:hover { border-color: var(--primary); }
    .checkbox.done { background: var(--primary); border-color: var(--primary); }
    .checkbox.done::after { content: ''; position: absolute; left: 5px; top: 2px; width: 4px; height: 8px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .task-text { color: #334155; font-weight: 500; flex: 1; }
    .task-text.done { color: #94a3b8; text-decoration: line-through; }

    /* Idea Cards */
    .idea-card { padding: 1rem; border: 1px solid var(--border); border-radius: 0.75rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; background: #fff; position: relative; overflow: hidden; }
    .idea-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #a855f7; }
    .idea-card:hover { transform: translateX(2px); border-color: #d8b4fe; box-shadow: 0 4px 12px rgba(168,85,247,0.08); }
    .idea-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.4rem; color: #1e293b; }
    .idea-desc { font-size: 0.8rem; color: #64748b; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* Skeleton */
    .shimmer { background: #f1f5f9; border-radius: 8px; overflow: hidden; position: relative; }
    .shimmer::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); animation: load 1.2s infinite; }
    @keyframes load { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    @media (max-width: 1024px) {
      .bento-main, .bento-side { grid-column: span 12; }
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main>
        <header class="dash-header">
          <div class="dash-title">
            <h1 class="t">ëŒ€ì‹œë³´ë“œ</h1>
            <p class="s">ì˜¤ëŠ˜ì˜ í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ê³¼ ì•„ì´ë””ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
          </div>
          <div class="status-pill">
            <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%;"></span>
            <span id="nowPill">ë°ì´í„° ë™ê¸°í™” ì¤‘...</span>
          </div>
        </header>

        <section class="bento-layout">
          
          <div class="bento-main">
            <div class="card" style="padding: 0; overflow: hidden;">
              <div class="card-header" style="padding: 1.5rem 1.5rem 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                <h2 class="card-title">ğŸ—‚ í”„ë¡œì íŠ¸ ë° í•  ì¼</h2>
                <a href="./todo_manage.html" class="card-link">ì „ì²´ ê´€ë¦¬ â†’</a>
              </div>
              <div style="padding: 0 1.5rem 1.5rem;" id="goalTreeContainer">
                <div class="shimmer" style="height: 120px; width: 100%; margin-bottom: 1rem;"></div>
                <div class="shimmer" style="height: 80px; width: 100%;"></div>
              </div>
            </div>
          </div>

          <div class="bento-side">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">ğŸ“Œ ê³µì§€ì‚¬í•­</h2>
                <a href="./board.html" class="card-link">ë”ë³´ê¸° â†’</a>
              </div>
              <ul class="feed-list" id="noticeList">
                <li class="feed-item"><div class="shimmer" style="height:40px; width:100%;"></div></li>
              </ul>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">ğŸ’¡ ì•„ì´ë””ì–´ ë±…í¬</h2>
                <a href="./todo_manage.html" class="card-link">ì „ì²´ë³´ê¸° â†’</a>
              </div>
              <div id="ideaBoxContainer">
                <div class="shimmer" style="height:80px; width:100%; margin-bottom:0.75rem;"></div>
                <div class="shimmer" style="height:80px; width:100%;"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h2 class="card-title">ğŸš¨ ë°˜ë ¤ëœ ìš”ì²­</h2>
                <a href="./my-requests.html?filter=rejected" class="card-link">ë‚´ì—­ ë³´ê¸° â†’</a>
              </div>
              <ul class="feed-list" id="myRejectedList">
                <li style="font-size:0.85rem; color:var(--text-sub); padding:0.5rem 0;">ë°ì´í„° ë¡œë”© ì¤‘...</li>
              </ul>
            </div>
          </div>

        </section>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    const DASHBOARD_API = 'https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec';
    const TODO_API = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";

    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return d.getFullYear()+'. '+pad2(d.getMonth()+1)+'. '+pad2(d.getDate()); }
    function hm(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
    function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
    
    function setNow(){ 
        const now = new Date(); 
        document.getElementById('nowPill').innerHTML = `ìµœê·¼ ë™ê¸°í™”: ${hm(now)}`; 
    }

    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'dashboard', subtitle:'í†µí•© ëŒ€ì‹œë³´ë“œ' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'dashboard' });
    }

    async function toggleStatus(id, newStatus, element) {
        if(!confirm(newStatus === 'ì™„ë£Œ' ? 'ì´ ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        // Optimistic UI Update (ë¶€ë“œëŸ¬ìš´ ì‹œê°ì  í”¼ë“œë°±)
        const textEl = element.nextElementSibling;
        if(newStatus === 'ì™„ë£Œ') {
            element.classList.add('done');
            textEl.classList.add('done');
        } else {
            element.classList.remove('done');
            textEl.classList.remove('done');
        }

        try {
            await fetch(TODO_API, { method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) });
            loadDashboard(); 
        } catch (e) {
            console.error("Status update failed", e);
            alert("ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            loadDashboard(); // ë¡¤ë°±
        }
    }

    function renderNotices(items){
      const ul = document.getElementById('noticeList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li style="font-size:0.85rem; color:#64748b;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; return; }
      items.slice(0,3).forEach(it=>{
        const title = it.title || '';
        const date = it.date || (it.updatedAt ? String(it.updatedAt).slice(0,10) : '');
        const level = (it.level || '').toLowerCase();
        
        let tagHtml = '<span class="tag info">ì•ˆë‚´</span>';
        if(level === 'danger') tagHtml = '<span class="tag bad">í•„ë…</span>';
        if(level === 'warn') tagHtml = '<span class="tag warn">ì¤‘ìš”</span>';

        const li = document.createElement('li'); 
        li.className = 'feed-item';
        if(it.noticeId) { li.style.cursor='pointer'; li.onclick=()=>location.href=`./notice.html?id=${it.noticeId}`; }
        
        li.innerHTML = `
          <div class="feed-content">
            <div class="feed-title">${escapeHtml(title)}</div>
            <div class="feed-meta">${escapeHtml(date.replace(/-/g, '.'))}</div>
          </div>
          <div>${tagHtml}</div>
        `;
        ul.appendChild(li);
      });
    }

    function renderMyRejected(items){
      const ul = document.getElementById('myRejectedList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li style="font-size:0.85rem; color:#64748b;">ìµœê·¼ ë°˜ë ¤ëœ ê²°ì¬/ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ‰</li>'; return; }
      items.slice(0,3).forEach(it=>{
        const li = document.createElement('li'); 
        li.className = 'feed-item';
        li.innerHTML = `
          <div class="feed-content">
            <div class="feed-title">${escapeHtml(it.title)}</div>
            <div class="feed-meta">${escapeHtml(it.date||'')}</div>
          </div>
          <div><span class="tag bad">ë°˜ë ¤</span></div>
        `;
        ul.appendChild(li);
      });
    }

    // ğŸš€ ëª¨ë˜í™”ëœ Goal & Task Tree Widget
    function renderGoalTreeWidget(goals, tasks) {
      const root = document.getElementById('goalTreeContainer');
      root.innerHTML = "";
      
      const bigGoals = goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
      if(bigGoals.length === 0) {
        root.innerHTML = '<div style="font-size:0.9rem; color:#64748b; text-align:center; padding: 2rem 0;">ë“±ë¡ëœ í”„ë¡œì íŠ¸ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      bigGoals.forEach(bg => {
        const card = document.createElement('div'); 
        card.className = "goal-group is-open"; // ê¸°ë³¸ì ìœ¼ë¡œ ì—´ë¦¼ ìƒíƒœ
        
        // Header
        const header = document.createElement('div');
        header.className = "goal-header";
        header.onclick = () => {
            card.classList.toggle('is-open');
            body.style.display = card.classList.contains('is-open') ? 'block' : 'none';
        };

        const dateHtml = bg['ë§ˆê°ì¼'] ? `<span class="goal-date">~${bg['ë§ˆê°ì¼'].split('T')[0].replace(/-/g, '.')}</span>` : '';
        header.innerHTML = `
            <div class="goal-header-title">${escapeHtml(bg['ì œëª©'])}</div>
            ${dateHtml}
        `;
        card.appendChild(header);

        // Body
        const body = document.createElement('div');
        
        const midGoals = goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
        if(midGoals.length > 0) {
            midGoals.forEach(mg => {
                const midWrapper = document.createElement('div');
                midWrapper.className = "mid-goal";
                midWrapper.innerHTML = `<div class="mid-header">${escapeHtml(mg['ì œëª©'])}</div>`;

                const mgTasks = tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']).includes(mg.ID) && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´');
                
                if (mgTasks.length > 0) {
                    mgTasks.forEach(t => {
                        const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
                        const taskRow = document.createElement('div');
                        taskRow.className = "task-item";
                        taskRow.innerHTML = `
                            <div class="checkbox ${isDone ? 'done' : ''}" 
                                 onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone ? 'ëŒ€ê¸°' : 'ì™„ë£Œ'}', this)"></div>
                            <div class="task-text ${isDone ? 'done' : ''}">${escapeHtml(t['ì œëª©'])}</div>
                        `;
                        midWrapper.appendChild(taskRow);
                    });
                } else {
                    midWrapper.insertAdjacentHTML('beforeend', '<div style="padding: 0.5rem 1.2rem 0.5rem 2.5rem; font-size:0.8rem; color:#94a3b8;">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
                }
                body.appendChild(midWrapper);
            });
        } else {
            body.innerHTML = '<div style="padding:1rem 1.2rem; font-size:0.85rem; color:#64748b;">í•˜ìœ„ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        
        card.appendChild(body);
        root.appendChild(card);
      });
    }

    function renderIdeaWidget(tasks) {
      const root = document.getElementById('ideaBoxContainer');
      root.innerHTML = "";
      
      const ideas = tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
      if(ideas.length === 0) {
        root.innerHTML = '<div style="font-size:0.85rem; color:#64748b;">ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      ideas.reverse().slice(0, 3).forEach(item => {
        const card = document.createElement('div'); 
        card.className = "idea-card";
        const plainText = (item['ìƒì„¸ë‚´ìš©'] || "").replace(/<[^>]*>?/gm, '').slice(0, 60);

        card.innerHTML = `
            <div class="idea-title">${escapeHtml(item['ì œëª©'])}</div>
            <div class="idea-desc">${escapeHtml(plainText) || 'ë‚´ìš© ì—†ìŒ...'}</div>
        `;
        card.onclick = () => location.href = './todo_manage.html'; 
        root.appendChild(card);
      });
    }

    async function loadDashboard(){
      try {
        const res = await fetch(DASHBOARD_API + '?mode=listAnnouncements&limit=3');
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.items)) {
          renderNotices(json.items.map(x => ({ title:x.title, date:x.createdAt?.slice(0,10), level:x.level, noticeId:x.noticeId })));
        } else { renderNotices([]); }
      } catch (e) { console.warn('ê³µì§€ ë¡œë“œ ì‹¤íŒ¨', e); renderNotices([]); }

      try {
        const res = await fetch(TODO_API + '?mode=getAllData');
        const json = await res.json();
        if(json.result === "success") {
            renderGoalTreeWidget(json.goals||[], json.tasks||[]);
            renderIdeaWidget(json.tasks||[]);
        }
      } catch(e) { 
          console.warn('í• ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
          document.getElementById('goalTreeContainer').innerHTML = '<div style="color:#ef4444; font-size:0.9rem; padding:1rem;">ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
      renderMyRejected([]); 
      setNow();
    }

    (function init(){
      setNow(); 
      setInterval(setNow, 1000*60); // 1ë¶„ë§ˆë‹¤ ê°±ì‹ 
      mountShell();
      loadDashboard();
    })();
  </script>
</body>
</html>
