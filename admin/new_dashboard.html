<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€ì‹œë³´ë“œ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px;
      --primary: #3b82f6; --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    .dash-title{ margin:10px 0 14px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .dash-title .t{ font-size:20px; font-weight:1000; letter-spacing:-0.02em; }
    .dash-title .s{ margin-top:4px; color:var(--sub); font-size:12px; font-weight:650; }
    .dash-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }

    .dash-grid{ display:grid; grid-template-columns:1.4fr 0.6fr; gap:14px; align-items:start; }
    .dash-col{ display:grid; gap:14px; }

    .dash-card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
    .dash-card-h{ padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(15,23,42,0.06); }
    .dash-card-title{ font-weight:1000; letter-spacing:-0.02em; font-size:14px; display:flex; align-items:center; gap:8px; }
    .dash-card-sub a{ text-decoration:none; font-size:12px; font-weight:800; color:var(--sub); }
    .dash-card-b{ padding:12px 14px 14px; }

    /* ê³µì§€ì‚¬í•­ & ë¦¬ìŠ¤íŠ¸ */
    .dash-list{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .dash-row{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px 10px; border-radius:14px;
      border:1px solid rgba(15,23,42,0.08); background:rgba(2,6,23,0.02); }
    .dash-row-left{ min-width:0; display:flex; flex-direction:column; gap:4px; }
    .dash-row-title{ font-weight:1000; font-size:13px; letter-spacing:-0.01em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }
    .dash-row-meta{ color:var(--sub); font-size:12px; font-weight:650; display:flex; gap:8px; flex-wrap:wrap; }

    .tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }
    .tag--warn{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.28); }
    .tag--ok{ background:rgba(34,197,94,0.10); border-color:rgba(34,197,94,0.25); }
    .tag--bad{ background:rgba(239,68,68,0.10); border-color:rgba(239,68,68,0.25); }
    .muted{ color:var(--sub); font-size:12px; font-weight:650; }

    /* Goal Card Style */
    .goal-card { background: #fff; border-radius: 12px; margin-bottom: 12px; overflow: hidden; border: 1px solid var(--border-color); }
    .goal-card-header { padding: 12px 16px; color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: opacity 0.2s; }
    .goal-card-header:hover { opacity: 0.9; }
    .goal-card-title { font-size: 1rem; font-weight: 800; line-height: 1.3; display: flex; align-items: center; gap: 6px; }
    .toggle-icon { font-size: 0.8rem; opacity: 0.8; }
    
    .mid-goal-group { padding: 12px; border-top: 1px solid #f1f5f9; background: #fff; }
    .mid-goal-item { margin-top: 8px; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-item:first-child { margin-top: 0; }
    .mid-goal-header { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
    
    /* ğŸš€ [NEW] í•  ì¼ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; transition: background 0.1s; }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: #fdfdfd; }
    
    .check-circle { 
        width: 18px; height: 18px; border: 2px solid #cbd5e1; border-radius: 50%; 
        flex-shrink: 0; cursor: pointer; position: relative; transition: all 0.2s;
    }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { 
        content: 'âœ”'; position: absolute; top: 50%; left: 50%; 
        transform: translate(-50%, -50%); color: white; font-size: 10px; font-weight: bold;
    }

    /* Idea Box Widget */
    .idea-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .idea-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; border-top: 4px solid #d8b4fe; cursor: pointer; }
    .idea-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .idea-date { font-size: 0.7rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    .idea-title { font-weight: 800; font-size: 0.95rem; margin-bottom: 4px; color: #1e293b; }
    .idea-body { font-size: 0.85rem; color: #64748b; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

    .skeleton{ height:12px; border-radius:999px; background:rgba(15,23,42,0.08); overflow:hidden; position:relative; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-60%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-60%);} 100%{transform:translateX(160%);} }

    /* ğŸš€ [NEW] Floating Action Button (FAB) */
    .fab-btn { position: fixed; bottom: 2rem; right: 2rem; width: 56px; height: 56px; background: var(--primary, #3b82f6); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.4), 0 4px 6px -2px rgba(59, 130, 246, 0.2); border: none; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s; z-index: 999; }
    .fab-btn:hover { transform: translateY(-4px) scale(1.05); background: #2563eb; }
    .fab-btn:active { transform: translateY(0) scale(0.95); }

    /* ğŸš€ [NEW] Quick Add Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .modal-overlay.show { display: flex; animation: fadeIn 0.2s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
    .modal-card { background: #fff; width: 100%; max-width: 440px; border-radius: 1.25rem; padding: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: translateY(20px); transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); margin: 1rem; }
    .modal-overlay.show .modal-card { transform: translateY(0); }
    .modal-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
    .modal-card-title { font-size: 1.2rem; font-weight: 800; color: #0f172a; margin: 0; }
    .modal-close-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #94a3b8; transition: color 0.2s; padding: 0; line-height: 1; }
    .modal-close-btn:hover { color: #ef4444; }
    
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 700; color: #475569; margin-bottom: 0.4rem; }
    .form-control { width: 100%; padding: 0.65rem 0.8rem; border: 1px solid var(--border-color, #e2e8f0); border-radius: 0.5rem; font-size: 0.95rem; font-family: inherit; box-sizing: border-box; transition: all 0.2s; background: #f8fafc; }
    .form-control:focus { outline: none; border-color: var(--primary, #3b82f6); background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
    textarea.form-control { resize: vertical; min-height: 90px; }
    
    .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    .btn-modal { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-cancel { background: #f1f5f9; color: #475569; }
    .btn-cancel:hover { background: #e2e8f0; }
    .btn-submit { background: var(--primary, #3b82f6); color: #fff; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
    .btn-submit:hover { background: #2563eb; transform: translateY(-1px); }

    @media (max-width:980px){ .dash-grid{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main>
        <div class="dash-title">
          <div>
            <div class="t">í†µí•© ëŒ€ì‹œë³´ë“œ</div>
            <div class="s">í”„ë¡œì íŠ¸ ëª©í‘œ ì§„í–‰ ìƒí™© ë° ì•„ì´ë””ì–´ ëª¨ìŒ</div>
          </div>
          <div class="dash-pill" id="nowPill">
            Update: 2026.02.14 17:22
          </div>
        </div>

        <section class="dash-grid">
          <div class="dash-col">
            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ“Œ ê³µì§€ì‚¬í•­</div>
                <div class="dash-card-sub"><a href="./board.html">ì „ì²´ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <ul class="dash-list" id="noticeList">
                  <li class="dash-row"><div style="flex:1"><div class="skeleton"></div></div></li>
                </ul>
              </div>
            </div>

            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ—‚ í”„ë¡œì íŠ¸ ëª©í‘œ & í•  ì¼</div>
                <div class="dash-card-sub"><a href="./todo_manage.html">ì „ì²´ ê´€ë¦¬ â†’</a></div>
              </div>
              <div class="dash-card-b" id="goalTreeContainer">
                <div class="skeleton" style="width:100%; height:100px; border-radius:12px;"></div>
              </div>
            </div>
          </div>

          <div class="dash-col">
            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</div>
                <div class="dash-card-sub"><a href="./todo_manage.html">ë”ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <div id="ideaBoxContainer" class="idea-grid">
                   <div class="skeleton" style="height:80px; border-radius:12px;"></div>
                   <div class="skeleton" style="height:80px; border-radius:12px;"></div>
                </div>
                <div class="muted" style="margin-top:10px; text-align:right;">
                  * ìµœê·¼ 4ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
              </div>
            </div>

            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸš¨ ìµœê·¼ ë°˜ë ¤(ë‚´ ìš”ì²­)</div>
                <div class="dash-card-sub"><a href="./my-requests.html?filter=rejected">ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <ul class="dash-list" id="myRejectedList">
                  <li class="muted">ë°˜ë ¤ëœ í•­ëª©ì´ ì—†ìœ¼ë©´ "ì—†ìŒ" í‘œì‹œ</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <button class="fab-btn" onclick="openQuickModal()" title="ë¹ ë¥¸ ì¶”ê°€ (ì•„ì´ë””ì–´/ë²„ê·¸/í• ì¼)">
    ï¼‹
  </button>

  <div class="modal-overlay" id="quickAddModal">
    <div class="modal-card">
      <div class="modal-card-header">
        <h3 class="modal-card-title">âœ¨ ë¹ ë¥¸ ê¸°ë¡ ì¶”ê°€</h3>
        <button class="modal-close-btn" onclick="closeQuickModal()">Ã—</button>
      </div>
      <div class="form-group">
        <label>ìœ í˜•</label>
        <select id="qaType" class="form-control">
          <option value="ì•„ì´ë””ì–´">ğŸ’¡ ì•„ì´ë””ì–´</option>
          <option value="ë²„ê·¸">ğŸ› ë²„ê·¸ ìˆ˜ì •</option>
          <option value="ë‹¨ìˆœì‘ì—…">âœ… ì¼ë°˜ í•  ì¼</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" id="qaTitle" class="form-control" placeholder="ì–´ë–¤ ìƒê°ì´ ë– ì˜¤ë¥´ì…¨ë‚˜ìš”?" autocomplete="off">
      </div>
      <div class="form-group">
        <label>ìƒì„¸ ë‚´ìš© (ì„ íƒ)</label>
        <textarea id="qaDetail" class="form-control" placeholder="êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="closeQuickModal()">ì·¨ì†Œ</button>
        <button class="btn-modal btn-submit" id="btnSubmitQuickAdd" onclick="submitQuickAdd()">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    const DASHBOARD_API = 'https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec';
    const TODO_API = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";

    function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
    
    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'dashboard', subtitle:'í†µí•© ëŒ€ì‹œë³´ë“œ' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'dashboard' });
    }

    // ìƒíƒœ í† ê¸€ í•¨ìˆ˜ (ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ë™ì‘)
    async function toggleStatus(id, newStatus) {
        if(!confirm(newStatus === 'ì™„ë£Œ' ? 'ì´ ì‘ì—…ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        try {
            await fetch(TODO_API, {
                method: "POST",
                body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus })
            });
            loadDashboard(); // ë°ì´í„° ê°±ì‹ 
        } catch (e) {
            console.error("Status update failed", e);
            alert("ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
        }
    }

    /* ğŸš€ ë¹ ë¥¸ ì¶”ê°€(Quick Add) ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ */
    function openQuickModal() {
        document.getElementById('quickAddModal').classList.add('show');
        setTimeout(() => document.getElementById('qaTitle').focus(), 100); 
    }

    function closeQuickModal() {
        document.getElementById('quickAddModal').classList.remove('show');
        document.getElementById('qaTitle').value = '';
        document.getElementById('qaDetail').value = '';
        document.getElementById('qaType').value = 'ì•„ì´ë””ì–´'; 
    }

    async function submitQuickAdd() {
        const type = document.getElementById('qaType').value;
        const title = document.getElementById('qaTitle').value.trim();
        const detail = document.getElementById('qaDetail').value.trim();
        
        if(!title) { 
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); 
            document.getElementById('qaTitle').focus();
            return; 
        }
        
        const btn = document.getElementById('btnSubmitQuickAdd');
        btn.innerHTML = 'ì €ì¥ ì¤‘...';
        btn.disabled = true;

        try {
            const payload = {
                mode: "saveGoal", 
                goalData: {
                    "ìœ í˜•": type,
                    "ì œëª©": title,
                    "ìƒì„¸ë‚´ìš©": detail,
                    "ìƒíƒœ": "ëŒ€ê¸°",
                    "ì—°ê²°_ì¤‘ê°„ëª©í‘œID": "" 
                }
            };

            const res = await fetch(TODO_API, {
                method: "POST",
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            
            if(json.result === "success") {
                closeQuickModal();
                loadDashboard(); // ì €ì¥ ì„±ê³µ ì‹œ í™”ë©´ ìë™ ê°±ì‹ 
            } else {
                alert('ë“±ë¡ ì‹¤íŒ¨: ' + (json.msg || 'ì„œë²„ ì˜¤ë¥˜'));
            }
        } catch (e) {
            console.error("Quick add failed", e);
            alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            btn.innerHTML = 'ì €ì¥í•˜ê¸°';
            btn.disabled = false;
        }
    }

    function renderNotices(items){
      const ul = document.getElementById('noticeList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li class="muted">ê³µì§€ ì—†ìŒ</li>'; return; }
      items.slice(0,3).forEach(it=>{
        const title = it.title || '';
        const date = it.date || (it.updatedAt ? String(it.updatedAt).slice(0,10) : '');
        const level = (it.level || '').toLowerCase();
        const tag = level === 'danger' ? '<span class="tag tag--bad">í•„ë…</span>' : level === 'warn' ? '<span class="tag tag--warn">ì¤‘ìš”</span>' : '<span class="tag">ê³µì§€</span>';
        const li = document.createElement('li'); li.className = 'dash-row';
        li.innerHTML = `<div class="dash-row-left"><div class="dash-row-title">${escapeHtml(title)}</div><div class="dash-row-meta"><span>${escapeHtml(date)}</span></div></div><div>${tag}</div>`;
        if(it.noticeId) { li.style.cursor='pointer'; li.onclick=()=>location.href=`./notice.html?id=${it.noticeId}`; }
        ul.appendChild(li);
      });
    }

    function renderMyRejected(items){
      const ul = document.getElementById('myRejectedList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li class="muted">ìµœê·¼ ë°˜ë ¤ëœ ë‚´ ìš”ì²­ì´ ì—†ì–´ìš”.</li>'; return; }
      items.slice(0,3).forEach(it=>{
        const li = document.createElement('li'); li.className = 'dash-row';
        li.innerHTML = `<div class="dash-row-left"><div class="dash-row-title">${escapeHtml(it.title)}</div><div class="dash-row-meta"><span>${escapeHtml(it.date||'')}</span></div></div><div><span class="tag tag--bad">ë°˜ë ¤</span></div>`;
        ul.appendChild(li);
      });
    }

    function renderGoalTreeWidget(goals, tasks) {
      const root = document.getElementById('goalTreeContainer');
      root.innerHTML = "";
      
      const bigGoals = goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
      if(bigGoals.length === 0) {
        root.innerHTML = '<div class="muted">ë“±ë¡ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      bigGoals.forEach(bg => {
        const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
        const card = document.createElement('div'); card.className = "goal-card";
        
        const header = document.createElement('div');
        header.className = "goal-card-header";
        header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${themeColor} 100%)`;
        header.onclick = function() {
            const body = card.querySelector('.mid-goal-group');
            const icon = header.querySelector('.toggle-icon');
            if(body.style.display === "none") { body.style.display = "block"; icon.textContent = "â–¼"; }
            else { body.style.display = "none"; icon.textContent = "â–¶"; }
        };

        const dateHtml = (bg['ë§ˆê°ì¼']) ? `<div style="font-size:0.7rem; background:rgba(0,0,0,0.2); padding:2px 6px; border-radius:4px;">~${bg['ë§ˆê°ì¼'].split('T')[0]}</div>` : '';
        header.innerHTML = `
            <div class="goal-card-title" style="flex:1;">
                <span class="toggle-icon">â–¶</span> ${bg['ì œëª©']} ${dateHtml}
            </div>
        `;
        card.appendChild(header);

        const body = document.createElement('div');
        body.className = "mid-goal-group";
        body.style.display = "none"; 

        const midGoals = goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
        if(midGoals.length > 0) {
            midGoals.forEach(mg => {
                const midItem = document.createElement('div');
                midItem.className = "mid-goal-item";
                midItem.style.borderLeft = `3px solid ${themeColor}`;
                
                midItem.innerHTML = `<div class="mid-goal-header"><span>ğŸš© ${mg['ì œëª©']}</span></div>`;

                const mgTasks = tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']).includes(mg.ID) && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´');
                
                if (mgTasks.length > 0) {
                    const taskList = document.createElement('div');
                    taskList.className = "task-list";
                    
                    mgTasks.forEach(t => {
                        const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
                        const row = document.createElement('div');
                        row.className = "task-row";
                        row.innerHTML = `
                            <div class="check-circle ${isDone?'checked':''}" 
                                 onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')">
                            </div>
                            <div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:${isDone?'400':'600'};">
                                ${t['ì œëª©']}
                            </div>
                        `;
                        taskList.appendChild(row);
                    });
                    midItem.appendChild(taskList);
                } else {
                    midItem.insertAdjacentHTML('beforeend', '<div class="muted" style="padding:8px 12px; font-size:0.8rem;">í•  ì¼ ì—†ìŒ</div>');
                }

                body.appendChild(midItem);
            });
        } else {
            body.innerHTML = '<div class="muted" style="padding:10px;">í•˜ìœ„ ëª©í‘œ ì—†ìŒ</div>';
        }
        
        card.appendChild(body);
        root.appendChild(card);
      });
    }

    function renderIdeaWidget(tasks) {
      const root = document.getElementById('ideaBoxContainer');
      root.innerHTML = "";
      
      const ideas = tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
      if(ideas.length === 0) {
        root.innerHTML = '<div class="muted">ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      ideas.reverse().slice(0, 4).forEach(item => {
        const card = document.createElement('div'); card.className = "idea-card";
        const dateStr = item['ê¸°í•œ'] ? item['ê¸°í•œ'].split('T')[0] : '';
        const plainText = (item['ìƒì„¸ë‚´ìš©'] || "").replace(/<[^>]*>?/gm, '').slice(0, 50);

        card.innerHTML = `
            <div class="idea-header">
                ${dateStr ? `<span class="idea-date">ğŸ“… ${dateStr}</span>` : '<span></span>'}
            </div>
            <div class="idea-title">${item['ì œëª©']}</div>
            <div class="idea-body">${plainText || 'ë‚´ìš© ì—†ìŒ'}</div>
        `;
        card.onclick = () => location.href = './todo_manage.html'; 
        root.appendChild(card);
      });
    }

    async function loadDashboard(){
      try {
        const res = await fetch(DASHBOARD_API + '?mode=listAnnouncements&limit=3');
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.items)) {
          renderNotices(json.items.map(x => ({ title:x.title, date:x.createdAt?.slice(0,10), level:x.level, noticeId:x.noticeId })));
        } else { renderNotices([]); }
      } catch (e) { console.warn('ê³µì§€ ë¡œë“œ ì‹¤íŒ¨', e); renderNotices([]); }

      try {
        const res = await fetch(TODO_API + '?mode=getAllData');
        const json = await res.json();
        if(json.result === "success") {
            renderGoalTreeWidget(json.goals||[], json.tasks||[]);
            renderIdeaWidget(json.tasks||[]);
        }
      } catch(e) { 
          console.warn('í• ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
          document.getElementById('goalTreeContainer').innerHTML = '<div class="muted">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
          document.getElementById('ideaBoxContainer').innerHTML = '<div class="muted">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
      }
      renderMyRejected([]); 
    }

    (function init(){
      mountShell();
      loadDashboard();
    })();
  </script>
</body>
</html>
