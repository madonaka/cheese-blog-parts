<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ëŒ€ì‹œë³´ë“œ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --sub:#475569;
      --line:rgba(15,23,42,0.10); --shadow:0 10px 28px rgba(15,23,42,0.10); --r:18px;
      /* Todo Manage CSS Variables */
      --primary: #3b82f6; --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }

    .dash-title{ margin:10px 0 14px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .dash-title .t{ font-size:20px; font-weight:1000; letter-spacing:-0.02em; }
    .dash-title .s{ margin-top:4px; color:var(--sub); font-size:12px; font-weight:650; }
    .dash-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }

    .dash-grid{ display:grid; grid-template-columns:1.4fr 0.6fr; gap:14px; align-items:start; } /* ë¹„ìœ¨ ì¡°ì •: ëª©í‘œ íŠ¸ë¦¬ê°€ ë„“ì–´ì„œ 1.4:0.6 */
    .dash-col{ display:grid; gap:14px; }

    .dash-card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; }
    .dash-card-h{ padding:14px 14px 10px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid rgba(15,23,42,0.06); }
    .dash-card-title{ font-weight:1000; letter-spacing:-0.02em; font-size:14px; display:flex; align-items:center; gap:8px; }
    .dash-card-sub a{ text-decoration:none; font-size:12px; font-weight:800; color:var(--sub); }
    .dash-card-b{ padding:12px 14px 14px; }

    /* === ê³µì§€ì‚¬í•­ ìŠ¤íƒ€ì¼ === */
    .dash-list{ margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:10px; }
    .dash-row{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px 10px; border-radius:14px;
      border:1px solid rgba(15,23,42,0.08); background:rgba(2,6,23,0.02); }
    .dash-row-left{ min-width:0; display:flex; flex-direction:column; gap:4px; }
    .dash-row-title{ font-weight:1000; font-size:13px; letter-spacing:-0.01em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }
    .dash-row-meta{ color:var(--sub); font-size:12px; font-weight:650; display:flex; gap:8px; flex-wrap:wrap; }

    .tag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(15,23,42,0.10); background:rgba(15,23,42,0.04); white-space:nowrap; }
    .tag--warn{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.28); }
    .tag--ok{ background:rgba(34,197,94,0.10); border-color:rgba(34,197,94,0.25); }
    .tag--bad{ background:rgba(239,68,68,0.10); border-color:rgba(239,68,68,0.25); }
    .muted{ color:var(--sub); font-size:12px; font-weight:650; }

    /* === [New] Todo Manage CSS Port === */
    /* Goal Card Style */
    .goal-card { background: #fff; border-radius: 12px; margin-bottom: 12px; overflow: hidden; border: 1px solid var(--border-color); }
    .goal-card-header { padding: 12px 16px; color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: opacity 0.2s; }
    .goal-card-header:hover { opacity: 0.9; }
    .goal-card-title { font-size: 1rem; font-weight: 800; line-height: 1.3; display: flex; align-items: center; gap: 6px; }
    .toggle-icon { font-size: 0.8rem; opacity: 0.8; }
    
    .mid-goal-group { padding: 12px; border-top: 1px solid #f1f5f9; background: #fff; }
    .mid-goal-item { margin-top: 8px; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-item:first-child { margin-top: 0; }
    .mid-goal-header { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
    
    /* Idea Slider inside Goal */
    .mid-idea-slider { display: flex; gap: 8px; overflow-x: auto; padding: 8px 12px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; scrollbar-width: thin; }
    .mid-idea-slider::-webkit-scrollbar { height: 4px; }
    .mid-idea-slider::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    .mid-idea-card-mini { min-width: 140px; max-width: 140px; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; border-top: 3px solid #d8b4fe; display: flex; flex-direction: column; }
    .mic-date { font-size: 0.65rem; color: #94a3b8; margin-bottom: 2px; }
    .mic-title { font-size: 0.8rem; font-weight: 700; color: #333; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mic-desc { font-size: 0.7rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; }
    .check-circle { width: 16px; height: 16px; border: 2px solid #cbd5e1; border-radius: 50%; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }

    /* Idea Box Widget */
    .idea-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .idea-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; border-top: 4px solid #d8b4fe; }
    .idea-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .idea-date { font-size: 0.7rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
    .idea-title { font-weight: 800; font-size: 0.95rem; margin-bottom: 4px; color: #1e293b; }
    .idea-body { font-size: 0.85rem; color: #64748b; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

    .skeleton{ height:12px; border-radius:999px; background:rgba(15,23,42,0.08); overflow:hidden; position:relative; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-60%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-60%);} 100%{transform:translateX(160%);} }

    @media (max-width:980px){ .dash-grid{ grid-template-columns:1fr; } }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main>
        <div class="dash-title">
          <div>
            <div class="t">í†µí•© ëŒ€ì‹œë³´ë“œ</div>
            <div class="s">í”„ë¡œì íŠ¸ ëª©í‘œ ì§„í–‰ ìƒí™© ë° ì•„ì´ë””ì–´ ëª¨ìŒ</div>
          </div>
          <div class="dash-pill" id="nowPill">ë¡œë”©ì¤‘â€¦</div>
        </div>

        <section class="dash-grid">
          <div class="dash-col">
            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ“Œ ê³µì§€ì‚¬í•­</div>
                <div class="dash-card-sub"><a href="./board.html">ì „ì²´ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <ul class="dash-list" id="noticeList">
                  <li class="dash-row"><div style="flex:1"><div class="skeleton"></div></div></li>
                </ul>
              </div>
            </div>

            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ—‚ í”„ë¡œì íŠ¸ ëª©í‘œ í˜„í™©</div>
                <div class="dash-card-sub"><a href="./todo_manage.html">ë”ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b" id="goalTreeContainer">
                <div class="skeleton" style="width:100%; height:100px; border-radius:12px;"></div>
              </div>
            </div>
          </div>

          <div class="dash-col">
            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</div>
                <div class="dash-card-sub"><a href="./todo_manage.html">ë”ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <div id="ideaBoxContainer" class="idea-grid">
                   <div class="skeleton" style="height:80px; border-radius:12px;"></div>
                   <div class="skeleton" style="height:80px; border-radius:12px;"></div>
                </div>
                <div class="muted" style="margin-top:10px; text-align:right;">
                  * ìµœê·¼ 4ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
              </div>
            </div>

            <div class="dash-card">
              <div class="dash-card-h">
                <div class="dash-card-title">ğŸš¨ ìµœê·¼ ë°˜ë ¤(ë‚´ ìš”ì²­)</div>
                <div class="dash-card-sub"><a href="./my-requests.html?filter=rejected">ë³´ê¸° â†’</a></div>
              </div>
              <div class="dash-card-b">
                <ul class="dash-list" id="myRejectedList">
                  <li class="muted">ë°˜ë ¤ëœ í•­ëª©ì´ ì—†ìœ¼ë©´ "ì—†ìŒ" í‘œì‹œ</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    // 1. ëŒ€ì‹œë³´ë“œìš© API (ê³µì§€ì‚¬í•­ ë“±)
    const DASHBOARD_API = 'https://script.google.com/macros/s/AKfycbyE0uUpF2VdePr6AC6VcK7UOI4y5zvkUfMHlGHEiNKiGiiAjSzr172140GtV5MpiwzaSg/exec';
    
    // 2. í•  ì¼ ê´€ë¦¬ìš© API (ëª©í‘œ, íƒœìŠ¤í¬, ì•„ì´ë””ì–´)
    const TODO_API = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";

    // ===== Utils =====
    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
    function hm(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
    function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
    function setNow(){ const now = new Date(); document.getElementById('nowPill').textContent = ymd(now)+' '+hm(now); }
    function adjustColor(color, amount) { return color; } // Dummy implementation for color adjustment

    // ===== Shell mount =====
    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'dashboard', subtitle:'í†µí•© ëŒ€ì‹œë³´ë“œ' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'dashboard' });
    }

    // ===== Renderers =====
    function renderNotices(items){
      const ul = document.getElementById('noticeList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li class="muted">ê³µì§€ ì—†ìŒ</li>'; return; }
      items.slice(0,3).forEach(it=>{ // 5ê°œ -> 3ê°œë¡œ ì¤„ì„ (ê³µê°„ í™•ë³´)
        const title = it.title || '';
        const date = it.date || (it.updatedAt ? String(it.updatedAt).slice(0,10) : '');
        const level = (it.level || '').toLowerCase();
        const tag = level === 'danger' ? '<span class="tag tag--bad">í•„ë…</span>' : level === 'warn' ? '<span class="tag tag--warn">ì¤‘ìš”</span>' : '<span class="tag">ê³µì§€</span>';
        const li = document.createElement('li'); li.className = 'dash-row';
        li.innerHTML = `<div class="dash-row-left"><div class="dash-row-title">${escapeHtml(title)}</div><div class="dash-row-meta"><span>${escapeHtml(date)}</span></div></div><div>${tag}</div>`;
        if(it.noticeId) { li.style.cursor='pointer'; li.onclick=()=>location.href=`./notice.html?id=${it.noticeId}`; }
        ul.appendChild(li);
      });
    }

    function renderMyRejected(items){
      const ul = document.getElementById('myRejectedList');
      ul.innerHTML = '';
      if(!items || !items.length){ ul.innerHTML = '<li class="muted">ìµœê·¼ ë°˜ë ¤ëœ ë‚´ ìš”ì²­ì´ ì—†ì–´ìš”.</li>'; return; }
      items.slice(0,3).forEach(it=>{
        const li = document.createElement('li'); li.className = 'dash-row';
        li.innerHTML = `<div class="dash-row-left"><div class="dash-row-title">${escapeHtml(it.title)}</div><div class="dash-row-meta"><span>${escapeHtml(it.date||'')}</span></div></div><div><span class="tag tag--bad">ë°˜ë ¤</span></div>`;
        ul.appendChild(li);
      });
    }

    // ğŸš€ [NEW] Goal Tree Renderer (Simplified for Dashboard)
    function renderGoalTreeWidget(goals, tasks) {
      const root = document.getElementById('goalTreeContainer');
      root.innerHTML = "";
      
      const bigGoals = goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
      if(bigGoals.length === 0) {
        root.innerHTML = '<div class="muted">ë“±ë¡ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // ëŒ€ì‹œë³´ë“œì—ì„œëŠ” ìƒìœ„ 3ê°œì˜ í° ëª©í‘œë§Œ ë³´ì—¬ì£¼ê±°ë‚˜, ì ‘íŒ ìƒíƒœë¡œ ë Œë”ë§
      bigGoals.forEach(bg => {
        const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
        const card = document.createElement('div'); card.className = "goal-card";
        
        // í—¤ë”
        const header = document.createElement('div');
        header.className = "goal-card-header";
        header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${themeColor} 100%)`;
        header.onclick = function() {
            const body = card.querySelector('.mid-goal-group');
            const icon = header.querySelector('.toggle-icon');
            if(body.style.display === "none") { body.style.display = "block"; icon.textContent = "â–¼"; }
            else { body.style.display = "none"; icon.textContent = "â–¶"; }
        };

        const dateHtml = (bg['ë§ˆê°ì¼']) ? `<div class="goal-date-badge" style="font-size:0.7rem;">~ ${bg['ë§ˆê°ì¼'].split('T')[0]}</div>` : '';
        header.innerHTML = `
            <div class="goal-card-title" style="flex:1;">
                <span class="toggle-icon">â–¶</span> ${bg['ì œëª©']} ${dateHtml}
            </div>
        `;
        card.appendChild(header);

        // ë°”ë”” (ì¤‘ê°„ ëª©í‘œë§Œ ê°„ë‹¨íˆ í‘œì‹œ)
        const body = document.createElement('div');
        body.className = "mid-goal-group";
        body.style.display = "none"; // ê¸°ë³¸ ì ‘í˜

        const midGoals = goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
        if(midGoals.length > 0) {
            midGoals.forEach(mg => {
                const midItem = document.createElement('div');
                midItem.className = "mid-goal-item";
                midItem.style.borderLeft = `3px solid ${themeColor}`;
                
                // ì¤‘ê°„ ëª©í‘œ ë‚´ ì•„ì´ë””ì–´ ê°œìˆ˜
                const ideaCount = tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']).includes(mg.ID)).length;
                // ì¤‘ê°„ ëª©í‘œ ë‚´ í• ì¼ ì§„í–‰ë„ (ê°„ë‹¨íˆ ì™„ë£Œ/ì „ì²´)
                const mgTasks = tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']).includes(mg.ID) && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´');
                const doneCount = mgTasks.filter(t => t['ìƒíƒœ'] === 'ì™„ë£Œ').length;
                
                midItem.innerHTML = `
                    <div class="mid-goal-header" style="font-size:0.85rem;">
                        <span>ğŸš© ${mg['ì œëª©']}</span>
                        <span class="muted" style="font-size:0.75rem;">
                            ${ideaCount > 0 ? `ğŸ’¡${ideaCount} ` : ''} 
                            ğŸ“ ${doneCount}/${mgTasks.length}
                        </span>
                    </div>
                `;
                body.appendChild(midItem);
            });
        } else {
            body.innerHTML = '<div class="muted" style="padding:10px;">í•˜ìœ„ ëª©í‘œ ì—†ìŒ</div>';
        }
        
        card.appendChild(body);
        root.appendChild(card);
      });
    }

    // ğŸš€ [NEW] Idea Box Renderer (Top 4)
    function renderIdeaWidget(tasks) {
      const root = document.getElementById('ideaBoxContainer');
      root.innerHTML = "";
      
      const ideas = tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ìƒíƒœ'] !== 'ì™„ë£Œ'); // ë¯¸ì™„ë£Œ ì•„ì´ë””ì–´ë§Œ
      if(ideas.length === 0) {
        root.innerHTML = '<div class="muted">ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // ìµœì‹  4ê°œë§Œ í‘œì‹œ
      ideas.reverse().slice(0, 4).forEach(item => {
        const card = document.createElement('div'); card.className = "idea-card";
        const dateStr = item['ê¸°í•œ'] ? item['ê¸°í•œ'].split('T')[0] : '';
        const plainText = (item['ìƒì„¸ë‚´ìš©'] || "").replace(/<[^>]*>?/gm, '').slice(0, 50);

        card.innerHTML = `
            <div class="idea-header">
                ${dateStr ? `<span class="idea-date">ğŸ“… ${dateStr}</span>` : '<span></span>'}
            </div>
            <div class="idea-title">${item['ì œëª©']}</div>
            <div class="idea-body">${plainText || 'ë‚´ìš© ì—†ìŒ'}</div>
        `;
        // í´ë¦­ ì‹œ ì´ë™
        card.style.cursor = 'pointer';
        card.onclick = () => location.href = './todo_manage.html'; 
        
        root.appendChild(card);
      });
    }

    // ===== Data Loading =====
    async function loadDashboard(){
      // 1. ê³µì§€ì‚¬í•­ ë¡œë“œ
      try {
        const res = await fetch(DASHBOARD_API + '?mode=listAnnouncements&limit=3');
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.items)) {
          renderNotices(json.items.map(x => ({ title:x.title, date:x.createdAt?.slice(0,10), level:x.level, noticeId:x.noticeId })));
        } else { renderNotices([]); }
      } catch (e) { console.warn('ê³µì§€ ë¡œë“œ ì‹¤íŒ¨', e); renderNotices([]); }

      // 2. íˆ¬ë‘ ë°ì´í„° ë¡œë“œ (Goal Tree & Idea)
      try {
        const res = await fetch(TODO_API + '?mode=getAllData');
        const json = await res.json();
        if(json.result === "success") {
            const goals = json.goals || [];
            const tasks = json.tasks || [];
            renderGoalTreeWidget(goals, tasks);
            renderIdeaWidget(tasks);
        }
      } catch(e) { 
          console.warn('í• ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
          document.getElementById('goalTreeContainer').innerHTML = '<div class="muted">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
          document.getElementById('ideaBoxContainer').innerHTML = '<div class="muted">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
      }

      // 3. ë”ë¯¸ ë°ì´í„° (ìµœê·¼ ë°˜ë ¤)
      renderMyRejected([]); 
    }

    (function init(){
      setNow(); setInterval(setNow, 1000*30);
      mountShell();
      loadDashboard();
    })();
  </script>
</body>
</html>
