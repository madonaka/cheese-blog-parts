<!-- post_builder.html (ìˆ˜ì •ë³¸: DBì €ì¥=Apps Script savePost, next post_id ì¡°íšŒ, post_id ìë™ë™ê¸°í™”, ë°œí–‰ì€ state.postId ìš°ì„ ) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„° Â· Cheese Lab Admin</title>

  <!-- âœ… í˜ì´ì§€ ë©”íƒ€(ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ê°€ ì½ìŒ) -->
  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE  = "post_builder";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„°";
    window.CHEESE_ADMIN_PAGE_BADGE    = "v0.1";
  </script>

  <!-- Drag & Drop (ë¸”ë¡ ëª©ë¡ ì •ë ¬) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <!-- ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 28px rgba(15,23,42,.10);
      --primary:#111827;
      --soft:#e0f2fe;
      --radius:18px;

      --headerH:56px;
      --sidebarW:280px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    a{ color:inherit; text-decoration:none; }

    /* =========================
       âœ… Admin Shell (slot ê¸°ë°˜)
       ========================= */
    .admin-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    #admin-header-slot{
      position:sticky;
      top:0;
      z-index:50;
      min-height:var(--headerH);
    }

    .admin-main{
      display:flex;
      flex:1 1 auto;
      min-height:calc(100vh - var(--headerH));
    }

    /* âœ… ë©”ë‰´ ìŠ¬ë¡¯(ì¢Œì¸¡ ì‚¬ì´ë“œë°”) */
    .admin-sidebar{
      width:var(--sidebarW);
      flex:0 0 var(--sidebarW);
      background:#fff;
      border-right:1px solid var(--line);
      padding:12px;
      position:sticky;
      top:var(--headerH);
      height:calc(100vh - var(--headerH));
      overflow:auto;
    }

    /* âœ… ë³¸ë¬¸ */
    .admin-content{
      flex:1 1 auto;
      min-width:0;
      padding:14px 14px 28px;
    }

    @media (max-width: 980px){
      .admin-sidebar{ display:none; }
      .admin-content{ padding:12px 12px 24px; }
    }

    /* =========================
       âœ… Page UI (Editor)
       ========================= */
    .wrap{ max-width:1200px; margin:0 auto; }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .page-title{ font-size:18px; font-weight:900; letter-spacing:-.02em; }
    .sub{ color:var(--muted); font-size:12px; }

    .grid{
      display:grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap:12px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .card-h .h1{ font-weight:900; font-size:14px; }
    .card-h .hint{ font-size:12px; color:var(--muted); }
    .card-b{ padding:14px; }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ border-color:rgba(15,23,42,.28); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.small{ padding:7px 9px; border-radius:11px; }
    .btn.danger{ border-color:rgba(239,68,68,.35); color:#991b1b; }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row.right{ justify-content:flex-end; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size:12px; color:var(--muted); font-weight:900; }
    input[type="text"], textarea, select, input[type="number"]{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; line-height:1.45; }
    .mini{ font-size:12px; color:var(--muted); }

    /* ì˜¤ë¥¸ìª½ ë¸”ë¡ ë¦¬ìŠ¤íŠ¸ */
    .block-list{ display:flex; flex-direction:column; gap:8px; padding:12px; }
    .block-item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:grab;
      background:#fff;
    }
    .block-item:active{ cursor:grabbing; }
    .block-item.selected{
      border-color: rgba(17,24,39,.55);
      box-shadow:0 8px 22px rgba(17,24,39,.12);
    }
    .block-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background:var(--soft);
      border:1px solid rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .btitle{
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:240px;
    }
    .bmeta{ font-size:11px; color:var(--muted); }
    .block-actions{ display:flex; gap:6px; flex:0 0 auto; }
    .icon-btn{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }
    .icon-btn:hover{ border-color:rgba(15,23,42,.28); }

    /* ì™¼ìª½ ë¯¸ë¦¬ë³´ê¸° */
    .preview .frame{
      border:1px dashed rgba(15,23,42,.20);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .preview .frame .p-title{
      font-size:18px;
      font-weight:900;
      letter-spacing:-.02em;
      margin:0 0 10px;
    }
    .preview .frame .p-meta{
      margin:0 0 14px;
      color:var(--muted);
      font-size:12px;
    }
    .preview article{ line-height:1.62; font-size:14px; }
    .preview h2{ margin:18px 0 8px; font-size:16px; letter-spacing:-.01em; }
    .preview h3{ margin:14px 0 6px; font-size:14px; }

    .summary-box{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(224,242,254,.55);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
    }
    .ad-box{
      border:1px dashed rgba(123,44,57,.40);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
      background:rgba(123,44,57,.03);
      color:#6b0f22;
      font-weight:900;
      font-size:12px;
    }
    .divider{ height:1px; background:rgba(15,23,42,.10); margin:16px 0; }
    .img-wrap img{ max-width:100%; border-radius:14px; border:1px solid rgba(15,23,42,.10); }
    .toc{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px 12px;
      margin:10px 0 14px;
      background:#fff;
    }
    .toc .t{ font-weight:900; font-size:12px; margin-bottom:6px; }
    .toc a{ color:var(--text); text-decoration:none; }
    .toc a:hover{ text-decoration:underline; }
    .sources{
      margin-top:18px; padding-top:14px;
      border-top:1px solid rgba(15,23,42,.10);
      color:var(--muted);
      font-size:12px;
    }
    .sources ul{ margin:8px 0 0; padding-left:18px; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    /* ì¸í„°ë™í‹°ë¸Œ ë¯¸ë¦¬ë³´ê¸° iframe */
    .pv-embed-wrap{
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:10px;
      background:#fff;
      margin:12px 0;
    }
    .pv-embed-caption{
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
      font-weight:900;
    }
    .pv-iframe{
      width:100%;
      border:0;
      border-radius:14px;
      background:#fff;
    }
    /* =========================
   âœ… DB Load Modal (ì¹´ë“œí˜•)
       ========================= */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal-backdrop.on{ display:flex; }
    
    .modal{
      width:min(980px, 100%);
      max-height:min(86vh, 860px);
      background:#fff;
      border:1px solid rgba(15,23,42,.14);
      border-radius:18px;
      box-shadow:0 18px 50px rgba(15,23,42,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    
    .modal-h{
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modal-title{ font-weight:900; font-size:15px; }
    .modal-sub{ color:var(--muted); font-size:12px; margin-top:3px; }
    
    .modal-b{
      padding:12px 14px 14px;
      overflow:auto;
    }
    
    .post-cards{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .post-cards{ grid-template-columns:repeat(2, 1fr); }
    }
    @media (max-width: 560px){
      .post-cards{ grid-template-columns:1fr; }
    }
    
    .post-card{
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding:12px 12px;
      background:#fff;
      cursor:pointer;
      transition:.12s ease;
    }
    .post-card:hover{
      border-color:rgba(17,24,39,.35);
      box-shadow:0 10px 24px rgba(15,23,42,.10);
      transform:translateY(-1px);
    }
    .post-card .t{
      font-weight:900;
      font-size:13px;
      margin:0 0 8px;
      line-height:1.3;
    }
    .post-card .meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .post-card .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(224,242,254,.6);
      width:max-content;
    }
    .post-card .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .modal-status{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
    .modal-error{
      font-size:12px;
      color:rgba(185,28,28,1);
      font-weight:900;
      margin-top:6px;
    }

  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- âœ… í—¤ë” ìŠ¬ë¡¯ -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- âœ… ë©”ë‰´ ìŠ¬ë¡¯ -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- âœ… ë³¸ë¬¸ -->
      <main class="admin-content">
        <div class="wrap">

          <div class="topbar">
            <div>
              <div class="page-title">ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„°</div>
              <div class="sub">ì˜¤ë¥¸ìª½ ë¸”ë¡ì„ ë“œë˜ê·¸ë¡œ ì¬ì •ë ¬í•˜ë©´, ì™¼ìª½ ìµœì¢… HTMLì´ ì¦‰ì‹œ ì¬ìƒì„±ë©ë‹ˆë‹¤. (ì¸í„°ë™í‹°ë¸Œ ë¸”ë¡ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì‹¤ì œë¡œ ë™ì‘)</div>
            </div>
            <div class="row right">
              <span class="mini mono" id="curPostId" title="í˜„ì¬ í¸ì§‘ ì¤‘ì¸ post_id">post_id: (new)</span>
              <span class="mini mono" id="nextPostId" title="ì‹ ê·œ ì €ì¥ ì‹œ ì˜ˆìƒë˜ëŠ” ë‹¤ìŒ post_id">next: -</span>
              <button class="btn small" id="btnReset">ì´ˆê¸°í™”</button>
              <button class="btn small" id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn small" id="btnSave">DB ì €ì¥</button>
              <button class="btn small primary" id="btnPublish">ë¸”ë¡œê·¸ ë°œí–‰</button>
              <span class="mini" id="publishMsg" style="margin-left:6px;"></span>
            </div>
          </div>

          <div class="grid">
            <!-- LEFT: Preview -->
            <div class="card">
              <div class="card-h">
                <div>
                  <div class="h1">ë¯¸ë¦¬ë³´ê¸°(ìµœì¢… HTML ë Œë”)</div>
                  <div class="hint">DBì—ëŠ” ì´ HTMLì„ content_htmlë¡œ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¥¼ ê¶Œì¥</div>
                </div>
                <div class="row">
                  <button class="btn small" id="btnCopyHtml">HTML ë³µì‚¬</button>
                  <button class="btn small" id="btnDownloadHtml">HTML ì €ì¥</button>
                </div>
              </div>

              <div class="card-b preview">
                <div class="field">
                  <label>ê¸€ ì œëª©</label>
                  <input id="postTitle" type="text" placeholder="ì˜ˆ: ê¹€êµ¬, ì„ì‹œì •ë¶€ì˜ ì¤‘ì‹¬ì— ì„  ì´ìœ " />
                  <!-- âœ… v8: intro ì…ë ¥ UIê°€ ì—†ë”ë¼ë„ JSê°€ null ì—ëŸ¬ë¡œ ì£½ì§€ ì•Šë„ë¡ ìˆ¨ê¹€ í•„ë“œ ì œê³µ -->
                  <input id="postIntro" type="hidden" value="" />
                </div>

                <div class="field">
                  <label>í…œí”Œë¦¿</label>
                  <select id="templateSelect">
                    <option value="default">ê¸°ë³¸(ì‹¬í”Œ)</option>
                    <option value="profile">ì¸ë¬¼ í”„ë¡œí•„í˜•</option>
                    <option value="timeline">ì—°í‘œí˜•</option>
                  </select>
                </div>
                <div class="field">
                  <label>ë¸”ë¡œê·¸ ë°œí–‰ ìƒíƒœ</label>
                  <select id="publishState">
                    <option value="draft">ì´ˆì•ˆ(ë¹„ê³µê°œ)</option>
                    <option value="published">ê³µê°œ</option>
                  </select>
                  <div class="mini">â€» â€œì´ˆì•ˆâ€ì€ Bloggerì—ì„œ ê³µê°œë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤(ì„œë²„ êµ¬í˜„ì— ë”°ë¼ ë™ì‘).</div>
                </div>

                <div class="field">
                  <label>ì˜µì…˜</label>
                  <div class="row">
                    <label class="mini"><input type="checkbox" id="optTOC" checked /> ëª©ì°¨(TOC)</label>
                    <label class="mini"><input type="checkbox" id="optSources" checked /> ì¶œì²˜ ì„¹ì…˜</label>
                  </div>
                </div>

                <div class="field">
                  <label>ë¯¸ë¦¬ë³´ê¸°</label>
                  <div class="frame">
                    <div class="p-title" id="pvTitle">ì œëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                    <div class="p-meta">
                      <span class="mono">blocks:</span> <span id="pvCount">0</span>
                      &nbsp;Â·&nbsp; <span class="mono">template:</span> <span id="pvTemplate">default</span>
                    </div>
                    <div id="pvBody"></div>
                  </div>
                </div>

                <div class="field">
                  <label>ìµœì¢… HTML(ì½ê¸°ì „ìš©)</label>
                  <textarea id="finalHtml" class="mono" readonly></textarea>
                </div>

                <details style="margin-top:10px;">
                  <summary class="mini" style="cursor:pointer; font-weight:900;">ë°œí–‰ API ì„¤ì •(ì„ íƒ)</summary>
                  <div style="margin-top:10px;">
                    <div class="field">
                      <label>API Base</label>
                      <input id="pubApiBase" type="text" placeholder="https://script.google.com/macros/s/AKfycbwW16jbVY6MEgvywrzwB3ie8WDnCXPUo1aLtkTTVAE7FOmmKE1T4VmebAIIK8ppY0ye/exec" />
                      <div class="mini">ê¸°ë³¸ê°’: window.CHEESE_BLOG_API_BASE â†’ window.CHEESE_ADMIN_API_BASE ìˆœì„œë¡œ ìë™ ì‚¬ìš©</div>
                    </div>
                    <div class="field">
                      <label>ë°œí–‰ mode</label>
                      <input id="pubMode" type="text" placeholder="ì˜ˆ: publishPost" />
                    </div>

                    <div class="field">
                      <label>post_id (POSTS ì‹œíŠ¸ í‚¤)</label>
                      <input id="pubPostId" type="text" placeholder="ì˜ˆ: P001" />
                      <div class="mini">â€» Apps Scriptê°€ POSTS ì‹œíŠ¸ì—ì„œ ì´ post_id í–‰ì„ ì°¾ì•„ HTMLì„ ë§Œë“  ë’¤ ë°œí–‰í•©ë‹ˆë‹¤.</div>
                    </div>

                    <div class="field">
                      <label>blogUrl</label>
                      <input id="pubBlogUrl" type="text" placeholder="https://cheesetestblog.blogspot.com/" />
                      <div class="mini">â€» BLOGGER_BLOG_IDë¥¼ ê³ ì •í•˜ì§€ ì•Šì•˜ë‹¤ë©´ blogUrlì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                    </div>
                    <div class="field">
                      <label>blogId (ì„ íƒ)</label>
                      <input id="pubBlogId" type="text" placeholder="(ì„ íƒ) ë¸”ë¡œê·¸ IDë¥¼ ì•Œê³  ìˆìœ¼ë©´ ì…ë ¥" />
                      <div class="mini">â€» blogIdë¥¼ ë„£ìœ¼ë©´ blogUrl ì¡°íšŒë¥¼ ìƒëµí•©ë‹ˆë‹¤.</div>
                    </div>

                    <div class="row right">
                      <button class="btn small" id="btnSavePubConfig" type="button">ì„¤ì • ì €ì¥</button>
                      <button class="btn small" id="btnResetPubConfig" type="button">ì„¤ì • ì´ˆê¸°í™”</button>
                    </div>
                  </div>
                </details>

              </div>
            </div>

            <!-- RIGHT: Blocks -->
            <div class="card">
              <div class="card-h">
                <div>
                  <div class="h1">ë¸”ë¡(ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)</div>
                  <div class="hint">ë¸”ë¡ í´ë¦­ â†’ ì•„ë˜ í¸ì§‘ íŒ¨ë„ì—ì„œ ë‚´ìš© ìˆ˜ì •</div>
                </div>
                <div class="row">
                  <button class="btn small" id="btnAddSection">ì„¹ì…˜</button>
                  <button class="btn small" id="btnAddSummary">ìš”ì•½</button>
                  <button class="btn small" id="btnAddImage">ì´ë¯¸ì§€</button>
                  <button class="btn small" id="btnAddAd">ê´‘ê³ </button>

                  <button class="btn small" id="btnAddFlash">í”Œë˜ì‹œì¹´ë“œ</button>
                  <button class="btn small" id="btnAddOrder">ë“œë˜ê·¸ ìˆœì„œ</button>
                  <button class="btn small" id="btnAddQuiz">ëœë¤ í€´ì¦ˆ</button>
                </div>
              </div>

              <div class="block-list" id="blockList"></div>

              <div class="card-b">
                <div class="field">
                  <label>ì„ íƒ ë¸”ë¡ í¸ì§‘</label>
                  <div class="mini">ì˜¤ë¥¸ìª½ ëª©ë¡ì—ì„œ ë¸”ë¡ì„ í´ë¦­í•˜ì„¸ìš”.</div>
                </div>

                <div id="editorEmpty" class="mini" style="padding:12px; border:1px dashed rgba(15,23,42,.18); border-radius:14px;">
                  ì•„ì§ ì„ íƒëœ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div id="editorPanel" style="display:none;">
                  <div class="field">
                    <label>ë¸”ë¡ íƒ€ì… / ID</label>
                    <div class="row">
                      <input id="edType" type="text" readonly class="mono" style="max-width:170px;" />
                      <input id="edId" type="text" readonly class="mono" />
                    </div>
                  </div>

                  <div class="field" id="edTitleWrap">
                    <label>ì œëª©</label>
                    <input id="edTitle" type="text" placeholder="ì˜ˆ: ë³¸ë¡  1. ì„ì‹œì •ë¶€" />
                  </div>

                  <div class="field" id="edBodyWrap">
                    <label>ë‚´ìš©</label>
                    <textarea id="edBody" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆì€ ìë™ìœ¼ë¡œ <p> ì²˜ë¦¬)"></textarea>
                  </div>

                  <div class="field" id="edUrlWrap" style="display:none;">
                    <label>ì´ë¯¸ì§€ URL</label>
                    <input id="edUrl" type="text" placeholder="https://..." />
                  </div>

                  <div class="field" id="edAdWrap" style="display:none;">
                    <label>ê´‘ê³  ë¬¸êµ¬(í‘œì‹œìš©)</label>
                    <input id="edAdLabel" type="text" placeholder="ì˜ˆ: ë°°ë„ˆ A / ìŠ¬ë¡¯ A" />
                  </div>

                  <!-- í”Œë˜ì‹œì¹´ë“œ -->
                  <div id="edFlashWrap" style="display:none;">
                    <div class="field">
                      <label>ì¹´ë“œ(ì¼ê´„ ì…ë ¥)</label>
                      <div class="mini">í•œ ì¤„ì— 1ì¥: <span class="mono">ì•ë©´[TAB]ë’·ë©´</span> ë˜ëŠ” <span class="mono">ì•ë©´ | ë’·ë©´</span></div>
                      <textarea id="edFlashBulk" placeholder="ì˜ˆ)&#10;ì„ì‚¬ëŠ‘ì•½	1905ë…„ ì²´ê²°&#10;í•œì„±ì¡°ì•½ | 1882ë…„(ì„ì˜¤êµ°ë€)"></textarea>
                    </div>
                    <div class="row">
                      <button class="btn small" id="btnFlashFromBlock">ë¸”ë¡ â†’ í…ìŠ¤íŠ¸</button>
                      <button class="btn small" id="btnFlashToBlock">í…ìŠ¤íŠ¸ â†’ ë¸”ë¡</button>
                    </div>
                  </div>

                  <!-- ë“œë˜ê·¸ ìˆœì„œ -->
                  <div id="edOrderWrap" style="display:none;">
                    <div class="field">
                      <label>ë¬¸ì œ ì œëª©</label>
                      <input id="edOrderTitle" type="text" placeholder="ì˜ˆ: ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!" />
                    </div>
                    <div class="field">
                      <label>ë³´ì¡° ë¬¸êµ¬(ì˜µì…˜)</label>
                      <input id="edOrderSub" type="text" placeholder="ì˜ˆ: ì•„ë˜ í•­ëª©ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì¹˜í•˜ì„¸ìš”." />
                    </div>
                    <div class="field">
                      <label>ì˜µì…˜</label>
                      <div class="row">
                        <label class="mini"><input type="checkbox" id="edOrderShuffle" checked /> ë³´ê¸° ì„ê¸°</label>
                      </div>
                    </div>
                    <div class="field">
                      <label>í•­ëª©(ì¼ê´„ ì…ë ¥)</label>
                      <div class="mini">í•œ ì¤„ì— 1ê°œ í•­ëª©(ìµœì†Œ 2ê°œ)</div>
                      <textarea id="edOrderItems" placeholder="ì˜ˆ)&#10;ëŒ€í•œì œêµ­ ì„ í¬&#10;ì„ì‚¬ëŠ‘ì•½&#10;í•œì¼ë³‘í•©"></textarea>
                    </div>
                    <div class="field">
                      <label>ì •ë‹µ ìˆœì„œ(ì˜µì…˜)</label>
                      <div class="mini">ë¯¸ì…ë ¥ ì‹œ â€œì…ë ¥í•œ í•­ëª© ìˆœì„œâ€ê°€ ì •ë‹µ. ìˆ«ì ì½¤ë§ˆ: <span class="mono">1,3,2</span></div>
                      <input id="edOrderAnswer" type="text" placeholder="ì˜ˆ: 1,2,3" />
                    </div>
                  </div>

                  <!-- ëœë¤ í€´ì¦ˆ ì„ë² ë“œ -->
                  <div id="edQuizWrap" style="display:none;">
                    <div class="field">
                      <label>examKey</label>
                      <input id="edQuizKey" type="text" class="mono" placeholder="ì˜ˆ: khs-era-01" />
                      <div class="mini">questions.html / exam_sets ì‹œíŠ¸ì—ì„œ ì“°ëŠ” í‚¤(ë¸”ë¡œê·¸ì—ì„  data-exam-keyë¡œ ì‚¬ìš©)</div>
                    </div>
                    <div class="field">
                      <label>í‘œì‹œ ì œëª©</label>
                      <input id="edQuizTitle" type="text" placeholder="ì˜ˆ: í•œêµ­ì‚¬ ì‹œëŒ€ ìˆœì„œ ì—°ìŠµë¬¸ì œ â‘ " />
                    </div>
                    <div class="row">
                      <div class="field" style="flex:1 1 120px; min-width:120px;">
                        <label>limit</label>
                        <input id="edQuizLimit" type="number" min="1" max="50" value="5" />
                      </div>
                      <div class="field" style="flex:1 1 160px; min-width:160px;">
                        <label>period(ì˜µì…˜)</label>
                        <input id="edQuizPeriod" type="text" placeholder="ì˜ˆ: í•œêµ­ì‚¬-í†µì‚¬" />
                      </div>
                    </div>
                    <div class="field">
                      <label>topic(ì˜µì…˜)</label>
                      <input id="edQuizTopic" type="text" placeholder="ì˜ˆ: ì‹œëŒ€ìˆœì„œ" />
                    </div>
                    <div class="mini">â€» ì´ ë¸”ë¡ì€ ë¸”ë¡œê·¸ì—ì„œ ì¹˜ì¦ˆ í€´ì¦ˆ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ ë™ì‘í•©ë‹ˆë‹¤.</div>
                  </div>

                  <div class="row right" style="margin-top:10px;">
                    <button class="btn small danger" id="btnDeleteBlock">ì‚­ì œ</button>
                    <button class="btn small primary" id="btnApplyBlock">ì ìš©</button>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- grid -->

        </div><!-- wrap -->
      </main>
    </div>
  </div>
  
    <!-- =========================
         âœ… ë¶ˆëŸ¬ì˜¤ê¸°: DB ëª©ë¡ ëª¨ë‹¬
         ========================= -->
    <div class="modal-backdrop" id="loadModalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loadModalTitle">
        <div class="modal-h">
          <div>
            <div class="modal-title" id="loadModalTitle">DBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</div>
            <div class="modal-sub">ì €ì¥ëœ ê¸€ ëª©ë¡ì—ì„œ ì„ íƒí•˜ë©´ ì—ë””í„°ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</div>
          </div>
          <button type="button" class="icon-btn" id="btnCloseLoadModal" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
    
        <div class="modal-b">
          <div class="row" style="margin-bottom:10px;">
            <input id="loadSearch" type="text" placeholder="ê²€ìƒ‰: ì œëª© ë˜ëŠ” post_id" />
            <button class="btn small" id="btnRefreshPosts" type="button">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn small" id="btnLoadLocalDraft" type="button" title="localStorage ì„ì‹œì €ì¥ë³¸ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤">ë¡œì»¬ ì„ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
    
          <div id="loadStatus" class="modal-status"></div>
          <div id="loadError" class="modal-error" style="display:none;"></div>
    
          <div class="post-cards" id="postCards"></div>
    
          <div class="row right" style="margin-top:10px;">
            <button class="btn small" id="btnLoadMorePosts" type="button" style="display:none;">ë” ë³´ê¸°</button>
          </div>
        </div>
      </div>
    </div>
      

  
  <!-- âœ… ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./admin-common.js"></script>

  <script>
    /************************************************************
     * âœ… Block Editor (post_builder)
     ************************************************************/
    const $ = (id) => document.getElementById(id);

    // âœ… í˜„ì¬ í¸ì§‘ ê¸€ì˜ post_id
    const state = {
      blocks: [],
      selectedId: null,
      postId: '',
      options: { toc:true, sources:false },
      lastLoadedBody: ''
    };

    const uid = () => 'b' + Math.random().toString(36).slice(2, 9) + Date.now().toString(36).slice(2,6);

    // âœ… ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œíƒœê·¸ ë¬¸ìì—´ì€ "ìª¼ê°œì„œ" ë§Œë“ ë‹¤ (HTML íŒŒì„œ ë³´í˜¸)
    const CLOSE_SCRIPT = '</scr' + 'ipt>';

    const makeSection = () => ({ id: uid(), type:'section', data:{ title:'ì†Œì œëª©', body:'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\në‘ë²ˆì§¸ ì¤„ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.' } });
    const makeSummary = () => ({ id: uid(), type:'summary', data:{ title:'í•µì‹¬ ìš”ì•½', body:'- ìš”ì•½ 1\n- ìš”ì•½ 2\n- ìš”ì•½ 3' } });
    const makeImage   = () => ({ id: uid(), type:'image',   data:{ title:'ì´ë¯¸ì§€', url:'https://picsum.photos/800/420', alt:'ì´ë¯¸ì§€' } });
    const makeAd      = () => ({ id: uid(), type:'ad',      data:{ label:'ê´‘ê³  ìŠ¬ë¡¯ A' } });

    const makeFlash   = () => ({
      id: uid(),
      type:'flashcard',
      data:{
        title:'í”Œë˜ì‹œì¹´ë“œ',
        cards:[
          { front:'ì„ì‚¬ëŠ‘ì•½', back:'1905ë…„ ì²´ê²°' },
          { front:'í•œì¼ë³‘í•©', back:'1910ë…„' },
        ]
      }
    });

    const makeOrder   = () => ({
      id: uid(),
      type:'order_quiz',
      data:{
        title:'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!',
        sub:'ì•„ë˜ í•­ëª©ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì¹˜í•˜ì„¸ìš”.',
        shuffle:true,
        items:['ëŒ€í•œì œêµ­ ì„ í¬','ì„ì‚¬ëŠ‘ì•½','í•œì¼ë³‘í•©'],
        answerNums:''
      }
    });

    const makeQuiz    = () => ({
      id: uid(),
      type:'quiz_embed',
      data:{
        examKey:'khs-era-01',
        title:'í•œêµ­ì‚¬ ì‹œëŒ€ ìˆœì„œ ì—°ìŠµë¬¸ì œ â‘ ',
        limit:5,
        period:'í•œêµ­ì‚¬-í†µì‚¬',
        topic:'ì‹œëŒ€ìˆœì„œ'
      }
    });

    const blockList = $('blockList');
    let sortable = null;

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('\n',' '); }

    function blockLabel(type){
      if (type==='section') return 'SECTION';
      if (type==='summary') return 'SUMMARY';
      if (type==='image') return 'IMAGE';
      if (type==='ad') return 'AD';
      if (type==='flashcard') return 'FLASH';
      if (type==='order_quiz') return 'ORDER';
      if (type==='quiz_embed') return 'QUIZ';
      return 'BLOCK';
    }
    function blockTitle(b){
      if (b.type==='section') return b.data?.title || 'ì„¹ì…˜';
      if (b.type==='summary') return b.data?.title || 'ìš”ì•½';
      if (b.type==='image') return b.data?.title || 'ì´ë¯¸ì§€';
      if (b.type==='ad') return b.data?.label || 'ê´‘ê³ ';
      if (b.type==='flashcard') return (b.data?.title || 'í”Œë˜ì‹œì¹´ë“œ') + ` (${(b.data?.cards||[]).length}ì¥)`;
      if (b.type==='order_quiz') return (b.data?.title || 'ë“œë˜ê·¸ ìˆœì„œ') + ` (${(b.data?.items||[]).length}ê°œ)`;
      if (b.type==='quiz_embed') return (b.data?.title || 'ëœë¤ í€´ì¦ˆ') + ` (${b.data?.examKey||''})`;
      return b.type;
    }
    function currentBlock(){
      return state.blocks.find(b => b.id===state.selectedId) || null;
    }

    function parasFromText(text){
      const lines = String(text || '').split(/\r?\n/);
      const ps = [];
      let buf = [];
      for (const line of lines){
        const trimmed = line.trim();
        if (!trimmed){
          if (buf.length){
            ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');
            buf = [];
          }
          continue;
        }
        if (trimmed.startsWith('- ')){
          if (buf.length){
            ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');
            buf = [];
          }
          ps.push('__UL_START__');
          ps.push('<li>' + escapeHtml(trimmed.slice(2)) + '</li>');
          ps.push('__UL_END__');
          continue;
        }
        buf.push(trimmed);
      }
      if (buf.length) ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');

      const out = [];
      let inUl = false;
      for (const item of ps){
        if (item === '__UL_START__'){
          if (!inUl){ out.push('<ul>'); inUl = true; }
          continue;
        }
        if (item === '__UL_END__'){ continue; }
        if (item.startsWith('<li')){ out.push(item); continue; }
        if (inUl){ out.push('</ul>'); inUl = false; }
        out.push(item);
      }
      if (inUl) out.push('</ul>');
      return out.join('\n');
    }

    function shuffleCopy(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        const t=a[i]; a[i]=a[j]; a[j]=t;
      }
      return a;
    }

    function parseOrderNums(text, n){
      const raw = String(text||'').trim();
      if(!raw) return null;
      const nums = raw.split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => Number(s));

      if(nums.length !== n) return { ok:false, msg:`ì •ë‹µ ìˆœì„œ ìˆ«ì ê°œìˆ˜(${nums.length})ê°€ í•­ëª©(${n})ê³¼ ë‹¬ë¼ìš”.` };
      const seen = new Set();
      for(const x of nums){
        if(!Number.isInteger(x) || x<1 || x>n) return { ok:false, msg:`ì •ë‹µ ìˆœì„œì— 1~${n} ë²”ìœ„ ë°– ìˆ«ìê°€ ìˆì–´ìš”: ${x}` };
        if(seen.has(x)) return { ok:false, msg:'ì •ë‹µ ìˆœì„œì— ì¤‘ë³µ ìˆ«ìê°€ ìˆì–´ìš”.' };
        seen.add(x);
      }
      return { ok:true, nums };
    }

    /* ===========================
       âœ… ì¸í„°ë™í‹°ë¸Œ ìŠ¤ë‹ˆí« ìƒì„±
       =========================== */
    function buildFlashcardSnippet(b){
      const id = `cheese-fc-${b.id}`;
      const cards = Array.isArray(b.data?.cards) ? b.data.cards : [];
      const data = JSON.stringify(cards);

      return [
`<!-- â–¼ í”Œë˜ì‹œì¹´ë“œ -->
<div id="${id}" class="cheese-flashcard-wrapper"></div>

<style>
  .cheese-flashcard-wrapper{display:flex;flex-direction:column;align-items:center;gap:1.2rem;margin:1.5rem 0;}
  .cheese-flashcard{background:none;border:none;padding:0;width:380px;height:230px;perspective:1000px;cursor:pointer;position:relative;border-radius:22px;overflow:hidden;box-shadow:0 14px 30px rgba(15,23,42,.2);}
  .cheese-flashcard.is-flipped .cheese-flashcard-inner{transform:rotateY(180deg);}
  .cheese-flashcard-inner{width:100%;height:100%;position:relative;border-radius:22px;background:#fff;transform-style:preserve-3d;transition:transform .35s ease;}
  .cheese-flashcard-face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:1.2rem 1.4rem;box-sizing:border-box;backface-visibility:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:1.15rem;text-align:center;line-height:1.5;border-radius:22px;}
  .cheese-flashcard-front{background:#111827;color:#f9fafb;font-weight:800;}
  .cheese-flashcard-back{background:#e0f2fe;color:#111827;transform:rotateY(180deg);font-weight:800;}
  .cheese-flashcard-hint{position:absolute;right:.9rem;bottom:.6rem;font-size:.75rem;opacity:.85;pointer-events:none;}
  @media(max-width:600px){
    .cheese-flashcard{width:84vw;max-width:340px;height:210px;}
  }
</style>

<script>
(function(){
  var root = document.getElementById(${JSON.stringify(id)});
  if(!root) return;

  var cards = ${data};

  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  cards.forEach(function(item, idx){
    var btn = document.createElement("button");
    btn.type = "button";
    btn.className = "cheese-flashcard";
    btn.setAttribute("aria-label", "ì¹´ë“œ " + (idx+1));
    btn.setAttribute("aria-pressed","false");

    btn.innerHTML =
      '<div class="cheese-flashcard-inner">' +
        '<div class="cheese-flashcard-face cheese-flashcard-front">' +
          '<div>' + esc(item.front) + '</div>' +
          '<div class="cheese-flashcard-hint">ğŸ‘‰ ë’¤ì§‘ê¸°</div>' +
        '</div>' +
        '<div class="cheese-flashcard-face cheese-flashcard-back">' +
          '<div>' + esc(item.back) + '</div>' +
          '<div class="cheese-flashcard-hint">ğŸ‘‰ ë’¤ì§‘ê¸°</div>' +
        '</div>' +
      '</div>';

    btn.addEventListener("click", function(){
      btn.classList.toggle("is-flipped");
      btn.setAttribute("aria-pressed", btn.classList.contains("is-flipped") ? "true" : "false");
    });

    root.appendChild(btn);
  });
})();
` + CLOSE_SCRIPT
      ].join('\n');
    }

    function buildOrderQuizSnippet(b){
      const id = `cheese-oq-${b.id}`;
      const title = String(b.data?.title || 'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!').trim();
      const sub   = String(b.data?.sub || '').trim();
      const items = Array.isArray(b.data?.items) ? b.data.items.filter(x => String(x||'').trim()) : [];
      const shuffle = !!b.data?.shuffle;

      const n = items.length;
      const parsed = parseOrderNums(b.data?.answerNums || '', n);
      const correctNums = (parsed && parsed.ok && parsed.nums) ? parsed.nums : null;

      const baseItems = items.map((label, i) => ({ id:`i${i+1}`, label }));
      const correctOrder = correctNums ? correctNums.map(x => `i${x}`) : baseItems.map(x => x.id);
      const viewItems = shuffle ? shuffleCopy(baseItems) : baseItems;

      const viewJson = JSON.stringify(viewItems);
      const correctJson = JSON.stringify(correctOrder);

      return [
`<!-- â–¼ ë“œë˜ê·¸ ìˆœì„œ í€´ì¦ˆ -->
<div id="${id}" class="cheese-order-quiz"></div>

<style>
  .cheese-order-quiz{max-width:720px;margin:1.8rem auto;padding:1.2rem 1.1rem;border-radius:16px;background:#f9fafb;box-shadow:0 8px 22px rgba(15,23,42,.10);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;box-sizing:border-box;}
  .cheese-order-title{font-size:1.35rem;font-weight:900;margin:0 0 .6rem;}
  .cheese-order-sub{font-size:.95rem;color:#6b7280;margin:0 0 1rem;}
  .cheese-order-top{display:flex;flex-wrap:wrap;gap:.6rem;padding:.6rem;border:1px dashed rgba(15,23,42,.18);border-radius:14px;background:#fff;}
  .cheese-order-bottom{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem;margin-top:.9rem;}
  @media(min-width:720px){ .cheese-order-bottom{grid-template-columns:repeat(4,1fr);} }
  .cheese-order-slot{min-height:44px;border-radius:999px;border:2px dashed #d1d5db;background:#fff;display:flex;align-items:center;justify-content:center;font-size:.95rem;color:#9ca3af;box-sizing:border-box;transition:.12s ease;}
  .cheese-order-slot.is-over{border-color:#6366f1;background:#e0e7ff;transform:translateY(-1px);}
  .cheese-order-card{border:2px solid #7B2C39;border-radius:999px;padding:.55rem .9rem;background:#111827;color:#f9fafb;font-weight:900;font-size:.95rem;cursor:grab;user-select:none;box-shadow:0 3px 8px rgba(15,23,42,.20);}
  .cheese-order-card:active{cursor:grabbing;}
  .cheese-order-controls{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;align-items:center;margin-top:1rem;}
  .cheese-order-btn{border:0;border-radius:999px;padding:.7rem 1.1rem;font-weight:900;cursor:pointer;box-shadow:0 4px 10px rgba(15,23,42,.12);}
  .cheese-order-btn.check{background:#dc2626;color:#fff;}
  .cheese-order-btn.reset{background:#e5e7eb;color:#111827;}
  .cheese-order-result{flex:1;color:#4b5563;font-weight:900;}
  .cheese-order-result.ok{color:#15803d;}
  .cheese-order-result.bad{color:#b91c1c;}
  .cheese-order-help{color:#6b7280;font-size:.85rem;margin-top:.7rem;line-height:1.45;}
</style>

<script>
(function(){
  var root = document.getElementById(${JSON.stringify(id)});
  if(!root) return;

  var items = ${viewJson};
  var correct = ${correctJson};

  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  root.innerHTML =
    '<div class="cheese-order-title">' + esc(${JSON.stringify(title)}) + '</div>' +
    (${JSON.stringify(sub)} ? '<div class="cheese-order-sub">' + esc(${JSON.stringify(sub)}) + '</div>' : '') +
    '<div class="cheese-order-top" data-top="1"></div>' +
    '<div class="cheese-order-bottom" data-bottom="1"></div>' +
    '<div class="cheese-order-controls">' +
      '<div class="cheese-order-result"></div>' +
      '<button type="button" class="cheese-order-btn reset">ì´ˆê¸°í™”</button>' +
      '<button type="button" class="cheese-order-btn check">ì±„ì í•˜ê¸°</button>' +
    '</div>' +
    '<div class="cheese-order-help">ğŸ’¡ PCëŠ” ë“œë˜ê·¸&ë“œë¡­, ëª¨ë°”ì¼ì€ â€œì¹´ë“œ íƒ­ â†’ ë¹ˆ ìŠ¬ë¡¯ ìë™ ë°°ì¹˜â€ ë°©ì‹ìœ¼ë¡œë„ í’€ ìˆ˜ ìˆì–´ìš”.</div>';

  var top = root.querySelector(".cheese-order-top");
  var bottom = root.querySelector(".cheese-order-bottom");
  var resultEl = root.querySelector(".cheese-order-result");
  var btnReset = root.querySelector(".cheese-order-btn.reset");
  var btnCheck = root.querySelector(".cheese-order-btn.check");

  function makeSlots(n){
    bottom.innerHTML = "";
    for(var i=0;i<n;i++){
      var s=document.createElement("div");
      s.className="cheese-order-slot";
      s.dataset.slotIndex=String(i);
      s.textContent=(i+1) + "ë²ˆ";
      bottom.appendChild(s);
    }
  }

  function placeToTop(cardEl){
    if(!cardEl) return;
    top.appendChild(cardEl);
  }

  function placeToFirstEmpty(cardEl){
    var slots = Array.from(bottom.querySelectorAll(".cheese-order-slot"));
    for(var i=0;i<slots.length;i++){
      if(!slots[i].querySelector(".cheese-order-card")){
        slots[i].textContent="";
        slots[i].appendChild(cardEl);
        return true;
      }
    }
    return false;
  }

  function resetAll(){
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
    top.innerHTML="";
    makeSlots(items.length);

    items.forEach(function(it){
      var c=document.createElement("div");
      c.className="cheese-order-card";
      c.draggable=true;
      c.dataset.itemId=it.id;
      c.textContent=it.label;
      top.appendChild(c);
    });
  }

  var dragging=null;

  root.addEventListener("dragstart", function(e){
    var card = e.target.closest(".cheese-order-card");
    if(!card) return;
    dragging = card;
    if(e.dataTransfer){
      e.dataTransfer.effectAllowed = "move";
      try{ e.dataTransfer.setData("text/plain", card.dataset.itemId||""); }catch(_){}
    }
  });

  root.addEventListener("dragover", function(e){
    if(!dragging) return;
    var slot = e.target.closest(".cheese-order-slot");
    var isTop = e.target.closest("[data-top]");
    if(!slot && !isTop) return;
    e.preventDefault();
    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });
    if(slot) slot.classList.add("is-over");
  });

  root.addEventListener("drop", function(e){
    if(!dragging) return;
    var slot = e.target.closest(".cheese-order-slot");
    var isTop = e.target.closest("[data-top]");
    if(!slot && !isTop) return;
    e.preventDefault();

    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });

    if(isTop){
      placeToTop(dragging);
    }else{
      var existing = slot.querySelector(".cheese-order-card");
      if(existing) placeToTop(existing);
      slot.textContent="";
      slot.appendChild(dragging);
    }
    dragging=null;
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
  });

  root.addEventListener("dragend", function(){
    dragging=null;
    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });
  });

  root.addEventListener("click", function(e){
    var card = e.target.closest(".cheese-order-card");
    if(!card) return;

    var inSlot = card.parentElement && card.parentElement.classList.contains("cheese-order-slot");
    if(inSlot){
      placeToTop(card);
      resultEl.textContent="";
      resultEl.className="cheese-order-result";
      Array.from(bottom.querySelectorAll(".cheese-order-slot")).forEach(function(s){
        if(!s.querySelector(".cheese-order-card")){
          s.textContent=(Number(s.dataset.slotIndex)+1)+"ë²ˆ";
        }
      });
      return;
    }

    var ok = placeToFirstEmpty(card);
    if(!ok) return;
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
  });

  btnCheck.addEventListener("click", function(){
    var slots = Array.from(bottom.querySelectorAll(".cheese-order-slot"));
    var user = slots.map(function(s){
      var c = s.querySelector(".cheese-order-card");
      return c ? (c.dataset.itemId||null) : null;
    });

    if(user.some(function(x){ return !x; })){
      resultEl.textContent="ì•„ì§ ë¹ˆ ì¹¸ì´ ìˆì–´ìš”. ëª¨ë“  ì¹¸ì— ë°°ì¹˜í•´ ì£¼ì„¸ìš”.";
      resultEl.className="cheese-order-result bad";
      return;
    }

    var ok=true;
    for(var i=0;i<correct.length;i++){
      if(user[i] !== correct[i]){ ok=false; break; }
    }

    if(ok){
      resultEl.textContent="ì •ë‹µ! ì•„ì£¼ ì˜í–ˆìŠµë‹ˆë‹¤ ğŸ‘";
      resultEl.className="cheese-order-result ok";
    }else{
      resultEl.textContent="ìˆœì„œê°€ ì¼ë¶€ ë‹¤ë¦…ë‹ˆë‹¤. ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”.";
      resultEl.className="cheese-order-result bad";
    }
  });

  btnReset.addEventListener("click", resetAll);

  resetAll();
})();
` + CLOSE_SCRIPT
      ].join('\n');
    }

    function buildQuizEmbedSnippet(b){
      const d = b.data || {};
      const examKey = String(d.examKey||'').trim();
      const title = String(d.title||'ì—°ìŠµë¬¸ì œ').trim();
      const limit = Number(d.limit||5) || 5;
      const period = String(d.period||'').trim();
      const topic = String(d.topic||'').trim();

      const lines = [
        '<div',
        '  class="cheese-quiz"',
        `  data-exam-key="${escapeAttr(examKey)}"`,
        '  data-source="sheet"',
        `  data-limit="${escapeAttr(String(limit))}"`,
        period ? `  data-period="${escapeAttr(period)}"` : '',
        topic ? `  data-topic="${escapeAttr(topic)}"` : '',
        '>',
        `  <h3>${escapeHtml(title)}</h3>`,
        '  <ol class="cheese-quiz-list"></ol>',
        '  <div class="cheese-quiz-buttons">',
        '    <button type="button" class="cheese-quiz-check">ì±„ì í•˜ê¸°</button>',
        '    <button type="button" class="cheese-quiz-reset">ë‹¤ì‹œ í’€ê¸°</button>',
        '  </div>',
        '  <div class="cheese-quiz-result"></div>',
        '</div>',
      ].filter(Boolean);

      return `<!-- â–¼ ëœë¤ í€´ì¦ˆ(ì¹˜ì¦ˆ í€´ì¦ˆ) -->\n` + lines.join('\n');
    }

    function renderBlockToFinalHtml(b){
      if (b.type==='section'){
        const id = 'sec-' + b.id;
        return `
<section class="blk blk--section" id="${escapeAttr(id)}">
  <h2>${escapeHtml(b.data?.title || 'ì†Œì œëª©')}</h2>
  ${parasFromText(b.data?.body || '')}
</section>`.trim();
      }
      if (b.type==='summary'){
        return `
<div class="summary-box blk blk--summary">
  <h3>${escapeHtml(b.data?.title || 'í•µì‹¬ ìš”ì•½')}</h3>
  ${parasFromText(b.data?.body || '')}
</div>`.trim();
      }
      if (b.type==='image'){
        const url = b.data?.url || '';
        const alt = b.data?.alt || 'ì´ë¯¸ì§€';
        return `
<div class="img-wrap blk blk--image">
  <div class="mini" style="margin:0 0 8px; font-weight:900;">${escapeHtml(b.data?.title || 'ì´ë¯¸ì§€')}</div>
  <img src="${escapeAttr(url)}" alt="${escapeAttr(alt)}" />
</div>`.trim();
      }
      if (b.type==='ad'){
        return `
<div class="ad-box blk blk--ad">
  ê´‘ê³  ë¸”ë¡ Â· ${escapeHtml(b.data?.label || 'ê´‘ê³ ')}
  <div class="mini" style="margin-top:6px; color:#6b0f22;">(ìš´ì˜ í™˜ê²½ì— ë§ì¶° ë°°ë„ˆ/ìŠ¬ë¡¯ HTMLë¡œ êµì²´)</div>
</div>`.trim();
      }
      if (b.type==='flashcard') return buildFlashcardSnippet(b).trim();
      if (b.type==='order_quiz') return buildOrderQuizSnippet(b).trim();
      if (b.type==='quiz_embed') return buildQuizEmbedSnippet(b).trim();

      return `<div class="blk">Unknown block</div>`;
    }

    function buildTOC(blocks){
      const items = blocks
        .filter(b => b.type==='section')
        .map(b => {
          const id = 'sec-' + b.id;
          const t = b.data?.title || 'ì†Œì œëª©';
          return `<li><a href="#${escapeAttr(id)}">${escapeHtml(t)}</a></li>`;
        });
      if (!items.length) return '';
      return `
<nav class="toc">
  <div class="t">ëª©ì°¨</div>
  <ul style="margin:0; padding-left:18px;">${items.join('\n')}</ul>
</nav>`.trim();
    }

    function wrapTemplate(templateId, title, innerHtml){
      if (templateId === 'profile'){
        return `
<article class="post post--profile">
  <header class="post__head">
    <h1 style="margin:0 0 6px; font-size:20px; letter-spacing:-.02em;">${escapeHtml(title || '')}</h1>
    <div style="color:rgba(100,116,139,1); font-size:12px;">ì¸ë¬¼ í”„ë¡œí•„ í…œí”Œë¦¿</div>
  </header>
  <div class="divider"></div>
  ${innerHtml}
</article>`.trim();
      }
      if (templateId === 'timeline'){
        return `
<article class="post post--timeline">
  <header class="post__head">
    <h1 style="margin:0 0 6px; font-size:20px; letter-spacing:-.02em;">${escapeHtml(title || '')}</h1>
    <div style="color:rgba(100,116,139,1); font-size:12px;">ì—°í‘œ í…œí”Œë¦¿</div>
  </header>
  <div class="divider"></div>
  ${innerHtml}
</article>`.trim();
      }
      return `<article class="post post--default">${innerHtml}</article>`;
    }

    function buildFinalHtml(){
      const title = $('postTitle').value.trim();
      const templateId = $('templateSelect').value;
      const optTOC = $('optTOC').checked;
      const optSources = $('optSources').checked;

      // âœ… fallback: blocks_json ì´ ë¹„ì–´ìˆì§€ë§Œ, DBì— body(html)ê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš°
      // (ì˜ˆ: ì˜ˆì „ ë²„ì „ì—ì„œ blocks ì €ì¥ì´ ì•ˆ ëë˜ ê¸€)
      const rawBody = String(state.lastLoadedBody || '').trim();
      const hasBlocks = Array.isArray(state.blocks) && state.blocks.length > 0;
      if (!hasBlocks && rawBody){
        // bodyê°€ ì´ë¯¸ ì™„ì„± HTML(íŠ¹íˆ <article> ë˜ëŠ” ì „ì²´ ë¬¸ì„œ) í˜•íƒœë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        if (/<article[\s>]/i.test(rawBody) || /<html[\s>]/i.test(rawBody)){
          return rawBody;
        }
        // content ì¡°ê°ì´ë©´ í…œí”Œë¦¿ìœ¼ë¡œ ê°ì‹¸ì„œ ë°˜í™˜
        return wrapTemplate(templateId, title, rawBody).trim();
      }

      const bodyParts = [];
      if (optTOC) bodyParts.push(buildTOC(state.blocks));
      bodyParts.push(...state.blocks.map(renderBlockToFinalHtml));

      if (optSources){
        bodyParts.push(`
<div class="sources">
  <div style="font-weight:900;">ì¶œì²˜</div>
  <ul>
    <li>ì˜ˆì‹œ ì¶œì²˜ 1</li>
    <li>ì˜ˆì‹œ ì¶œì²˜ 2</li>
  </ul>
</div>`.trim());
      }

      return wrapTemplate(templateId, title, bodyParts.filter(Boolean).join('\n\n')).trim();
    }

    function renderPreview(){
      const title = $('postTitle').value.trim() || 'ì œëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
      $('pvTitle').textContent = title;
      $('pvCount').textContent = String(state.blocks.length);
      $('pvTemplate').textContent = $('templateSelect').value;

      const final = buildFinalHtml();
      $('finalHtml').value = final;

      const templateId = $('templateSelect').value;
      const optTOC = $('optTOC').checked;
      const optSources = $('optSources').checked;

      const parts = [];
      if (optTOC) parts.push(buildTOC(state.blocks));

      state.blocks.forEach((b) => {
        if (b.type === 'flashcard' || b.type === 'order_quiz'){
          const caption = (b.type==='flashcard') ? 'í”Œë˜ì‹œì¹´ë“œ(ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰)' : 'ë“œë˜ê·¸ ìˆœì„œ í€´ì¦ˆ(ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰)';
          const h = (b.type==='flashcard') ? 320 : 520;

          parts.push(`
<div class="pv-embed-wrap" data-embed-id="${escapeAttr(b.id)}" data-embed-type="${escapeAttr(b.type)}" data-embed-height="${h}">
  <div class="pv-embed-caption">${escapeHtml(caption)}</div>
  <iframe class="pv-iframe" title="${escapeAttr(caption)}"></iframe>
</div>`.trim());
          return;
        }

        if (b.type==='quiz_embed'){
          const d = b.data || {};
          parts.push(`
<div class="summary-box">
  <div style="font-weight:900; margin-bottom:6px;">ëœë¤ í€´ì¦ˆ(ì„ë² ë“œ)</div>
  <div class="mini mono">examKey: ${escapeHtml(d.examKey||'')}</div>
  <div class="mini">â€» ë¸”ë¡œê·¸ì—ì„œ ì¹˜ì¦ˆ í€´ì¦ˆ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ë©´ ë™ì‘í•©ë‹ˆë‹¤.</div>
</div>`.trim());
          return;
        }

        parts.push(renderBlockToFinalHtml(b));
      });

      if (optSources){
        parts.push(`
<div class="sources">
  <div style="font-weight:900;">ì¶œì²˜</div>
  <ul>
    <li>ì˜ˆì‹œ ì¶œì²˜ 1</li>
    <li>ì˜ˆì‹œ ì¶œì²˜ 2</li>
  </ul>
</div>`.trim());
      }

      $('pvBody').innerHTML = wrapTemplate(templateId, title, parts.filter(Boolean).join('\n\n'));
      hydrateEmbeds();
    }

    function hydrateEmbeds(){
      const wraps = Array.from(document.querySelectorAll('[data-embed-id]'));
      wraps.forEach((wrap) => {
        const id = wrap.getAttribute('data-embed-id');
        const type = wrap.getAttribute('data-embed-type');
        const h = Number(wrap.getAttribute('data-embed-height')||320);
        const iframe = wrap.querySelector('iframe');
        if(!iframe) return;

        const b = state.blocks.find(x => x.id === id);
        if(!b) return;

        let snippet = '';
        if(type === 'flashcard') snippet = buildFlashcardSnippet(b);
        if(type === 'order_quiz') snippet = buildOrderQuizSnippet(b);

        iframe.style.height = h + 'px';
        iframe.srcdoc = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>body{margin:0;padding:10px;background:#fff;}</style>
</head>
<body>
${snippet}
</body>
</html>`.trim();
      });
    }

    function ensureSortable(){
      if (sortable) return;

      sortable = new Sortable(blockList, {
        animation: 150,
        draggable: '.block-item',
        handle: '.block-left',
        filter: '.icon-btn, button, a, input, textarea, select, label',
        preventOnFilter: false,
        forceFallback: true,
        fallbackOnBody: true,
        fallbackTolerance: 5,
        delayOnTouchOnly: true,
        delay: 150,
        touchStartThreshold: 5,
        onEnd: () => {
          const ids = Array.from(blockList.querySelectorAll('.block-item')).map(n => n.dataset.id);
          state.blocks = ids.map(id => state.blocks.find(b => b.id===id)).filter(Boolean);
          setTimeout(() => renderAll(), 0);
        }
      });
    }

    function renderBlockList(){
      if (sortable){ sortable.destroy(); sortable = null; }
      blockList.innerHTML = '';
      state.blocks.forEach((b, idx) => {
        const el = document.createElement('div');
        el.className = 'block-item' + (state.selectedId===b.id ? ' selected':'');
        el.dataset.id = b.id;

        el.innerHTML = `
<div class="block-left">
  <span class="badge">${blockLabel(b.type)}</span>
  <div style="min-width:0;">
    <div class="btitle" title="${escapeAttr(blockTitle(b))}">${escapeHtml(blockTitle(b))}</div>
    <div class="bmeta">#${idx+1} Â· ${escapeHtml(b.type)}</div>
  </div>
</div>
<div class="block-actions">
  <button class="icon-btn" data-act="up" title="ìœ„ë¡œ">â†‘</button>
  <button class="icon-btn" data-act="down" title="ì•„ë˜ë¡œ">â†“</button>
</div>`;

        el.addEventListener('click', (e) => {
          const act = e.target?.dataset?.act;
          if (act === 'up' || act === 'down'){
            e.stopPropagation();
            moveBlock(b.id, act==='up' ? -1 : 1);
            return;
          }
          selectBlock(b.id);
        });

        blockList.appendChild(el);
      });

      ensureSortable();
    }

    function moveBlock(id, delta){
      const i = state.blocks.findIndex(b => b.id===id);
      if (i < 0) return;
      const j = i + delta;
      if (j < 0 || j >= state.blocks.length) return;
      const tmp = state.blocks[i];
      state.blocks[i] = state.blocks[j];
      state.blocks[j] = tmp;
      renderAll();
    }

    function selectBlock(id){
      state.selectedId = id;
      renderBlockList();
      fillEditor();
      renderPreview();
    }

    function show(el, on){
      if(!el) return;
      el.style.display = on ? '' : 'none';
    }

    function fillEditor(){
      const b = currentBlock();
      show($('editorEmpty'), !b);
      show($('editorPanel'), !!b);
      if (!b) return;

      $('edType').value = b.type;
      $('edId').value = b.id;

      show($('edTitleWrap'), false);
      show($('edBodyWrap'), false);
      show($('edUrlWrap'), false);
      show($('edAdWrap'), false);
      show($('edFlashWrap'), false);
      show($('edOrderWrap'), false);
      show($('edQuizWrap'), false);

      if (b.type==='section' || b.type==='summary'){
        show($('edTitleWrap'), true);
        show($('edBodyWrap'), true);
        $('edTitle').value = b.data?.title || '';
        $('edBody').value  = b.data?.body || '';
      } else if (b.type==='image'){
        show($('edTitleWrap'), true);
        show($('edUrlWrap'), true);
        $('edTitle').value = b.data?.title || '';
        $('edUrl').value   = b.data?.url || '';
      } else if (b.type==='ad'){
        show($('edAdWrap'), true);
        $('edAdLabel').value = b.data?.label || '';
      } else if (b.type==='flashcard'){
        show($('edTitleWrap'), true);
        show($('edFlashWrap'), true);
        $('edTitle').value = b.data?.title || 'í”Œë˜ì‹œì¹´ë“œ';
      } else if (b.type==='order_quiz'){
        show($('edOrderWrap'), true);
        $('edOrderTitle').value = b.data?.title || '';
        $('edOrderSub').value = b.data?.sub || '';
        $('edOrderShuffle').checked = !!b.data?.shuffle;
        $('edOrderItems').value = (Array.isArray(b.data?.items) ? b.data.items : []).join('\n');
        $('edOrderAnswer').value = b.data?.answerNums || '';
      } else if (b.type==='quiz_embed'){
        show($('edQuizWrap'), true);
        $('edQuizKey').value = b.data?.examKey || '';
        $('edQuizTitle').value = b.data?.title || '';
        $('edQuizLimit').value = String(b.data?.limit || 5);
        $('edQuizPeriod').value = b.data?.period || '';
        $('edQuizTopic').value = b.data?.topic || '';
      }
    }

    function flashBlockToBulk(){
      const b = currentBlock();
      if(!b || b.type!=='flashcard') return;
      const cards = Array.isArray(b.data?.cards) ? b.data.cards : [];
      $('edFlashBulk').value = cards.map(c => `${c.front}\t${c.back}`).join('\n');
    }
    function flashBulkToBlock(){
      const b = currentBlock();
      if(!b || b.type!=='flashcard') return;

      const lines = String($('edFlashBulk').value||'').split(/\r?\n/);
      const cards = [];
      lines.forEach(line => {
        const t = line.trim();
        if(!t) return;

        let front='', back='';
        if(t.includes('\t')){
          const parts = t.split('\t');
          front = (parts[0]||'').trim();
          back  = parts.slice(1).join('\t').trim();
        }else if(t.includes('|')){
          const parts = t.split('|');
          front = (parts[0]||'').trim();
          back  = parts.slice(1).join('|').trim();
        }else{
          front = t;
          back = '';
        }
        if(front) cards.push({ front, back });
      });

      b.data.cards = cards.length ? cards : [{front:'ì•ë©´', back:'ë’·ë©´'}];
    }

    function renderAll(){
      renderBlockList();
      fillEditor();
      renderPreview();
    }

    function addBlock(b){
      state.blocks.push(b);
      state.selectedId = b.id;
      renderAll();
    }

    $('btnAddSection').addEventListener('click', () => addBlock(makeSection()));
    $('btnAddSummary').addEventListener('click', () => addBlock(makeSummary()));
    $('btnAddImage').addEventListener('click', () => addBlock(makeImage()));
    $('btnAddAd').addEventListener('click', () => addBlock(makeAd()));
    $('btnAddFlash').addEventListener('click', () => addBlock(makeFlash()));
    $('btnAddOrder').addEventListener('click', () => addBlock(makeOrder()));
    $('btnAddQuiz').addEventListener('click', () => addBlock(makeQuiz()));

    $('btnFlashFromBlock').addEventListener('click', flashBlockToBulk);
    $('btnFlashToBlock').addEventListener('click', () => { flashBulkToBlock(); renderAll(); });

    $('btnApplyBlock').addEventListener('click', () => {
      const b = currentBlock();
      if (!b) return;

      if (b.type==='section' || b.type==='summary'){
        b.data.title = $('edTitle').value.trim() || (b.type==='section' ? 'ì†Œì œëª©' : 'í•µì‹¬ ìš”ì•½');
        b.data.body  = $('edBody').value || '';
      } else if (b.type==='image'){
        b.data.title = $('edTitle').value.trim() || 'ì´ë¯¸ì§€';
        b.data.url   = $('edUrl').value.trim() || 'https://picsum.photos/800/420';
        b.data.alt   = b.data.title;
      } else if (b.type==='ad'){
        b.data.label = $('edAdLabel').value.trim() || 'ê´‘ê³ ';
      } else if (b.type==='flashcard'){
        b.data.title = $('edTitle').value.trim() || 'í”Œë˜ì‹œì¹´ë“œ';
        flashBulkToBlock();
      } else if (b.type==='order_quiz'){
        const items = String($('edOrderItems').value||'')
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean);

        if(items.length < 2){
          alert('ë“œë˜ê·¸ ìˆœì„œ í•­ëª©ì€ ìµœì†Œ 2ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }

        const parsed = parseOrderNums($('edOrderAnswer').value, items.length);
        if(parsed && parsed.ok === false){
          alert(parsed.msg);
          return;
        }

        b.data.title = $('edOrderTitle').value.trim() || 'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!';
        b.data.sub = $('edOrderSub').value.trim();
        b.data.shuffle = $('edOrderShuffle').checked;
        b.data.items = items;
        b.data.answerNums = $('edOrderAnswer').value.trim();
      } else if (b.type==='quiz_embed'){
        const examKey = $('edQuizKey').value.trim();
        if(!examKey){
          alert('examKeyëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }
        b.data.examKey = examKey;
        b.data.title = $('edQuizTitle').value.trim() || 'ì—°ìŠµë¬¸ì œ';
        b.data.limit = Math.max(1, Number($('edQuizLimit').value||5) || 5);
        b.data.period = $('edQuizPeriod').value.trim();
        b.data.topic = $('edQuizTopic').value.trim();
      }

      renderAll();
    });

    $('btnDeleteBlock').addEventListener('click', () => {
      const b = currentBlock();
      if (!b) return;
      state.blocks = state.blocks.filter(x => x.id !== b.id);
      state.selectedId = null;
      renderAll();
    });

    $('templateSelect').addEventListener('change', renderPreview);
    $('optTOC').addEventListener('change', renderPreview);
    $('optSources').addEventListener('change', renderPreview);
    $('postTitle').addEventListener('input', renderPreview);

    $('btnCopyHtml').addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText($('finalHtml').value || '');
        alert('HTML ë³µì‚¬ ì™„ë£Œ');
      }catch(e){
        alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)');
      }
    });

    $('btnDownloadHtml').addEventListener('click', () => {
      const html = $('finalHtml').value || '';
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'post_content_html.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    $('btnReset').addEventListener('click', initDemo);

    /************************************************************
     * âœ… DB Load Modal (listPosts / getPost)
     *  - listPosts: ëª©ë¡ ì¡°íšŒ
     *  - getPost  : ë‹¨ê±´ ë¡œë“œ
     ************************************************************/
    const loadModalBackdrop = $('loadModalBackdrop');
    const postCardsEl = $('postCards');
    const loadSearchEl = $('loadSearch');
    const loadStatusEl = $('loadStatus');
    const loadErrorEl = $('loadError');
    const btnLoadMore = $('btnLoadMorePosts');
    
    let _dbPostListCache = [];       // ì „ì²´ ëª©ë¡ ìºì‹œ
    let _dbNextPageToken = '';       // í˜ì´ì§• í† í°(ìˆì„ ë•Œë§Œ)
    let _dbLoading = false;
    
    function safeJsonParse_(v){
      try{
        if (v == null) return null;
        if (typeof v === 'object') return v;
        const s = String(v).trim();
        if (!s) return null;
        return JSON.parse(s);
      }catch(e){
        return null;
      }
    }
    
    function showLoadError_(msg){
      if (!loadErrorEl) return;
      loadErrorEl.style.display = msg ? '' : 'none';
      loadErrorEl.textContent = msg || '';
    }
    function setLoadStatus_(msg){
      if (!loadStatusEl) return;
      loadStatusEl.textContent = msg || '';
    }
    
    function openLoadModal_(){
      if (!loadModalBackdrop) return;
      loadModalBackdrop.classList.add('on');
      loadModalBackdrop.setAttribute('aria-hidden','false');
      showLoadError_('');
      setLoadStatus_('ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      // ì—´ìë§ˆì ëª©ë¡ ë¡œë“œ
      fetchPostList_({ reset:true }).catch((e)=>{
        showLoadError_('ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message || e));
        setLoadStatus_('');
      });
      // í¬ì»¤ìŠ¤
      setTimeout(()=>{ loadSearchEl?.focus?.(); }, 0);
    }
    
    function closeLoadModal_(){
      if (!loadModalBackdrop) return;
      loadModalBackdrop.classList.remove('on');
      loadModalBackdrop.setAttribute('aria-hidden','true');
    }
    
    function normalizeListItems_(data){
      const items = data?.items || data?.posts || data?.list || data?.data || [];
      if (!Array.isArray(items)) return [];
      return items.map((x)=>({
        post_id: x.post_id || x.postId || x.id || '',
        title: x.title || x.post_title || '(ì œëª© ì—†ìŒ)',
        template_id: x.template_id || x.templateId || x.template || 'default',
        updated_at: x.updated_at || x.updatedAt || x.modified_at || x.modifiedAt || '',
      })).filter(x => x.post_id);
    }
    
    function formatDate_(s){
      const t = String(s||'').trim();
      if (!t) return '-';
      // ISOë©´ ì§§ê²Œ
      if (t.includes('T')) return t.replace('T',' ').slice(0,16);
      return t;
    }
    
    function renderPostCards_(items){
      if (!postCardsEl) return;
    
      const q = String(loadSearchEl?.value || '').trim().toLowerCase();
      const filtered = q
        ? items.filter(it =>
            String(it.title||'').toLowerCase().includes(q) ||
            String(it.post_id||'').toLowerCase().includes(q)
          )
        : items;
    
      postCardsEl.innerHTML = '';
      if (!filtered.length){
        postCardsEl.innerHTML = `<div class="mini" style="padding:10px; color:var(--muted);">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
    
      filtered.forEach((it)=>{
        const card = document.createElement('div');
        card.className = 'post-card';
        card.dataset.postId = it.post_id;
    
        card.innerHTML = `
          <div class="pill"><span class="mono">${escapeHtml(it.post_id)}</span> Â· ${escapeHtml(it.template_id)}</div>
          <div class="t">${escapeHtml(it.title || '(ì œëª© ì—†ìŒ)')}</div>
          <div class="meta">
            <div>updated: <span class="mono">${escapeHtml(formatDate_(it.updated_at))}</span></div>
          </div>
        `;
        card.addEventListener('click', async ()=>{
          await loadPostById_(it.post_id);
        });
        postCardsEl.appendChild(card);
      });
    }
    
    async function callAppsScriptFlex_(apiBase, mode, params={}, methods=['GET','POST']){
      let lastErr = null;
    
      for (const method of methods){
        try{
          // URL ë§Œë“¤ê¸°
          const urlObj = new URL(apiBase);
          urlObj.searchParams.set('mode', mode);
    
          const p = new URLSearchParams();
          Object.entries(params || {}).forEach(([k, v])=>{
            if (v === undefined || v === null) return;
            if (typeof v === 'object') p.set(k, JSON.stringify(v));
            else p.set(k, String(v));
          });
    
          let res, txt;
    
          if (method === 'GET'){
            // GETì€ queryë¡œ íŒŒë¼ë¯¸í„° ë¶€ì°©
            p.forEach((val, key)=> urlObj.searchParams.set(key, val));
            res = await fetch(urlObj.toString(), { method:'GET' });
            txt = await res.text();
          }else{
            // POSTëŠ” form-urlencoded
            res = await fetch(urlObj.toString(), {
              method:'POST',
              headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
              body: p.toString(),
            });
            txt = await res.text();
          }
    
          let data = null;
          try{ data = JSON.parse(txt); }catch(e){}
    
          if (!res.ok){
            throw new Error((data && (data.message || data.error)) || txt || ('HTTP ' + res.status));
          }
          return data || { ok:true, raw: txt };
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error('API call failed');
    }
    
    async function fetchPostList_({ reset=false } = {}){
      if (_dbLoading) return;
      _dbLoading = true;
      showLoadError_('');
    
      try{
        const cfg = getPublishConfig_ ? getPublishConfig_() : { api_base:'' };
        const apiBase = (cfg?.api_base || getApiBase_?.() || '').trim();
    
        if (!apiBase){
          throw new Error('API Baseê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. (ë°œí–‰ API ì„¤ì •ì˜ API Baseì— ì…ë ¥í•˜ê±°ë‚˜ window.CHEESE_ADMIN_API_BASE ë¥¼ ì„¸íŒ…í•˜ì„¸ìš”)');
        }
    
        if (reset){
          _dbPostListCache = [];
          _dbNextPageToken = '';
          btnLoadMore.style.display = 'none';
        }
    
        setLoadStatus_('ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
        // ì„œë²„ê°€ pageTokenì„ ì§€ì›í•˜ë©´ ê°™ì´ ë³´ëƒ„(ì—†ì–´ë„ ë¬´ì‹œë  ê²ƒ)
        const params = {};
        if (!reset && _dbNextPageToken) params.page_token = _dbNextPageToken;
    
        // âœ… listPosts ìš°ì„ , ë§Œì•½ ì„œë²„ì—ì„œ ë‹¤ë¥¸ ì´ë¦„ì´ë©´ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨
        const data = await callAppsScriptFlex_(apiBase, 'listPosts', params, ['GET','POST']);
    
        if (!data || data.ok === false){
          throw new Error(data?.message || data?.error || 'ì‘ë‹µì€ ë°›ì•˜ì§€ë§Œ okê°€ ì•„ë‹™ë‹ˆë‹¤');
        }
    
        const items = normalizeListItems_(data);
        _dbPostListCache = _dbPostListCache.concat(items);
    
        // í˜ì´ì§• í† í°(ìˆìœ¼ë©´ ë” ë³´ê¸° ë²„íŠ¼ ë…¸ì¶œ)
        _dbNextPageToken = data.next_page_token || data.nextPageToken || '';
        btnLoadMore.style.display = _dbNextPageToken ? '' : 'none';
    
        setLoadStatus_(`ì´ ${_dbPostListCache.length}ê±´`);
        renderPostCards_(_dbPostListCache);
      }finally{
        _dbLoading = false;
      }
    }
    
    function normalizePost_(data){
      const p = data?.post || data || {};
    
      // blocks_json: ë°°ì—´/ë¬¸ìì—´(JSON)/ì—†ìŒ ëª¨ë‘ ëŒ€ì‘
      let blocks = (p.blocks_json ?? p.blocks ?? []);
      if (typeof blocks === 'string') blocks = safeJsonParse_(blocks) || [];
      if (!Array.isArray(blocks)) blocks = [];
    
      // options_json: ê°ì²´/ë¬¸ìì—´(JSON)/ì—†ìŒ ëª¨ë‘ ëŒ€ì‘
      let opt = (p.options_json ?? p.options ?? {});
      if (typeof opt === 'string') opt = safeJsonParse_(opt) || {};
      if (!opt || typeof opt !== 'object') opt = {};
    
      return {
        post_id: String(p.post_id || ''),
        title: String(p.title || ''),
        intro: String(p.intro || ''),
        template_id: String(p.template_id || p.templateId || 'default'),
        options_json: opt,
        blocks_json: blocks,
    
        // ì„œë²„ í•„ë“œëª…(body)ë„ ì½ì–´ì˜¤ë„ë¡ ë³´ê°•
        content_html: String(p.body || p.content_html || p.html || ''),
    
        updated_at: p.updated_at || '',
        status: String(p.status || ''),
        blogger_post_id: String(p.blogger_post_id || ''),
        blogger_url: String(p.blogger_url || '')
      };
    }
    
    function setCurrentPostId_(postId){
      state.postId = postId || '';
      const curEl = $('curPostId');
      if (curEl) curEl.textContent = 'post_id: ' + (state.postId ? state.postId : '(new)');
    
      // ë°œí–‰ ì˜ì—­ post_idì—ë„ ìë™ ë°˜ì˜
      const pubPid = $('pubPostId');
      if (pubPid && state.postId) pubPid.value = state.postId;
    }
    
    async function loadPostById_(postId){
      showLoadError_('');
      setLoadStatus_('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
      try{
        const cfg = getPublishConfig_ ? getPublishConfig_() : { api_base:'' };
        const apiBase = (cfg?.api_base || getApiBase_?.() || '').trim();
        if (!apiBase) throw new Error('API Baseê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    
        const data = await callAppsScriptFlex_(apiBase, 'getPost', { post_id: postId }, ['GET','POST']);
    
        if (!data || data.ok === false){
          throw new Error(data?.message || data?.error || 'ì‘ë‹µì€ ë°›ì•˜ì§€ë§Œ okê°€ ì•„ë‹™ë‹ˆë‹¤');
        }
    
        const p = normalizePost_(data);
    
        // âœ… í™”ë©´ ë³µì›
        $('postTitle').value = p.title || '';
      $('postIntro').value = p.intro || '';
      state.lastLoadedBody = String(p.content_html || '');
      state.options = p.options_json || {};
        $('templateSelect').value = p.template_id || 'default';
        $('optTOC').checked = !!((state.options && state.options.toc) ?? true);
        $('optSources').checked = !!((state.options && state.options.sources) ?? false);
state.blocks = Array.isArray(p.blocks_json) ? p.blocks_json : [];
        state.selectedId = state.blocks[0]?.id || null;
    
        setCurrentPostId_(p.post_id || postId);
    
        renderAll();
        closeLoadModal_();
        setPublishMsg_?.('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ', true);
      }catch(e){
        showLoadError_('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (e?.message || e));
        setLoadStatus_('');
        console.error(e);
      }
    }
    
    /* âœ… ë¡œì»¬ ì„ì‹œ ì €ì¥ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°(ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) */
    function loadFromLocalDraft_(){
      const raw = localStorage.getItem('post_builder_draft');
      if (!raw){ alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
      const p = JSON.parse(raw);
    
      $('postTitle').value = p.title || '';
      $('postIntro').value = p.intro || '';
      state.lastLoadedBody = String(p.content_html || '');
      state.options = p.options_json || {};
      $('templateSelect').value = p.template_id || 'default';
      $('optTOC').checked = !!(p.options_json && p.options_json.toc);
$('optSources').checked = !!(p.options_json && p.options_json.sources);
state.blocks = Array.isArray(p.blocks_json) ? p.blocks_json : [];
      state.selectedId = state.blocks[0]?.id || null;
    
      // ë¡œì»¬ì€ post_idê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ new ì²˜ë¦¬
      setCurrentPostId_('');
      renderAll();
      closeLoadModal_();
    }
    
    /* ===========================
       âœ… ëª¨ë‹¬ UI ë°”ì¸ë”©
       =========================== */
    $('btnCloseLoadModal')?.addEventListener('click', closeLoadModal_);
    loadModalBackdrop?.addEventListener('click', (e)=>{
      // ë°°ê²½ í´ë¦­ë§Œ ë‹«ê¸°(ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ì€ ë¬´ì‹œ)
      if (e.target === loadModalBackdrop) closeLoadModal_();
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && loadModalBackdrop?.classList.contains('on')) closeLoadModal_();
    });
    
    $('btnRefreshPosts')?.addEventListener('click', ()=> fetchPostList_({ reset:true }));
    $('btnLoadMorePosts')?.addEventListener('click', ()=> fetchPostList_({ reset:false }));
    $('btnLoadLocalDraft')?.addEventListener('click', loadFromLocalDraft_);
    
    loadSearchEl?.addEventListener('input', ()=>{
      renderPostCards_(_dbPostListCache);
    });


    
    /************************************************************
     * âœ… Blog Publish + DB Save (Apps Script ì—°ë™)
     ************************************************************/
    const LS_PUBCFG = 'post_builder_publish_cfg_v1';

    function getPublishConfig_(){
      let saved = {};
      try{ saved = JSON.parse(localStorage.getItem(LS_PUBCFG) || '{}') || {}; }catch(e){}

      const uiBase = (($('pubApiBase')?.value) || '').trim();
      const uiMode = (($('pubMode')?.value) || '').trim();

      const phBase = (($('pubApiBase')?.getAttribute('placeholder')) || '').trim();
      const apiBase = (uiBase || saved.api_base || window.CHEESE_BLOG_API_BASE || window.CHEESE_ADMIN_API_BASE || phBase || '').trim();
      const mode = (uiMode || saved.mode_publish || 'publishPost').trim();
      return { api_base: apiBase, mode_publish: mode };
    }

    // âœ… ì €ì¥/ì¡°íšŒë„ ê°™ì€ api_baseë¥¼ ì“°ë„ë¡ ê³µìš© base getter
    function getApiBase_(){
      const cfg = getPublishConfig_();
      if (cfg?.api_base) return cfg.api_base;

      const phBase = (($('pubApiBase')?.getAttribute('placeholder')) || '').trim();
      return (window.CHEESE_BLOG_API_BASE || window.CHEESE_ADMIN_API_BASE || phBase || '').trim();
    }

    function applyPublishConfigToUI_(){
      const cfg = getPublishConfig_();
      const baseEl = $('pubApiBase');
      const modeEl = $('pubMode');
      if (baseEl) baseEl.value = cfg.api_base || '';
      if (modeEl) modeEl.value = cfg.mode_publish || 'publishPost';
    }

    function savePublishConfigFromUI_(){
      const base = ($('pubApiBase')?.value || '').trim();
      const mode = ($('pubMode')?.value || '').trim() || 'publishPost';
      const payload = { api_base: base, mode_publish: mode };
      localStorage.setItem(LS_PUBCFG, JSON.stringify(payload));
      setPublishMsg_('ì„¤ì • ì €ì¥ ì™„ë£Œ', true);
      applyPublishConfigToUI_();
      refreshNextPostId_(); // âœ… baseê°€ í™•ì •ë˜ë©´ next ê°±ì‹ 
    }

    function resetPublishConfig_(){
      localStorage.removeItem(LS_PUBCFG);
      setPublishMsg_('ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ', true);
      applyPublishConfigToUI_();
      refreshNextPostId_();
    }

    function setPublishMsg_(msg, ok=false){
      const el = $('publishMsg');
      if (!el) return;
      el.textContent = msg || '';
      el.style.color = ok ? 'rgba(22,163,74,1)' : 'rgba(239,68,68,1)';
      if (!msg) el.style.color = '';
      if (!msg){
        el.onclick = null;
        el.style.cursor = '';
        el.title = '';
      }
    }

    function refreshCurPostId_(){
      const cur = (state.postId || '').trim();
      const el = $('curPostId');
      if (el) el.textContent = 'post_id: ' + (cur ? cur : '(new)');

      // âœ… ë°œí–‰ ì…ë ¥ì¹¸ë„ ê°™ì´ ë™ê¸°í™”
      if ($('pubPostId')) $('pubPostId').value = cur;
    }

    async function postToAppsScript_(apiBase, mode, payload){
      const url = mode
        ? (apiBase + (apiBase.includes('?') ? '&' : '?') + 'mode=' + encodeURIComponent(mode))
        : apiBase;

      const form = new URLSearchParams();
      Object.entries(payload || {}).forEach(([k, v]) => {
        if (v === undefined || v === null) return;
        if (typeof v === 'object') form.set(k, JSON.stringify(v));
        else form.set(k, String(v));
      });

      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString(),
      });

      const txt = await res.text();
      let data = null;
      try{ data = JSON.parse(txt); }catch(e){}
      if (!res.ok) throw new Error((data && (data.message || data.error)) || txt || ('HTTP ' + res.status));
      return data || { ok:true, raw: txt };
    }

    // âœ… ë‹¤ìŒ post_id í‘œì‹œ (Apps Script: mode=getNextPostId í•„ìš”)
    async function refreshNextPostId_(){
      const apiBase = getApiBase_();
      const el = $('nextPostId');

      if (!apiBase){
        if (el) el.textContent = 'next: -';
        return;
      }
      try{
        // ì„œë²„ëŠ” doPost + e.parameter ê¸°ë°˜ì´ë¯€ë¡œ postë¡œ í˜¸ì¶œ
        const data = await postToAppsScript_(apiBase, 'getNextPostId', {});
        const nextId = (data?.next_post_id || '').trim() || '-';
        if (el) el.textContent = 'next: ' + nextId;
      }catch(e){
        if (el) el.textContent = 'next: (error)';
      }
    }

    // âœ… DB ì €ì¥: Apps Script mode=savePost ë¡œ ì‹¤ì œ ì €ì¥
    
    // âœ… ì €ì¥ ì „ì— finalHtmlì„ ìµœì‹  ìƒíƒœë¡œ ê°±ì‹ 
    function updateFinalHtml_(){
      // âœ… ì˜µì…˜ ì²´í¬ë°•ìŠ¤ ê°’ë„ stateë¡œ ë™ê¸°í™” (DB ì €ì¥ìš©)
      state.options = { toc: $('optTOC').checked, sources: $('optSources').checked };
      // renderPreview() ë‚´ë¶€ì—ì„œ finalHtml textareaë¥¼ ê°±ì‹ í•¨
      renderPreview();
    }

async function saveToDb_(){
      try{
        const cfg = getPublishConfig_();
        const apiBase = (cfg?.api_base || getApiBase_?.() || '').trim();
        if (!apiBase) throw new Error('API Baseê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    
        // ìµœì‹  ë¯¸ë¦¬ë³´ê¸° HTML ê°±ì‹ 
        updateFinalHtml_();
    
        const payload = {
          post_id: state.postId || '',
          title: $('postTitle').value.trim(),
        intro: $('postIntro').value.trim(),
    
          // âœ… ë¸”ë¡ ê¸°ë°˜ í¸ì§‘ ë³µì›ìš©
          template_id: $('templateSelect').value || 'default',
          options_json: state.options || {},      // ê°ì²´ë¡œ ë³´ë‚´ë„ callAppsScriptFlex_ê°€ JSON.stringify í•´ì¤Œ
          blocks_json: state.blocks || [],        // ë°°ì—´ë¡œ ë³´ë‚´ë„ stringify ë¨
    
          // âœ… ìµœì¢… ë°œí–‰/ë¯¸ë¦¬ë³´ê¸°ìš© HTML (ë°±ì—… ê²¸)
          body: $('finalHtml').value || ''
        };
    
        const data = await callAppsScriptFlex_(apiBase, 'savePost', payload, ['POST','GET']);
        if (!data || data.ok === false) throw new Error(data?.message || 'ì €ì¥ ì‹¤íŒ¨');
    
        // post_id ê°±ì‹ 
        if (data.post_id) state.postId = String(data.post_id);
        toast_('DB ì €ì¥ ì™„ë£Œ');
      }catch(e){
        alert('DB ì €ì¥ ì‹¤íŒ¨: ' + (e?.message || e));
      }
    }


    async function publishToBlog_(){
      const cfg = getPublishConfig_();
      if (!cfg.api_base){
        alert('API Baseê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. (ë°œí–‰ API ì„¤ì •ì—ì„œ ì…ë ¥í•˜ê±°ë‚˜ window.CHEESE_BLOG_API_BASE / window.CHEESE_ADMIN_API_BASE ë¥¼ ì„¸íŒ…í•˜ì„¸ìš”)');
        return;
      }

      const mode = (cfg.mode_publish || 'publishPost').trim() || 'publishPost';

      // âœ… state.postId ìš°ì„  ì‚¬ìš© (ì…ë ¥ì¹¸ë³´ë‹¤ ì•ˆì „)
      const postId = (state.postId || ($('pubPostId')?.value || '')).trim();
      if (!postId){
        alert('ë¨¼ì € "DB ì €ì¥"ì„ ëˆŒëŸ¬ post_idë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const isDraft = ($('publishState')?.value || 'draft') === 'draft';
      const blogUrl = ($('pubBlogUrl')?.value || '').trim();
      const blogId  = ($('pubBlogId')?.value || '').trim();

      if (!blogId && !blogUrl){
        alert('blogUrl ë˜ëŠ” blogIdê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì˜ˆ: https://cheesetestblog.blogspot.com/');
        return;
      }

      const payload = { post_id: postId, isDraft: isDraft };
      if (blogId) payload.blogId = blogId;
      if (blogUrl) payload.blogUrl = blogUrl;

      const confirmMsg = isDraft ? 'ì´ˆì•ˆ(ë¹„ê³µê°œ)ìœ¼ë¡œ ë¸”ë¡œê·¸ì— ë°œí–‰í• ê¹Œìš”?' : 'ê³µê°œ ê¸€ë¡œ ë¸”ë¡œê·¸ì— ë°œí–‰í• ê¹Œìš”?';
      if (!confirm(confirmMsg)) return;

      setPublishMsg_('ë°œí–‰ ì¤‘...', true);

      try{
        const data = await postToAppsScript_(cfg.api_base, mode, payload);
        if (!data || data.ok === false){
          throw new Error(data?.message || data?.error || 'ì‘ë‹µì€ ë°›ì•˜ì§€ë§Œ okê°€ ì•„ë‹™ë‹ˆë‹¤');
        }

        const url = data.url || data.blogger_url || '';
        const bloggerPostId = data.blogger_post_id || data.id || '';

        if (url){
          setPublishMsg_('ë°œí–‰ ì™„ë£Œ Â· ë§í¬ ì—´ê¸°', true);
          const msgEl = $('publishMsg');
          if (msgEl){
            msgEl.style.cursor = 'pointer';
            msgEl.onclick = () => window.open(url, '_blank', 'noopener');
            msgEl.title = url;
          }
        }else{
          setPublishMsg_('ë°œí–‰ ì™„ë£Œ' + (bloggerPostId ? (' Â· blogger_post_id: ' + bloggerPostId) : ''), true);
        }

        try{
          const last = { post_id: postId, blogger_post_id: bloggerPostId, url, isDraft, at: new Date().toISOString() };
          localStorage.setItem('post_builder_last_publish', JSON.stringify(last));
        }catch(e){}
      }catch(err){
        console.error(err);
        setPublishMsg_('ë°œí–‰ ì‹¤íŒ¨: ' + (err?.message || String(err)), false);
        alert('ë°œí–‰ ì‹¤íŒ¨\n' + (err?.message || err));
      }
    }

    // UI ë°”ì¸ë”©
    $('btnPublish')?.addEventListener('click', publishToBlog_);
    $('btnSavePubConfig')?.addEventListener('click', savePublishConfigFromUI_);
    $('btnResetPubConfig')?.addEventListener('click', resetPublishConfig_);

    // âœ… DB ì €ì¥ ë²„íŠ¼ì€ Apps Script ì €ì¥ìœ¼ë¡œ ì—°ê²°
    $('btnSave')?.addEventListener('click', saveToDb_);

    // âœ… ë¶ˆëŸ¬ì˜¤ê¸° (DB ëª©ë¡ ëª¨ë‹¬ ì—´ê¸°)
    $('btnLoad')?.addEventListener('click', openLoadModal_);
    
    // âœ… (ì„ íƒ) ë¡œì»¬ ì„ì‹œì €ì¥ìš©: ìœ ì§€í•˜ë˜ ë²„íŠ¼ì€ ì—†ìœ¼ë‹ˆ ë‹¨ì¶•í‚¤ ë“±ìœ¼ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´ ì—°ê²° ê°€ëŠ¥
    function saveLocalDraft_(){
      const payload = {
        title: $('postTitle').value.trim(),
        intro: $('postIntro').value.trim(),
        template_id: $('templateSelect').value,
        options: { toc: $('optTOC').checked, sources: $('optSources').checked },
        blocks_json: JSON.parse(JSON.stringify(state.blocks)),
        content_html: $('finalHtml').value
      };
      localStorage.setItem('post_builder_draft', JSON.stringify(payload));
    }


    // âœ… (ì„ íƒ) ë¡œì»¬ ì„ì‹œì €ì¥ìš©: ìœ ì§€í•˜ë˜ ë²„íŠ¼ì€ ì—†ìœ¼ë‹ˆ ë‹¨ì¶•í‚¤ ë“±ìœ¼ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´ ì—°ê²° ê°€ëŠ¥
    function saveLocalDraft_(){
      const payload = {
        title: $('postTitle').value.trim(),
        intro: $('postIntro').value.trim(),
        template_id: $('templateSelect').value,
        options: { toc: $('optTOC').checked, sources: $('optSources').checked },
        blocks_json: JSON.parse(JSON.stringify(state.blocks)),
        content_html: $('finalHtml').value
      };
      localStorage.setItem('post_builder_draft', JSON.stringify(payload));
    }

    /************************************************************
     * âœ… Demo Init
     ************************************************************/
    function initDemo(){
      $('postTitle').value = 'ê¹€êµ¬, ì„ì‹œì •ë¶€ì˜ ì¤‘ì‹¬ì— ì„  ì´ìœ ';
      $('templateSelect').value = 'profile';
      $('optTOC').checked = true;
      $('optSources').checked = true;

      // âœ… ë°ëª¨ ì´ˆê¸°í™” ì‹œì—ëŠ” ìƒˆ ê¸€ë¡œ ì·¨ê¸‰(í•„ìš”í•˜ë©´ ìœ ì§€í•˜ë„ë¡ ë°”ê¿€ ìˆ˜ ìˆìŒ)
      state.postId = '';
      refreshCurPostId_();

      state.blocks = [
        { id: uid(), type:'summary', data:{ title:'í•µì‹¬ ìš”ì•½', body:'- ê¹€êµ¬ì˜ ì •ì¹˜ì  ì¤‘ì‹¬ì„±\n- ì„ì‹œì •ë¶€ì˜ ì •í†µì„± ë…¼ìŸ\n- í•´ë°© ì´í›„ì˜ ì—­í• ê³¼ í•œê³„' } },
        { id: uid(), type:'section', data:{ title:'1. ìƒí•´ ì„ì‹œì •ë¶€ì˜ êµ¬ì‹¬ì ', body:'ê¹€êµ¬ëŠ” ì„ì‹œì •ë¶€ ë‚´ì—ì„œ ì¡°ì§ ìš´ì˜ê³¼ ëŒ€ì™¸ í™œë™ì„ ì¡°ìœ¨í–ˆë‹¤.\n\níŠ¹íˆ ë…ë¦½ìš´ë™ ë…¸ì„ ê³¼ ìê¸ˆ ë¬¸ì œì—ì„œ ì˜í–¥ë ¥ì„ ê°€ì¡Œë‹¤.' } },
        makeFlash(),
        { id: uid(), type:'ad', data:{ label:'ë°°ë„ˆ A' } },
        makeOrder(),
        { id: uid(), type:'image', data:{ title:'ê´€ë ¨ ì´ë¯¸ì§€', url:'https://picsum.photos/900/480', alt:'ê´€ë ¨ ì´ë¯¸ì§€' } },
        makeQuiz(),
        { id: uid(), type:'section', data:{ title:'2. ë…ë¦½ìš´ë™ ë…¸ì„ ê³¼ ì •í†µì„±', body:'ë¬´ì¥ íˆ¬ìŸÂ·ì™¸êµ ë…¸ì„ ì˜ ê· í˜• ì†ì—ì„œ ë‚´ë¶€ ê°ˆë“±ì´ ë°˜ë³µëë‹¤.\nê¹€êµ¬ëŠ” í†µí•©ì„ ê°•ì¡°í–ˆì§€ë§Œ, ë…¸ì„  ì°¨ì´ëŠ” ì§€ì†ëë‹¤.' } },
      ];

      state.selectedId = state.blocks[0]?.id || null;
      renderAll();

      const fc = state.blocks.find(x => x.type==='flashcard');
      if(fc){
        state.selectedId = fc.id;
        renderAll();
        flashBlockToBulk();
      }

      // âœ… demo ë¡œë“œ í›„ next í‘œì‹œ ê°±ì‹ 
      refreshNextPostId_();
    }

    initDemo();
    applyPublishConfigToUI_();
    refreshCurPostId_();
    refreshNextPostId_();

  </script>
</body>
</html>
