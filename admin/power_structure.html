<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì •êµ­ êµ¬ë„ ì‹œê°í™” ë„êµ¬</title>
  
  <link rel="stylesheet" href="./admin.css" />
  
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    .admin-content { background-color: #f1f5f9; }
    /* ìº¡ì²˜ ì‹œ ë°°ê²½ ìŠ¤íƒ€ì¼ í™•ë³´ìš© */
    #viz-container-box { background-color: #ffffff; }
    /* ë²„ì „ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .pm-pill { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(15,23,42,0.15); font-size: 12px; margin-left: 8px; }
  </style>
</head>
<body>

  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      <main class="admin-content">
        
        <div id="dynamic-power-app" style="max-width: 1100px; margin: 0 auto; padding: 30px; border-radius: 32px; font-family: 'Pretendard', sans-serif; box-shadow: 0 20px 50px rgba(0,0,0,0.05); border: 1px solid #ffffff; background: #f9fbff;">
          
          <div style="background: #fff; padding: 25px; border-radius: 24px; margin-bottom: 30px; border: 1px solid #f2f4f6;">
            <div style="display:flex; align-items:center; justify-content:center; margin-bottom: 20px; flex-wrap:wrap; position:relative;">
              <div style="font-weight: 800; color: #1a1f27; font-size: 1.1em;">âš™ï¸ ì •êµ­ êµ¬ë„ ê´€ë¦¬ (ìƒ‰ìƒÂ·ì´ë¦„Â·ì‚­ì œ)</div>
              <span id="sysVersion" class="pm-pill" style="background:#f1f5f9; color:#64748b; font-family:monospace; margin-left:auto; position:absolute; right:0;">Checking...</span>
            </div>
            
            <div id="controls-wrapper" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px;"></div>
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #f2f4f6; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
              <button onclick="createNewFaction()" style="padding: 12px 20px; background: #1a1f27; color: #fff; border: none; border-radius: 14px; cursor: pointer; font-weight: 700;">+ ì„¸ë ¥ ì¶”ê°€</button>
              <button onclick="createAlliance()" style="padding: 12px 20px; background: #3182f6; color: #fff; border: none; border-radius: 14px; cursor: pointer; font-weight: 700;">ğŸ¤ ë™ë§¹ ê²°ì„±</button>
              <button onclick="createVs()" style="padding: 12px 20px; background: #f04452; color: #fff; border: none; border-radius: 14px; cursor: pointer; font-weight: 700;">âš”ï¸ ëŒ€ë¦½ ì„¤ì • (VS)</button>
              <button onclick="resetAll()" style="padding: 12px 20px; background: #fff; color: #666; border: 1px solid #dbdee2; border-radius: 14px; cursor: pointer; font-weight: 700;">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
              <button onclick="saveAsImage()" style="padding: 12px 20px; background: #00c471; color: #fff; border: none; border-radius: 14px; cursor: pointer; font-weight: 700; margin-left: 10px; display: flex; align-items: center; gap: 5px;"><span>ğŸ“¸</span> ê²°ê³¼ë§Œ ì´ë¯¸ì§€ ì €ì¥</button>
            </div>
          </div>
        
          <div id="viz-container-box" style="position: relative; min-height: 500px; width: 100%; background: #ffffff; border-radius: 28px; border: 1px solid #f2f4f6; padding: 80px 20px; overflow-x: auto;">
            <div id="viz-wrapper" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; align-items: center; width: max-content; min-width: 100%; margin: auto;"></div>
          </div>
        </div>

      </main>
    </div>
  </div>

<script src="./admin-common.js"></script>

  <script>
    (function(){
      try {
        if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
          window.AdminCommon.renderShell({
            headerSlotId: "admin-header-slot",
            menuSlotId: "admin-menu-slot",
            activeMenu: "power_structure"
          });
        }
      } catch(e) { console.error("Admin Shell Error:", e); }
    })();
  </script>

  <script>
    /** * [ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥] 
     * - í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ë°°ì¹˜(2ë‹¨ ë°°ì—´) ê·¸ëŒ€ë¡œ ê¹”ë”í•˜ê²Œ ì €ì¥
     */
    function saveAsImage() {
      const target = document.querySelector("#viz-wrapper");
      if (!target) return alert("ìº¡ì²˜ ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      
      html2canvas(target, {
        scale: 3, // ê³ í™”ì§ˆ
        backgroundColor: "#ffffff",
        useCORS: true,
        // ìº¡ì²˜ ì‹œ ìŠ¤íƒ€ì¼ ë‹¤ë“¬ê¸°
        onclone: (clonedDoc) => {
            const el = clonedDoc.querySelector("#viz-wrapper");
            if (el) {
                // í™”ë©´ê³¼ ë™ì¼í•˜ê²Œ 100% í­ ìœ ì§€ (ì¤„ë°”ê¿ˆ ìœ ì§€)
                el.style.width = "100%";
                el.style.minWidth = "auto";
                el.style.height = "auto";
                el.style.margin = "0";
                el.style.padding = "50px"; // ì´ë¯¸ì§€ ì—¬ë°±
                el.style.backgroundColor = "#ffffff";
                
                // ìº¡ì²˜ ì‹œ ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€
                el.style.display = "flex";
                el.style.flexWrap = "wrap";
                el.style.justifyContent = "center";
                el.style.alignItems = "flex-start"; // ìƒë‹¨ ì •ë ¬
            }
        }
      }).then(canvas => {
        const link = document.createElement("a");
        const d = new Date();
        const z = n => (n < 10 ? "0"+n : String(n));
        const ts = d.getFullYear() + z(d.getMonth()+1) + z(d.getDate()) + "_" + z(d.getHours()) + z(d.getMinutes());
        
        link.download = "ì •êµ­êµ¬ë„_" + ts + ".png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(err => {
        console.error(err); 
        alert("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨");
      });
    }

    /** [ì •êµ­ êµ¬ë„ ë¡œì§] */
    let factionIdCounter = 0;
    let factions = []; 
    let alliances = []; 
    let vsRelations = []; 

    function createNewFaction() {
      factionIdCounter++;
      const id = 'fac-' + factionIdCounter;
      const defaultColors = ['#3182f6', '#f04452', '#00c471', '#ffb800', '#9333ea', '#ff6b00', '#00b8d9', '#6554c0'];
      const color = defaultColors[(factionIdCounter - 1) % defaultColors.length];
      
      factions.push({ 
        id: id, 
        name: 'ì„¸ë ¥ ' + factionIdCounter, 
        leader: 'ë¦¬ë”', 
        size: 100, 
        coreMembers: [], 
        coreSize: 85, 
        members: [], 
        color: color, 
        selected: false 
      });
      renderAll();
    }

    function deleteFaction(id) {
      if(!confirm("ì´ ì„¸ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      factions = factions.filter(f => f.id !== id);
      alliances.forEach(a => a.factionIds = a.factionIds.filter(fid => fid !== id));
      alliances = alliances.filter(a => a.factionIds.length > 0);
      vsRelations = vsRelations.filter(rel => rel[0] !== id && rel[1] !== id);
      renderAll();
    }

    // âœ… [í•µì‹¬ ìˆ˜ì •] ë Œë”ë§ ë¡œì§ ê°œì„  (ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° & 2ë‹¨ ë°°ì—´)
    function renderAll() {
      const controls = document.getElementById('controls-wrapper');
      const viz = document.getElementById('viz-wrapper');
      if(!controls || !viz) return;

      controls.innerHTML = ''; 
      viz.innerHTML = '';

      // ì‹œê°í™” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ê°•ì œ ì„¤ì • (ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€)
      viz.style.width = '100%';
      viz.style.display = 'flex';
      viz.style.flexWrap = 'wrap';       // ì¤„ë°”ê¿ˆ í—ˆìš©
      viz.style.justifyContent = 'center'; 
      viz.style.gap = '20px';            // ì•„ì´í…œ ê°„ ê°„ê²©

      // 1. ì»¨íŠ¸ë¡¤ íŒ¨ë„ ê·¸ë¦¬ê¸° (ê¸°ì¡´ ë™ì¼)
      factions.forEach(f => {
        const card = document.createElement('div');
        const borderColor = f.selected ? f.color : '#f2f4f6';
        
        card.style.cssText = 'padding: 15px; border: 2.5px solid ' + borderColor + '; border-radius: 20px; background: #fbfcfe; cursor: pointer; position:relative; transition: all 0.2s;';
        card.onclick = function() { f.selected = !f.selected; renderAll(); };
        
        card.innerHTML = `
          <div onclick="deleteFaction('${f.id}'); event.stopPropagation();" style="position:absolute; top:8px; right:8px; width:22px; height:22px; background:#ff4d4f; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; cursor:pointer;">Ã—</div>
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding-right:25px;">
            <input type="color" value="${f.color}" onchange="updateFaction('${f.id}', 'color', this.value)" onclick="event.stopPropagation()" style="width:30px; height:30px; border:none; border-radius:4px; background:none; cursor:pointer;">
            <input type="text" value="${f.name}" onchange="updateFaction('${f.id}', 'name', this.value)" onclick="event.stopPropagation()" style="flex:1; border:none; background:transparent; font-weight:800; color:${f.color}; outline:none; font-size:1.1em;">
            <span>${f.selected ? 'âœ…' : 'âšª'}</span>
          </div>
          <div style="margin-bottom:8px;">
            <div style="font-size:10px; color:#888; margin-bottom:2px;">ğŸ‘‘ ë¦¬ë” ì´ë¦„</div>
            <input type="text" value="${f.leader}" onchange="updateFaction('${f.id}', 'leader', this.value)" onclick="event.stopPropagation()" style="width:100%; padding:6px; border:1px solid #eef0f2; border-radius:8px; font-size:12px;">
          </div>
          <div style="font-size:10px; color:#888;">ğŸ“ ì„¸ë ¥ í¬ê¸°</div>
          <input type="range" min="80" max="180" value="${f.size}" oninput="updateFaction('${f.id}', 'size', this.value)" onclick="event.stopPropagation()" style="width:100%;">
          <div style="margin-top:10px; display:flex; gap:5px;">
            <button onclick="addRoleMember('${f.id}', 'core'); event.stopPropagation();" style="flex:1; padding:6px; border:1.5px solid ${f.color}50; border-radius:8px; font-size:11px; font-weight:700; color:${f.color}; background:white;">+í•µì‹¬</button>
            <button onclick="addRoleMember('${f.id}', 'normal'); event.stopPropagation();" style="flex:1; padding:6px; background:${f.color}; color:#fff; border:none; border-radius:8px; font-size:11px; font-weight:700;">+ì¸ë¬¼</button>
          </div>
        `;
        controls.appendChild(card);
      });

      // 2. ì‹œê°í™” ê·¸ë¦¬ê¸°
      let renderedIds = new Set();
      factions.forEach(f => {
        if (renderedIds.has(f.id)) return;
        
        let alliance = alliances.find(a => a.factionIds.includes(f.id));
        let element = alliance ? createAllianceDOM(alliance) : createFactionDOM(f, false);
        
        if (alliance) alliance.factionIds.forEach(id => renderedIds.add(id));
        else renderedIds.add(f.id);
        
        viz.appendChild(element);

        // VS ê´€ê³„ (ëŒ€ë¦½) í‘œì‹œ
        const vsRel = vsRelations.find(rel => rel[0] === f.id || (alliance && alliance.factionIds.includes(rel[0])));
        if (vsRel) {
             const key = vsRel[0] + '-' + vsRel[1];
             if(!viz.querySelector('[data-vs="' + key + '"]')){
                 const vsContainer = document.createElement('div');
                 vsContainer.setAttribute('data-vs', key);
                 // VS ë¬¸êµ¬ ìŠ¤íƒ€ì¼
                 vsContainer.style.cssText = 'display:flex; align-items:center; justify-content:center; margin: 0 5px; z-index:5; flex-shrink: 0;';
                 vsContainer.innerHTML = '<div style="font-family:\'Arial Black\', sans-serif; font-size:40px; font-style:italic; color:#f04452; font-weight:900; text-shadow: 2px 2px 10px rgba(240,68,82,0.2);">VS</div>';
                 viz.appendChild(vsContainer);
             }
        }
      });
    }

    function createFactionDOM(f, inAlliance) {
      const div = document.createElement('div');
      
      // âœ… [ìˆ˜ì •] ë„ˆë¹„ ê³„ì‚° ë¡œì§ ë³€ê²½
      // ì—°í•© ë‚´ë¶€ê°€ ì•„ë‹ ê²½ìš°(ë©”ì¸ í™”ë©´) -> í™”ë©´ì˜ ì•½ 45% ì°¨ì§€ (2ê°œ ë°°ì¹˜)
      // ì—°í•© ë‚´ë¶€ì¼ ê²½ìš° -> ìë™ í¬ê¸° (ê¸°ì¡´ ìœ ì§€)
      if (!inAlliance) {
          div.style.flex = "1 1 45%"; // ê¸°ë³¸ 45%, ìœ ì—°í•˜ê²Œ ëŠ˜ì–´ë‚¨
          div.style.maxWidth = "48%"; // ìµœëŒ€ 48% (2ê°œ ë°°ì¹˜ ë³´ì¥)
          div.style.minWidth = "300px"; // ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ
          div.style.marginBottom = "20px";
      } else {
          // ì—°í•© ë‚´ë¶€ì—ì„œëŠ” ê¸°ì¡´ì²˜ëŸ¼ ê³„ì‚°ëœ í”½ì…€ ë„ˆë¹„ ì‚¬ìš©í•˜ë˜ flex itemìœ¼ë¡œ
          const headWidth = parseInt(f.size) + (f.coreMembers.length * (parseInt(f.coreSize) + 20)) + 40;
          const finalWidth = Math.max(f.size * 2.5, headWidth, 220);
          div.style.width = finalWidth + "px";
          div.style.flexShrink = "0";
      }

      div.style.textAlign = 'center';
      div.style.transition = 'all 0.3s ease';
      
      let coreHtml = f.coreMembers.map(m => `<div onclick="removeRoleMember('${f.id}','core','${m}')" style="width:${f.coreSize}px; height:${f.coreSize}px; background:#fff; border:4px solid ${f.color}; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${f.color}; font-weight:800; font-size:${f.coreSize/75}em; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">${m}</div>`).join('');
      let memHtml = f.members.map(m => `<div onclick="removeRoleMember('${f.id}','normal','${m}')" style="width:70px; height:70px; background:#fff; border:2.5px solid ${f.color}80; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${f.color}; font-weight:800; font-size:15px; cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">${m}</div>`).join('');

      div.innerHTML = `
        <div style="font-weight:900; color:${f.color}; margin-bottom:15px; font-size:19px; text-shadow: 0 2px 4px rgba(0,0,0,0.05);">${f.name}</div>
        <div style="background:${f.color}08; border-radius:45px; border:${inAlliance ? 'none' : '2.5px dashed ' + f.color + '30'}; padding:40px 20px; display:flex; align-items:center; justify-content:center; min-height:160px; box-shadow: inset 0 0 20px ${f.color}05;">
          <div style="display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:15px;">
            <div style="width:${f.size}px; height:${f.size}px; background:${f.color}; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:900; font-size:${f.size/75}em; box-shadow:0 10px 25px ${f.color}40; transition: all 0.3s;">${f.leader}</div>
            ${coreHtml}
            ${memHtml}
          </div>
        </div>
      `;
      return div;
    }

    function createAllianceDOM(alliance) {
      const wrapper = document.createElement('div');
      // âœ… [ìˆ˜ì •] ì—°í•© ë°•ìŠ¤ë„ í™”ë©´ì˜ ì•½ 45% ì°¨ì§€í•˜ë„ë¡ ì„¤ì •
      wrapper.style.flex = "1 1 45%";
      wrapper.style.maxWidth = "98%"; // ì—°í•©ì€ ì¢€ ë” ë„“ê²Œ ì“¸ ìˆ˜ë„ ìˆìŒ (ì„ íƒ ì‚¬í•­)
      wrapper.style.minWidth = "320px";
      wrapper.style.display = 'flex';
      wrapper.style.gap = '25px'; 
      wrapper.style.padding = '65px 35px 35px'; 
      wrapper.style.background = 'rgba(0,0,0,0.02)'; 
      wrapper.style.border = '2.5px solid #e5e8eb'; 
      wrapper.style.borderRadius = '65px'; 
      wrapper.style.position = 'relative'; 
      wrapper.style.alignItems = 'center'; 
      wrapper.style.justifyContent = 'center';
      wrapper.style.flexWrap = 'wrap'; // ë‚´ë¶€ ì„¸ë ¥ë“¤ë„ ì¤„ë°”ê¿ˆ ê°€ëŠ¥í•˜ê²Œ
      
      const label = document.createElement('div');
      label.innerText = alliance.name;
      label.style.cssText = 'position:absolute; top:-20px; left:50%; transform:translateX(-50%); background:#1a1f27; color:#fff; padding:10px 30px; border-radius:40px; font-size:15px; font-weight:800; white-space:nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor:pointer;';
      label.onclick = function() { alliance.name = prompt("ì—°í•© ëª…ì¹­:", alliance.name) || alliance.name; renderAll(); };
      wrapper.appendChild(label);
      
      alliance.factionIds.forEach(id => {
        const f = factions.find(x => x.id === id);
        if(f) wrapper.appendChild(createFactionDOM(f, true));
      });
      return wrapper;
    }

    function updateFaction(id, key, val) { const f = factions.find(fac => fac.id === id); if(f) { f[key] = val; renderAll(); } }
    
    function createVs() {
      const sel = factions.filter(f => f.selected);
      if (sel.length !== 2) return alert("ëŒ€ë¦½ì‹œí‚¬ ë‘ ì„¸ë ¥ì„ ì„ íƒí•˜ì„¸ìš”.");
      vsRelations.push([sel[0].id, sel[1].id]);
      factions.forEach(f => f.selected = false);
      renderAll();
    }
    
    function createAlliance() {
      const ids = factions.filter(f => f.selected).map(f => f.id);
      if (ids.length < 2) return alert("ë™ë§¹í•  ì„¸ë ¥ì„ 2ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
      alliances.push({ id: Date.now(), name: "ì—°í•© ì„¸ë ¥", factionIds: ids });
      factions.forEach(f => f.selected = false);
      renderAll();
    }
    
    function resetAll() { factions = []; alliances = []; vsRelations = []; renderAll(); }
    
    function addRoleMember(id, type) {
      const name = prompt("ì¸ë¬¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
      if(!name) return;
      const f = factions.find(fac => fac.id === id);
      if(type === 'core') f.coreMembers.push(name); else f.members.push(name);
      renderAll();
    }
    
    function removeRoleMember(fId, type, name) {
      const f = factions.find(fac => fac.id === fId);
      if(type === 'core') f.coreMembers = f.coreMembers.filter(m => m !== name);
      else f.members = f.members.filter(m => m !== name);
      renderAll();
    }

    /** [3] ì´ˆê¸°í™” & ë²„ì „ í‘œì‹œ */
    window.addEventListener('DOMContentLoaded', () => {
       createNewFaction(); 
       createNewFaction(); 
       
       (function(){
          const el = document.getElementById("sysVersion");
          if (!el) return;
          const d = new Date(document.lastModified);
          if (isNaN(d.getTime())) { el.textContent = "V. Unknown"; return; }
          
          const z = n => (n < 10 ? "0"+n : String(n));
          el.textContent = "V. " + d.getFullYear() + z(d.getMonth()+1) + z(d.getDate()) + "_" + z(d.getHours()) + z(d.getMinutes());
          el.title = document.lastModified;
       })();
    });
  </script>
</body>
</html>
