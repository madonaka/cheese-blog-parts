<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cheese Lab Project</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

<style>
    /* ... ê¸°ì¡´ CSS ë³€ìˆ˜ ... */
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; }
    .dashboard-layout > div { min-width: 0; }

    /* ğŸš¨ [ìˆ˜ì • 1] ëª¨ë°”ì¼ ìƒë‹¨ ì˜ë¦¼ í•´ê²° (í—¤ë” ë†’ì´ë§Œí¼ íŒ¨ë”© ì¶”ê°€) */
    @media (max-width: 1000px) { 
      .admin-main { 
        padding: 12px; 
        padding-top: calc(var(--admin-header-h, 64px) + 20px) !important; /* í—¤ë” ë†’ì´ í™•ë³´ */
      } 
    }

    /* ğŸš¨ [ìˆ˜ì • 2] íƒ­ ë©”ë‰´ ìŠ¤í¬ë¡¤ ë° ì˜ë¦¼ í•´ê²° */
    .view-tabs { 
      display: flex; gap: 6px; margin-bottom: 20px; 
      background: #f1f5f9; padding: 4px; border-radius: 12px; 
      width: 100%; max-width: 100%; /* ë„ˆë¹„ 100%ë¡œ í™•ì¥ */
      overflow-x: auto; white-space: nowrap; 
      -webkit-overflow-scrolling: touch; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
      scrollbar-width: none; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ (íŒŒì´ì–´í­ìŠ¤) */
    }
    .view-tabs::-webkit-scrollbar { display: none; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ (í¬ë¡¬/ì‚¬íŒŒë¦¬) */ }

    .view-tab-btn { 
      padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; 
      border: none; background: transparent; color: var(--text-sub); 
      cursor: pointer; transition: all 0.2s; white-space: nowrap; 
      flex-shrink: 0; /* ë²„íŠ¼ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
    }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* Goal Card */
    .goal-card { background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); transition: transform 0.2s; position: relative; }
    .goal-card-header { padding: 18px 24px; color: white; display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; }
    .goal-card-header:hover { opacity: 0.95; }
    .goal-card-title { font-size: 1.25rem; font-weight: 800; line-height: 1.3; max-width: 85%; display: flex; align-items: center; gap: 8px; }
    .goal-card-desc { font-size: 0.9rem; opacity: 0.95; margin-top: 6px; font-weight: 400; line-height: 1.4; }
    .goal-date-badge { display: inline-block; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 8px; font-size: 0.75rem; margin-top: 6px; font-weight: 500; }
    .header-actions .action-btn { background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 6px; padding: 6px 10px; cursor: pointer; margin-left: 4px; }

    /* Mid/Task */
    .mid-goal-group { padding: 20px; border-top: 1px solid #f1f5f9; }
    .mid-goal-item { margin-top: 16px; background: #fff; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-item:first-child { margin-top: 0; }
    .mid-goal-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); }
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s; }
    .task-row:hover { background: #fdfdfd; }
    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .mid-goal-header:hover .row-actions, .task-row:hover .row-actions { opacity: 1; }
    @media(max-width:600px){ .row-actions { opacity: 1; } }
    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: #94a3b8; }
    .row-btn:hover { color: var(--primary); } .row-btn.delete:hover { color: #ef4444; }

    /* Board */
    .board-container { background: #fff; border-radius: 16px; border: 1px solid var(--border-color); overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); width: 100%; }
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; min-width: 600px; }
    .board-table th { background: #f8fafc; padding: 14px 16px; text-align: left; font-weight: 700; color: var(--text-sub); border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    .board-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; cursor: pointer; }
    .path-badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: #fff; background: #94a3b8; white-space: nowrap; }
    
    /* ğŸš€ [ë³€ê²½] ë²„ê·¸ íŠ¸ë˜ì»¤ ì „ìš© ìŠ¤íƒ€ì¼ */
    .bug-container { border-top: 4px solid #ef4444; }
    .bug-header-alert { padding: 12px 16px; background: #fef2f2; color: #b91c1c; font-weight: 700; border-bottom: 1px solid #fee2e2; display: flex; align-items: center; gap: 6px; }
    .bug-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; color: #b91c1c; background: #fecaca; border: 1px solid #f87171; }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• (Board & Bug ê³µí†µ) */
    @media (max-width: 768px) {
        .board-container { background: transparent; border: none; box-shadow: none; overflow: visible; }
        .board-table { display: block; width: 100%; min-width: 0; }
        .board-table thead { display: none; }
        .board-table tbody { display: block; }
        .board-table tr { display: block; background: #fff; border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 12px; padding: 16px 16px 16px 48px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .board-table td { display: block; padding: 0; border: none; text-align: left !important; margin-bottom: 6px; }
        .board-table td:nth-child(1) { position: absolute; left: 16px; top: 18px; width: auto; }
        .board-table td:nth-child(2) { margin-bottom: 8px; }
        .board-table td:nth-child(3) { font-size: 1.05rem; margin-bottom: 8px; font-weight: 600; }
        .board-table td:nth-child(4) { font-size: 0.85rem; color: var(--text-sub); }
        .board-table td:nth-child(4)::before { content: 'ğŸ“… ë§ˆê°: '; font-weight: 600; color: var(--primary); }
    }

    /* Idea */
    .idea-container { padding: 0 4px; }
    .idea-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .idea-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .idea-card { 
      background: #fff; border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; 
      transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: flex; flex-direction: column; height: 100%; border-top: 5px solid #d8b4fe;
    }
    .idea-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .idea-header { display: flex; justify-content: flex-start; margin-bottom: 8px; }
    .idea-date { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .idea-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; color: #1e293b; line-height: 1.3; }
    .idea-body { font-size: 0.9rem; color: #64748b; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    .idea-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #f1f5f9; padding-top: 12px; }
    .idea-btn { flex: 1; border: none; background: #f1f5f9; color: #64748b; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    .idea-btn:hover { background: #e2e8f0; color: #334155; }
    .idea-btn.plan { background: #eff6ff; color: #3b82f6; } .idea-btn.plan:hover { background: #dbeafe; }
    .idea-btn.done { background: #f0fdf4; color: #16a34a; } .idea-btn.done:hover { background: #dcfce7; }

    /* Log */
    .log-container { background: #fff; border-radius: 16px; padding: 32px; border: 1px solid var(--border-color); min-height: 600px; }
    .log-item { position: relative; padding-left: 24px; margin-bottom: 28px; max-width: 800px; }
    .log-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -30px; width: 2px; background: #e2e8f0; }
    .log-item:last-child::before { display: none; }
    .log-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary); border-radius: 50%; }
    .log-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; transition: box-shadow 0.2s; position: relative; }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .log-date { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; }
    .log-related { display: inline-block; font-size: 0.75rem; color: #059669; background: #ecfdf5; padding: 2px 8px; border-radius: 4px; font-weight: 600; margin-bottom: 6px; }
    .log-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .log-card:hover .log-actions { opacity: 1; }
    .log-count-badge { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-flex; align-items: center; gap: 3px; }
    @media (max-width: 600px) { .log-container { padding: 16px; } .log-actions { opacity: 1; position: relative; top:0; right:0; margin-left: auto; } .log-header { flex-wrap: wrap; gap: 8px; } }

    /* Utils */
    .color-options { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .color-radio { display: none; }
    .color-label { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-radio:checked + .color-label { transform: scale(1.1); box-shadow: 0 0 0 2px #fff, 0 0 0 4px #94a3b8; }
    .check-circle { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: var(--primary); }
    .fab-sub { width: 48px; height: 48px; background: #475569; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }

    /* ëª¨ë‹¬ */
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 32px; border-radius: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    @media (max-width: 600px) { .date-group { flex-direction: column !important; gap: 10px !important; } .modal-box { width: 95% !important; padding: 20px !important; max-width: 100%; border-radius: 16px; } }
    .view-content-box { padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 100px; line-height: 1.6; color: #334155; margin-top: 4px; }
    .view-content-box img { max-width: 100%; height: auto; border-radius: 4px; }
    
    .modal-section { margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .section-title { font-size: 0.95rem; font-weight: 700; color: #475569; margin-bottom: 12px; display:flex; align-items:center; gap:6px; }
    
    .history-item { background: #fff; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 8px; }
    .history-date { font-weight: 600; color: var(--primary); font-size: 0.75rem; margin-bottom: 4px; }

    /* ê´€ë ¨ ì•„ì´ë””ì–´(ë¯¸ë‹ˆ ì¹´ë“œ) */
    .mini-idea-grid { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
    .mini-idea-card { min-width: 200px; max-width: 200px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; border-top: 4px solid #d8b4fe; cursor: pointer; flex-shrink: 0; }
    .mini-idea-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .mini-idea-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .mini-idea-desc { font-size: 0.8rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
    
    #log-bug-section { background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px dashed #ef4444; margin-top: 10px; }
    #log-bug-section label { color: #b91c1c; font-weight: 700; display:flex; align-items:center; gap:4px; }
    #log-bug-section input { border-color: #fca5a5; }
    
    /* ğŸš€ [NEW] ì¤‘ê°„ ëª©í‘œ ë‚´ ì•„ì´ë””ì–´ ìŠ¬ë¼ì´ë” */
    .mid-idea-slider {
      display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px;
      background: #f1f5f9; border-bottom: 1px solid #e2e8f0;
      /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ì„ íƒì‚¬í•­) */
      scrollbar-width: thin;
    }
    .mid-idea-slider::-webkit-scrollbar { height: 6px; }
    .mid-idea-slider::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

    .mid-idea-card-mini {
      min-width: 180px; max-width: 180px;
      background: #fff; border: 1px solid #cbd5e1; border-radius: 8px;
      padding: 10px; cursor: pointer; flex-shrink: 0;
      border-top: 3px solid #d8b4fe; /* ì•„ì´ë””ì–´ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
      transition: transform 0.1s;
      display: flex; flex-direction: column;
    }
    .mid-idea-card-mini:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    
    .mic-date { font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; }
    .mic-title { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.3; }
    .mic-desc { font-size: 0.75rem; color: #64748b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

  /* ğŸš€ [NEW] ë¡œê·¸ ë‚ ì§œ êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ */
    .log-date-divider {
      display: flex; align-items: center; margin: 30px 0 15px; 
      font-weight: 700; color: #475569; font-size: 0.9rem;
    }
    /* êµ¬ë¶„ì„  ì¢Œìš° ë¼ì¸ */
    .log-date-divider::before, .log-date-divider::after {
      content: ''; flex: 1; height: 1px; background: #e2e8f0;
    }
    .log-date-divider::before { margin-right: 12px; }
    .log-date-divider::after { margin-left: 12px; }
    
    /* ë‚ ì§œ í…ìŠ¤íŠ¸ ë°°ì§€ */
    .log-date-badge {
      background: #f1f5f9; padding: 4px 12px; border-radius: 20px; 
      color: #334155; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* ë¡œê·¸ ì¹´ë“œ ë‚´ë¶€ ì •ë¦¬ */
    .log-card { border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
    .log-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; display:flex; align-items:center; gap:4px; }
    
    /* íƒ€ì„ë¼ì¸ ì„  ì—°ê²° ëŠê¸° ë°©ì§€ (ë§ˆì§€ë§‰ ì•„ì´í…œ ì²˜ë¦¬) */
    .log-item:last-child::before { display: block; background: linear-gradient(to bottom, #e2e8f0 50%, transparent 100%); }

  /* ğŸš€ [NEW] ëª¨ë‹¬ ë‚´ íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ ê°œì„  */
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    
    .history-item { 
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; 
      padding: 12px; font-size: 0.9rem; position: relative;
    }
    
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .history-date { 
      font-weight: 700; color: #64748b; font-size: 0.75rem; 
      background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #e2e8f0; 
    }
    .history-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
    
    .history-content { color: #334155; line-height: 1.5; white-space: pre-wrap; font-size: 0.9rem; }

    /* ë”ë³´ê¸° ë²„íŠ¼ */
    .history-more-btn {
      width: 100%; padding: 10px; margin-top: 5px;
      background: #fff; border: 1px dashed #cbd5e1; border-radius: 8px;
      color: #64748b; font-size: 0.85rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .history-more-btn:hover { background: #f1f5f9; color: #3b82f6; border-color: #3b82f6; }

  /* ğŸš€ [NEW] ì‹¤í˜„ëœ ì•„ì´ë””ì–´ ìŠ¤íƒ€ì¼ */
    .idea-card.realized { 
      border: 2px solid #60a5fa; /* íŒŒë€ í…Œë‘ë¦¬ */
      background: #f8fbff; /* ì•„ì£¼ ì—°í•œ íŒŒë€ ë°°ê²½ */
    }
    .realized-badge { 
      position: absolute; top: -10px; right: 12px; 
      background: #3b82f6; color: white; font-size: 0.75rem; 
      padding: 4px 10px; border-radius: 20px; font-weight: 800; 
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
      z-index: 2; 
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
  /* ğŸš€ [NEW] ë²„ê·¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .bug-card {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px;
      transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      display: flex; flex-direction: column; height: 100%; 
      border-top: 5px solid #ef4444; /* ê¸°ë³¸ ë¹¨ê°• */
    }
    .bug-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.15); }

    /* ì‘ì—…ì¤‘(í™•ì¸ì¤‘) ìƒíƒœ ê°•ì¡° */
    .bug-card.working {
      border: 2px solid #f87171; /* ë¶‰ì€ í…Œë‘ë¦¬ */
      background: #fef2f2; /* ì—°í•œ ë¶‰ì€ ë°°ê²½ */
    }

    /* ë°°ì§€ (í™•ì¸ì¤‘/ì‘ì—…ì¤‘) */
    .bug-status-badge {
      position: absolute; top: -10px; right: 12px;
      background: #ef4444; color: white; font-size: 0.75rem;
      padding: 4px 10px; border-radius: 20px; font-weight: 800;
      box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);
      z-index: 2;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* ë²„ê·¸ ì¹´ë“œ ë‚´ìš© */
    .bug-parent-info { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display:flex; align-items:center; gap:4px; }
    .bug-title { font-weight: 800; font-size: 1.05rem; margin-bottom: 8px; color: #7f1d1d; line-height: 1.3; }
    .bug-body { font-size: 0.9rem; color: #7f1d1d; opacity:0.8; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

    /* ë²„ê·¸ ì•¡ì…˜ ë²„íŠ¼ */
    .bug-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #fee2e2; padding-top: 12px; }
    .bug-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    
    .bug-btn.check { background: #fff1f2; color: #e11d48; } 
    .bug-btn.check:hover { background: #ffe4e6; }
    
    .bug-btn.solve { background: #f0fdf4; color: #16a34a; } 
    .bug-btn.solve:hover { background: #dcfce7; }
    
    .bug-btn.restore { background: #f1f5f9; color: #64748b; }
    .bug-btn.restore:hover { background: #e2e8f0; }
  /* ğŸš€ [ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ (ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ìš©) */
    .history-list { display: flex; flex-direction: column; gap: 8px; }
    
    .history-item { 
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; 
      padding: 12px; font-size: 0.9rem; position: relative;
      cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
      transition: background 0.2s;
    }
    .history-item:hover { background: #f1f5f9; }

    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .history-date { 
      font-weight: 700; color: #64748b; font-size: 0.75rem; 
      background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #e2e8f0; 
    }
    .history-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
    
    /* ë‚´ìš©: ê¸°ë³¸ 3ì¤„ ë§ì¤„ì„ (...) ì²˜ë¦¬ */
    .history-content { 
      color: #334155; line-height: 1.5; font-size: 0.9rem;
      
      /* 3ì¤„ ì´ìƒ ë„˜ì–´ê°€ë©´ ìë¥´ê³  ... í‘œì‹œ */
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal; /* pre-wrap ëŒ€ì‹  normalì„ ì¨ì•¼ line-clampê°€ ë¨¹í˜ (JSì—ì„œ bríƒœê·¸ ì²˜ë¦¬) */
    }

    /* í¼ì³ì¡Œì„ ë•Œ (.expanded í´ë˜ìŠ¤ ì¶”ê°€ ì‹œ) */
    .history-item.expanded .history-content {
      display: block; /* ë°•ìŠ¤ ì œí•œ í•´ì œ */
      -webkit-line-clamp: unset;
      overflow: visible;
    }
    
    /* í¼ì¹¨/ì ‘í˜ íŒíŠ¸ (ì„ íƒì‚¬í•­) */
    .history-item::after {
        content: 'â–¼ ëˆŒì–´ì„œ ë”ë³´ê¸°';
        display: block; text-align: center; font-size: 0.7rem; color: #cbd5e1; margin-top: 6px;
    }
    .history-item.expanded::after {
        content: 'â–² ì ‘ê¸°';
    }
  /* íˆìŠ¤í† ë¦¬ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
    .history-item { 
      background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; 
      padding: 12px; font-size: 0.9rem; position: relative;
      cursor: pointer; transition: background 0.2s;
    }
    .history-item:hover { background: #f1f5f9; }

    /* ê¸°ë³¸ ìƒíƒœ: 3ì¤„ê¹Œì§€ë§Œ ë³´ì´ê³  ë§ì¤„ì„ */
    .history-content { 
      color: #334155; line-height: 1.5; font-size: 0.9rem;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
      overflow: hidden; text-overflow: ellipsis;
    }

    /* í¼ì³ì§„ ìƒíƒœ: ì „ì²´ ë‚´ìš© í‘œì‹œ */
    .history-item.expanded .history-content {
      display: block; -webkit-line-clamp: unset; overflow: visible;
    }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0;">Dashboard</h2>
        <p style="color: var(--text-sub); margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ í˜„í™©ê³¼ ê¸°ë¡</p>
      </div>

      <div class="dashboard-layout">
        
        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜•</button>
          <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ</button>
          <button class="view-tab-btn" onclick="switchView('bug')" id="btn-view-bug">ğŸ ë²„ê·¸ íŠ¸ë˜ì»¤</button> <button class="view-tab-btn" onclick="switchView('idea')" id="btn-view-idea">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</button>
          <button class="view-tab-btn" onclick="switchView('log')" id="btn-view-log">ğŸ“ ì‘ì—… ë¡œê·¸</button>
        </div>

        <div id="view-card-container"><div id="goal-tree-root"><div class="goal-card" style="padding:40px; text-align:center; color:#94a3b8; background:#f1f5f9;">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
        
        <div id="view-board-container" style="display:none;"><div class="board-container"><table class="board-table"><thead><tr><th style="width:50px; text-align:center;">ì™„ë£Œ</th><th>ê²½ë¡œ</th><th>ì œëª©</th><th style="width:110px;">ë§ˆê°ì¼</th></tr></thead><tbody id="board-table-body"></tbody></table></div></div>
        
        <div id="view-bug-container" style="display:none;">
          <div class="idea-container">
            <div class="idea-toolbar">
              <span style="font-size:0.9rem; color:#b91c1c; font-weight:600;">ğŸš¨ ë°œê²¬ëœ ë²„ê·¸ ë° ì´ìŠˆ íŠ¸ë˜ì»¤</span>
              <label style="cursor:pointer; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="toggle-bug-archive" onchange="renderBugView()">
                <span>âœ… í•´ê²°ëœ ë²„ê·¸ ë³´ê¸° (ì•„ì¹´ì´ë¸Œ)</span>
              </label>
            </div>
            <div id="bug-grid-root" class="idea-grid"></div>
          </div>
        </div>

        <div id="view-idea-container" style="display:none;">
          <div class="idea-container">
            <div class="idea-toolbar">
              <span style="font-size:0.9rem; color:#64748b; font-weight:600;">âœ¨ ë°˜ì§ì´ëŠ” ì•„ì´ë””ì–´ë“¤ì„ ëª¨ì•„ë³´ì„¸ìš”!</span>
              <label style="cursor:pointer; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="toggle-archive" onchange="renderIdeaView()">
                <span>ğŸ—„ï¸ ì™„ë£Œëœ ì•„ì´ë””ì–´ ë³´ê¸° (ì•„ì¹´ì´ë¸Œ)</span>
              </label>
            </div>
            <div id="idea-grid-root" class="idea-grid"></div>
          </div>
        </div>

        <div id="view-log-container" style="display:none;">
          <div class="log-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
              <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">ğŸ“ ì „ì²´ ì‘ì—… íƒ€ì„ë¼ì¸</h3>
              <button class="btn btn-primary" style="padding: 10px 16px; font-size: 0.95rem;" onclick="openLogModal()">+ ìƒˆ ê¸°ë¡ ì‘ì„±</button>
            </div>
            <div id="log-timeline-root"></div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 class="modal-title" id="todo-modal-title" style="margin:0;">í•­ëª© ìƒì„¸</h3>
      <button id="btn-enable-edit" class="btn" style="background:#eff6ff; color:var(--primary); border:none;" onclick="toggleEditMode(true)">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    </div>

    <form id="todo-form" class="admin-form-grid">
      <input type="hidden" id="edit-id"><input type="hidden" id="edit-mode" value="false">
      <input type="hidden" id="origin-idea-id"> 

      <div class="field admin-field-full">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto;">
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label style="white-space:nowrap; color:#ef4444; font-weight:bold;"><input type="radio" name="type" value="ë²„ê·¸" onclick="toggleFormFields()"> ğŸ”¥ ë²„ê·¸</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-color" style="display:none;"><label>í…Œë§ˆ ìƒ‰ìƒ</label><div class="color-options"><label><input type="radio" name="color" value="#4f46e5" class="color-radio" checked><span class="color-label" style="background:#4f46e5;"></span></label><label><input type="radio" name="color" value="#059669" class="color-radio"><span class="color-label" style="background:#059669;"></span></label><label><input type="radio" name="color" value="#db2777" class="color-radio"><span class="color-label" style="background:#db2777;"></span></label><label><input type="radio" name="color" value="#d97706" class="color-radio"><span class="color-label" style="background:#d97706;"></span></label><label><input type="radio" name="color" value="#0891b2" class="color-radio"><span class="color-label" style="background:#0891b2;"></span></label><label><input type="radio" name="color" value="#475569" class="color-radio"><span class="color-label" style="background:#475569;"></span></label></div></div>
      <div class="field admin-field-full" id="field-parent"><label>ì—°ê²°ëœ ëª©í‘œ</label><select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select></div>
      <div class="field admin-field-full"><label>ì œëª©</label><input type="text" id="input-title" required></div>
      
      <div class="field admin-field-full" id="field-detail">
        <label>ìƒì„¸ ë‚´ìš©</label>
        <div id="detail-view-box" class="view-content-box"></div>
        <div id="detail-edit-wrapper" style="display:none;">
          <textarea id="input-detail"></textarea>
        </div>
      </div>

      <div class="date-group" style="display:flex; gap:16px;">
        <div class="field" id="field-start-date" style="flex:1;"><label>ì‹œì‘ì¼</label><input type="date" id="input-start"></div>
        <div class="field" id="field-due-date" style="flex:1;"><label>ë§ˆê°ì¼</label><input type="date" id="input-due"></div>
      </div>
      <div class="field" id="field-priority"><label>ìš°ì„ ìˆœìœ„</label><select id="input-priority"><option value="ë†’ìŒ">ë†’ìŒ</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ë‚®ìŒ">ë‚®ìŒ</option></select></div>

      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;">
        <div id="edit-actions" style="display:none; width:100%; display:flex; gap:10px;">
          <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥í•˜ê¸°</button>
          <button type="button" id="btn-delete-modal" class="btn" style="color:#ef4444;" onclick="deleteFromModal()">ì‚­ì œ</button>
          <button type="button" class="btn" onclick="toggleEditMode(false)" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button>
        </div>
        <div id="view-actions" style="width:100%; display:flex; gap:10px;">
          <button type="button" class="btn" style="background:#10b981; color:white; flex:1;" onclick="createNewLogFromTask()">ğŸ“… ì‘ì—… ë¡œê·¸ ê¸°ë¡</button>
          <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center; padding:12px;">ë‹«ê¸°</button>
        </div>
      </div>
    </form>

    <div id="related-idea-section" class="modal-section" style="display:none;">
      <div class="section-title">ğŸ’¡ ê´€ë ¨ ì•„ì´ë””ì–´ & ê¸°íš</div>
      <div id="related-idea-root" class="mini-idea-grid"></div>
    </div>

    <div id="related-history-section" class="modal-section" style="display:none;">
      <div class="section-title">ğŸ“ ì‘ì—… íˆìŠ¤í† ë¦¬</div>
      <div id="history-list-root" class="history-list"></div>
    </div>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="log-modal-title" style="margin-top:0;">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <input type="hidden" id="log-edit-id"><input type="hidden" id="log-edit-mode" value="false">
      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title"></div>
      <div class="field admin-field-full" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;"><label style="color:#0284c7; font-weight:600;">ğŸ”— ê´€ë ¨ ì‘ì—… ì—°ë™ (ì„ íƒ)</label><select id="log-related-id" style="width:100%; border:1px solid #bae6fd;"><option value="">(ì—†ìŒ)</option></select><p style="font-size:0.75rem; color:#0ea5e9; margin:4px 0 0;">* ì´ ë¡œê·¸ë¥¼ íŠ¹ì • ì‘ì—…ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.</p></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      <div class="field admin-field-full" id="log-idea-section" style="background:#f0fdf4; padding:16px; border-radius:12px; border:1px dashed #16a34a;"><label style="color:#15803d; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ (ì„ íƒ)</label><input type="text" id="log-idea-input" placeholder="ì—¬ê¸°ì— ì ìœ¼ë©´ ì•„ì´ë””ì–´ í•¨ì— ì¶”ê°€ë¨" style="background:#fff; border-color:#86efac;"></div>
      
      <div class="field admin-field-full" id="log-bug-section">
        <label>ğŸ ë²„ê·¸ ë°œê²¬ (ì„ íƒ)</label>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <input type="text" id="log-bug-input" placeholder="ë²„ê·¸ ì œëª© (ì˜ˆ: ë¡œê·¸ì¸ ì‹œ 404 ì—ëŸ¬)" style="background:#fff;">
            <textarea id="log-bug-detail" placeholder="ë²„ê·¸ ìƒì„¸ ë‚´ìš© (ë°œìƒ ê²½ë¡œ, ì¦ìƒ ë“±)" style="background:#fff; min-height:60px;"></textarea>
        </div>
        <p style="font-size:0.75rem; color:#ef4444; margin:4px 0 0;">* ì…ë ¥ ì‹œ 'ë²„ê·¸' í•­ëª©ìœ¼ë¡œ ìë™ ë“±ë¡ë˜ë©°, í˜„ì¬ ë¡œê·¸ì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags"></div>
      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥</button><button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button></div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        renderGoalTree(); renderBoardView(); renderBugView(); renderIdeaView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // ğŸš€ [ë³€ê²½] íƒ­ ì „í™˜
  function switchView(mode) {
    document.getElementById('btn-view-card').classList.toggle('active', mode==='card');
    document.getElementById('btn-view-board').classList.toggle('active', mode==='board');
    document.getElementById('btn-view-bug').classList.toggle('active', mode==='bug'); // NEW
    document.getElementById('btn-view-idea').classList.toggle('active', mode==='idea');
    document.getElementById('btn-view-log').classList.toggle('active', mode==='log');
    
    document.getElementById('view-card-container').style.display = (mode==='card')?'block':'none';
    document.getElementById('view-board-container').style.display = (mode==='board')?'block':'none';
    document.getElementById('view-bug-container').style.display = (mode==='bug')?'block':'none'; // NEW
    document.getElementById('view-idea-container').style.display = (mode==='idea')?'block':'none';
    document.getElementById('view-log-container').style.display = (mode==='log')?'block':'none';
  }

// ğŸš€ [ìˆ˜ì •] ê³„ì¸µí˜• ë·° ë Œë”ë§ (ì ‘ê¸°/í¼ì¹˜ê¸° ë²„ê·¸ ìˆ˜ì •ë¨)
  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root'); root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:40px;text-align:center;color:#94a3b8;">ë°ì´í„° ì—†ìŒ</div>`; return; }
    
    bigGoals.forEach(bg => {
      const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
      const card = document.createElement('div'); card.className = "goal-card";
      
      // --- í° ëª©í‘œ í—¤ë” ---
      const header = document.createElement('div'); 
      header.className = "goal-card-header"; 
      header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${adjustColor(themeColor,-20)} 100%)`;
      
      header.onclick = function() {
        const body = card.querySelector('.mid-goal-group');
        const icon = header.querySelector('.toggle-icon');
        if (body.style.display === "none") { body.style.display = "block"; icon.textContent = "â–¼"; } 
        else { body.style.display = "none"; icon.textContent = "â–¶"; }
      };

      let dateHtml = ""; if (bg['ì‹œì‘ì¼'] || bg['ë§ˆê°ì¼']) { const s = bg['ì‹œì‘ì¼']?bg['ì‹œì‘ì¼'].split('T')[0]:''; const e = bg['ë§ˆê°ì¼']?bg['ë§ˆê°ì¼'].split('T')[0]:''; dateHtml = `<div class="goal-date-badge">ğŸ—“ ${s} ~ ${e}</div>`; }
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc">${bg['ìƒì„¸ë‚´ìš©']}</div>` : '';
      
      header.innerHTML = `
        <div style="flex:1;">
          <div class="goal-card-title"><span class="toggle-icon">â–¶</span> ${bg['ì œëª©']}</div>
          ${dateHtml}${descHtml}
        </div>
        <div class="header-actions" onclick="event.stopPropagation()">
           <button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button>
           <button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(header);

      // --- ì¤‘ê°„ ëª©í‘œ ê·¸ë£¹ (í° ëª©í‘œì˜ ë°”ë””) ---
      const body = document.createElement('div'); 
      body.className = "mid-goal-group";
      body.style.display = "none"; // ì´ˆê¸° ìƒíƒœ: ì ‘í˜

      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midItem = document.createElement('div'); 
        midItem.className = "mid-goal-item"; 
        midItem.style.borderLeftColor = themeColor;
        
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span style="font-weight:400; font-size:0.85rem; color:#64748b; margin-left:8px;">${mg['ìƒì„¸ë‚´ìš©']}</span>` : '';
        
        // 1. ì¤‘ê°„ ëª©í‘œ í—¤ë”
        const midHeader = document.createElement('div');
        midHeader.className = "mid-goal-header";
        // âœ… [Fix] í—¤ë” í´ë¦­ ì‹œ ë°”ë¡œ ë‹¤ìŒ í˜•ì œ(contentWrapper)ë¥¼ í† ê¸€
        midHeader.onclick = function() { toggleDisplay(this); };
        midHeader.innerHTML = `<span>ğŸš© ${mg['ì œëª©']} ${midDesc}</span><div onclick="event.stopPropagation()" class="row-actions"><button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button></div>`;
        midItem.appendChild(midHeader);

        // 2. âœ… [Fix] ì½˜í…ì¸  ë˜í¼ (ìŠ¬ë¼ì´ë” + í• ì¼ ëª©ë¡ì„ ê°ì‹¸ëŠ” div)
        const contentWrapper = document.createElement('div');
        contentWrapper.style.display = "block"; // ê¸°ë³¸ í¼ì¹¨ ìƒíƒœ

        // 3. ì•„ì´ë””ì–´ ìŠ¬ë¼ì´ë” (ë˜í¼ ì•ˆì— ë„£ìŒ)
        const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        if (relatedIdeas.length > 0) {
          const slider = document.createElement('div');
          slider.className = "mid-idea-slider"; // Flex ì†ì„± ìœ ì§€ë¨
          
          let sliderHtml = "";
          relatedIdeas.forEach(idea => {
             const iDate = idea['ê¸°í•œ'] ? idea['ê¸°í•œ'].split('T')[0] : '';
             const iDesc = (idea['ìƒì„¸ë‚´ìš©']||"").replace(/<[^>]*>?/gm, ''); 
             sliderHtml += `
               <div class="mid-idea-card-mini" onclick="openEditModal('idea', '${idea.ID}')">
                 <div class="mic-date">ğŸ’¡ ${iDate}</div>
                 <div class="mic-title">${idea['ì œëª©']}</div>
                 <div class="mic-desc">${iDesc || '(ë‚´ìš© ì—†ìŒ)'}</div>
               </div>
             `;
          });
          slider.innerHTML = sliderHtml;
          contentWrapper.appendChild(slider);
        }

        // 4. í•  ì¼ ëª©ë¡ (ë˜í¼ ì•ˆì— ë„£ìŒ)
        const taskList = document.createElement('div'); 
        taskList.className = "task-list";
        const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID) && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´');
        
        if(tasks.length > 0) tasks.forEach(t => taskList.appendChild(createTaskRow(t)));
        else if(relatedIdeas.length === 0) taskList.innerHTML = `<div style="padding:15px;color:#cbd5e1;font-size:0.85rem;">í•  ì¼ ì—†ìŒ</div>`;
        
        contentWrapper.appendChild(taskList);
        
        // ìµœì¢… ì¡°ë¦½
        midItem.appendChild(contentWrapper);
        body.appendChild(midItem);
      });
      card.appendChild(body); root.appendChild(card);
    });
  }
  
  function createTaskRow(t) {
    const container = document.createElement('div'); const row = document.createElement('div'); row.className = "task-row";
    row.onclick = function() { openEditModal('task', t.ID); };
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
    const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';
    const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '<span style="color:#ef4444;font-weight:bold;margin-right:4px;">[BUG]</span> ' : '';
    row.innerHTML = `<div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div><div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:500;">${prefix}${t['ì œëª©']} ${t['ìƒì„¸ë‚´ìš©']?'<span style="font-size:0.75rem;color:#94a3b8;margin-left:4px;">ğŸ“</span>':''} ${badgeHtml}</div>`;
    container.appendChild(row); return container;
  }

  // ğŸš€ [ë³€ê²½] ê²Œì‹œíŒ ë·° (ë²„ê·¸ ì œì™¸)
  function renderBoardView() {
    const tbody = document.getElementById('board-table-body'); tbody.innerHTML = "";
    // ë²„ê·¸ì™€ ì•„ì´ë””ì–´ëŠ” ì œì™¸
    const boardTasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸').sort((a,b) => (a['ìƒíƒœ']==='ì™„ë£Œ'?1:-1));
    if(boardTasks.length === 0) { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#cbd5e1;">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
    boardTasks.forEach(t => {
      const tr = document.createElement('tr'); const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      let pathHtml = `<span style="color:#cbd5e1;">(ë¯¸ë¶„ë¥˜)</span>`;
      const midId = (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").split(',')[0];
      const mid = g_goals.find(g=>g.ID===midId);
      if(mid) { const big = g_goals.find(g=>g.ID===mid['ìƒìœ„ID']); const bgCol = big ? (big['ìƒ‰ìƒ'] || "#94a3b8") : "#94a3b8"; pathHtml = `<div class="path-badge" style="background:${bgCol};">${big?big['ì œëª©']:'?'} > ${mid['ì œëª©']}</div>`; }
      tr.onclick = function() { openEditModal('task', t.ID); };
      const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
      const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';
      tr.innerHTML = `<td style="text-align:center;"><div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div></td><td>${pathHtml}</td><td><div style="font-weight:600; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}">${t['ì œëª©']} ${badgeHtml}</div></td><td style="color:#64748b; font-size:0.85rem;">${t['ê¸°í•œ'] ? t['ê¸°í•œ'].slice(5) : '-'}</td>`;
      tbody.appendChild(tr);
    });
  }

// ğŸš€ [ìˆ˜ì •] ë²„ê·¸ íŠ¸ë˜ì»¤ ë Œë”ë§ (ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€)
  function renderBugView() {
    const root = document.getElementById('bug-grid-root');
    root.innerHTML = "";
    
    // ì•„ì¹´ì´ë¸Œ ì²´í¬ ì—¬ë¶€ í™•ì¸
    const showArchive = document.getElementById('toggle-bug-archive') ? document.getElementById('toggle-bug-archive').checked : false;

    // í•„í„°ë§
    const bugs = g_tasks.filter(t => {
      if (t['ìœ í˜•'] !== 'ë²„ê·¸') return false;
      if (showArchive) return t['ìƒíƒœ'] === 'ì™„ë£Œ'; 
      else return t['ìƒíƒœ'] !== 'ì™„ë£Œ'; 
    });
    
    // ì •ë ¬
    bugs.sort((a,b) => (b['ID'] > a['ID'] ? 1 : -1));

    if(bugs.length === 0) { 
        root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${showArchive ? 'í•´ê²°ëœ ë²„ê·¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë°œê²¬ëœ ë²„ê·¸ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰'}</div>`; 
        return; 
    }

    bugs.forEach(t => {
      const card = document.createElement('div');
      
      const isWorking = t['ìƒíƒœ'] === 'ì§„í–‰ì¤‘';
      const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';

      card.className = `bug-card ${isWorking ? 'working' : ''}`;
      
      let parentTitle = "";
      if (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) {
        const parent = g_tasks.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) || g_goals.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']);
        if (parent) parentTitle = parent['ì œëª©'];
      }
      
      const plainText = (t['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";

      // ğŸš€ [ìˆ˜ì •] ë²„íŠ¼ ë¡œì§ ê°œì„  (+ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
      let buttonsHtml = "";
      
      // ê³µí†µ ì‚­ì œ ë²„íŠ¼ (ìš°ì¸¡ ëì— ë°°ì¹˜í•˜ê¸° ìœ„í•´ ìŠ¤íƒ€ì¼ ì¡°ì • í•„ìš”)
      const deleteBtn = `<button class="bug-btn delete-bug" onclick="deleteItem('${t.ID}')" style="flex:0 0 auto; width:36px; background:#fff1f2; color:#ef4444; margin-left:4px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>`;

      if (isDone) {
          buttonsHtml = `
            <button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ë¯¸í•´ê²°/ë³µêµ¬</button>
            ${deleteBtn}
          `;
      } else {
          if (isWorking) {
              buttonsHtml = `
                <button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ì·¨ì†Œ</button>
                <button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">âœ… í•´ê²° ì™„ë£Œ!</button>
                ${deleteBtn}
              `;
          } else {
              buttonsHtml = `
                <button class="bug-btn check" onclick="toggleStatus('${t.ID}', 'ì§„í–‰ì¤‘')">ğŸ” í™•ì¸ ì‹œì‘</button>
                <button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">ë°”ë¡œ í•´ê²°</button>
                ${deleteBtn}
              `;
          }
      }

      card.innerHTML = `
        ${isWorking ? `<div class="bug-status-badge">ğŸ”¥ í™•ì¸ì¤‘</div>` : ''} 
        
        <div class="bug-content" onclick="openEditModal('task', '${t.ID}')" style="cursor:pointer; flex-grow:1;">
          <div class="bug-parent-info">
             ${parentTitle ? `<span>ğŸ”— ${parentTitle}</span>` : '<span>(ì—°ë™ ì‘ì—… ì—†ìŒ)</span>'}
          </div>
          <div class="bug-title">${t['ì œëª©']}</div>
          <div class="bug-body">${plainText}</div>
        </div>
        
        <div class="bug-footer">
          ${buttonsHtml}
        </div>
      `;
      root.appendChild(card);
    });
  }


// ğŸš€ [ìˆ˜ì •] ì•„ì´ë””ì–´ ë·° (ì‹¤í˜„ ì·¨ì†Œ + ì‚­ì œ ë²„íŠ¼ì´ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ìˆ˜ì •)
  function renderIdeaView() {
    const root = document.getElementById('idea-grid-root'); 
    root.innerHTML = "";
    
    // ì•„ì¹´ì´ë¸Œ ì²´í¬ ì—¬ë¶€
    const archiveToggle = document.getElementById('toggle-archive');
    const showArchive = archiveToggle ? archiveToggle.checked : false;
    
    const ideas = g_tasks.filter(t => {
      if (t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´') return false;
      if (showArchive) return t['ìƒíƒœ'] === 'ì™„ë£Œ'; 
      else return t['ìƒíƒœ'] !== 'ì™„ë£Œ'; 
    });

    // ì •ë ¬: ìµœì‹ ìˆœ
    ideas.sort((a,b) => (b['ID'] > a['ID'] ? 1 : -1));

    if(ideas.length === 0) { 
      root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${showArchive ? 'ë³´ê´€ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>`; 
      return; 
    }

    ideas.forEach(item => {
      const card = document.createElement('div'); 
      
      // ì‹¤í˜„ ì—¬ë¶€ í™•ì¸ (ì—°ê²°ëœ IDê°€ ìˆê³ , ë¹ˆì¹¸ì´ ì•„ë‹ˆë©´ ì‹¤í˜„ëœ ê²ƒ)
      const realizedId = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']; 
      const isRealized = realizedId && realizedId.trim().length > 0; 

      card.className = `idea-card ${isRealized ? 'realized' : ''}`;
      
      const dateStr = item['ê¸°í•œ'] ? `ğŸ“… ${item['ê¸°í•œ'].split('T')[0]}` : "";
      const plainText = (item['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";

      // ğŸ”˜ ë²„íŠ¼ ë¡œì§ ìƒì„±
      let actionBtn = "";
      
      // ê³µí†µ ì‚­ì œ ë²„íŠ¼ (ë¹¨ê°„ íœ´ì§€í†µ)
      const deleteBtn = `<button class="idea-btn delete-idea" onclick="deleteItem('${item.ID}')" style="flex:0 0 auto; width:36px; background:#fff1f2; color:#ef4444; margin-left:4px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>`;

      if (item['ìƒíƒœ'] !== 'ì™„ë£Œ') {
          if (isRealized) {
              // âœ… [í•µì‹¬] ì´ë¯¸ ì‹¤í˜„ë¨ -> 'ì‘ì—… ë³´ê¸°' ì™€ 'ì‹¤í˜„ ì·¨ì†Œ' ë²„íŠ¼ ë‘ ê°œê°€ ë‚˜ì™€ì•¼ í•¨
              actionBtn = `
                <button class="idea-btn" style="background:#eff6ff; color:#3b82f6; font-weight:700;" onclick="openEditModal('task', '${realizedId}')">ğŸ‘‰ ì‘ì—… ë³´ê¸°</button>
                <button class="idea-btn" style="background:#f1f5f9; color:#64748b;" onclick="cancelRealization('${item.ID}')">â†©ï¸ ì·¨ì†Œ</button>
              `;
          } else {
              // ì‹¤í˜„ ì•ˆ ë¨ -> 'ì‹¤í˜„' ë²„íŠ¼
              actionBtn = `<button class="idea-btn plan" onclick="convertIdeaToTask('${item.ID}')">ğŸš€ ì‹¤í˜„</button>`;
          }
      } else {
          // ì™„ë£Œ(ë³´ê´€) ìƒíƒœ -> 'ë³µêµ¬' ë²„íŠ¼
          actionBtn = `<button class="idea-btn done" onclick="toggleStatus('${item.ID}', 'ëŒ€ê¸°')">â†©ï¸ ë³µêµ¬</button>`;
      }

      // ë³´ê´€ ë²„íŠ¼ (ì‹¤í˜„ ì•ˆ ëœ ìƒíƒœì—ì„œë§Œ ë³´ê´€ ê°€ëŠ¥í•˜ë„ë¡)
      const archiveBtn = (item['ìƒíƒœ'] !== 'ì™„ë£Œ' && !isRealized) 
          ? `<button class="idea-btn done" onclick="toggleStatus('${item.ID}', 'ì™„ë£Œ')">ğŸ—„ï¸ ë³´ê´€</button>` 
          : '';

      card.innerHTML = `
        ${isRealized ? `<div class="realized-badge">ğŸš€ ì‹¤í˜„ë¨</div>` : ''} 
        
        <div class="idea-header">
          ${dateStr ? `<div class="idea-date">${dateStr}</div>` : ''}
        </div>
        
        <div class="idea-content" onclick="openEditModal('idea', '${item.ID}')" style="cursor:pointer; flex-grow:1;">
          <div class="idea-title" style="${isRealized ? 'color:#2563eb;' : ''}">${item['ì œëª©']}</div>
          <div class="idea-body">${plainText}</div>
        </div>
        
        <div class="idea-footer">
          ${actionBtn}
          ${archiveBtn}
          ${deleteBtn}
        </div>
      `;
      root.appendChild(card);
    });
  }
// ğŸš€ [NEW] ì‹¤í˜„ ì·¨ì†Œ í•¨ìˆ˜ (ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì•ˆìª½, ë§¨ ë§ˆì§€ë§‰ì— ì¶”ê°€í•˜ì„¸ìš”)
  async function cancelRealization(ideaId) {
      if(!confirm("ì‹¤í˜„ ìƒíƒœë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ì‘ì—…ê³¼ì˜ ê³ ë¦¬ë¥¼ ëŠìŠµë‹ˆë‹¤.)")) return;
      
      if(typeof showAdminLoading === 'function') showAdminLoading("ì·¨ì†Œ ì¤‘...");
      
      try {
          // 'connectedId'ì— ê³µë°±(" ")ì„ ë³´ë‚´ì„œ ê¸°ì¡´ ì—°ê²° ì •ë³´ë¥¼ ì§€ì›ë‹ˆë‹¤.
          await fetch(window.CHEESE_ADMIN_API_BASE, { 
              method: "POST", 
              body: JSON.stringify({ 
                  mode: "editItem", 
                  id: ideaId, 
                  connectedId: " " 
              }) 
          });
          loadAllData(); // í™”ë©´ ê°±ì‹ 
      } catch(e) {
          console.error(e);
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
          if(typeof hideAdminLoading === 'function') hideAdminLoading();
      }
  }

  function convertIdeaToTask(ideaId) {
    const idea = g_tasks.find(t => t.ID === ideaId);
    if (!idea) return;
    openModal('í• ì¼');
    document.getElementById('origin-idea-id').value = ideaId;
    document.getElementById('input-title').value = idea['ì œëª©'];
    const memoContent = `<div style="background:#f0f9ff; padding:12px; border-left:4px solid #3b82f6; border-radius:4px; margin-bottom:15px; color:#1e40af;"><strong>ğŸš€ Design Memo Origin:</strong> ${idea['ì œëª©']}<div style="font-size:0.85rem; margin-top:4px; color:#60a5fa;">ì´ ì‘ì—…ì€ ì•„ì´ë””ì–´ í•¨ì—ì„œ ì‹¤í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.</div></div>${idea['ìƒì„¸ë‚´ìš©'] || ''}`;
    $('#input-detail').summernote('code', memoContent);
  }

// ğŸš€ [ìˆ˜ì •] ë¡œê·¸ ë Œë”ë§ (ë‚ ì§œ ë°€ë¦¼ í•´ê²° + ë‚ ì§œë³„ ê·¸ë£¹í™” ì ìš©)
  function renderLogs() {
    const root = document.getElementById('log-timeline-root'); 
    root.innerHTML = "";
    
    if(g_logs.length === 0) { 
      root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem; text-align:center; padding:20px;">ì‘ì—… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
      return; 
    }
    
    // 1. ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘
    const groupedLogs = {};
    g_logs.forEach(log => {
        let dateKey = 'ë‚ ì§œ ì—†ìŒ';
        if (log['ë‚ ì§œ']) {
            // âœ… [í•µì‹¬] UTC ë¬¸ìì—´ì„ ë¸Œë¼ìš°ì € ë¡œì»¬ ì‹œê°„ëŒ€(KST)ë¡œ ë³€í™˜
            const d = new Date(log['ë‚ ì§œ']);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateKey = `${year}-${month}-${day}`;
        }
        
        if (!groupedLogs[dateKey]) groupedLogs[dateKey] = [];
        groupedLogs[dateKey].push(log);
    });

    // 2. ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
    const sortedDates = Object.keys(groupedLogs).sort().reverse();

    // 3. ë Œë”ë§
    sortedDates.forEach(date => {
        // ë‚ ì§œ êµ¬ë¶„ì„ 
        const divider = document.createElement('div');
        divider.className = "log-date-divider";
        
        // êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ ì ìš© (CSSê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì¼ë¶€ ì ìš©)
        divider.style.cssText = "display:flex; align-items:center; margin:30px 0 15px; font-weight:700; color:#475569; font-size:0.9rem;";
        
        let dayOfWeek = "";
        try { dayOfWeek = new Date(date).toLocaleDateString('ko-KR', { weekday: 'short' }); } catch(e){}
        
        // êµ¬ë¶„ì„  HTML (before/after ê°€ìƒìš”ì†ŒëŠ” CSS í•„ìš”, ì—¬ê¸°ì„  ì‹¬í”Œí•˜ê²Œ í…ìŠ¤íŠ¸ë§Œ)
        divider.innerHTML = `<span style="background:#f1f5f9; padding:4px 12px; border-radius:20px;">ğŸ“… ${date} (${dayOfWeek})</span>`;
        root.appendChild(divider);

        // í•´ë‹¹ ë‚ ì§œì˜ ë¡œê·¸ë“¤ ì¶œë ¥
        groupedLogs[date].forEach(log => {
            const item = document.createElement('div'); 
            item.className = "log-item";
            
            const title = log['ì œëª©'] ? `<div class="log-title" style="font-weight:700; font-size:0.95rem; margin-bottom:4px;">${log['ì œëª©']}</div>` : '';
            
            let relatedHtml = "";
            if(log['ê´€ë ¨_ëª©í‘œID']) {
                const relTask = g_tasks.find(t => t.ID === log['ê´€ë ¨_ëª©í‘œID']) || g_goals.find(g => g.ID === log['ê´€ë ¨_ëª©í‘œID']);
                if(relTask) {
                    if (relTask['ìœ í˜•'] === 'ë²„ê·¸') { 
                        relatedHtml = `<div class="log-related" style="background:#fecaca; color:#b91c1c; border:1px solid #f87171; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ ë²„ê·¸ Fix: ${relTask['ì œëª©']}</div>`; 
                    } else { 
                        relatedHtml = `<div class="log-related" style="background:#ecfdf5; color:#059669; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ“Œ ê´€ë ¨: ${relTask['ì œëª©']}</div>`; 
                    }
                }
            }

            const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');

            item.innerHTML = `
                <div class="log-dot"></div>
                <div class="log-card">
                    <div class="log-header" style="margin-bottom: 4px;">
                        <div class="log-time" style="font-size:0.75rem; color:#94a3b8;">
                            ${log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : ''}
                        </div>
                        <div class="log-actions">
                            <button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button>
                            <button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    ${relatedHtml}
                    ${title}
                    <div class="log-body" style="font-size:0.9rem; color:#475569; line-height:1.6;">${content}</div>
                    ${log['íƒœê·¸'] ? `<div style="margin-top:8px;"><span class="log-tag" style="font-size:0.75rem; color:#3b82f6; background:#eff6ff; padding:2px 8px; border-radius:4px;">#${log['íƒœê·¸']}</span></div>` : ''}
                </div>`;
            root.appendChild(item);
        });
    });
  }

  function adjustColor(color, amount) { return color; } 
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function updateLogTaskOptions(selectedId = "") {
    const select = document.getElementById('log-related-id'); select.innerHTML = '<option value="">(ì—†ìŒ)</option>';
    const tasks = g_tasks.filter(t => (t['ìœ í˜•'] === 'í• ì¼' || t['ìœ í˜•'] === 'ë²„ê·¸') && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
    if(tasks.length > 0) { const group = document.createElement('optgroup'); group.label = "ì§„í–‰ ì¤‘ì¸ ì‘ì—… (í• ì¼/ë²„ê·¸)"; tasks.forEach(t => { const op = document.createElement('option'); op.value = t.ID; const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '[ğŸë²„ê·¸] ' : ''; op.textContent = prefix + t['ì œëª©']; group.appendChild(op); }); select.appendChild(group); }
    const mids = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    if(mids.length > 0) { const group2 = document.createElement('optgroup'); group2.label = "ì¤‘ê°„ ëª©í‘œ"; mids.forEach(m => { const op = document.createElement('option'); op.value = m.ID; op.textContent = m['ì œëª©']; group2.appendChild(op); }); select.appendChild(group2); }
    if(selectedId) select.value = selectedId;
  }

  function openLogModal() {
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-date').valueAsDate = new Date(); document.getElementById('log-edit-mode').value="false";
    document.getElementById('log-form').reset(); document.getElementById('log-idea-section').style.display='block'; updateLogTaskOptions();
  }

  function toggleEditMode(isEdit) {
    const form = document.getElementById('todo-form');
    const inputs = form.querySelectorAll('input, select');
    
    if (isEdit) {
      inputs.forEach(el => el.disabled = false);
      document.getElementById('edit-actions').style.display = 'flex';
      document.getElementById('view-actions').style.display = 'none';
      document.getElementById('btn-enable-edit').style.display = 'none';
      document.getElementById('detail-view-box').style.display = 'none';
      document.getElementById('detail-edit-wrapper').style.display = 'block';
      
      if (!$('#input-detail').summernote('exists')) {
        $('#input-detail').summernote({
          height: 250,
          toolbar: [['style', ['bold', 'italic', 'underline', 'clear']], ['font', ['strikethrough']], ['para', ['ul', 'ol']], ['insert', ['link', 'picture']], ['view', ['fullscreen', 'codeview']]]
        });
      }
    } else {
      inputs.forEach(el => el.disabled = true);
      document.getElementById('edit-actions').style.display = 'none';
      document.getElementById('view-actions').style.display = 'flex';
      document.getElementById('btn-enable-edit').style.display = 'block';
      const content = $('#input-detail').summernote('code');
      document.getElementById('detail-view-box').innerHTML = content;
      document.getElementById('detail-view-box').style.display = 'block';
      document.getElementById('detail-edit-wrapper').style.display = 'none';
    }
  }

  function openModal(type) {
    document.getElementById('input-modal').classList.add('open'); 
    document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡"; 
    document.getElementById('edit-mode').value = "false";
    document.getElementById('btn-delete-modal').style.display = "none"; 
    document.getElementById('related-history-section').style.display = "none";
    document.getElementById('related-idea-section').style.display = "none";
    document.getElementById('origin-idea-id').value = ""; 

    document.getElementById('todo-form').reset();
    $('#input-detail').summernote('reset'); 
    toggleEditMode(true);
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }

  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    if (isGoal) { document.getElementById('field-start-date').style.display = "block"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "none"; } 
    else { document.getElementById('field-start-date').style.display = "none"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "block"; }
    
    if (type === 'ë²„ê·¸') document.getElementById('input-priority').value = 'ë†’ìŒ';
    document.getElementById('field-color').style.display = (type === "í° ëª©í‘œ") ? "block" : "none";
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id'); select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    opts.forEach(o => { const op = document.createElement('option'); op.value = o.ID; op.textContent = o['ì œëª©']; select.appendChild(op); });
  }

  function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìƒì„¸";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('edit-id').value = id;
    document.getElementById('origin-idea-id').value = ""; 

    document.getElementById('input-title').value = item['ì œëª©'];
    const safeContent = item['ìƒì„¸ë‚´ìš©'] || "";
    $('#input-detail').summernote('code', safeContent);
    document.getElementById('detail-view-box').innerHTML = safeContent || "<span style='color:#ccc'>(ë‚´ìš© ì—†ìŒ)</span>";

    if (item['ìƒ‰ìƒ']) { const radio = document.querySelector(`input[name="color"][value="${item['ìƒ‰ìƒ']}"]`); if(radio) radio.checked = true; }
    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => { if(r.value === item['ìœ í˜•']) r.checked = true; });
    toggleFormFields();

    if (item['ìœ í˜•'].includes("ëª©í‘œ")) {
        document.getElementById('input-start').value = (item['ì‹œì‘ì¼']||"").split('T')[0];
        document.getElementById('input-due').value = (item['ë§ˆê°ì¼']||"").split('T')[0];
        if(item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
        document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
        document.getElementById('input-due').value = (item['ê¸°í•œ']||"").split('T')[0];
        document.getElementById('input-priority').value = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }
    toggleEditMode(false);
    
    const delBtn = document.getElementById('btn-delete-modal'); 
    delBtn.style.display = "block"; 
    delBtn.onclick = () => deleteFromModal();

    renderHistoryInModal(id);
    renderRelatedIdeasInModal(id);
  }

// ğŸš€ [ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ë Œë”ë§ (ë‚ ì§œ ë°€ë¦¼ í•´ê²° + ì ‘ê¸°/í¼ì¹˜ê¸°)
  function renderHistoryInModal(targetId) {
    const container = document.getElementById('related-history-section');
    const listRoot = document.getElementById('history-list-root');
    
    const relatedLogs = g_logs.filter(l => String(l['ê´€ë ¨_ëª©í‘œID']) === String(targetId));

    if (relatedLogs.length === 0) {
      container.style.display = 'none';
      return;
    }

    // ë‚ ì§œ ìµœì‹ ìˆœ ì •ë ¬
    relatedLogs.sort((a, b) => new Date(b['ë‚ ì§œ']) - new Date(a['ë‚ ì§œ']));

    container.style.display = 'block';
    listRoot.innerHTML = "";

    relatedLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = function() { this.classList.toggle('expanded'); };
        
        // âœ… [í•µì‹¬] ë‚ ì§œ ë³€í™˜ ë¡œì§ ì ìš©
        let dateStr = '';
        if (log['ë‚ ì§œ']) {
            const d = new Date(log['ë‚ ì§œ']);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateStr = `${year}-${month}-${day}`;
        }
        
        const timeStr = log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : '';
        const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');

        item.innerHTML = `
            <div class="history-header">
                <span class="history-date">ğŸ“… ${dateStr}</span>
                <span class="history-time">${timeStr}</span>
            </div>
            <div class="history-content">${content}</div>
        `;
        listRoot.appendChild(item);
    });
  }
  
  function renderRelatedIdeasInModal(targetId) {
    const container = document.getElementById('related-idea-section');
    const root = document.getElementById('related-idea-root');
    const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === targetId);

    if (relatedIdeas.length > 0) {
      container.style.display = 'block';
      root.innerHTML = relatedIdeas.map(idea => `
        <div class="mini-idea-card" onclick="openEditModal('idea', '${idea.ID}')">
          <div class="mini-idea-title">ğŸ’¡ ${idea['ì œëª©']}</div>
          <div class="mini-idea-desc">${(idea['ìƒì„¸ë‚´ìš©'] || '').replace(/<[^>]*>?/gm, '')}</div>
        </div>
      `).join('');
    } else {
      container.style.display = 'none';
    }
  }

  function createNewLogFromTask() {
    const taskId = document.getElementById('edit-id').value;
    const taskTitle = document.getElementById('input-title').value;
    if (!taskId) return;
    closeModal('input-modal');
    openLogModal(); 
    const relatedSelect = document.getElementById('log-related-id');
    if (relatedSelect) relatedSelect.value = taskId;
    document.getElementById('log-title').value = taskTitle + " ì‘ì—… ê¸°ë¡";
  }

  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id); if (!log) return;
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •"; document.getElementById('log-edit-mode').value = "true"; document.getElementById('log-edit-id').value = id;
    document.getElementById('log-date').value = (log['ë‚ ì§œ']||"").split('T')[0]; document.getElementById('log-title').value = log['ì œëª©'] || ""; document.getElementById('log-content').value = log['ë‚´ìš©'] || ""; document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || ""; document.getElementById('log-tags').value = log['íƒœê·¸'] || ""; document.getElementById('log-idea-section').style.display = 'none';
    updateLogTaskOptions(log['ê´€ë ¨_ëª©í‘œID']);
  }

  function deleteFromModal() { const id = document.getElementById('edit-id').value; deleteItem(id); closeModal('input-modal'); }
  async function toggleStatus(id, newStatus) { await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) }); loadAllData(); }
  async function deleteItem(id) { if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) }); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading(); }

  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('edit-mode').value === "true";
    const type = document.querySelector('input[name="type"]:checked').value;
    const color = document.querySelector('input[name="color"]:checked').value;
    const detailContent = $('#input-detail').summernote('code');
    const originIdeaId = document.getElementById('origin-idea-id').value;

    const payload = { 
        mode: isEdit ? "editItem" : "addItem", id: document.getElementById('edit-id').value, type: type, 
        title: document.getElementById('input-title').value, parentId: document.getElementById('input-connected-id').value, 
        connectedId: document.getElementById('input-connected-id').value, 
        detail: detailContent, 
        startDate: document.getElementById('input-start').value, dueDate: document.getElementById('input-due').value, 
        priority: document.getElementById('input-priority').value, color: color 
    };
    
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); 
    
    try {
        const response = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();

        if (!isEdit && result.id && originIdeaId) {
            await fetch(window.CHEESE_ADMIN_API_BASE, { 
                method: "POST", 
                body: JSON.stringify({ mode: "editItem", id: originIdeaId, connectedId: result.id }) 
            });
        }
        
        closeModal('input-modal'); loadAllData();
    } catch(err) {
        console.error(err);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
        if(typeof hideAdminLoading==='function') hideAdminLoading();
    }
  });

// ğŸš€ [ìˆ˜ì •] ë¡œê·¸ ì €ì¥ + ë²„ê·¸ ë™ì‹œ ë“±ë¡ + ìƒí˜¸ ì—°ë™ ë¡œì§
  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const isEdit = document.getElementById('log-edit-mode').value === "true";
    const relatedId = document.getElementById('log-related-id').value;
    
    // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    const dateVal = document.getElementById('log-date').value;
    const titleVal = document.getElementById('log-title').value;
    let contentVal = document.getElementById('log-content').value; // ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ let ì„ ì–¸
    const durationVal = document.getElementById('log-duration').value;
    const tagsVal = document.getElementById('log-tags').value;
    
    // ë²„ê·¸ ì…ë ¥ê°’ í™•ì¸
    const bugTitle = document.getElementById('log-bug-input') ? document.getElementById('log-bug-input').value.trim() : "";
    const bugDetail = document.getElementById('log-bug-detail') ? document.getElementById('log-bug-detail').value.trim() : "";

    if(typeof showAdminLoading === 'function') showAdminLoading("ì €ì¥ ì¤‘..."); 

    try {
      const requests = [];

      // 1. ë²„ê·¸ê°€ ìˆë‹¤ë©´ -> ë²„ê·¸ ë¨¼ì € ë“±ë¡ (ID í™•ë³´ë¥¼ ìœ„í•´? ë™ì‹œ ì‹¤í–‰í•´ë„ ë¬´ë°©í•˜ì§€ë§Œ ë…¼ë¦¬ì  ìˆœì„œ ê³ ë ¤)
      // í•˜ì§€ë§Œ Apps Scriptì˜ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ Promise.all ì‚¬ìš©
      // ëŒ€ì‹ , ë¡œê·¸ ë‚´ìš©ì— ë²„ê·¸ ì •ë³´ë¥¼ ì¶”ê°€í•¨
      
      if (!isEdit && bugTitle !== "") {
         // ë¡œê·¸ ë³¸ë¬¸ì— ìë™ ì¶”ê°€
         contentVal += `\n\n[System] ğŸ ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±ë¨: ${bugTitle}`;
         
         // ë²„ê·¸ ìƒì„¸ ë‚´ìš©ì— ë¡œê·¸ ì •ë³´ ì¶”ê°€
         const bugFullDetail = `${bugDetail}\n\n---\nğŸ“Œ ë°œê²¬ëœ ì‘ì—… ë¡œê·¸: ${titleVal || 'ì œëª© ì—†ëŠ” ë¡œê·¸'} (${dateVal})`;

         // ë²„ê·¸ ë“±ë¡ ìš”ì²­
         requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
           method: "POST", 
           body: JSON.stringify({ 
               mode: "addItem", 
               type: "ë²„ê·¸", 
               title: bugTitle, 
               detail: bugFullDetail, 
               priority: "ë†’ìŒ", 
               connectedId: relatedId // ë¶€ëª¨ ì‘ì—…ê³¼ ì—°ê²°
           }) 
         }));
      }

      // 2. ì•„ì´ë””ì–´ ìë™ ë“±ë¡ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      const ideaInput = document.getElementById('log-idea-input');
      if (!isEdit && ideaInput && ideaInput.value.trim() !== "") {
        requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
          method: "POST", 
          body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaInput.value, detail: "ì‘ì—… ë¡œê·¸ ì‘ì„± ì¤‘ íŒŒìƒë¨: " + titleVal, priority: "ë³´í†µ" }) 
        }));
      }

      // 3. ë¡œê·¸ ì €ì¥ ìš”ì²­ (ìˆ˜ì •ëœ ë‚´ìš© í¬í•¨)
      const logPayload = { 
        mode: isEdit ? "editItem" : "addLog", 
        id: document.getElementById('log-edit-id').value, 
        date: dateVal, 
        title: titleVal, 
        content: contentVal, // ë²„ê·¸ ì •ë³´ê°€ ì¶”ê°€ëœ ë‚´ìš©
        duration: durationVal, 
        tags: tagsVal,
        relatedId: relatedId
      };
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(logPayload) }));

      // ì „ì²´ ì‹¤í–‰
      await Promise.all(requests); 
      
      closeModal('log-modal'); 
      loadAllData(); 

    } catch (err) {
      console.error("ì €ì¥ ì‹¤íŒ¨:", err);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      if(typeof hideAdminLoading === 'function') hideAdminLoading();
    }
  });
</script>
</body>
</html>
