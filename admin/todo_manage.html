<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Cheese Lab í†µí•© í•  ì¼ ê´€ë¦¬</title>
  <link rel="stylesheet" href="./admin.css">

  <script>
    // âœ… ì‚¬ìš©ìë‹˜ì˜ Apps Script ì£¼ì†Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* === 1. ë ˆì´ì•„ì›ƒ & ë·° ì „í™˜ === */
    .dashboard-layout {
      display: grid; grid-template-columns: 2fr 1fr; gap: 24px; align-items: start;
    }
    @media (max-width: 900px) { .dashboard-layout { grid-template-columns: 1fr; } }

    /* ë·° ì „í™˜ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .view-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .view-tab-btn {
      padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
      border: none; background: transparent; color: #6b7280; cursor: pointer; transition: all 0.2s;
    }
    .view-tab-btn:hover { background: #f3f4f6; color: #374151; }
    .view-tab-btn.active { background: #eff6ff; color: #2563eb; }

    /* === 2. ì¹´ë“œ ë·° (ê¸°ì¡´) === */
    .goal-card {
      background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid rgba(0,0,0,0.05);
    }
    .goal-card-header {
      background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
      color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;
    }
    .goal-card-title { font-size: 1.2rem; font-weight: 800; }
    .goal-card-status { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; backdrop-filter: blur(4px); }
    
    .mid-goal-group { margin-top: 16px; }
    .mid-goal-item { border-left: 4px solid #10b981; background: #f9fafb; border-radius: 0 8px 8px 0; overflow: hidden; }
    .mid-goal-header { padding: 12px 16px; font-weight: 700; color: #374151; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .mid-goal-header:hover { background: #f3f4f6; }
    
    .task-list { background: #fff; border-top: 1px solid #f3f4f6; }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; }
    .task-row:hover { background: #fdfdfd; }
    .check-circle {
      width: 22px; height: 22px; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0;
    }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; }

    /* === 3. [NEW] ê²Œì‹œíŒ(ë³´ë“œ) ë·° === */
    .board-container { background: #fff; border-radius: 16px; border: 1px solid #e5e7eb; overflow: hidden; }
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .board-table th { background: #f9fafb; padding: 12px 16px; text-align: left; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    .board-table td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
    .board-table tr:last-child td { border-bottom: none; }
    .board-table tr:hover { background: #fdfdfd; }

    /* ê²½ë¡œ ë±ƒì§€ (í°ëª©í‘œ > ì¤‘ê°„ëª©í‘œ) */
    .path-badge { display: inline-flex; align-items: center; font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; margin-bottom: 4px; }
    .path-arrow { margin: 0 4px; color: #9ca3af; }
    
    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
    .sb-pending { background: #eff6ff; color: #2563eb; }
    .sb-done { background: #ecfdf5; color: #059669; }

    /* === 4. ë¡œê·¸ & ê³µí†µ === */
    .log-container {
      background: #fff; border-radius: 16px; padding: 24px; border: 1px solid #e5e7eb;
      position: sticky; top: 80px; max-height: calc(100vh - 100px); overflow-y: auto;
    }
    .timeline { position: relative; padding-left: 24px; margin-top: 24px; border-left: 2px solid #e5e7eb; }
    .timeline-item { position: relative; margin-bottom: 30px; }
    .timeline-dot { position: absolute; left: -31px; top: 5px; width: 12px; height: 12px; background: #3b82f6; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 0 0 2px #dbeafe; }
    .timeline-content { background: #f9fafb; padding: 12px 14px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; color: #374151; white-space: pre-wrap; }
    
    /* FAB & Modal (ê¸°ì¡´ ë™ì¼) */
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: #2563eb; }
    .fab-sub { width: 48px; height: 48px; background: #4b5563; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }
    
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: #111827; margin: 0;">Dashboard</h2>
        <p style="color: #6b7280; margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ê³¼ í•˜ë£¨ ê¸°ë¡ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>

      <div class="dashboard-layout">
        
        <div>
          <div class="view-tabs">
            <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ì¹´ë“œ ë·° (ê³„ì¸µí˜•)</button>
            <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ ë·° (ì „ì²´ëª©ë¡)</button>
          </div>

          <div id="view-card-container">
            <div id="goal-tree-root">
              <div class="card" style="padding:40px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <div id="view-board-container" style="display:none;">
            <div class="board-container">
              <table class="board-table">
                <thead>
                  <tr>
                    <th style="width:50px;">ìƒíƒœ</th>
                    <th>ë¶„ë¥˜ / ê²½ë¡œ</th>
                    <th>ì œëª©</th>
                    <th style="width:100px;">ê¸°í•œ</th>
                    <th style="width:80px;">ìš°ì„ ìˆœìœ„</th>
                  </tr>
                </thead>
                <tbody id="board-table-body">
                  </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="log-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">ğŸ“ ì‘ì—… ë¡œê·¸</h3>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openLogModal()">+ ê¸°ë¡í•˜ê¸°</button>
          </div>
          <div class="timeline" id="log-timeline-root"></div>
        </div>

      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <h3 style="margin:0 0 20px 0;">ìƒˆ í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      <div class="field admin-field-full">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f9fafb; padding:10px; border-radius:8px;">
          <label><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>
      <div class="field admin-field-full" id="field-parent">
        <label>ì—°ê²°ëœ ëª©í‘œ</label>
        <select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select>
      </div>
      <div class="field admin-field-full">
        <label>ì œëª©</label>
        <input type="text" id="input-title" required>
      </div>
      <div class="field admin-field-full" id="field-detail" style="display:none;">
        <label>ìƒì„¸ ë‚´ìš©</label>
        <textarea id="input-detail"></textarea>
      </div>
      <div class="field" id="field-date">
         <label>ë§ˆê° ê¸°í•œ</label>
         <input type="date" id="input-due">
      </div>
      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center;">ì €ì¥í•˜ê¸°</button>
        <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 style="margin:0 0 20px 0;">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title" placeholder="ë¹„ì›Œë‘ë©´ ë‚ ì§œë¡œ í‘œì‹œ"></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      <div class="field admin-field-full" style="background:#f5f3ff; padding:16px; border-radius:12px; border:1px dashed #8b5cf6;">
        <label style="color:#6d28d9; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ ìë™ ë“±ë¡ (ì„ íƒ)</label>
        <input type="text" id="log-idea-input" placeholder="ì…ë ¥ ì‹œ ì•„ì´ë””ì–´ ëª©ë¡ì— ì¶”ê°€ë¨" style="background:#fff;">
      </div>
      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags"></div>
      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center;">ì €ì¥</button>
        <button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals = [], g_tasks = [], g_logs = [];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading === 'function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals;
        g_tasks = json.tasks;
        g_logs  = json.logs || [];
        
        renderGoalTree();  // ì¹´ë“œ ë·° ë Œë”ë§
        renderBoardView(); // ê²Œì‹œíŒ ë·° ë Œë”ë§ (NEW)
        renderLogs();      // ë¡œê·¸ ë Œë”ë§
        updateParentOptions();
      } else { alert("ì‹¤íŒ¨: " + json.msg); }
    } catch(e) { console.error(e); } 
    finally { if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  }

  // ===========================================
  // [NEW] ë·° ì „í™˜ ë¡œì§
  // ===========================================
  function switchView(mode) {
    // íƒ­ ìŠ¤íƒ€ì¼
    document.getElementById('btn-view-card').classList.toggle('active', mode === 'card');
    document.getElementById('btn-view-board').classList.toggle('active', mode === 'board');
    
    // ì»¨í…Œì´ë„ˆ í‘œì‹œ
    document.getElementById('view-card-container').style.display = (mode === 'card') ? 'block' : 'none';
    document.getElementById('view-board-container').style.display = (mode === 'board') ? 'block' : 'none';
  }

  // ===========================================
  // [NEW] ê²Œì‹œíŒ(ë³´ë“œ) ë·° ë Œë”ë§
  // ===========================================
  function renderBoardView() {
    const tbody = document.getElementById('board-table-body');
    tbody.innerHTML = "";

    // 1. í‘œì‹œí•  í• ì¼/ì•„ì´ë””ì–´ë§Œ í•„í„°ë§ (ì™„ë£Œëœ ê²ƒë„ í¬í•¨í•˜ë˜ ì •ë ¬ ë“± ì²˜ë¦¬ ê°€ëŠ¥)
    // ì—¬ê¸°ì„œëŠ” ì „ì²´ íƒœìŠ¤í¬ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
    const allTasks = [...g_tasks];

    // ì •ë ¬: ëŒ€ê¸°ì¤‘ -> ì™„ë£Œë¨ ìˆœì„œ, ê·¸ ì•ˆì—ì„œ ë§ˆê°ì¼ ìˆœ
    allTasks.sort((a, b) => {
      if (a['ìƒíƒœ'] === b['ìƒíƒœ']) return 0;
      return a['ìƒíƒœ'] === 'ì™„ë£Œ' ? 1 : -1;
    });

    if (allTasks.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    allTasks.forEach(task => {
      // ë¶€ëª¨ ê²½ë¡œ ì°¾ê¸° (íƒœìŠ¤í¬ -> ì¤‘ê°„ëª©í‘œ -> í°ëª©í‘œ)
      let pathHtml = `<span style="color:#aaa;">(ë¯¸ë¶„ë¥˜)</span>`;
      const midIdRaw = String(task['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] || "");
      // ì²« ë²ˆì§¸ ì—°ê²°ëœ ì¤‘ê°„ëª©í‘œë§Œ ëŒ€í‘œë¡œ í‘œì‹œ (ì‰¼í‘œë¡œ ì—¬ëŸ¬ê°œì¼ ê²½ìš°)
      const midId = midIdRaw.split(',')[0].trim();
      
      const midGoal = g_goals.find(g => g.ID === midId);
      if (midGoal) {
        const bigGoal = g_goals.find(g => g.ID === midGoal['ìƒìœ„ID']);
        const bigTitle = bigGoal ? bigGoal['ì œëª©'] : "?";
        pathHtml = `
          <div class="path-badge">
            ${bigTitle} <span class="path-arrow">â€º</span> ${midGoal['ì œëª©']}
          </div>
        `;
      } else if (task['ìœ í˜•'] === 'ì•„ì´ë””ì–´') {
        pathHtml = `<div class="path-badge" style="background:#f3e8ff; color:#7c3aed;">ğŸ’¡ ì•„ì´ë””ì–´</div>`;
      }

      const tr = document.createElement('tr');
      const isDone = task['ìƒíƒœ'] === 'ì™„ë£Œ';

      tr.innerHTML = `
        <td style="text-align:center;">
           <div class="check-circle ${isDone?'checked':''}" 
                onclick="toggleTaskStatus('${task.ID}', '${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"
                title="ìƒíƒœ ë³€ê²½"></div>
        </td>
        <td>
          ${pathHtml}
        </td>
        <td>
          <div style="font-weight:600; text-decoration:${isDone?'line-through':''}; color:${isDone?'#9ca3af':'#374151'}">
            ${task['ì œëª©']}
          </div>
          ${task['ìƒì„¸ë‚´ìš©'] ? `<div style="font-size:0.8rem; color:#9ca3af; margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:300px;">${task['ìƒì„¸ë‚´ìš©']}</div>` : ''}
        </td>
        <td>
          ${task['ê¸°í•œ'] ? `<span style="color:#6b7280;">${task['ê¸°í•œ'].slice(5)}</span>` : '-'}
        </td>
        <td>
          ${task['ìš°ì„ ìˆœìœ„'] === 'ë†’ìŒ' ? '<span style="color:#ef4444; font-weight:700;">ğŸ”¥ ë†’ìŒ</span>' : '<span style="color:#9ca3af;">ë³´í†µ</span>'}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===========================================
  // ê¸°ì¡´ ë Œë”ë§ ë¡œì§ (ì¹´ë“œ ë·°) - ë³€ê²½ ì—†ìŒ
  // ===========================================
  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root');
    root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    
    if(bigGoals.length === 0) {
      root.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">ë“±ë¡ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }
    bigGoals.forEach(bg => {
      const card = document.createElement('div');
      card.className = "goal-card";
      card.innerHTML = `<div class="goal-card-header"><div class="goal-card-title">${bg['ì œëª©']}</div><div class="goal-card-status">${bg['ìƒíƒœ']}</div></div>`;
      
      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      const body = document.createElement('div');
      body.style.padding = "10px 20px 20px";
      
      if(midGoals.length === 0) {
        body.innerHTML = `<div style="padding:20px 0; font-size:0.9rem; color:#999; text-align:center;">í•˜ìœ„ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      } else {
        midGoals.forEach(mg => {
          const midGroup = document.createElement('div');
          midGroup.className = "mid-goal-group";
          const midItem = document.createElement('div');
          midItem.className = "mid-goal-item";
          midItem.innerHTML = `<div class="mid-goal-header" onclick="toggleDisplay(this)"><span>ğŸš© ${mg['ì œëª©']}</span><span style="font-size:0.8rem; color:#888;">â–¼</span></div>`;

          const taskList = document.createElement('div');
          taskList.className = "task-list";
          const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
          if(tasks.length === 0) {
             taskList.innerHTML = `<div style="padding:15px; font-size:0.85rem; color:#aaa;">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
          } else {
             tasks.forEach(t => {
               const row = document.createElement('div');
               row.className = "task-row";
               const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
               row.innerHTML = `<div class="check-circle ${isDone?'checked':''}" onclick="toggleTaskStatus('${t.ID}', '${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div><div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#9ca3af':''};">${t['ì œëª©']}</div>`;
               taskList.appendChild(row);
             });
          }
          midItem.appendChild(taskList);
          midGroup.appendChild(midItem);
          body.appendChild(midGroup);
        });
      }
      card.appendChild(body);
      root.appendChild(card);
    });
  }

  function renderLogs() {
    const root = document.getElementById('log-timeline-root');
    root.innerHTML = "";
    if(g_logs.length === 0) { root.innerHTML = `<div style="color:#999; font-size:0.9rem;">ê¸°ë¡ ì—†ìŒ</div>`; return; }
    g_logs.slice(0, 20).forEach(log => {
      const item = document.createElement('div');
      item.className = "timeline-item";
      const dateStr = log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : '';
      const title = log['ì œëª©'] || "";
      const headerHtml = title ? `<div class="timeline-date">${dateStr}</div><div class="timeline-title">${title}</div>` : `<div class="timeline-title" style="font-size:0.95rem;">${dateStr} ê¸°ë¡</div>`;
      item.innerHTML = `<div class="timeline-dot"></div><div class="timeline-header">${headerHtml}</div><div class="timeline-content">${log['ë‚´ìš©']}${log['íƒœê·¸']?`<div><span class="timeline-tag">${log['íƒœê·¸']}</span></div>`:''}</div>`;
      root.appendChild(item);
    });
  }

  // === ê³µí†µ ë¡œì§ ===
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function openLogModal() { document.getElementById('log-modal').classList.add('open'); document.getElementById('log-date').valueAsDate = new Date(); }
  function openModal(type) { document.getElementById('input-modal').classList.add('open'); if(type) document.querySelector(`input[name="type"][value="${type}"]`).click(); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  
  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    document.getElementById('field-date').style.display = isGoal ? "none" : "block";
    document.getElementById('field-detail').style.display = isGoal ? "none" : "block";
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id');
    select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    opts.forEach(o => { const op = document.createElement('option'); op.value = o.ID; op.textContent = o['ì œëª©']; select.appendChild(op); });
  }

  async function toggleTaskStatus(id, newStatus) {
    if(typeof showAdminLoading === 'function') showAdminLoading("ìƒíƒœ ë³€ê²½ ì¤‘...");
    await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) });
    loadAllData();
    if(typeof hideAdminLoading === 'function') hideAdminLoading();
  }

  // í¼ ì œì¶œ
  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const type = document.querySelector('input[name="type"]:checked').value;
    const parentId = document.getElementById('input-connected-id').value;
    const payload = {
        mode: "addItem", type: type, title: document.getElementById('input-title').value,
        parentId: parentId, connectedId: parentId, 
        detail: document.getElementById('input-detail').value, dueDate: document.getElementById('input-due').value
    };
    if(typeof showAdminLoading === 'function') showAdminLoading("ì €ì¥ ì¤‘...");
    await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
    closeModal('input-modal'); loadAllData();
    if(typeof hideAdminLoading === 'function') hideAdminLoading();
  });

  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const dateVal = document.getElementById('log-date').value;
    const logTitle = document.getElementById('log-title').value;
    const contentVal = document.getElementById('log-content').value;
    const ideaVal = document.getElementById('log-idea-input').value; 
    
    if(typeof showAdminLoading === 'function') showAdminLoading("ê¸°ë¡ ì €ì¥ ì¤‘...");
    const requests = [];
    requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "addLog", date: dateVal, title: logTitle, content: contentVal, duration: document.getElementById('log-duration').value, tags: document.getElementById('log-tags').value }) }));
    if (ideaVal.trim() !== "") {
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaVal, detail: "ë¡œê·¸ì—ì„œ íŒŒìƒë¨", priority: "ë³´í†µ", parentId: "", connectedId: "" }) }));
    }
    await Promise.all(requests);
    closeModal('log-modal'); document.getElementById('log-form').reset(); loadAllData();
    if(typeof hideAdminLoading === 'function') hideAdminLoading();
  });
</script>
</body>
</html>
