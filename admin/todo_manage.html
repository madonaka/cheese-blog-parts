<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í†µí•© í•  ì¼ ê´€ë¦¬ - Cheese Lab</title>
  <link rel="stylesheet" href="./admin.css">
  <style>
    /* í• ì¼ ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .todo-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* ê³„ì¸µí˜• ë“¤ì—¬ì“°ê¸° & ë¼ì¸ */
    .tree-node {
      position: relative;
      margin-left: 20px;
      padding-left: 15px;
      border-left: 2px solid #e5e7eb;
    }
    .tree-root { margin-left: 0; padding-left: 0; border-left: none; }
    
    /* ì•„ì½”ë””ì–¸ í—¤ë” ì»¤ìŠ¤í…€ */
    .goal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .goal-header:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    
    .goal-big { border-left: 5px solid var(--primary); background: #fdfdfd; }
    .goal-mid { border-left: 5px solid #10b981; margin-top: 4px; }
    
    /* íƒœìŠ¤í¬ ì•„ì´í…œ */
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #fff;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.9rem;
    }
    .task-item:last-child { border-bottom: none; }
    .task-item.is-idea { background: #fbf7ff; } /* ì•„ì´ë””ì–´ëŠ” ì—°ë³´ë¼ ë°°ê²½ */
    
    .task-meta { display: flex; gap: 8px; font-size: 0.75rem; color: #6b7280; }
    
    /* ìƒíƒœê°’ ë±ƒì§€ */
    .badge-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #eee; }
    .bs-ing { background: #dbeafe; color: #1e40af; }
    .bs-done { background: #d1fae5; color: #065f46; text-decoration: line-through; }
    
    /* í”Œë¡œíŒ… ì…ë ¥ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
    .fab-btn {
      position: fixed;
      bottom: 30px; right: 30px;
      width: 56px; height: 56px;
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4);
      border: none;
      font-size: 24px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
      transition: transform 0.2s;
    }
    .fab-btn:hover { transform: scale(1.1); }
    
    /* ì…ë ¥ ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 2000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      width: 90%; max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
  </style>
  <script src="./admin-common.js" defer></script>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>

  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content todo-container">
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">í”„ë¡œì íŠ¸ & í•  ì¼</h2>
          <div class="admin-btn-group">
            <button class="btn btn-primary" onclick="openModal('ì•„ì´ë””ì–´')">âœ¨ ì•„ì´ë””ì–´ ë“±ë¡</button>
            <button class="btn" onclick="loadAllData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="dashboard-stat">
            <div class="dashboard-stat-label">ì§„í–‰ì¤‘ì¸ í° ëª©í‘œ</div>
            <div class="dashboard-stat-value" id="stat-goal-count">-</div>
          </div>
          <div class="dashboard-stat">
            <div class="dashboard-stat-label">ì˜¤ëŠ˜ ë§ˆê°</div>
            <div class="dashboard-stat-value" style="color:#dc2626;" id="stat-urgent-count">-</div>
          </div>
          <div class="dashboard-stat">
            <div class="dashboard-stat-label">ìŒ“ì¸ ì•„ì´ë””ì–´</div>
            <div class="dashboard-stat-value" style="color:#7c3aed;" id="stat-idea-count">-</div>
          </div>
        </div>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="filterView('tree')">ğŸŒ³ ê³„ì¸µ ë³´ê¸°</button>
        <button class="btn" onclick="filterView('flat')">ğŸ“… ë§ˆê°ìˆœ ë³´ê¸°</button>
        <button class="btn" onclick="filterView('idea')">ğŸ’¡ ì•„ì´ë””ì–´ë§Œ</button>
      </div>

      <div id="todo-list-root">
        </div>

    </section>
  </main>
</div>

<button class="fab-btn" onclick="openModal('í• ì¼')">+</button>

<div id="input-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 class="card-title" style="margin-bottom:15px;" id="modal-title">ìƒˆ í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      
      <div class="field admin-field-full">
        <label>ìœ í˜• ì„ íƒ</label>
        <div style="display:flex; gap:10px;">
          <label><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-parent">
        <label>ì—°ê²°ëœ ëª©í‘œ</label>
        <select id="input-connected-id" style="width:100%;">
          <option value="">(ì„ íƒ ì—†ìŒ - ë‚˜ì¤‘ì— ë¶„ë¥˜)</option>
          </select>
      </div>

      <div class="field admin-field-full">
        <label>ì œëª©</label>
        <input type="text" id="input-title" required placeholder="ì˜ˆ: ì¡°ì„  5í¸ ìë£Œì¡°ì‚¬">
      </div>

      <div class="field admin-field-full" id="field-detail">
        <label>ìƒì„¸ ë‚´ìš© / ë©”ëª¨</label>
        <textarea id="input-detail" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>

      <div class="field" id="field-date">
        <label>ë§ˆê° ê¸°í•œ</label>
        <input type="date" id="input-due">
      </div>

      <div class="field" id="field-priority">
        <label>ìš°ì„ ìˆœìœ„</label>
        <select id="input-priority">
          <option value="ë†’ìŒ">ğŸ”¥ ë†’ìŒ</option>
          <option value="ë³´í†µ" selected>ë³´í†µ</option>
          <option value="ë‚®ìŒ">ë‚®ìŒ</option>
        </select>
      </div>

      <div class="field admin-field-full" style="margin-top:10px; display:flex; gap:10px;">
        <button type="submit" class="admin-logout-btn" style="background:var(--primary); flex:1;">ì €ì¥</button>
        <button type="button" class="btn" onclick="closeModal()" style="flex:1;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage"; // ë©”ë‰´ í•˜ì´ë¼ì´íŠ¸
  window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
  let g_goals = [];
  let g_tasks = [];

  document.addEventListener('DOMContentLoaded', loadAllData);

  // 1. ë°ì´í„° ë¡œë“œ
  async function loadAllData() {
    showAdminLoading("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      
      if(json.result === "success") {
        g_goals = json.goals;
        g_tasks = json.tasks;
        renderDashboardStats();
        renderTree(); // ê¸°ë³¸ ë·°
        updateParentOptions(); // ëª¨ë‹¬ì˜ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°±ì‹ 
      } else {
        alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + json.msg);
      }
    } catch(e) {
      console.error(e);
      alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
      hideAdminLoading();
    }
  }

  // 2. ê³„ì¸µí˜• ë Œë”ë§ (Core Logic)
  function renderTree() {
    const root = document.getElementById('todo-list-root');
    root.innerHTML = "";

    // (1) í° ëª©í‘œ ì°¾ê¸°
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    
    // (2) ë¶„ë¥˜ë˜ì§€ ì•Šì€ ì•„ì´ë””ì–´/í• ì¼ (ê³ ì•„ í•­ëª©) ì²˜ë¦¬ë¥¼ ìœ„í•œ ê°€ìƒ ê·¸ë£¹
    const orphanTasks = getTasksByParent(null); // ì—°ê²°IDê°€ ì—†ëŠ” ì• ë“¤

    // --- í° ëª©í‘œ ë£¨í”„ ---
    bigGoals.forEach(bg => {
      const bgEl = createGoalElement(bg, 'big');
      
      // ì¤‘ê°„ ëª©í‘œ ì°¾ê¸°
      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      
      // ì¤‘ê°„ ëª©í‘œ ë£¨í”„
      const midContainer = document.createElement('div');
      midContainer.className = "tree-node";
      midContainer.style.display = "none"; // ê¸°ë³¸ ì ‘í˜

      midGoals.forEach(mg => {
        const mgEl = createGoalElement(mg, 'mid');
        
        // í•  ì¼(íƒœìŠ¤í¬) ì°¾ê¸°
        const tasks = getTasksByParent(mg.ID);
        
        const taskContainer = document.createElement('div');
        taskContainer.className = "tree-node";
        taskContainer.style.display = "none";

        if(tasks.length === 0) {
            taskContainer.innerHTML = `<div style="padding:10px; color:#999; font-size:0.8rem;">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
            tasks.forEach(t => taskContainer.appendChild(createTaskElement(t)));
        }

        // ì¤‘ê°„ëª©í‘œ í´ë¦­ -> í• ì¼ í¼ì¹˜ê¸°
        mgEl.addEventListener('click', (e) => {
            e.stopPropagation(); // ë²„ë¸”ë§ ë°©ì§€
            toggleDisplay(taskContainer);
        });

        midContainer.appendChild(mgEl);
        midContainer.appendChild(taskContainer);
      });

      // í° ëª©í‘œ í´ë¦­ -> ì¤‘ê°„ëª©í‘œ í¼ì¹˜ê¸°
      bgEl.addEventListener('click', () => toggleDisplay(midContainer));

      root.appendChild(bgEl);
      root.appendChild(midContainer);
    });

    // --- ê¸°íƒ€(ë¯¸ë¶„ë¥˜) ì˜ì—­ ---
    if(orphanTasks.length > 0) {
        root.innerHTML += `<h3 style="margin-top:30px; padding-left:10px; color:#666;">ğŸ—‚ ë¯¸ë¶„ë¥˜ / ì•„ì´ë””ì–´ ë³´ê´€í•¨</h3>`;
        orphanTasks.forEach(t => root.appendChild(createTaskElement(t)));
    }
  }

  // Helper: íŠ¹ì • ì¤‘ê°„ëª©í‘œIDë¥¼ í¬í•¨í•˜ëŠ” íƒœìŠ¤í¬ ì°¾ê¸°
  function getTasksByParent(midId) {
    return g_tasks.filter(t => {
      const raw = String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] || "");
      if(!midId) return raw.trim() === ""; // ë¯¸ë¶„ë¥˜
      return raw.includes(midId);
    });
  }

  // UI ìƒì„±: ëª©í‘œ(Goal) ì—˜ë¦¬ë¨¼íŠ¸
  function createGoalElement(data, level) {
    const div = document.createElement('div');
    div.className = `goal-header goal-${level}`;
    div.innerHTML = `
      <div>
        <strong>${data['ì œëª©']}</strong>
        <span style="font-size:0.8rem; color:#666; margin-left:8px;">
          ${data['ìƒíƒœ']}
        </span>
      </div>
      <div style="font-size:0.8rem; color:#aaa;">â–¼</div>
    `;
    return div;
  }

  // UI ìƒì„±: í• ì¼(Task) ì—˜ë¦¬ë¨¼íŠ¸
  function createTaskElement(data) {
    const isIdea = data['ìœ í˜•'] === 'ì•„ì´ë””ì–´';
    const div = document.createElement('div');
    div.className = `task-item ${isIdea ? 'is-idea' : ''}`;
    
    // ìƒíƒœ ë±ƒì§€ í´ë˜ìŠ¤
    let statusClass = "bs-ing";
    if(data['ìƒíƒœ'] === "ì™„ë£Œ") statusClass = "bs-done";
    else if(data['ìƒíƒœ'] === "ëŒ€ê¸°") statusClass = "badge-status";

    div.innerHTML = `
      <div style="flex:1;">
        <div style="display:flex; align-items:center; gap:8px;">
            ${isIdea ? '<span style="font-size:12px;">ğŸ’¡</span>' : '<input type="checkbox" ' + (data['ìƒíƒœ'] === 'ì™„ë£Œ' ? 'checked' : '') + '>'}
            <span class="${statusClass}">${data['ì œëª©']}</span>
            ${data['ìš°ì„ ìˆœìœ„'] === 'ë†’ìŒ' ? 'ğŸ”¥' : ''}
        </div>
        <div class="task-meta">
            ${data['ê¸°í•œ'] ? 'ğŸ“… ' + data['ê¸°í•œ'].split('T')[0] : ''}
            ${data['ìƒì„¸ë‚´ìš©'] ? ' Â· ğŸ“ ë‚´ìš©ìˆìŒ' : ''}
        </div>
      </div>
      <div>
        <button class="btn btn-ghost" style="padding:4px;">â‹®</button>
      </div>
    `;
    
    // í´ë¦­ ì‹œ ìƒì„¸ ë³´ê¸° (ì¶”í›„ êµ¬í˜„ ê°€ëŠ¥)
    div.onclick = () => { /* ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° ë¡œì§ */ };
    
    return div;
  }

  function toggleDisplay(el) {
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  // 3. í†µê³„ ë Œë”ë§
  function renderDashboardStats() {
    document.getElementById('stat-goal-count').textContent = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && g['ìƒíƒœ'] === 'ì§„í–‰ì¤‘').length + "ê°œ";
    document.getElementById('stat-idea-count').textContent = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´').length + "ê°œ";
    
    // ì˜¤ëŠ˜ ë§ˆê° ê³„ì‚°
    const today = new Date().toISOString().slice(0,10);
    const urgent = g_tasks.filter(t => t['ê¸°í•œ'] && t['ê¸°í•œ'].startsWith(today)).length;
    document.getElementById('stat-urgent-count').textContent = urgent + "ê±´";
  }

  // 4. ì…ë ¥ ëª¨ë‹¬ ê´€ë ¨
  function openModal(defaultType) {
    document.getElementById('input-modal').classList.add('open');
    if(defaultType) {
        document.querySelector(`input[name="type"][value="${defaultType}"]`).click();
    }
  }
  function closeModal() {
    document.getElementById('input-modal').classList.remove('open');
    document.getElementById('todo-form').reset();
  }
  
  // ìœ í˜• ì„ íƒì— ë”°ë¥¸ í¼ í•„ë“œ í† ê¸€
  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    
    document.getElementById('field-priority').style.display = isGoal ? "none" : "flex";
    document.getElementById('field-date').style.display = isGoal ? "none" : "flex";
    document.getElementById('field-detail').style.display = isGoal ? "none" : "grid"; // gridë¡œ ì „ì²´ í­ ìœ ì§€
    
    // ì¤‘ê°„ëª©í‘œ/í• ì¼ì€ ìƒìœ„ ì—°ê²° í•„ìš”
    // í° ëª©í‘œëŠ” ìƒìœ„ ì—†ìŒ
    if (type === "í° ëª©í‘œ") {
        document.getElementById('field-parent').style.display = "none";
    } else {
        document.getElementById('field-parent').style.display = "grid";
        // í• ì¼/ì•„ì´ë””ì–´ -> ì¤‘ê°„ëª©í‘œ ëª©ë¡ ë³´ì—¬ì£¼ê¸°
        // ì¤‘ê°„ëª©í‘œ -> í°ëª©í‘œ ëª©ë¡ ë³´ì—¬ì£¼ê¸°
        updateParentOptions(type);
    }
  }

  function updateParentOptions(currentType) {
    const select = document.getElementById('input-connected-id');
    select.innerHTML = `<option value="">(ì„ íƒ ì—†ìŒ)</option>`;
    
    let options = [];
    if (!currentType || currentType === "í• ì¼" || currentType === "ì•„ì´ë””ì–´") {
        // ì¤‘ê°„ ëª©í‘œë“¤ë§Œ ë³´ì—¬ì¤Œ
        options = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    } else if (currentType === "ì¤‘ê°„ ëª©í‘œ") {
        // í° ëª©í‘œë“¤ë§Œ ë³´ì—¬ì¤Œ
        options = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    }

    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.ID;
        option.textContent = opt['ì œëª©'];
        select.appendChild(option);
    });
  }

  // í¼ ì œì¶œ
  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const type = document.querySelector('input[name="type"]:checked').value;
    const parentId = document.getElementById('input-connected-id').value;
    
    const payload = {
        mode: "addItem",
        type: type,
        title: document.getElementById('input-title').value,
        // ëª©í‘œì¼ ë• parentId, í• ì¼ì¼ ë• connectedIdë¡œ ì „ì†¡ (GASê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ê²Œ í•¨)
        parentId: parentId, 
        connectedId: parentId, 
        detail: document.getElementById('input-detail').value,
        dueDate: document.getElementById('input-due').value,
        priority: document.getElementById('input-priority').value
    };

    showAdminLoading("ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...");
    try {
        await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify(payload)
        });
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeModal();
        loadAllData(); // ìƒˆë¡œê³ ì¹¨
    } catch(err) {
        console.error(err);
        alert("ì €ì¥ ì‹¤íŒ¨");
    } finally {
        hideAdminLoading();
    }
  });

</script>
</body>
</html>
