<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cheese Lab Project</title>
  <link rel="stylesheet" href="./admin.css">

  <script>
    // âœ… Apps Script ë°°í¬ ì£¼ì†Œ ìœ ì§€
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* ... ê¸°ì¡´ CSS (ë ˆì´ì•„ì›ƒ, íƒ­, ì¹´ë“œ ë“±) ... */
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    .dashboard-layout { display: grid; grid-template-columns: 2fr 1.2fr; gap: 28px; align-items: start; }
    .dashboard-layout > div { min-width: 0; }
    @media (max-width: 1000px) { .dashboard-layout { grid-template-columns: 1fr; gap: 20px; } .admin-main { padding: 12px; } }
    .view-tabs { display: flex; gap: 6px; margin-bottom: 20px; background: #f1f5f9; padding: 4px; border-radius: 12px; width: 100%; max-width: fit-content; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .view-tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; border: none; background: transparent; color: var(--text-sub); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* Goal & Task Styles */
    .goal-card { background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); transition: transform 0.2s; position: relative; }
    .goal-card-header { padding: 18px 24px; color: white; display: flex; justify-content: space-between; align-items: flex-start; }
    .goal-card-title { font-size: 1.25rem; font-weight: 800; line-height: 1.3; max-width: 85%; }
    .goal-card-desc { font-size: 0.9rem; opacity: 0.95; margin-top: 6px; font-weight: 400; line-height: 1.4; white-space: pre-wrap; }
    .goal-date-badge { display: inline-block; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 8px; font-size: 0.75rem; margin-top: 6px; font-weight: 500; }
    .header-actions .action-btn { background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 6px; padding: 6px 10px; cursor: pointer; margin-left: 4px; }
    .mid-goal-group { padding: 0 20px 20px; }
    .mid-goal-item { margin-top: 16px; background: #fff; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); }
    .mid-date-info { font-size: 0.75rem; color: var(--text-sub); margin-left: 8px; font-weight: normal; }
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s; }
    .task-row:last-child { border-bottom: none; }
    .task-detail { display: none; padding: 12px 16px 16px 50px; background: #fcfcfc; color: var(--text-sub); font-size: 0.9rem; border-bottom: 1px solid var(--border-color); line-height: 1.6; }
    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .mid-goal-header:hover .row-actions, .task-row:hover .row-actions { opacity: 1; }
    @media(max-width:600px){ .row-actions { opacity: 1; } .mid-goal-group { padding: 0 10px 15px; } .mid-goal-header, .task-row { padding: 12px 12px; } }
    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: #94a3b8; }
    .row-btn:hover { color: var(--primary); } .row-btn.delete:hover { color: #ef4444; }

    /* Board View (Mobile Card Style) */
    .board-container { background: #fff; border-radius: 16px; border: 1px solid var(--border-color); overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); width: 100%; }
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; min-width: 600px; }
    .board-table th { background: #f8fafc; padding: 14px 16px; text-align: left; font-weight: 700; color: var(--text-sub); border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    .board-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; cursor: pointer; }
    .board-table tr:hover td { background: #fcfcfc; }
    .path-badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: #fff; background: #94a3b8; white-space: nowrap; }
    @media (max-width: 768px) {
        .board-container { background: transparent; border: none; box-shadow: none; overflow: visible; }
        .board-table { display: block; width: 100%; min-width: 0; }
        .board-table thead { display: none; }
        .board-table tbody { display: block; }
        .board-table tr { display: block; background: #fff; border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 12px; padding: 16px 16px 16px 48px; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .board-table td { display: block; padding: 0; border: none; text-align: left !important; margin-bottom: 6px; }
        .board-table td:nth-child(1) { position: absolute; left: 16px; top: 18px; width: auto; }
        .board-table td:nth-child(2) { margin-bottom: 8px; }
        .board-table td:nth-child(3) { font-size: 1.05rem; margin-bottom: 8px; font-weight: 600; }
        .board-table td:nth-child(4) { font-size: 0.85rem; color: var(--text-sub); }
        .board-table td:nth-child(4)::before { content: 'ğŸ“… ë§ˆê°: '; font-weight: 600; color: var(--primary); }
    }

    /* Idea Grid */
    .idea-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .idea-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.02); border-top: 4px solid #d8b4fe; }
    .idea-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .idea-title { font-weight: 700; font-size: 1rem; margin-bottom: 8px; color: #333; line-height: 1.4; }
    .idea-body { font-size: 0.9rem; color: #64748b; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .idea-date { margin-top: 12px; font-size: 0.75rem; color: #94a3b8; text-align: right; }

    /* Log Style */
    .log-container { background: #fff; border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); position: sticky; top: 80px; max-height: calc(100vh - 100px); overflow-y: auto; }
    .log-item { position: relative; padding-left: 24px; margin-bottom: 28px; }
    .log-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -30px; width: 2px; background: #e2e8f0; }
    .log-item:last-child::before { display: none; }
    .log-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary); border-radius: 50%; }
    .log-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; transition: box-shadow 0.2s; position: relative; }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .log-date { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; }
    .log-related { display: inline-block; font-size: 0.75rem; color: #059669; background: #ecfdf5; padding: 2px 8px; border-radius: 4px; font-weight: 600; margin-bottom: 6px; }
    .log-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .log-card:hover .log-actions { opacity: 1; }
    @media (max-width: 600px) { .log-actions { opacity: 1; position: relative; top:0; right:0; margin-left: auto; } .log-header { flex-wrap: wrap; gap: 8px; } }

    /* Utils & Modal */
    .color-options { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .color-radio { display: none; }
    .color-label { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-radio:checked + .color-label { transform: scale(1.1); box-shadow: 0 0 0 2px #fff, 0 0 0 4px #94a3b8; }
    .check-circle { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: var(--primary); }
    .fab-sub { width: 48px; height: 48px; background: #475569; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 28px; border-radius: 20px; width: 90%; max-width: 520px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    @media (max-width: 600px) { .date-group { flex-direction: column !important; gap: 10px !important; } .modal-box { width: 95% !important; padding: 20px !important; } }

    /* ğŸ”¥ [NEW] ëª¨ë‹¬ ë‚´ íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ */
    .history-section { margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .history-title { font-size: 0.9rem; font-weight: 700; color: #475569; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    .history-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; font-size: 0.85rem; }
    .history-date { font-weight: 600; color: var(--primary); font-size: 0.75rem; margin-bottom: 4px; }
    .history-content { color: #334155; line-height: 1.4; }
    
    /* ğŸ”¥ [NEW] ë¦¬ìŠ¤íŠ¸ ë‚´ ë¡œê·¸ ì¹´ìš´íŠ¸ ë°°ì§€ */
    .log-count-badge { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-flex; align-items: center; gap: 3px; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0;">Dashboard</h2>
        <p style="color: var(--text-sub); margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ í˜„í™©ê³¼ ê¸°ë¡</p>
      </div>

      <div class="dashboard-layout">
        <div>
          <div class="view-tabs">
            <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜•</button>
            <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ</button>
            <button class="view-tab-btn" onclick="switchView('idea')" id="btn-view-idea">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</button>
          </div>
          <div id="view-card-container"><div id="goal-tree-root"><div class="goal-card" style="padding:40px; text-align:center; color:#94a3b8; background:#f1f5f9;">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
          <div id="view-board-container" style="display:none;"><div class="board-container"><table class="board-table"><thead><tr><th style="width:50px; text-align:center;">ì™„ë£Œ</th><th>ê²½ë¡œ</th><th>ì œëª©</th><th style="width:110px;">ë§ˆê°ì¼</th></tr></thead><tbody id="board-table-body"></tbody></table></div></div>
          <div id="view-idea-container" style="display:none;"><div id="idea-grid-root" class="idea-grid"></div></div>
        </div>

        <div class="log-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700;">ğŸ“ ì‘ì—… ë¡œê·¸</h3>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="openLogModal()">+ ê¸°ë¡</button>
          </div>
          <div id="log-timeline-root"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="todo-modal-title" style="margin-top:0;">í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      <input type="hidden" id="edit-id"><input type="hidden" id="edit-mode" value="false">
      <div class="field admin-field-full"><label>ìœ í˜•</label><div style="display:flex; gap:12px; background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto;"><label style="white-space:nowrap;"><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label><label style="white-space:nowrap;"><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label><label style="white-space:nowrap;"><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label><label style="white-space:nowrap;"><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label></div></div>
      <div class="field admin-field-full" id="field-color" style="display:none;"><label>í…Œë§ˆ ìƒ‰ìƒ</label><div class="color-options"><label><input type="radio" name="color" value="#4f46e5" class="color-radio" checked><span class="color-label" style="background:#4f46e5;"></span></label><label><input type="radio" name="color" value="#059669" class="color-radio"><span class="color-label" style="background:#059669;"></span></label><label><input type="radio" name="color" value="#db2777" class="color-radio"><span class="color-label" style="background:#db2777;"></span></label><label><input type="radio" name="color" value="#d97706" class="color-radio"><span class="color-label" style="background:#d97706;"></span></label><label><input type="radio" name="color" value="#0891b2" class="color-radio"><span class="color-label" style="background:#0891b2;"></span></label><label><input type="radio" name="color" value="#475569" class="color-radio"><span class="color-label" style="background:#475569;"></span></label></div></div>
      <div class="field admin-field-full" id="field-parent"><label>ì—°ê²°ëœ ëª©í‘œ</label><select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select></div>
      <div class="field admin-field-full"><label>ì œëª©</label><input type="text" id="input-title" required></div>
      <div class="field admin-field-full" id="field-detail"><label>ìƒì„¸ ë‚´ìš©</label><textarea id="input-detail" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="min-height:100px;"></textarea></div>
      <div class="date-group" style="display:flex; gap:16px;"><div class="field" id="field-start-date" style="flex:1;"><label>ì‹œì‘ì¼</label><input type="date" id="input-start"></div><div class="field" id="field-due-date" style="flex:1;"><label>ë§ˆê°ì¼</label><input type="date" id="input-due"></div></div>
      <div class="field" id="field-priority"><label>ìš°ì„ ìˆœìœ„</label><select id="input-priority"><option value="ë†’ìŒ">ë†’ìŒ</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ë‚®ìŒ">ë‚®ìŒ</option></select></div>
      
      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥í•˜ê¸°</button><button type="button" id="btn-delete-modal" class="btn" style="color:#ef4444; display:none;" onclick="deleteFromModal()">ì‚­ì œ</button><button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button></div>
    </form>

    <div id="related-history-section" class="history-section" style="display:none;">
      <div class="history-title">ğŸ“ ì‘ì—… íˆìŠ¤í† ë¦¬</div>
      <div id="history-list-root" class="history-list">
        </div>
    </div>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="log-modal-title" style="margin-top:0;">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <input type="hidden" id="log-edit-id"><input type="hidden" id="log-edit-mode" value="false">
      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title"></div>
      <div class="field admin-field-full" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;"><label style="color:#0284c7; font-weight:600;">ğŸ”— ê´€ë ¨ ì‘ì—… ì—°ë™ (ì„ íƒ)</label><select id="log-related-id" style="width:100%; border:1px solid #bae6fd;"><option value="">(ì—†ìŒ)</option></select><p style="font-size:0.75rem; color:#0ea5e9; margin:4px 0 0;">* ì´ ë¡œê·¸ë¥¼ íŠ¹ì • ì‘ì—…ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.</p></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      <div class="field admin-field-full" id="log-idea-section" style="background:#f0fdf4; padding:16px; border-radius:12px; border:1px dashed #16a34a;"><label style="color:#15803d; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ (ì„ íƒ)</label><input type="text" id="log-idea-input" placeholder="ì—¬ê¸°ì— ì ìœ¼ë©´ ì•„ì´ë””ì–´ í•¨ì— ì¶”ê°€ë¨" style="background:#fff; border-color:#86efac;"></div>
      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags"></div>
      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥</button><button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button></div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        renderGoalTree(); renderBoardView(); renderIdeaView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchView(mode) {
    document.getElementById('btn-view-card').classList.toggle('active', mode==='card');
    document.getElementById('btn-view-board').classList.toggle('active', mode==='board');
    document.getElementById('btn-view-idea').classList.toggle('active', mode==='idea');
    document.getElementById('view-card-container').style.display = (mode==='card')?'block':'none';
    document.getElementById('view-board-container').style.display = (mode==='board')?'block':'none';
    document.getElementById('view-idea-container').style.display = (mode==='idea')?'block':'none';
  }

  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root'); root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:40px;text-align:center;color:#94a3b8;">ë°ì´í„° ì—†ìŒ</div>`; return; }
    bigGoals.forEach(bg => {
      const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
      const card = document.createElement('div'); card.className = "goal-card";
      const header = document.createElement('div'); header.className = "goal-card-header"; header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${adjustColor(themeColor,-20)} 100%)`;
      let dateHtml = ""; if (bg['ì‹œì‘ì¼'] || bg['ë§ˆê°ì¼']) { const s = bg['ì‹œì‘ì¼']?bg['ì‹œì‘ì¼'].split('T')[0]:''; const e = bg['ë§ˆê°ì¼']?bg['ë§ˆê°ì¼'].split('T')[0]:''; dateHtml = `<div class="goal-date-badge">ğŸ—“ ${s} ~ ${e}</div>`; }
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc">${bg['ìƒì„¸ë‚´ìš©']}</div>` : '';
      header.innerHTML = `<div><div class="goal-card-title">${bg['ì œëª©']}</div>${dateHtml}${descHtml}</div><div class="header-actions"><button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button><button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button></div>`;
      card.appendChild(header);
      const body = document.createElement('div'); body.className = "mid-goal-group";
      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midItem = document.createElement('div'); midItem.className = "mid-goal-item"; midItem.style.borderLeftColor = themeColor;
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span style="font-weight:400; font-size:0.85rem; color:#64748b; margin-left:8px;">${mg['ìƒì„¸ë‚´ìš©']}</span>` : '';
        midItem.innerHTML = `<div class="mid-goal-header" onclick="toggleDisplay(this)"><span>ğŸš© ${mg['ì œëª©']} ${midDesc}</span><div onclick="event.stopPropagation()" class="row-actions"><button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button></div></div>`;
        const taskList = document.createElement('div'); taskList.className = "task-list";
        const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        if(tasks.length > 0) tasks.forEach(t => taskList.appendChild(createTaskRow(t)));
        else taskList.innerHTML = `<div style="padding:15px;color:#cbd5e1;font-size:0.85rem;">í•  ì¼ ì—†ìŒ</div>`;
        midItem.appendChild(taskList); body.appendChild(midItem);
      });
      card.appendChild(body); root.appendChild(card);
    });
  }
  function createTaskRow(t) {
    const container = document.createElement('div'); const row = document.createElement('div'); row.className = "task-row";
    row.onclick = function() { openEditModal('task', t.ID); };
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    
    // ë¡œê·¸ ê°œìˆ˜ ê³„ì‚°
    const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
    const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';

    row.innerHTML = `<div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div><div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:500;">${t['ì œëª©']} ${t['ìƒì„¸ë‚´ìš©']?'<span style="font-size:0.75rem;color:#94a3b8;margin-left:4px;">ğŸ“</span>':''} ${badgeHtml}</div>`;
    container.appendChild(row); return container;
  }

  function renderBoardView() {
    const tbody = document.getElementById('board-table-body'); tbody.innerHTML = "";
    const boardTasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´').sort((a,b) => (a['ìƒíƒœ']==='ì™„ë£Œ'?1:-1));
    if(boardTasks.length === 0) { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#cbd5e1;">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; return; }
    boardTasks.forEach(t => {
      const tr = document.createElement('tr'); const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      let pathHtml = `<span style="color:#cbd5e1;">(ë¯¸ë¶„ë¥˜)</span>`;
      const midId = (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").split(',')[0];
      const mid = g_goals.find(g=>g.ID===midId);
      if(mid) { const big = g_goals.find(g=>g.ID===mid['ìƒìœ„ID']); const bgCol = big ? (big['ìƒ‰ìƒ'] || "#94a3b8") : "#94a3b8"; pathHtml = `<div class="path-badge" style="background:${bgCol};">${big?big['ì œëª©']:'?'} > ${mid['ì œëª©']}</div>`; }
      tr.onclick = function() { openEditModal('task', t.ID); };
      
      // ë¡œê·¸ ê°œìˆ˜ ê³„ì‚°
      const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
      const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';

      tr.innerHTML = `<td style="text-align:center;"><div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div></td><td>${pathHtml}</td><td><div style="font-weight:600; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}">${t['ì œëª©']} ${badgeHtml}</div></td><td style="color:#64748b; font-size:0.85rem;">${t['ê¸°í•œ'] ? t['ê¸°í•œ'].slice(5) : '-'}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderIdeaView() {
    const root = document.getElementById('idea-grid-root'); root.innerHTML = "";
    const ideas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´');
    if(ideas.length === 0) { root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:#cbd5e1;">ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    ideas.forEach(item => {
      const card = document.createElement('div'); card.className = "idea-card";
      card.onclick = () => openEditModal('idea', item.ID);
      card.innerHTML = `<div class="idea-title">${item['ì œëª©']}</div><div class="idea-body">${item['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ"}</div><div class="idea-date">${item['ê¸°í•œ'] ? "ğŸ“… "+item['ê¸°í•œ'].split('T')[0] : ""}</div>`;
      root.appendChild(card);
    });
  }

  function renderLogs() {
    const root = document.getElementById('log-timeline-root'); root.innerHTML = "";
    if(g_logs.length===0) { root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem;">ì‘ì—… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    g_logs.slice(0, 30).forEach(log => {
      const item = document.createElement('div'); item.className = "log-item";
      const dateStr = log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : '';
      const title = log['ì œëª©'] || "ì‘ì—… ê¸°ë¡";
      let relatedHtml = "";
      if(log['ê´€ë ¨_ëª©í‘œID']) {
        const relTask = g_tasks.find(t => t.ID === log['ê´€ë ¨_ëª©í‘œID']) || g_goals.find(g => g.ID === log['ê´€ë ¨_ëª©í‘œID']);
        if(relTask) relatedHtml = `<div class="log-related">ğŸ“Œ ê´€ë ¨: ${relTask['ì œëª©']}</div>`;
      }
      item.innerHTML = `
        <div class="log-dot"></div><div class="log-card">
          <div class="log-header"><div style="display:flex; align-items:center;"><span class="log-date">${dateStr}</span>${log['ì†Œìš”ì‹œê°„']?`<span class="log-duration">â± ${log['ì†Œìš”ì‹œê°„']}</span>`:''}</div><div class="log-actions"><button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button></div></div>
          ${relatedHtml}
          <div class="log-title">${title}</div><div class="log-body">${log['ë‚´ìš©']}</div>${log['íƒœê·¸']?`<div><span class="log-tag">${log['íƒœê·¸']}</span></div>`:''}
        </div>`;
      root.appendChild(item);
    });
  }

  function adjustColor(color, amount) { return color; } 
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function updateLogTaskOptions(selectedId = "") {
    const select = document.getElementById('log-related-id'); select.innerHTML = '<option value="">(ì—†ìŒ)</option>';
    const tasks = g_tasks.filter(t => t['ìœ í˜•'] === 'í• ì¼' && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
    if(tasks.length > 0) { const group = document.createElement('optgroup'); group.label = "ì§„í–‰ ì¤‘ì¸ í•  ì¼"; tasks.forEach(t => { const op = document.createElement('option'); op.value = t.ID; op.textContent = t['ì œëª©']; group.appendChild(op); }); select.appendChild(group); }
    const mids = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    if(mids.length > 0) { const group2 = document.createElement('optgroup'); group2.label = "ì¤‘ê°„ ëª©í‘œ"; mids.forEach(m => { const op = document.createElement('option'); op.value = m.ID; op.textContent = m['ì œëª©']; group2.appendChild(op); }); select.appendChild(group2); }
    if(selectedId) select.value = selectedId;
  }

  function openLogModal() {
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-date').valueAsDate = new Date(); document.getElementById('log-edit-mode').value="false";
    document.getElementById('log-form').reset(); document.getElementById('log-idea-section').style.display='block'; updateLogTaskOptions();
  }

  function openModal(type) {
    document.getElementById('input-modal').classList.add('open'); document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡"; document.getElementById('edit-mode').value = "false";
    document.getElementById('btn-delete-modal').style.display = "none"; document.getElementById('related-history-section').style.display = "none"; // íˆìŠ¤í† ë¦¬ ìˆ¨ê¹€
    document.getElementById('todo-form').reset();
    document.querySelectorAll('input[name="type"]').forEach(r => r.disabled = false);
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }

  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    if (isGoal) { document.getElementById('field-start-date').style.display = "block"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "none"; } 
    else { document.getElementById('field-start-date').style.display = "none"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "block"; }
    document.getElementById('field-color').style.display = (type === "í° ëª©í‘œ") ? "block" : "none";
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id'); select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    opts.forEach(o => { const op = document.createElement('option'); op.value = o.ID; op.textContent = o['ì œëª©']; select.appendChild(op); });
  }

  function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìƒì„¸ / ìˆ˜ì •";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('edit-id').value = id;
    const delBtn = document.getElementById('btn-delete-modal'); delBtn.style.display = "block"; delBtn.onclick = () => deleteFromModal();

    document.getElementById('input-title').value = item['ì œëª©'];
    document.getElementById('input-detail').value = item['ìƒì„¸ë‚´ìš©'] || "";
    if (item['ìƒ‰ìƒ']) { const radio = document.querySelector(`input[name="color"][value="${item['ìƒ‰ìƒ']}"]`); if(radio) radio.checked = true; }

    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => { if(r.value === item['ìœ í˜•']) r.checked = true; else r.disabled = true; });
    
    toggleFormFields();

    if (item['ìœ í˜•'].includes("ëª©í‘œ")) {
        document.getElementById('input-start').value = (item['ì‹œì‘ì¼']||"").split('T')[0];
        document.getElementById('input-due').value = (item['ë§ˆê°ì¼']||"").split('T')[0];
        if(item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
        document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
        document.getElementById('input-due').value = (item['ê¸°í•œ']||"").split('T')[0];
        document.getElementById('input-priority').value = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }

    // ğŸ”¥ [NEW] ê´€ë ¨ íˆìŠ¤í† ë¦¬ ë Œë”ë§
    renderHistoryInModal(id);
  }

  // ëª¨ë‹¬ ë‚´ íˆìŠ¤í† ë¦¬ ë Œë”ë§ í•¨ìˆ˜
  function renderHistoryInModal(targetId) {
    const container = document.getElementById('related-history-section');
    const listRoot = document.getElementById('history-list-root');
    
    // ì´ ì‘ì—…(targetId)ê³¼ ì—°ê²°ëœ ë¡œê·¸ ì°¾ê¸°
    const relatedLogs = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === targetId);
    
    if (relatedLogs.length > 0) {
      container.style.display = 'block';
      listRoot.innerHTML = relatedLogs.map(log => `
        <div class="history-item">
          <div class="history-date">ğŸ“… ${log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : ''}</div>
          <div class="history-content">${log['ë‚´ìš©']}</div>
        </div>
      `).join('');
    } else {
      container.style.display = 'none';
    }
  }

  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id); if (!log) return;
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •"; document.getElementById('log-edit-mode').value = "true"; document.getElementById('log-edit-id').value = id;
    document.getElementById('log-date').value = (log['ë‚ ì§œ']||"").split('T')[0]; document.getElementById('log-title').value = log['ì œëª©'] || ""; document.getElementById('log-content').value = log['ë‚´ìš©'] || ""; document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || ""; document.getElementById('log-tags').value = log['íƒœê·¸'] || ""; document.getElementById('log-idea-section').style.display = 'none';
    updateLogTaskOptions(log['ê´€ë ¨_ëª©í‘œID']);
  }

  function deleteFromModal() { const id = document.getElementById('edit-id').value; deleteItem(id); closeModal('input-modal'); }
  async function toggleStatus(id, newStatus) { await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) }); loadAllData(); }
  async function deleteItem(id) { if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) }); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading(); }

  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('edit-mode').value === "true";
    const type = document.querySelector('input[name="type"]:checked').value;
    const color = document.querySelector('input[name="color"]:checked').value;
    const payload = { 
        mode: isEdit ? "editItem" : "addItem", id: document.getElementById('edit-id').value, type: type, 
        title: document.getElementById('input-title').value, parentId: document.getElementById('input-connected-id').value, 
        connectedId: document.getElementById('input-connected-id').value, detail: document.getElementById('input-detail').value, 
        startDate: document.getElementById('input-start').value, dueDate: document.getElementById('input-due').value, 
        priority: document.getElementById('input-priority').value, color: color 
    };
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) }); closeModal('input-modal'); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading();
  });

  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault(); const isEdit = document.getElementById('log-edit-mode').value === "true";
    const payload = { 
      mode: isEdit ? "editItem" : "addLog", id: document.getElementById('log-edit-id').value, 
      date: document.getElementById('log-date').value, title: document.getElementById('log-title').value, 
      content: document.getElementById('log-content').value, duration: document.getElementById('log-duration').value, tags: document.getElementById('log-tags').value,
      relatedId: document.getElementById('log-related-id').value
    };
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); const requests = [fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) })];
    const ideaVal = document.getElementById('log-idea-input').value; if (!isEdit && ideaVal.trim() !== "") requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaVal, detail: "ë¡œê·¸ íŒŒìƒ", priority: "ë³´í†µ" }) }));
    await Promise.all(requests); closeModal('log-modal'); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading();
  });
</script>
</body>
</html>
