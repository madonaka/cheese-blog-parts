<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cheese Lab Project</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

<style>
    /* ... ê¸°ì¡´ CSS ë³€ìˆ˜ ... */
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; }
    .dashboard-layout > div { min-width: 0; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 1000px) { 
      .admin-main { 
        padding: 12px; 
        padding-top: calc(var(--admin-header-h, 64px) + 20px) !important; 
      } 
    }

    /* íƒ­ ë©”ë‰´ */
    .view-tabs { 
      display: flex; gap: 6px; margin-bottom: 20px; 
      background: #f1f5f9; padding: 4px; border-radius: 12px; 
      width: 100%; max-width: 100%; overflow-x: auto; white-space: nowrap; 
      -webkit-overflow-scrolling: touch; scrollbar-width: none; 
    }
    .view-tabs::-webkit-scrollbar { display: none; }

    .view-tab-btn { 
      padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; 
      border: none; background: transparent; color: var(--text-sub); 
      cursor: pointer; transition: all 0.2s; white-space: nowrap; 
      flex-shrink: 0; 
    }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* Goal Card */
    .goal-card { background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); transition: transform 0.2s; position: relative; }
    .goal-card-header { padding: 18px 24px; color: white; display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; }
    .goal-card-header:hover { opacity: 0.95; }
    .goal-card-title { font-size: 1.25rem; font-weight: 800; line-height: 1.3; max-width: 85%; display: flex; align-items: center; gap: 8px; }
    .goal-card-desc { font-size: 0.9rem; opacity: 0.95; margin-top: 6px; font-weight: 400; line-height: 1.4; }
    .goal-date-badge { display: inline-block; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 8px; font-size: 0.75rem; margin-top: 6px; font-weight: 500; }
    .header-actions .action-btn { background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 6px; padding: 6px 10px; cursor: pointer; margin-left: 4px; }

    /* Mid/Task */
    .mid-goal-group { padding: 20px; border-top: 1px solid #f1f5f9; }
    .mid-goal-item { margin-top: 16px; background: #fff; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-item:first-child { margin-top: 0; }
    .mid-goal-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); }
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s; }
    .task-row:hover { background: #fdfdfd; }
    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .mid-goal-header:hover .row-actions, .task-row:hover .row-actions { opacity: 1; }
    @media(max-width:600px){ .row-actions { opacity: 1; } }
    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: #94a3b8; }
    .row-btn:hover { color: var(--primary); } .row-btn.delete:hover { color: #ef4444; }

    /* ğŸš€ [NEW] ë³´ë“œ ë·° (Planner ìŠ¤íƒ€ì¼) */
    .board-wrapper { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 20px; height: calc(100vh - 220px); }
    .board-column { flex: 1; min-width: 280px; max-width: 400px; background: #f1f5f9; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    
    .column-header { padding: 14px; font-weight: 800; font-size: 1rem; border-radius: 12px 12px 0 0; color: white; text-align: center; }
    .header-high { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .header-normal { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .header-low { background: linear-gradient(135deg, #10b981, #059669); }

    .column-content { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .column-done-content { padding: 12px; display: flex; flex-direction: column; gap: 10px; background: #e2e8f0; border-radius: 0 0 12px 12px; border-top: 1px solid #cbd5e1; }

    .board-card { background: #fff; border-radius: 8px; padding: 12px 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: transform 0.2s; position: relative; }
    .board-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .board-card.done { opacity: 0.7; background: #f8fafc; color: #94a3b8; }
    .board-card.done .board-card-title { text-decoration: line-through; }

    .board-card-title { font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; color: #1e293b; line-height: 1.4; }
    .board-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #64748b; }
    .board-date-badge { background: #eff6ff; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .board-overdue { background: #fef2f2; color: #ef4444; }

    .completed-toggle-btn { width: 100%; border: none; background: #cbd5e1; color: #475569; padding: 10px; font-weight: 700; cursor: pointer; text-align: center; transition: background 0.2s; font-size: 0.85rem; }
    .completed-toggle-btn:hover { background: #94a3b8; color: #fff; }
    
    /* ë²„ê·¸ íŠ¸ë˜ì»¤ ìŠ¤íƒ€ì¼ */
    .bug-container { border-top: 4px solid #ef4444; }
    .bug-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; flex-direction: column; height: 100%; border-top: 5px solid #ef4444; }
    .bug-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.15); }
    .bug-card.working { border: 2px solid #f87171; background: #fef2f2; }
    .bug-status-badge { position: absolute; top: -10px; right: 12px; background: #ef4444; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); z-index: 2; }
    .bug-parent-info { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display:flex; align-items:center; gap:4px; }
    .bug-title { font-weight: 800; font-size: 1.05rem; margin-bottom: 8px; color: #7f1d1d; line-height: 1.3; }
    .bug-body { font-size: 0.9rem; color: #7f1d1d; opacity:0.8; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    .bug-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #fee2e2; padding-top: 12px; }
    .bug-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    .bug-btn.check { background: #fff1f2; color: #e11d48; } .bug-btn.check:hover { background: #ffe4e6; }
    .bug-btn.solve { background: #f0fdf4; color: #16a34a; } .bug-btn.solve:hover { background: #dcfce7; }
    .bug-btn.restore { background: #f1f5f9; color: #64748b; } .bug-btn.restore:hover { background: #e2e8f0; }

    /* Idea */
    .idea-container { padding: 0 4px; }
    .idea-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .idea-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .idea-card { background: #fff; border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; flex-direction: column; height: 100%; border-top: 5px solid #d8b4fe; }
    .idea-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .idea-card.realized { border: 2px solid #60a5fa; background: #f8fbff; }
    .realized-badge { position: absolute; top: -10px; right: 12px; background: #3b82f6; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); z-index: 2; }
    .idea-header { display: flex; justify-content: flex-start; margin-bottom: 8px; }
    .idea-date { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .idea-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; color: #1e293b; line-height: 1.3; }
    .idea-body { font-size: 0.9rem; color: #64748b; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    .idea-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #f1f5f9; padding-top: 12px; }
    .idea-btn { flex: 1; border: none; background: #f1f5f9; color: #64748b; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    .idea-btn:hover { background: #e2e8f0; color: #334155; }
    .idea-btn.plan { background: #eff6ff; color: #3b82f6; } .idea-btn.plan:hover { background: #dbeafe; }
    .idea-btn.done { background: #f0fdf4; color: #16a34a; } .idea-btn.done:hover { background: #dcfce7; }

    /* Log */
    .log-container { background: #fff; border-radius: 16px; padding: 32px; border: 1px solid var(--border-color); min-height: 600px; }
    .log-item { position: relative; padding-left: 24px; margin-bottom: 28px; max-width: 800px; }
    .log-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -30px; width: 2px; background: #e2e8f0; }
    .log-item:last-child::before { display: block; background: linear-gradient(to bottom, #e2e8f0 50%, transparent 100%); }
    .log-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary); border-radius: 50%; }
    .log-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; transition: box-shadow 0.2s; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .log-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; display:flex; align-items:center; gap:4px; }
    .log-related { display: inline-block; font-size: 0.75rem; color: #059669; background: #ecfdf5; padding: 2px 8px; border-radius: 4px; font-weight: 600; margin-bottom: 6px; }
    .log-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .log-card:hover .log-actions { opacity: 1; }
    .log-count-badge { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-flex; align-items: center; gap: 3px; }
    .log-date-divider { display: flex; align-items: center; margin: 30px 0 15px; font-weight: 700; color: #475569; font-size: 0.9rem; }
    .log-date-divider::before, .log-date-divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }
    .log-date-divider::before { margin-right: 12px; } .log-date-divider::after { margin-left: 12px; }
    @media (max-width: 600px) { .log-container { padding: 16px; } .log-actions { opacity: 1; position: relative; top:0; right:0; margin-left: auto; } .log-header { flex-wrap: wrap; gap: 8px; } }

    /* Utils */
    .color-options { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .color-radio { display: none; }
    .color-label { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-radio:checked + .color-label { transform: scale(1.1); box-shadow: 0 0 0 2px #fff, 0 0 0 4px #94a3b8; }
    .check-circle { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: var(--primary); }
    .fab-sub { width: 48px; height: 48px; background: #475569; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }

    /* ëª¨ë‹¬ */
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 32px; border-radius: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    @media (max-width: 600px) { .date-group { flex-direction: column !important; gap: 10px !important; } .modal-box { width: 95% !important; padding: 20px !important; max-width: 100%; border-radius: 16px; } }
    .view-content-box { padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 100px; line-height: 1.6; color: #334155; margin-top: 4px; }
    .view-content-box img { max-width: 100%; height: auto; border-radius: 4px; }
    
    .modal-section { margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .section-title { font-size: 0.95rem; font-weight: 700; color: #475569; margin-bottom: 12px; display:flex; align-items:center; gap:6px; }
    
    /* íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ (ì ‘ê¸°/í¼ì¹˜ê¸°) */
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    .history-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 0.9rem; position: relative; cursor: pointer; transition: background 0.2s; }
    .history-item:hover { background: #f1f5f9; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .history-date { font-weight: 700; color: #64748b; font-size: 0.75rem; background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .history-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
    .history-content { color: #334155; line-height: 1.5; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; white-space: normal; }
    .history-item.expanded .history-content { display: block; -webkit-line-clamp: unset; overflow: visible; }
    .history-item::after { content: 'â–¼ ë”ë³´ê¸°'; display: block; text-align: center; font-size: 0.7rem; color: #cbd5e1; margin-top: 6px; }
    .history-item.expanded::after { content: 'â–² ì ‘ê¸°'; }

    /* ê´€ë ¨ ì•„ì´ë””ì–´(ë¯¸ë‹ˆ ì¹´ë“œ) */
    .mini-idea-grid { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
    .mini-idea-card { min-width: 200px; max-width: 200px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; border-top: 4px solid #d8b4fe; cursor: pointer; flex-shrink: 0; }
    .mini-idea-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .mini-idea-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .mini-idea-desc { font-size: 0.8rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
    
    #log-bug-section { background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px dashed #ef4444; margin-top: 10px; }
    #log-bug-section label { color: #b91c1c; font-weight: 700; display:flex; align-items:center; gap:4px; }
    #log-bug-section input { border-color: #fca5a5; }
    
    /* ì¤‘ê°„ ëª©í‘œ ë‚´ ì•„ì´ë””ì–´ ìŠ¬ë¼ì´ë” */
    .mid-idea-slider { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; scrollbar-width: thin; }
    .mid-idea-slider::-webkit-scrollbar { height: 6px; }
    .mid-idea-slider::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .mid-idea-card-mini { min-width: 180px; max-width: 180px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; cursor: pointer; flex-shrink: 0; border-top: 3px solid #d8b4fe; transition: transform 0.1s; display: flex; flex-direction: column; }
    .mid-idea-card-mini:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .mic-date { font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; }
    .mic-title { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.3; }
    .mic-desc { font-size: 0.75rem; color: #64748b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0;">Dashboard</h2>
        <p style="color: var(--text-sub); margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ í˜„í™©ê³¼ ê¸°ë¡</p>
      </div>

      <div class="dashboard-layout">
        
        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜•</button>
          <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ</button>
          <button class="view-tab-btn" onclick="switchView('bug')" id="btn-view-bug">ğŸ ë²„ê·¸ íŠ¸ë˜ì»¤</button> 
          <button class="view-tab-btn" onclick="switchView('idea')" id="btn-view-idea">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</button>
          <button class="view-tab-btn" onclick="switchView('log')" id="btn-view-log">ğŸ“ ì‘ì—… ë¡œê·¸</button>
        </div>

        <div id="view-card-container"><div id="goal-tree-root"><div class="goal-card" style="padding:40px; text-align:center; color:#94a3b8; background:#f1f5f9;">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
        
        <div id="view-board-container" style="display:none;">
          <div class="board-wrapper">
            <div class="board-column">
              <div class="column-header header-high">ğŸ”¥ ë†’ìŒ (High)</div>
              <div id="board-col-high" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('high')">
                   âœ… ì™„ë£Œë¨ <span id="count-high-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-high-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
            <div class="board-column">
              <div class="column-header header-normal">ğŸ”µ ë³´í†µ (Normal)</div>
              <div id="board-col-normal" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('normal')">
                   âœ… ì™„ë£Œë¨ <span id="count-normal-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-normal-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
            <div class="board-column">
              <div class="column-header header-low">ğŸŒ± ë‚®ìŒ (Low)</div>
              <div id="board-col-low" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('low')">
                   âœ… ì™„ë£Œë¨ <span id="count-low-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-low-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="view-bug-container" style="display:none;">
          <div class="idea-container">
            <div class="idea-toolbar">
              <span style="font-size:0.9rem; color:#b91c1c; font-weight:600;">ğŸš¨ ë°œê²¬ëœ ë²„ê·¸ ë° ì´ìŠˆ íŠ¸ë˜ì»¤</span>
              <label style="cursor:pointer; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="toggle-bug-archive" onchange="renderBugView()">
                <span>âœ… í•´ê²°ëœ ë²„ê·¸ ë³´ê¸° (ì•„ì¹´ì´ë¸Œ)</span>
              </label>
            </div>
            <div id="bug-grid-root" class="idea-grid"></div>
          </div>
        </div>

        <div id="view-idea-container" style="display:none;">
          <div class="idea-container">
            <div class="idea-toolbar">
              <span style="font-size:0.9rem; color:#64748b; font-weight:600;">âœ¨ ë°˜ì§ì´ëŠ” ì•„ì´ë””ì–´ë“¤ì„ ëª¨ì•„ë³´ì„¸ìš”!</span>
              <label style="cursor:pointer; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="toggle-archive" onchange="renderIdeaView()">
                <span>ğŸ—„ï¸ ì™„ë£Œëœ ì•„ì´ë””ì–´ ë³´ê¸° (ì•„ì¹´ì´ë¸Œ)</span>
              </label>
            </div>
            <div id="idea-grid-root" class="idea-grid"></div>
          </div>
        </div>

        <div id="view-log-container" style="display:none;">
          <div class="log-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
              <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">ğŸ“ ì „ì²´ ì‘ì—… íƒ€ì„ë¼ì¸</h3>
              <button class="btn btn-primary" style="padding: 10px 16px; font-size: 0.95rem;" onclick="openLogModal()">+ ìƒˆ ê¸°ë¡ ì‘ì„±</button>
            </div>
            <div id="log-timeline-root"></div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 class="modal-title" id="todo-modal-title" style="margin:0;">í•­ëª© ìƒì„¸</h3>
      <button id="btn-enable-edit" class="btn" style="background:#eff6ff; color:var(--primary); border:none;" onclick="toggleEditMode(true)">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    </div>

    <form id="todo-form" class="admin-form-grid">
      <input type="hidden" id="edit-id"><input type="hidden" id="edit-mode" value="false">
      <input type="hidden" id="origin-idea-id"> 

      <div class="field admin-field-full">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto;">
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label style="white-space:nowrap; color:#ef4444; font-weight:bold;"><input type="radio" name="type" value="ë²„ê·¸" onclick="toggleFormFields()"> ğŸ”¥ ë²„ê·¸</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-color" style="display:none;"><label>í…Œë§ˆ ìƒ‰ìƒ</label><div class="color-options"><label><input type="radio" name="color" value="#4f46e5" class="color-radio" checked><span class="color-label" style="background:#4f46e5;"></span></label><label><input type="radio" name="color" value="#059669" class="color-radio"><span class="color-label" style="background:#059669;"></span></label><label><input type="radio" name="color" value="#db2777" class="color-radio"><span class="color-label" style="background:#db2777;"></span></label><label><input type="radio" name="color" value="#d97706" class="color-radio"><span class="color-label" style="background:#d97706;"></span></label><label><input type="radio" name="color" value="#0891b2" class="color-radio"><span class="color-label" style="background:#0891b2;"></span></label><label><input type="radio" name="color" value="#475569" class="color-radio"><span class="color-label" style="background:#475569;"></span></label></div></div>
      <div class="field admin-field-full" id="field-parent"><label>ì—°ê²°ëœ ëª©í‘œ</label><select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select></div>
      <div class="field admin-field-full"><label>ì œëª©</label><input type="text" id="input-title" required></div>
      
      <div class="field admin-field-full" id="field-detail">
        <label>ìƒì„¸ ë‚´ìš©</label>
        <div id="detail-view-box" class="view-content-box"></div>
        <div id="detail-edit-wrapper" style="display:none;">
          <textarea id="input-detail"></textarea>
        </div>
      </div>

      <div class="date-group" style="display:flex; gap:16px;">
        <div class="field" id="field-start-date" style="flex:1;"><label>ì‹œì‘ì¼</label><input type="date" id="input-start"></div>
        <div class="field" id="field-due-date" style="flex:1;"><label>ë§ˆê°ì¼</label><input type="date" id="input-due"></div>
      </div>
      <div class="field" id="field-priority"><label>ìš°ì„ ìˆœìœ„</label><select id="input-priority"><option value="ë†’ìŒ">ë†’ìŒ</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ë‚®ìŒ">ë‚®ìŒ</option></select></div>

      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;">
        <div id="edit-actions" style="display:none; width:100%; display:flex; gap:10px;">
          <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥í•˜ê¸°</button>
          <button type="button" id="btn-delete-modal" class="btn" style="color:#ef4444;" onclick="deleteFromModal()">ì‚­ì œ</button>
          <button type="button" class="btn" onclick="toggleEditMode(false)" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button>
        </div>
        <div id="view-actions" style="width:100%; display:flex; gap:10px;">
          <button type="button" class="btn" style="background:#10b981; color:white; flex:1;" onclick="createNewLogFromTask()">ğŸ“… ì‘ì—… ë¡œê·¸ ê¸°ë¡</button>
          <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center; padding:12px;">ë‹«ê¸°</button>
        </div>
      </div>
    </form>

    <div id="related-idea-section" class="modal-section" style="display:none;">
      <div class="section-title">ğŸ’¡ ê´€ë ¨ ì•„ì´ë””ì–´ & ê¸°íš</div>
      <div id="related-idea-root" class="mini-idea-grid"></div>
    </div>

    <div id="related-history-section" class="modal-section" style="display:none;">
      <div class="section-title">ğŸ“ ì‘ì—… íˆìŠ¤í† ë¦¬</div>
      <div id="history-list-root" class="history-list"></div>
    </div>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="log-modal-title" style="margin-top:0;">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <input type="hidden" id="log-edit-id"><input type="hidden" id="log-edit-mode" value="false">
      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title"></div>
      <div class="field admin-field-full" style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px solid #bae6fd;"><label style="color:#0284c7; font-weight:600;">ğŸ”— ê´€ë ¨ ì‘ì—… ì—°ë™ (ì„ íƒ)</label><select id="log-related-id" style="width:100%; border:1px solid #bae6fd;"><option value="">(ì—†ìŒ)</option></select><p style="font-size:0.75rem; color:#0ea5e9; margin:4px 0 0;">* ì´ ë¡œê·¸ë¥¼ íŠ¹ì • ì‘ì—…ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.</p></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      <div class="field admin-field-full" id="log-idea-section" style="background:#f0fdf4; padding:16px; border-radius:12px; border:1px dashed #16a34a;"><label style="color:#15803d; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ (ì„ íƒ)</label><input type="text" id="log-idea-input" placeholder="ì—¬ê¸°ì— ì ìœ¼ë©´ ì•„ì´ë””ì–´ í•¨ì— ì¶”ê°€ë¨" style="background:#fff; border-color:#86efac;"></div>
      
      <div class="field admin-field-full" id="log-bug-section">
        <label>ğŸ ë²„ê·¸ ë°œê²¬ (ì„ íƒ)</label>
        <div style="display:flex; flex-direction:column; gap:8px;">
            <input type="text" id="log-bug-input" placeholder="ë²„ê·¸ ì œëª© (ì˜ˆ: ë¡œê·¸ì¸ ì‹œ 404 ì—ëŸ¬)" style="background:#fff;">
            <textarea id="log-bug-detail" placeholder="ë²„ê·¸ ìƒì„¸ ë‚´ìš© (ë°œìƒ ê²½ë¡œ, ì¦ìƒ ë“±)" style="background:#fff; min-height:60px;"></textarea>
        </div>
        <p style="font-size:0.75rem; color:#ef4444; margin:4px 0 0;">* ì…ë ¥ ì‹œ 'ë²„ê·¸' í•­ëª©ìœ¼ë¡œ ìë™ ë“±ë¡ë˜ë©°, í˜„ì¬ ë¡œê·¸ì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags"></div>
      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;"><button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥</button><button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button></div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        renderGoalTree(); renderBoardView(); renderBugView(); renderIdeaView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // ğŸš€ [ìˆ˜ì •] íƒ­ ì „í™˜ í•¨ìˆ˜
  function switchView(mode) {
    document.querySelectorAll('.view-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('btn-view-' + mode).classList.add('active');
    
    const containers = ['card', 'board', 'bug', 'idea', 'log'];
    containers.forEach(c => {
        document.getElementById('view-' + c + '-container').style.display = (c === mode) ? 'block' : 'none';
    });
    
    // íƒ­ ì „í™˜ ì‹œ ë·° ë¦¬ë Œë”ë§ (ìµœì‹  ìƒíƒœ ë°˜ì˜)
    if(mode === 'board') renderBoardView();
    if(mode === 'bug') renderBugView();
    if(mode === 'idea') renderIdeaView();
    if(mode === 'log') renderLogs();
  }

// ğŸš€ [ìˆ˜ì •] ê³„ì¸µí˜• ë·° (ë²„ê·¸ ìˆ¨ê¹€)
  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root'); root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:40px;text-align:center;color:#94a3b8;">ë°ì´í„° ì—†ìŒ</div>`; return; }
    
    bigGoals.forEach(bg => {
      const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
      const card = document.createElement('div'); card.className = "goal-card";
      
      const header = document.createElement('div'); 
      header.className = "goal-card-header"; 
      header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${adjustColor(themeColor,-20)} 100%)`;
      
      header.onclick = function() {
        const body = card.querySelector('.mid-goal-group');
        const icon = header.querySelector('.toggle-icon');
        if (body.style.display === "none") { body.style.display = "block"; icon.textContent = "â–¼"; } 
        else { body.style.display = "none"; icon.textContent = "â–¶"; }
      };

      let dateHtml = ""; if (bg['ì‹œì‘ì¼'] || bg['ë§ˆê°ì¼']) { const s = bg['ì‹œì‘ì¼']?bg['ì‹œì‘ì¼'].split('T')[0]:''; const e = bg['ë§ˆê°ì¼']?bg['ë§ˆê°ì¼'].split('T')[0]:''; dateHtml = `<div class="goal-date-badge">ğŸ—“ ${s} ~ ${e}</div>`; }
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc">${bg['ìƒì„¸ë‚´ìš©']}</div>` : '';
      
      header.innerHTML = `
        <div style="flex:1;">
          <div class="goal-card-title"><span class="toggle-icon">â–¶</span> ${bg['ì œëª©']}</div>
          ${dateHtml}${descHtml}
        </div>
        <div class="header-actions" onclick="event.stopPropagation()">
           <button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button>
           <button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(header);

      const body = document.createElement('div'); 
      body.className = "mid-goal-group";
      body.style.display = "none"; 

      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midItem = document.createElement('div'); 
        midItem.className = "mid-goal-item"; 
        midItem.style.borderLeftColor = themeColor;
        
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span style="font-weight:400; font-size:0.85rem; color:#64748b; margin-left:8px;">${mg['ìƒì„¸ë‚´ìš©']}</span>` : '';
        
        const midHeader = document.createElement('div');
        midHeader.className = "mid-goal-header";
        midHeader.onclick = function() { toggleDisplay(this); };
        midHeader.innerHTML = `<span>ğŸš© ${mg['ì œëª©']} ${midDesc}</span><div onclick="event.stopPropagation()" class="row-actions"><button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button></div>`;
        midItem.appendChild(midHeader);

        const contentWrapper = document.createElement('div');
        contentWrapper.style.display = "block"; 

        const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        if (relatedIdeas.length > 0) {
          const slider = document.createElement('div');
          slider.className = "mid-idea-slider"; 
          
          let sliderHtml = "";
          relatedIdeas.forEach(idea => {
             const iDate = idea['ê¸°í•œ'] ? idea['ê¸°í•œ'].split('T')[0] : '';
             const iDesc = (idea['ìƒì„¸ë‚´ìš©']||"").replace(/<[^>]*>?/gm, ''); 
             sliderHtml += `
               <div class="mid-idea-card-mini" onclick="openEditModal('idea', '${idea.ID}')">
                 <div class="mic-date">ğŸ’¡ ${iDate}</div>
                 <div class="mic-title">${idea['ì œëª©']}</div>
                 <div class="mic-desc">${iDesc || '(ë‚´ìš© ì—†ìŒ)'}</div>
               </div>
             `;
          });
          slider.innerHTML = sliderHtml;
          contentWrapper.appendChild(slider);
        }

        const taskList = document.createElement('div'); 
        taskList.className = "task-list";
        // ğŸš€ ë²„ê·¸ ì œì™¸ í•„í„° ì ìš©
        const tasks = g_tasks.filter(t => 
            String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID) 
            && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' 
            && t['ìœ í˜•'] !== 'ë²„ê·¸' 
        );        
        if(tasks.length > 0) tasks.forEach(t => taskList.appendChild(createTaskRow(t)));
        else if(relatedIdeas.length === 0) taskList.innerHTML = `<div style="padding:15px;color:#cbd5e1;font-size:0.85rem;">í•  ì¼ ì—†ìŒ</div>`;
        
        contentWrapper.appendChild(taskList);
        midItem.appendChild(contentWrapper);
        body.appendChild(midItem);
      });
      card.appendChild(body); root.appendChild(card);
    });
  }
  
  function createTaskRow(t) {
    const container = document.createElement('div'); const row = document.createElement('div'); row.className = "task-row";
    row.onclick = function() { openEditModal('task', t.ID); };
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
    const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';
    const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '<span style="color:#ef4444;font-weight:bold;margin-right:4px;">[BUG]</span> ' : '';
    row.innerHTML = `<div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div><div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:500;">${prefix}${t['ì œëª©']} ${t['ìƒì„¸ë‚´ìš©']?'<span style="font-size:0.75rem;color:#94a3b8;margin-left:4px;">ğŸ“</span>':''} ${badgeHtml}</div>`;
    container.appendChild(row); return container;
  }

  // ğŸš€ [ìˆ˜ì •] ë³´ë“œ ë·° (3ë‹¨ ì¹´ë“œí˜•)
  function renderBoardView() {
    const cols = {
      'high': { active: document.getElementById('board-col-high'), done: document.getElementById('board-col-high-done'), doneCount: 0 },
      'normal': { active: document.getElementById('board-col-normal'), done: document.getElementById('board-col-normal-done'), doneCount: 0 },
      'low': { active: document.getElementById('board-col-low'), done: document.getElementById('board-col-low-done'), doneCount: 0 }
    };

    // ì´ˆê¸°í™”
    Object.values(cols).forEach(c => { 
        if(c.active) c.active.innerHTML = ""; 
        if(c.done) c.done.innerHTML = ""; 
    });

    // ë²„ê·¸ ì œì™¸í•œ í•  ì¼ë§Œ í‘œì‹œ
    const tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸');
    
    // ë‚ ì§œìˆœ ì •ë ¬
    tasks.sort((a, b) => {
        const dateA = a['ê¸°í•œ'] ? new Date(a['ê¸°í•œ']) : new Date('9999-12-31');
        const dateB = b['ê¸°í•œ'] ? new Date(b['ê¸°í•œ']) : new Date('9999-12-31');
        return dateA - dateB;
    });

    tasks.forEach(t => {
        let pKey = 'low';
        const priority = t['ìš°ì„ ìˆœìœ„'] || 'ë³´í†µ';
        if (priority === 'ë†’ìŒ') pKey = 'high';
        else if (priority === 'ë³´í†µ') pKey = 'normal';
        
        const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
        const card = createBoardCard(t);
        
        if (cols[pKey]) {
            if (isDone) {
                cols[pKey].done.appendChild(card);
                cols[pKey].doneCount++;
            } else {
                cols[pKey].active.appendChild(card);
            }
        }
    });

    if(document.getElementById('count-high-done')) document.getElementById('count-high-done').innerText = `(${cols.high.doneCount})`;
    if(document.getElementById('count-normal-done')) document.getElementById('count-normal-done').innerText = `(${cols.normal.doneCount})`;
    if(document.getElementById('count-low-done')) document.getElementById('count-low-done').innerText = `(${cols.low.doneCount})`;
  }

  function createBoardCard(item) {
      const el = document.createElement('div');
      const isDone = item['ìƒíƒœ'] === 'ì™„ë£Œ';
      el.className = `board-card ${isDone ? 'done' : ''}`;
      el.onclick = () => openEditModal('task', item.ID);

      let dateHtml = "";
      if (item['ê¸°í•œ']) {
          const d = new Date(item['ê¸°í•œ']);
          const today = new Date(); today.setHours(0,0,0,0);
          const isOverdue = !isDone && d < today;
          const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
          dateHtml = `<span class="board-date-badge ${isOverdue ? 'board-overdue' : ''}">${isOverdue?'ğŸš¨ ':''}ğŸ“… ${dateStr}</span>`;
      }

      const title = item['ì œëª©'] || "(ì œëª© ì—†ìŒ)";
      el.innerHTML = `<div class="board-card-title">${title}</div><div class="board-card-meta">${dateHtml}<span>${item['ìƒíƒœ']}</span></div>`;
      return el;
  }

  function toggleBoardCompleted(priority) {
      const el = document.getElementById(`board-col-${priority}-done`);
      if(el) el.style.display = (el.style.display === 'none') ? 'flex' : 'none';
  }

// ğŸš€ [ìˆ˜ì •] ë²„ê·¸ íŠ¸ë˜ì»¤
  function renderBugView() {
    const root = document.getElementById('bug-grid-root'); root.innerHTML = "";
    const showArchive = document.getElementById('toggle-bug-archive') ? document.getElementById('toggle-bug-archive').checked : false;

    const bugs = g_tasks.filter(t => {
      if (t['ìœ í˜•'] !== 'ë²„ê·¸') return false;
      if (showArchive) return t['ìƒíƒœ'] === 'ì™„ë£Œ'; 
      else return t['ìƒíƒœ'] !== 'ì™„ë£Œ'; 
    });
    
    bugs.sort((a,b) => (b['ID'] > a['ID'] ? 1 : -1));

    if(bugs.length === 0) { 
        root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${showArchive ? 'í•´ê²°ëœ ë²„ê·¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë°œê²¬ëœ ë²„ê·¸ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰'}</div>`; 
        return; 
    }

    bugs.forEach(t => {
      const card = document.createElement('div');
      const isWorking = t['ìƒíƒœ'] === 'ì§„í–‰ì¤‘';
      const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      card.className = `bug-card ${isWorking ? 'working' : ''}`;
      
      let parentTitle = "";
      if (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) {
        const parent = g_tasks.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) || g_goals.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']);
        if (parent) parentTitle = parent['ì œëª©'];
      }
      
      const plainText = (t['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";
      const deleteBtn = `<button class="bug-btn delete-bug" onclick="deleteItem('${t.ID}')" style="flex:0 0 auto; width:36px; background:#fff1f2; color:#ef4444; margin-left:4px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>`;

      let buttonsHtml = "";
      if (isDone) {
          buttonsHtml = `<button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ë¯¸í•´ê²°/ë³µêµ¬</button>${deleteBtn}`;
      } else if (isWorking) {
          buttonsHtml = `<button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ì·¨ì†Œ</button><button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">âœ… í•´ê²° ì™„ë£Œ!</button>${deleteBtn}`;
      } else {
          buttonsHtml = `<button class="bug-btn check" onclick="toggleStatus('${t.ID}', 'ì§„í–‰ì¤‘')">ğŸ” í™•ì¸ ì‹œì‘</button><button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">ë°”ë¡œ í•´ê²°</button>${deleteBtn}`;
      }

      card.innerHTML = `
        ${isWorking ? `<div class="bug-status-badge">ğŸ”¥ í™•ì¸ì¤‘</div>` : ''} 
        <div class="bug-content" onclick="openEditModal('task', '${t.ID}')" style="cursor:pointer; flex-grow:1;">
          <div class="bug-parent-info">${parentTitle ? `<span>ğŸ”— ${parentTitle}</span>` : '<span>(ì—°ë™ ì‘ì—… ì—†ìŒ)</span>'}</div>
          <div class="bug-title">${t['ì œëª©']}</div>
          <div class="bug-body">${plainText}</div>
        </div>
        <div class="bug-footer">${buttonsHtml}</div>
      `;
      root.appendChild(card);
    });
  }

// ğŸš€ [ìˆ˜ì •] ì•„ì´ë””ì–´ ë·° (ë¯¸ì•„/ê³ ì•„ ì‘ì—… êµ¬ì¡° ê¸°ëŠ¥ í¬í•¨)
  function renderIdeaView() {
    const root = document.getElementById('idea-grid-root'); root.innerHTML = "";
    const showArchive = document.getElementById('toggle-archive') ? document.getElementById('toggle-archive').checked : false;
    
    // í•„í„°ë§: ì•„ì´ë””ì–´ + ê³ ì•„ íƒœìŠ¤í¬(ë¶€ëª¨ê°€ ì—†ê±°ë‚˜, ë¶€ëª¨ê°€ í°ëª©í‘œì¸ ì˜ëª»ëœ ê²½ìš°)
    const ideas = g_tasks.filter(t => {
      if (showArchive && t['ìƒíƒœ'] !== 'ì™„ë£Œ') return false; 
      if (!showArchive && t['ìƒíƒœ'] === 'ì™„ë£Œ') return false;

      if (t['ìœ í˜•'] === 'ì•„ì´ë””ì–´') return true;
      if (t['ìœ í˜•'] === 'í•  ì¼') {
          const parentId = t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
          // ë¶€ëª¨ê°€ ì—†ê±°ë‚˜, ë¶€ëª¨ê°€ G_(í°ëª©í‘œ)ë¼ë©´ ì•„ì´ë””ì–´ í•¨ì— í‘œì‹œí•´ì„œ ì¬ë°°ì¹˜ ìœ ë„
          if (!parentId || parentId.trim() === "" || parentId.startsWith("G_")) return true;
      }
      return false;
    });

    ideas.sort((a,b) => (b['ID'] > a['ID'] ? 1 : -1));

    if(ideas.length === 0) { 
      root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${showArchive ? 'ë³´ê´€ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>`; return; 
    }

    ideas.forEach(item => {
      const card = document.createElement('div'); 
      const realizedId = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']; 
      // ì‹¤í˜„ ì—¬ë¶€: T_ ë˜ëŠ” B_ì™€ ì—°ê²°ëœ ê²½ìš°ë§Œ ì‹¤í˜„ìœ¼ë¡œ ê°„ì£¼
      const isRealized = realizedId && (realizedId.startsWith('T_') || realizedId.startsWith('B_'));

      card.className = `idea-card ${isRealized ? 'realized' : ''}`;
      const dateStr = item['ê¸°í•œ'] ? `ğŸ“… ${item['ê¸°í•œ'].split('T')[0]}` : "";
      const plainText = (item['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";

      let parentGoalName = "";
      if (!isRealized && realizedId && (realizedId.startsWith('M_') || realizedId.startsWith('G_'))) {
          const parent = g_goals.find(g => g.ID === realizedId);
          if (parent) parentGoalName = `<div style="font-size:0.75rem; color:#059669; margin-bottom:4px;">ğŸš© ${parent['ì œëª©']}</div>`;
      }

      let actionBtn = "";
      const deleteBtn = `<button class="idea-btn delete-idea" onclick="deleteItem('${item.ID}')" style="flex:0 0 auto; width:36px; background:#fff1f2; color:#ef4444; margin-left:4px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>`;

      if (item['ìƒíƒœ'] !== 'ì™„ë£Œ') {
          if (isRealized) {
              actionBtn = `
                <button class="idea-btn" style="background:#eff6ff; color:#3b82f6; font-weight:700;" onclick="openEditModal('task', '${realizedId}')">ğŸ‘‰ ì‘ì—… ë³´ê¸°</button>
                <button class="idea-btn" style="background:#f1f5f9; color:#64748b;" onclick="cancelRealization('${item.ID}')">â†©ï¸ ì·¨ì†Œ</button>
              `;
          } else {
              actionBtn = `<button class="idea-btn plan" onclick="convertIdeaToTask('${item.ID}')">ğŸš€ ì‹¤í˜„</button>`;
          }
      } else {
          actionBtn = `<button class="idea-btn done" onclick="toggleStatus('${item.ID}', 'ëŒ€ê¸°')">â†©ï¸ ë³µêµ¬</button>`;
      }
      const archiveBtn = (item['ìƒíƒœ'] !== 'ì™„ë£Œ' && !isRealized) ? `<button class="idea-btn done" onclick="toggleStatus('${item.ID}', 'ì™„ë£Œ')">ğŸ—„ï¸ ë³´ê´€</button>` : '';

      card.innerHTML = `
        ${isRealized ? `<div class="realized-badge">ğŸš€ ì‹¤í˜„ë¨</div>` : ''} 
        <div class="idea-header" style="flex-direction:column; align-items:flex-start;">${parentGoalName} ${dateStr ? `<div class="idea-date">${dateStr}</div>` : ''}</div>
        <div class="idea-content" onclick="openEditModal('idea', '${item.ID}')" style="cursor:pointer; flex-grow:1;">
          <div class="idea-title" style="${isRealized ? 'color:#2563eb;' : ''}">${item['ì œëª©']}</div>
          <div class="idea-body">${plainText}</div>
        </div>
        <div class="idea-footer">${actionBtn}${archiveBtn}${deleteBtn}</div>
      `;
      root.appendChild(card);
    });
  }

  // ì•„ì´ë””ì–´ ì‹¤í˜„ ì·¨ì†Œ
  async function cancelRealization(ideaId) {
      if(!confirm("ì‹¤í˜„ ìƒíƒœë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ì‘ì—…ê³¼ì˜ ê³ ë¦¬ë¥¼ ëŠìŠµë‹ˆë‹¤.)")) return;
      if(typeof showAdminLoading === 'function') showAdminLoading("ì·¨ì†Œ ì¤‘...");
      try {
          await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "editItem", id: ideaId, connectedId: "" }) });
          loadAllData(); 
      } catch(e) { console.error(e); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
      finally { if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  }

  function convertIdeaToTask(ideaId) {
    const idea = g_tasks.find(t => t.ID === ideaId); if (!idea) return;
    openModal('í• ì¼');
    document.getElementById('origin-idea-id').value = ideaId;
    document.getElementById('input-title').value = idea['ì œëª©'];
    const memoContent = `<div style="background:#f0f9ff; padding:12px; border-left:4px solid #3b82f6; border-radius:4px; margin-bottom:15px; color:#1e40af;"><strong>ğŸš€ Design Memo Origin:</strong> ${idea['ì œëª©']}<div style="font-size:0.85rem; margin-top:4px; color:#60a5fa;">ì´ ì‘ì—…ì€ ì•„ì´ë””ì–´ í•¨ì—ì„œ ì‹¤í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.</div></div>${idea['ìƒì„¸ë‚´ìš©'] || ''}`;
    $('#input-detail').summernote('code', memoContent);
  }

// ğŸš€ [ìˆ˜ì •] ë¡œê·¸ ë Œë”ë§ (ë‚ ì§œ ë°€ë¦¼ í•´ê²° + ìµœì‹ ìˆœ ì •ë ¬ ì¶”ê°€)
  function renderLogs() {
    const root = document.getElementById('log-timeline-root'); root.innerHTML = "";
    if(g_logs.length === 0) { root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem; text-align:center; padding:20px;">ì‘ì—… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

    // [ì¶”ê°€] ë¡œê·¸ë¥¼ ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ) -> ID ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ)ìœ¼ë¡œ ë¯¸ë¦¬ ì •ë ¬
    // ì´ë ‡ê²Œ í•˜ë©´ ê·¸ë£¹í•‘í•  ë•Œ ë‚´ë¶€ ì•„ì´í…œë“¤ë„ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë¨
    g_logs.sort((a, b) => {
        const da = new Date(a['ë‚ ì§œ']);
        const db = new Date(b['ë‚ ì§œ']);
        return db - da || b.ID - a.ID; 
    });
    
    const groupedLogs = {};
    g_logs.forEach(log => {
        let dateKey = 'ë‚ ì§œ ì—†ìŒ';
        if (log['ë‚ ì§œ']) {
            // [ìˆ˜ì •] ë‹¨ìˆœ substringì€ UTC ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì„œ í•˜ë£¨ ì „ìœ¼ë¡œ ë°€ë¦´ ìˆ˜ ìˆìŒ.
            // new Dateë¡œ ì „ì²´ ì‹œê°„ì„ íŒŒì‹±í•œ ë’¤ ë¡œì»¬ ì—°/ì›”/ì¼ì„ ê°€ì ¸ì™€ì•¼ í•¨.
            const d = new Date(log['ë‚ ì§œ']);
            if (!isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dateKey = `${year}-${month}-${day}`;
            } else {
                 // íŒŒì‹± ì‹¤íŒ¨ ì‹œ fallback
                 dateKey = log['ë‚ ì§œ'].substring(0, 10);
            }
        }
        if (!groupedLogs[dateKey]) groupedLogs[dateKey] = [];
        groupedLogs[dateKey].push(log);
    });

    const sortedDates = Object.keys(groupedLogs).sort().reverse();
    sortedDates.forEach(date => {
        const divider = document.createElement('div'); divider.className = "log-date-divider";
        let dayOfWeek = ""; try { dayOfWeek = new Date(date.replace(/-/g,'/')).toLocaleDateString('ko-KR', { weekday: 'short' }); } catch(e){}
        divider.innerHTML = `<span class="log-date-badge">ğŸ“… ${date} (${dayOfWeek})</span>`;
        root.appendChild(divider);

        // ì´ë¯¸ g_logsë¥¼ ì •ë ¬í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ìˆœì„œëŒ€ë¡œ ë¿Œë¦¬ë©´ ë¨ (ìµœì‹  = ìœ„)
        groupedLogs[date].forEach(log => {
            const item = document.createElement('div'); item.className = "log-item";
            const title = log['ì œëª©'] ? `<div class="log-title" style="font-weight:700; font-size:0.95rem; margin-bottom:4px;">${log['ì œëª©']}</div>` : '';
            let relatedHtml = "";
            if(log['ê´€ë ¨_ëª©í‘œID']) {
                const relTask = g_tasks.find(t => t.ID === log['ê´€ë ¨_ëª©í‘œID']) || g_goals.find(g => g.ID === log['ê´€ë ¨_ëª©í‘œID']);
                if(relTask) {
                    if (relTask['ìœ í˜•'] === 'ë²„ê·¸') relatedHtml = `<div class="log-related" style="background:#fecaca; color:#b91c1c; border:1px solid #f87171; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ ë²„ê·¸ Fix: ${relTask['ì œëª©']}</div>`; 
                    else relatedHtml = `<div class="log-related" style="background:#ecfdf5; color:#059669; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ“Œ ê´€ë ¨: ${relTask['ì œëª©']}</div>`; 
                }
            }
            const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');
            item.innerHTML = `
                <div class="log-dot"></div>
                <div class="log-card">
                    <div class="log-header" style="margin-bottom: 4px;">
                        <div class="log-time">${log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : ''}</div>
                        <div class="log-actions"><button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button></div>
                    </div>
                    ${relatedHtml}${title}<div class="log-body" style="font-size:0.9rem; color:#475569; line-height:1.6;">${content}</div>
                    ${log['íƒœê·¸'] ? `<div style="margin-top:8px;"><span class="log-tag" style="font-size:0.75rem; color:#3b82f6; background:#eff6ff; padding:2px 8px; border-radius:4px;">#${log['íƒœê·¸']}</span></div>` : ''}
                </div>`;
            root.appendChild(item);
        });
    });
  }

  function adjustColor(color, amount) { return color; } 
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function updateLogTaskOptions(selectedId = "") {
    const select = document.getElementById('log-related-id'); select.innerHTML = '<option value="">(ì—†ìŒ)</option>';
    const tasks = g_tasks.filter(t => (t['ìœ í˜•'] === 'í• ì¼' || t['ìœ í˜•'] === 'ë²„ê·¸') && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
    if(tasks.length > 0) { const group = document.createElement('optgroup'); group.label = "ì§„í–‰ ì¤‘ì¸ ì‘ì—… (í• ì¼/ë²„ê·¸)"; tasks.forEach(t => { const op = document.createElement('option'); op.value = t.ID; const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '[ğŸë²„ê·¸] ' : ''; op.textContent = prefix + t['ì œëª©']; group.appendChild(op); }); select.appendChild(group); }
    const mids = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    if(mids.length > 0) { const group2 = document.createElement('optgroup'); group2.label = "ì¤‘ê°„ ëª©í‘œ"; mids.forEach(m => { const op = document.createElement('option'); op.value = m.ID; op.textContent = m['ì œëª©']; group2.appendChild(op); }); select.appendChild(group2); }
    if(selectedId) select.value = selectedId;
  }

  function openLogModal() {
    document.getElementById('log-modal').classList.add('open'); 
    
    // [ìˆ˜ì •] valueAsDate = new Date()ëŠ” UTC ê¸°ì¤€ì´ë¼ ìƒˆë²½ì— ì‘ì„± ì‹œ ë‚ ì§œê°€ ì–´ì œë¡œ ë°€ë¦¼
    // ë¡œì»¬ ì‹œê°„ëŒ€ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´(YYYY-MM-DD)ì„ ì§ì ‘ ì£¼ì…
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    document.getElementById('log-date').value = localDate;
    
    document.getElementById('log-edit-mode').value="false";
    document.getElementById('log-form').reset(); document.getElementById('log-idea-section').style.display='block'; updateLogTaskOptions();
  }

  function toggleEditMode(isEdit) {
    const form = document.getElementById('todo-form');
    const inputs = form.querySelectorAll('input, select');
    
    if (isEdit) {
      inputs.forEach(el => el.disabled = false);
      document.getElementById('edit-actions').style.display = 'flex';
      document.getElementById('view-actions').style.display = 'none';
      document.getElementById('btn-enable-edit').style.display = 'none';
      document.getElementById('detail-view-box').style.display = 'none';
      document.getElementById('detail-edit-wrapper').style.display = 'block';
      if (!$('#input-detail').summernote('exists')) {
        $('#input-detail').summernote({ height: 250, toolbar: [['style', ['bold', 'italic', 'underline', 'clear']], ['font', ['strikethrough']], ['para', ['ul', 'ol']], ['insert', ['link', 'picture']], ['view', ['fullscreen', 'codeview']]] });
      }
    } else {
      inputs.forEach(el => el.disabled = true);
      document.getElementById('edit-actions').style.display = 'none';
      document.getElementById('view-actions').style.display = 'flex';
      document.getElementById('btn-enable-edit').style.display = 'block';
      const content = $('#input-detail').summernote('code');
      document.getElementById('detail-view-box').innerHTML = content;
      document.getElementById('detail-view-box').style.display = 'block';
      document.getElementById('detail-edit-wrapper').style.display = 'none';
    }
  }

  function openModal(type) {
    document.getElementById('input-modal').classList.add('open'); 
    document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡"; 
    document.getElementById('edit-mode').value = "false";
    document.getElementById('btn-delete-modal').style.display = "none"; 
    document.getElementById('related-history-section').style.display = "none";
    document.getElementById('related-idea-section').style.display = "none";
    document.getElementById('origin-idea-id').value = ""; 

    document.getElementById('todo-form').reset();
    $('#input-detail').summernote('reset'); 
    toggleEditMode(true);
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }

  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    if (isGoal) { document.getElementById('field-start-date').style.display = "block"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "none"; } 
    else { document.getElementById('field-start-date').style.display = "none"; document.getElementById('field-due-date').style.display = "block"; document.getElementById('field-priority').style.display = "block"; }
    
    if (type === 'ë²„ê·¸') document.getElementById('input-priority').value = 'ë†’ìŒ';
    document.getElementById('field-color').style.display = (type === "í° ëª©í‘œ") ? "block" : "none";
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id'); select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    opts.forEach(o => { const op = document.createElement('option'); op.value = o.ID; op.textContent = o['ì œëª©']; select.appendChild(op); });
  }

  function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìƒì„¸";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('edit-id').value = id;
    document.getElementById('origin-idea-id').value = ""; 

    document.getElementById('input-title').value = item['ì œëª©'];
    const safeContent = item['ìƒì„¸ë‚´ìš©'] || "";
    $('#input-detail').summernote('code', safeContent);
    document.getElementById('detail-view-box').innerHTML = safeContent || "<span style='color:#ccc'>(ë‚´ìš© ì—†ìŒ)</span>";

    if (item['ìƒ‰ìƒ']) { const radio = document.querySelector(`input[name="color"][value="${item['ìƒ‰ìƒ']}"]`); if(radio) radio.checked = true; }
    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => { if(r.value === item['ìœ í˜•']) r.checked = true; });
    toggleFormFields();

    if (item['ìœ í˜•'].includes("ëª©í‘œ")) {
        document.getElementById('input-start').value = (item['ì‹œì‘ì¼']||"").split('T')[0];
        document.getElementById('input-due').value = (item['ë§ˆê°ì¼']||"").split('T')[0];
        if(item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
        document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
        document.getElementById('input-due').value = (item['ê¸°í•œ']||"").split('T')[0];
        document.getElementById('input-priority').value = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }
    toggleEditMode(false);
    
    const delBtn = document.getElementById('btn-delete-modal'); 
    delBtn.style.display = "block"; 
    delBtn.onclick = () => deleteFromModal();

    renderHistoryInModal(id);
    renderRelatedIdeasInModal(id);
  }

// ğŸš€ [ìˆ˜ì •] íˆìŠ¤í† ë¦¬ ë Œë”ë§ (ë‚ ì§œ ë°€ë¦¼ í•´ê²° + ì ‘ê¸°/í¼ì¹˜ê¸°)
  function renderHistoryInModal(targetId) {
    const container = document.getElementById('related-history-section');
    const listRoot = document.getElementById('history-list-root');
    const relatedLogs = g_logs.filter(l => String(l['ê´€ë ¨_ëª©í‘œID']) === String(targetId));

    if (relatedLogs.length === 0) { container.style.display = 'none'; return; }

    relatedLogs.sort((a, b) => new Date(b['ë‚ ì§œ'].substring(0,10).replace(/-/g,'/')) - new Date(a['ë‚ ì§œ'].substring(0,10).replace(/-/g,'/')));

    container.style.display = 'block'; listRoot.innerHTML = "";

    relatedLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = function() { this.classList.toggle('expanded'); };
        
        let dateStr = '';
        if (log['ë‚ ì§œ']) {
            const rawDate = log['ë‚ ì§œ'].substring(0, 10).replace(/-/g, '/');
            const d = new Date(rawDate);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateStr = `${year}-${month}-${day}`;
        }
        
        const timeStr = log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : '';
        const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');

        item.innerHTML = `
            <div class="history-header">
                <span class="history-date">ğŸ“… ${dateStr}</span>
                <span class="history-time">${timeStr}</span>
            </div>
            <div class="history-content">${content}</div>
        `;
        listRoot.appendChild(item);
    });
  }
  
  function renderRelatedIdeasInModal(targetId) {
    const container = document.getElementById('related-idea-section');
    const root = document.getElementById('related-idea-root');
    const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === targetId);

    if (relatedIdeas.length > 0) {
      container.style.display = 'block';
      root.innerHTML = relatedIdeas.map(idea => `
        <div class="mini-idea-card" onclick="openEditModal('idea', '${idea.ID}')">
          <div class="mini-idea-title">ğŸ’¡ ${idea['ì œëª©']}</div>
          <div class="mini-idea-desc">${(idea['ìƒì„¸ë‚´ìš©'] || '').replace(/<[^>]*>?/gm, '')}</div>
        </div>
      `).join('');
    } else {
      container.style.display = 'none';
    }
  }

  function createNewLogFromTask() {
    const taskId = document.getElementById('edit-id').value;
    const taskTitle = document.getElementById('input-title').value;
    if (!taskId) return;
    closeModal('input-modal');
    openLogModal(); 
    const relatedSelect = document.getElementById('log-related-id');
    if (relatedSelect) relatedSelect.value = taskId;
    document.getElementById('log-title').value = taskTitle + " ì‘ì—… ê¸°ë¡";
  }

  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id); if (!log) return;
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •"; document.getElementById('log-edit-mode').value = "true"; document.getElementById('log-edit-id').value = id;
    
    // [ìˆ˜ì •] ìˆ˜ì • ëª¨ë“œì—ì„œë„ ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€
    const d = new Date(log['ë‚ ì§œ']);
    let localIso = "";
    if(!isNaN(d.getTime())) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        localIso = `${year}-${month}-${day}`;
    } else {
        localIso = (log['ë‚ ì§œ']||"").split('T')[0];
    }
    document.getElementById('log-date').value = localIso;

    document.getElementById('log-title').value = log['ì œëª©'] || ""; document.getElementById('log-content').value = log['ë‚´ìš©'] || ""; document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || ""; document.getElementById('log-tags').value = log['íƒœê·¸'] || ""; document.getElementById('log-idea-section').style.display = 'none';
    updateLogTaskOptions(log['ê´€ë ¨_ëª©í‘œID']);
  }

  function deleteFromModal() { const id = document.getElementById('edit-id').value; deleteItem(id); closeModal('input-modal'); }
// ğŸš€ [ìˆ˜ì •] ìƒíƒœ ë³€ê²½ + ì™„ë£Œ ì‹œ ìë™ ë¡œê·¸
  async function toggleStatus(id, newStatus) {
    // 1. ìƒíƒœ ì—…ë°ì´íŠ¸ ìš”ì²­
    await fetch(window.CHEESE_ADMIN_API_BASE, { 
        method: "POST", 
        body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) 
    });

    // 2. 'ì™„ë£Œ' ìƒíƒœê°€ ë˜ë©´ ìë™ìœ¼ë¡œ ë¡œê·¸ ë‚¨ê¸°ê¸°
    if (newStatus === 'ì™„ë£Œ') {
        const item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
        if (item) {
            // ì‚¬ìš©ìì—ê²Œ ë°©í•´ë˜ì§€ ì•Šê²Œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
            await createAutoLog("complete", item['ì œëª©'], id);
        }
    }

    // 3. í™”ë©´ ê°±ì‹ 
    loadAllData(); 
  }  async function deleteItem(id) { if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) }); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading(); }

  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('edit-mode').value === "true";
    const type = document.querySelector('input[name="type"]:checked').value;
    const color = document.querySelector('input[name="color"]:checked').value;
    const detailContent = $('#input-detail').summernote('code');
    const originIdeaId = document.getElementById('origin-idea-id').value;

    const payload = { 
        mode: isEdit ? "editItem" : "addItem", id: document.getElementById('edit-id').value, type: type, 
        title: document.getElementById('input-title').value, parentId: document.getElementById('input-connected-id').value, 
        connectedId: document.getElementById('input-connected-id').value, 
        detail: detailContent, 
        startDate: document.getElementById('input-start').value, dueDate: document.getElementById('input-due').value, 
        priority: document.getElementById('input-priority').value, color: color 
    };
    
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); 
    
    try {
        const response = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();

        // ğŸš€ [ìˆ˜ì •] ì•„ì´ë””ì–´ ì‹¤í˜„ ì—°ê²° ë¡œì§ + ìë™ ë¡œê·¸ ì¶”ê°€
        if (!isEdit && result.id && originIdeaId) {
            // 1. ê¸°ì¡´ ì•„ì´ë””ì–´ì™€ ìƒˆ ì‘ì—… ì—°ê²° (ì„œë²„ ìš”ì²­)
            await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "editItem", id: originIdeaId, connectedId: result.id }) });
            
            // 2. [NEW] ì‹¤í˜„ ë¡œê·¸ ìë™ ìƒì„±! (ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”)
            const taskTitle = document.getElementById('input-title').value;
            await createAutoLog("realize_idea", taskTitle, result.id);
        }
        // ğŸš€ [ì¶”ê°€] ì—¬ê¸°ê°€ í•µì‹¬! ì‹ ê·œ ë“±ë¡ ì‹œ ìë™ ë¡œê·¸ ìƒì„± ë¡œì§
        if (!isEdit && result.result === "success") {
            const newId = result.id; // ì„œë²„ì—ì„œ ë°œê¸‰ë°›ì€ ìƒˆ ID
            const title = document.getElementById('input-title').value;
            
            if (type === "ë²„ê·¸") {
                await createAutoLog("create_bug", title, newId);
            } else if (type === "ì•„ì´ë””ì–´") {
                await createAutoLog("create_idea", title, newId);
            } else if (type.includes("ëª©í‘œ")) { // í° ëª©í‘œ, ì¤‘ê°„ ëª©í‘œ
                await createAutoLog("create_goal", title, newId);
            }
        }
        closeModal('input-modal'); loadAllData();
    } catch(err) { console.error(err); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); } 
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  });

// ğŸš€ [ìˆ˜ì •] ë¡œê·¸ ì €ì¥ ë¡œì§ (ëª©í‘œ ì—°ê²° í—ˆìš©, ì‘ì—… ì—°ê²° ì‹œ ìë™ì‹¤í˜„ ë°©ì§€)
  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const isEdit = document.getElementById('log-edit-mode').value === "true";
    const relatedId = document.getElementById('log-related-id').value; 
    
    const dateVal = document.getElementById('log-date').value;
    const titleVal = document.getElementById('log-title').value;
    let contentVal = document.getElementById('log-content').value;
    const durationVal = document.getElementById('log-duration').value;
    const tagsVal = document.getElementById('log-tags').value;
    
    const bugInput = document.getElementById('log-bug-input');
    const bugTitle = bugInput ? bugInput.value.trim() : "";
    const bugDetailVal = document.getElementById('log-bug-detail') ? document.getElementById('log-bug-detail').value.trim() : "";

    const ideaInput = document.getElementById('log-idea-input');
    const ideaTitle = ideaInput ? ideaInput.value.trim() : "";

    if(typeof showAdminLoading === 'function') showAdminLoading("ì €ì¥ ì¤‘..."); 

    try {
      const requests = [];

      // 1. ë²„ê·¸ ë“±ë¡
      if (!isEdit && bugTitle !== "") {
         contentVal += `\n\n[System] ğŸ ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±ë¨: ${bugTitle}`;
         const bugFullDetail = `${bugDetailVal}\n\n---\nğŸ“Œ ë°œê²¬ëœ ì‘ì—… ë¡œê·¸: ${titleVal || 'ì œëª© ì—†ëŠ” ë¡œê·¸'} (${dateVal})`;
         requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
           method: "POST", body: JSON.stringify({ mode: "addItem", type: "ë²„ê·¸", title: bugTitle, detail: bugFullDetail, priority: "ë†’ìŒ", connectedId: relatedId }) 
         }));
      }

      // 2. ì•„ì´ë””ì–´ ë“±ë¡ (ëª©í‘œëŠ” ì—°ê²°í•˜ê³ , ì‘ì—…ì€ ì—°ê²° ì•ˆ í•¨)
      if (!isEdit && ideaTitle !== "") {
        let connectionForIdea = "";
        // IDê°€ G_ ë˜ëŠ” M_ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ì—ë§Œ ì—°ê²° (ì‘ì—…/ë²„ê·¸ì™€ ì—°ê²°ë˜ë©´ ì‹¤í˜„ë¨ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ë°©ì§€)
        if (relatedId && (relatedId.startsWith('G_') || relatedId.startsWith('M_'))) {
            connectionForIdea = relatedId;
        }
        requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
          method: "POST", body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaTitle, detail: "ì‘ì—… ë¡œê·¸ ì‘ì„± ì¤‘ íŒŒìƒë¨: " + titleVal, priority: "ë³´í†µ", connectedId: connectionForIdea }) 
        }));
      }

      // 3. ë¡œê·¸ ì €ì¥
      const logPayload = { 
        mode: isEdit ? "editItem" : "addLog", id: document.getElementById('log-edit-id').value, 
        date: dateVal, title: titleVal, content: contentVal, duration: durationVal, tags: tagsVal, relatedId: relatedId
      };
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(logPayload) }));

      await Promise.all(requests); 
      closeModal('log-modal'); loadAllData(); 

    } catch (err) { console.error("ì €ì¥ ì‹¤íŒ¨:", err); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
    finally { if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  });

// ğŸš€ [ìˆ˜ì •] ìë™ ë¡œê·¸ ìƒì„± í•¨ìˆ˜ (ì¼€ì´ìŠ¤ ì¶”ê°€)
  async function createAutoLog(actionType, itemTitle, itemId) {
    const today = new Date().toISOString().split('T')[0];
    let logTitle = "";
    let logContent = "";
    let tags = "System";

    if (actionType === "create_bug") {
        logTitle = "ğŸš¨ ë²„ê·¸ ë¦¬í¬íŠ¸ ë“±ë¡";
        logContent = `ìƒˆë¡œìš´ ë²„ê·¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì œëª©: ${itemTitle}`;
        tags = "BugReport";
    } else if (actionType === "create_idea") {
        logTitle = "ğŸ’¡ ìƒˆ ì•„ì´ë””ì–´";
        logContent = `ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì œëª©: ${itemTitle}`;
        tags = "Idea";
    } else if (actionType === "create_goal") {
        logTitle = "ğŸš© ëª©í‘œ ì„¤ì •";
        logContent = `ìƒˆë¡œìš´ ëª©í‘œê°€ ìˆ˜ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.\nëª©í‘œëª…: ${itemTitle}`;
        tags = "Goal";
    } else if (actionType === "complete") {
        logTitle = "âœ… ë‹¬ì„±/ì™„ë£Œ";
        logContent = `ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì‘ì—…ëª…: ${itemTitle}`;
        tags = "Done";
    } 
    // ğŸ‘‡ [ì—¬ê¸°] ì•„ì´ë””ì–´ ì‹¤í˜„ ì¼€ì´ìŠ¤ ì¶”ê°€!
    else if (actionType === "realize_idea") {
        logTitle = "ğŸš€ ì•„ì´ë””ì–´ ì‹¤í˜„!";
        logContent = `ì•„ì´ë””ì–´ê°€ êµ¬ì²´ì ì¸ ì‘ì—…ìœ¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‘ì—…ëª…: ${itemTitle}`;
        tags = "Realization";
    }

    try {
        await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({
                mode: "addLog",
                date: today,
                title: logTitle,
                content: logContent,
                relatedId: itemId || "",
                tags: tags
            })
        });
    } catch(e) {
        console.error("ìë™ ë¡œê·¸ ìƒì„± ì‹¤íŒ¨:", e);
    }
  }
</script>
</body>
</html>
