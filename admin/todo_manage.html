<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cheese Lab Project</title>
  <link rel="stylesheet" href="./admin.css">

  <script>
    // âœ… Apps Script ë°°í¬ ì£¼ì†Œ (ê¸°ì¡´ ì£¼ì†Œ ìœ ì§€)
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    :root {
      --bg-soft: #f8fafc;
      --border-color: #e2e8f0;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --primary: #3b82f6;
    }

    /* === ê¸°ë³¸ ë ˆì´ì•„ì›ƒ === */
    .dashboard-layout { display: grid; grid-template-columns: 2fr 1.2fr; gap: 28px; align-items: start; }
    
    /* === ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• ë¯¸ë””ì–´ ì¿¼ë¦¬ === */
    @media (max-width: 1000px) {
      .dashboard-layout { grid-template-columns: 1fr; gap: 20px; }
      .admin-main { padding: 10px; } /* ì—¬ë°± ì¶•ì†Œ */
    }
    
    @media (max-width: 600px) {
      /* íƒ­ ë©”ë‰´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
      .view-tabs { width: 100%; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
      
      /* ë‚ ì§œ ì…ë ¥ì°½ ì„¸ë¡œ ë°°ì¹˜ */
      .date-group { flex-direction: column !important; gap: 10px !important; }
      
      /* ëª¨ë‹¬ ê½‰ ì°¨ê²Œ */
      .modal-box { width: 95% !important; padding: 20px !important; max-height: 85vh; }
      
      /* í°íŠ¸ ì‚¬ì´ì¦ˆ ì¡°ì • */
      .goal-card-title { font-size: 1.1rem; }
      .header-actions { position: absolute; top: 16px; right: 16px; } /* ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
    }

    /* === ë·° ì „í™˜ íƒ­ === */
    .view-tabs { display: flex; gap: 6px; margin-bottom: 20px; background: #f1f5f9; padding: 4px; border-radius: 12px; width: fit-content; }
    .view-tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; border: none; background: transparent; color: var(--text-sub); cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* === 1. ëª©í‘œ ì¹´ë“œ === */
    .goal-card {
      background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden;
      box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
      transition: transform 0.2s; position: relative;
    }
    
    .goal-card-header {
      padding: 18px 24px; color: white;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .goal-card-title { font-size: 1.25rem; font-weight: 800; line-height: 1.3; max-width: 80%; }
    .goal-card-desc { font-size: 0.9rem; opacity: 0.95; margin-top: 6px; font-weight: 400; line-height: 1.4; white-space: pre-wrap; }
    .goal-date-badge {
      display: inline-block; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 8px;
      font-size: 0.75rem; margin-top: 6px; font-weight: 500;
    }
    
    .header-actions .action-btn {
      background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 6px;
      padding: 6px 10px; cursor: pointer; transition: background 0.2s; margin-left: 4px;
    }

    /* ì¤‘ê°„ ëª©í‘œ */
    .mid-goal-group { padding: 0 20px 20px; }
    .mid-goal-item { margin-top: 16px; background: #fff; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-header {
      padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
      background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); transition: background 0.2s;
    }
    .mid-date-info { font-size: 0.75rem; color: var(--text-sub); margin-left: 8px; font-weight: normal; }

    /* íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸ */
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s;
    }
    .task-row:last-child { border-bottom: none; }
    
    .task-detail {
      display: none; padding: 12px 16px 16px 50px; background: #fcfcfc;
      color: var(--text-sub); font-size: 0.9rem; border-bottom: 1px solid var(--border-color); line-height: 1.6;
    }

    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .mid-goal-header:hover .row-actions, .task-row:hover .row-actions { opacity: 1; }
    /* ëª¨ë°”ì¼ì—ì„œëŠ” í•­ìƒ ì•¡ì…˜ ë²„íŠ¼ ë³´ì´ê²Œ í•  ìˆ˜ë„ ìˆìŒ */
    @media (max-width: 600px) { .row-actions { opacity: 1; } }

    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: #94a3b8; }
    .row-btn:hover { color: var(--primary); }
    .row-btn.delete:hover { color: #ef4444; }

    /* === 2. ê²Œì‹œíŒ ë·° (ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ì ìš©) === */
    .board-container { 
      background: #fff; border-radius: 16px; border: 1px solid var(--border-color); 
      overflow-x: auto; /* ğŸ“± ê°€ë¡œ ìŠ¤í¬ë¡¤ í•„ìˆ˜ */
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); 
    }
    .board-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; min-width: 600px; /* ìµœì†Œ ë„ˆë¹„ ì§€ì • */ }
    .board-table th {
      background: #f8fafc; padding: 14px 16px; text-align: left; font-weight: 700; color: var(--text-sub);
      border-bottom: 1px solid var(--border-color); white-space: nowrap;
    }
    .board-table td { padding: 14px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; }
    
    .path-badge {
      display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 6px;
      font-size: 0.75rem; font-weight: 600; color: #fff; background: #94a3b8; white-space: nowrap;
    }

    /* === 3. ì‘ì—… ë¡œê·¸ === */
    .log-container {
      background: #fff; border-radius: 16px; padding: 24px; border: 1px solid var(--border-color);
      position: sticky; top: 80px; max-height: calc(100vh - 100px); overflow-y: auto;
    }
    .log-item { position: relative; padding-left: 24px; margin-bottom: 28px; }
    .log-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -30px; width: 2px; background: #e2e8f0; }
    .log-item:last-child::before { display: none; }
    .log-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary); border-radius: 50%; }
    .log-card { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; transition: box-shadow 0.2s; position: relative; }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .log-date { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); background: #f1f5f9; padding: 2px 8px; border-radius: 4px; }
    .log-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .log-card:hover .log-actions { opacity: 1; }
    @media (max-width: 600px) { .log-actions { opacity: 1; position: relative; top:0; right:0; margin-left: auto;} }

    /* === ê¸°íƒ€ UI === */
    .color-options { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .color-radio { display: none; }
    .color-label { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-radio:checked + .color-label { transform: scale(1.1); box-shadow: 0 0 0 2px #fff, 0 0 0 4px #94a3b8; }
    
    .check-circle { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }

    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: var(--primary); }
    .fab-sub { width: 48px; height: 48px; background: #475569; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }

    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 28px; border-radius: 20px; width: 90%; max-width: 520px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0;">Dashboard</h2>
        <p style="color: var(--text-sub); margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ í˜„í™©ê³¼ ê¸°ë¡</p>
      </div>

      <div class="dashboard-layout">
        
        <div>
          <div class="view-tabs">
            <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜• ë·°</button>
            <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ ë·°</button>
          </div>

          <div id="view-card-container">
            <div id="goal-tree-root">
              <div class="goal-card" style="padding:40px; text-align:center; color:#94a3b8; border:none; box-shadow:none; background:#f1f5f9;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <div id="view-board-container" style="display:none;">
            <div class="board-container">
              <table class="board-table">
                <thead>
                  <tr>
                    <th style="width:50px; text-align:center;">ì™„ë£Œ</th>
                    <th>ê²½ë¡œ</th>
                    <th>ì œëª©</th>
                    <th style="width:110px;">ë§ˆê°ì¼</th>
                    <th style="width:70px; text-align:center;">ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="board-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="log-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700;">ğŸ“ ì‘ì—… ë¡œê·¸</h3>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="openLogModal()">+ ê¸°ë¡</button>
          </div>
          <div id="log-timeline-root"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="todo-modal-title" style="margin-top:0;">í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      <input type="hidden" id="edit-id"><input type="hidden" id="edit-mode" value="false">

      <div class="field admin-field-full">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f8fafc; padding:10px; border-radius:8px; overflow-x:auto;">
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label style="white-space:nowrap;"><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-color" style="display:none;">
        <label>í…Œë§ˆ ìƒ‰ìƒ</label>
        <div class="color-options">
          <label><input type="radio" name="color" value="#4f46e5" class="color-radio" checked><span class="color-label" style="background:#4f46e5;"></span></label>
          <label><input type="radio" name="color" value="#059669" class="color-radio"><span class="color-label" style="background:#059669;"></span></label>
          <label><input type="radio" name="color" value="#db2777" class="color-radio"><span class="color-label" style="background:#db2777;"></span></label>
          <label><input type="radio" name="color" value="#d97706" class="color-radio"><span class="color-label" style="background:#d97706;"></span></label>
          <label><input type="radio" name="color" value="#0891b2" class="color-radio"><span class="color-label" style="background:#0891b2;"></span></label>
          <label><input type="radio" name="color" value="#475569" class="color-radio"><span class="color-label" style="background:#475569;"></span></label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-parent">
        <label>ì—°ê²°ëœ ëª©í‘œ</label>
        <select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select>
      </div>

      <div class="field admin-field-full"><label>ì œëª©</label><input type="text" id="input-title" required></div>
      <div class="field admin-field-full" id="field-detail"><label>ìƒì„¸ ë‚´ìš©</label><textarea id="input-detail" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></div>
      
      <div class="date-group" style="display:flex; gap:16px;">
        <div class="field" id="field-start-date" style="flex:1;"><label>ì‹œì‘ì¼</label><input type="date" id="input-start"></div>
        <div class="field" id="field-due-date" style="flex:1;"><label>ë§ˆê°ì¼</label><input type="date" id="input-due"></div>
      </div>

      <div class="field" id="field-priority"><label>ìš°ì„ ìˆœìœ„</label><select id="input-priority"><option value="ë†’ìŒ">ë†’ìŒ</option><option value="ë³´í†µ" selected>ë³´í†µ</option><option value="ë‚®ìŒ">ë‚®ìŒ</option></select></div>

      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥í•˜ê¸°</button>
        <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="log-modal-title" style="margin-top:0;">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <input type="hidden" id="log-edit-id"><input type="hidden" id="log-edit-mode" value="false">
      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title" placeholder="ì˜¤ëŠ˜ì˜ í•µì‹¬ ì‘ì—…"></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      <div class="field admin-field-full" id="log-idea-section" style="background:#f0fdf4; padding:16px; border-radius:12px; border:1px dashed #16a34a;">
        <label style="color:#15803d; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ (ì„ íƒ)</label>
        <input type="text" id="log-idea-input" placeholder="ì—¬ê¸°ì— ì ìœ¼ë©´ ì•„ì´ë””ì–´ ëª©ë¡ì— ì¶”ê°€ë¨" style="background:#fff; border-color:#86efac;">
      </div>
      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration" placeholder="ì˜ˆ: 2h"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags" placeholder="#ê°œë°œ #ê¸°íš"></div>
      <div class="field admin-field-full" style="margin-top:20px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center; padding:12px;">ì €ì¥</button>
        <button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center; padding:12px;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¡œë”© ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        renderGoalTree(); renderBoardView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchView(mode) {
    document.getElementById('btn-view-card').classList.toggle('active', mode==='card');
    document.getElementById('btn-view-board').classList.toggle('active', mode==='board');
    document.getElementById('view-card-container').style.display = (mode==='card')?'block':'none';
    document.getElementById('view-board-container').style.display = (mode==='board')?'block':'none';
  }

  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root');
    root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:40px;text-align:center;color:#94a3b8;">ë°ì´í„° ì—†ìŒ</div>`; return; }

    bigGoals.forEach(bg => {
      const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
      const card = document.createElement('div');
      card.className = "goal-card";
      
      const header = document.createElement('div');
      header.className = "goal-card-header";
      header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${adjustColor(themeColor, -20)} 100%)`;

      let dateHtml = "";
      if (bg['ì‹œì‘ì¼'] || bg['ë§ˆê°ì¼']) {
        const s = bg['ì‹œì‘ì¼'] ? bg['ì‹œì‘ì¼'].split('T')[0] : '';
        const e = bg['ë§ˆê°ì¼'] ? bg['ë§ˆê°ì¼'].split('T')[0] : '';
        dateHtml = `<div class="goal-date-badge">ğŸ—“ ${s} ~ ${e}</div>`;
      }
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc">${bg['ìƒì„¸ë‚´ìš©']}</div>` : '';
      
      header.innerHTML = `
        <div><div class="goal-card-title">${bg['ì œëª©']}</div>${dateHtml}${descHtml}</div>
        <div class="header-actions">
           <button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button>
           <button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = "mid-goal-group";

      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midItem = document.createElement('div');
        midItem.className = "mid-goal-item";
        midItem.style.borderLeftColor = themeColor; 

        let midDateHtml = "";
        if (mg['ì‹œì‘ì¼'] || mg['ë§ˆê°ì¼']) {
          const s = mg['ì‹œì‘ì¼'] ? mg['ì‹œì‘ì¼'].split('T')[0].slice(5) : '';
          const e = mg['ë§ˆê°ì¼'] ? mg['ë§ˆê°ì¼'].split('T')[0].slice(5) : '';
          midDateHtml = `<span class="mid-date-info">(${s}~${e})</span>`;
        }
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span style="font-weight:400; font-size:0.85rem; color:#64748b; margin-left:8px;">${mg['ìƒì„¸ë‚´ìš©']}</span>` : '';

        midItem.innerHTML = `
          <div class="mid-goal-header" onclick="toggleDisplay(this)">
            <span>ğŸš© ${mg['ì œëª©']} ${midDesc} ${midDateHtml}</span>
            <div onclick="event.stopPropagation()" class="row-actions">
              <button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button>
              <button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;

        const taskList = document.createElement('div');
        taskList.className = "task-list";
        const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        if(tasks.length > 0) tasks.forEach(t => taskList.appendChild(createTaskRow(t)));
        else taskList.innerHTML = `<div style="padding:15px;color:#cbd5e1;font-size:0.85rem;">í•  ì¼ ì—†ìŒ</div>`;
        
        midItem.appendChild(taskList);
        body.appendChild(midItem);
      });
      card.appendChild(body);
      root.appendChild(card);
    });
  }

  function createTaskRow(t) {
    const container = document.createElement('div');
    const row = document.createElement('div');
    row.className = "task-row";
    row.onclick = function() { const d = container.querySelector('.task-detail'); if(d) d.style.display=(d.style.display==="none")?"block":"none"; };
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    
    row.innerHTML = `
      <div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div>
      <div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:500;">
        ${t['ì œëª©']} ${t['ìƒì„¸ë‚´ìš©']?'<span style="font-size:0.75rem;color:#94a3b8;margin-left:4px;">ğŸ“</span>':''}
      </div>
      <div class="row-actions">
        <button class="row-btn" onclick="event.stopPropagation(); openEditModal('task', '${t.ID}')">âœï¸</button>
        <button class="row-btn delete" onclick="event.stopPropagation(); deleteItem('${t.ID}')">ğŸ—‘ï¸</button>
      </div>
    `;
    container.appendChild(row);
    if (t['ìƒì„¸ë‚´ìš©'] || t['ê¸°í•œ']) {
      const detail = document.createElement('div');
      detail.className = "task-detail";
      detail.innerHTML = (t['ìƒì„¸ë‚´ìš©']?`<div>${t['ìƒì„¸ë‚´ìš©']}</div>`:'') + (t['ê¸°í•œ']?`<div style="margin-top:6px; color:#3b82f6; font-weight:600;">ğŸ“… ${t['ê¸°í•œ'].split('T')[0]}</div>`:'');
      container.appendChild(detail);
    }
    return container;
  }

  function renderBoardView() {
    const tbody = document.getElementById('board-table-body');
    tbody.innerHTML = "";
    if(g_tasks.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#cbd5e1;">ë°ì´í„° ì—†ìŒ</td></tr>`; return; }
    const allTasks = [...g_tasks].sort((a,b) => (a['ìƒíƒœ']==='ì™„ë£Œ'?1:-1));
    allTasks.forEach(t => {
      const tr = document.createElement('tr');
      const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      let pathHtml = `<span style="color:#cbd5e1;">(ë¯¸ë¶„ë¥˜)</span>`;
      const midId = (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").split(',')[0];
      const mid = g_goals.find(g=>g.ID===midId);
      if(mid) {
        const big = g_goals.find(g=>g.ID===mid['ìƒìœ„ID']);
        const bgCol = big ? (big['ìƒ‰ìƒ'] || "#94a3b8") : "#94a3b8";
        pathHtml = `<div class="path-badge" style="background:${bgCol};">${big?big['ì œëª©']:'?'} > ${mid['ì œëª©']}</div>`;
      } else if(t['ìœ í˜•']==='ì•„ì´ë””ì–´') pathHtml = `<div class="path-badge" style="background:#d8b4fe; color:#6b21a8;">ğŸ’¡ ì•„ì´ë””ì–´</div>`;
      
      tr.innerHTML = `
        <td style="text-align:center;"><div class="check-circle ${isDone?'checked':''}" onclick="toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div></td>
        <td>${pathHtml}</td>
        <td><div style="font-weight:600; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}">${t['ì œëª©']}</div></td>
        <td style="color:#64748b; font-size:0.85rem;">${t['ê¸°í•œ'] ? t['ê¸°í•œ'].slice(5) : '-'}</td>
        <td style="text-align:center;"><div class="row-actions" style="justify-content:center; opacity:0.5;"><button class="row-btn" onclick="openEditModal('task', '${t.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${t.ID}')">ğŸ—‘ï¸</button></div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderLogs() {
    const root = document.getElementById('log-timeline-root');
    root.innerHTML = "";
    if(g_logs.length===0) { root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem;">ì‘ì—… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    g_logs.slice(0, 30).forEach(log => {
      const item = document.createElement('div'); item.className = "log-item";
      const dateStr = log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : '';
      const title = log['ì œëª©'] || "ì‘ì—… ê¸°ë¡";
      item.innerHTML = `
        <div class="log-dot"></div><div class="log-card">
          <div class="log-header"><div style="display:flex; align-items:center;"><span class="log-date">${dateStr}</span>${log['ì†Œìš”ì‹œê°„']?`<span class="log-duration">â± ${log['ì†Œìš”ì‹œê°„']}</span>`:''}</div><div class="log-actions"><button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button></div></div>
          <div class="log-title">${title}</div><div class="log-body">${log['ë‚´ìš©']}</div>${log['íƒœê·¸']?`<div><span class="log-tag">${log['íƒœê·¸']}</span></div>`:''}
        </div>`;
      root.appendChild(item);
    });
  }

  // === Utils & Modals ===
  function adjustColor(color, amount) { return color; } 
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function openLogModal() { document.getElementById('log-modal').classList.add('open'); document.getElementById('log-date').valueAsDate = new Date(); document.getElementById('log-edit-mode').value="false"; document.getElementById('log-form').reset(); document.getElementById('log-idea-section').style.display='block'; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function openModal(type) {
    document.getElementById('input-modal').classList.add('open'); document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡";
    document.getElementById('edit-mode').value = "false"; document.getElementById('todo-form').reset();
    document.querySelectorAll('input[name="type"]').forEach(r => r.disabled = false);
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }

  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    
    // âœ… ëª¨ë°”ì¼ ëŒ€ì‘: start-date, due-date í‘œì‹œ ì œì–´
    // í• ì¼/ì•„ì´ë””ì–´ëŠ” ë§ˆê°ì¼ë§Œ, ëª©í‘œëŠ” ì‹œì‘+ë§ˆê°ì¼
    if(isGoal) {
      document.getElementById('field-start-date').style.display = "block";
      document.getElementById('field-due-date').style.display = "block";
      document.getElementById('field-priority').style.display = "none";
    } else {
      document.getElementById('field-start-date').style.display = "none";
      document.getElementById('field-due-date').style.display = "block";
      document.getElementById('field-priority').style.display = "block";
    }
    
    document.getElementById('field-color').style.display = (type === "í° ëª©í‘œ") ? "block" : "none";
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id'); select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    opts.forEach(o => { const op = document.createElement('option'); op.value = o.ID; op.textContent = o['ì œëª©']; select.appendChild(op); });
  }

  // âœ… ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ë§ˆê°ì¼ ë§¤í•‘ ê°•í™”)
  function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìˆ˜ì •";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('edit-id').value = id;

    document.getElementById('input-title').value = item['ì œëª©'];
    document.getElementById('input-detail').value = item['ìƒì„¸ë‚´ìš©'] || "";
    
    // ìƒ‰ìƒ ë³µì›
    if (item['ìƒ‰ìƒ']) { const radio = document.querySelector(`input[name="color"][value="${item['ìƒ‰ìƒ']}"]`); if(radio) radio.checked = true; }

    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => { if(r.value === item['ìœ í˜•']) r.checked = true; else r.disabled = true; });
    
    toggleFormFields();

    // ë‚ ì§œ ë³µì› (ëª©í‘œ vs í• ì¼)
    if (item['ìœ í˜•'].includes("ëª©í‘œ")) {
        document.getElementById('input-start').value = (item['ì‹œì‘ì¼']||"").split('T')[0];
        document.getElementById('input-due').value = (item['ë§ˆê°ì¼']||"").split('T')[0];
        if(item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
        document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
        // âœ… í•  ì¼ ìˆ˜ì • ì‹œ ë§ˆê°ì¼ í™•ì‹¤í•˜ê²Œ ë³µì›
        document.getElementById('input-due').value = (item['ê¸°í•œ']||"").split('T')[0];
        document.getElementById('input-priority').value = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }
  }

  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id);
    if (!log) return;
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •";
    document.getElementById('log-edit-mode').value = "true"; document.getElementById('log-edit-id').value = id;
    document.getElementById('log-date').value = (log['ë‚ ì§œ']||"").split('T')[0]; document.getElementById('log-title').value = log['ì œëª©'] || "";
    document.getElementById('log-content').value = log['ë‚´ìš©'] || ""; document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || "";
    document.getElementById('log-tags').value = log['íƒœê·¸'] || ""; document.getElementById('log-idea-section').style.display = 'none';
  }

  async function toggleStatus(id, newStatus) { await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) }); loadAllData(); }
  async function deleteItem(id) { if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) }); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading(); }

  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('edit-mode').value === "true";
    const type = document.querySelector('input[name="type"]:checked').value;
    const color = document.querySelector('input[name="color"]:checked').value;
    const payload = { 
        mode: isEdit ? "editItem" : "addItem", id: document.getElementById('edit-id').value, type: type, 
        title: document.getElementById('input-title').value, parentId: document.getElementById('input-connected-id').value, 
        connectedId: document.getElementById('input-connected-id').value, detail: document.getElementById('input-detail').value, 
        startDate: document.getElementById('input-start').value, dueDate: document.getElementById('input-due').value, 
        priority: document.getElementById('input-priority').value, color: color 
    };
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) }); closeModal('input-modal'); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading();
  });

  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault(); const isEdit = document.getElementById('log-edit-mode').value === "true";
    const payload = { mode: isEdit ? "editItem" : "addLog", id: document.getElementById('log-edit-id').value, date: document.getElementById('log-date').value, title: document.getElementById('log-title').value, content: document.getElementById('log-content').value, duration: document.getElementById('log-duration').value, tags: document.getElementById('log-tags').value };
    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); const requests = [fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) })];
    const ideaVal = document.getElementById('log-idea-input').value; if (!isEdit && ideaVal.trim() !== "") requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaVal, detail: "ë¡œê·¸ íŒŒìƒ", priority: "ë³´í†µ" }) }));
    await Promise.all(requests); closeModal('log-modal'); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading();
  });
</script>
</body>
</html>
