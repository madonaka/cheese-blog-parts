<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cheese Lab Project</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

  <script>
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

<style>
    /* ... ê¸°ì¡´ CSS ë³€ìˆ˜ ... */
    :root { --bg-soft: #f8fafc; --border-color: #e2e8f0; --text-main: #1e293b; --text-sub: #64748b; --primary: #3b82f6; }
    
    .dashboard-layout { display: block; max-width: 1200px; margin: 0 auto; }
    .dashboard-layout > div { min-width: 0; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 1000px) { 
      .admin-main { 
        padding: 12px; 
        padding-top: calc(var(--admin-header-h, 64px) + 20px) !important; 
      } 
    }

    /* íƒ­ ë©”ë‰´ */
    .view-tabs { 
      display: flex; gap: 6px; margin-bottom: 20px; 
      background: #f1f5f9; padding: 4px; border-radius: 12px; 
      width: 100%; max-width: 100%; overflow-x: auto; white-space: nowrap; 
      -webkit-overflow-scrolling: touch; scrollbar-width: none; 
    }
    .view-tabs::-webkit-scrollbar { display: none; }

    .view-tab-btn { 
      padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; 
      border: none; background: transparent; color: var(--text-sub); 
      cursor: pointer; transition: all 0.2s; white-space: nowrap; 
      flex-shrink: 0; 
    }
    .view-tab-btn:hover { color: var(--text-main); }
    .view-tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* Goal Card */
    .goal-card { background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); transition: transform 0.2s; position: relative; }
    .goal-card-header { padding: 18px 24px; color: white; display: flex; justify-content: space-between; align-items: flex-start; cursor: pointer; }
    .goal-card-header:hover { opacity: 0.95; }
    .goal-card-title { font-size: 1.25rem; font-weight: 800; line-height: 1.3; max-width: 85%; display: flex; align-items: center; gap: 8px; }
    .goal-card-desc { font-size: 0.9rem; opacity: 0.95; margin-top: 6px; font-weight: 400; line-height: 1.4; }
    .goal-date-badge { display: inline-block; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 8px; font-size: 0.75rem; margin-top: 6px; font-weight: 500; }
    .header-actions .action-btn { background: rgba(255,255,255,0.25); border: none; color: white; border-radius: 6px; padding: 6px 10px; cursor: pointer; margin-left: 4px; }

    /* Mid/Task */
    .mid-goal-group { padding: 20px; border-top: 1px solid #f1f5f9; }
    .mid-goal-item { margin-top: 16px; background: #fff; border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
    .mid-goal-item:first-child { margin-top: 0; }
    .mid-goal-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); }
    .task-list { border-top: 1px solid var(--border-color); }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s; }
    .task-row:hover { background: #fdfdfd; }
    .row-actions { display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .mid-goal-header:hover .row-actions, .task-row:hover .row-actions { opacity: 1; }
    @media(max-width:600px){ .row-actions { opacity: 1; } }
    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: #94a3b8; }
    .row-btn:hover { color: var(--primary); } .row-btn.delete:hover { color: #ef4444; }

    /* ğŸš€ [NEW] ë³´ë“œ ë·° (Planner ìŠ¤íƒ€ì¼) */
    .board-wrapper { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 20px; height: calc(100vh - 220px); }
    .board-column { flex: 1; min-width: 280px; max-width: 400px; background: #f1f5f9; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    
    .column-header { padding: 14px; font-weight: 800; font-size: 1rem; border-radius: 12px 12px 0 0; color: white; text-align: center; }
    .header-high { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .header-normal { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .header-low { background: linear-gradient(135deg, #10b981, #059669); }

    .column-content { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
    .column-done-content { padding: 12px; display: flex; flex-direction: column; gap: 10px; background: #e2e8f0; border-radius: 0 0 12px 12px; border-top: 1px solid #cbd5e1; }

    .board-card { background: #fff; border-radius: 8px; padding: 12px 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; cursor: pointer; transition: transform 0.2s; position: relative; }
    .board-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .board-card.done { opacity: 0.7; background: #f8fafc; color: #94a3b8; }
    .board-card.done .board-card-title { text-decoration: line-through; }

    .board-card-title { font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; color: #1e293b; line-height: 1.4; }
    .board-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #64748b; }
    .board-date-badge { background: #eff6ff; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .board-overdue { background: #fef2f2; color: #ef4444; }

    .completed-toggle-btn { width: 100%; border: none; background: #cbd5e1; color: #475569; padding: 10px; font-weight: 700; cursor: pointer; text-align: center; transition: background 0.2s; font-size: 0.85rem; }
    .completed-toggle-btn:hover { background: #94a3b8; color: #fff; }
    
    /* ë²„ê·¸ íŠ¸ë˜ì»¤ ìŠ¤íƒ€ì¼ */
    .bug-container { border-top: 4px solid #ef4444; }
    .bug-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; flex-direction: column; height: 100%; border-top: 5px solid #ef4444; }
    .bug-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.15); }
    .bug-card.working { border: 2px solid #f87171; background: #fef2f2; }
    .bug-status-badge { position: absolute; top: -10px; right: 12px; background: #ef4444; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4); z-index: 2; }
    .bug-parent-info { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display:flex; align-items:center; gap:4px; }
    .bug-title { font-weight: 800; font-size: 1.05rem; margin-bottom: 8px; color: #7f1d1d; line-height: 1.3; }
    .bug-body { font-size: 0.9rem; color: #7f1d1d; opacity:0.8; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    .bug-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #fee2e2; padding-top: 12px; }
    .bug-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    .bug-btn.check { background: #fff1f2; color: #e11d48; } .bug-btn.check:hover { background: #ffe4e6; }
    .bug-btn.solve { background: #f0fdf4; color: #16a34a; } .bug-btn.solve:hover { background: #dcfce7; }
    .bug-btn.restore { background: #f1f5f9; color: #64748b; } .bug-btn.restore:hover { background: #e2e8f0; }

    /* Idea */
    .idea-container { padding: 0 4px; }
    .idea-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .idea-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .idea-card { background: #fff; border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; transition: all 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; flex-direction: column; height: 100%; border-top: 5px solid #d8b4fe; }
    .idea-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .idea-card.realized { border: 2px solid #60a5fa; background: #f8fbff; }
    .realized-badge { position: absolute; top: -10px; right: 12px; background: #3b82f6; color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 20px; font-weight: 800; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); z-index: 2; }
    .idea-header { display: flex; justify-content: flex-start; margin-bottom: 8px; }
    .idea-date { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .idea-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 8px; color: #1e293b; line-height: 1.3; }
    .idea-body { font-size: 0.9rem; color: #64748b; line-height: 1.5; flex-grow: 1; margin-bottom: 16px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
    .idea-footer { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #f1f5f9; padding-top: 12px; }
    .idea-btn { flex: 1; border: none; background: #f1f5f9; color: #64748b; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s; }
    .idea-btn:hover { background: #e2e8f0; color: #334155; }
    .idea-btn.plan { background: #eff6ff; color: #3b82f6; } .idea-btn.plan:hover { background: #dbeafe; }
    .idea-btn.done { background: #f0fdf4; color: #16a34a; } .idea-btn.done:hover { background: #dcfce7; }

    /* Log */
    .log-container { background: #fff; border-radius: 16px; padding: 32px; border: 1px solid var(--border-color); min-height: 600px; }
    .log-item { position: relative; padding-left: 24px; margin-bottom: 28px; max-width: 800px; }
    .log-item::before { content: ''; position: absolute; left: 7px; top: 24px; bottom: -30px; width: 2px; background: #e2e8f0; }
    .log-item:last-child::before { display: block; background: linear-gradient(to bottom, #e2e8f0 50%, transparent 100%); }
    .log-dot { position: absolute; left: 0; top: 6px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary); border-radius: 50%; }
    .log-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; transition: box-shadow 0.2s; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
    .log-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
    .log-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; display:flex; align-items:center; gap:4px; }
    .log-related { display: inline-block; font-size: 0.75rem; color: #059669; background: #ecfdf5; padding: 2px 8px; border-radius: 4px; font-weight: 600; margin-bottom: 6px; }
    .log-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.2s; }
    .log-card:hover .log-actions { opacity: 1; }
    .log-count-badge { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-left: 6px; display: inline-flex; align-items: center; gap: 3px; }
    .log-date-divider { display: flex; align-items: center; margin: 30px 0 15px; font-weight: 700; color: #475569; font-size: 0.9rem; }
    .log-date-divider::before, .log-date-divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }
    .log-date-divider::before { margin-right: 12px; } .log-date-divider::after { margin-left: 12px; }
    @media (max-width: 600px) { .log-container { padding: 16px; } .log-actions { opacity: 1; position: relative; top:0; right:0; margin-left: auto; } .log-header { flex-wrap: wrap; gap: 8px; } }

    /* Utils */
    .color-options { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .color-radio { display: none; }
    .color-label { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-radio:checked + .color-label { transform: scale(1.1); box-shadow: 0 0 0 2px #fff, 0 0 0 4px #94a3b8; }
    .check-circle { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1500; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: var(--primary); }
    .fab-sub { width: 48px; height: 48px; background: #475569; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }

    /* ëª¨ë‹¬ */
    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 32px; border-radius: 20px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    @media (max-width: 600px) { .date-group { flex-direction: column !important; gap: 10px !important; } .modal-box { width: 95% !important; padding: 20px !important; max-width: 100%; border-radius: 16px; } }
    
    /* ğŸ”¥ [ìˆ˜ì •] ë³´ê¸° ì „ìš© ë°•ìŠ¤ ë””ìì¸ (ë†’ì´ ë„‰ë„‰í•˜ê²Œ ë³´ì¥) */
    .view-content-box { 
      padding: 24px; 
      background: #ffffff; 
      border: 1px solid #cbd5e1; 
      border-radius: 12px; 
      min-height: 250px; /* í…ìŠ¤íŠ¸ê°€ ì ì–´ë„ ì¶©ë¶„í•œ ë†’ì´ë¥¼ ê°€ì§€ë„ë¡ ìˆ˜ì • */
      line-height: 1.75; 
      color: #334155; 
      margin-top: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      font-size: 0.95rem;
      letter-spacing: -0.01em;
      word-break: break-word; 
    }

    /* ë‚´ë¶€ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ë§ */
    .view-content-box img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 12px 0; }
    .view-content-box h1, .view-content-box h2, .view-content-box h3 { color: #1e293b; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 800; line-height: 1.3; }
    .view-content-box h1 { font-size: 1.4rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; }
    .view-content-box h2 { font-size: 1.25rem; }
    .view-content-box ul, .view-content-box ol { padding-left: 24px; margin: 12px 0; }
    .view-content-box li { margin-bottom: 4px; }
    .view-content-box p { margin-bottom: 12px; }
    .view-content-box blockquote { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0; color: #1e40af; font-style: italic; }
    .view-content-box hr { border: 0; border-top: 1px solid #e2e8f0; margin: 24px 0; }
    
    .modal-section { margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .section-title { font-size: 0.95rem; font-weight: 700; color: #475569; margin-bottom: 12px; display:flex; align-items:center; gap:6px; }
    
    /* íˆìŠ¤í† ë¦¬ ìŠ¤íƒ€ì¼ */
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    .history-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 0.9rem; position: relative; cursor: pointer; transition: background 0.2s; }
    .history-item:hover { background: #f1f5f9; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .history-date { font-weight: 700; color: #64748b; font-size: 0.75rem; background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .history-time { font-size: 0.75rem; color: #94a3b8; font-weight: 600; }
    .history-content { color: #334155; line-height: 1.5; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; white-space: normal; }
    .history-item.expanded .history-content { display: block; -webkit-line-clamp: unset; overflow: visible; }
    .history-item::after { content: 'â–¼ ë”ë³´ê¸°'; display: block; text-align: center; font-size: 0.7rem; color: #cbd5e1; margin-top: 6px; }
    .history-item.expanded::after { content: 'â–² ì ‘ê¸°'; }

    /* ê´€ë ¨ ì•„ì´ë””ì–´ */
    .mini-idea-grid { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; }
    .mini-idea-card { min-width: 200px; max-width: 200px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; border-top: 4px solid #d8b4fe; cursor: pointer; flex-shrink: 0; }
    .mini-idea-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .mini-idea-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .mini-idea-desc { font-size: 0.8rem; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
    
    #log-bug-section { background: #fef2f2; padding: 12px; border-radius: 8px; border: 1px dashed #ef4444; margin-top: 10px; }
    #log-bug-section label { color: #b91c1c; font-weight: 700; display:flex; align-items:center; gap:4px; }
    #log-bug-section input { border-color: #fca5a5; }
    
    .mid-idea-slider { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; scrollbar-width: thin; }
    .mid-idea-slider::-webkit-scrollbar { height: 6px; }
    .mid-idea-slider::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .mid-idea-card-mini { min-width: 180px; max-width: 180px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; cursor: pointer; flex-shrink: 0; border-top: 3px solid #d8b4fe; transition: transform 0.1s; display: flex; flex-direction: column; }
    .mid-idea-card-mini:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .mic-date { font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; }
    .mic-title { font-size: 0.85rem; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.3; }
    .mic-desc { font-size: 0.75rem; color: #64748b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  
    /* ì•„ì´ë””ì–´ íƒ­ & ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .idea-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 12px;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .idea-tab-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #64748b;
      background: #fff;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .idea-tab-btn:hover { background: #f8fafc; color: #334155; }
    .idea-tab-btn.active { background: #3b82f6; color: #fff; border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    
    .idea-tab-btn[data-cat="blog"].active { background: #db2777; border-color: #db2777; box-shadow: 0 4px 6px -1px rgba(219, 39, 119, 0.3); }
    .idea-tab-btn[data-cat="system"].active { background: #2563eb; border-color: #2563eb; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
    .idea-tab-btn[data-cat="biz"].active { background: #d97706; border-color: #d97706; box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.3); }
    .idea-tab-btn[data-cat="etc"].active { background: #64748b; border-color: #64748b; box-shadow: 0 4px 6px -1px rgba(100, 116, 139, 0.3); }
    .idea-tab-btn[data-cat="realized"].active { background: #10b981; border-color: #10b981; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
    
    .idea-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; min-height: 400px; }
    
    .idea-card-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; position: relative; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; border-top: 4px solid #cbd5e1; }
    .idea-card-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08); }
    
    .idea-card-item.cat-blog { border-top-color: #db2777; }
    .idea-card-item.cat-system { border-top-color: #2563eb; }
    .idea-card-item.cat-biz { border-top-color: #d97706; }
    .idea-card-item.cat-etc { border-top-color: #64748b; }
    .idea-card-item.is-realized { background: #f0fdf4; border: 1px solid #bbf7d0; border-top-color: #10b981; }
    
    .ici-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .ici-date { font-size: 0.75rem; color: #94a3b8; font-weight: 500; display: flex; align-items: center; gap: 4px; }
    .ici-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; color: #fff; }
    .ici-title { font-size: 1.05rem; font-weight: 700; color: #1e293b; margin-bottom: 8px; line-height: 1.3; }
    .ici-body { font-size: 0.9rem; color: #64748b; line-height: 1.5; flex: 1; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .ici-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed #e2e8f0; margin-top: auto; }

    .btn-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 6px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .btn.loading { position: relative; pointer-events: none; opacity: 0.7; }  

    /* ëª¨ë‹¬ ë°•ìŠ¤ ë ˆì´ì•„ì›ƒ */
    .modal-box {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 700px; 
      max-width: 95vw;
      height: auto;
      max-height: 90vh; 
      display: flex;
      flex-direction: column;
      overflow: hidden; 
    }

    /* í—¤ë” */
    .modal-header-custom { padding: 20px 32px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-title-custom { font-size: 1.5rem; font-weight: 800; color: #1e293b; }

    /* í¼ íƒœê·¸ê°€ ëª¨ë‹¬ ë°•ìŠ¤ë¥¼ ê°€ë“ ì±„ìš°ê²Œ ì„¤ì • */
    #todo-form, #log-form { display: flex; flex-direction: column; height: 100%; overflow: hidden; margin: 0; padding: 0; }

    /* ë°”ë”” (ìŠ¤í¬ë¡¤ ì˜ì—­) */
    .modal-body-custom { padding: 32px; background: #f8fafc; flex: 1; overflow-y: auto; min-height: 0; }

    .form-grid { display: grid; gap: 24px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .input-label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 700; color: #475569; }
    .styled-input { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; font-size: 1rem; color: #334155; transition: all 0.2s; box-sizing:border-box;}
    .styled-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

    .type-selector-wrapper { background: #e2e8f0; padding: 4px; border-radius: 14px; display: flex; gap: 4px; }
    .type-selector-wrapper label { flex: 1; text-align: center; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: #64748b; transition: all 0.2s; }
    .type-selector-wrapper input { display: none; } 
    .type-selector-wrapper input:checked + label { background: #fff; color: #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .type-selector-wrapper input[value="ë²„ê·¸"]:checked + label { color: #ef4444; }
    .type-selector-wrapper input[value="ì•„ì´ë””ì–´"]:checked + label { color: #db2777; }

    .color-chip-wrapper { display: flex; gap: 8px; flex-wrap: wrap; }
    .color-chip-option { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 20px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; font-weight: 600; color: #64748b; font-size: 0.9rem; transition: all 0.2s; }
    .color-radio { display: none; }
    .color-radio:checked + .color-chip-option { border-color: transparent; color: #fff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .color-radio[value="#db2777"]:checked + .color-chip-option { background: #db2777; }
    .color-radio[value="#2563eb"]:checked + .color-chip-option { background: #2563eb; }
    .color-radio[value="#d97706"]:checked + .color-chip-option { background: #d97706; }
    .color-radio[value="#64748b"]:checked + .color-chip-option { background: #64748b; }
    .color-radio[value="#4f46e5"]:checked + .color-chip-option { background: #4f46e5; }
    .color-radio[value="#059669"]:checked + .color-chip-option { background: #059669; }

    /* í‘¸í„° (ë²„íŠ¼ ì˜ì—­) */
    .modal-footer-custom { padding: 20px 32px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between !important; align-items: center; flex-shrink: 0; z-index: 10; gap: 12px; }
    .btn-close-custom { padding: 12px 24px; border-radius: 12px; border: 1px solid #e2e8f0; background: #fff; color: #64748b; font-weight: 700; cursor: pointer; }
    .btn-save-custom { padding: 12px 24px; border-radius: 12px; background: #10b981; color: #fff; font-weight: 700; border: none; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }
    .btn-save-custom:hover { background: #059669; }
    
    .btn-delete-custom { padding: 12px 20px; border-radius: 12px; background: #fff1f2; color: #e11d48; font-weight: 700; border: 1px solid #ffe4e6; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; }
    .btn-delete-custom:hover { background: #ffe4e6; color: #be123c; border-color: #fecdd3; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.15); }

    .btn-edit-custom { padding:12px 24px; border-radius:12px; background:#3b82f6; color:#fff; border:none; font-weight:700; cursor:pointer; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); transition: all 0.2s; }
    .btn-edit-custom:hover { background: #2563eb !important; transform: translateY(-2px); }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-overlay.open { display: flex; }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
    ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
    
    .sys-version-large { font-size: 1.1rem; font-weight: 800; color: #ef4444; background: #fee2e2; display: inline-block; padding: 4px 12px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    .board-card { cursor: grab; }
    .board-card:active { cursor: grabbing; }
    .board-card.dragging { opacity: 0.4; border: 2px dashed #3b82f6; transform: scale(0.98); }
    .board-column.drag-over { background: #e2e8f0; border: 2px dashed #94a3b8; }
    .board-header-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 6px; }
    .board-check-btn { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #cbd5e1; background: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; font-size: 13px; font-weight: 800; transition: all 0.2s; }
    .board-check-btn:hover { border-color: #10b981; color: #10b981; }
    .board-card.done .board-check-btn { background: #10b981; border-color: #10b981; color: white; }
    .board-card-title-wrap { flex: 1; line-height: 1.3; }

    .progress-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 14px; }
    .progress-bar-bg { flex: 1; height: 8px; background: rgba(255, 255, 255, 0.3); border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
    .progress-bar-fill { height: 100%; background: #fff; border-radius: 4px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    .progress-text { font-size: 0.9rem; font-weight: 800; color: #fff; min-width: 45px; text-align: right; }
    
    .mid-progress-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 8px; width: 100%; }
    .mid-progress-bg { flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .mid-progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    .mid-progress-text { font-size: 0.75rem; font-weight: 800; color: #64748b; }
    
    .d-day-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 800; background: rgba(255, 255, 255, 0.2); color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.3); white-space: nowrap; }
    .d-day-badge.danger { background: #ef4444; color: #fff; border-color: #f87171; animation: pulse-danger 2s infinite; }
    @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    /* ğŸ”¥ [í•„ìˆ˜] TinyMCE ë©”ë‰´ê°€ ëª¨ë‹¬ ë’¤ë¡œ ìˆ¨ì§€ ì•Šë„ë¡ í•˜ëŠ” ìµœìƒë‹¨ z-index */
    .tox-tinymce-aux { 
        z-index: 99999 !important; 
    }
</style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin: 0;">Dashboard</h2>
        <p style="color: var(--text-sub); margin-top: 4px;">í”„ë¡œì íŠ¸ í˜„í™© ê´€ë¦¬</p>
        <div id="sysVersion" class="sys-version-large">Checking version...</div>
      </div>

      <div class="dashboard-layout">
        <div style="text-align: right; margin-bottom: 10px;">
            <button id="btn-toggle-completed" class="btn" onclick="toggleCompletedGoals()" style="background-color: #f1f5f9; color: #475569; border: 1px solid #cbd5e1;">
                âœ… ì™„ë£Œëœ í•­ëª© ìˆ¨ê¸°ê¸° (ON)
            </button>
        </div>
        <div class="view-tabs">
          <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜•</button>
          <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ê²Œì‹œíŒ</button>
          <button class="view-tab-btn" onclick="switchView('bug')" id="btn-view-bug">ğŸ ë²„ê·¸ íŠ¸ë˜ì»¤</button> 
          <button class="view-tab-btn" onclick="switchView('idea')" id="btn-view-idea">ğŸ’¡ ì•„ì´ë””ì–´ í•¨</button>
          <button class="view-tab-btn" onclick="switchView('log')" id="btn-view-log">ğŸ“ ì‘ì—… ë¡œê·¸</button>
        </div>
        
        <div id="view-card-container"><div id="goal-tree-root"><div class="goal-card" style="padding:40px; text-align:center; color:#94a3b8; background:#f1f5f9;">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
        
        <div id="view-board-container" style="display:none;">

        <div class="board-toolbar" style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; background: #f8fafc; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; flex-wrap: wrap;">
             <span style="font-weight: 700; color: #475569;">ğŸ¯ ëª©í‘œ í•„í„°:</span>
             
             <select id="board-filter-big" class="styled-input" style="max-width: 280px; padding: 8px 12px; font-weight: 600;" onchange="onChangeBigGoalFilter()">
                <option value="all">ğŸ† ì „ì²´ í° ëª©í‘œ (ëª¨ë“  í•  ì¼)</option>
             </select>

             <select id="board-filter-mid" class="styled-input" style="max-width: 280px; padding: 8px 12px; font-weight: 600; display: none;" onchange="renderBoardView()">
                <option value="all">ğŸš© ì „ì²´ ì¤‘ê°„ ëª©í‘œ</option>
             </select>
          </div>
          
          <div class="board-wrapper">
            <div class="board-column">
              <div class="column-header header-high">ğŸ”¥ ë†’ìŒ (High)</div>
              <div id="board-col-high" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('high')">
                   âœ… ì™„ë£Œë¨ <span id="count-high-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-high-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
            <div class="board-column">
              <div class="column-header header-normal">ğŸ”µ ë³´í†µ (Normal)</div>
              <div id="board-col-normal" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('normal')">
                   âœ… ì™„ë£Œë¨ <span id="count-normal-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-normal-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
            <div class="board-column">
              <div class="column-header header-low">ğŸŒ± ë‚®ìŒ (Low)</div>
              <div id="board-col-low" class="column-content"></div>
              <div class="column-footer">
                 <button class="completed-toggle-btn" onclick="toggleBoardCompleted('low')">
                   âœ… ì™„ë£Œë¨ <span id="count-low-done">(0)</span> â–¼
                 </button>
                 <div id="board-col-low-done" class="column-done-content" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="view-bug-container" style="display:none;">
          <div class="idea-container">
            <div class="idea-toolbar">
              <span style="font-size:0.9rem; color:#b91c1c; font-weight:600;">ğŸš¨ ë°œê²¬ëœ ë²„ê·¸ ë° ì´ìŠˆ íŠ¸ë˜ì»¤</span>
              <label style="cursor:pointer; display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                <input type="checkbox" id="toggle-bug-archive" onchange="renderBugView()">
                <span>âœ… í•´ê²°ëœ ë²„ê·¸ ë³´ê¸° (ì•„ì¹´ì´ë¸Œ)</span>
              </label>
            </div>
            <div id="bug-grid-root" class="idea-grid"></div>
          </div>
        </div>

      <div id="view-idea-container" style="display:none;">
        <div class="idea-container">
          <div class="idea-toolbar" style="margin-bottom: 10px;">
            <div style="display:flex; flex-direction:column;">
              <span style="font-size:1.1rem; color:#1e293b; font-weight:800;">ğŸ’¡ ì•„ì´ë””ì–´ ë±…í¬</span>
              <span style="font-size:0.85rem; color:#64748b;">ë²ˆëœ©ì´ëŠ” ì˜ê°ì„ ê¸°ë¡í•˜ê³  ì‹¤í˜„í•´ë³´ì„¸ìš”.</span>
            </div>
            <select id="idea-sort-select" class="sort-select" onchange="renderIdeaView()">
              <option value="newest">ğŸ“… ìµœì‹ ìˆœ</option>
              <option value="oldest">â³ ì˜¤ë˜ëœìˆœ</option>
            </select>
          </div>
      
          <div class="idea-nav">
            <button class="idea-tab-btn active" onclick="switchIdeaTab('all')" id="itab-all">ğŸ“‚ ì „ì²´</button>
            <button class="idea-tab-btn" onclick="switchIdeaTab('blog')" id="itab-blog" data-cat="blog">ğŸ“ ë¸”ë¡œê·¸</button>
            <button class="idea-tab-btn" onclick="switchIdeaTab('system')" id="itab-system" data-cat="system">âš™ï¸ ì‹œìŠ¤í…œ</button>
            <button class="idea-tab-btn" onclick="switchIdeaTab('biz')" id="itab-biz" data-cat="biz">ğŸ§€ ì‚¬ì—…/êµ¬ìƒ</button>
            <button class="idea-tab-btn" onclick="switchIdeaTab('etc')" id="itab-etc" data-cat="etc">ğŸ’­ ì¡ë‹´/ìƒê°</button>
            <div style="width:1px; background:#e2e8f0; margin:0 4px;"></div>
            <button class="idea-tab-btn" onclick="switchIdeaTab('realized')" id="itab-realized" data-cat="realized">ğŸš€ ì‹¤í˜„ë¨</button>
          </div>
      
          <div id="idea-list-root" class="idea-list-grid"></div>
        </div>
      </div>

        <div id="view-log-container" style="display:none;">
          <div class="log-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; font-size: 1.3rem; font-weight: 700;">ğŸ“ ì „ì²´ ì‘ì—… íƒ€ì„ë¼ì¸</h3>
              <button
                type="button"
                class="btn btn-primary"
                style="padding: 10px 16px; font-size: 0.95rem; z-index: 10;"
                onclick="event.preventDefault(); event.stopPropagation(); openLogModal();"
              >  + ìƒˆ ê¸°ë¡ ì‘ì„±</button>
            </div>
            
           <div class="log-filter-toolbar" style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0; flex-wrap: wrap;">
              <span style="font-weight: 700; color: #475569;">ğŸ“… ê¸°ê°„ í•„í„°:</span>
              <input type="date" id="log-filter-start" class="styled-input" style="max-width: 150px; padding: 6px 10px;" onchange="renderLogs()">
              <span style="color: #94a3b8; font-weight: bold;">~</span>
              <input type="date" id="log-filter-end" class="styled-input" style="max-width: 150px; padding: 6px 10px;" onchange="renderLogs()">
              <button class="btn" style="background: #e2e8f0; color: #475569; padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s;" onclick="clearLogFilter()" onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">ì´ˆê¸°í™”</button>
            </div>
            
            <div id="log-timeline-root"></div>
            
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;">
    <button type="button" class="fab-btn fab-sub" onclick="event.stopPropagation(); openLogModal();" title="ìƒˆ ì‘ì—… ê¸°ë¡">ğŸ“</button>
  </div>
  <div style="position:relative;">
    <button type="button" class="fab-btn fab-main" onclick="event.stopPropagation(); openModal('í•  ì¼');" title="ìƒˆ í•­ëª© ë“±ë¡">+</button>
  </div>
</div>

<div id="input-modal" class="modal-overlay">
  <div class="modal-box">
    <form id="todo-form">
      <input type="hidden" id="edit-mode" value="false">
      <input type="hidden" id="edit-id">
      <input type="hidden" id="origin-idea-id"> 
      
      <div class="modal-header-custom">
        <span class="modal-title-custom" id="todo-modal-title">ìƒˆ í•­ëª©</span>
      </div>

      <div class="modal-body-custom">
        <div class="form-grid">
          
          <div class="form-group">
            <label class="input-label">í•­ëª© ìœ í˜•</label>
            <div class="type-selector-wrapper" onchange="toggleFormFields()">
              <input type="radio" name="type" id="type-task" value="í•  ì¼" checked><label for="type-task">í•  ì¼</label>
              <input type="radio" name="type" id="type-idea" value="ì•„ì´ë””ì–´"><label for="type-idea">ğŸ’¡ ì•„ì´ë””ì–´</label>
              <input type="radio" name="type" id="type-bug" value="ë²„ê·¸"><label for="type-bug">ğŸ”¥ ë²„ê·¸</label>
              <input type="radio" name="type" id="type-mid" value="ì¤‘ê°„ ëª©í‘œ"><label for="type-mid">ğŸš© ì¤‘ê°„ ëª©í‘œ</label>
              <input type="radio" name="type" id="type-big" value="í° ëª©í‘œ"><label for="type-big">ğŸ† í° ëª©í‘œ</label>
            </div>
          </div>

          <div class="form-group" id="field-title">
            <label class="input-label">ì œëª©</label>
            <input type="text" id="input-title" class="styled-input" placeholder="ë¬´ì—‡ì„ í•´ì•¼ í•˜ë‚˜ìš”?" required autocomplete="off">
          </div>

          <div class="form-group" id="field-color" style="display:none;">
            <label class="input-label" id="label-color-theme">ë¶„ë¥˜ ì„ íƒ</label>
            
            <div id="color-picker-goal" class="color-chip-wrapper" style="display:none;">
                <label><input type="radio" name="color_goal" value="#4f46e5" class="color-radio" checked><span class="color-chip-option">ì¸ë””ê³ </span></label>
                <label><input type="radio" name="color_goal" value="#059669" class="color-radio"><span class="color-chip-option">ì—ë©”ë„ë“œ</span></label>
                <label><input type="radio" name="color_goal" value="#db2777" class="color-radio"><span class="color-chip-option">í•‘í¬</span></label>
                <label><input type="radio" name="color_goal" value="#d97706" class="color-radio"><span class="color-chip-option">ì— ë²„</span></label>
            </div>
            
            <div id="color-picker-idea" class="color-chip-wrapper" style="display:none;">
                <label><input type="radio" name="color_idea" value="#db2777" class="color-radio"><span class="color-chip-option">ğŸ“ ë¸”ë¡œê·¸</span></label>
                <label><input type="radio" name="color_idea" value="#2563eb" class="color-radio"><span class="color-chip-option">âš™ï¸ ì‹œìŠ¤í…œ</span></label>
                <label><input type="radio" name="color_idea" value="#d97706" class="color-radio"><span class="color-chip-option">ğŸ§€ ì‚¬ì—…</span></label>
                <label><input type="radio" name="color_idea" value="#64748b" class="color-radio" checked><span class="color-chip-option">ğŸ’­ ì¡ë‹´</span></label>
            </div>
          </div>

          <div class="form-group" id="field-parent">
            <label class="input-label" id="label-parent">ì—°ê²°ëœ ëª©í‘œ</label>
            <select id="input-connected-id" class="styled-input">
              <option value="">(ì„ íƒ ì—†ìŒ)</option>
            </select>
            <div style="font-size:0.8rem; color:#94a3b8; margin-top:4px;">* ìƒìœ„ ëª©í‘œë¥¼ ì„ íƒí•˜ë©´ êµ¬ì¡°í™”ë˜ì–´ ê´€ë¦¬ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="form-group" id="field-detail">
            <label class="input-label">ìƒì„¸ ë‚´ìš©</label>
            
            <div id="view-detail-content" class="view-content-box" style="display:none; overflow-y:auto; max-height:500px;"></div>
            
            <textarea id="input-detail" style="width: 100%; height: 500px;"></textarea>
          </div>  
          
          <div class="form-row">
            <div class="form-group" id="field-start-date" style="display:none;">
              <label class="input-label">ì‹œì‘ì¼</label>
              <input type="date" id="input-start" class="styled-input">
            </div>

            <div class="form-group" id="field-due-date">
              <label class="input-label">ë§ˆê°ì¼ / ì¼ì</label>
              <input type="date" id="input-due" class="styled-input">
            </div>

            <div class="form-group" id="field-priority">
              <label class="input-label">ìš°ì„ ìˆœìœ„</label>
              <select id="input-priority" class="styled-input">
                <option value="ë‚®ìŒ">ğŸŸ¢ ë‚®ìŒ (ì²œì²œíˆ)</option>
                <option value="ë³´í†µ" selected>ğŸ”µ ë³´í†µ (ì¼ë°˜ì )</option>
                <option value="ë†’ìŒ">ğŸ”´ ë†’ìŒ (ê¸‰í•¨!)</option>
                <option value="ê¸´ê¸‰">ğŸ”¥ ê¸´ê¸‰ (ì§€ê¸ˆ ë‹¹ì¥)</option>
              </select>
            </div>
          </div>
          
          <div id="related-history-section" style="display:none; margin-top:20px; padding-top:20px; border-top:1px dashed #cbd5e1;">
             <label class="input-label">ğŸ“‹ ì‘ì—… íˆìŠ¤í† ë¦¬</label>
             <div id="history-list-root" style="font-size:0.9rem; color:#64748b;"></div>
          </div>

          <div id="related-idea-section" style="display:none; margin-top:20px; padding:15px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">
             <label class="input-label" style="color:#0369a1;">ğŸ’¡ ì—°ê²°ëœ ì•„ì´ë””ì–´</label>
             <div id="related-idea-root" style="font-size:0.9rem; color:#0c4a6e;"></div>
          </div>

        <div class="modal-footer-custom">
          <div id="footer-left-actions">
            <button type="button" class="btn-delete-custom" id="btn-delete-modal" onclick="deleteFromModal()" style="display:none;">ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</button>
            
            <button type="button" id="btn-close-project" class="btn-save-custom" style="background-color: #1d4ed8; color: white; display: none; margin-left: 8px;" onclick="closeProjectWithAI(document.getElementById('id').value)">
              ğŸ¯ í”„ë¡œì íŠ¸ ë§ˆê° (AI)
            </button>
          </div>

          <div style="display: flex; gap: 12px;">
            <button type="button" class="btn-close-custom" onclick="closeModal('input-modal')">ë‹«ê¸°</button>
            <button type="button" class="btn-edit-custom" id="btn-switch-edit" onclick="toggleEditMode(true)">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
            <button type="submit" class="btn-save-custom" id="btn-save-submit" style="display:none;">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
          </div>
        </div>

    </form>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    
    <div class="modal-header-custom">
      <span class="modal-title-custom" id="log-modal-title">ì‘ì—… ê¸°ë¡</span>
    </div>
    
    <form id="log-form">
      
      <div class="modal-body-custom" style="display: flex; flex-direction: column; gap: 20px;">
        <input type="hidden" id="log-edit-id">
        <input type="hidden" id="log-edit-mode" value="false">
        
        <div class="field">
            <label class="input-label">ë‚ ì§œ</label>
            <input type="date" id="log-date" class="styled-input" required>
        </div>
        
        <div class="field">
            <label class="input-label">ì œëª© (ì„ íƒ)</label>
            <input type="text" id="log-title" class="styled-input" placeholder="ì‘ì—…ì˜ í•µì‹¬ ìš”ì•½ì„ ì ì–´ì£¼ì„¸ìš”">
        </div>
        
        <div class="field" style="background:#f0f9ff; padding:16px; border-radius:12px; border:1px solid #bae6fd;">
            <label class="input-label" style="color:#0284c7; margin-bottom:8px;">ğŸ”— ê´€ë ¨ ì‘ì—… ì—°ë™ (ì„ íƒ)</label>
            <select id="log-related-id" class="styled-input" style="border-color:#bae6fd;">
                <option value="">(ì—†ìŒ)</option>
            </select>
            <p style="font-size:0.75rem; color:#0ea5e9; margin:6px 0 0;">* ì´ ë¡œê·¸ë¥¼ ì§„í–‰ ì¤‘ì¸ íŠ¹ì • ì‘ì—…ê³¼ ì—°ê²°í•©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="field">
            <label class="input-label">ë‚´ìš©</label>
            <textarea id="log-content" class="styled-input" required style="min-height:120px; resize:vertical;" placeholder="ì–´ë–¤ ì‘ì—…ì„ í•˜ì…¨ë‚˜ìš”?"></textarea>
        </div>
        
        <div class="field" id="log-idea-section" style="background:#f0fdf4; padding:16px; border-radius:12px; border:1px dashed #16a34a;">
            <label class="input-label" style="color:#15803d; margin-bottom:8px;">ğŸ’¡ ì•„ì´ë””ì–´ (ì„ íƒ)</label>
            <input type="text" id="log-idea-input" class="styled-input" placeholder="ì‘ì—… ì¤‘ ë– ì˜¤ë¥¸ ì•„ì´ë””ì–´ë¥¼ ì ìœ¼ë©´ ì•„ì´ë””ì–´ í•¨ì— ì¶”ê°€ë©ë‹ˆë‹¤" style="border-color:#86efac;">
        </div>
        
        <div class="field" id="log-bug-section" style="background:#fef2f2; padding:16px; border-radius:12px; border:1px dashed #ef4444;">
          <label class="input-label" style="color:#b91c1c; margin-bottom:8px;">ğŸ ë²„ê·¸ ë°œê²¬ (ì„ íƒ)</label>
          <div style="display:flex; flex-direction:column; gap:10px;">
              <input type="text" id="log-bug-input" class="styled-input" placeholder="ë²„ê·¸ ì œëª© (ì˜ˆ: ë¡œê·¸ì¸ ì‹œ 404 ì—ëŸ¬)" style="border-color:#fca5a5;">
              <textarea id="log-bug-detail" class="styled-input" placeholder="ë²„ê·¸ ìƒì„¸ ë‚´ìš© (ë°œìƒ ê²½ë¡œ, ì¦ìƒ ë“±)" style="border-color:#fca5a5; min-height:80px; resize:vertical;"></textarea>
          </div>
          <p style="font-size:0.75rem; color:#ef4444; margin:6px 0 0;">* ì…ë ¥ ì‹œ 'ë²„ê·¸' í•­ëª©ìœ¼ë¡œ ìë™ ë“±ë¡ë˜ë©°, ì´ ë¡œê·¸ì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="field">
                <label class="input-label">ì†Œìš” ì‹œê°„</label>
                <input type="text" id="log-duration" class="styled-input" placeholder="ì˜ˆ: 2ì‹œê°„ 30ë¶„">
            </div>
            <div class="field">
                <label class="input-label">íƒœê·¸</label>
                <input type="text" id="log-tags" class="styled-input" placeholder="ì˜ˆ: íšŒì˜, ê¸°íš">
            </div>
        </div>
      </div>
      
      <div class="modal-footer-custom">
        <button type="button" class="btn-close-custom" onclick="closeModal('log-modal')">ì·¨ì†Œ</button>
        <button type="submit" class="btn-save-custom" style="background:#3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      </div>

    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

 // âœ… 1. ì—ë””í„° ì´ˆê¸°í™” ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ë³€ìˆ˜ì™€ í•¨ìˆ˜ ì¶”ê°€
  let isTinyMCEInitialized = false;

  async function initTinyMCEIfNeeded() {
    if (isTinyMCEInitialized) return;
    
    // ëª¨ë‹¬ì´ í™”ë©´ì— ì—´ë¦° ì§í›„ì— ì—ë””í„°ë¥¼ ìƒì„±í•´ì•¼ 'ë¨¹í†µ(í´ë¦­ ë¶ˆê°€)' ë²„ê·¸ê°€ ìƒê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤.
    await tinymce.init({
      selector: '#input-detail',
      height: 500,
      language: 'ko_KR',
      plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
      toolbar: [
        'fontfamily fontsize blocks | bold italic underline strikethrough | forecolor backcolor removeformat',
        'alignleft aligncenter alignright alignjustify | bullist numlist | outdent indent | table link image | undo redo code fullscreen'
      ],
      toolbar_mode: 'wrap',
      menubar: false,
      branding: false,
      font_family_formats: 'Pretendard=Pretendard,sans-serif; ë§‘ì€ ê³ ë”•=Malgun Gothic,sans-serif; ë‹ì›€=Dotum,sans-serif; êµ´ë¦¼=Gulim,sans-serif; Arial=arial,helvetica,sans-serif;',
      valid_elements: '*[*]',
      extended_valid_elements: '*[*]',
      verify_html: false
    });
    isTinyMCEInitialized = true;
  }

  // âœ… DOMContentLoadedì—ì„œëŠ” ë°ì´í„°ë§Œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
  document.addEventListener('DOMContentLoaded', () => {
    loadAllData();
  });

  function toggleBtnLoading(btn, isLoading) {
    if (!btn) return;
    if (isLoading) {
      btn.dataset.originalText = btn.innerHTML; 
      btn.style.width = getComputedStyle(btn).width; 
      btn.classList.add('loading');
      btn.disabled = true;
      btn.innerHTML = `<span class="btn-spinner"></span> ì €ì¥ ì¤‘...`;
    } else {
      btn.classList.remove('loading');
      btn.disabled = false;
      btn.innerHTML = btn.dataset.originalText;
      btn.style.width = ''; 
    }
  }
  
  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        updateBoardFilterOptions();
        renderGoalTree(); renderBoardView(); renderBugView(); renderIdeaView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  let g_currentIdeaTab = 'all';
  
  function switchIdeaTab(tabName) {
    g_currentIdeaTab = tabName;
    document.querySelectorAll('.idea-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('itab-' + tabName).classList.add('active');
    renderIdeaView();
  }
  
  function switchView(mode) {
    document.querySelectorAll('.view-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('btn-view-' + mode).classList.add('active');
    
    const containers = ['card', 'board', 'bug', 'idea', 'log'];
    containers.forEach(c => {
        document.getElementById('view-' + c + '-container').style.display = (c === mode) ? 'block' : 'none';
    });
    
    if(mode === 'board') renderBoardView();
    if(mode === 'bug') renderBugView();
    if(mode === 'idea') renderIdeaView();
    if(mode === 'log') renderLogs();
  }

function renderGoalTree() {
    const root = document.getElementById('goal-tree-root'); root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ' && (!window.hideCompleted || g['ìƒíƒœ'] !== 'ì™„ë£Œ'));
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:40px;text-align:center;color:#94a3b8;">ë°ì´í„° ì—†ìŒ</div>`; return; }
    
    bigGoals.forEach(bg => {
      const themeColor = bg['ìƒ‰ìƒ'] || "#4f46e5";
      const card = document.createElement('div'); card.className = "goal-card";
      
      const header = document.createElement('div'); 
      header.className = "goal-card-header"; 
      header.style.background = `linear-gradient(135deg, ${themeColor} 0%, ${adjustColor(themeColor,-20)} 100%)`;
      
      header.onclick = function() {
        const body = card.querySelector('.mid-goal-group');
        const icon = header.querySelector('.toggle-icon');
        if (body.style.display === "none") { body.style.display = "block"; icon.textContent = "â–¼"; } 
        else { body.style.display = "none"; icon.textContent = "â–¶"; }
      };

      let dateHtml = ""; if (bg['ì‹œì‘ì¼'] || bg['ë§ˆê°ì¼']) { const s = bg['ì‹œì‘ì¼']?bg['ì‹œì‘ì¼'].split('T')[0]:''; const e = bg['ë§ˆê°ì¼']?bg['ë§ˆê°ì¼'].split('T')[0]:''; dateHtml = `<div class="goal-date-badge" style="margin-top:0;">ğŸ—“ ${s} ~ ${e}</div>`; }
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc" style="margin-top:10px;">${bg['ìƒì„¸ë‚´ìš©'].replace(/<[^>]*>?/gm, '')}</div>` : '';
      
      const progressRate = calculateProgress(bg.ID, true);
      const ddayInfo = calculateDday(bg['ë§ˆê°ì¼']);
      const ddayHtml = ddayInfo ? `<div class="d-day-badge ${ddayInfo.isDanger ? 'danger' : ''}">${ddayInfo.text}</div>` : '';
      
      header.innerHTML = `
        <div style="flex:1;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div class="goal-card-title"><span class="toggle-icon">â–¶</span> ${bg['ì œëª©']}</div>
            ${ddayHtml}
          </div>
          <div style="margin-top:6px;">${dateHtml}</div>
          ${descHtml}
          
          <div class="progress-wrapper">
             <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${progressRate}%;"></div></div>
             <div class="progress-text">${progressRate}%</div>
          </div>
        </div>
        <div class="header-actions" onclick="event.stopPropagation()" style="margin-left: 12px; flex-shrink: 0;">
           <button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button>
           <button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(header);

      const body = document.createElement('div'); 
      body.className = "mid-goal-group";
      body.style.display = "none"; 

      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midItem = document.createElement('div'); 
        midItem.className = "mid-goal-item"; 
        midItem.style.borderLeftColor = themeColor;
        
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span style="font-weight:400; font-size:0.85rem; color:#64748b; margin-left:8px;">${mg['ìƒì„¸ë‚´ìš©'].replace(/<[^>]*>?/gm, '')}</span>` : '';
        const midProgressRate = calculateProgress(mg.ID, false);
        
        const midHeader = document.createElement('div');
        midHeader.className = "mid-goal-header";
        
        midHeader.onclick = function() { 
            toggleDisplay(this); 
            const icon = this.querySelector('.mid-toggle-icon');
            if(icon) { icon.textContent = icon.textContent === 'â–¶' ? 'â–¼' : 'â–¶'; }
        };
        
        midHeader.innerHTML = `
          <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span><span class="mid-toggle-icon" style="display:inline-block; width:16px; font-size:0.8rem; color:#94a3b8;">â–¶</span> ğŸš© ${mg['ì œëª©']} ${midDesc}</span>
                  <div onclick="event.stopPropagation()" class="row-actions">
                      <button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button>
                      <button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button>
                  </div>
              </div>
              <div class="mid-progress-wrapper">
                 <div class="mid-progress-bg"><div class="mid-progress-fill" style="width: ${midProgressRate}%; background: ${themeColor};"></div></div>
                 <div class="mid-progress-text">${midProgressRate}%</div>
              </div>
          </div>
        `;
        midItem.appendChild(midHeader);

        const contentWrapper = document.createElement('div');
        contentWrapper.style.display = "none"; 

        const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        if (relatedIdeas.length > 0) {
          const slider = document.createElement('div');
          slider.className = "mid-idea-slider"; 
          
          let sliderHtml = "";
          relatedIdeas.forEach(idea => {
             const iDate = idea['ê¸°í•œ'] ? idea['ê¸°í•œ'].split('T')[0] : '';
             const iDesc = (idea['ìƒì„¸ë‚´ìš©']||"").replace(/<[^>]*>?/gm, ''); 
             sliderHtml += `
               <div class="mid-idea-card-mini" onclick="openEditModal('idea', '${idea.ID}')">
                 <div class="mic-date">ğŸ’¡ ${iDate}</div>
                 <div class="mic-title">${idea['ì œëª©']}</div>
                 <div class="mic-desc">${iDesc || '(ë‚´ìš© ì—†ìŒ)'}</div>
               </div>
             `;
          });
          slider.innerHTML = sliderHtml;
          contentWrapper.appendChild(slider);
        }

        const taskList = document.createElement('div'); 
        taskList.className = "task-list";
        const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID) && t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸');        
        if(tasks.length > 0) {
          tasks.forEach(t => {
              // í° ëª©í‘œê°€ ì§„í–‰ ì¤‘ì´ë¯€ë¡œ, ì™„ë£Œëœ í•  ì¼ë„ ì·¨ì†Œì„  ìƒíƒœë¡œ ê³„ì† ë³´ì—¬ì¤ë‹ˆë‹¤.
              taskList.appendChild(createTaskRow(t));
          });
        }
        else if(relatedIdeas.length === 0) taskList.innerHTML = `<div style="padding:15px;color:#cbd5e1;font-size:0.85rem;">í•  ì¼ ì—†ìŒ</div>`;
        
        contentWrapper.appendChild(taskList);
        midItem.appendChild(contentWrapper);
        body.appendChild(midItem);
      });
      card.appendChild(body); root.appendChild(card);
    });
}
  
  function createTaskRow(t) {
    const container = document.createElement('div'); const row = document.createElement('div'); row.className = "task-row";
    row.onclick = function() { openEditModal('task', t.ID); };
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    const relatedCount = g_logs.filter(l => l['ê´€ë ¨_ëª©í‘œID'] === t.ID).length;
    const badgeHtml = relatedCount > 0 ? `<span class="log-count-badge">ğŸ“ ${relatedCount}</span>` : '';
    const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '<span style="color:#ef4444;font-weight:bold;margin-right:4px;">[BUG]</span> ' : '';
    row.innerHTML = `<div class="check-circle ${isDone?'checked':''}" onclick="event.stopPropagation(); toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div><div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#cbd5e1':'#334155'}; font-weight:500;">${prefix}${t['ì œëª©']} ${t['ìƒì„¸ë‚´ìš©']?'<span style="font-size:0.75rem;color:#94a3b8;margin-left:4px;">ğŸ“</span>':''} ${badgeHtml}</div>`;
    container.appendChild(row); return container;
  }

  function renderBoardView() {
    const cols = {
      'high': { active: document.getElementById('board-col-high'), done: document.getElementById('board-col-high-done'), doneCount: 0 },
      'normal': { active: document.getElementById('board-col-normal'), done: document.getElementById('board-col-normal-done'), doneCount: 0 },
      'low': { active: document.getElementById('board-col-low'), done: document.getElementById('board-col-low-done'), doneCount: 0 }
    };

    Object.values(cols).forEach(c => { 
        if(c.active) c.active.innerHTML = ""; 
        if(c.done) c.done.innerHTML = ""; 
    });

    const bigFilterEl = document.getElementById('board-filter-big');
    const midFilterEl = document.getElementById('board-filter-mid');
    
    const bigVal = bigFilterEl ? bigFilterEl.value : 'all';
    const midVal = midFilterEl ? midFilterEl.value : 'all';

    let validTargetIds = [];

    // í° ëª©í‘œê°€ ì„ íƒë˜ì—ˆì„ ë•Œì˜ í•„í„°ë§ ëª©ë¡ ë§Œë“¤ê¸°
    if (bigVal !== 'all') {
        if (midVal !== 'all') {
            // 2ì°¨ë¡œ íŠ¹ì • ì¤‘ê°„ ëª©í‘œê¹Œì§€ ì„ íƒëœ ê²½ìš°
            validTargetIds.push(midVal);
        } else {
            // í° ëª©í‘œë§Œ ì„ íƒë˜ê³  ì¤‘ê°„ ëª©í‘œëŠ” 'ì „ì²´'ì¸ ê²½ìš° (í•´ë‹¹ í° ëª©í‘œ í•˜ìœ„ì˜ ëª¨ë“  ì¤‘ê°„ ëª©í‘œ ID ìˆ˜ì§‘)
            const midGoals = g_goals.filter(g => g['ìƒìœ„ID'] === bigVal);
            validTargetIds = midGoals.map(m => m.ID);
            validTargetIds.push(bigVal); // í° ëª©í‘œ ìì²´ì— ì§ì ‘ ì—°ê²°ëœ í•  ì¼ì´ ìˆì„ ê²½ìš° ëŒ€ë¹„
        }
    }

    const tasks = g_tasks.filter(t => {
        if (t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' || t['ìœ í˜•'] === 'ë²„ê·¸') return false;
        
        // í•„í„°ê°€ ì ìš©ëœ ê²½ìš° ê²€ì‚¬
        if (bigVal !== 'all') {
            if (!validTargetIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'])) return false;
        }
        return true;
    });
    
    tasks.sort((a, b) => {
        const dateA = a['ê¸°í•œ'] ? new Date(a['ê¸°í•œ']) : new Date('9999-12-31');
        const dateB = b['ê¸°í•œ'] ? new Date(b['ê¸°í•œ']) : new Date('9999-12-31');
        return dateA - dateB;
    });

    tasks.forEach(t => {
        let pKey = 'low';
        const priority = t['ìš°ì„ ìˆœìœ„'] || 'ë³´í†µ';
        if (priority === 'ë†’ìŒ' || priority === 'ê¸´ê¸‰') pKey = 'high';
        else if (priority === 'ë³´í†µ') pKey = 'normal';
        
        const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
        const card = createBoardCard(t);
        
        if (cols[pKey]) {
            if (isDone) {
                cols[pKey].done.appendChild(card);
                cols[pKey].doneCount++;
            } else {
                cols[pKey].active.appendChild(card);
            }
        }
    });

    if(document.getElementById('count-high-done')) document.getElementById('count-high-done').innerText = `(${cols.high.doneCount})`;
    if(document.getElementById('count-normal-done')) document.getElementById('count-normal-done').innerText = `(${cols.normal.doneCount})`;
    if(document.getElementById('count-low-done')) document.getElementById('count-low-done').innerText = `(${cols.low.doneCount})`;

    setupBoardDragAndDrop();
  }

  function createBoardCard(item) {
      const el = document.createElement('div');
      const isDone = item['ìƒíƒœ'] === 'ì™„ë£Œ';
      el.className = `board-card ${isDone ? 'done' : ''}`;

      if (!isDone) {
          el.draggable = true;
          el.addEventListener('dragstart', (e) => {
              e.dataTransfer.setData('text/plain', item.ID);
              setTimeout(() => el.classList.add('dragging'), 0); 
          });
          el.addEventListener('dragend', () => {
              el.classList.remove('dragging');
          });
      }

      let dateHtml = "";
      if (item['ê¸°í•œ']) {
          const d = new Date(item['ê¸°í•œ']);
          const today = new Date(); today.setHours(0,0,0,0);
          const isOverdue = !isDone && d < today;
          const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
          dateHtml = `<span class="board-date-badge ${isOverdue ? 'board-overdue' : ''}">${isOverdue?'ğŸš¨ ':''}ğŸ“… ${dateStr}</span>`;
      }

      const title = item['ì œëª©'] || "(ì œëª© ì—†ìŒ)";
      
      el.innerHTML = `
          <div class="board-header-row">
              <div class="board-check-btn" title="ì™„ë£Œ ì²˜ë¦¬" onclick="event.stopPropagation(); toggleStatus('${item.ID}', '${isDone ? 'ëŒ€ê¸°' : 'ì™„ë£Œ'}')">âœ”</div>
              <div class="board-card-title-wrap">
                  <div class="board-card-title">${title}</div>
              </div>
          </div>
          <div class="board-card-meta">${dateHtml}<span>${item['ìƒíƒœ']}</span></div>
      `;
      
      el.onclick = (e) => {
          if (e.target.closest('.board-check-btn')) return;
          openEditModal('task', item.ID);
      };

      return el;
  }

  function toggleBoardCompleted(priority) {
      const el = document.getElementById(`board-col-${priority}-done`);
      if(el) el.style.display = (el.style.display === 'none') ? 'flex' : 'none';
  }

  function renderBugView() {
    const root = document.getElementById('bug-grid-root'); root.innerHTML = "";
    const showArchive = document.getElementById('toggle-bug-archive') ? document.getElementById('toggle-bug-archive').checked : false;

    const bugs = g_tasks.filter(t => {
      if (t['ìœ í˜•'] !== 'ë²„ê·¸') return false;
      if (showArchive) return t['ìƒíƒœ'] === 'ì™„ë£Œ'; 
      else return t['ìƒíƒœ'] !== 'ì™„ë£Œ'; 
    });
    
    bugs.sort((a,b) => (b['ID'] > a['ID'] ? 1 : -1));

    if(bugs.length === 0) { 
        root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${showArchive ? 'í•´ê²°ëœ ë²„ê·¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë°œê²¬ëœ ë²„ê·¸ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰'}</div>`; 
        return; 
    }

    bugs.forEach(t => {
      const card = document.createElement('div');
      const isWorking = t['ìƒíƒœ'] === 'ì§„í–‰ì¤‘';
      const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      card.className = `bug-card ${isWorking ? 'working' : ''}`;
      
      let parentTitle = "";
      if (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) {
        const parent = g_tasks.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']) || g_goals.find(x => x.ID === t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']);
        if (parent) parentTitle = parent['ì œëª©'];
      }
      
      const plainText = (t['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";
      const deleteBtn = `<button class="bug-btn delete-bug" onclick="deleteItem('${t.ID}')" style="flex:0 0 auto; width:36px; background:#fff1f2; color:#ef4444; margin-left:4px;" title="ì‚­ì œ">ğŸ—‘ï¸</button>`;

      let buttonsHtml = "";
      if (isDone) {
          buttonsHtml = `<button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ë¯¸í•´ê²°/ë³µêµ¬</button>${deleteBtn}`;
      } else if (isWorking) {
          buttonsHtml = `<button class="bug-btn restore" onclick="toggleStatus('${t.ID}', 'ëŒ€ê¸°')">â†©ï¸ ì·¨ì†Œ</button><button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">âœ… í•´ê²° ì™„ë£Œ!</button>${deleteBtn}`;
      } else {
          buttonsHtml = `<button class="bug-btn check" onclick="toggleStatus('${t.ID}', 'ì§„í–‰ì¤‘')">ğŸ” í™•ì¸ ì‹œì‘</button><button class="bug-btn solve" onclick="toggleStatus('${t.ID}', 'ì™„ë£Œ')">ë°”ë¡œ í•´ê²°</button>${deleteBtn}`;
      }

      card.innerHTML = `
        ${isWorking ? `<div class="bug-status-badge">ğŸ”¥ í™•ì¸ì¤‘</div>` : ''} 
        <div class="bug-content" onclick="openEditModal('task', '${t.ID}')" style="cursor:pointer; flex-grow:1;">
          <div class="bug-parent-info">${parentTitle ? `<span>ğŸ”— ${parentTitle}</span>` : '<span>(ì—°ë™ ì‘ì—… ì—†ìŒ)</span>'}</div>
          <div class="bug-title">${t['ì œëª©']}</div>
          <div class="bug-body">${plainText}</div>
        </div>
        <div class="bug-footer">${buttonsHtml}</div>
      `;
      root.appendChild(card);
    });
  }

function renderIdeaView() {
  const root = document.getElementById('idea-list-root');
  root.innerHTML = "";

  const sortMode = document.getElementById('idea-sort-select').value;
  
  let rawIdeas = g_tasks.filter(t => {
    if (t['ìœ í˜•'] === 'ì•„ì´ë””ì–´') return true;
    if (t['ìœ í˜•'] === 'í•  ì¼') {
        const parentId = t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
        if (!parentId || parentId.trim() === "" || parentId.startsWith("G_")) return true;
    }
    return false;
  });

  let filteredIdeas = rawIdeas.filter(item => {
    const realizedId = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']; 
    const isRealized = (item['ìƒíƒœ'] === 'ì™„ë£Œ') || (realizedId && (realizedId.startsWith('T_') || realizedId.startsWith('B_')));
    const color = item['ìƒ‰ìƒ'] || '#64748b';

    if (g_currentIdeaTab === 'realized') return isRealized; 
    if (isRealized) return false; 

    if (g_currentIdeaTab === 'all') return true;
    if (g_currentIdeaTab === 'blog') return color === '#db2777';
    if (g_currentIdeaTab === 'system') return color === '#2563eb';
    if (g_currentIdeaTab === 'biz') return color === '#d97706';
    if (g_currentIdeaTab === 'etc') return (color === '#64748b' || !color);
    
    return true;
  });

  filteredIdeas.sort((a, b) => {
    const dateA = a['ê¸°í•œ'] ? new Date(a['ê¸°í•œ']).getTime() : 0;
    const dateB = b['ê¸°í•œ'] ? new Date(b['ê¸°í•œ']).getTime() : 0;
    if (sortMode === 'oldest') return (dateA - dateB) || (a.ID - b.ID);
    return (dateB - dateA) || (b.ID - a.ID);
  });

  if (filteredIdeas.length === 0) {
    let msg = "ë“±ë¡ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.";
    if (g_currentIdeaTab === 'realized') msg = "ì•„ì§ ì‹¤í˜„ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸš€";
    root.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:#cbd5e1;">${msg}</div>`;
    return;
  }

  filteredIdeas.forEach(item => {
    const card = document.createElement('div');
    
    let catClass = 'cat-etc';
    const c = item['ìƒ‰ìƒ'];
    if (c === '#db2777') catClass = 'cat-blog';
    else if (c === '#2563eb') catClass = 'cat-system';
    else if (c === '#d97706') catClass = 'cat-biz';
    
    const realizedId = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
    const isRealized = (item['ìƒíƒœ'] === 'ì™„ë£Œ') || (realizedId && (realizedId.startsWith('T_') || realizedId.startsWith('B_')));

    card.className = `idea-card-item ${catClass} ${isRealized ? 'is-realized' : ''}`;
    
    const dateStr = item['ê¸°í•œ'] ? item['ê¸°í•œ'].split('T')[0] : '';
    const plainText = (item['ìƒì„¸ë‚´ìš©'] || "ë‚´ìš© ì—†ìŒ").replace(/<[^>]*>?/gm, '').slice(0, 100) + "...";
    
    let badgeLabel = "ğŸ’­ ì¡ë‹´";
    let badgeColor = "#64748b";
    if (catClass === 'cat-blog') { badgeLabel = "ğŸ“ ë¸”ë¡œê·¸"; badgeColor = "#db2777"; }
    else if (catClass === 'cat-system') { badgeLabel = "âš™ï¸ ì‹œìŠ¤í…œ"; badgeColor = "#2563eb"; }
    else if (catClass === 'cat-biz') { badgeLabel = "ğŸ§€ ì‚¬ì—…"; badgeColor = "#d97706"; }
    if (isRealized) { badgeLabel = "ğŸš€ ì‹¤í˜„ë¨"; badgeColor = "#10b981"; }

    let buttons = "";
    if (isRealized) {
      buttons = `<button class="btn" style="font-size:0.8rem; background:#fff; border:1px solid #cbd5e1;" onclick="event.stopPropagation(); cancelRealization('${item.ID}')">â†©ï¸ ì‹¤í˜„ ì·¨ì†Œ</button>`;
    } else {
      buttons = `<button class="btn" style="font-size:0.8rem; background:#eff6ff; color:#3b82f6; border:1px solid #bfdbfe; font-weight:700;" onclick="event.stopPropagation(); realizeIdea('${item.ID}')">âš¡ ì‹¤í˜„í•˜ê¸°</button>`;
    }

    card.innerHTML = `
      <div class="ici-header">
        <span class="ici-badge" style="background:${badgeColor}">${badgeLabel}</span>
        <div class="ici-date">ğŸ“… ${dateStr}</div>
      </div>
      <div class="ici-title">${item['ì œëª©']}</div>
      <div class="ici-body">${plainText}</div>
      <div class="ici-footer">
        ${buttons}
        <div style="display:flex; gap:4px;">
            <button class="row-btn" style="font-size:1rem;" onclick="event.stopPropagation(); openEditModal('idea', '${item.ID}')">âœï¸</button>
            <button class="row-btn" style="font-size:1rem; color:#ef4444;" onclick="event.stopPropagation(); deleteItem('${item.ID}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
    
    card.onclick = () => openEditModal('idea', item.ID);
    root.appendChild(card);
  });
}

  async function cancelRealization(ideaId) {
      if(!confirm("ì‹¤í˜„ ìƒíƒœë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì—°ê²°ëœ ì‘ì—…ê³¼ì˜ ê³ ë¦¬ë¥¼ ëŠìŠµë‹ˆë‹¤.)")) return;
      if(typeof showAdminLoading === 'function') showAdminLoading("ì·¨ì†Œ ì¤‘...");
      try {
          await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "editItem", id: ideaId, connectedId: "" }) });
          loadAllData(); 
      } catch(e) { console.error(e); alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
      finally { if(typeof hideAdminLoading === 'function') hideAdminLoading(); }
  }

async function realizeIdea(ideaId) {
    if(!confirm("âš¡ ì´ ì•„ì´ë””ì–´ë¥¼ 'ì‹¤í˜„ë¨(ì™„ë£Œ)' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    if(typeof showAdminLoading === 'function') showAdminLoading("ì‹¤í˜„ ì²˜ë¦¬ ì¤‘...");

    try {
        const response = await fetch(window.CHEESE_ADMIN_API_BASE, { 
            method: "POST", 
            body: JSON.stringify({ mode: "updateStatus", id: ideaId, status: "ì™„ë£Œ" }) 
        });
        
        const idea = g_tasks.find(t => t.ID === ideaId);
        if(idea) {
             await createAutoLog("realize_idea", idea['ì œëª©'], ideaId);
        }

        await loadAllData();

    } catch (e) {
        console.error(e);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
        if(typeof hideAdminLoading === 'function') hideAdminLoading();
    }
}

  function renderLogs() {
      const root = document.getElementById('log-timeline-root'); root.innerHTML = "";
      if(g_logs.length === 0) { root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem; text-align:center; padding:20px;">ì‘ì—… ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
  
      const filterStart = document.getElementById('log-filter-start')?.value;
      const filterEnd = document.getElementById('log-filter-end')?.value;
  
      let filteredLogs = g_logs;
  
      if (filterStart || filterEnd) {
          const sDate = filterStart ? new Date(filterStart) : new Date('2000-01-01');
          const eDate = filterEnd ? new Date(filterEnd) : new Date('2999-12-31');
          sDate.setHours(0,0,0,0);
          eDate.setHours(23,59,59,999);
          
          filteredLogs = g_logs.filter(log => {
              if (!log['ë‚ ì§œ']) return false;
              const d = new Date(log['ë‚ ì§œ']);
              if (isNaN(d.getTime())) {
                  const raw = new Date(log['ë‚ ì§œ'].substring(0,10));
                  return raw >= sDate && raw <= eDate;
              }
              return d >= sDate && d <= eDate;
          });
      }
  
      if(filteredLogs.length === 0) {
          root.innerHTML = `<div style="color:#cbd5e1; font-size:0.9rem; text-align:center; padding:40px;">í•´ë‹¹ ê¸°ê°„ì— ì‘ì„±ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤. í……~ ğŸƒ</div>`; 
          return;
      }
  
      filteredLogs.sort((a, b) => {
          const da = new Date(a['ë‚ ì§œ']);
          const db = new Date(b['ë‚ ì§œ']);
          return db - da || b.ID - a.ID; 
      });
      
      const groupedLogs = {};
      filteredLogs.forEach(log => {
          let dateKey = 'ë‚ ì§œ ì—†ìŒ';
          if (log['ë‚ ì§œ']) {
              const d = new Date(log['ë‚ ì§œ']);
              if (!isNaN(d.getTime())) {
                  const year = d.getFullYear();
                  const month = String(d.getMonth() + 1).padStart(2, '0');
                  const day = String(d.getDate()).padStart(2, '0');
                  dateKey = `${year}-${month}-${day}`;
              } else {
                   dateKey = log['ë‚ ì§œ'].substring(0, 10);
              }
          }
          if (!groupedLogs[dateKey]) groupedLogs[dateKey] = [];
          groupedLogs[dateKey].push(log);
      });
  
      const sortedDates = Object.keys(groupedLogs).sort().reverse();
      sortedDates.forEach(date => {
          const divider = document.createElement('div'); 
          divider.className = "log-date-divider";
          divider.style.cursor = "pointer"; 
          divider.style.transition = "color 0.2s";
  
          let dayOfWeek = ""; 
          try { dayOfWeek = new Date(date.replace(/-/g,'/')).toLocaleDateString('ko-KR', { weekday: 'short' }); } catch(e){}
          
          const logCount = groupedLogs[date].length;
          divider.innerHTML = `<span class="log-date-badge"><span class="log-toggle-icon" style="display:inline-block; width:16px;">â–¶</span> ğŸ“… ${date} (${dayOfWeek}) <span style="font-size:0.75rem; color:#94a3b8; font-weight:normal; margin-left:6px;">${logCount}ê±´</span></span>`;
          
          root.appendChild(divider);
  
          const groupContainer = document.createElement('div');
          groupContainer.style.display = "none"; 
          groupContainer.style.paddingLeft = "8px"; 
          
          divider.onclick = () => {
              const icon = divider.querySelector('.log-toggle-icon');
              if (groupContainer.style.display === "none") {
                  groupContainer.style.display = "block";
                  if(icon) icon.textContent = "â–¼";
              } else {
                  groupContainer.style.display = "none";
                  if(icon) icon.textContent = "â–¶";
              }
          };
  
          groupedLogs[date].forEach(log => {
              const item = document.createElement('div'); item.className = "log-item";
              const title = log['ì œëª©'] ? `<div class="log-title" style="font-weight:700; font-size:0.95rem; margin-bottom:4px;">${log['ì œëª©']}</div>` : '';
              let relatedHtml = "";
              if(log['ê´€ë ¨_ëª©í‘œID']) {
                  const relTask = g_tasks.find(t => t.ID === log['ê´€ë ¨_ëª©í‘œID']) || g_goals.find(g => g.ID === log['ê´€ë ¨_ëª©í‘œID']);
                  if(relTask) {
                      if (relTask['ìœ í˜•'] === 'ë²„ê·¸') relatedHtml = `<div class="log-related" style="background:#fecaca; color:#b91c1c; border:1px solid #f87171; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ ë²„ê·¸ Fix: ${relTask['ì œëª©']}</div>`; 
                      else relatedHtml = `<div class="log-related" style="background:#ecfdf5; color:#059669; padding:2px 8px; border-radius:4px; font-size:0.75rem; margin-bottom:6px; display:inline-block;">ğŸ“Œ ê´€ë ¨: ${relTask['ì œëª©']}</div>`; 
                  }
              }
              const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');
              item.innerHTML = `
                  <div class="log-dot"></div>
                  <div class="log-card">
                      <div class="log-header" style="margin-bottom: 4px;">
                          <div class="log-time">${log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : ''}</div>
                          <div class="log-actions"><button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button><button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button></div>
                      </div>
                      ${relatedHtml}${title}<div class="log-body" style="font-size:0.9rem; color:#475569; line-height:1.6;">${content}</div>
                      ${log['íƒœê·¸'] ? `<div style="margin-top:8px;"><span class="log-tag" style="font-size:0.75rem; color:#3b82f6; background:#eff6ff; padding:2px 8px; border-radius:4px;">#${log['íƒœê·¸']}</span></div>` : ''}
                  </div>`;
              groupContainer.appendChild(item); 
          });
          
          root.appendChild(groupContainer);
      });
  }
  function adjustColor(color, amount) { return color; } 
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }

  function updateLogTaskOptions(selectedId = "") {
    const select = document.getElementById('log-related-id'); 
    select.innerHTML = '<option value="">(ì—†ìŒ)</option>';
    
    const tasks = g_tasks.filter(t => (t['ìœ í˜•'] === 'í•  ì¼' || t['ìœ í˜•'] === 'ë²„ê·¸') && t['ìƒíƒœ'] !== 'ì™„ë£Œ');
    
    if(tasks.length > 0) { 
        const group = document.createElement('optgroup'); 
        group.label = "ì§„í–‰ ì¤‘ì¸ ì‘ì—… (í•  ì¼/ë²„ê·¸)"; 
        tasks.forEach(t => { 
            const op = document.createElement('option'); 
            op.value = t.ID; 
            const prefix = t['ìœ í˜•'] === 'ë²„ê·¸' ? '[ğŸë²„ê·¸] ' : ''; 
            op.textContent = prefix + t['ì œëª©']; 
            group.appendChild(op); 
        }); 
        select.appendChild(group); 
    }
    
    const mids = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    if(mids.length > 0) { 
        const group2 = document.createElement('optgroup'); 
        group2.label = "ì¤‘ê°„ ëª©í‘œ"; 
        mids.forEach(m => { 
            const op = document.createElement('option'); 
            op.value = m.ID; 
            op.textContent = m['ì œëª©']; 
            group2.appendChild(op); 
        }); 
        select.appendChild(group2); 
    }
    
    if(selectedId) select.value = selectedId;
  }

  function openLogModal() {
    document.getElementById('log-form').reset(); 

    const modal = document.getElementById('log-modal');
    modal.classList.add('open'); 
    
    void modal.offsetWidth; 
    
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
    document.getElementById('log-date').value = localDate;
    
    document.getElementById('log-edit-mode').value = "false";
    document.getElementById('log-idea-section').style.display = 'block'; 
    
    updateLogTaskOptions();
  }

// âœ… 2. í† ê¸€ ë¡œì§ ë³€ê²½ (ì—ë””í„° ê°•ì œ ì¬ë Œë”ë§ ë°©ì‹ ì ìš©)
function toggleEditMode(isEdit) {
  const btnSave   = document.getElementById('btn-save-submit');
  const btnSwitch = document.getElementById('btn-switch-edit');
  const isCreate = !document.getElementById('edit-id')?.value;

  if (isCreate) {
    if (btnSave) { btnSave.innerHTML = "ğŸ’¾ ë“±ë¡í•˜ê¸°"; btnSave.style.display = "inline-block"; }
    if (btnSwitch) btnSwitch.style.display = "none";
  } else {
    if (isEdit) {
      if (btnSave) { btnSave.innerHTML = "ğŸ’¾ ì €ì¥í•˜ê¸°"; btnSave.style.display = "inline-block"; }
      if (btnSwitch) btnSwitch.style.display = "none";
    } else {
      if (btnSave) btnSave.style.display = "none";
      if (btnSwitch) { btnSwitch.innerHTML = "âœï¸ ìˆ˜ì •í•˜ê¸°"; btnSwitch.style.display = "inline-block"; }
    }
  }

  const viewBox = document.getElementById('view-detail-content');
  const editTa = document.getElementById('input-detail');
  const editor = tinymce.get('input-detail');

  let currentHtml = editor ? editor.getContent() : editTa.value;

  if (!isEdit) {
    // ì½ê¸° ëª¨ë“œ (TinyMCE ìì²´ë¥¼ ì•ˆì „í•˜ê²Œ ìˆ¨ê¹€)
    if (editor) editor.hide(); 
    editTa.style.display = 'none'; // ì›ë³¸ textareaë„ ìˆ¨ê¹€
    
    viewBox.innerHTML = currentHtml || "<p style='color:#94a3b8;'>ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    viewBox.style.display = 'block';
  } else {
    // ìˆ˜ì • ëª¨ë“œ (TinyMCE ì¬í™œì„±í™”)
    viewBox.style.display = 'none';
    if (editor) {
        editor.show(); // ğŸ”¥ ë„¤ì´í‹°ë¸Œ show()ë¥¼ ì‚¬ìš©í•´ iframe ë¨¹í†µ ë°©ì§€
        editor.setContent(currentHtml);
    } else {
        editTa.style.display = 'block';
    }
  }
}

// âœ… 3. ìƒˆ í•­ëª© ëª¨ë‹¬ ë¹„ë™ê¸° ì²˜ë¦¬
async function openModal(type) {
  // 1ï¸âƒ£ ëª¨ë‹¬ì„ ë¨¼ì € í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤ (display: flex)
  document.getElementById('input-modal').classList.add('open');
  
  // 2ï¸âƒ£ ëª¨ë‹¬ì´ ì—´ë¦° ìƒíƒœì—ì„œ ì—ë””í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (ê°€ì¥ ì¤‘ìš”)
  await initTinyMCEIfNeeded();

  document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡";
  document.getElementById('edit-mode').value = "false"; 
  document.getElementById('edit-id').value = "";
  document.getElementById('origin-idea-id').value = "";
  document.getElementById('todo-form').reset();

  const today = new Date();
  const localIso = new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
  document.getElementById('input-due').value = localIso;
  document.getElementById('input-start').value = localIso;

  const editor = tinymce.get('input-detail');
  if (editor) editor.setContent('');
  else document.getElementById('input-detail').value = "";

  toggleEditMode(true);
  
  const h = document.getElementById('related-history-section');
  if (h) h.style.display = "none";
  const i = document.getElementById('related-idea-section');
  if (i) i.style.display = "none";

  // ğŸš¨ [ì¶”ê°€ëœ ë¶€ë¶„] ìƒˆ í•­ëª© ë“±ë¡ ì°½ì—ì„œëŠ” ë§ˆê° ë²„íŠ¼ ë¬´ì¡°ê±´ ìˆ¨ê¸°ê¸°
  const closeProjectBtn = document.getElementById('btn-close-project');
  if (closeProjectBtn) closeProjectBtn.style.display = "none";

  if (type) {
    const normalized = (type === 'í• ì¼') ? 'í•  ì¼' : type;
    const radio = document.querySelector(`input[name="type"][value="${normalized}"]`);
    if (radio) radio.click();
  }
  toggleFormFields();
}
  
function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id'); 
    select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    
    if(!type || type==='í•  ì¼' || type==='ì•„ì´ë””ì–´' || type==='ë²„ê·¸') {
      opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    } else if(type==='ì¤‘ê°„ ëª©í‘œ') {
        opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    }
    
    opts.forEach(o => { 
        const op = document.createElement('option'); 
        op.value = o.ID; 
        op.textContent = o['ì œëª©']; 
        select.appendChild(op); 
    });
  }

  // âœ… 4. ê¸€ ìˆ˜ì • ëª¨ë‹¬ ë¹„ë™ê¸° ì²˜ë¦¬
  async function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
  
    // 1ï¸âƒ£ ëª¨ë‹¬ì„ ë¨¼ì € ì—½ë‹ˆë‹¤
    document.getElementById('input-modal').classList.add('open');
    
    // 2ï¸âƒ£ ì—ë””í„° ì´ˆê¸°í™” ëŒ€ê¸°
    await initTinyMCEIfNeeded();
  
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìƒì„¸";
    document.getElementById('edit-id').value = id;
    document.getElementById('origin-idea-id').value = "";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('input-title').value = item['ì œëª©'] || "";
  
    const safeContent = item['ìƒì„¸ë‚´ìš©'] || "";
    const editor = tinymce.get('input-detail');
    if (editor) editor.setContent(safeContent);
    else document.getElementById('input-detail').value = safeContent;
  
    let currentType = item['ìœ í˜•'];
    if (currentType === "í• ì¼") currentType = "í•  ì¼"; 
  
    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => { if (r.value === currentType) r.checked = true; });
    
    if (typeof toggleFormFields === 'function') toggleFormFields();
  
    if ((item['ìœ í˜•'] || "").includes("ëª©í‘œ")) {
      document.getElementById('input-start').value = (item['ì‹œì‘ì¼'] || "").split('T')[0];
      document.getElementById('input-due').value   = (item['ë§ˆê°ì¼'] || "").split('T')[0];
      if (item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
      document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
      document.getElementById('input-due').value          = (item['ê¸°í•œ'] || "").split('T')[0];
      document.getElementById('input-priority').value     = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }
  
  toggleEditMode(false); // 3ï¸âƒ£ ì½ê¸° ëª¨ë“œë¡œ ì„¸íŒ… ì™„ë£Œ
  
    const delBtn = document.getElementById('btn-delete-modal');
    if (delBtn) {
        delBtn.style.display = 'flex'; 
        delBtn.onclick = () => deleteFromModal();
    }
    
    // ğŸš¨ [ì¶”ê°€ëœ ë¶€ë¶„] 'í° ëª©í‘œ'ì¼ ë•Œë§Œ AI ë§ˆê° ë²„íŠ¼ ë³´ì´ê¸°
    const closeProjectBtn = document.getElementById('btn-close-project');
    if (closeProjectBtn) {
        if (currentType === 'í° ëª©í‘œ') {
            closeProjectBtn.style.display = 'inline-block'; // í° ëª©í‘œë©´ ì§ ! ë‚˜íƒ€ë‚¨
            closeProjectBtn.onclick = () => closeProjectWithAI(id); // í˜„ì¬ ê¸€ì˜ IDë¥¼ ë²„íŠ¼ì— ì—°ê²°
        } else {
            closeProjectBtn.style.display = 'none'; // ì•„ë‹ˆë©´ ìˆ¨ê¹€
        }
    }

    renderHistoryInModal(id);
    renderRelatedIdeasInModal(id);
}
  
  function renderHistoryInModal(targetId) {
    const container = document.getElementById('related-history-section');
    const listRoot = document.getElementById('history-list-root');
    const relatedLogs = g_logs.filter(l => String(l['ê´€ë ¨_ëª©í‘œID']) === String(targetId));

    if (relatedLogs.length === 0) { container.style.display = 'none'; return; }

    relatedLogs.sort((a, b) => new Date(b['ë‚ ì§œ'].substring(0,10).replace(/-/g,'/')) - new Date(a['ë‚ ì§œ'].substring(0,10).replace(/-/g,'/')));

    container.style.display = 'block'; listRoot.innerHTML = "";

    relatedLogs.forEach(log => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.onclick = function() { this.classList.toggle('expanded'); };
        
        let dateStr = '';
        if (log['ë‚ ì§œ']) {
            const rawDate = log['ë‚ ì§œ'].substring(0, 10).replace(/-/g, '/');
            const d = new Date(rawDate);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            dateStr = `${year}-${month}-${day}`;
        }
        
        const timeStr = log['ì†Œìš”ì‹œê°„'] ? `â± ${log['ì†Œìš”ì‹œê°„']}` : '';
        const content = (log['ë‚´ìš©'] || "").replace(/\n/g, '<br>');

        item.innerHTML = `
            <div class="history-header">
                <span class="history-date">ğŸ“… ${dateStr}</span>
                <span class="history-time">${timeStr}</span>
            </div>
            <div class="history-content">${content}</div>
        `;
        listRoot.appendChild(item);
    });
  }
  
  function renderRelatedIdeasInModal(targetId) {
    const container = document.getElementById('related-idea-section');
    const root = document.getElementById('related-idea-root');
    const relatedIdeas = g_tasks.filter(t => t['ìœ í˜•'] === 'ì•„ì´ë””ì–´' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === targetId);

    if (relatedIdeas.length > 0) {
      container.style.display = 'block';
      root.innerHTML = relatedIdeas.map(idea => `
        <div class="mini-idea-card" onclick="openEditModal('idea', '${idea.ID}')">
          <div class="mini-idea-title">ğŸ’¡ ${idea['ì œëª©']}</div>
          <div class="mini-idea-desc">${(idea['ìƒì„¸ë‚´ìš©'] || '').replace(/<[^>]*>?/gm, '')}</div>
        </div>
      `).join('');
    } else {
      container.style.display = 'none';
    }
  }

  function createNewLogFromTask() {
    const taskId = document.getElementById('edit-id').value;
    const taskTitle = document.getElementById('input-title').value;
    if (!taskId) return;
    closeModal('input-modal');
    openLogModal(); 
    const relatedSelect = document.getElementById('log-related-id');
    if (relatedSelect) relatedSelect.value = taskId;
    document.getElementById('log-title').value = taskTitle + " ì‘ì—… ê¸°ë¡";
  }

  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id); if (!log) return;
    document.getElementById('log-modal').classList.add('open'); document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •"; document.getElementById('log-edit-mode').value = "true"; document.getElementById('log-edit-id').value = id;
    
    const d = new Date(log['ë‚ ì§œ']);
    let localIso = "";
    if(!isNaN(d.getTime())) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        localIso = `${year}-${month}-${day}`;
    } else {
        localIso = (log['ë‚ ì§œ']||"").split('T')[0];
    }
    document.getElementById('log-date').value = localIso;

    document.getElementById('log-title').value = log['ì œëª©'] || ""; document.getElementById('log-content').value = log['ë‚´ìš©'] || ""; document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || ""; document.getElementById('log-tags').value = log['íƒœê·¸'] || ""; document.getElementById('log-idea-section').style.display = 'none';
    updateLogTaskOptions(log['ê´€ë ¨_ëª©í‘œID']);
  }

  function deleteFromModal() { const id = document.getElementById('edit-id').value; deleteItem(id); closeModal('input-modal'); }

  async function toggleStatus(id, newStatus) {
    await fetch(window.CHEESE_ADMIN_API_BASE, { 
        method: "POST", 
        body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus }) 
    });

    if (newStatus === 'ì™„ë£Œ') {
        const item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
        if (item) {
            await createAutoLog("complete", item['ì œëª©'], id);
        }
    }

    loadAllData(); 
  }  async function deleteItem(id) { if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘..."); await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify({ mode: "deleteItem", id: id }) }); loadAllData(); if(typeof hideAdminLoading==='function') hideAdminLoading(); }

document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const saveBtn = document.querySelector('.btn-save-custom');
    toggleBtnLoading(saveBtn, true);
    
    try {
        const isEdit = document.getElementById('edit-mode').value === "true";
        const type = document.querySelector('input[name="type"]:checked').value;
        
        let color = "#64748b"; 
        if(type === "í° ëª©í‘œ") {
            const el = document.querySelector('input[name="color_goal"]:checked');
            if(el) color = el.value;
        } else if (type === "ì•„ì´ë””ì–´") {
            const el = document.querySelector('input[name="color_idea"]:checked');
            if(el) color = el.value;
        }

        // âœ… TinyMCE ë°ì´í„° ì•ˆì „í•˜ê²Œ ì¶”ì¶œ
        const editor = tinymce.get('input-detail');
        const detailContent = editor ? editor.getContent() : document.getElementById('input-detail').value;
            
        const originIdeaId = document.getElementById('origin-idea-id').value;

        const linkVal = document.getElementById('input-connected-id').value || "";
        
        const payload = { 
          mode: isEdit ? "editItem" : "addItem", 
          id: document.getElementById('edit-id').value, 
          type: type, 
          title: document.getElementById('input-title').value, 
          parentId: linkVal,      
          connectedId: linkVal,   
          detail: detailContent, 
          startDate: document.getElementById('input-start').value, 
          dueDate: document.getElementById('input-due').value, 
          priority: document.getElementById('input-priority').value, 
          color: color 
        };
        
        if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘..."); 
        
        const response = await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();

        if (!isEdit && result.id && originIdeaId) {
          const idea = g_tasks.find(x => x.ID === originIdeaId);
          const oldDetail = idea ? (idea['ìƒì„¸ë‚´ìš©'] || "") : "";
        
          const stamp = `\n\n---\n[System] âœ… ì‹¤í˜„ë¨: ${result.id}`;
        
          await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({
              mode: "editItem",
              id: originIdeaId,
              detail: oldDetail + stamp
            })
          });
        
          const taskTitle = document.getElementById('input-title').value;
          await createAutoLog("realize_idea", taskTitle, result.id);
        }

        if (!isEdit && result.result === "success") {
            const newId = result.id;
            const title = document.getElementById('input-title').value;
            if (type === "ë²„ê·¸") await createAutoLog("create_bug", title, newId);
            else if (type === "ì•„ì´ë””ì–´") await createAutoLog("create_idea", title, newId);
            else if (type.includes("ëª©í‘œ")) await createAutoLog("create_goal", title, newId);
        }
        
        closeModal('input-modal'); 
        loadAllData();

    } catch(err) { 
        console.error(err); 
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); 
    } finally { 
        if(typeof hideAdminLoading==='function') hideAdminLoading(); 
        toggleBtnLoading(saveBtn, false); 
    }
});
  
  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const saveBtn = document.querySelector('#log-form button[type="submit"]');
    
    toggleBtnLoading(saveBtn, true);
    const isEdit = document.getElementById('log-edit-mode').value === "true";
    const relatedId = document.getElementById('log-related-id').value; 
    
    const dateVal = document.getElementById('log-date').value;
    const titleVal = document.getElementById('log-title').value;
    let contentVal = document.getElementById('log-content').value;
    const durationVal = document.getElementById('log-duration').value;
    const tagsVal = document.getElementById('log-tags').value;
    
    const bugInput = document.getElementById('log-bug-input');
    const bugTitle = bugInput ? bugInput.value.trim() : "";
    const bugDetailVal = document.getElementById('log-bug-detail') ? document.getElementById('log-bug-detail').value.trim() : "";

    const ideaInput = document.getElementById('log-idea-input');
    const ideaTitle = ideaInput ? ideaInput.value.trim() : "";

    if(typeof showAdminLoading === 'function') showAdminLoading("ì €ì¥ ì¤‘..."); 

    try {
      const requests = [];

      if (!isEdit && bugTitle !== "") {
         contentVal += `\n\n[System] ğŸ ë²„ê·¸ ë¦¬í¬íŠ¸ ìƒì„±ë¨: ${bugTitle}`;
         const bugFullDetail = `${bugDetailVal}\n\n---\nğŸ“Œ ë°œê²¬ëœ ì‘ì—… ë¡œê·¸: ${titleVal || 'ì œëª© ì—†ëŠ” ë¡œê·¸'} (${dateVal})`;
         requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
           method: "POST", body: JSON.stringify({ mode: "addItem", type: "ë²„ê·¸", title: bugTitle, detail: bugFullDetail, priority: "ë†’ìŒ", connectedId: relatedId }) 
         }));
      }

      if (!isEdit && ideaTitle !== "") {
        let connectionForIdea = "";
        if (relatedId && (relatedId.startsWith('G_') || relatedId.startsWith('M_'))) {
            connectionForIdea = relatedId;
        }
        requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { 
          method: "POST", body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaTitle, detail: "ì‘ì—… ë¡œê·¸ ì‘ì„± ì¤‘ íŒŒìƒë¨: " + titleVal, priority: "ë³´í†µ", connectedId: connectionForIdea }) 
        }));
      }

      const logPayload = { 
        mode: isEdit ? "editItem" : "addLog", id: document.getElementById('log-edit-id').value, 
        date: dateVal, title: titleVal, content: contentVal, duration: durationVal, tags: tagsVal, relatedId: relatedId
      };
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(logPayload) }));

      await Promise.all(requests); 
      closeModal('log-modal'); loadAllData(); 

    } catch (err) { console.error("ì €ì¥ ì‹¤íŒ¨:", err); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); } 
    finally { if(typeof hideAdminLoading === 'function') hideAdminLoading(); toggleBtnLoading(saveBtn, false);}
  });

  async function createAutoLog(actionType, itemTitle, itemId) {
    const today = new Date().toISOString().split('T')[0];
    let logTitle = "";
    let logContent = "";
    let tags = "System";

    if (actionType === "create_bug") {
        logTitle = "ğŸš¨ ë²„ê·¸ ë¦¬í¬íŠ¸ ë“±ë¡";
        logContent = `ìƒˆë¡œìš´ ë²„ê·¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì œëª©: ${itemTitle}`;
        tags = "BugReport";
    } else if (actionType === "create_idea") {
        logTitle = "ğŸ’¡ ìƒˆ ì•„ì´ë””ì–´";
        logContent = `ìƒˆë¡œìš´ ì•„ì´ë””ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì œëª©: ${itemTitle}`;
        tags = "Idea";
    } else if (actionType === "create_goal") {
        logTitle = "ğŸš© ëª©í‘œ ì„¤ì •";
        logContent = `ìƒˆë¡œìš´ ëª©í‘œê°€ ìˆ˜ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤.\nëª©í‘œëª…: ${itemTitle}`;
        tags = "Goal";
    } else if (actionType === "complete") {
        logTitle = "âœ… ë‹¬ì„±/ì™„ë£Œ";
        logContent = `ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì‘ì—…ëª…: ${itemTitle}`;
        tags = "Done";
    } 
    else if (actionType === "realize_idea") {
        logTitle = "ğŸš€ ì•„ì´ë””ì–´ ì‹¤í˜„!";
        logContent = `ì•„ì´ë””ì–´ê°€ êµ¬ì²´ì ì¸ ì‘ì—…ìœ¼ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‘ì—…ëª…: ${itemTitle}`;
        tags = "Realization";
    }

    try {
        await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({
                mode: "addLog",
                date: today,
                title: logTitle,
                content: logContent,
                relatedId: itemId || "",
                tags: tags
            })
        });
    } catch(e) {
        console.error("ìë™ ë¡œê·¸ ìƒì„± ì‹¤íŒ¨:", e);
    }
  }

    (function showVersion() {
      const el = document.getElementById("sysVersion");
      if (!el) return;
      
      const d = new Date(document.lastModified);
      const pad = (n) => String(n).padStart(2, '0');
      
      const versionTag = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}_${pad(d.getHours())}:${pad(d.getMinutes())} [Final-TinyMCE]`;
      
      el.textContent = `Version: ${versionTag}`;
    })();

  function toggleFormFields() {
    const typeEl = document.querySelector('input[name="type"]:checked');
    if (!typeEl) return;
    const type = typeEl.value;

    const fColor = document.getElementById('field-color');
    const fParent = document.getElementById('field-parent');
    const fStart = document.getElementById('field-start-date');
    const fDue = document.getElementById('field-due-date');
    const fPriority = document.getElementById('field-priority');

    const cGoal = document.getElementById('color-picker-goal');
    const cIdea = document.getElementById('color-picker-idea');
    const lColor = document.getElementById('label-color-theme');

    if(fColor) fColor.style.display = 'none';
    if(fParent) fParent.style.display = 'none';
    if(fStart) fStart.style.display = 'none';
    if(fDue) fDue.style.display = 'none';
    if(fPriority) fPriority.style.display = 'none';
    if(cGoal) cGoal.style.display = 'none';
    if(cIdea) cIdea.style.display = 'none';

    if (type === 'í° ëª©í‘œ') {
      if(fColor) fColor.style.display = 'block';
      if(cGoal) cGoal.style.display = 'flex';
      if(lColor) lColor.textContent = 'ëª©í‘œ í…Œë§ˆ ìƒ‰ìƒ';
      if(fStart) fStart.style.display = 'block'; 
      if(fDue) fDue.style.display = 'block';
    } else if (type === 'ì¤‘ê°„ ëª©í‘œ') {
      if(fParent) fParent.style.display = 'block';
      if(fStart) fStart.style.display = 'block'; 
      if(fDue) fDue.style.display = 'block';
    } else if (type === 'ì•„ì´ë””ì–´') {
      if(fColor) fColor.style.display = 'block';
      if(cIdea) cIdea.style.display = 'flex';
      if(lColor) lColor.textContent = 'ì•„ì´ë””ì–´ ë¶„ë¥˜';
      if(fParent) fParent.style.display = 'block';
    } else if (type === 'ë²„ê·¸' || type === 'í•  ì¼') {
      if(fParent) fParent.style.display = 'block';
      if(fDue) fDue.style.display = 'block';
      if(fPriority) fPriority.style.display = 'block';
    }

    if (typeof updateParentOptions === 'function') {
      updateParentOptions(type);
    }
  }

  let isBoardDnDSetup = false;
  
  function setupBoardDragAndDrop() {
      if (isBoardDnDSetup) return; 
      isBoardDnDSetup = true;

      const columns = [
          { id: 'board-col-high', priority: 'ë†’ìŒ' },
          { id: 'board-col-normal', priority: 'ë³´í†µ' },
          { id: 'board-col-low', priority: 'ë‚®ìŒ' }
      ];

      columns.forEach(col => {
          const dropZone = document.getElementById(col.id).parentElement;
          
          dropZone.addEventListener('dragover', (e) => {
              e.preventDefault(); 
              dropZone.classList.add('drag-over');
          });

          dropZone.addEventListener('dragleave', (e) => {
              dropZone.classList.remove('drag-over');
          });

          dropZone.addEventListener('drop', async (e) => {
              e.preventDefault();
              dropZone.classList.remove('drag-over');
              
              const taskId = e.dataTransfer.getData('text/plain');
              if (!taskId) return;

              await updateTaskPriority(taskId, col.priority);
          });
      });
  }

  async function updateTaskPriority(id, newPriority) {
      const task = g_tasks.find(t => t.ID === id);
      if(!task || task['ìš°ì„ ìˆœìœ„'] === newPriority) return; 

      if(typeof showAdminLoading==='function') showAdminLoading("ìš°ì„ ìˆœìœ„ ë³€ê²½ ì¤‘...");
      
      try {
          task['ìš°ì„ ìˆœìœ„'] = newPriority;
          renderBoardView();

          const payload = {
              mode: "editItem",
              id: task.ID,
              type: task['ìœ í˜•'],
              title: task['ì œëª©'],
              detail: task['ìƒì„¸ë‚´ìš©'],
              priority: newPriority,
              dueDate: task['ê¸°í•œ'] ? task['ê¸°í•œ'].split('T')[0] : "",
              connectedId: task['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'],
              color: task['ìƒ‰ìƒ']
          };

          await fetch(window.CHEESE_ADMIN_API_BASE, { 
              method: "POST", 
              body: JSON.stringify(payload) 
          });
      } catch(e) {
          console.error(e);
          alert("ìš°ì„ ìˆœìœ„ ë³€ê²½ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          loadAllData(); 
      } finally {
          if(typeof hideAdminLoading==='function') hideAdminLoading();
      }
  }

// ê²Œì‹œíŒ í•„í„° ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ (ì´ˆê¸° ë¡œë“œìš©)
  function updateBoardFilterOptions() {
      const bigSelect = document.getElementById('board-filter-big');
      if (!bigSelect) return;

      const currentBig = bigSelect.value;
      bigSelect.innerHTML = '<option value="all">ğŸ† ì „ì²´ í° ëª©í‘œ (ëª¨ë“  í•  ì¼)</option>';

      // í° ëª©í‘œë§Œ ì¶”ì¶œí•˜ì—¬ 1ì°¨ ë“œë¡­ë‹¤ìš´ ìƒì„±
      const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
      bigGoals.forEach(bg => {
          const opt = document.createElement('option');
          opt.value = bg.ID;
          opt.textContent = `ğŸ† ${bg['ì œëª©']}`;
          bigSelect.appendChild(opt);
      });

      // ê¸°ì¡´ ì„ íƒê°’ ë³µì›
      if (Array.from(bigSelect.options).some(opt => opt.value === currentBig)) {
          bigSelect.value = currentBig;
      } else {
          bigSelect.value = 'all';
      }

      // ì—°ì‡„ì ìœ¼ë¡œ ì¤‘ê°„ ëª©í‘œ í•„í„°ë„ ì—…ë°ì´íŠ¸ (ì´ˆê¸° ë¡œë”© ì‹œì—ëŠ” ë³´ë“œ ë Œë”ë§ ì¤‘ë³µì„ ë§‰ê¸° ìœ„í•´ true ì „ë‹¬)
      onChangeBigGoalFilter(true);
  }

  // 1ì°¨ ë“œë¡­ë‹¤ìš´(í° ëª©í‘œ) ë³€ê²½ ì‹œ 2ì°¨ ë“œë¡­ë‹¤ìš´(ì¤‘ê°„ ëª©í‘œ) ì˜µì…˜ ë³€ê²½ ì´ë²¤íŠ¸
  function onChangeBigGoalFilter(skipRender = false) {
      const bigSelect = document.getElementById('board-filter-big');
      const midSelect = document.getElementById('board-filter-mid');
      const bigGoalId = bigSelect.value;

      const currentMid = midSelect.value;
      midSelect.innerHTML = '<option value="all">ğŸš© ì „ì²´ ì¤‘ê°„ ëª©í‘œ</option>';

      if (bigGoalId === 'all') {
          // í° ëª©í‘œê°€ 'ì „ì²´'ë©´ 2ì°¨ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
          midSelect.style.display = 'none';
      } else {
          // íŠ¹ì • í° ëª©í‘œê°€ ì„ íƒë˜ë©´ 2ì°¨ ë“œë¡­ë‹¤ìš´ í‘œì‹œ ë° í•˜ìœ„ ì¤‘ê°„ ëª©í‘œë“¤ë¡œ ëª©ë¡ êµ¬ì„±
          midSelect.style.display = 'inline-block';
          const midGoals = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ' && g['ìƒìœ„ID'] === bigGoalId);
          
          midGoals.forEach(mg => {
              const opt = document.createElement('option');
              opt.value = mg.ID;
              opt.textContent = `ğŸš© ${mg['ì œëª©']}`;
              midSelect.appendChild(opt);
          });
      }

      // ê¸°ì¡´ ì„ íƒê°’ ë³µì› (í° ëª©í‘œë¥¼ ë°”ê¿¨ëŠ”ë° ìš°ì—°íˆ IDê°€ ê²¹ì¹˜ì§€ ì•ŠëŠ” í•œ 'all'ë¡œ ë¦¬ì…‹ë¨)
      if (Array.from(midSelect.options).some(opt => opt.value === currentMid)) {
          midSelect.value = currentMid;
      } else {
          midSelect.value = 'all';
      }

      // í™”ë©´ ì—…ë°ì´íŠ¸ ì‹¤í–‰
      if (!skipRender) {
          renderBoardView();
      }
  }

  function calculateDday(dateStr) {
      if (!dateStr) return null;
      const targetDate = new Date(dateStr);
      const today = new Date();
      targetDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
      
      const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0) return { text: `D-${diffDays}`, isDanger: diffDays <= 3 }; 
      if (diffDays === 0) return { text: `D-Day`, isDanger: true };
      return { text: `D+${Math.abs(diffDays)} (ì§€ì—°)`, isDanger: true };
  }

  function calculateProgress(goalId, isBigGoal) {
      let tasks = [];
      if (isBigGoal) {
          const midGoalIds = g_goals.filter(m => m['ìƒìœ„ID'] === goalId).map(m => m.ID);
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && midGoalIds.includes(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']));
      } else {
          tasks = g_tasks.filter(t => t['ìœ í˜•'] !== 'ì•„ì´ë””ì–´' && t['ìœ í˜•'] !== 'ë²„ê·¸' && t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'] === goalId);
      }

      if (tasks.length === 0) return 0; 
      const doneCount = tasks.filter(t => t['ìƒíƒœ'] === 'ì™„ë£Œ').length;
      return Math.round((doneCount / tasks.length) * 100);
  }

  function clearLogFilter() {
      const startEl = document.getElementById('log-filter-start');
      const endEl = document.getElementById('log-filter-end');
      if (startEl) startEl.value = "";
      if (endEl) endEl.value = "";
      renderLogs();
  }
</script>
<script>
// ì„ì‹œ ì €ì¥ìš© ë³€ìˆ˜
window.tempCompletionData = null;
window.tempClosingGoalId = null;

// 1. ë²„íŠ¼ ëˆ„ë¥´ë©´ AI ë³´ê³ ì„œ ìƒì„± ìš”ì²­
async function closeProjectWithAI(goalId) {
    if(!confirm("ì´ í”„ë¡œì íŠ¸ë¥¼ ë§ˆê°í•˜ê³  AI ì„±ê³¼ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    // ë¡œë”©ì°½ ë„ìš°ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ì¬í™œìš© í˜¹ì€ alert)
    if(typeof showAdminLoading==='function') showAdminLoading("AIê°€ í©ì–´ì§„ ë°ì´í„°ë¥¼ ëª¨ì•„ ì„±ê³¼ ë³´ê³ ì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤... ğŸ“");
    else alert("AI ë³´ê³ ì„œ ì‘ì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");

    try {
        const res = await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({ mode: "generateCompletionReport", goalId: goalId })
        });
        const json = await res.json();
        
        if(json.result === "success") {
            window.tempCompletionData = json.data;
            window.tempClosingGoalId = json.goalId;
            renderCompletionReport(json.data);
        } else alert("ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: " + json.msg);
    } catch(e) { alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
}

// 2. ì™„ì„±ëœ ë³´ê³ ì„œë¥¼ í™”ë©´ì— ì˜ˆì˜ê²Œ ê·¸ë¦¬ê¸° (ê°€ìƒì˜ ëª¨ë‹¬ ìƒì„±)
function renderCompletionReport(data) {
    const formatToSubBullets = (text) => {
        if (!text) return "";
        let resultHtml = "";
        const lines = text.split('\n');
        lines.forEach(line => {
            const match = line.match(/^-\s*\[(.*?)\](.*)/);
            if (match) {
                resultHtml += `<div style="margin-top:8px;"><b>${match[1]}:</b></div>`;
                resultHtml += `<li style="margin-bottom:4px; margin-left: 20px;">${match[2].trim()}</li>`;
            } else if (line.trim().startsWith('-')) {
                resultHtml += `<li style="margin-bottom:4px; margin-left: 20px;">${line.substring(1).trim()}</li>`;
            } else if(line.trim()) {
                resultHtml += `<div style="margin-top:4px;">${line}</div>`;
            }
        });
        return resultHtml;
    };

    let scheduleHtml = "ì”ì—¬ í•­ëª©ì´ ì—†ì–´ ì™„ë²½í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰";
    let btnText = "âœ¨ í™•ì • ë° í”„ë¡œì íŠ¸ ë§ˆê° (100% ì™„ë£Œ)";
    
    if (data.followup_schedule && data.followup_schedule.length > 0) {
        btnText = "ğŸš€ ë§ˆê° í™•ì • ë° [ì”ì—¬ í•­ëª©] í›„ì† í”„ë¡œì íŠ¸ ìë™ ìƒì„±";
        scheduleHtml = `<table style="width:100%; border-collapse:collapse; text-align:left; border: 1px solid #cbd5e1; margin-top:10px;">
            <tr style="background:#f1f5f9;"><th style="padding:8px; border: 1px solid #cbd5e1;">ê³µì •</th><th style="padding:8px; border: 1px solid #cbd5e1;">ì‘ì—…ëª…</th><th style="padding:8px; border: 1px solid #cbd5e1;">ì¼ì •</th></tr>`;
        data.followup_schedule.forEach(t => {
            scheduleHtml += `<tr><td style="padding:8px; border: 1px solid #cbd5e1; font-size:0.9rem;">${t.category}</td><td style="padding:8px; border: 1px solid #cbd5e1; font-weight:bold;">${t.task_name}</td><td style="padding:8px; border: 1px solid #cbd5e1; font-size:0.85rem;">${t.start_date} ~ ${t.end_date}</td></tr>`;
        });
        scheduleHtml += "</table>";
    }

  const htmlTemplate = `
    <div id="ai-completion-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:99999; display:flex; justify-content:center; align-items:center;">
        <div style="background:#fff; width:90%; max-width:900px; max-height:90vh; overflow-y:auto; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding: 30px;">
            
            <h2 style="color:#1d4ed8; text-align:center; margin-bottom: 8px;">ğŸ“Š ${data.title}</h2>
            
            <div style="text-align:center; color:#64748b; font-size:1rem; font-weight:bold; border-bottom:2px solid #bfdbfe; padding-bottom:15px; margin-bottom:20px;">
                ğŸ—“ï¸ í”„ë¡œì íŠ¸ ì§„í–‰ ê¸°ê°„: ${data.period || "ê¸°ê°„ ì •ë³´ ì—†ìŒ"}
            </div>

            <table style="width:100%; border-collapse:collapse; margin-top:10px; border:2px solid #cbd5e1;">
                <tr>
                    <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#f8fafc;">
                        <h3 style="color:#2563eb; margin:0 0 10px 0;">1. ì´í‰ ë° ë‹¬ì„±ë¥ </h3>
                        <div>${formatToSubBullets(data.executive_summary)}</div>
                    </td>
                    <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;">
                        <h3 style="color:#16a34a; margin:0 0 10px 0;">2. ì£¼ìš” ì„±ê³¼ (Achievements)</h3>
                        <div>${formatToSubBullets(data.achievements)}</div>
                    </td>
                </tr>
                <tr>
                    <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fff;">
                        <h3 style="color:#dc2626; margin:0 0 10px 0;">3. ë¯¸ì™„ë£Œ í•­ëª© ì›ì¸ ë¶„ì„</h3>
                        <div>${formatToSubBullets(data.unfinished_analysis)}</div>
                    </td>
                    <td style="width:50%; vertical-align:top; border:1px solid #cbd5e1; padding:20px; background:#fefce8;">
                        <h3 style="color:#d97706; margin:0 0 10px 0;">4. í›„ì† ì¡°ì¹˜ ê³„íš</h3>
                        <div>${formatToSubBullets(data.followup_strategy)}</div>
                    </td>
                </tr>
            </table>
            <div style="margin-top:20px; padding:20px; background:#f1f5f9; border-radius:8px;">
                <h3 style="color:#475569; margin:0 0 10px 0;">ğŸ’¡ AI ì œì•ˆ: ë¯¸ì™„ë£Œ í•­ëª© ìŠ¤í•€ì˜¤í”„ (í›„ì† ì¼ì •)</h3>
                ${scheduleHtml}
            </div>
            
            <div id="ai-modal-btn-area" style="text-align:center; margin-top:30px; display:flex; gap:10px; justify-content:center;">
                <button onclick="document.getElementById('ai-completion-modal').remove()" style="padding:12px 24px; border:none; border-radius:8px; background:#94a3b8; color:#fff; cursor:pointer; font-weight:bold;">ì·¨ì†Œ</button>
                <button onclick="downloadReportAsImage()" style="padding:12px 24px; border:1px solid #cbd5e1; border-radius:8px; background:#fff; color:#475569; cursor:pointer; font-weight:bold;">ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                <button onclick="saveCompletionReport()" style="padding:12px 24px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:bold;">${btnText}</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', htmlTemplate);
}

// ğŸš¨ [ì‹ ê·œ] ë³´ê³ ì„œë¥¼ ì˜ˆìœ PNG ì´ë¯¸ì§€ë¡œ ì°°ì¹µ! ë‹¤ìš´ë¡œë“œ í•˜ëŠ” í•¨ìˆ˜
function downloadReportAsImage() {
    const modalContent = document.querySelector('#ai-completion-modal > div'); // í•˜ì–€ìƒ‰ íŒì—… ë³¸ë¬¸
    const btnArea = document.getElementById('ai-modal-btn-area'); // ë²„íŠ¼ ì˜ì—­
    
    // 1. ìº¡ì²˜í•˜ê¸° ì „ì— í•˜ë‹¨ ë²„íŠ¼ë“¤ì€ ìº¡ì²˜ ì•ˆ ë˜ê²Œ ì ê¹ ìˆ¨ê¹ë‹ˆë‹¤.
    const originalDisplay = btnArea.style.display;
    btnArea.style.display = 'none';
    
    // 2. ì°°ì¹µ! ìº¡ì²˜ ì‹¤í–‰ (í™”ì§ˆì„ 2ë°°ë¡œ ì„ ëª…í•˜ê²Œ)
    html2canvas(modalContent, { scale: 2 }).then(canvas => {
        // ì´ë¯¸ì§€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        const link = document.createElement('a');
        const safeTitle = window.tempCompletionData.title.replace(/\[ì™„ë£Œë³´ê³ ì„œ\]\s*/, '').replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
        link.download = `[ì„±ê³¼ë³´ê³ ì„œ]_${safeTitle}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        
        // 3. ìº¡ì²˜ ëë‚¬ìœ¼ë‹ˆ ë²„íŠ¼ë“¤ì„ ë‹¤ì‹œ ë³´ì—¬ì¤ë‹ˆë‹¤.
        btnArea.style.display = originalDisplay;
    });
}

// 3. í™•ì • ë° ì €ì¥ (ê¸°ì¡´ê³¼ ë™ì¼)
async function saveCompletionReport() {
    // ... ê¸°ì¡´ ë‚´ìš© ê·¸ëŒ€ë¡œ ìœ ì§€ ...
    if(typeof showAdminLoading==='function') showAdminLoading("í”„ë¡œì íŠ¸ ë§ˆê° ë° í›„ì† ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ğŸ’¾");
    try {
        const res = await fetch(window.CHEESE_ADMIN_API_BASE, {
            method: "POST",
            body: JSON.stringify({ mode: "saveCompletionReport", goalId: window.tempClosingGoalId, rData: window.tempCompletionData })
        });
        const json = await res.json();
        if(json.result === "success") {
            alert("âœ¨ ì„±ê³µì ìœ¼ë¡œ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤!\nì”ì—¬ í•­ëª©ì´ ìˆë‹¤ë©´ ëª©í‘œ íŠ¸ë¦¬ì— 'ìƒˆ í”„ë¡œì íŠ¸'ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('ai-completion-modal').remove();
            if(typeof loadAllData === 'function') await loadAllData(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
        } else alert("ì €ì¥ ì‹¤íŒ¨: " + json.msg);
    } catch(e) { alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
}

  // ğŸš¨ [ì‹ ê·œ] ì™„ë£Œëœ í•­ëª© ìˆ¨ê¸°ê¸°/ë³´ê¸° ì „ì—­ ë³€ìˆ˜ (ê¸°ë³¸ê°’: ìˆ¨ê¸°ê¸°)
window.hideCompleted = true; 

function toggleCompletedGoals() {
    window.hideCompleted = !window.hideCompleted;
    const btn = document.getElementById('btn-toggle-completed');
    if(window.hideCompleted) {
        btn.innerHTML = "âœ… ì™„ë£Œëœ í•­ëª© ìˆ¨ê¸°ê¸° (ON)";
        btn.style.backgroundColor = "#f1f5f9";
    } else {
        btn.innerHTML = "â˜‘ï¸ ì™„ë£Œëœ í•­ëª© ëª¨ë‘ ë³´ê¸°";
        btn.style.backgroundColor = "#e2e8f0";
    }
    // ë°ì´í„° ë‹¤ì‹œ ê·¸ë¦¬ê¸° ì‹¤í–‰
    if(typeof loadAllData === 'function') loadAllData(); 
}


</script>
</body>
</html>
