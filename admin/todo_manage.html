<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Cheese Lab í†µí•© í•  ì¼ ê´€ë¦¬</title>
  <link rel="stylesheet" href="./admin.css">

  <script>
    // âœ… (ì¤‘ìš”) ì•± ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ í›„ ì£¼ì†Œê°€ ë°”ë€Œì—ˆë‹¤ë©´ ê¼­ ê°±ì‹ í•´ì£¼ì„¸ìš”!
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* ... ê¸°ì¡´ CSS ìœ ì§€ ... */
    .dashboard-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; align-items: start; }
    @media (max-width: 900px) { .dashboard-layout { grid-template-columns: 1fr; } }
    
    .view-tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .view-tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; border: none; background: transparent; color: #6b7280; cursor: pointer; transition: all 0.2s; }
    .view-tab-btn:hover { background: #f3f4f6; color: #374151; }
    .view-tab-btn.active { background: #eff6ff; color: #2563eb; }

    /* ì¹´ë“œ ë·° */
    .goal-card { background: #fff; border-radius: 16px; margin-bottom: 24px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
    .goal-card-header { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .goal-card-title { font-size: 1.15rem; font-weight: 800; }
    
    /* ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê·¸ë£¹ (í—¤ë”ìš©) */
    .header-actions { display: flex; gap: 8px; }
    .action-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
    .action-btn:hover { background: rgba(255,255,255,0.4); }

    .mid-goal-group { margin-top: 10px; }
    .mid-goal-item { border-left: 4px solid #10b981; background: #f9fafb; border-radius: 0 8px 8px 0; overflow: hidden; }
    .mid-goal-header { padding: 10px 16px; font-weight: 700; color: #374151; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .mid-goal-header:hover { background: #f3f4f6; }

    /* ì¼ë°˜ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ë¦¬ìŠ¤íŠ¸ìš© - íšŒìƒ‰í†¤) */
    .row-actions { display: flex; gap: 4px; opacity: 0.4; transition: opacity 0.2s; }
    .row-actions:hover { opacity: 1; }
    .row-btn { background: transparent; border: none; cursor: pointer; font-size: 1rem; padding: 4px; color: #6b7280; }
    .row-btn:hover { color: #111827; background: #e5e7eb; border-radius: 4px; }
    .row-btn.delete:hover { color: #ef4444; background: #fee2e2; }

    /* Task Rows */
    .task-list { background: #fff; border-top: 1px solid #f3f4f6; }
    .task-row { display: flex; align-items: center; gap: 12px; padding: 8px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; }
    .task-row:hover { background: #fdfdfd; }

    /* Check Circle */
    .check-circle { width: 22px; height: 22px; border: 2px solid #d1d5db; border-radius: 50%; cursor: pointer; position: relative; flex-shrink: 0; }
    .check-circle.checked { background: #10b981; border-color: #10b981; }
    .check-circle.checked::after { content: 'âœ”'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; }

    /* ë¡œê·¸ ì»¨í…Œì´ë„ˆ */
    .log-container { background: #fff; border-radius: 16px; padding: 24px; border: 1px solid #e5e7eb; position: sticky; top: 80px; max-height: calc(100vh - 100px); overflow-y: auto; }
    .timeline { position: relative; padding-left: 24px; margin-top: 24px; border-left: 2px solid #e5e7eb; }
    .timeline-item { position: relative; margin-bottom: 30px; }
    .timeline-dot { position: absolute; left: -31px; top: 5px; width: 12px; height: 12px; background: #3b82f6; border: 3px solid #fff; border-radius: 50%; }
    .timeline-content { background: #f9fafb; padding: 12px 14px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6; color: #374151; white-space: pre-wrap; position: relative; }
    .timeline-actions { position: absolute; top: 8px; right: 8px; display: none; }
    .timeline-content:hover .timeline-actions { display: flex; gap: 4px; }

    /* ëª¨ë‹¬ ë“± ìœ í‹¸ */
    .fab-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 12px; align-items: flex-end; z-index: 1000; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
    .fab-main { background: #2563eb; }
    .fab-sub { width: 48px; height: 48px; background: #4b5563; font-size: 20px; display: none; }
    .fab-menu:hover .fab-sub { display: flex; }

    .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .custom-modal.open { display: flex; }
    .modal-box { background: #fff; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }

    /* ëª©í‘œ ìƒì„¸ ì„¤ëª… ìŠ¤íƒ€ì¼ */
    .goal-card-desc {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 4px;
      font-weight: 400;
      line-height: 1.4;
    }
    .mid-goal-desc {
      font-size: 0.8rem;
      color: #6b7280;
      margin-left: 8px;
      font-weight: normal;
    }
  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: #111827; margin: 0;">Dashboard</h2>
        <p style="color: #6b7280; margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ê³¼ í•˜ë£¨ ê¸°ë¡ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>

      <div class="dashboard-layout">
        
        <div>
          <div class="view-tabs">
            <button class="view-tab-btn active" onclick="switchView('card')" id="btn-view-card">ğŸ—‚ ê³„ì¸µí˜• ë·°</button>
            <button class="view-tab-btn" onclick="switchView('board')" id="btn-view-board">ğŸ“‹ ë¦¬ìŠ¤íŠ¸ ë·°</button>
          </div>

          <div id="view-card-container">
            <div id="goal-tree-root">
              <div class="card" style="padding:40px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <div id="view-board-container" style="display:none;">
            <div style="background:#fff; border-radius:16px; border:1px solid #e5e7eb; overflow:hidden;">
              <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                <thead style="background:#f9fafb; color:#6b7280;">
                  <tr>
                    <th style="padding:12px;">ìƒíƒœ</th>
                    <th>ë¶„ë¥˜ / ê²½ë¡œ</th>
                    <th>ì œëª©</th>
                    <th>ê¸°í•œ</th>
                    <th>ê´€ë¦¬</th>
                  </tr>
                </thead>
                <tbody id="board-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="log-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">ğŸ“ ì‘ì—… ë¡œê·¸</h3>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openLogModal()">+ ê¸°ë¡</button>
          </div>
          <div class="timeline" id="log-timeline-root"></div>
        </div>

      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;"><button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button></div>
  <div style="position:relative;"><button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button></div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="todo-modal-title">ìƒˆ í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      <input type="hidden" id="edit-id"> <input type="hidden" id="edit-mode" value="false">

      <div class="field admin-field-full" id="field-type-group">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f9fafb; padding:10px; border-radius:8px;">
          <label><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-parent">
        <label>ì—°ê²°ëœ ëª©í‘œ</label>
        <select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select>
      </div>

      <div class="field admin-field-full">
        <label>ì œëª©</label>
        <input type="text" id="input-title" required>
      </div>
      <div class="field admin-field-full" id="field-detail" style="display:none;">
        <label>ìƒì„¸ ë‚´ìš©</label>
        <textarea id="input-detail"></textarea>
      </div>
      <div class="field" id="field-date">
         <label>ë§ˆê° ê¸°í•œ</label>
         <input type="date" id="input-due">
      </div>
      <div class="field" id="field-priority" style="display:none;">
         <label>ìš°ì„ ìˆœìœ„</label>
         <select id="input-priority">
           <option value="ë†’ìŒ">ë†’ìŒ</option>
           <option value="ë³´í†µ" selected>ë³´í†µ</option>
           <option value="ë‚®ìŒ">ë‚®ìŒ</option>
         </select>
      </div>

      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center;">ì €ì¥í•˜ê¸°</button>
        <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content:center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title" id="log-modal-title">ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      <input type="hidden" id="log-edit-id">
      <input type="hidden" id="log-edit-mode" value="false">

      <div class="field admin-field-full"><label>ë‚ ì§œ</label><input type="date" id="log-date" required></div>
      <div class="field admin-field-full"><label>ì œëª© (ì„ íƒ)</label><input type="text" id="log-title" placeholder="ë¹„ì›Œë‘ë©´ ë‚ ì§œë¡œ í‘œì‹œ"></div>
      <div class="field admin-field-full"><label>ë‚´ìš©</label><textarea id="log-content" required style="min-height:100px;"></textarea></div>
      
      <div class="field admin-field-full" id="log-idea-section" style="background:#f5f3ff; padding:16px; border-radius:12px; border:1px dashed #8b5cf6;">
        <label style="color:#6d28d9; font-weight:700;">ğŸ’¡ ì•„ì´ë””ì–´ ìë™ ë“±ë¡</label>
        <input type="text" id="log-idea-input" placeholder="ì…ë ¥ ì‹œ ì•„ì´ë””ì–´ ëª©ë¡ì— ì¶”ê°€ë¨" style="background:#fff;">
      </div>

      <div class="field"><label>ì‹œê°„</label><input type="text" id="log-duration"></div>
      <div class="field"><label>íƒœê·¸</label><input type="text" id="log-tags"></div>
      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content:center;">ì €ì¥</button>
        <button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content:center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  let g_goals=[], g_tasks=[], g_logs=[];

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    if(typeof showAdminLoading==='function') showAdminLoading("ë¡œë”© ì¤‘...");
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      if(json.result === "success") {
        g_goals = json.goals; g_tasks = json.tasks; g_logs = json.logs||[];
        renderGoalTree(); renderBoardView(); renderLogs(); updateParentOptions();
      }
    } catch(e) { console.error(e); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  function switchView(mode) {
    document.getElementById('btn-view-card').classList.toggle('active', mode==='card');
    document.getElementById('btn-view-board').classList.toggle('active', mode==='board');
    document.getElementById('view-card-container').style.display = (mode==='card')?'block':'none';
    document.getElementById('view-board-container').style.display = (mode==='board')?'block':'none';
  }

  // --- ë Œë”ë§: ì¹´ë“œ ë·° ---
  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root');
    root.innerHTML = "";
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    
    if(bigGoals.length===0) { root.innerHTML = `<div style="padding:30px;text-align:center;color:#999;">ëª©í‘œ ì—†ìŒ</div>`; return; }
  
    bigGoals.forEach(bg => {
      const card = document.createElement('div');
      card.className = "goal-card";
      
      // âœ… ë³€ê²½ì : ì œëª© ì•„ë˜ì— ìƒì„¸ë‚´ìš©(desc) ì¶”ê°€
      const descHtml = bg['ìƒì„¸ë‚´ìš©'] ? `<div class="goal-card-desc">${bg['ìƒì„¸ë‚´ìš©']}</div>` : '';
  
      const header = document.createElement('div');
      header.className = "goal-card-header";
      header.innerHTML = `
        <div>
          <div class="goal-card-title">${bg['ì œëª©']}</div>
          ${descHtml}
        </div>
        <div class="header-actions">
           <button class="action-btn" onclick="openEditModal('goal', '${bg.ID}')">âœï¸</button>
           <button class="action-btn" onclick="deleteItem('${bg.ID}')">ğŸ—‘ï¸</button>
        </div>
      `;
      card.appendChild(header);
  
      const body = document.createElement('div');
      body.style.padding = "10px 20px 20px";
  
      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      midGoals.forEach(mg => {
        const midGroup = document.createElement('div');
        midGroup.className = "mid-goal-group";
        const midItem = document.createElement('div');
        midItem.className = "mid-goal-item";
        
        // âœ… ë³€ê²½ì : ì¤‘ê°„ ëª©í‘œë„ ì˜†ì— ìƒì„¸ë‚´ìš© í‘œì‹œ (ê´„í˜¸ ë“±ìœ¼ë¡œ)
        const midDesc = mg['ìƒì„¸ë‚´ìš©'] ? `<span class="mid-goal-desc">(${mg['ìƒì„¸ë‚´ìš©']})</span>` : '';
  
        midItem.innerHTML = `
          <div class="mid-goal-header" onclick="toggleDisplay(this)">
            <span>ğŸš© ${mg['ì œëª©']} ${midDesc}</span>
            <div onclick="event.stopPropagation()" class="row-actions">
              <button class="row-btn" onclick="openEditModal('goal', '${mg.ID}')">âœï¸</button>
              <button class="row-btn delete" onclick="deleteItem('${mg.ID}')">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
        // ... (ì´í•˜ Task ë Œë”ë§ ì½”ë“œëŠ” ë™ì¼) ...
        const taskList = document.createElement('div');
        taskList.className = "task-list";
        const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
        
        if(tasks.length > 0) {
          tasks.forEach(t => taskList.appendChild(createTaskRow(t)));
        } else {
          taskList.innerHTML = `<div style="padding:10px;color:#aaa;font-size:0.8rem;">í•  ì¼ ì—†ìŒ</div>`;
        }
        midItem.appendChild(taskList);
        midGroup.appendChild(midItem);
        body.appendChild(midGroup);
      });
      card.appendChild(body);
      root.appendChild(card);
    });
  }

  function createTaskRow(t) {
    const div = document.createElement('div');
    div.className = "task-row";
    const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
    div.innerHTML = `
      <div class="check-circle ${isDone?'checked':''}" onclick="toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div>
      <div style="flex:1; text-decoration:${isDone?'line-through':''}; color:${isDone?'#aaa':'#333'}">
        ${t['ì œëª©']}
      </div>
      <div class="row-actions">
        <button class="row-btn" onclick="openEditModal('task', '${t.ID}')">âœï¸</button>
        <button class="row-btn delete" onclick="deleteItem('${t.ID}')">ğŸ—‘ï¸</button>
      </div>
    `;
    return div;
  }

  // --- ë Œë”ë§: ë¡œê·¸ ---
  function renderLogs() {
    const root = document.getElementById('log-timeline-root');
    root.innerHTML = "";
    g_logs.slice(0, 20).forEach(log => {
      const item = document.createElement('div');
      item.className = "timeline-item";
      const dateStr = log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : '';
      const title = log['ì œëª©'] || dateStr + " ê¸°ë¡";
      
      item.innerHTML = `
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <div class="timeline-actions">
            <button class="row-btn" onclick="openEditLog('${log.ID}')">âœï¸</button>
            <button class="row-btn delete" onclick="deleteItem('${log.ID}')">ğŸ—‘ï¸</button>
          </div>
          <div style="font-weight:700; margin-bottom:4px;">${title}</div>
          <div style="white-space:pre-wrap;">${log['ë‚´ìš©']}</div>
          ${log['íƒœê·¸']?`<div style="font-size:0.8rem;color:#d946ef;margin-top:6px;">${log['íƒœê·¸']}</div>`:''}
        </div>
      `;
      root.appendChild(item);
    });
  }

  // --- ë Œë”ë§: ë³´ë“œ ë·° ---
  function renderBoardView() {
    const tbody = document.getElementById('board-table-body');
    tbody.innerHTML = "";
    g_tasks.forEach(t => {
      const tr = document.createElement('tr');
      const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
      // ì¤‘ê°„ëª©í‘œ ì´ë¦„ ì°¾ê¸°
      const midId = (t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").split(',')[0];
      const mid = g_goals.find(g=>g.ID===midId);
      const midTitle = mid ? mid['ì œëª©'] : (t['ìœ í˜•']==='ì•„ì´ë””ì–´'?'ğŸ’¡ ì•„ì´ë””ì–´':'ë¯¸ë¶„ë¥˜');

      tr.innerHTML = `
        <td style="text-align:center;"><div class="check-circle ${isDone?'checked':''}" onclick="toggleStatus('${t.ID}','${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"></div></td>
        <td style="color:#888;font-size:0.8rem;">${midTitle}</td>
        <td style="${isDone?'text-decoration:line-through;color:#aaa':''}">${t['ì œëª©']}</td>
        <td>${t['ê¸°í•œ'] ? t['ê¸°í•œ'].slice(5) : '-'}</td>
        <td>
           <div class="row-actions" style="opacity:1;">
             <button class="row-btn" onclick="openEditModal('task', '${t.ID}')">âœï¸</button>
             <button class="row-btn delete" onclick="deleteItem('${t.ID}')">ğŸ—‘ï¸</button>
           </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- ì•¡ì…˜ ë¡œì§ ---
  
  // 1. í•­ëª© ì‚­ì œ
  async function deleteItem(id) {
    if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;
    if(typeof showAdminLoading==='function') showAdminLoading("ì‚­ì œ ì¤‘...");
    try {
      await fetch(window.CHEESE_ADMIN_API_BASE, {
        method: "POST",
        body: JSON.stringify({ mode: "deleteItem", id: id })
      });
      loadAllData();
    } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
    finally { if(typeof hideAdminLoading==='function') hideAdminLoading(); }
  }

  // 2. í•­ëª© ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  function openEditModal(typeHint, id) {
    let item = g_goals.find(x => x.ID === id) || g_tasks.find(x => x.ID === id);
    if (!item) return;
  
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "í•­ëª© ìˆ˜ì •";
    document.getElementById('edit-mode').value = "true";
    document.getElementById('edit-id').value = id;
  
    document.getElementById('input-title').value = item['ì œëª©'];
    
    // âœ… ë³€ê²½ì : ëª©í‘œë“  í• ì¼ì´ë“  'ìƒì„¸ë‚´ìš©' í•„ë“œì— ê°’ ì±„ìš°ê¸°
    document.getElementById('input-detail').value = item['ìƒì„¸ë‚´ìš©'] || ""; 
  
    const typeRadios = document.querySelectorAll('input[name="type"]');
    typeRadios.forEach(r => {
      if(r.value === item['ìœ í˜•']) r.checked = true;
      else r.disabled = true;
    });
  
    toggleFormFields(); 
  
    if(item['ìœ í˜•'] === 'í° ëª©í‘œ') {
      // ìƒìœ„ ID ì—†ìŒ
    } else if(item['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ') {
      updateParentOptions('ì¤‘ê°„ ëª©í‘œ');
      document.getElementById('input-connected-id').value = item['ìƒìœ„ID'];
    } else {
      updateParentOptions('í• ì¼');
      document.getElementById('input-connected-id').value = item['ì—°ê²°_ì¤‘ê°„ëª©í‘œID'];
      document.getElementById('input-due').value = (item['ê¸°í•œ']||"").split('T')[0];
      document.getElementById('input-priority').value = item['ìš°ì„ ìˆœìœ„'] || "ë³´í†µ";
    }
  }

  // 3. ë¡œê·¸ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
  function openEditLog(id) {
    const log = g_logs.find(x => x.ID === id);
    if (!log) return;

    document.getElementById('log-modal').classList.add('open');
    document.getElementById('log-modal-title').textContent = "ê¸°ë¡ ìˆ˜ì •";
    document.getElementById('log-edit-mode').value = "true";
    document.getElementById('log-edit-id').value = id;

    document.getElementById('log-date').value = (log['ë‚ ì§œ']||"").split('T')[0];
    document.getElementById('log-title').value = log['ì œëª©'] || "";
    document.getElementById('log-content').value = log['ë‚´ìš©'] || "";
    document.getElementById('log-duration').value = log['ì†Œìš”ì‹œê°„'] || "";
    document.getElementById('log-tags').value = log['íƒœê·¸'] || "";
    
    // ìˆ˜ì • ë•ŒëŠ” ì•„ì´ë””ì–´ ì¶”ê°€ ì„¹ì…˜ ìˆ¨ê¸°ê¸° (ë³µì¡ë„ ë°©ì§€)
    document.getElementById('log-idea-section').style.display = 'none';
  }

  // 4. ìƒíƒœ í† ê¸€
  async function toggleStatus(id, newStatus) {
    await fetch(window.CHEESE_ADMIN_API_BASE, {
      method: "POST", body: JSON.stringify({ mode: "updateStatus", id: id, status: newStatus })
    });
    loadAllData();
  }

  // --- ëª¨ë‹¬ & í¼ ìœ í‹¸ ---
  function openModal(type) {
    document.getElementById('input-modal').classList.add('open');
    document.getElementById('todo-modal-title').textContent = "ìƒˆ í•­ëª© ë“±ë¡";
    document.getElementById('edit-mode').value = "false";
    document.getElementById('edit-id').value = "";
    document.getElementById('todo-form').reset();
    
    // ë¼ë””ì˜¤ ë²„íŠ¼ í™œì„±í™” ë¦¬ì…‹
    document.querySelectorAll('input[name="type"]').forEach(r => r.disabled = false);
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }

  function openLogModal() {
    document.getElementById('log-modal').classList.add('open');
    document.getElementById('log-modal-title').textContent = "ì‘ì—… ê¸°ë¡";
    document.getElementById('log-edit-mode').value = "false";
    document.getElementById('log-edit-id').value = "";
    document.getElementById('log-form').reset();
    document.getElementById('log-date').valueAsDate = new Date();
    document.getElementById('log-idea-section').style.display = 'block';
  }

  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  function toggleDisplay(el) { const next = el.nextElementSibling; if(next) next.style.display = next.style.display==="none"?"block":"none"; }
  
  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ");
    
    // âœ… ë³€ê²½ì : ëª©í‘œ(Goal)ì—¬ë„ ìƒì„¸ë‚´ìš©(detail)ì€ í•­ìƒ ë³´ì´ê²Œ ì„¤ì •!
    document.getElementById('field-detail').style.display = "block"; 
    
    // ë‚ ì§œ, ìš°ì„ ìˆœìœ„ëŠ” ëª©í‘œì¼ ë•Œ ìˆ¨ê¹€ (ê¸°ì¡´ ìœ ì§€)
    document.getElementById('field-date').style.display = isGoal ? "none" : "block";
    document.getElementById('field-priority').style.display = isGoal ? "none" : "block";
    
    updateParentOptions(type);
  }

  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id');
    const oldVal = select.value;
    select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    let opts = [];
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
    else if(type==='ì¤‘ê°„ ëª©í‘œ') opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    
    opts.forEach(o => {
      const op = document.createElement('option');
      op.value = o.ID; op.textContent = o['ì œëª©'];
      select.appendChild(op);
    });
    // ê°’ ë³µì› ì‹œë„
    select.value = oldVal;
  }

  // --- ì €ì¥ (Submit) ---
  
  // í• ì¼/ëª©í‘œ í¼
  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('edit-mode').value === "true";
    const editId = document.getElementById('edit-id').value;
    const type = document.querySelector('input[name="type"]:checked').value;
    
    const payload = {
        mode: isEdit ? "editItem" : "addItem",
        id: editId, // ìˆ˜ì •ì¼ ë•Œë§Œ ì‚¬ìš©ë¨
        type: type,
        title: document.getElementById('input-title').value,
        parentId: document.getElementById('input-connected-id').value,
        connectedId: document.getElementById('input-connected-id').value,
        detail: document.getElementById('input-detail').value,
        dueDate: document.getElementById('input-due').value,
        priority: document.getElementById('input-priority').value
    };

    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
    await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
    closeModal('input-modal'); loadAllData();
    if(typeof hideAdminLoading==='function') hideAdminLoading();
  });

  // ë¡œê·¸ í¼
  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const isEdit = document.getElementById('log-edit-mode').value === "true";
    
    const payload = {
      mode: isEdit ? "editItem" : "addLog", // ìˆ˜ì • ì‹œì—” ê³µí†µ editItem í˜¸ì¶œ (IDê°€ L_ë¡œ ì‹œì‘í•˜ë¯€ë¡œ ìë™ì²˜ë¦¬ë¨)
      id: document.getElementById('log-edit-id').value,
      date: document.getElementById('log-date').value,
      title: document.getElementById('log-title').value,
      content: document.getElementById('log-content').value,
      duration: document.getElementById('log-duration').value,
      tags: document.getElementById('log-tags').value
    };

    if(typeof showAdminLoading==='function') showAdminLoading("ì €ì¥ ì¤‘...");
    
    // 1. ë¡œê·¸ ì €ì¥
    const requests = [fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) })];

    // 2. ì•„ì´ë””ì–´ ë™ì‹œ ë“±ë¡ (ì‹ ê·œ ì‘ì„±ì¼ ë•Œë§Œ)
    const ideaVal = document.getElementById('log-idea-input').value;
    if (!isEdit && ideaVal.trim() !== "") {
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, {
        method: "POST",
        body: JSON.stringify({ mode: "addItem", type: "ì•„ì´ë””ì–´", title: ideaVal, detail: "ë¡œê·¸ íŒŒìƒ", priority: "ë³´í†µ" })
      }));
    }

    await Promise.all(requests);
    closeModal('log-modal'); loadAllData();
    if(typeof hideAdminLoading==='function') hideAdminLoading();
  });

</script>
</body>
</html>
