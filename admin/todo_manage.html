/**
 * Cheese Lab 통합 할 일 관리 시스템 (Backend - v2.0)
 * - 추가: 수정(editItem), 삭제(deleteItem) 기능 완벽 지원
 */

function doGet(e) {
  const mode = e.parameter.mode;
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  if (mode === "getAllData") {
    const goals = getSheetData_(ss, "goals_master");
    const tasks = getSheetData_(ss, "task_master");
    const logs = getSheetData_(ss, "work_log");
    logs.sort((a, b) => new Date(b['날짜']) - new Date(a['날짜'])); // 최신순

    return responseJSON_({ result: "success", goals, tasks, logs });
  }
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const mode = params.mode;
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // ----------------------------------------------------
    // 1. 항목 등록 (기존 유지)
    // ----------------------------------------------------
    if (mode === "addItem") {
      let sheetName = "task_master";
      let prefix = "T_"; 
      if (["큰 목표", "중간 목표"].includes(params.type)) {
        sheetName = "goals_master";
        prefix = params.type === "큰 목표" ? "G_" : "M_";
      } else if (params.type === "아이디어") {
        prefix = "I_";
      }

      const sheet = ss.getSheetByName(sheetName);
      const newId = prefix + Date.now().toString(36) + Math.floor(Math.random()*100);
      const nowStr = new Date().toISOString().slice(0, 10);

      let rowData = [];
      if (sheetName === "goals_master") {
        rowData = [newId, params.type, params.parentId||"", params.title, "진행중", 0, nowStr, ""];
      } else {
        rowData = [newId, params.type, params.connectedId||"", params.title, params.detail||"", params.priority||"보통", "대기", params.dueDate||"", ""];
      }
      sheet.appendRow(rowData);
      return responseJSON_({ result: "success", msg: "등록 완료" });
    }

    if (mode === "addLog") {
      const sheet = ss.getSheetByName("work_log");
      const newId = "L_" + Date.now().toString(36);
      const nowStr = new Date().toISOString().slice(0, 10);
      sheet.appendRow([newId, params.date||nowStr, params.title||"", "관리자", params.content, params.relatedId||"", params.duration||"", params.tags||""]);
      return responseJSON_({ result: "success", msg: "로그 저장 완료" });
    }

    // ----------------------------------------------------
    // 2. 상태 업데이트 (기존 유지)
    // ----------------------------------------------------
    if (mode === "updateStatus") {
      updateRow_(ss, "task_master", params.id, { "상태": params.status });
      return responseJSON_({ result: "success" });
    }

    // ----------------------------------------------------
    // 3. [NEW] 항목 삭제 (ID로 시트 자동 찾기)
    // ----------------------------------------------------
    if (mode === "deleteItem") {
      const id = params.id;
      const sheetName = getSheetNameById_(id);
      if (!sheetName) throw new Error("알 수 없는 ID 형식입니다.");
      
      deleteRowById_(ss, sheetName, id);
      return responseJSON_({ result: "success", msg: "삭제되었습니다." });
    }

    // ----------------------------------------------------
    // 4. [NEW] 항목 수정 (ID로 시트 자동 찾기)
    // ----------------------------------------------------
    if (mode === "editItem") {
      const id = params.id;
      const sheetName = getSheetNameById_(id);
      
      // 업데이트할 필드 맵핑
      let updates = {};
      
      if (sheetName === "goals_master") {
        // 목표 수정
        updates = { "제목": params.title };
        // 목표는 필드가 적어서 제목 정도만 수정하거나 필요시 추가
      } else if (sheetName === "task_master") {
        // 할일/아이디어 수정
        updates = {
          "제목": params.title,
          "상세내용": params.detail,
          "우선순위": params.priority,
          "기한": params.dueDate,
          "연결_중간목표ID": params.connectedId // 부모 변경 가능
        };
      } else if (sheetName === "work_log") {
        // 로그 수정
        updates = {
          "날짜": params.date,
          "제목": params.title,
          "내용": params.content,
          "소요시간": params.duration,
          "태그": params.tags
        };
      }

      updateRow_(ss, sheetName, id, updates);
      return responseJSON_({ result: "success", msg: "수정되었습니다." });
    }

  } catch (err) {
    return responseJSON_({ result: "error", msg: err.toString() });
  }
}

// --- Helpers ---

// ID 접두사로 시트 이름 찾기
function getSheetNameById_(id) {
  if (id.startsWith("G_") || id.startsWith("M_")) return "goals_master";
  if (id.startsWith("T_") || id.startsWith("I_")) return "task_master";
  if (id.startsWith("L_")) return "work_log";
  return null;
}

// 특정 ID의 행 삭제
function deleteRowById_(ss, sheetName, id) {
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  const idIdx = data[0].indexOf("ID");
  
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idIdx]) === String(id)) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
  throw new Error("삭제할 ID를 찾지 못했습니다.");
}

// 특정 ID의 행 수정 (updates 객체: { "컬럼명": "새값" })
function updateRow_(ss, sheetName, id, updates) {
  const sheet = ss.getSheetByName(sheetName);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const idIdx = headers.indexOf("ID");

  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idIdx]) === String(id)) {
      rowIndex = i + 1;
      break;
    }
  }
  if (rowIndex === -1) throw new Error("수정할 ID를 찾지 못했습니다.");

  // 각 업데이트 필드 적용
  for (const key in updates) {
    const colIdx = headers.indexOf(key);
    if (colIdx !== -1 && updates[key] !== undefined) {
      sheet.getRange(rowIndex, colIdx + 1).setValue(updates[key]);
    }
  }
}

function getSheetData_(ss, sheetName) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  const headers = data.shift();
  return data.map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      if (row[i] instanceof Date) {
        try { obj[h] = row[i].toISOString(); } catch(e) { obj[h] = String(row[i]); }
      } else {
        obj[h] = row[i];
      }
    });
    return obj;
  });
}

function responseJSON_(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
