<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ë¹„ê²Œì´í„°(í…œí”Œë¦¿) ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .nav-container { display: flex; gap: 20px; height: calc(100vh - 80px); }
        .nav-list-section { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .nav-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .nav-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #f0f7ff; }
        .nav-item h4 { margin: 0 0 5px 0; font-size: 14px; color: #333; }
        .nav-item p { margin: 0; font-size: 12px; color: #888; }
        
        .nav-editor-section { flex: 1; display: flex; flex-direction: column; background: #fff; padding: 20px; overflow-y: auto; }
        .editor-header { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .editor-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .code-area { width: 100%; height: 300px; font-family: monospace; padding: 10px; background: #2d2d2d; color: #f8f8f2; border-radius: 4px; resize: vertical; margin-bottom: 20px; }
        
        .preview-area { border: 2px dashed #ddd; padding: 20px; min-height: 200px; background: #fafafa; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

        /* ë³µì‚¬ íƒœê·¸ í‘œì‹œìš© */
        .tag-display { background: #e9ecef; padding: 10px; border-radius: 4px; font-family: monospace; color: #d63384; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="admin-wrapper">
        <div id="menu-slot"></div>

        <div class="admin-content">
            <div id="header-slot"></div>

            <div class="nav-container">
                <div class="nav-list-section">
                    <div style="padding:15px; border-bottom:1px solid #ddd;">
                        <button class="btn-primary" style="width:100%" onclick="createNew()">+ ìƒˆ ë„¤ë¹„ê²Œì´í„° ë§Œë“¤ê¸°</button>
                    </div>
                    <ul class="nav-list" id="navigatorList">
                        <li style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</li>
                    </ul>
                </div>

                <div class="nav-editor-section" id="editorPanel" style="display:none;">
                    <div class="editor-header">
                        <input type="text" id="editKey" class="editor-input" placeholder="KEY (ì˜ˆ: NAV_MAIN)" style="width: 200px; font-weight:bold;">
                        <input type="text" id="editTitle" class="editor-input" placeholder="ì œëª© (ê´€ë¦¬ìš©)" style="flex:1;">
                        <button class="btn-secondary" onclick="loadDefaultTemplate()">ğŸ”„ ê¸°ë³¸ í…œí”Œë¦¿ ë„£ê¸°</button>
                        <button class="btn-danger" onclick="deleteCurrent()">ì‚­ì œ</button>
                        <button class="btn-primary" onclick="saveCurrent()">ğŸ’¾ ì €ì¥</button>
                    </div>

                    <div class="tag-display" onclick="copyTag()" title="í´ë¦­í•´ì„œ ë³µì‚¬">
                        &lt;div class="cheese-template" data-key="<span id="displayKey">KEY</span>"&gt;&lt;/div&gt;
                    </div>
                    <p style="font-size:12px; color:#666; margin-bottom:15px;">ğŸ‘† ìœ„ íƒœê·¸ë¥¼ í´ë¦­í•´ ë³µì‚¬í•œ ë’¤, ë¸”ë¡œê·¸ ê¸€(HTML ëª¨ë“œ)ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>

                    <label>HTML / CSS / JS ì½”ë“œ ìˆ˜ì •:</label>
                    <textarea id="htmlContent" class="code-area" oninput="updatePreview()"></textarea>

                    <label>ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œ ì‘ë™ í™•ì¸):</label>
                    <div id="previewBox" class="preview-area"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // â–¼â–¼â–¼ Apps Script ë°°í¬ URL (ìˆ˜ì • í•„ìˆ˜!) â–¼â–¼â–¼
        const API_URL = "https://script.google.com/macros/s/AKfycbxEfHER2lBOZnixi1iX5pwn22lwIOKy6IWcq8XiDmoRsGT34wf1N6eYUL3YYLi8Tho4/exec"; 

        // 1. ê³µí†µ ë ˆì´ì•„ì›ƒ ë¡œë“œ
        $(document).ready(function() {
            $("#menu-slot").load("admin-menu.html");
            $("#header-slot").load("admin-header.html");
            loadList();
        });

        let currentData = null;

        // 2. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Read)
        function loadList() {
            $.getJSON(API_URL + "?mode=getAllData", function(res) {
                // library ë°ì´í„°ê°€ ì—†ìœ¼ë©´ getAllData ëŒ€ì‹  getComponents ë¦¬ìŠ¤íŠ¸ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
                // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ getAllDataê°€ libraryë¥¼ ì•ˆ ì¤€ë‹¤ë©´, 
                // Code.gsì˜ doGetì— library ì „ì²´ë¥¼ ì£¼ëŠ” ë¡œì§ì´ ì¶”ê°€ë˜ì–´ì•¼ í•¨.
                // í¸ì˜ìƒ ?mode=getComponents&keys=ALL ê°™ì€ ê±¸ ì“´ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜
                // ê°€ì¥ ì¢‹ì€ ê±´: doGetì— mode='getLibraryList'ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒ.
                
                // (ì„ì‹œ) ì¼ë‹¨ getComponentsë¡œ ëª¨ë“  í‚¤ë¥¼ ë‹¤ ê°€ì ¸ì˜¬ ìˆœ ì—†ìœ¼ë‹ˆ,
                // Code.gsì˜ loadLibraryFromSheet_ í•¨ìˆ˜ë¥¼ í™œìš©í•´ ëª©ë¡ì„ ì£¼ëŠ” APIê°€ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì‘ì„±í•©ë‹ˆë‹¤.
                // ë§Œì•½ ì—†ë‹¤ë©´ Code.gsì˜ doGetì— `if(mode === 'getLibraryList') return responseJSON_(loadLibraryFromSheet_());` ì¶”ê°€ í•„ìš”.
                
                // ì—¬ê¸°ì„œëŠ” 'ê°€ê³„ë„' ì˜ˆì‹œë¥¼ ê°•ì œë¡œ ë³´ì—¬ì£¼ëŠ” í•˜ë“œì½”ë”© (í…ŒìŠ¤íŠ¸ìš©)
                // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œë¡œ ë°”ê¿”ì•¼ í•¨.
                
                // â˜… ì‹¤ì œ êµ¬í˜„ ì‹œ: Code.gsì— ëª©ë¡ ë°˜í™˜ ê¸°ëŠ¥ ì¶”ê°€ í›„ ì•„ë˜ ì£¼ì„ í•´ì œ
                /*
                fetch(API_URL + "?mode=getLibraryList")
                    .then(r => r.json())
                    .then(data => renderList(data));
                */
               
               // ì¼ë‹¨ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ê°€ì§œ ë°ì´í„° ë Œë”ë§
               renderList([
                   { key: "NAV_GENEALOGY", title: "ì™•ì¡° ê°€ê³„ë„" },
                   { key: "NAV_SIDEBAR", title: "ì‚¬ì´ë“œë°” ë©”ë‰´" } // ì˜ˆì‹œ
               ]);
            });
        }
        
        // ì‹¤ì œë¡œëŠ” Code.gsì—ì„œ 'getLibraryList'ë¥¼ í˜¸ì¶œí•´ì•¼ ì™„ë²½í•©ë‹ˆë‹¤.
        // í˜„ì¬ Code.gsì—ëŠ” ëª©ë¡ ë°˜í™˜ì´ ì—†ìœ¼ë¯€ë¡œ, ì¼ë‹¨ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬í•˜ê±°ë‚˜ 
        // 1ë²ˆ ë‹¨ê³„ì˜ Code.gs ì—…ë°ì´íŠ¸ ë•Œ getLibraryListë„ ì¶”ê°€í•˜ëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.

        function renderList(list) {
            const html = list.map(item => `
                <li class="nav-item" onclick="selectItem('${item.key}')">
                    <h4>${item.key}</h4>
                    <p>${item.title || 'ì œëª© ì—†ìŒ'}</p>
                </li>
            `).join('');
            $("#navigatorList").html(html);
        }

        // 3. ì•„ì´í…œ ì„ íƒ & ë°ì´í„° ë¡œë”©
        function selectItem(key) {
            $(".nav-item").removeClass("active");
            // $(this).addClass("active"); // í´ë¦­í•œ ìš”ì†Œ ì°¾ê¸° ë³µì¡í•˜ë‹ˆ ìƒëµ

            // ì„œë²„ì—ì„œ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            fetch(`${API_URL}?mode=getComponents&keys=${key}`)
                .then(r => r.json())
                .then(json => {
                    const content = json.items[key];
                    // ì œëª©ì€ ë³„ë„ë¡œ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ, ì¼ë‹¨ ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ì •ë³´ë¥¼ ì“´ë‹¤ê³  ê°€ì •
                    // ë˜ëŠ” content ì•ˆì— ì£¼ì„ìœ¼ë¡œ ì œëª©ì„ ë„£ëŠ” ê·œì¹™ì„ ì •í•´ë„ ë¨.
                    
                    document.getElementById("editKey").value = key;
                    document.getElementById("editTitle").value = key; // ì„ì‹œ
                    document.getElementById("htmlContent").value = content;
                    document.getElementById("displayKey").innerText = key;
                    
                    $("#editorPanel").show();
                    updatePreview();
                });
        }

        function createNew() {
            document.getElementById("editKey").value = "";
            document.getElementById("editTitle").value = "";
            document.getElementById("htmlContent").value = "";
            document.getElementById("displayKey").innerText = "KEY";
            $("#editorPanel").show();
            document.getElementById("htmlContent").focus();
        }

        // 4. í”„ë¦¬ë·° ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í¬í•¨)
        function updatePreview() {
            const html = document.getElementById("htmlContent").value;
            const previewBox = document.getElementById("previewBox");
            const key = document.getElementById("editKey").value || "PREVIEW";
            document.getElementById("displayKey").innerText = key;

            previewBox.innerHTML = html;

            // ìŠ¤í¬ë¦½íŠ¸ ê°•ì œ ì‹¤í–‰ ë¡œì§
            const scripts = previewBox.querySelectorAll("script");
            scripts.forEach(oldScript => {
                const newScript = document.createElement("script");
                Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        // 5. ê¸°ë³¸ í…œí”Œë¦¿(ê°€ê³„ë„) ë„£ê¸°
        function loadDefaultTemplate() {
            const template = `<div class="namu-wiki-container">
  <div class="namu-main-header">
    <span class="namu-icon">ğŸ§­</span>
    <span class="namu-title">ìƒˆ ë„¤ë¹„ê²Œì´í„°</span>
  </div>
  <details class="namu-details">
    <summary class="namu-summary">[ <span class="toggle-text">í¼ì¹˜ê¸°</span> ]</summary>
    <div class="namu-body">
      <div class="namu-genealogy-grid"></div>
    </div>
  </details>
</div>
<style>
/* ... (ì•„ê¹Œ ë“œë¦° CSS ì „ì²´) ... */
.namu-wiki-container { border: 2px solid #00a495; margin: 20px 0; }
.namu-main-header { background: #00a495; color: #fff; padding: 10px; text-align: center; font-weight: bold; }
.namu-summary { background: #008f82; color: white; padding: 5px; cursor: pointer; text-align: center; }
.namu-cell { padding: 10px; border: 1px solid #eee; text-align: center; }
</style>
<script>
/* ... (ì•„ê¹Œ ë“œë¦° JS) ... */
console.log("ë„¤ë¹„ê²Œì´í„° ë¡œë“œë¨");
<\/script>
`;
            document.getElementById("htmlContent").value = template;
            updatePreview();
        }

        // 6. ì €ì¥ (Save)
        function saveCurrent() {
            const key = document.getElementById("editKey").value;
            const title = document.getElementById("editTitle").value;
            const content = document.getElementById("htmlContent").value;

            if(!key) return alert("KEYë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const payload = {
                mode: "saveLibrary",
                key: key,
                title: title,
                content: content
            };

            if(confirm(`[${key}] ë„¤ë¹„ê²Œì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload) // POSTë¡œ ë°ì´í„° ì „ì†¡
                })
                .then(r => r.json())
                .then(res => {
                    if(res.result === "success") {
                        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (ìºì‹œë¡œ ì¸í•´ 30ì´ˆ ë’¤ ë¸”ë¡œê·¸ì— ë°˜ì˜ë©ë‹ˆë‹¤)");
                        loadList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    } else {
                        alert("ì˜¤ë¥˜: " + res.msg);
                    }
                });
            }
        }

        // 7. ì‚­ì œ
        function deleteCurrent() {
            const key = document.getElementById("editKey").value;
            if(!key) return;

            if(confirm(`ì •ë§ [${key}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ mode: "deleteLibrary", key: key })
                })
                .then(r => r.json())
                .then(res => {
                    if(res.result === "success") {
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        location.reload();
                    }
                });
            }
        }

        function copyTag() {
            const key = document.getElementById("displayKey").innerText;
            const tag = `<div class="cheese-template" data-key="${key}"></div>`;
            navigator.clipboard.writeText(tag).then(() => {
                alert("íƒœê·¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në¸”ë¡œê·¸ HTML ëª¨ë“œì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:\n\n" + tag);
            });
        }
    </script>
</body>
</html>
