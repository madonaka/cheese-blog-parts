<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë„¤ë¹„ê²Œì´í„° ì œì‘ ë„êµ¬</title>

  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap { padding: 0; }
    
    .tabs { display:flex; gap:10px; margin-bottom:15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .tab-btn { border: none; background: transparent; padding: 10px 15px; cursor: pointer; font-weight: bold; color: #888; border-radius: 8px; transition: 0.2s; }
    .tab-btn.active { background: #eef2ff; color: #4f46e5; }

    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px; margin-bottom:15px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); }
    .card-title { font-weight: 800; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: #1e293b; justify-content: space-between; }

    .builder-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
    @media (max-width: 800px) { .builder-layout { grid-template-columns: 1fr; } .left-panel { order: 2; } }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 13px; font-weight: 600; color: #64748b; }
    .input { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
    .input:focus { border-color: #6366f1; ring: 2px solid #e0e7ff; }
    .input[type="color"] { padding: 2px; height: 42px; width: 100%; cursor: pointer; }
    .select { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; background: #fff; }

    .data-list { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
    /* [ìˆ˜ì •] ë²„íŠ¼ ê³µê°„ í™•ë³´ (ì‚­ì œ/ì¶”ê°€) */
    .data-row { display: grid; grid-template-columns: 80px 1fr 1fr 60px; gap: 1px; background: #e2e8f0; }
    .data-cell { background: #fff; padding: 8px; display: flex; align-items: center; justify-content: center; gap: 2px; }
    .data-cell input { width: 100%; border: none; outline: none; font-size: 13px; }
    .data-header { background: #f8fafc; font-weight: bold; font-size: 12px; color: #475569; text-align: center; }
    
    .btn-icon { border: none; background: #fee2e2; color: #ef4444; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 4px; }
    .btn-icon:hover { background: #fecaca; }
    .btn-add-mid { background: #dbeafe; color: #2563eb; }
    .btn-add-mid:hover { background: #bfdbfe; }

    .btn { background: #0f172a; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
    .btn.secondary { background: #fff; color: #0f172a; border: 1px solid #cbd5e1; }
    .btn.primary { background: #4f46e5; color: white; }
    .btn.danger { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
    .btn.full { width: 100%; margin-top: 10px; }

    .preview-box { border: 2px dashed #cbd5e1; padding: 20px; border-radius: 12px; background: #f8fafc; min-height: 200px; }
    .saved-list { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    .saved-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
    .saved-item:hover { background: #f1f5f9; }
    .saved-item:last-child { border-bottom: none; }
    .saved-item .info { display: flex; flex-direction: column; }
    .saved-item .key { font-weight: bold; font-size: 14px; color: #334155; }
    .saved-item .title { font-size: 12px; color: #64748b; }

    .code-export-box { background: #1e1e1e; color: #a9b7c6; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; height: 150px; overflow-y: auto; margin-top: 10px; border: 1px solid #333; }

    /* í•˜ë‹¨ ì˜µì…˜ ì „ìš© ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .footer-list .data-row { grid-template-columns: 1fr 1fr 30px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      
      <main class="admin-content">
        <div class="lm-wrap">
          
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('easy')">ğŸ¨ ì´ì§€ ë¹Œë”</button>
            <button class="tab-btn" onclick="switchTab('raw')">ğŸ”§ ê³ ê¸‰ í¸ì§‘</button>
          </div>

          <div class="card">
            <div class="card-title">
              ğŸ“‚ ì €ì¥ëœ ë„¤ë¹„ê²Œì´í„° ëª©ë¡
              <button class="btn secondary" style="padding: 5px 10px; font-size: 12px;" onclick="loadLibraryList()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="saved-list" id="savedItemsList">
              <div style="padding:20px; text-align:center; color:#999;">ë¡œë”© ì¤‘...</div>
            </div>
          </div>

          <div id="tab-easy" style="display:block;">
            <div class="builder-layout">
              
              <div class="left-panel">
                <div class="card">
                  <div class="card-title">
                    âš™ï¸ ì„¤ì •
                    <button class="btn danger" style="padding: 4px 8px; font-size: 11px;" onclick="resetForm()">ì´ˆê¸°í™”</button>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ê³ ìœ  ID (KEY)</label>
                    <input type="text" id="easyKey" class="input" placeholder="ì˜ˆ: NAV_HISTORY" value="NAV_NEW">
                  </div>
                  <div class="form-group" style="margin-top:10px;">
                    <label class="form-label">ì œëª© (ê´€ë¦¬ìš©)</label>
                    <input type="text" id="easyTitle" class="input" placeholder="ì˜ˆ: ì¡°ì„  ì™•ì¡° ê°€ê³„ë„">
                  </div>
                </div>

                <div class="card">
                  <div class="card-title">ğŸ¨ ë””ìì¸</div>
                  <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                      <label class="form-label">ë©”ì¸ ìƒ‰ìƒ</label>
                      <input type="color" id="easyColorMain" class="input" value="#B70000" oninput="renderPreview(); generateSkeletonCode();">
                    </div>
                    <div class="form-group">
                      <label class="form-label">ì„œë¸Œ ìƒ‰ìƒ</label>
                      <input type="color" id="easyColorSub" class="input" value="#A00000" oninput="renderPreview(); generateSkeletonCode();">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ìƒë‹¨ ì œëª©</label>
                    <input type="text" id="easyHeadTitle" class="input" value="ì—­ëŒ€ ì™•ì¡° ê°€ê³„ë„ ì‹œë¦¬ì¦ˆ" oninput="renderPreview(); generateSkeletonCode();">
                  </div>
                  <div class="form-group" style="margin-top:10px;">
                    <label class="form-label">ì•„ì´ì½˜</label>
                    <input type="text" id="easyIcon" class="input" value="ğŸ‘‘" oninput="renderPreview(); generateSkeletonCode();" style="width: 50px; text-align: center;">
                  </div>
                  
                  <div style="border-top:1px solid #eee; margin-top:15px; padding-top:15px;">
                    <div class="form-label" style="margin-bottom:8px;">ğŸ‘‡ í•˜ë‹¨ ì¶”ê°€ ì˜ì—­ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</div>
                    
                    <div class="data-list footer-list">
                       <div class="data-row data-header">
                         <div class="data-cell">ë¬¸êµ¬</div>
                         <div class="data-cell">ë§í¬ (ì„ íƒ)</div>
                         <div class="data-cell">Ã—</div>
                       </div>
                       <div id="footerRows"></div>
                    </div>
                    <button class="btn secondary full" style="margin-bottom: 10px;" onclick="addFooterRow()">+ í•˜ë‹¨ ë§í¬ ì¶”ê°€</button>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; margin-top:10px;">
                      <div class="form-group">
                        <label class="form-label">í•˜ë‹¨ ë°°ê²½ìƒ‰</label>
                        <input type="color" id="easyColorFooter" class="input" value="#E0F7FA" oninput="renderPreview(); generateSkeletonCode();">
                      </div>
                      <div class="form-group">
                        <label class="form-label">í•˜ë‹¨ ê¸€ììƒ‰</label>
                        <select id="easyFooterTextColor" class="select" onchange="renderPreview(); generateSkeletonCode();">
                          <option value="#333333">ê²€ì • (ê¸°ë³¸)</option>
                          <option value="#ffffff">í°ìƒ‰</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card">
                  <div class="card-title">ğŸ“ ë°ì´í„° ì…ë ¥</div>
                  <div class="data-list">
                    <div class="data-row data-header">
                      <div class="data-cell">ê·¸ë£¹</div>
                      <div class="data-cell">ì´ë¦„</div>
                      <div class="data-cell">ë§í¬</div>
                      <div class="data-cell">í¸ì§‘</div>
                    </div>
                    <div id="dataRows"></div>
                  </div>
                  <button class="btn secondary full" onclick="addDataRow()">+ ë§¨ ì•„ë˜ ì¶”ê°€í•˜ê¸°</button>
                </div>

                <button class="btn primary full" style="padding: 15px;" onclick="saveEasyMode()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                <button class="btn danger full" style="margin-top:5px;" onclick="deleteCurrent()">ğŸ—‘ ì‚­ì œ</button>
              </div>

              <div class="right-panel">
                <div class="card">
                   <div class="card-title">ğŸ“¤ ë¸”ë¡œê·¸ ë¶™ì—¬ë„£ê¸°ìš© ì½”ë“œ</div>
                   <textarea id="skeletonExport" class="code-export-box" readonly onclick="this.select()"></textarea>
                   <button class="btn secondary full" onclick="copySkeletonCode()">ğŸ“‹ ì½”ë“œ ë³µì‚¬í•˜ê¸°</button>
                </div>

                <div class="card" style="height: 100%; display:flex; flex-direction:column;">
                  <div class="card-title">ğŸ‘€ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</div>
                  <div id="easyPreview" class="preview-box"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="tab-raw" style="display:none;">
            <div class="card">
              <div class="card-title">HTML ì§ì ‘ í¸ì§‘</div>
              <textarea id="rawHtml" class="input" style="width:100%; height:400px; font-family:monospace; background:#1e1e1e; color:#eee;"></textarea>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <script>
    (function renderShellOnce(){
      if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
        window.AdminCommon.renderShell({ headerSlotId: "admin-header-slot", menuSlotId: "admin-menu-slot", activeMenu: "library_manage" });
      }
    })();

    const API_URL = "https://script.google.com/macros/s/AKfycbxEfHER2lBOZnixi1iX5pwn22lwIOKy6IWcq8XiDmoRsGT34wf1N6eYUL3YYLi8Tho4/exec";

    function switchTab(mode) {
      document.getElementById('tab-easy').style.display = mode === 'easy' ? 'block' : 'none';
      document.getElementById('tab-raw').style.display = mode === 'raw' ? 'block' : 'none';
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if(mode === 'raw') document.getElementById('rawHtml').value = generateHtmlFromEasyMode();
    }

    function loadLibraryList() {
      const listEl = document.getElementById('savedItemsList');
      listEl.innerHTML = '<div style="padding:20px; text-align:center;">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      fetch(API_URL + "?mode=getLibraryList")
        .then(r => r.json())
        .then(res => {
          if (res.items && res.items.length > 0) {
            listEl.innerHTML = "";
            res.items.forEach(item => {
              const div = document.createElement('div');
              div.className = 'saved-item';
              div.innerHTML = `
                <div class="info"><span class="key">${item.key}</span><span class="title">${item.title || '(ì œëª© ì—†ìŒ)'}</span></div>
                <button class="btn secondary" style="padding:5px 10px; font-size:12px;">ë¶ˆëŸ¬ì˜¤ê¸°</button>`;
              div.onclick = () => loadItemToEditor(item.key, item.title);
              listEl.appendChild(div);
            });
          } else {
            listEl.innerHTML = '<div style="padding:20px; text-align:center;">ì €ì¥ëœ ë„¤ë¹„ê²Œì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          }
        });
    }

    function loadItemToEditor(key, title) {
      if(!confirm(`[${key}] ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      document.getElementById('easyKey').value = key;
      document.getElementById('easyTitle').value = title;
      fetch(API_URL + "?mode=getComponent&key=" + key)
        .then(r => r.json())
        .then(res => {
          if(res.result === "success") { parseHtmlToEasyMode(res.html); alert("ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!"); } 
          else { alert("ì‹¤íŒ¨: " + res.msg); }
        });
    }

    function parseHtmlToEasyMode(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      
      const styleTag = doc.querySelector("style");
      if(styleTag) {
        const css = styleTag.innerHTML;
        const main = css.match(/--nw-color-header:\s*(#[0-9a-fA-F]{6})/);
        const sub = css.match(/--nw-color-sub:\s*(#[0-9a-fA-F]{6})/);
        const footer = css.match(/--nw-color-footer:\s*(#[0-9a-fA-F]{6})/);
        const footerText = css.match(/--nw-color-footer-text:\s*(#[0-9a-fA-F]{6})/);
        
        if(main) document.getElementById('easyColorMain').value = main[1];
        if(sub) document.getElementById('easyColorSub').value = sub[1];
        if(footer) document.getElementById('easyColorFooter').value = footer[1];
        if(footerText) document.getElementById('easyFooterTextColor').value = footerText[1];
      }
      
      const titleEl = doc.querySelector(".namu-title");
      const iconEl = doc.querySelector(".namu-icon");
      if(titleEl) document.getElementById('easyHeadTitle').value = titleEl.innerText;
      if(iconEl) document.getElementById('easyIcon').value = iconEl.innerText;

      // í•˜ë‹¨ í…ìŠ¤íŠ¸ ë° ë§í¬ íŒŒì‹± (ë©€í‹° ì§€ì›)
      document.getElementById('footerRows').innerHTML = "";
      const footerEl = doc.querySelector(".namu-bottom-area");
      if(footerEl) {
        const links = footerEl.querySelectorAll("a, span.footer-item");
        if(links.length > 0) {
          links.forEach(l => {
             const href = l.tagName === 'A' ? l.getAttribute('href') : '';
             addFooterRow(l.innerText, href);
          });
        } else if(footerEl.innerText.trim()) {
           // ì˜›ë‚  ë°©ì‹(ë‹¨ì¼ í…ìŠ¤íŠ¸) í˜¸í™˜
           addFooterRow(footerEl.innerText, "");
        }
      }

      const scriptTag = doc.querySelector("script");
      if(scriptTag) {
        const jsonMatch = scriptTag.innerHTML.match(/genealogyData\s*=\s*(\[[\s\S]*?\]);/);
        if(jsonMatch && jsonMatch[1]) {
          let jsonStr = jsonMatch[1].replace(/group:/g, '"group":').replace(/label:/g, '"label":').replace(/href:/g, '"href":');
          try {
            const data = JSON.parse(jsonStr);
            document.getElementById('dataRows').innerHTML = "";
            data.forEach(d => addDataRow(d.group, d.label, d.href));
          } catch(e) {}
        }
      }
      renderPreview();
      generateSkeletonCode();
    }

    // [ìˆ˜ì •] í•­ëª© ì¶”ê°€ (ì¤‘ê°„ ì‚½ì… ì§€ì›)
    function addDataRow(group="", label="", href="", insertAfterElement = null) {
      const container = document.getElementById('dataRows');
      const row = document.createElement('div');
      row.className = 'data-row';
      row.innerHTML = `
        <div class="data-cell"><input type="text" class="inp-group" value="${group}" oninput="renderPreview(); generateSkeletonCode();" placeholder="ê·¸ë£¹"></div>
        <div class="data-cell"><input type="text" class="inp-label" value="${label}" oninput="renderPreview(); generateSkeletonCode();" placeholder="ì´ë¦„"></div>
        <div class="data-cell"><input type="text" class="inp-href" value="${href}" oninput="renderPreview(); generateSkeletonCode();" placeholder="ë§í¬"></div>
        <div class="data-cell">
          <button class="btn-icon" onclick="this.parentElement.parentElement.remove(); renderPreview(); generateSkeletonCode();" title="ì‚­ì œ">Ã—</button>
          <button class="btn-icon btn-add-mid" onclick="insertRowBelow(this)" title="ì•„ë˜ì— ì¶”ê°€">+</button>
        </div>
      `;
      
      if (insertAfterElement && insertAfterElement.nextSibling) {
          container.insertBefore(row, insertAfterElement.nextSibling);
      } else {
          container.appendChild(row);
      }
      renderPreview();
      generateSkeletonCode();
    }

    // ì¤‘ê°„ ì‚½ì… ë„ìš°ë¯¸ í•¨ìˆ˜
    function insertRowBelow(btn) {
      const currentRow = btn.parentElement.parentElement;
      addDataRow("", "", "", currentRow);
    }

    // [ì¶”ê°€] í•˜ë‹¨ ë§í¬ í–‰ ì¶”ê°€
    function addFooterRow(text="", link="") {
      const container = document.getElementById('footerRows');
      const row = document.createElement('div');
      row.className = 'data-row';
      row.innerHTML = `
        <div class="data-cell"><input type="text" class="inp-text" value="${text}" oninput="renderPreview(); generateSkeletonCode();" placeholder="ë¬¸êµ¬"></div>
        <div class="data-cell"><input type="text" class="inp-link" value="${link}" oninput="renderPreview(); generateSkeletonCode();" placeholder="ë§í¬(ì„ íƒ)"></div>
        <div class="data-cell"><button class="btn-icon" onclick="this.parentElement.parentElement.remove(); renderPreview(); generateSkeletonCode();">Ã—</button></div>
      `;
      container.appendChild(row);
      renderPreview();
      generateSkeletonCode();
    }

    function generateHtmlFromEasyMode() {
      const mainColor = document.getElementById('easyColorMain').value;
      const subColor = document.getElementById('easyColorSub').value;
      const footerColor = document.getElementById('easyColorFooter').value;
      const footerTextColor = document.getElementById('easyFooterTextColor').value;
      const headTitle = document.getElementById('easyHeadTitle').value;
      const icon = document.getElementById('easyIcon').value;
      
      // í•˜ë‹¨ ë©€í‹° ë§í¬ ìƒì„±
      let footerHtml = "";
      const footerRows = [];
      document.querySelectorAll('#footerRows .data-row').forEach(row => {
        const text = row.querySelector('.inp-text').value.trim();
        const link = row.querySelector('.inp-link').value.trim();
        if(text) footerRows.push({text, link});
      });

      if(footerRows.length > 0) {
        const itemsHtml = footerRows.map(item => {
           if(item.link) return `<a href="${item.link}">${item.text}</a>`;
           return `<span class="footer-item">${item.text}</span>`;
        }).join(""); // Flexbox gapìœ¼ë¡œ ê°„ê²© ì¡°ì •í•˜ë¯€ë¡œ íƒœê·¸ë§Œ ë‚˜ì—´
        footerHtml = `<div class="namu-bottom-area">${itemsHtml}</div>`;
      }

      const rows = [];
      document.querySelectorAll('#dataRows .data-row').forEach(row => {
        if(row.classList.contains('data-header')) return;
        rows.push({
          group: row.querySelector('.inp-group').value,
          label: row.querySelector('.inp-label').value,
          href: row.querySelector('.inp-href').value
        });
      });
      const jsonData = JSON.stringify(rows, null, 2);

      return `<div class="namu-wiki-container">
  <div class="namu-main-header">
    <span class="namu-icon">${icon}</span>
    <span class="namu-title">${headTitle}</span>
  </div>
  <details class="namu-details">
    <summary class="namu-summary">[ <span class="toggle-text">í¼ì¹˜ê¸°</span> ]</summary>
    <div class="namu-body">
      <div class="namu-genealogy-grid"></div>
      ${footerHtml}
    </div>
  </details>
</div>
<style>
.namu-wiki-container {
  --nw-color-header: ${mainColor};
  --nw-color-sub: ${subColor};
  --nw-color-footer: ${footerColor};
  --nw-color-footer-text: ${footerTextColor};
  --nw-color-group: #EFEFEF;
  --nw-color-border: #ccc;
  --nw-text-white: #fff;
  --nw-text-black: #333;
  border: 2px solid var(--nw-color-header); margin: 30px 0; font-family: sans-serif; box-sizing: border-box;
}
.namu-main-header { background: var(--nw-color-header); color: var(--nw-text-white); padding: 10px; text-align: center; font-weight: bold; font-size: 1.1em; display:flex; justify-content:center; align-items:center; gap:8px; }
.namu-details { background: #fff; display: block; }
.namu-summary { background: var(--nw-color-sub); color: var(--nw-text-white); text-align: center; padding: 6px; cursor: pointer; list-style: none; font-size: 0.9em; border-top: 1px solid rgba(255,255,255,0.2); user-select: none; }
.namu-summary::-webkit-details-marker { display: none; }
.namu-body { background: #fff; padding: 0; }
.namu-details[open] .namu-body { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.namu-group-header { background: var(--nw-color-group); color: var(--nw-text-black); text-align: center; font-weight: bold; padding: 8px; border-bottom: 1px solid var(--nw-color-border); border-top: 1px solid var(--nw-color-border); }
.namu-group-header:first-child { border-top: none; }

/* [ìˆ˜ì •] í•˜ë‹¨ ë©€í‹° ë§í¬ ìŠ¤íƒ€ì¼ */
.namu-bottom-area { 
  background-color: var(--nw-color-footer); 
  color: var(--nw-color-footer-text);
  padding: 10px; 
  text-align: center; 
  font-size: 0.9em; 
  border-top: 2px solid var(--nw-color-header); 
  display: flex; 
  justify-content: center; 
  flex-wrap: wrap; 
  gap: 15px; /* ë§í¬ ì‚¬ì´ ê°„ê²© */
}
.namu-bottom-area a { text-decoration: none; color: inherit; font-weight: bold; }
.namu-bottom-area a:hover { text-decoration: underline; opacity: 0.8; }
.namu-bottom-area .footer-item { font-weight: normal; }

.namu-group-grid { display: grid; grid-template-columns: repeat(4, 1fr); width: 100%; }
.namu-cell { display: flex; align-items: center; justify-content: center; padding: 12px 5px; text-align: center; text-decoration: none; color: var(--nw-text-black); font-size: 0.95em; border-right: 1px solid var(--nw-color-border); border-bottom: 1px solid var(--nw-color-border); background: #fff; transition: background 0.2s; word-break: keep-all; }
.namu-group-grid .namu-cell:nth-child(4n) { border-right: none; }
.namu-cell:hover { background-color: #f0f0f0; text-decoration: underline; }
.namu-cell.active { background-color: #fff0f0; font-weight: bold; color: var(--nw-color-header); box-shadow: inset 0 0 0 2px var(--nw-color-header); }

@media (max-width: 600px) {
  .namu-group-grid { grid-template-columns: repeat(2, 1fr); }
  .namu-group-grid .namu-cell { border-right: 1px solid var(--nw-color-border); padding: 12px 2px; font-size: 13px; min-height: 40px; }
  .namu-group-grid .namu-cell:nth-child(2n) { border-right: none; }
  .namu-group-grid .namu-cell:nth-child(4n) { border-right: none; }
}
</style>
<script>
(function(){
  const unprocessed = document.querySelectorAll(".namu-wiki-container:not(.js-active)");
  unprocessed.forEach(root => {
    root.classList.add("js-active");
    const genealogyData = ${jsonData};
    const container = root.querySelector(".namu-genealogy-grid");
    if (container) {
      const currentPath = location.pathname;
      const currentFullUrl = location.href;
      const grouped = genealogyData.reduce((acc, item) => { const g = item.group || "ê¸°íƒ€"; (acc[g] ||= []).push(item); return acc; }, {});
      container.innerHTML = "";
      Object.keys(grouped).forEach(groupName => {
        const header = document.createElement("div"); header.className = "namu-group-header"; header.textContent = groupName; container.appendChild(header);
        const grid = document.createElement("div"); grid.className = "namu-group-grid";
        grouped[groupName].forEach(it => {
          const el = document.createElement(it.href ? "a" : "div"); el.className = "namu-cell"; el.textContent = it.label;
          if (it.href) el.href = it.href;
          if (it.href && (currentPath.indexOf(it.href) !== -1 || currentFullUrl.indexOf(it.href) !== -1)) { el.classList.add("active"); el.setAttribute("aria-current", "page"); }
          grid.appendChild(el);
        });
        container.appendChild(grid);
      });
    }
    const details = root.querySelector(".namu-details");
    const summaryText = root.querySelector(".toggle-text");
    if (details && summaryText) { details.addEventListener("toggle", function() { summaryText.textContent = details.open ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°"; }); }
  });
})();
<\/script>`;
    }

    function renderPreview() {
      const html = generateHtmlFromEasyMode();
      const previewBox = document.getElementById('easyPreview');
      previewBox.innerHTML = html;
      previewBox.querySelectorAll('script').forEach(oldS => { const newS = document.createElement('script'); newS.text = oldS.innerHTML; oldS.parentNode.replaceChild(newS, oldS); });
      const details = previewBox.querySelector('details'); if(details) details.open = true;
    }
    function saveEasyMode() {
      const key = document.getElementById('easyKey').value; const title = document.getElementById('easyTitle').value; const content = generateHtmlFromEasyMode();
      if(!key) return alert("KEY(ID)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      if(confirm(`[${key}] ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(API_URL, { method: "POST", body: JSON.stringify({ mode: "saveLibrary", key: key, title: title || key, content: content }) })
        .then(r => r.json()).then(res => { 
          if(res.result === "success") { 
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜¤ë¥¸ìª½ì— ìƒì„±ëœ 'ìŠ¤ì¼ˆë ˆí†¤ ì½”ë“œ'ë¥¼ ë¸”ë¡œê·¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."); 
            loadLibraryList(); 
          } else { alert("âŒ ì˜¤ë¥˜: " + res.msg); } 
        });
      }
    }
    function deleteCurrent() {
      const key = document.getElementById('easyKey').value; if(!key) return;
      if(confirm(`ì •ë§ [${key}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(API_URL, { method: "POST", body: JSON.stringify({ mode: "deleteLibrary", key: key }) }).then(r => r.json()).then(res => { if(res.result === "success") { alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); loadLibraryList(); resetForm(); } });
      }
    }
    function resetForm() {
      document.getElementById('easyKey').value = "NAV_NEW";
      document.getElementById('easyTitle').value = "";
      document.getElementById('footerRows').innerHTML = "";
      document.getElementById('dataRows').innerHTML = "";
      addDataRow(); renderPreview(); generateSkeletonCode();
    }

    // ìŠ¤ì¼ˆë ˆí†¤ ì½”ë“œ ìƒì„±ê¸° (ì—…ë°ì´íŠ¸ë¨)
    function generateSkeletonCode() {
      const key = document.getElementById('easyKey').value || "NAV_KEY";
      const mainColor = document.getElementById('easyColorMain').value;
      const subColor = document.getElementById('easyColorSub').value;
      const footerColor = document.getElementById('easyColorFooter').value;
      const footerTextColor = document.getElementById('easyFooterTextColor').value;
      const headTitle = document.getElementById('easyHeadTitle').value;
      const icon = document.getElementById('easyIcon').value;

      // í•˜ë‹¨ ë§í¬ë“¤ ìŠ¤ì¼ˆë ˆí†¤ ìƒì„±
      let footerHtml = "";
      const footerRows = [];
      document.querySelectorAll('#footerRows .data-row').forEach(row => {
        const text = row.querySelector('.inp-text').value.trim();
        const link = row.querySelector('.inp-link').value.trim();
        if(text) footerRows.push({text, link});
      });

      if(footerRows.length > 0) {
        const itemsHtml = footerRows.map(item => {
           if(item.link) return `<a href="${item.link}" style="text-decoration:none; color:inherit; font-weight:bold;">${item.text}</a>`;
           return `<span>${item.text}</span>`;
        }).join(` <span style="opacity:0.3">|</span> `); // ìŠ¤ì¼ˆë ˆí†¤ìš© êµ¬ë¶„ì
        
        footerHtml = `<div class="namu-bottom-area" style="background-color:${footerColor}; color:${footerTextColor}; padding:10px; border-top:2px solid ${mainColor}; text-align:center; font-size:0.9em; display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">${itemsHtml}</div>`;
      }

      const code = `<div class="cheese-template" data-key="${key}" style="--nw-color-header:${mainColor}; --nw-color-sub:${subColor}; --nw-color-footer:${footerColor}; --nw-color-footer-text:${footerTextColor};">
  <div class="namu-wiki-container" style="border:2px solid ${mainColor}; margin:30px 0; font-family:sans-serif; box-sizing:border-box;">
    <div class="namu-main-header" style="background:${mainColor}; color:#fff; padding:10px; text-align:center; font-weight:bold; font-size:1.1em; display:flex; justify-content:center; align-items:center; gap:8px;">
      <span class="namu-icon">${icon}</span>
      <span class="namu-title">${headTitle}</span>
    </div>
    <details class="namu-details" open style="background:#fff;">
      <summary class="namu-summary" style="background:${subColor}; color:#fff; text-align:center; padding:6px; cursor:pointer; list-style:none; font-size:0.9em; user-select:none;">
        [ <span class="toggle-text">í¼ì¹˜ê¸°</span> ]
      </summary>
      <div class="namu-body">
        <div class="namu-genealogy-grid" style="padding:20px; text-align:center; color:#ccc; animation:blink 1.5s infinite;">
           ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ ë¡œë”© ì¤‘...
        </div>
        ${footerHtml}
      </div>
    </details>
  </div>
  <style>@keyframes blink{0%{opacity:1}50%{opacity:0.4}100%{opacity:1}}.namu-summary::-webkit-details-marker{display:none}</style>
</div>`;

      document.getElementById('skeletonExport').value = code;
    }

    function copySkeletonCode() {
      const copyText = document.getElementById("skeletonExport");
      copyText.select();
      copyText.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(copyText.value).then(() => {
        alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\në¸”ë¡œê·¸ HTML ëª¨ë“œì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
      });
    }

    window.onload = function() { loadLibraryList(); addDataRow(); renderPreview(); generateSkeletonCode(); };
  </script>
</body>
</html>
