<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë„¤ë¹„ê²Œì´í„° ì œì‘ ë„êµ¬</title>

  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js"></script>

  <style>
    /* ì´ì§€ ì—ë””í„° ì „ìš© ìŠ¤íƒ€ì¼ */
    .lm-wrap { padding: 0; }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tabs { display:flex; gap:10px; margin-bottom:15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .tab-btn {
      border: none; background: transparent; padding: 10px 15px; cursor: pointer;
      font-weight: bold; color: #888; border-radius: 8px; transition: 0.2s;
    }
    .tab-btn.active { background: #eef2ff; color: #4f46e5; }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:20px; margin-bottom:15px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); }
    .card-title { font-weight: 800; font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: #1e293b; }

    /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-label { font-size: 13px; font-weight: 600; color: #64748b; }
    .input { border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
    .input:focus { border-color: #6366f1; ring: 2px solid #e0e7ff; }
    .input[type="color"] { padding: 2px; height: 42px; width: 100%; cursor: pointer; }

    /* ë°ì´í„° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .data-list { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
    .data-row { display: grid; grid-template-columns: 100px 1fr 1fr 40px; gap: 1px; background: #e2e8f0; }
    .data-cell { background: #fff; padding: 8px; }
    .data-cell input { width: 100%; border: none; outline: none; font-size: 13px; }
    .data-header { background: #f8fafc; font-weight: bold; font-size: 12px; color: #475569; text-align: center; }
    .btn-icon { border: none; background: #fee2e2; color: #ef4444; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .btn-icon:hover { background: #fecaca; }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn { background: #0f172a; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
    .btn.secondary { background: #fff; color: #0f172a; border: 1px solid #cbd5e1; }
    .btn.primary { background: #4f46e5; color: white; }
    .btn.full { width: 100%; margin-top: 10px; }

    /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
    .preview-box { border: 2px dashed #cbd5e1; padding: 20px; border-radius: 12px; background: #f8fafc; min-height: 200px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      
      <main class="admin-content">
        <div class="lm-wrap">
          
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('easy')">ğŸ¨ ì´ì§€ ë¹Œë” (ì´ˆë³´ììš©)</button>
            <button class="tab-btn" onclick="switchTab('raw')">ğŸ”§ ê³ ê¸‰ í¸ì§‘ (HTML)</button>
          </div>

          <div id="tab-easy" style="display:block;">
            <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px;">
              
              <div class="left-panel">
                
                <div class="card">
                  <div class="card-title">âš™ï¸ ê¸°ë³¸ ì„¤ì •</div>
                  <div class="form-group">
                    <label class="form-label">ê³ ìœ  ID (KEY)</label>
                    <input type="text" id="easyKey" class="input" placeholder="ì˜ˆ: NAV_HISTORY" value="NAV_NEW">
                  </div>
                  <div class="form-group" style="margin-top:10px;">
                    <label class="form-label">ì œëª© (ê´€ë¦¬ìš©)</label>
                    <input type="text" id="easyTitle" class="input" placeholder="ì˜ˆ: ì¡°ì„  ì™•ì¡° ê°€ê³„ë„">
                  </div>
                </div>

                <div class="card">
                  <div class="card-title">ğŸ¨ ë””ìì¸ & ìƒ‰ìƒ</div>
                  <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                      <label class="form-label">ë©”ì¸ ìƒ‰ìƒ</label>
                      <input type="color" id="easyColorMain" class="input" value="#B70000" oninput="renderPreview()">
                    </div>
                    <div class="form-group">
                      <label class="form-label">ì„œë¸Œ ìƒ‰ìƒ</label>
                      <input type="color" id="easyColorSub" class="input" value="#A00000" oninput="renderPreview()">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">ìƒë‹¨ ì œëª©</label>
                    <input type="text" id="easyHeadTitle" class="input" value="ì—­ëŒ€ ì™•ì¡° ê°€ê³„ë„ ì‹œë¦¬ì¦ˆ" oninput="renderPreview()">
                  </div>
                  <div class="form-group" style="margin-top:10px;">
                    <label class="form-label">ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                    <input type="text" id="easyIcon" class="input" value="ğŸ‘‘" oninput="renderPreview()" style="width: 50px; text-align: center;">
                  </div>
                </div>

                <div class="card">
                  <div class="card-title">ğŸ“ ë‚´ìš© ì…ë ¥</div>
                  <div class="data-list">
                    <div class="data-row data-header">
                      <div class="data-cell">ê·¸ë£¹ëª…</div>
                      <div class="data-cell">ì´ë¦„(ë¼ë²¨)</div>
                      <div class="data-cell">ë§í¬ì£¼ì†Œ</div>
                      <div class="data-cell">ì‚­ì œ</div>
                    </div>
                    <div id="dataRows">
                      </div>
                  </div>
                  <button class="btn secondary full" onclick="addRows()">+ í•­ëª© ì¶”ê°€í•˜ê¸°</button>
                </div>

                <button class="btn primary full" style="padding: 15px;" onclick="saveEasyMode()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
              </div>

              <div class="right-panel">
                <div class="card" style="height: 100%; display:flex; flex-direction:column;">
                  <div class="card-title">ğŸ‘€ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</div>
                  <div id="easyPreview" class="preview-box"></div>
                  <p style="font-size:12px; color:#888; margin-top:10px; text-align:center;">
                    * ì‹¤ì œ ë¸”ë¡œê·¸ì—ì„œëŠ” ì ‘ê¸°/í¼ì¹˜ê¸° ê¸°ëŠ¥ì´ ì‘ë™í•©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>

            </div>
          </div>

          <div id="tab-raw" style="display:none;">
            <div class="card">
              <div class="card-title">HTML ì§ì ‘ í¸ì§‘</div>
              <p style="font-size:13px; color:#666; margin-bottom:10px;">ì½”ë“œë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
              <textarea id="rawHtml" class="input" style="width:100%; height:400px; font-family:monospace; background:#1e1e1e; color:#eee;"></textarea>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <script>
    // 1. ê³µí†µ ì‰˜ ë¡œë“œ
    (function renderShellOnce(){
      if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
        window.AdminCommon.renderShell({
          headerSlotId: "admin-header-slot",
          menuSlotId: "admin-menu-slot",
          activeMenu: "library_manage"
        });
      }
    })();

    // 2. Apps Script URL (ì‚¬ìš©ìë‹˜ì˜ ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”)
    const API_URL = "https://script.google.com/macros/s/AKfycbxEfHER2lBOZnixi1iX5pwn22lwIOKy6IWcq8XiDmoRsGT34wf1N6eYUL3YYLi8Tho4/exec";

    // --- íƒ­ ì „í™˜ ê¸°ëŠ¥ ---
    function switchTab(mode) {
      document.getElementById('tab-easy').style.display = mode === 'easy' ? 'block' : 'none';
      document.getElementById('tab-raw').style.display = mode === 'raw' ? 'block' : 'none';
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      if(mode === 'raw') {
        document.getElementById('rawHtml').value = generateHtmlFromEasyMode();
      }
    }

    // --- ì´ì§€ ë¹Œë” ë¡œì§ ---
    
    // ì´ˆê¸° ë°ì´í„° (ì˜ˆì‹œ)
    const defaultData = [
      { group: "ì¡°ì„ ", label: "íƒœì¡°", href: "/joseon-1" },
      { group: "ì¡°ì„ ", label: "ì •ì¢…", href: "/joseon-2" },
      { group: "ê³ ë ¤", label: "íƒœì¡° ì™•ê±´", href: "/goryeo-1" }
    ];

    function init() {
      // ì´ˆê¸° í–‰ ì¶”ê°€
      defaultData.forEach(d => addRows(d.group, d.label, d.href));
      renderPreview();
    }

    function addRows(group="", label="", href="") {
      const container = document.getElementById('dataRows');
      const row = document.createElement('div');
      row.className = 'data-row';
      row.innerHTML = `
        <div class="data-cell"><input type="text" class="inp-group" value="${group}" oninput="renderPreview()" placeholder="ê·¸ë£¹"></div>
        <div class="data-cell"><input type="text" class="inp-label" value="${label}" oninput="renderPreview()" placeholder="ì´ë¦„"></div>
        <div class="data-cell"><input type="text" class="inp-href" value="${href}" oninput="renderPreview()" placeholder="/link"></div>
        <div class="data-cell"><button class="btn-icon" onclick="this.parentElement.parentElement.remove(); renderPreview()">Ã—</button></div>
      `;
      container.appendChild(row);
      // ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
      container.scrollTop = container.scrollHeight;
    }

    // --- í•µì‹¬: ì…ë ¥ê°’ -> HTML ë³€í™˜ê¸° ---
    function generateHtmlFromEasyMode() {
      const mainColor = document.getElementById('easyColorMain').value;
      const subColor = document.getElementById('easyColorSub').value;
      const headTitle = document.getElementById('easyHeadTitle').value;
      const icon = document.getElementById('easyIcon').value;
      
      // ë°ì´í„° ìˆ˜ì§‘
      const rows = [];
      document.querySelectorAll('#dataRows .data-row').forEach(row => {
        if(row.classList.contains('data-header')) return;
        rows.push({
          group: row.querySelector('.inp-group').value,
          label: row.querySelector('.inp-label').value,
          href: row.querySelector('.inp-href').value
        });
      });

      // JSON ë°ì´í„° ìƒì„±
      const jsonData = JSON.stringify(rows, null, 2);

      // HTML í…œí”Œë¦¿ ì¡°í•© (ê¸°ì¡´ ì›ë³¸ í‹€.txt ê¸°ë°˜)
      return `<div class="namu-wiki-container">
  <div class="namu-main-header">
    <span class="namu-icon">${icon}</span>
    <span class="namu-title">${headTitle}</span>
  </div>

  <details class="namu-details">
    <summary class="namu-summary">
      [ <span class="toggle-text">í¼ì¹˜ê¸°</span> ]
    </summary>
    <div class="namu-body">
      <div class="namu-genealogy-grid"></div>
    </div>
  </details>
</div>

<style>
/* ìë™ ìƒì„±ëœ ìŠ¤íƒ€ì¼ */
.namu-wiki-container {
  --nw-color-header: ${mainColor};
  --nw-color-sub: ${subColor};
  --nw-color-group: #EFEFEF;
  --nw-color-border: #ccc;
  --nw-text-white: #fff;
  --nw-text-black: #333;
  
  border: 2px solid var(--nw-color-header);
  margin: 30px 0;
  font-family: sans-serif;
  box-sizing: border-box;
}

.namu-main-header {
  background-color: var(--nw-color-header);
  color: var(--nw-text-white);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  font-size: 1.1em;
  display: flex; justify-content: center; align-items: center; gap: 8px;
}
.namu-details { background: #fff; display: block; }
.namu-summary {
  background-color: var(--nw-color-sub);
  color: var(--nw-text-white);
  text-align: center; padding: 6px; cursor: pointer; list-style: none;
  font-size: 0.9em; border-top: 1px solid rgba(255,255,255,0.2);
  user-select: none;
}
.namu-summary::-webkit-details-marker { display: none; }
.namu-body { background: #fff; padding: 0; }
.namu-details[open] .namu-body { animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.namu-group-header {
  background-color: var(--nw-color-group); color: var(--nw-text-black);
  text-align: center; font-weight: bold; padding: 8px;
  border-bottom: 1px solid var(--nw-color-border);
  border-top: 1px solid var(--nw-color-border);
}
.namu-group-header:first-child { border-top: none; }
.namu-group-grid { display: grid; grid-template-columns: repeat(4, 1fr); width: 100%; }
.namu-cell {
  display: flex; align-items: center; justify-content: center;
  padding: 12px 5px; text-align: center; text-decoration: none;
  color: var(--nw-text-black); font-size: 0.95em;
  border-right: 1px solid var(--nw-color-border);
  border-bottom: 1px solid var(--nw-color-border);
  background: #fff; transition: background 0.2s;
}
.namu-group-grid .namu-cell:nth-child(4n) { border-right: none; }
.namu-cell:hover { background-color: #f0f0f0; text-decoration: underline; }
.namu-cell.active {
  background-color: #fff0f0; font-weight: bold;
  color: var(--nw-color-header); box-shadow: inset 0 0 0 2px var(--nw-color-header);
}
@media (max-width: 600px) {
  .namu-group-grid { grid-template-columns: repeat(2, 1fr); }
  .namu-group-grid .namu-cell { border-right: 1px solid var(--nw-color-border); }
  .namu-group-grid .namu-cell:nth-child(2n) { border-right: none; }
}
</style>

<script>
(function(){
  const unprocessed = document.querySelectorAll(".namu-wiki-container:not(.js-active)");
  unprocessed.forEach(root => {
    root.classList.add("js-active");

    // === ë°ì´í„° ì£¼ì… ===
    const genealogyData = ${jsonData};

    const container = root.querySelector(".namu-genealogy-grid");
    if (container) {
      const currentPath = location.pathname;
      const grouped = genealogyData.reduce((acc, item) => {
        const g = item.group || "ê¸°íƒ€"; (acc[g] ||= []).push(item); return acc;
      }, {});
      container.innerHTML = "";
      Object.keys(grouped).forEach(groupName => {
        const header = document.createElement("div");
        header.className = "namu-group-header"; header.textContent = groupName;
        container.appendChild(header);
        const grid = document.createElement("div");
        grid.className = "namu-group-grid";
        grouped[groupName].forEach(it => {
          const el = document.createElement(it.href ? "a" : "div");
          el.className = "namu-cell"; el.textContent = it.label;
          if (it.href) el.href = it.href;
          if (it.href && currentPath.indexOf(it.href) !== -1) {
            el.classList.add("active"); el.setAttribute("aria-current", "page");
          }
          grid.appendChild(el);
        });
        container.appendChild(grid);
      });
    }
    const details = root.querySelector(".namu-details");
    const summaryText = root.querySelector(".toggle-text");
    if (details && summaryText) {
      details.addEventListener("toggle", function() {
        summaryText.textContent = details.open ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°";
      });
    }
  });
})();
<\/script>
`;
    }

    function renderPreview() {
      const html = generateHtmlFromEasyMode();
      const previewBox = document.getElementById('easyPreview');
      previewBox.innerHTML = html;
      
      // ìŠ¤í¬ë¦½íŠ¸ ê°•ì œ ì‹¤í–‰ (ë¯¸ë¦¬ë³´ê¸°ìš©)
      previewBox.querySelectorAll('script').forEach(oldS => {
        const newS = document.createElement('script');
        newS.text = oldS.innerHTML;
        oldS.parentNode.replaceChild(newS, oldS);
      });
      
      // ë¯¸ë¦¬ë³´ê¸°ì—ì„œëŠ” detailsë¥¼ ê°•ì œë¡œ í¼ì³ë‘ 
      const details = previewBox.querySelector('details');
      if(details) details.open = true;
    }

    function saveEasyMode() {
      const key = document.getElementById('easyKey').value;
      const title = document.getElementById('easyTitle').value;
      const content = generateHtmlFromEasyMode();

      if(!key) return alert("KEY(ID)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

      if(confirm(`[${key}] ë„¤ë¹„ê²Œì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            mode: "saveLibrary",
            key: key,
            title: title || key,
            content: content
          })
        })
        .then(r => r.json())
        .then(res => {
          if(res.result === "success") {
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në¸”ë¡œê·¸ HTML ëª¨ë“œì— ì•„ë˜ íƒœê·¸ë¥¼ ë„£ìœ¼ì„¸ìš”:\n<div class=\"cheese-template\" data-key=\"" + key + "\"></div>");
          } else {
            alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + res.msg);
          }
        });
      }
    }

    window.onload = init;
  </script>
</body>
</html>
