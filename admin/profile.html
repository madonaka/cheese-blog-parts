<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¸ì‚¬ ê´€ë¦¬ - Cheese Lab</title>
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* âœ¨ ì„¸ë ¨ëœ ì¸ì‚¬ ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ */
    .user-list-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .user-table { width: 100%; border-collapse: collapse; text-align: left; }
    .user-table th { background: #f8fafc; padding: 15px; font-size: 0.8rem; text-transform: uppercase; color: #64748b; border-bottom: 1px solid #e2e8f0; }
    .user-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; color: #1a202c; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .status-1 { background: #dcfce7; color: #166534; } 
    .status-0 { background: #fee2e2; color: #991b1b; }

    /* ğŸ¨ ëª¨ë‹¬ ì—…ê·¸ë ˆì´ë“œ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(8px); }
    .modal-content { background: #fff; margin: 5% auto; border-radius: 16px; width: 90%; max-width: 520px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); overflow: hidden; animation: modalFadeIn 0.3s; }
    @keyframes modalFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
    .modal-body { padding: 25px; }
    .modal-footer { padding: 15px 25px; background: #f8fafc; display: flex; gap: 10px; justify-content: flex-end; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full-width { grid-column: span 2; }
    .field-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
    .styled-input { width: 100%; padding: 10px 14px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; box-sizing: border-box; }
    .styled-input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  </style>
  <script>
    // âœ… ì‹¤ì œ ë°°í¬ëœ API ì£¼ì†Œë¡œ ìˆ˜ì • í•„ìˆ˜
    window.CHEESE_LOGIN_API = "https://script.google.com/macros/s/ì—¬ê¸°ì—_ìŠ¤í¬ë¦½íŠ¸_ID_ì…ë ¥/exec";
  </script>
</head>
<body>
  <div class="admin-shell">
    <section class="admin-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ‘¤ ì¸ì‚¬ ì •ë³´ ê´€ë¦¬</h2>
        <button class="btn-bbs" style="background:#1a202c; color:#fff;" onclick="openModal()">+ ì‹ ê·œ ë“±ë¡</button>
      </div>

      <div class="user-list-card">
        <table class="user-table">
          <thead>
            <tr>
              <th>ì´ë¦„/ì‚¬ë²ˆ</th>
              <th>ë¶€ì„œ/ì§ê¸‰</th>
              <th>ì´ë©”ì¼</th>
              <th>ê¶Œí•œ</th>
              <th>ìƒíƒœ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="user-tbody">
            </tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title" style="margin:0;">ì§ì› ì •ë³´ ìˆ˜ì •</h3>
        <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="full-width">
            <label class="field-label">ì„±ëª…</label>
            <input type="text" id="m-name" class="styled-input">
          </div>
          <div>
            <label class="field-label">ì‚¬ë²ˆ (ìˆ˜ì •ë¶ˆê°€)</label>
            <input type="text" id="m-empNo" class="styled-input" readonly style="background:#f1f5f9;">
          </div>
          <div>
            <label class="field-label">ì•„ì´ë””</label>
            <input type="text" id="m-loginId" class="styled-input">
          </div>
          <div class="full-width">
            <label class="field-label">ì´ë©”ì¼ ì£¼ì†Œ</label>
            <input type="email" id="m-email" class="styled-input">
          </div>
          <div>
            <label class="field-label">ë¶€ì„œ</label>
            <input type="text" id="m-dept" class="styled-input">
          </div>
          <div>
            <label class="field-label">ë¶€ì„œ ì„ íƒ</label>
            <select id="m-dept" class="styled-input">
              <option value="">ë¶€ì„œ ì„ íƒ</option>
              </select>
          </div>
          <div>
            <label class="field-label">ì§ê¸‰ ì„ íƒ</label>
            <select id="m-pos" class="styled-input">
              <option value="">ì§ê¸‰ ì„ íƒ</option>
              <option value="ì‚¬ì›">ì‚¬ì›</option>
              <option value="ëŒ€ë¦¬">ëŒ€ë¦¬</option>
              <option value="ê³¼ì¥">ê³¼ì¥</option>
              <option value="ì°¨ì¥">ì°¨ì¥</option>
              <option value="ë¶€ì¥">ë¶€ì¥</option>
              <option value="íŒ€ì¥">íŒ€ì¥</option>
              <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
            </select>
          </div>
          <div>
            <label class="field-label">ì‹œìŠ¤í…œ ê¶Œí•œ</label>
            <select id="m-role" class="styled-input">
              <option value="EMP">ì¼ë°˜ ì‚¬ì›(EMP)</option>
              <option value="MGR">ë§¤ë‹ˆì €(MGR)</option>
              <option value="ADMIN">ê´€ë¦¬ì(ADMIN)</option>
            </select>
          </div>
          <div>
            <label class="field-label">ê³„ì • ìƒíƒœ</label>
            <select id="m-active" class="styled-input">
              <option value="1">ì •ìƒ ì‚¬ìš©</option>
              <option value="0">ê³„ì • ì ê¸ˆ</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal()" style="padding:10px 20px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;">ì·¨ì†Œ</button>
        <button onclick="saveUser()" style="padding:10px 25px; border-radius:8px; background:#1a202c; color:#fff; border:none; cursor:pointer; font-weight:700;">ì •ë³´ ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(fetchUsers);

    async function fetchUsers() {
      try {
        const res = await fetch(`${window.CHEESE_LOGIN_API}?mode=listUsers`);
        const json = await res.json();
        if(!json.ok) return;

        const html = json.users.map(u => `
          <tr>
            <td><strong>${u.displayName}</strong><br><small style="color:#718096">${u.empNo}</small></td>
            <td>${u.deptId || '-'} / ${u.positionName || '-'}</td>
            <td>${u.email}</td>
            <td><code style="background:#f1f5f9; padding:2px 5px; border-radius:4px;">${u.role}</code></td>
            <td><span class="status-badge status-${u.active}">${u.active == 1 ? 'ì •ìƒ' : 'ì ê¸ˆ'}</span></td>
            <td><button style="padding:5px 10px; cursor:pointer;" onclick='openModal(${JSON.stringify(u)})'>ìˆ˜ì •</button></td>
          </tr>
        `).join('');
        $('#user-tbody').html(html);
      } catch(e) { console.error("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", e); }
    }

    function openModal(user = null) {
      const modal = document.getElementById('userModal');
      modal.style.display = 'block';

      if(user) {
        $('#modal-title').text("ì§ì› ì •ë³´ ìˆ˜ì •");
        $('#m-name').val(user.displayName);
        $('#m-empNo').val(user.empNo).prop('readonly', true);
        $('#m-loginId').val(user.loginId);
        $('#m-email').val(user.email);
        // ğŸš¨ select ë°•ìŠ¤ ê°’ ë§¤ì¹­
        $('#m-dept').val(user.deptId); 
        $('#m-pos').val(user.positionName);

        $('#m-role').val(user.role);
        $('#m-active').val(user.active);
      } else {
        $('#modal-title').text("ì‹ ê·œ ì§ì› ë“±ë¡");
        $('.styled-input').val('');
        $('#m-empNo').prop('readonly', false).css('background', '#fff');
        $('#m-active').val('1');
        $('#m-role').val('EMP');
      }
    }

    function closeModal() { $('#userModal').hide(); }

    // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      if (event.target == document.getElementById('userModal')) closeModal();
    }

    async function saveUser() {
      const payload = {
        mode: 'upsertUser',
        empNo: $('#m-empNo').val(),
        loginId: $('#m-loginId').val(),
        displayName: $('#m-name').val(),
        email: $('#m-email').val(),
        deptId: $('#m-dept').val(),
        positionName: $('#m-pos').val(),
        role: $('#m-role').val(),
        active: $('#m-active').val()
      };

      if(!payload.empNo || !payload.loginId) return alert("ì‚¬ë²ˆê³¼ ì•„ì´ë””ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      try {
        const res = await fetch(window.CHEESE_LOGIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        alert(json.message);
        if(json.ok) {
          closeModal();
          fetchUsers();
        }
      } catch(e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }

    // ì„œë²„ì—ì„œ ë¶€ì„œ ëª©ë¡ì„ ê°€ì ¸ì™€ Select ë°•ìŠ¤ì— ì±„ìš°ëŠ” í•¨ìˆ˜
    async function fetchDeptOptions() {
      try {
        const res = await fetch(`${window.CHEESE_LOGIN_API}?mode=getDeptList`);
        const json = await res.json();
        if(json.ok) {
          const $deptSelect = $('#m-dept');
          json.list.forEach(dept => {
            $deptSelect.append(`<option value="${dept.id}">${dept.name} (${dept.id})</option>`);
          });
        }
      } catch(e) {
        console.error("ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", e);
      }
    }
  </script>
</body>
</html>
