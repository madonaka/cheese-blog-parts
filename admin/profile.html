<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>개인정보 수정 - Cheese Lab</title>
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // ✅ 로그인 API 주소 (V3.0 통합본이 배포된 주소)
    window.CHEESE_LOGIN_API = "https://script.google.com/macros/s/AKfycbwLtN5N5ndt80qRnGPCkVIaus9YbyAFRPWbhfU5tyFOdULUmm8CPrV6ffngEH4r8Z_E/exec"; // 본인의 로그인 API 주소로 확인 필요
    
    // 세션 정보 가져오기
    const currId = sessionStorage.getItem("cheese_admin_login_id");
    const currName = sessionStorage.getItem("cheese_admin_display_name");
    const currEmpNo = sessionStorage.getItem("cheese_admin_emp_no");
  </script>
  <script src="./admin-common.js" defer></script>
</head>
<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <main class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      
      <section class="admin-content">
        <div style="max-width: 500px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; border: 1px solid #eee;">
          <h2 style="margin-top:0;">내 정보 수정</h2>
          <p style="color: #666; font-size: 0.9rem; margin-bottom: 25px;">보안을 위해 비밀번호를 주기적으로 변경해 주세요.</p>
          
          <div style="margin-bottom: 15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px;">아이디 / 사번</label>
            <input type="text" id="disp-info" class="styled-input" disabled style="background:#f5f5f5;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px;">현재 비밀번호</label>
            <input type="password" id="old-pw" class="styled-input" placeholder="현재 비밀번호 입력">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px;">새 비밀번호</label>
            <input type="password" id="new-pw" class="styled-input" placeholder="새 비밀번호 입력">
          </div>

          <div style="margin-bottom: 25px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px;">새 비밀번호 확인</label>
            <input type="password" id="confirm-pw" class="styled-input" placeholder="새 비밀번호 다시 입력">
          </div>

          <button onclick="updatePassword()" class="btn-bbs" style="width:100%; background:#333; color:#fff; border:none; padding:12px;">비밀번호 변경하기</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // 초기 값 세팅
    document.getElementById('disp-info').value = `${currName} (${currId} / ${currEmpNo})`;

    async function updatePassword() {
      const oldPw = document.getElementById('old-pw').value;
      const newPw = document.getElementById('new-pw').value;
      const confirmPw = document.getElementById('confirm-pw').value;

      if(!oldPw || !newPw || !confirmPw) return alert("모든 항목을 입력해주세요.");
      if(newPw !== confirmPw) return alert("새 비밀번호가 일치하지 않습니다.");
      if(newPw.length < 4) return alert("비밀번호는 4자리 이상이어야 합니다.");

      if(!confirm("비밀번호를 변경하시겠습니까?")) return;

      const payload = {
        mode: 'changePassword',
        loginId: currId,
        oldPassword: oldPw,
        newPassword: newPw
      };

      try {
        const res = await fetch(window.CHEESE_LOGIN_API, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if(json.ok) {
          alert("비밀번호가 성공적으로 변경되었습니다. 다시 로그인 해주세요.");
          // 보안을 위해 로그아웃 처리
          sessionStorage.clear();
          location.href = "../index.html";
        } else {
          alert("오류: " + json.message);
        }
      } catch(e) {
        alert("서버 통신 중 오류가 발생했습니다.");
      }
    }
  </script>
</body>
</html>
