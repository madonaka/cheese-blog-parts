<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚´ ì •ë³´ ê´€ë¦¬ - Cheese Lab</title>
  
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <style>
    /* í”„ë¡œí•„ ì „ìš© ì„¸ë ¨ëœ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .profile-card {
      max-width: 500px;
      margin: 50px auto;
      background: #fff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      border: 1px solid #eee;
    }
    .profile-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .profile-header h2 {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 8px;
    }
    .profile-header p {
      color: #718096;
      font-size: 0.9rem;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      color: #4a5568;
      margin-bottom: 8px;
      margin-left: 2px;
    }
    .styled-input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s;
      box-sizing: border-box;
    }
    .styled-input:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .styled-input:disabled {
      background: #f8fafc;
      color: #94a3b8;
      cursor: not-allowed;
    }
    .btn-submit-profile {
      width: 100%;
      padding: 14px;
      background: #1a202c;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 10px;
    }
    .btn-submit-profile:hover {
      background: #2d3748;
    }
    .info-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #edf2f7;
      border-radius: 20px;
      font-size: 0.8rem;
      color: #4a5568;
      margin-top: 10px;
    }
  </style>

  <script>
    // âœ… API ì£¼ì†Œ (V3.0 í†µí•©ë³¸ ì£¼ì†Œ)
    window.CHEESE_LOGIN_API = "https://script.google.com/macros/s/AKfycbwLtN5N5ndt80qRnGPCkVIaus9YbyAFRPWbhfU5tyFOdULUmm8CPrV6ffngEH4r8Z_E/exec"; 
    
    const currId = sessionStorage.getItem("cheese_admin_login_id");
    const currName = sessionStorage.getItem("cheese_admin_display_name");
    const currEmpNo = sessionStorage.getItem("cheese_admin_emp_no");
    const currRole = sessionStorage.getItem("cheese_admin_role");
  </script>
  <script src="./admin-common.js" defer></script>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>
    
    <section class="admin-content">
      <div class="profile-card">
        <div class="profile-header">
          <h2>ë‚´ ì •ë³´ ì„¤ì •</h2>
          <p>ê³„ì • ë³´ì•ˆì„ ìœ„í•´ ì •ë³´ë¥¼ ê´€ë¦¬í•´ ì£¼ì„¸ìš”.</p>
          <div class="info-badge" id="role-badge">ë¡œë”© ì¤‘...</div>
        </div>
        
        <div class="form-group">
          <label>ì‚¬ìš©ì ì •ë³´</label>
          <input type="text" id="disp-info" class="styled-input" disabled>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

        <div class="form-group">
          <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="old-pw" class="styled-input" placeholder="í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¹„ë°€ë²ˆí˜¸">
        </div>

        <div class="form-group">
          <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="new-pw" class="styled-input" placeholder="ìµœì†Œ 4ìë¦¬ ì´ìƒ">
        </div>

        <div class="form-group">
          <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input type="password" id="confirm-pw" class="styled-input" placeholder="í•œ ë²ˆ ë” ì…ë ¥í•´ ì£¼ì„¸ìš”">
        </div>

        <button onclick="updatePassword()" class="btn-submit-profile">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì €ì¥</button>
      </div>
    </section>
  </main>
</div>

<script>
  // ì •ë³´ ì¶œë ¥
  if(currId) {
    document.getElementById('disp-info').value = `${currName} (${currId} / ${currEmpNo})`;
    document.getElementById('role-badge').textContent = `ê¶Œí•œ ë ˆë²¨: ${currRole}`;
  }

  async function updatePassword() {
    const oldPw = document.getElementById('old-pw').value;
    const newPw = document.getElementById('new-pw').value;
    const confirmPw = document.getElementById('confirm-pw').value;

    if(!oldPw || !newPw || !confirmPw) return alert("ë¹ˆì¹¸ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");
    if(newPw !== confirmPw) return alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    if(newPw.length < 4) return alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");

    if(!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë©´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const payload = {
      mode: 'changePassword', // ğŸš¨ ì„œë²„ì™€ ëŒ€ì†Œë¬¸ì ì¼ì¹˜ í™•ì¸ë¨
      loginId: currId,
      oldPassword: oldPw,
      newPassword: newPw
    };

  try {
      const res = await fetch(window.CHEESE_LOGIN_API, {
        method: 'POST',
        // ğŸš¨ ì¤‘ìš”: ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ OPTIONS ìš”ì²­(CORS)ì„ ë³´ë‚´ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ 
        // Content-Typeì„ 'text/plain'ìœ¼ë¡œ ì„¤ì •í•˜ê³  ë‚´ë¶€ëŠ” JSON ë¬¸ìì—´ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
        headers: {
          'Content-Type': 'text/plain;charset=utf-8'
        },
        body: JSON.stringify(payload)
      });
      
      const json = await res.json();

      if(json.ok) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì•ˆì „í•˜ê²Œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.");
        sessionStorage.clear();
        location.href = "../index.html";
      } else {
        // ğŸš¨ ì„œë²„ê°€ ë³´ë‚¸ êµ¬ì²´ì ì¸ ì‹¤íŒ¨ ì‚¬ìœ (detail)ë¥¼ ë„ì›Œ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ í•¨
        alert("ì‹¤íŒ¨: " + (json.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜") + (json.detail ? "\nìƒì„¸: " + json.detail : ""));
      }
    } catch(e) {
      alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }
</script>
</body>
</html>
