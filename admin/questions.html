<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>문제 관리 · Cheese Quiz Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 같은 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />
</head>
<body>
  <div class="admin-shell">
    <header class="admin-header">
      <div class="admin-logo">
        Cheese Quiz Admin
        <span>문제 관리</span>
      </div>
      <div class="admin-badge">
        questions
      </div>
    </header>

    <div class="admin-main">
      <!-- 좌측 네비 (간단 버전) -->
      <aside class="admin-nav">
        <div class="admin-nav-group-title">메뉴</div>
        <ul class="admin-nav-list">
          <li class="admin-nav-item">
            <a class="admin-nav-button" href="../index.html">
              <span class="icon">🏠</span>
              <span>대시보드</span>
            </a>
          </li>
          <li class="admin-nav-item">
            <button class="admin-nav-button active">
              <span class="icon">📚</span>
              <span>문제 관리</span>
            </button>
          </li>
        </ul>
      </aside>

      <main>
        <!-- 필터 + 목록 -->
        <section class="admin-section active" data-section="questions">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">문제 목록</div>
                <div class="card-subtitle">
                  questions 시트의 활성( active=1 ) 문제를 게시판처럼 조회
                </div>
              </div>
            </div>

            <!-- 필터 영역 -->
            <div class="field-row">
              <div class="field">
                <label for="q-period">시대 / 카테고리</label>
                <select id="q-period">
                  <option value="">전체</option>
                  <option value="한국사-통사">한국사 통사</option>
                  <option value="한국사-근현대">한국사 근현대</option>
                  <option value="일본사-통사">일본사 통사</option>
                </select>
              </div>
              <div class="field">
                <label for="q-topic">토픽</label>
                <input id="q-topic" type="text" placeholder="예: 시대순서" />
              </div>
              <div class="field">
                <label for="q-diff">난이도</label>
                <select id="q-diff">
                  <option value="">전체</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </div>
              <div class="field">
                <label for="q-search">검색어 (질문/해설/힌트)</label>
                <input id="q-search" type="text" placeholder="키워드 검색" />
              </div>
            </div>

            <!-- 목록 테이블 -->
            <div class="table-wrapper">
              <table class="admin-table" id="question-table">
                <thead>
                  <tr>
                    <th style="min-width:60px;">ID</th>
                    <th style="min-width:180px;">질문</th>
                    <th style="min-width:120px;">시대</th>
                    <th style="min-width:90px;">토픽</th>
                    <th style="min-width:70px;">난이도</th>
                    <th style="min-width:80px;">정답</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS에서 채움 -->
                </tbody>
              </table>
            </div>

            <!-- 페이지네이션 -->
            <div class="cheese-pagination" id="question-pagination">
              <!-- JS에서 채움 -->
            </div>
          </div>

          <!-- 상세 보기 카드(일단 안씀) -->
          <div class="card" id="question-detail-card" style="display:none;">
            <div class="card-header">
              <div>
                <div class="card-title">문제 상세</div>
                <div class="card-subtitle" id="detail-meta"></div>
              </div>
            </div>
            <div id="detail-body" class="small-help">
              <!-- JS에서 채움 -->
            </div>
          </div>
          
        </section>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---------- 0. 엘리먼트 모아두기 ----------
      const spanQId      = document.getElementById('detail-qid');
  
      const fId          = document.getElementById('q-id');
      const fPeriod      = document.getElementById('q-period');
      const fTopic       = document.getElementById('q-topic');
      const fDifficulty  = document.getElementById('q-difficulty');
      const fQuestion    = document.getElementById('q-question');
      const fChoice1     = document.getElementById('q-choice1');
      const fChoice2     = document.getElementById('q-choice2');
      const fChoice3     = document.getElementById('q-choice3');
      const fChoice4     = document.getElementById('q-choice4');
      const fAnswer      = document.getElementById('q-answer');
      const fActive      = document.getElementById('q-active');
      const fExplanation = document.getElementById('q-explanation');
      const fHint        = document.getElementById('q-hint');
  
      const btnBack   = document.getElementById('btn-back-list');
      const btnSave   = document.getElementById('btn-save');
      const btnReset  = document.getElementById('btn-reset');
      const msgEl     = document.getElementById('save-message');
  
      let originalData = null; // 되돌리기용 원본
  
      function showError(message) {
        if (!msgEl) return;
        msgEl.textContent = message;
        msgEl.classList.add('danger-text');
      }
  
      function clearMessage() {
        if (!msgEl) return;
        msgEl.textContent = '';
        msgEl.classList.remove('danger-text');
      }
  
      // ---------- 1. 세션에서 데이터 꺼내기 ----------
      let raw = null;
      try {
        raw = sessionStorage.getItem('cheese_admin_question_detail');
      } catch (e) {
        console.error(e);
      }
  
      if (!raw) {
        showError('목록 화면에서 문제를 선택한 뒤 들어와 주세요. (저장된 데이터가 없습니다)');
        return;
      }
  
      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        console.error(e);
        showError('저장된 문제 정보를 해석할 수 없습니다.');
        return;
      }
  
      originalData = data;
  
      // ---------- 2. 폼에 값 채우기 ----------
      function fillForm(q) {
        if (!q) return;
  
        if (spanQId)      spanQId.textContent      = q.id || '-';
        if (fId)          fId.value                = q.id || '';
        if (fPeriod)      fPeriod.value            = q.period || '';
        if (fTopic)       fTopic.value             = q.topic || '';
        if (fDifficulty)  fDifficulty.value        = q.difficulty || '';
        if (fQuestion)    fQuestion.value          = q.question || '';
        if (fChoice1)     fChoice1.value           = q.choice1 || '';
        if (fChoice2)     fChoice2.value           = q.choice2 || '';
        if (fChoice3)     fChoice3.value           = q.choice3 || '';
        if (fChoice4)     fChoice4.value           = q.choice4 || '';
        if (fAnswer)      fAnswer.value            = q.answer || '';
        if (fActive)      fActive.value            = q.active || '';
        if (fExplanation) fExplanation.value       = q.explanation || '';
        if (fHint)        fHint.value              = q.hint || '';
      }
  
      function collectForm() {
        return {
          id:          fId?.value.trim()          ?? '',
          period:      fPeriod?.value.trim()      ?? '',
          topic:       fTopic?.value.trim()       ?? '',
          difficulty:  fDifficulty?.value.trim()  ?? '',
          question:    fQuestion?.value.trim()    ?? '',
          choice1:     fChoice1?.value.trim()     ?? '',
          choice2:     fChoice2?.value.trim()     ?? '',
          choice3:     fChoice3?.value.trim()     ?? '',
          choice4:     fChoice4?.value.trim()     ?? '',
          answer:      fAnswer?.value.trim()      ?? '',
          active:      fActive?.value.trim()      ?? '',
          explanation: fExplanation?.value.trim() ?? '',
          hint:        fHint?.value.trim()        ?? '',
        };
      }
  
      fillForm(data);
      clearMessage();
      if (msgEl) {
        msgEl.textContent = '불러오기 완료. 수정 후 [수정 내용 저장] 버튼을 눌러주세요.';
      }
  
      // ---------- 3. 버튼 이벤트 ----------
  
      // 목록으로 돌아가기
      if (btnBack) {
        btnBack.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = './questions.html';
        });
      }
  
      // 원래 값으로 되돌리기
      if (btnReset) {
        btnReset.addEventListener('click', (e) => {
          e.preventDefault();
          fillForm(originalData);
          clearMessage();
          if (msgEl) {
            msgEl.textContent = '불러온 원래 값으로 되돌렸습니다.';
          }
        });
      }
  
      // 저장 버튼 (지금은 프론트엔드 테스트용)
      if (btnSave) {
        btnSave.addEventListener('click', async (e) => {
          e.preventDefault();
          clearMessage();
  
          const payload = collectForm();
          if (!payload.id) {
            showError('ID가 없습니다. 저장할 수 없습니다.');
            return;
          }
  
          // 지금은 실제 Apps Script와 연동 전이라, 콘솔에만 찍고 안내만 띄움
          console.log('[question-detail] 저장 요청 payload', payload);
  
          if (msgEl) {
            msgEl.textContent =
              '지금은 화면에서만 수정됩니다. 나중에 Apps Script와 연동하면 이 버튼에서 실제 저장을 호출하면 됩니다.';
          }
  
          // 나중에 연동할 때는 여기서 fetch로 POST 호출만 추가하면 됨.
          // const base = window.CHEESE_ADMIN_API_BASE;
          // await fetch(base + '?mode=updateQuestion', { ... });
        });
      }
    });
  </script>
