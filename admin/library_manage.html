<!-- post_manage.html 내의 핵심 수정 사항만 반영된 조립 엔진 로직입니다. -->
<script>
/** * 검색 키워드: async function assembleHtmlFromManifest_
 * 설명: IMG_SLOT 설정을 확인하여 {{IMG_SRC}} -> {{IMG_1_SRC}} 형태로 값을 매핑합니다.
 */
async function assembleHtmlFromManifest_(manifest, templateId, vars) {
  const tid = String(manifest?.id || templateId).trim();
  const sections = Array.isArray(manifest?.sections) ? manifest.sections : [];
  const parts = [];

  for (const sec of sections) {
    const secName = (typeof sec === "string") ? sec : sec.name;
    let secHtml = await getSectionHtml_(secName);
    const secVars = sec.vars || {};

    // 1. BODY 슬롯 처리 (기존 로직)
    const slotName = secVars.SLOT ? String(secVars.SLOT).trim() : "";
    if (slotName) {
      const slotVal = vars[slotName] || "";
      secHtml = secHtml.replace(/{{\s*BODY\s*}}/g, slotVal);
      secHtml = secHtml.replace(/<!--\s*BODY_START\s*-->/gi, `<!-- BODY_START:${slotName} -->`);
      secHtml = secHtml.replace(/<!--\s*BODY_END\s*-->/gi, `<!-- BODY_END:${slotName} -->`);
    }

    // 2. IMG 슬롯 처리 (추가된 로직)
    const imgSlot = secVars.IMG_SLOT ? String(secVars.IMG_SLOT).trim() : "";
    if (imgSlot) {
      // IMG_1 -> IMG_1_SRC, IMG_1_HREF 등 매핑
      const imgTokens = ["ID", "SRC", "HREF", "OW", "OH", "ALT", "TITLE", "SNIPPET"];
      imgTokens.forEach(t => {
        const sourceKey = `${imgSlot}_${t}`; // 예: IMG_1_SRC
        const val = vars[sourceKey] || "";
        const re = new RegExp(`{{\\s*IMG_${t}\\s*}}`, "g");
        secHtml = secHtml.replace(re, val);
      });
      // THUMB_URL도 IMG_SLOT_SRC와 동일하게 처리
      if (vars[`${imgSlot}_SRC`]) {
        secHtml = secHtml.replace(/{{\s*THUMB_URL\s*}}/g, vars[`${imgSlot}_SRC`]);
      }
    }

    // 일반 토큰 치환
    secHtml = replaceTokens_(secHtml, { ...vars, ...secVars });
    parts.push(secHtml);
  }

  return { html: parts.join("\n"), manifest };
}

/** * 검색 키워드: async function collectTokensFromTemplate_
 * 설명: IMG_SLOT이 정의된 경우 IMG_1_SRC 등 번호가 붙은 입력칸을 자동 생성 목록에 넣습니다.
 */
async function collectTokensFromTemplate_(manifest, slotNames) {
  const found = new Set();
  const sections = manifest.sections || [];
  
  for (const sec of sections) {
    const secVars = sec.vars || {};
    // IMG_SLOT (예: IMG_1)이 있으면 해당 번호의 모든 이미지 토큰을 입력 필드로 생성
    if (secVars.IMG_SLOT) {
      const p = secVars.IMG_SLOT + "_";
      ["ID", "SRC", "HREF", "OW", "OH", "ALT", "TITLE", "SNIPPET"].forEach(t => {
        found.add(p + t);
      });
    }
    
    // 기존 HTML 토큰 스캔 로직 (유지)
    const html = await getSectionHtml_(sec.name);
    const re = /{{\s*([A-Z0-9_]+)\s*}}/g;
    let m;
    while ((m = re.exec(html)) !== null) {
      found.add(m[1]);
    }
  }
  return Array.from(found);
}
</script>
