<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Manage</title>

  <!-- 네 관리자 공통 CSS 있으면 유지 -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    .lm-wrap{ padding:14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .tab-btn.active{ outline:2px solid rgba(59,130,246,.35); }

    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input, .select, .textarea{
      border:1px solid rgba(15,23,42,.16);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
    }
    .input{ min-width:220px; }
    .textarea{ width:100%; min-height:240px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .btn{
      border:1px solid rgba(15,23,42,.14);
      background:#0f172a;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.secondary{ background:#fff; color:#0f172a; }
    .btn.danger{ background:#b91c1c; }
    .muted{ color:rgba(15,23,42,.65); font-size:13px; }
    .hr{ height:1px; background:rgba(15,23,42,.10); margin:12px 0; }

    /* builder layout */
    .builder-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .builder-grid{ grid-template-columns: 1fr; }
    }
    .list{
      border:1px solid rgba(15,23,42,.12);
      border-radius:12px;
      padding:10px;
      max-height:420px;
      overflow:auto;
      background:rgba(2,6,23,.02);
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      margin-bottom:8px;
    }
    .item .name{ font-weight:900; }
    .item .meta{ font-size:12px; color:rgba(15,23,42,.65); }
    .mini-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .vars-area{ width:100%; min-height:110px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(15,23,42,.14); font-size:12px; }
    .ok{ color:#065f46; }
    .err{ color:#b91c1c; }
  </style>
</head>

<body>
  <div class="lm-wrap">

    <div class="tabs">
      <button class="tab-btn active" data-tab="builder">템플릿 빌더</button>
      <button class="tab-btn" data-tab="sections">섹션 관리</button>
      <button class="tab-btn" data-tab="templates">템플릿 보기</button>
    </div>

    <!-- ============ Builder ============ -->
    <section id="tab-builder">
      <div class="card">
        <div class="row">
          <label style="font-weight:900;">API URL</label>
          <input id="apiUrl" class="input" style="min-width:520px" />
          <span class="muted">배포 /exec 주소</span>
        </div>
        <div class="row" style="margin-top:10px;">
          <label style="font-weight:900;">템플릿 ID</label>
          <input id="tplId" class="input" placeholder="예: news_year_nav_v1" />
          <label style="font-weight:900;">템플릿 이름</label>
          <input id="tplName" class="input" placeholder="예: 뉴스 연도네비 + CSS" />
          <button class="btn" id="btnSaveTemplate">템플릿 저장</button>
          <button class="btn secondary" id="btnPreviewJson">JSON 미리보기</button>
        </div>
        <p class="muted" style="margin-top:10px;">
          왼쪽 섹션 목록에서 “추가”를 누르면 오른쪽(선택 영역)에 들어갑니다. 오른쪽에서 ↑↓로 순서를 바꾸고 저장하면 템플릿(JSON)이 Drive에 저장됩니다.
        </p>
      </div>

      <div class="builder-grid">
        <!-- Available -->
        <div class="card">
          <div class="row">
            <div style="font-weight:900;">섹션 목록(Drive)</div>
            <span class="pill" id="secCount">0</span>
            <div style="flex:1"></div>
            <input id="secSearch" class="input" placeholder="섹션 검색 (.html)" />
            <button class="btn secondary" id="btnReloadSections">새로고침</button>
          </div>
          <div class="hr"></div>
          <div class="list" id="secList"></div>
        </div>

        <!-- Selected -->
        <div class="card">
          <div class="row">
            <div style="font-weight:900;">템플릿에 포함될 섹션(순서)</div>
            <span class="pill" id="selCount">0</span>
            <div style="flex:1"></div>
            <button class="btn danger" id="btnClearSelected">전체 비우기</button>
          </div>
          <div class="hr"></div>
          <div class="list" id="selectedList"></div>
          <p class="muted" style="margin-top:10px;">
            (옵션) 섹션별 vars는 JSON으로 입력합니다. 예: {"CURRENT_YEAR":"2022","LINKS":[...]}<br/>
            vars를 안 쓰는 섹션(예: css link)은 비워두면 됩니다.
          </p>
        </div>
      </div>

      <div class="card" id="jsonPreviewCard" style="display:none;">
        <div class="row">
          <div style="font-weight:900;">JSON 미리보기</div>
          <span id="jsonStatus" class="pill"></span>
          <div style="flex:1"></div>
          <button class="btn secondary" id="btnHidePreview">닫기</button>
        </div>
        <div class="hr"></div>
        <textarea id="jsonPreview" class="textarea" readonly></textarea>
      </div>
    </section>

    <!-- ============ Sections ============ -->
    <section id="tab-sections" style="display:none;">
      <div class="card">
        <div class="row">
          <div style="font-weight:900;">섹션 생성/편집</div>
          <div style="flex:1"></div>
          <button class="btn secondary" id="btnSecLoadList">섹션 목록 불러오기</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <label style="font-weight:900;">파일명</label>
          <input id="secName" class="input" placeholder="예: year_nav.html" />
          <button class="btn secondary" id="btnSecLoad">불러오기</button>
          <button class="btn" id="btnSecSave">저장</button>
          <span class="muted" id="secMsg"></span>
        </div>
        <div style="margin-top:10px;">
          <textarea id="secHtml" class="textarea" placeholder="섹션 HTML을 입력"></textarea>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div style="font-weight:900;">섹션 목록</div>
          <span class="pill" id="secListCount2">0</span>
          <div style="flex:1"></div>
        </div>
        <div class="hr"></div>
        <div class="list" id="secList2"></div>
      </div>
    </section>

    <!-- ============ Templates ============ -->
    <section id="tab-templates" style="display:none;">
      <div class="card">
        <div class="row">
          <div style="font-weight:900;">템플릿 목록</div>
          <div style="flex:1"></div>
          <button class="btn secondary" id="btnTplReload">새로고침</button>
        </div>
        <div class="hr"></div>
        <div class="list" id="tplList"></div>
      </div>

      <div class="card">
        <div class="row">
          <div style="font-weight:900;">템플릿 JSON 보기</div>
          <div style="flex:1"></div>
          <span class="muted" id="tplMsg"></span>
        </div>
        <div class="hr"></div>
        <textarea id="tplJson" class="textarea" readonly></textarea>
      </div>
    </section>

  </div>

<script>
/** =========================
 * 설정
 * - 여기를 네 배포 URL로 세팅
 * ========================= */
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzj5LUEUKMyQqJfVsVlftO1f4CTYb3NhAQMT2QL6VADBlnjleAXLtBVVhuVHOfwkhQYqQ/exec";

const $ = (id)=>document.getElementById(id);

function setMsg(el, text, isErr=false){
  el.textContent = text || "";
  el.className = "muted " + (isErr ? "err" : "ok");
}

/** =========================
 * fetch helpers (405 회피)
 * - GET: list/get
 * - POST: upsert 저장
 * ========================= */
async function apiGet(mode, params={}){
  const base = $("apiUrl").value.trim();
  const url = new URL(base);
  url.searchParams.set("mode", mode);
  Object.keys(params).forEach(k=> url.searchParams.set(k, params[k]));
  const res = await fetch(url.toString(), { method:"GET" });
  return res.json();
}

async function apiPost(mode, data={}){
  const base = $("apiUrl").value.trim();
  const body = new URLSearchParams();
  body.set("mode", mode);
  Object.keys(data).forEach(k=>{
    if (data[k] === undefined || data[k] === null) return;
    body.set(k, typeof data[k] === "string" ? data[k] : String(data[k]));
  });
  const res = await fetch(base, {
    method:"POST",
    headers: { "Content-Type":"application/x-www-form-urlencoded; charset=UTF-8" },
    body
  });
  return res.json();
}

/** =========================
 * 탭
 * ========================= */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    $("tab-builder").style.display  = tab==="builder" ? "" : "none";
    $("tab-sections").style.display = tab==="sections" ? "" : "none";
    $("tab-templates").style.display= tab==="templates" ? "" : "none";
  });
});

/** =========================
 * Builder state
 * ========================= */
let ALL_SECTIONS = []; // [{name,file_id,url}]
let SELECTED = [];     // [{name, varsText:""}]

function renderSectionList(){
  const q = $("secSearch").value.trim().toLowerCase();
  const list = $("secList");
  list.innerHTML = "";
  const items = ALL_SECTIONS.filter(x => !q || x.name.toLowerCase().includes(q));
  $("secCount").textContent = String(items.length);

  items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(it.name)}</div>
        <div class="meta">${escapeHtml(it.url || "")}</div>
      </div>
      <div class="row" style="gap:6px;">
        <button class="mini-btn" data-act="add">추가</button>
      </div>
    `;
    row.querySelector('[data-act="add"]').addEventListener("click", ()=>{
      SELECTED.push({ name: it.name, varsText: "" });
      renderSelected();
    });
    list.appendChild(row);
  });
}

function renderSelected(){
  const list = $("selectedList");
  list.innerHTML = "";
  $("selCount").textContent = String(SELECTED.length);

  SELECTED.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div class="row" style="justify-content:space-between;">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="row" style="gap:6px;">
            <button class="mini-btn" data-act="up">↑</button>
            <button class="mini-btn" data-act="down">↓</button>
            <button class="mini-btn" data-act="remove">제거</button>
          </div>
        </div>
        <div class="meta" style="margin-top:6px;">vars (옵션, JSON)</div>
        <textarea class="vars-area input" placeholder='예: {"CURRENT_YEAR":"2022","LINKS":[{"label":"2023","url":"..."}]}'></textarea>
      </div>
    `;
    const ta = row.querySelector("textarea");
    ta.value = it.varsText || "";
    ta.addEventListener("input", ()=>{ SELECTED[idx].varsText = ta.value; });

    row.querySelector('[data-act="up"]').addEventListener("click", ()=>{
      if (idx<=0) return;
      const tmp = SELECTED[idx-1]; SELECTED[idx-1]=SELECTED[idx]; SELECTED[idx]=tmp;
      renderSelected();
    });
    row.querySelector('[data-act="down"]').addEventListener("click", ()=>{
      if (idx>=SELECTED.length-1) return;
      const tmp = SELECTED[idx+1]; SELECTED[idx+1]=SELECTED[idx]; SELECTED[idx]=tmp;
      renderSelected();
    });
    row.querySelector('[data-act="remove"]').addEventListener("click", ()=>{
      SELECTED.splice(idx,1);
      renderSelected();
    });

    list.appendChild(row);
  });
}

function buildTemplateJson(){
  const id = $("tplId").value.trim();
  const name = $("tplName").value.trim();
  if (!id) throw new Error("템플릿 ID가 없습니다.");

  const sections = SELECTED.map(s=>{
    const obj = { name: s.name };
    const t = (s.varsText || "").trim();
    if (t){
      // vars는 JSON이어야 함
      obj.vars = JSON.parse(t);
    }
    return obj;
  });

  return {
    id,
    name: name || id,
    sections
  };
}

/** =========================
 * Builder actions
 * ========================= */
async function reloadSections(){
  const res = await apiGet("listSections");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listSections 실패");
  ALL_SECTIONS = res.items || [];
  renderSectionList();
}

$("btnReloadSections").addEventListener("click", async ()=>{
  try{ await reloadSections(); }catch(e){ alert(String(e.message||e)); }
});
$("secSearch").addEventListener("input", renderSectionList);

$("btnClearSelected").addEventListener("click", ()=>{
  SELECTED = [];
  renderSelected();
});

$("btnPreviewJson").addEventListener("click", ()=>{
  $("jsonPreviewCard").style.display = "";
  try{
    const obj = buildTemplateJson();
    $("jsonPreview").value = JSON.stringify(obj, null, 2);
    $("jsonStatus").textContent = "OK";
    $("jsonStatus").className = "pill ok";
  }catch(e){
    $("jsonPreview").value = String(e.message||e);
    $("jsonStatus").textContent = "ERROR";
    $("jsonStatus").className = "pill err";
  }
});

$("btnHidePreview").addEventListener("click", ()=>{
  $("jsonPreviewCard").style.display = "none";
});

$("btnSaveTemplate").addEventListener("click", async ()=>{
  try{
    const obj = buildTemplateJson();
    const jsonStr = JSON.stringify(obj, null, 2);

    // 서버로 저장
    const res = await apiPost("templateUpsert", {
      template_id: obj.id,
      name: obj.name,
      json: jsonStr
    });

    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "templateUpsert 실패");
    alert("템플릿 저장 완료: " + (res.file && res.file.name ? res.file.name : obj.id + ".json"));
  }catch(e){
    alert("저장 실패: " + String(e.message||e));
  }
});

/** =========================
 * Sections tab actions
 * ========================= */
$("btnSecSave").addEventListener("click", async ()=>{
  try{
    const name = $("secName").value.trim();
    const html = $("secHtml").value;
    if (!name) return setMsg($("secMsg"), "파일명을 입력하세요", true);
    if (!html.trim()) return setMsg($("secMsg"), "HTML이 비어있습니다", true);

    setMsg($("secMsg"), "저장 중...");
    const res = await apiPost("sectionUpsert", { name, html });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "sectionUpsert 실패");
    setMsg($("secMsg"), "저장 완료: " + (res.file && res.file.name ? res.file.name : name));
    await loadSectionsList2();
    await reloadSections(); // builder 목록도 갱신
  }catch(e){
    setMsg($("secMsg"), "저장 실패: " + String(e.message||e), true);
  }
});

$("btnSecLoad").addEventListener("click", async ()=>{
  try{
    const name = $("secName").value.trim();
    if (!name) return setMsg($("secMsg"), "파일명을 입력하세요", true);

    setMsg($("secMsg"), "불러오는 중...");
    const res = await apiGet("getSection", { name });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "getSection 실패");
    $("secHtml").value = res.html || "";
    setMsg($("secMsg"), "불러오기 완료");
  }catch(e){
    setMsg($("secMsg"), "불러오기 실패: " + String(e.message||e), true);
  }
});

async function loadSectionsList2(){
  const res = await apiGet("listSections");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listSections 실패");

  const list = $("secList2");
  list.innerHTML = "";
  $("secListCount2").textContent = String((res.items||[]).length);

  (res.items||[]).forEach(it=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(it.name)}</div>
        <div class="meta">${escapeHtml(it.url || "")}</div>
      </div>
      <div class="row" style="gap:6px;">
        <button class="mini-btn" data-act="edit">편집</button>
      </div>
    `;
    row.querySelector('[data-act="edit"]').addEventListener("click", async ()=>{
      $("secName").value = it.name;
      document.querySelector('.tab-btn[data-tab="sections"]').click();
      await $("btnSecLoad").click();
    });
    list.appendChild(row);
  });
}

$("btnSecLoadList").addEventListener("click", async ()=>{
  try{ await loadSectionsList2(); }catch(e){ alert(String(e.message||e)); }
});

/** =========================
 * Templates tab actions
 * ========================= */
async function loadTemplates(){
  const res = await apiGet("listTemplates");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listTemplates 실패");

  const list = $("tplList");
  list.innerHTML = "";
  (res.items||[]).forEach(it=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(it.id)}</div>
        <div class="meta">${escapeHtml(it.name || it.url || "")}</div>
      </div>
      <div class="row" style="gap:6px;">
        <button class="mini-btn" data-act="open">열기</button>
      </div>
    `;
    row.querySelector('[data-act="open"]').addEventListener("click", async ()=>{
      try{
        $("tplMsg").textContent = "불러오는 중...";
        const r = await apiGet("getTemplate", { template_id: it.id });
        if (!r || !r.ok) throw new Error(r && r.message ? r.message : "getTemplate 실패");
        $("tplJson").value = r.json || "";
        $("tplMsg").textContent = "OK";
      }catch(e){
        $("tplMsg").textContent = "ERROR: " + String(e.message||e);
      }
    });
    list.appendChild(row);
  });
}

$("btnTplReload").addEventListener("click", async ()=>{
  try{ await loadTemplates(); }catch(e){ alert(String(e.message||e)); }
});

/** =========================
 * utils
 * ========================= */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/** =========================
 * init
 * ========================= */
(function init(){
  $("apiUrl").value = DEFAULT_API_URL;
  renderSelected();
  reloadSections().catch(()=>{});
  loadSectionsList2().catch(()=>{});
  loadTemplates().catch(()=>{});
})();
</script>
</body>
</html>
