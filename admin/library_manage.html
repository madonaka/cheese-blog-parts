<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Manage</title>
  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js"></script>
  <style>
    .lm-wrap{ padding:14px; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab-btn{ border:1px solid rgba(15,23,42,.14); background:#fff; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800; }
    .tab-btn.active{ outline:2px solid rgba(59,130,246,.35); }
    .card{ background:#fff; border:1px solid rgba(15,23,42,0.14); border-radius:14px; padding:14px; box-shadow:0 10px 24px rgba(15,23,42,0.06); margin-bottom:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input, .select, .textarea{ border:1px solid rgba(15,23,42,0.16); border-radius:12px; padding:10px 12px; background:#fff; min-height:42px; outline:none; }
    .textarea{ width:100%; min-height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .btn{ border:1px solid rgba(15,23,42,0.14); background:#0f172a; color:#fff; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800; }
    .btn.secondary{ background:#fff; color:#0f172a; }
    .mini-btn{ border:1px solid rgba(15,23,42,0.14); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:800; }
    .muted{ color:rgba(15,23,42,0.65); font-size:13px; }
    .hr{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }
    .pill{ font-size:12px; background:rgba(15,23,42,0.06); border:1px solid rgba(15,23,42,0.10); border-radius:999px; padding:4px 10px; font-weight:800; }
    .builder-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .builder-grid{ grid-template-columns: 1fr; } }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{ border:1px solid rgba(15,23,42,0.14); border-radius:14px; padding:10px 12px; display:flex; align-items:center; gap:10px; box-shadow:0 10px 24px rgba(15,23,42,0.04); background:#fff; }
    .item .name{ font-weight:900; }
    .item .meta{ font-size:12px; color:rgba(15,23,42,0.65); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }
    .tpl-card{ cursor:grab; }
    .tpl-card.dragging{ opacity:.45; }
    .tpl-drop{ outline:2px dashed rgba(59,130,246,.35); }
  </style>
</head>
<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      <main class="admin-content">
        <div class="lm-wrap">
          <div class="tabs">
            <button class="tab-btn active" data-tab="builder">템플릿 빌더</button>
            <button class="tab-btn" data-tab="sections">섹션 관리</button>
            <button class="tab-btn" data-tab="templates">템플릿 보기</button>
          </div>
          <section id="tab-builder">
            <div class="card">
              <div class="row">
                <label style="font-weight:900;">API URL</label>
                <input id="apiUrl" class="input" style="min-width:520px" />
              </div>
              <div class="row" style="margin-top:10px;">
                <label style="font-weight:900;">템플릿 ID</label>
                <input id="tplId" class="input" placeholder="id_v1" />
                <label style="font-weight:900;">템플릿 이름</label>
                <input id="tplName" class="input" placeholder="이름" />
                <button class="btn secondary" id="btnAutoImgSlots">IMG 슬롯 자동지정</button>
                <button class="btn secondary" id="btnAutoBodySlots">BODY 슬롯 자동지정</button>
                <button class="btn" id="btnSaveTemplate">템플릿 저장</button>
                <button class="btn secondary" id="btnPreviewJson">JSON 미리보기</button>
              </div>
            </div>
            <div class="builder-grid">
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">섹션 목록(Drive)</div>
                  <span class="pill" id="secCount">0</span>
                  <input id="secSearch" class="input" placeholder="섹션 검색" />
                  <button class="btn secondary" id="btnReloadSections">새로고침</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="secList"></div>
              </div>
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">선택된 섹션</div>
                  <span class="pill" id="selCount">0</span>
                  <button class="btn secondary" id="btnClearSel">비우기</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="selList"></div>
              </div>
            </div>
            <div class="card">
              <div class="row">
                <div style="font-weight:900;">JSON 미리보기</div>
                <span class="muted" id="jsonMsg"></span>
              </div>
              <textarea id="jsonPreview" class="textarea" readonly></textarea>
            </div>
          </section>
          <!-- Sections, Templates 섹션은 기존 코드 유지 (생략) -->
          <section id="tab-sections" style="display:none;"></section>
          <section id="tab-templates" style="display:none;"></section>
        </div>
      </main>
    </div>
  </div>

<script>
// (AdminCommon 초기화 로직 생략)
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwXqz1uMy3EOrisCEKIe0Fk7yu0P6MQ1ddHDvo7Sr_CPEYY0RHP2GyUBL8YhaBqxnmBJg/exec";
const $ = (id)=>document.getElementById(id);
let ALL_SECTIONS = [];
let SELECTED = [];
const BODY_SECTION_CACHE = new Map();
const IMG_SECTION_CACHE = new Map();

function apiUrl(){ return ($("apiUrl")?.value || "").trim() || DEFAULT_API_URL; }
async function apiGet(mode, params={}){
  const url = new URL(apiUrl());
  url.searchParams.set("mode", mode);
  url.searchParams.set("_ts", String(Date.now()));
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k, String(v)));
  const r = await fetch(url.toString());
  return await r.json();
}
async function apiPost(mode, bodyObj){
  const url = new URL(apiUrl());
  const body = new URLSearchParams();
  body.set("mode", String(mode || ""));
  Object.entries(bodyObj).forEach(([k,v])=> body.set(k, String(v)));
  const r = await fetch(url.toString(), { method:"POST", body });
  return await r.json();
}

/** 슬롯 자동화 핵심 로직 */
function findMaxSlotNumber_(keyPrefix){
  let maxN = 0;
  for (const s of SELECTED){
    try{
      const v = JSON.parse(s.varsText || "{}");
      const slot = String(v?.SLOT || v?.IMG_SLOT || "").trim();
      const m = slot.match(new RegExp(`^${keyPrefix}_(\\d+)$`, 'i'));
      if (m) maxN = Math.max(maxN, parseInt(m[1], 10));
    }catch(_){}
  }
  return maxN;
}

function isImageSectionName_(name){
  const n = String(name || "").toLowerCase();
  return n.includes("img") || n.includes("image") || n.includes("cheese_img");
}

async function isBodySection_(name){
  if (BODY_SECTION_CACHE.has(name)) return BODY_SECTION_CACHE.get(name);
  const r = await apiGet("getSection", { name });
  const yes = String(r?.html || "").includes("{{BODY}}");
  BODY_SECTION_CACHE.set(name, yes);
  return yes;
}

async function isImgTokenSection_(name){
  if (IMG_SECTION_CACHE.has(name)) return IMG_SECTION_CACHE.get(name);
  const r = await apiGet("getSection", { name });
  const yes = /{{\s*(IMG_[A-Z0-9_]+|THUMB_URL)\s*}}/i.test(String(r?.html || ""));
  IMG_SECTION_CACHE.set(name, yes);
  return yes;
}

/** 버튼 액션 */
async function autoAssignBodySlots_(){
  let n = findMaxSlotNumber_("BODY");
  for (let i=0; i<SELECTED.length; i++){
    const item = SELECTED[i];
    try { if (JSON.parse(item.varsText || "{}").SLOT) continue; } catch(_){}
    if (await isBodySection_(item.name)){
      n++;
      const v = JSON.parse(item.varsText || "{}");
      v.SLOT = `BODY_${n}`;
      item.varsText = JSON.stringify(v, null, 2);
    }
  }
  renderSelected();
  updateJsonPreview();
}

async function autoAssignImgSlots_(){
  let n = findMaxSlotNumber_("IMG");
  for (let i=0; i<SELECTED.length; i++){
    const item = SELECTED[i];
    try { if (JSON.parse(item.varsText || "{}").IMG_SLOT) continue; } catch(_){}
    if (await isImgTokenSection_(item.name) || isImageSectionName_(item.name)){
      n++;
      const v = JSON.parse(item.varsText || "{}");
      v.IMG_SLOT = `IMG_${n}`;
      item.varsText = JSON.stringify(v, null, 2);
    }
  }
  renderSelected();
  updateJsonPreview();
}

function renderSelected(){
  const list = $("selList");
  list.innerHTML = "";
  SELECTED.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;"><div class="name">${s.name}</div></div>
      <div style="flex:1"></div>
      <button class="mini-btn" data-act="slot">SLOT</button>
      <button class="mini-btn" data-act="vars">vars</button>
      <button class="mini-btn" data-act="rm">제거</button>
    `;
    row.querySelector('[data-act="slot"]').addEventListener("click", async ()=>{
      if (isImageSectionName_(s.name) || await isImgTokenSection_(s.name)){
        const n = findMaxSlotNumber_("IMG") + 1;
        const v = JSON.parse(s.varsText || "{}"); v.IMG_SLOT = `IMG_${n}`;
        s.varsText = JSON.stringify(v, null, 2);
      } else {
        const n = findMaxSlotNumber_("BODY") + 1;
        const v = JSON.parse(s.varsText || "{}"); v.SLOT = `BODY_${n}`;
        s.varsText = JSON.stringify(v, null, 2);
      }
      renderSelected(); updateJsonPreview();
    });
    row.querySelector('[data-act="vars"]').addEventListener("click", ()=>{
      const v = prompt("JSON vars", s.varsText);
      if (v !== null) { s.varsText = v; renderSelected(); updateJsonPreview(); }
    });
    row.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
      SELECTED.splice(idx,1); renderSelected(); updateJsonPreview();
    });
    list.appendChild(row);
  });
  $("selCount").textContent = SELECTED.length;
}

function updateJsonPreview(){
  const sections = SELECTED.map(s=>({ name: s.name, vars: JSON.parse(s.varsText || "{}") }));
  $("jsonPreview").value = JSON.stringify({ id: $("tplId").value, name: $("tplName").value, sections }, null, 2);
}

// 이벤트 초기화
$("btnAutoBodySlots").onclick = autoAssignBodySlots_;
$("btnAutoImgSlots").onclick = autoAssignImgSlots_;
// (기타 탭 전환 및 데이터 로드 함수는 기존 파일과 동일하게 유지)
</script>
</body>
</html>
