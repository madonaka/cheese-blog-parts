<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Manage</title>

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />
  <!-- ✅ 기존 방식 유지: 헤더/메뉴 슬롯 렌더 -->
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap{ padding:14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .tab-btn.active{ outline:2px solid rgba(59,130,246,.35); }

    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input, .select, .textarea{
      border:1px solid rgba(15,23,42,0.16);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      min-height:42px;
      outline:none;
    }
    .textarea{ width:100%; min-height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#0f172a;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.secondary{ background:#fff; color:#0f172a; }
    .mini-btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    .muted{ color:rgba(15,23,42,0.65); font-size:13px; }
    .hr{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }
    .pill{
      font-size:12px;
      background:rgba(15,23,42,0.06);
      border:1px solid rgba(15,23,42,0.10);
      border-radius:999px;
      padding:4px 10px;
      font-weight:800;
    }

    .builder-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .builder-grid{ grid-template-columns: 1fr; } }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 10px 24px rgba(15,23,42,0.04);
      background:#fff;
    }
    .item .name{ font-weight:900; }
    .item .meta{ font-size:12px; color:rgba(15,23,42,0.65); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }

    /* template editor drag */
    .tpl-card{ cursor:grab; }
    .tpl-card.dragging{ opacity:.45; }
    .tpl-drop{ outline:2px dashed rgba(59,130,246,.35); }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="lm-wrap">

          <div class="tabs">
            <button class="tab-btn active" data-tab="builder">템플릿 빌더</button>
            <button class="tab-btn" data-tab="sections">섹션 관리</button>
            <button class="tab-btn" data-tab="templates">템플릿 보기</button>
          </div>

          <!-- ============ Builder ============ -->
          <section id="tab-builder">
            <div class="card">
              <div class="row">
                <label style="font-weight:900;">API URL</label>
                <input id="apiUrl" class="input" style="min-width:520px" />
                <span class="muted">배포 /exec 주소</span>
              </div>

              <div class="row" style="margin-top:10px;">
                <label style="font-weight:900;">템플릿 ID</label>
                <input id="tplId" class="input" placeholder="예: news_year_nav_v1" />
                <label style="font-weight:900;">템플릿 이름</label>
                <input id="tplName" class="input" placeholder="예: 뉴스 연도네비 + CSS" />

                <!-- ✅ 추가: BODY 슬롯 자동 지정 -->
                <button class="btn secondary" id="btnAutoBodySlots">BODY 슬롯 자동지정</button>

                <button class="btn" id="btnSaveTemplate">템플릿 저장</button>
                <button class="btn secondary" id="btnPreviewJson">JSON 미리보기</button>
              </div>

              <p class="muted" style="margin-top:10px; white-space:pre-line;">
                왼쪽 섹션 목록에서 “추가”를 누르면 오른쪽(선택 영역)에 들어갑니다.
                같은 섹션(예: 본문2.html)을 여러 번 넣는 경우, 각 항목에 vars.SLOT을 반드시 다르게 지정해야 post_manage에서 BODY_1/2/3/4 입력칸이 분리됩니다.

                ✅ 빠른 방법
                - 선택 카드의 “SLOT” 버튼: 해당 항목에 {"SLOT":"BODY_N"} 자동 부여
                - 상단 “BODY 슬롯 자동지정”: 선택 목록에서 {{BODY}}를 포함한 섹션들을 찾아 BODY_1.. 순서대로 자동 부여
              </p>
            </div>

            <div class="builder-grid">
              <!-- Available -->
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">섹션 목록(Drive)</div>
                  <span class="pill" id="secCount">0</span>
                  <div style="flex:1"></div>
                  <input id="secSearch" class="input" placeholder="섹션 검색 (.html)" />
                  <button class="btn secondary" id="btnReloadSections">새로고침</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="secList"></div>
              </div>

              <!-- Selected -->
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">선택된 섹션(템플릿 구성)</div>
                  <span class="pill" id="selCount">0</span>
                  <div style="flex:1"></div>
                  <button class="btn secondary" id="btnClearSel">비우기</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="selList"></div>
              </div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">JSON 미리보기</div>
                <div style="flex:1"></div>
                <span class="muted" id="jsonMsg"></span>
              </div>
              <div class="hr"></div>
              <textarea id="jsonPreview" class="textarea" readonly></textarea>
            </div>
          </section>

          <!-- ============ Sections ============ -->
          <section id="tab-sections" style="display:none;">
            <div class="card">
              <div class="row">
                <div style="font-weight:900;">섹션 생성/편집</div>
                <div style="flex:1"></div>
                <button class="btn secondary" id="btnSecLoadList">섹션 목록 불러오기</button>
              </div>
              <div class="hr"></div>
              <div class="row">
                <label style="font-weight:900;">파일명</label>
                <input id="secName" class="input" placeholder="예: year_nav.html" />
                <button class="btn secondary" id="btnSecLoad">불러오기</button>
                <button class="btn" id="btnSecSave">저장</button>
                <button class="btn secondary" id="btnSecMakeBody">본문 섹션 템플릿 넣기</button>

                <label class="row" style="gap:6px;">
                  <input type="checkbox" id="secAutoMarker" />
                  <span class="muted">저장 시 섹션 구분 주석 자동 삽입(현재는 안내용)</span>
                </label>

                <span class="muted" id="secMsg"></span>
              </div>
              <div style="margin-top:10px;">
                <textarea id="secHtml" class="textarea" placeholder="섹션 HTML을 입력"></textarea>
              </div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">섹션 목록</div>
                <span class="pill" id="secListCount2">0</span>
                <div style="flex:1"></div>
              </div>
              <div class="hr"></div>
              <div class="row" style="margin-bottom:10px;">
                <input id="secSearch2" class="input" placeholder="검색 (파일명)" />
              </div>
              <div class="list" id="secList2"></div>
            </div>
          </section>

          <!-- ============ Templates ============ -->
          <section id="tab-templates" style="display:none;">
            <div class="card">
              <div class="row">
                <div style="font-weight:900;">템플릿 목록</div>
                <div style="flex:1"></div>
                <button class="btn secondary" id="btnTplReload">새로고침</button>
              </div>
              <div class="hr"></div>
              <div class="list" id="tplList"></div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">템플릿 JSON 보기</div>
                <div style="flex:1"></div>
                <span class="muted" id="tplMsg"></span>
              </div>
              <div class="hr"></div>
              <textarea id="tplJson" class="textarea" readonly></textarea>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">템플릿 섹션 편집(카드)</div>
                <div style="flex:1"></div>

                <label class="row" style="gap:6px;">
                  <input type="checkbox" id="tplUseMarkers" checked />
                  <span class="muted">조합 시 구분 주석</span>
                </label>

                <label class="row" style="gap:6px;">
                  <input type="checkbox" id="tplWrapSection" />
                  <span class="muted">조합 시 &lt;section data-section&gt; 래핑</span>
                </label>

                <button class="btn secondary" id="btnTplToBuilder">빌더로 불러오기</button>
                <button class="btn" id="btnTplSaveOrder">순서 저장</button>
                <button class="btn secondary" id="btnTplBuildHtml">HTML 조합 미리보기</button>
              </div>

              <div class="hr"></div>

              <div class="muted" style="margin-bottom:10px;">
                카드 드래그 또는 ↑↓로 순서를 바꾸고 “순서 저장”을 누르면 템플릿 JSON(sections)이 갱신됩니다.
              </div>

              <div class="list" id="tplSectionsList"></div>

              <div class="hr"></div>

              <div class="row">
                <div style="font-weight:900;">조합 결과(미리보기)</div>
                <div style="flex:1"></div>
                <span class="muted" id="tplBuildMsg"></span>
              </div>
              <textarea id="tplHtmlPreview" class="textarea" readonly placeholder="여기에 조합된 HTML이 표시됩니다"></textarea>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

<script>
/** =========================
 * ✅ admin-common.js: 헤더/메뉴 슬롯 유지
 * ========================= */
(function renderShellOnce(){
  try{
    if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
      window.AdminCommon.renderShell({
        headerSlotId: "admin-header-slot",
        menuSlotId: "admin-menu-slot",
        activeMenu: "library_manage"
      });
    }
  }catch(_){}
})();

/** =========================
 * 설정
 * - 여기를 네 배포 URL로 세팅
 * ========================= */
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzj5LUEUKMyQqJfVsVlftO1f4CTYb3NhAQMT2QL6VADBlnjleAXLtBVVhuVHOfwkhQYqQ/exec";

const $ = (id)=>document.getElementById(id);

function setMsg(el, text, isErr=false){
  if (!el) return;
  el.textContent = text || "";
  el.style.color = isErr ? "crimson" : "rgba(15,23,42,0.65)";
}

function apiUrl(){
  const v = ($("apiUrl")?.value || "").trim();
  return v || DEFAULT_API_URL;
}

async function apiGet(mode, params={}){
  const url = new URL(apiUrl());
  url.searchParams.set("mode", mode);
  url.searchParams.set("_ts", String(Date.now())); // ✅ 캐시 방지
  Object.entries(params||{}).forEach(([k,v])=>{
    if (v===undefined || v===null) return;
    url.searchParams.set(k, String(v));
  });

  const r = await fetch(url.toString(), { method:"GET", cache:"no-store", credentials:"omit" });
  const text = await r.text().catch(()=> "");
  let j = null;
  try{ j = JSON.parse(text); }catch(_){}

  if (!r.ok) throw new Error(`HTTP ${r.status}\n${text.slice(0,300)}`);
  if (!j) throw new Error(`JSON 아님\n${text.slice(0,300)}`);

  return j;
}

async function apiPost(mode, bodyObj){
  const url = new URL(apiUrl());
  url.searchParams.set("_ts", String(Date.now()));

  const body = new URLSearchParams();
  body.set("mode", String(mode || ""));
  for (const [k,v] of Object.entries(bodyObj||{})){
    if (v===undefined || v===null) continue;
    body.set(k, String(v));
  }

  const r = await fetch(url.toString(), { method:"POST", body, cache:"no-store", credentials:"omit" });
  const text = await r.text().catch(()=> "");
  let j = null;
  try{ j = JSON.parse(text); }catch(_){}

  if (!r.ok) throw new Error(`HTTP ${r.status}\n${text.slice(0,300)}`);
  if (!j) throw new Error(`JSON 아님\n${text.slice(0,300)}`);

  return j;
}

/** =========================
 * Tabs
 * ========================= */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    ["builder","sections","templates"].forEach(t=>{
      const el = $("tab-"+t);
      if (el) el.style.display = (t===tab) ? "" : "none";
    });
  });
});

/** =========================
 * 데이터
 * ========================= */
let ALL_SECTIONS = [];   // [{name,file_id,url}]
let SELECTED = [];       // [{name, varsText:""}]

let CURRENT_TPL = null;  // {id,name,sections:[{name,vars?}]}
let TPL_SECTIONS = [];   // 편집용 복사본
let _dragIndex = -1;

// 섹션 HTML에 {{BODY}} 포함 여부 캐시
const BODY_SECTION_CACHE = new Map(); // key: sectionName => boolean

function renderSectionList(){
  const q = $("secSearch").value.trim().toLowerCase();
  const list = $("secList");
  list.innerHTML = "";
  const filtered = ALL_SECTIONS.filter(s=>!q || String(s.name||"").toLowerCase().includes(q));
  $("secCount").textContent = String(filtered.length);

  filtered.forEach(s=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(s.name)}</div>
        <div class="meta">${escapeHtml(s.url || s.file_id || "")}</div>
      </div>
      <div style="flex:1"></div>
      <button class="mini-btn" data-act="add">추가</button>
    `;
    row.querySelector('[data-act="add"]').addEventListener("click", ()=>{
      SELECTED.push({ name: s.name, varsText: "" });
      renderSelected();
      updateJsonPreviewSafe_();
    });
    list.appendChild(row);
  });
}

function varsSummary_(varsText){
  const t = (varsText || "").trim();
  if (!t) return "";
  try{
    const o = JSON.parse(t);
    if (!o || typeof o !== "object") return "";
    const keys = Object.keys(o);
    if (!keys.length) return "";
    const pairs = keys.slice(0,4).map(k=>`${k}=${String(o[k])}`);
    const more = keys.length > 4 ? ` …(+${keys.length-4})` : "";
    return pairs.join(", ") + more;
  }catch(_){
    return "vars(JSON) 오류";
  }
}

function parseVarsStrict_(varsText, hint){
  const t = (varsText || "").trim();
  if (!t) return undefined;
  try{
    const v = JSON.parse(t);
    if (!v || typeof v !== "object" || Array.isArray(v)) {
      throw new Error("vars는 객체(JSON object)여야 합니다.");
    }
    return v;
  }catch(e){
    throw new Error(`${hint} vars JSON 파싱 실패: ${e.message || e}`);
  }
}

function findMaxBodySlotNumber_(){
  let maxN = 0;
  for (const s of (SELECTED || [])){
    const t = (s.varsText || "").trim();
    if (!t) continue;
    try{
      const v = JSON.parse(t);
      const slot = String(v?.SLOT || "").trim();
      const m = slot.match(/^BODY_(\d+)$/i);
      if (m){
        const n = parseInt(m[1], 10);
        if (!isNaN(n)) maxN = Math.max(maxN, n);
      }
    }catch(_){}
  }
  return maxN;
}

function setSlotOnItem_(idx, slotValue){
  if (idx < 0 || idx >= SELECTED.length) return;
  const item = SELECTED[idx];
  let v = {};
  const t = (item.varsText || "").trim();
  if (t){
    // 기존 vars 유지 (단, JSON 오류면 강제 덮어쓰기 대신 안내)
    try{ v = JSON.parse(t) || {}; } catch(_){ v = {}; }
  }
  v.SLOT = slotValue;
  item.varsText = JSON.stringify(v, null, 2);
}

async function isBodySection_(secName){
  const key = String(secName || "").trim();
  if (!key) return false;
  if (BODY_SECTION_CACHE.has(key)) return BODY_SECTION_CACHE.get(key);

  try{
    const r = await apiGet("getSection", { name: key });
    const html = String(r?.html || "");
    const yes = html.includes("{{BODY}}");
    BODY_SECTION_CACHE.set(key, yes);
    return yes;
  }catch(_){
    BODY_SECTION_CACHE.set(key, false);
    return false;
  }
}

async function autoAssignBodySlots_(){
  if (!SELECTED.length) return;

  // 이미 지정된 SLOT이 있으면 그 뒤부터 이어서
  let n = findMaxBodySlotNumber_();

  for (let i=0; i<SELECTED.length; i++){
    const item = SELECTED[i];

    // 이미 SLOT이 있으면 건드리지 않음
    const t = (item.varsText || "").trim();
    if (t){
      try{
        const v = JSON.parse(t);
        if (v && typeof v === "object" && String(v.SLOT || "").trim()) continue;
      }catch(_){}
    }

    // 본문 섹션인지 검사(실제 HTML에 {{BODY}}가 있어야 대상)
    const ok = await isBodySection_(item.name);
    if (!ok) continue;

    n += 1;
    setSlotOnItem_(i, `BODY_${n}`);
  }

  renderSelected();
  updateJsonPreviewSafe_();
}

function renderSelected(){
  const list = $("selList");
  list.innerHTML = "";
  $("selCount").textContent = String(SELECTED.length);

  SELECTED.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    const vs = varsSummary_(s.varsText);
    const meta = `#${idx+1}` + (vs ? ` · ${vs}` : "");

    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(s.name)}</div>
        <div class="meta">${escapeHtml(meta)}</div>
      </div>
      <div style="flex:1"></div>
      <button class="mini-btn" data-act="up">↑</button>
      <button class="mini-btn" data-act="down">↓</button>
      <button class="mini-btn" data-act="slot">SLOT</button>
      <button class="mini-btn" data-act="vars">vars</button>
      <button class="mini-btn" data-act="rm">제거</button>
    `;

    row.querySelector('[data-act="up"]').addEventListener("click", ()=>{
      if (idx<=0) return;
      const t = SELECTED[idx-1]; SELECTED[idx-1]=SELECTED[idx]; SELECTED[idx]=t;
      renderSelected();
      updateJsonPreviewSafe_();
    });
    row.querySelector('[data-act="down"]').addEventListener("click", ()=>{
      if (idx>=SELECTED.length-1) return;
      const t = SELECTED[idx+1]; SELECTED[idx+1]=SELECTED[idx]; SELECTED[idx]=t;
      renderSelected();
      updateJsonPreviewSafe_();
    });
    row.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
      SELECTED.splice(idx,1);
      renderSelected();
      updateJsonPreviewSafe_();
    });

    // ✅ SLOT 버튼: BODY_N 자동 할당(해당 아이템만)
    row.querySelector('[data-act="slot"]').addEventListener("click", async ()=>{
      // 본문 섹션인지 한번 확인(없어도 강제 지정은 가능하지만, 실수 방지용)
      const ok = await isBodySection_(s.name);
      if (!ok){
        const go = confirm(`"${s.name}" 섹션 HTML에서 {{BODY}}를 찾지 못했습니다.\n그래도 SLOT을 지정할까요?`);
        if (!go) return;
      }
      const next = findMaxBodySlotNumber_() + 1;
      setSlotOnItem_(idx, `BODY_${next}`);
      renderSelected();
      updateJsonPreviewSafe_();
    });

    row.querySelector('[data-act="vars"]').addEventListener("click", ()=>{
      const hint = `vars(JSON) 입력. 비우면 삭제.\n예: {"SLOT":"BODY_1"}\n또는: {"SLOT":"BODY_2","YEAR":"2026"}`;
      const v = prompt(hint, s.varsText || "");
      if (v===null) return;
      s.varsText = v.trim();
      renderSelected();
      updateJsonPreviewSafe_();
    });

    list.appendChild(row);
  });
}

function buildTemplateObjStrict_(){
  const id = $("tplId").value.trim();
  const name = $("tplName").value.trim();
  const sections = SELECTED.map((s, idx)=>{
    const hint = `선택 #${idx+1} (${s.name})`;
    const vars = parseVarsStrict_(s.varsText, hint); // ✅ 여기서 vars 오류면 즉시 throw
    return vars ? { name: s.name, vars } : { name: s.name };
  });

  return { id, name, sections };
}

function buildTemplateJsonStrict_(){
  const obj = buildTemplateObjStrict_();
  return JSON.stringify(obj, null, 2);
}

function updateJsonPreviewSafe_(){
  // 자동 미리보기: vars JSON이 깨져있으면 안내만 표시
  try{
    $("jsonPreview").value = buildTemplateJsonStrict_();
    setMsg($("jsonMsg"), "OK");
  }catch(e){
    $("jsonPreview").value = "";
    setMsg($("jsonMsg"), String(e.message||e), true);
  }
}

async function reloadSections(){
  const res = await apiGet("listSections");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listSections 실패");
  ALL_SECTIONS = res.items || [];
  renderSectionList();
}

/** =========================
 * Builder actions
 * ========================= */
$("btnReloadSections").addEventListener("click", async ()=>{
  try{ await reloadSections(); }catch(e){ alert(String(e.message||e)); }
});
$("secSearch").addEventListener("input", renderSectionList);

$("btnClearSel").addEventListener("click", ()=>{
  if (!confirm("선택 목록을 비울까요?")) return;
  SELECTED = [];
  renderSelected();
  updateJsonPreviewSafe_();
});

// ✅ BODY 슬롯 자동 지정 버튼
$("btnAutoBodySlots").addEventListener("click", async ()=>{
  try{
    await autoAssignBodySlots_();
    alert("BODY 슬롯 자동지정 완료(가능한 항목만 적용).");
  }catch(e){
    alert("자동지정 실패: " + String(e.message||e));
  }
});

$("btnPreviewJson").addEventListener("click", ()=>{
  try{
    $("jsonPreview").value = buildTemplateJsonStrict_();
    setMsg($("jsonMsg"), "OK");
  }catch(e){
    setMsg($("jsonMsg"), String(e.message||e), true);
    alert(String(e.message||e));
  }
});

$("btnSaveTemplate").addEventListener("click", async ()=>{
  try{
    const id = $("tplId").value.trim();
    const name = $("tplName").value.trim();
    if (!id) return alert("템플릿 ID를 입력하세요.");

    // ✅ vars JSON 유효성 강제 체크 + 최종 JSON 생성
    const json = buildTemplateJsonStrict_();

    // ✅ 저장 전 BODY 슬롯 검사
    let obj = null;
    try { obj = JSON.parse(json); } catch(_){ obj = null; }

    if (obj && Array.isArray(obj.sections)){
      const hasBody = await templateHasBodySlot_(obj.sections);
      if (!hasBody){
        const ok = confirm("경고: 이 템플릿 구성에는 {{BODY}}가 포함된 섹션이 없습니다.\n본문이 최종 HTML에 들어가지 않을 수 있습니다.\n그래도 저장할까요?");
        if (!ok) return;
      }
    }

    const res = await apiPost("templateUpsert", { template_id: id, name, json });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "templateUpsert 실패");

    setMsg($("jsonMsg"), "저장 완료");
    updateJsonPreviewSafe_();
    await loadTemplates();
  }catch(e){
    alert("저장 실패: " + String(e.message||e));
  }
});

/** =========================
 * Sections tab (섹션 관리)
 * ========================= */
async function loadSectionsList2(){
  const res = await apiGet("listSections");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listSections 실패");
  ALL_SECTIONS = res.items || [];
  renderSectionsList2_();
}

function renderSectionsList2_(){
  const q = $("secSearch2").value.trim().toLowerCase();
  const list = $("secList2");
  list.innerHTML = "";
  const filtered = (ALL_SECTIONS||[]).filter(s=>!q || String(s.name||"").toLowerCase().includes(q));
  $("secListCount2").textContent = String(filtered.length);

  filtered.forEach(s=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(s.name)}</div>
        <div class="meta">${escapeHtml(s.url || s.file_id || "")}</div>
      </div>
      <div style="flex:1"></div>
      <button class="mini-btn" data-act="load">불러오기</button>
    `;
    row.querySelector('[data-act="load"]').addEventListener("click", async ()=>{
      $("secName").value = s.name;
      await loadSectionByName_();
      document.querySelector('.tab-btn[data-tab="sections"]').click();
    });
    list.appendChild(row);
  });
}

$("btnSecLoadList").addEventListener("click", async ()=>{
  try{ await loadSectionsList2(); }catch(e){ alert(String(e.message||e)); }
});
$("secSearch2").addEventListener("input", renderSectionsList2_);

async function loadSectionByName_(){
  const name = $("secName").value.trim();
  if (!name) return setMsg($("secMsg"), "파일명을 입력하세요", true);
  try{
    setMsg($("secMsg"), "불러오는 중...");
    const r = await apiGet("getSection", { name });
    if (!r || !r.ok) throw new Error(r && r.message ? r.message : "getSection 실패");
    $("secHtml").value = r.html || "";
    setMsg($("secMsg"), "OK");
  }catch(e){
    setMsg($("secMsg"), "ERROR: " + String(e.message||e), true);
  }
}

$("btnSecLoad").addEventListener("click", loadSectionByName_);

$("btnSecSave").addEventListener("click", async ()=>{
  try{
    // ✅ IME 조합/입력 확정 (한글 입력 중 클릭 이슈 방지)
    $("secName").blur();
    $("secHtml").blur();
    await new Promise(r=>setTimeout(r, 0));

    let name = $("secName").value.trim();
    const html = $("secHtml").value;

    // ✅ .html 자동 보정
    if (name && !/\.html$/i.test(name)) name += ".html";

    if (!name) return setMsg($("secMsg"), "파일명을 입력하세요", true);
    if (!html.trim()) return setMsg($("secMsg"), "HTML이 비어있습니다", true);

    setMsg($("secMsg"), "저장 중...");
    const res = await apiPost("sectionUpsert", { name, html });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "sectionUpsert 실패");

    setMsg($("secMsg"), "저장 완료: " + (res.file && res.file.name ? res.file.name : name));
    await loadSectionsList2();
    await reloadSections();
  }catch(e){
    setMsg($("secMsg"), "저장 실패: " + String(e.message||e), true);
  }
});

$("btnSecMakeBody").addEventListener("click", ()=>{
  if (!$("secName").value.trim()) $("secName").value = "body.html";
  if (!/\.html$/i.test($("secName").value.trim())) {
    $("secName").value = $("secName").value.trim() + ".html";
  }

  $("secHtml").value =
`<!-- SECTION:body.html START -->
<!-- BODY_START -->
{{BODY}}
<!-- BODY_END -->
<!-- SECTION:body.html END -->`;

  setMsg($("secMsg"), "본문 섹션 템플릿을 채웠습니다. 파일명/내용 확인 후 저장하세요.");
});

/** =========================
 * Templates tab
 * ========================= */
async function loadTemplates(){
  const res = await apiGet("listTemplates");
  if (!res || !res.ok) throw new Error(res && res.message ? res.message : "listTemplates 실패");

  const list = $("tplList");
  list.innerHTML = "";
  (res.items||[]).forEach(it=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(it.id)}</div>
        <div class="meta">${escapeHtml(it.name || it.url || "")}</div>
      </div>
      <div class="row" style="gap:6px;">
        <button class="mini-btn" data-act="open">열기</button>
      </div>
    `;
    row.querySelector('[data-act="open"]').addEventListener("click", async ()=>{
      try{
        $("tplMsg").textContent = "불러오는 중...";
        const r = await apiGet("getTemplate", { template_id: it.id });
        if (!r || !r.ok) throw new Error(r && r.message ? r.message : "getTemplate 실패");
        $("tplJson").value = r.json || "";
        $("tplMsg").textContent = "OK";

        try{
          const obj = JSON.parse(r.json || "{}");
          if (!obj || typeof obj !== "object") throw new Error("템플릿 JSON 파싱 실패");
          if (!Array.isArray(obj.sections)) obj.sections = [];
          if (!obj.id) obj.id = it.id;
          if (!obj.name) obj.name = it.name || it.id;

          CURRENT_TPL = obj;
          TPL_SECTIONS = (obj.sections || []).map(s=>({ ...s }));
          renderTplSectionsEditor_();
        }catch(_e){
          CURRENT_TPL = null;
          TPL_SECTIONS = [];
          renderTplSectionsEditor_();
        }
      }catch(e){
        $("tplMsg").textContent = "ERROR: " + String(e.message||e);
      }
    });
    list.appendChild(row);
  });
}

$("btnTplReload").addEventListener("click", async ()=>{
  try{ await loadTemplates(); }catch(e){ alert(String(e.message||e)); }
});

/** =========================
 * Templates: 카드 편집기 / 조합 미리보기
 * ========================= */
function renderTplSectionsEditor_(){
  const list = $("tplSectionsList");
  if (!list) return;
  list.innerHTML = "";

  if (!CURRENT_TPL){
    list.innerHTML = `<div class="muted">템플릿을 먼저 “열기” 해주세요.</div>`;
    return;
  }

  if (!TPL_SECTIONS.length){
    list.innerHTML = `<div class="muted">sections가 비어 있습니다.</div>`;
    return;
  }

  TPL_SECTIONS.forEach((sec, idx)=>{
    const row = document.createElement("div");
    row.className = "item tpl-card";
    row.setAttribute("draggable","true");
    row.dataset.index = String(idx);

    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${escapeHtml(sec.name)}</div>
        <div class="meta">#${idx+1}</div>
      </div>
      <div class="row" style="gap:6px;">
        <button class="mini-btn" data-act="up">↑</button>
        <button class="mini-btn" data-act="down">↓</button>
        <button class="mini-btn" data-act="rm">제거</button>
      </div>
    `;

    row.querySelector('[data-act="up"]').addEventListener("click", ()=>{
      if (idx<=0) return;
      const t = TPL_SECTIONS[idx-1]; TPL_SECTIONS[idx-1]=TPL_SECTIONS[idx]; TPL_SECTIONS[idx]=t;
      renderTplSectionsEditor_();
    });
    row.querySelector('[data-act="down"]').addEventListener("click", ()=>{
      if (idx>=TPL_SECTIONS.length-1) return;
      const t = TPL_SECTIONS[idx+1]; TPL_SECTIONS[idx+1]=TPL_SECTIONS[idx]; TPL_SECTIONS[idx]=t;
      renderTplSectionsEditor_();
    });
    row.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
      TPL_SECTIONS.splice(idx,1);
      renderTplSectionsEditor_();
    });

    row.addEventListener("dragstart", (e)=>{
      _dragIndex = idx;
      row.classList.add("dragging");
      try{ e.dataTransfer.effectAllowed = "move"; }catch(_){}
    });
    row.addEventListener("dragend", ()=>{
      _dragIndex = -1;
      row.classList.remove("dragging");
      document.querySelectorAll(".tpl-drop").forEach(x=>x.classList.remove("tpl-drop"));
    });
    row.addEventListener("dragover", (e)=>{
      e.preventDefault();
      row.classList.add("tpl-drop");
    });
    row.addEventListener("dragleave", ()=>{
      row.classList.remove("tpl-drop");
    });
    row.addEventListener("drop", (e)=>{
      e.preventDefault();
      row.classList.remove("tpl-drop");
      const to = Number(row.dataset.index);
      const from = _dragIndex;
      if (from<0 || to<0 || from===to) return;

      const moved = TPL_SECTIONS.splice(from,1)[0];
      TPL_SECTIONS.splice(to,0,moved);
      _dragIndex = -1;
      renderTplSectionsEditor_();
    });

    list.appendChild(row);
  });
}

$("btnTplSaveOrder") && $("btnTplSaveOrder").addEventListener("click", async ()=>{
  try{
    if (!CURRENT_TPL) return alert("템플릿을 먼저 열어주세요.");

    CURRENT_TPL.sections = TPL_SECTIONS.map(s=>({ ...s }));
    const jsonStr = JSON.stringify(CURRENT_TPL, null, 2);

    const res = await apiPost("templateUpsert", {
      template_id: CURRENT_TPL.id,
      name: CURRENT_TPL.name || CURRENT_TPL.id,
      json: jsonStr
    });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "templateUpsert 실패");

    $("tplJson").value = jsonStr;
    $("tplMsg").textContent = "OK (순서 저장됨)";
    alert("순서 저장 완료");
  }catch(e){
    alert("순서 저장 실패: " + String(e.message||e));
  }
});

$("btnTplToBuilder") && $("btnTplToBuilder").addEventListener("click", ()=>{
  if (!CURRENT_TPL) return alert("템플릿을 먼저 열어주세요.");

  $("tplId").value = CURRENT_TPL.id || "";
  $("tplName").value = CURRENT_TPL.name || CURRENT_TPL.id || "";

  SELECTED = (TPL_SECTIONS || []).map(s=>{
    return {
      name: s.name,
      varsText: s.vars ? JSON.stringify(s.vars, null, 2) : ""
    };
  });

  renderSelected();
  updateJsonPreviewSafe_();
  document.querySelector('.tab-btn[data-tab="builder"]').click();
});

$("btnTplBuildHtml") && $("btnTplBuildHtml").addEventListener("click", async ()=>{
  try{
    if (!CURRENT_TPL) return alert("템플릿을 먼저 열어주세요.");
    if (!TPL_SECTIONS.length) return alert("sections가 비어 있습니다.");

    $("tplBuildMsg").textContent = "조합 중...";
    const useMarkers = $("tplUseMarkers") ? $("tplUseMarkers").checked : true;
    const wrapSec = $("tplWrapSection") ? $("tplWrapSection").checked : false;

    let out = "";
    for (const s of TPL_SECTIONS){
      const r = await apiGet("getSection", { name: s.name });
      if (!r || !r.ok) throw new Error("getSection 실패: " + s.name);

      let html = r.html || "";

      if (wrapSec){
        html = `<section data-section="${escapeHtml(s.name)}">\n${html}\n</section>\n`;
      }

      if (useMarkers){
        out += `<!-- SECTION:${s.name} START -->\n${html}\n<!-- SECTION:${s.name} END -->\n\n`;
      }else{
        out += html + "\n\n";
      }
    }

    $("tplHtmlPreview").value = out;
    $("tplBuildMsg").textContent = "OK";
  }catch(e){
    $("tplBuildMsg").textContent = "ERROR";
    alert("조합 실패: " + String(e.message||e));
  }
});

/** =========================
 * utils
 * ========================= */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

async function templateHasBodySlot_(sections){
  for (const sec of (sections || [])){
    const secName =
      (typeof sec === "string") ? sec.trim() :
      (sec && typeof sec === "object") ? String(sec.name || "").trim() : "";

    if (!secName) continue;

    const r = await apiGet("getSection", { name: secName });
    if (r && r.ok){
      const html = String(r.html || "");
      if (html.includes("{{BODY}}")) return true;
    }
  }
  return false;
}

/** =========================
 * init
 * ========================= */
(function init(){
  $("apiUrl").value = DEFAULT_API_URL;
  renderSelected();
  updateJsonPreviewSafe_();
  reloadSections().catch(()=>{});
  loadSectionsList2().catch(()=>{});
  loadTemplates().catch(()=>{});
  renderTplSectionsEditor_();
})();
</script>
</body>
</html>
