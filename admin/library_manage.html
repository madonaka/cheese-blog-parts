<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Manage</title>

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />
  <!-- ✅ 기존 방식 유지: 헤더/메뉴 슬롯 렌더 -->
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap{ padding:14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      transition: all 0.2s;
    }
    .tab-btn.active{ background: #0f172a; color: #fff; outline:2px solid rgba(59,130,246,.35); }

    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input, .select, .textarea{
      border:1px solid rgba(15,23,42,0.16);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      min-height:42px;
      outline:none;
    }
    .textarea{ width:100%; min-height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }

    .btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#0f172a;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.secondary{ background:#fff; color:#0f172a; }
    .mini-btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size: 12px;
    }

    .muted{ color:rgba(15,23,42,0.65); font-size:13px; }
    .hr{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }
    .pill{
      font-size:12px;
      background:rgba(15,23,42,0.06);
      border:1px solid rgba(15,23,42,0.10);
      border-radius:999px;
      padding:4px 10px;
      font-weight:800;
    }

    .builder-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .builder-grid{ grid-template-columns: 1fr; } }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow:0 10px 24px rgba(15,23,42,0.04);
      background:#fff;
    }
    .item .name{ font-weight:900; font-size: 14px; }
    .item .meta{ font-size:12px; color:rgba(15,23,42,0.65); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:520px; }

    /* template editor drag */
    .tpl-card{ cursor:grab; }
    .tpl-card.dragging{ opacity:.45; }
    .tpl-drop{ outline:2px dashed rgba(59,130,246,.35); }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="lm-wrap">

          <div class="tabs">
            <button class="tab-btn active" data-tab="builder">템플릿 빌더</button>
            <button class="tab-btn" data-tab="sections">섹션 관리</button>
            <button class="tab-btn" data-tab="templates">템플릿 보기</button>
          </div>

          <!-- ============ Builder ============ -->
          <section id="tab-builder">
            <div class="card">
              <div class="row">
                <label style="font-weight:900;">API URL</label>
                <input id="apiUrl" class="input" style="min-width:520px" />
                <span class="muted">배포 /exec 주소</span>
              </div>

              <div class="row" style="margin-top:10px;">
                <label style="font-weight:900;">템플릿 ID</label>
                <input id="tplId" class="input" placeholder="예: news_v1" />
                <label style="font-weight:900;">템플릿 이름</label>
                <input id="tplName" class="input" placeholder="예: 뉴스 레이아웃" />

                <button class="btn secondary" id="btnAutoImgSlots">IMG 슬롯 자동지정</button>
                <button class="btn secondary" id="btnAutoBodySlots">BODY 슬롯 자동지정</button>

                <button class="btn" id="btnSaveTemplate">템플릿 저장</button>
                <button class="btn secondary" id="btnPreviewJson">JSON 미리보기</button>
              </div>

              <p class="muted" style="margin-top:10px; white-space:pre-line;">
                왼쪽 섹션에서 추가 후 오른쪽 목록에서 관리하세요.
                ✅ <strong>SLOT</strong> 버튼: 본문형이면 BODY_N, 이미지형이면 IMG_N 자동 개별 부여
                ✅ <strong>자동지정</strong> 버튼: 전체 목록을 분석하여 한꺼번에 번호 부여
              </p>
            </div>

            <div class="builder-grid">
              <!-- Available -->
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">섹션 목록(Drive)</div>
                  <span class="pill" id="secCount">0</span>
                  <div style="flex:1"></div>
                  <input id="secSearch" class="input" placeholder="검색 (.html)" />
                  <button class="btn secondary" id="btnReloadSections">새로고침</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="secList"></div>
              </div>

              <!-- Selected -->
              <div class="card">
                <div class="row">
                  <div style="font-weight:900;">선택된 섹션</div>
                  <span class="pill" id="selCount">0</span>
                  <div style="flex:1"></div>
                  <button class="btn secondary" id="btnClearSel">비우기</button>
                </div>
                <div class="hr"></div>
                <div class="list" id="selList"></div>
              </div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">JSON 미리보기</div>
                <div style="flex:1"></div>
                <span class="muted" id="jsonMsg"></span>
              </div>
              <div class="hr"></div>
              <textarea id="jsonPreview" class="textarea" readonly></textarea>
            </div>
          </section>

          <!-- ============ Sections ============ -->
          <section id="tab-sections" style="display:none;">
            <div class="card">
              <div class="row">
                <div style="font-weight:900;">섹션 생성/편집</div>
                <div style="flex:1"></div>
                <button class="btn secondary" id="btnSecLoadList">섹션 목록 불러오기</button>
              </div>
              <div class="hr"></div>
              <div class="row">
                <label style="font-weight:900;">파일명</label>
                <input id="secName" class="input" placeholder="파일명.html" />
                <button class="btn secondary" id="btnSecLoad">불러오기</button>
                <button class="btn" id="btnSecSave">저장</button>
                <button class="btn secondary" id="btnSecMakeBody">본문 마커 넣기</button>
                <span class="muted" id="secMsg"></span>
              </div>
              <div style="margin-top:10px;">
                <textarea id="secHtml" class="textarea" placeholder="HTML 입력"></textarea>
              </div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">섹션 목록</div>
                <span class="pill" id="secListCount2">0</span>
              </div>
              <div class="hr"></div>
              <div class="list" id="secList2"></div>
            </div>
          </section>

          <!-- ============ Templates ============ -->
          <section id="tab-templates" style="display:none;">
            <div class="card">
              <div class="row">
                <div style="font-weight:900;">템플릿 목록</div>
                <div style="flex:1"></div>
                <button class="btn secondary" id="btnTplReload">새로고침</button>
              </div>
              <div class="hr"></div>
              <div class="list" id="tplList"></div>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">템플릿 JSON</div>
                <span class="muted" id="tplMsg"></span>
              </div>
              <textarea id="tplJson" class="textarea" readonly></textarea>
            </div>

            <div class="card">
              <div class="row">
                <div style="font-weight:900;">섹션 구성 편집</div>
                <div style="flex:1"></div>
                <button class="btn secondary" id="btnTplToBuilder">빌더로 보내기</button>
                <button class="btn" id="btnTplSaveOrder">순서 저장</button>
              </div>
              <div class="hr"></div>
              <div class="list" id="tplSectionsList"></div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

<script>
/** =========================
 * ✅ admin-common.js 연동
 * ========================= */
(function renderShellOnce(){
  try{
    if (window.AdminCommon && typeof window.AdminCommon.renderShell === "function"){
      window.AdminCommon.renderShell({
        headerSlotId: "admin-header-slot",
        menuSlotId: "admin-menu-slot",
        activeMenu: "library_manage"
      });
    }
  }catch(_){}
})();

const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwXqz1uMy3EOrisCEKIe0Fk7yu0P6MQ1ddHDvo7Sr_CPEYY0RHP2GyUBL8YhaBqxnmBJg/exec";
const $ = (id)=>document.getElementById(id);

function setMsg(el, text, isErr=false){
  if (!el) return;
  el.textContent = text || "";
  el.style.color = isErr ? "crimson" : "rgba(15,23,42,0.65)";
}

function apiUrl(){ return ($("apiUrl")?.value || "").trim() || DEFAULT_API_URL; }

async function apiGet(mode, params={}){
  const url = new URL(apiUrl());
  url.searchParams.set("mode", mode);
  url.searchParams.set("_ts", String(Date.now()));
  Object.entries(params||{}).forEach(([k,v])=>{ if (v!==undefined && v!==null) url.searchParams.set(k, String(v)); });
  const r = await fetch(url.toString(), { method:"GET", cache:"no-store" });
  return await r.json();
}

async function apiPost(mode, bodyObj){
  const url = new URL(apiUrl());
  const body = new URLSearchParams();
  body.set("mode", String(mode || ""));
  Object.entries(bodyObj||{}).forEach(([k,v])=>{ if (v!==undefined && v!==null) body.set(k, String(v)); });
  const r = await fetch(url.toString(), { method:"POST", body, cache:"no-store" });
  return await r.json();
}

/** =========================
 * Tabs
 * ========================= */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    ["builder","sections","templates"].forEach(t=>{
      const el = $("tab-"+t);
      if (el) el.style.display = (t===tab) ? "" : "none";
    });
  };
});

/** =========================
 * 데이터 상태 및 유틸
 * ========================= */
let ALL_SECTIONS = [];
let SELECTED = [];
let CURRENT_TPL = null;
let TPL_SECTIONS = [];
let _dragIndex = -1;

const SECTION_CACHE = new Map();

function findMaxSlotNumber_(prefix){
  let maxN = 0;
  for (const s of SELECTED){
    try{
      const v = JSON.parse(s.varsText || "{}");
      const slot = String(v?.SLOT || v?.IMG_SLOT || "").trim().toUpperCase();
      const m = slot.match(new RegExp(`^${prefix}_(\\d+)$`));
      if (m) maxN = Math.max(maxN, parseInt(m[1], 10));
    }catch(_){}
  }
  return maxN;
}

function isImageSectionName_(name){
  const n = String(name || "").toLowerCase();
  return n.includes("img") || n.includes("image") || n.includes("cheese_img");
}

async function getSectionHtmlCached(name) {
  if (SECTION_CACHE.has(name)) return SECTION_CACHE.get(name);
  try {
    const r = await apiGet("getSection", { name });
    const html = r.html || "";
    SECTION_CACHE.set(name, html);
    return html;
  } catch(e) { return ""; }
}

async function checkSectionType(name) {
  const html = await getSectionHtmlCached(name);
  const isImg = isImageSectionName_(name) || /{{\s*(IMG_[A-Z0-9_]+|THUMB_URL)\s*}}/i.test(html);
  const isBody = html.includes("{{BODY}}");
  return { isImg, isBody };
}

/** =========================
 * 렌더링 로직
 * ========================= */
function renderSectionList(){
  const q = $("secSearch").value.trim().toLowerCase();
  const list = $("secList");
  list.innerHTML = "";
  const filtered = ALL_SECTIONS.filter(s=>!q || s.name.toLowerCase().includes(q));
  $("secCount").textContent = filtered.length;

  filtered.forEach(s=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `<div style="min-width:0;"><div class="name">${s.name}</div></div><div style="flex:1"></div><button class="mini-btn">추가</button>`;
    row.querySelector("button").onclick = ()=>{
      SELECTED.push({ name: s.name, varsText: "" });
      renderSelected();
      updateJsonPreviewSafe_();
    };
    list.appendChild(row);
  });
}

function renderSelected(){
  const list = $("selList");
  list.innerHTML = "";
  $("selCount").textContent = SELECTED.length;

  SELECTED.forEach((s, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    let vSummary = "";
    try {
      const v = JSON.parse(s.varsText || "{}");
      const keys = Object.keys(v);
      if(keys.length) vSummary = " · " + keys.map(k=>`${k}=${v[k]}`).join(", ");
    } catch(e){}

    row.innerHTML = `
      <div style="min-width:0;">
        <div class="name">${s.name}</div>
        <div class="meta">#${idx+1}${vSummary}</div>
      </div>
      <div style="flex:1"></div>
      <button class="mini-btn" data-act="up">↑</button>
      <button class="mini-btn" data-act="down">↓</button>
      <button class="mini-btn" data-act="slot">SLOT</button>
      <button class="mini-btn" data-act="vars">vars</button>
      <button class="mini-btn" data-act="rm">제거</button>
    `;

    row.querySelector('[data-act="up"]').onclick = ()=>{
      if(idx<=0) return;
      [SELECTED[idx-1], SELECTED[idx]] = [SELECTED[idx], SELECTED[idx-1]];
      renderSelected(); updateJsonPreviewSafe_();
    };
    row.querySelector('[data-act="down"]').onclick = ()=>{
      if(idx>=SELECTED.length-1) return;
      [SELECTED[idx+1], SELECTED[idx]] = [SELECTED[idx], SELECTED[idx+1]];
      renderSelected(); updateJsonPreviewSafe_();
    };
    row.querySelector('[data-act="rm"]').onclick = ()=>{
      SELECTED.splice(idx,1); renderSelected(); updateJsonPreviewSafe_();
    };

    // ✅ SLOT 버튼 개별 지정 로직
    row.querySelector('[data-act="slot"]').onclick = async ()=>{
      const type = await checkSectionType(s.name);
      let vars = {}; try { vars = JSON.parse(s.varsText || "{}"); } catch(e){}
      
      if (type.isImg) {
        const next = findMaxSlotNumber_("IMG") + 1;
        vars.IMG_SLOT = `IMG_${next}`;
      } else {
        const next = findMaxSlotNumber_("BODY") + 1;
        vars.SLOT = `BODY_${next}`;
      }
      s.varsText = JSON.stringify(vars, null, 2);
      renderSelected(); updateJsonPreviewSafe_();
    };

    row.querySelector('[data-act="vars"]').onclick = ()=>{
      const v = prompt("vars(JSON) 입력", s.varsText || "");
      if (v!==null) { s.varsText = v.trim(); renderSelected(); updateJsonPreviewSafe_(); }
    };

    list.appendChild(row);
  });
}

function updateJsonPreviewSafe_(){
  try{
    const sections = SELECTED.map(s=>{
      let vars = undefined;
      if(s.varsText.trim()) vars = JSON.parse(s.varsText);
      return vars ? { name: s.name, vars } : { name: s.name };
    });
    $("jsonPreview").value = JSON.stringify({ id: $("tplId").value, name: $("tplName").value, sections }, null, 2);
    setMsg($("jsonMsg"), "OK");
  }catch(e){
    setMsg($("jsonMsg"), "JSON 오류", true);
  }
}

/** =========================
 * 버튼 액션들
 * ========================= */
async function autoAssignBodySlots_(){
  let n = findMaxSlotNumber_("BODY");
  for (let item of SELECTED) {
    let v = {}; try { v = JSON.parse(item.varsText || "{}"); } catch(e){}
    if (v.SLOT || v.IMG_SLOT) continue;
    const type = await checkSectionType(item.name);
    if (type.isBody) {
      n++; v.SLOT = `BODY_${n}`;
      item.varsText = JSON.stringify(v, null, 2);
    }
  }
  renderSelected(); updateJsonPreviewSafe_();
}

async function autoAssignImgSlots_(){
  let n = findMaxSlotNumber_("IMG");
  for (let item of SELECTED) {
    let v = {}; try { v = JSON.parse(item.varsText || "{}"); } catch(e){}
    if (v.SLOT || v.IMG_SLOT) continue;
    const type = await checkSectionType(item.name);
    if (type.isImg) {
      n++; v.IMG_SLOT = `IMG_${n}`;
      item.varsText = JSON.stringify(v, null, 2);
    }
  }
  renderSelected(); updateJsonPreviewSafe_();
}

async function reloadSections(){
  const res = await apiGet("listSections");
  ALL_SECTIONS = res.items || [];
  renderSectionList();
  
  const list2 = $("secList2");
  list2.innerHTML = "";
  $("secListCount2").textContent = ALL_SECTIONS.length;
  ALL_SECTIONS.forEach(s=>{
    const r = document.createElement("div");
    r.className = "item";
    r.innerHTML = `<div class="name">${s.name}</div><div style="flex:1"></div><button class="mini-btn">편집</button>`;
    r.querySelector("button").onclick = async ()=>{
      $("secName").value = s.name;
      const d = await apiGet("getSection", { name: s.name });
      $("secHtml").value = d.html || "";
      document.querySelector('[data-tab="sections"]').click();
    };
    list2.appendChild(r);
  });
}

async function loadTemplates(){
  const res = await apiGet("listTemplates");
  const list = $("tplList");
  list.innerHTML = "";
  (res.items||[]).forEach(it=>{
    const r = document.createElement("div");
    r.className = "item";
    r.innerHTML = `<div class="name">${it.id}</div><div style="flex:1"></div><button class="mini-btn">열기</button>`;
    r.querySelector("button").onclick = async ()=>{
      const d = await apiGet("getTemplate", { template_id: it.id });
      $("tplJson").value = d.json || "";
      const obj = JSON.parse(d.json || "{}");
      CURRENT_TPL = obj;
      TPL_SECTIONS = [...(obj.sections || [])];
      renderTplSectionsEditor();
    };
    list.appendChild(r);
  });
}

function renderTplSectionsEditor(){
  const list = $("tplSectionsList");
  list.innerHTML = "";
  TPL_SECTIONS.forEach((s, i)=>{
    const r = document.createElement("div");
    r.className = "item";
    r.innerHTML = `<div>${s.name}</div><div style="flex:1"></div><button class="mini-btn">삭제</button>`;
    r.querySelector("button").onclick = ()=>{ TPL_SECTIONS.splice(i,1); renderTplSectionsEditor(); };
    list.appendChild(r);
  });
}

/** =========================
 * 초기화 및 이벤트 바인딩
 * ========================= */
$("btnReloadSections").onclick = reloadSections;
$("secSearch").oninput = renderSectionList;
$("btnClearSel").onclick = ()=>{ if(confirm("비울까요?")) { SELECTED=[]; renderSelected(); updateJsonPreviewSafe_(); } };
$("btnAutoBodySlots").onclick = autoAssignBodySlots_;
$("btnAutoImgSlots").onclick = autoAssignImgSlots_;
$("btnPreviewJson").onclick = updateJsonPreviewSafe_;

$("btnSaveTemplate").onclick = async ()=>{
  const res = await apiPost("templateUpsert", { template_id: $("tplId").value, json: $("jsonPreview").value, name: $("tplName").value });
  if(res.ok) alert("저장 완료");
};

$("btnSecSave").onclick = async ()=>{
  const res = await apiPost("sectionUpsert", { name: $("secName").value, html: $("secHtml").value });
  if(res.ok) { alert("저장 완료"); reloadSections(); }
};

$("btnSecLoad").onclick = async ()=>{
  const d = await apiGet("getSection", { name: $("secName").value });
  $("secHtml").value = d.html || "";
};

$("btnSecMakeBody").onclick = ()=>{
  $("secHtml").value = `<!-- SECTION:${$("secName").value || 'body.html'} START -->\n{{BODY}}\n<!-- SECTION END -->`;
};

$("btnTplReload").onclick = loadTemplates;
$("btnTplToBuilder").onclick = ()=>{
  if(!CURRENT_TPL) return;
  $("tplId").value = CURRENT_TPL.id;
  $("tplName").value = CURRENT_TPL.name;
  SELECTED = TPL_SECTIONS.map(s=>({ name: s.name, varsText: JSON.stringify(s.vars||{}, null, 2) }));
  renderSelected(); updateJsonPreviewSafe_();
  document.querySelector('[data-tab="builder"]').click();
};

window.onload = ()=>{
  $("apiUrl").value = DEFAULT_API_URL;
  reloadSections();
  loadTemplates();
};
</script>
</body>
</html>
