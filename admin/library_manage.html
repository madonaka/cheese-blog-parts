<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>섹션/템플릿 관리 툴</title>

  <!-- ✅ 기존 관리자 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap{ padding:14px; }
    .lm-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .lm-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .lm-col{ display:flex; flex-direction:column; gap:10px; }
    .lm-split{ display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start; }
    @media (max-width: 980px){ .lm-split{ grid-template-columns: 1fr; } }

    .lm-tabs{ display:flex; gap:8px; }
    .lm-tab{
      appearance:none; border:1px solid rgba(15,23,42,0.14);
      background:#fff; padding:10px 12px; border-radius:12px;
      font-weight:800; cursor:pointer;
    }
    .lm-tab[aria-selected="true"]{ border-color: rgba(15,23,42,0.35); box-shadow:0 8px 20px rgba(15,23,42,0.08); }

    .lm-input, .lm-select, .lm-textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      outline:none;
    }
    .lm-textarea{ min-height: 420px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13px; }

    .lm-list{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      overflow:hidden;
      max-height: 520px;
      overflow:auto;
    }
    .lm-item{
      display:flex; flex-direction:column; gap:4px;
      padding:10px 12px;
      border-top:1px solid rgba(15,23,42,0.08);
      cursor:pointer;
      background:#fff;
    }
    .lm-item:first-child{ border-top:none; }
    .lm-item:hover{ background:rgba(15,23,42,0.03); }
    .lm-item.active{ background:rgba(15,23,42,0.06); }
    .lm-item small{ opacity:0.7; }

    .lm-btn{
      appearance:none;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .lm-btn.primary{ border-color: rgba(15,23,42,0.35); }

    .lm-status{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.14);
      background: rgba(15,23,42,0.02);
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .lm-note{ font-size:13px; opacity:0.8; line-height:1.5; }
    .lm-k{ font-weight:900; }

    /* ===== builder ===== */
    .lm-builder{ display:grid; grid-template-columns: 320px 1fr; gap:12px; align-items:start; margin-top:12px; }
    @media (max-width: 980px){ .lm-builder{ grid-template-columns: 1fr; } }
    .lm-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid rgba(15,23,42,0.14);
      border-radius:999px; background:#fff;
      font-weight:800;
    }
    .lm-mini{ font-size:12px; opacity:0.8; }
    .lm-hr{ height:1px; background:rgba(15,23,42,0.08); margin:10px 0; border:0; }
    .lm-selected-row{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .lm-selected-actions{ display:flex; gap:6px; align-items:center; }
    .lm-json-mini{ min-height: 120px; font-size:12.5px; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="lm-wrap">

          <div class="lm-card">
            <div class="lm-row" style="justify-content:space-between;">
              <div class="lm-col" style="flex:1;">
                <div class="lm-tabs" role="tablist" aria-label="라이브러리 탭">
                  <button id="tab-sections" class="lm-tab" role="tab" aria-selected="true">섹션 라이브러리</button>
                  <button id="tab-templates" class="lm-tab" role="tab" aria-selected="false">템플릿 매니페스트</button>
                </div>
                <div class="lm-note">
                  <span class="lm-k">중요:</span> 저장/불러오기는 기존 관리자 페이지들과 동일하게
                  <span class="lm-k">POST + URLSearchParams</span>로 호출합니다.
                </div>
              </div>

              <div class="lm-row">
                <button class="lm-btn" id="btn-reload">목록 새로고침</button>
                <button class="lm-btn" id="btn-diag">diag</button>
              </div>
            </div>

            <div style="margin-top:10px;" class="lm-row">
              <label class="lm-label lm-k" style="min-width:64px;">GAS</label>
              <input id="gas-url" class="lm-input" />
            </div>

            <div style="margin-top:10px;" class="lm-status" id="status">대기</div>
          </div>

          <!-- ===== Sections ===== -->
          <section id="panel-sections" class="lm-card" role="tabpanel" aria-labelledby="tab-sections">
            <div class="lm-split">
              <div>
                <div class="lm-row" style="justify-content:space-between;">
                  <div class="lm-k">섹션 목록 (.html)</div>
                  <button class="lm-btn" id="sec-new">새 섹션</button>
                </div>
                <div class="lm-list" id="sec-list" style="margin-top:10px;"></div>
              </div>

              <div>
                <div class="lm-row">
                  <div style="flex:1;">
                    <div class="lm-k">섹션 파일명</div>
                    <input id="sec-name" class="lm-input" placeholder="예: year_nav.html" />
                  </div>
                  <div class="lm-row" style="margin-top:18px;">
                    <button class="lm-btn" id="sec-load">불러오기</button>
                    <button class="lm-btn primary" id="sec-save">저장</button>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <div class="lm-k">HTML</div>
                  <textarea id="sec-html" class="lm-textarea" placeholder="섹션 HTML 조각을 입력하세요"></textarea>
                </div>
              </div>
            </div>
          </section>

          <!-- ===== Templates ===== -->
          <section id="panel-templates" class="lm-card" role="tabpanel" aria-labelledby="tab-templates" style="display:none;">
            <div class="lm-split">
              <div>
                <div class="lm-row" style="justify-content:space-between;">
                  <div class="lm-k">템플릿 목록 (.json)</div>
                  <button class="lm-btn" id="tpl-new">새 템플릿</button>
                </div>
                <div class="lm-list" id="tpl-list" style="margin-top:10px;"></div>
              </div>

              <div>
                <div class="lm-row">
                  <div style="flex:1;">
                    <div class="lm-k">template_id</div>
                    <input id="tpl-id" class="lm-input" placeholder="예: genealogy_v1" />
                    <div class="lm-note" style="margin-top:6px;">실제 파일명은 <b>template_id + .json</b> 으로 저장됩니다.</div>
                  </div>
                  <div class="lm-row" style="margin-top:18px;">
                    <button class="lm-btn" id="tpl-load">불러오기</button>
                    <button class="lm-btn primary" id="tpl-save">저장</button>
                  </div>
                </div>

                <hr class="lm-hr"/>

                <!-- ✅ Builder -->
                <div class="lm-k">템플릿 빌더 (섹션 조합 → JSON 자동생성)</div>
                <div class="lm-note" style="margin-top:6px;">
                  왼쪽 섹션 목록에서 <span class="lm-k">추가</span> → 오른쪽에서 순서 조정/params 입력 → 아래 JSON 자동생성
                </div>

                <div class="lm-builder">
                  <div>
                    <div class="lm-row" style="justify-content:space-between;">
                      <div class="lm-pill">섹션 목록 <span class="lm-mini">(Drive .html)</span></div>
                      <button class="lm-btn" id="btn-refresh-sections-for-builder">섹션 새로고침</button>
                    </div>
                    <div class="lm-list" id="builder-sec-list" style="margin-top:10px; max-height:360px;"></div>
                  </div>

                  <div>
                    <div class="lm-row" style="justify-content:space-between;">
                      <div class="lm-pill">선택된 섹션(순서)</div>
                      <div class="lm-row">
                        <button class="lm-btn" id="btn-builder-clear">비우기</button>
                        <button class="lm-btn" id="btn-builder-to-json">JSON 반영</button>
                      </div>
                    </div>

                    <div class="lm-list" id="builder-selected-list" style="margin-top:10px; max-height:240px;"></div>

                    <div style="margin-top:10px;">
                      <div class="lm-row" style="justify-content:space-between;">
                        <div class="lm-k">선택 섹션 params (JSON)</div>
                        <div class="lm-note">예: {"TITLE":"...","YEAR_LINKS":"..."} (없으면 {})</div>
                      </div>
                      <textarea id="builder-params" class="lm-textarea lm-json-mini" placeholder="{}"></textarea>
                      <div class="lm-row" style="margin-top:8px;">
                        <button class="lm-btn" id="btn-builder-apply-params">params 적용</button>
                        <button class="lm-btn" id="btn-builder-params-validate">params JSON 검증</button>
                      </div>
                    </div>
                  </div>
                </div>

                <hr class="lm-hr"/>

                <div style="margin-top:10px;">
                  <div class="lm-row" style="justify-content:space-between;">
                    <div class="lm-k">JSON</div>
                    <div class="lm-row">
                      <button class="lm-btn" id="tpl-validate">JSON 검증</button>
                      <button class="lm-btn" id="btn-tpl-from-json">JSON → 빌더 반영</button>
                    </div>
                  </div>
                  <textarea id="tpl-json" class="lm-textarea" placeholder='{"name":"...","sections":[...]} 형태'></textarea>
                </div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

<script>
/* =========================================================
 * ✅ 설정: 배포 /exec 주소
 * ======================================================= */
const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbzj5LUEUKMyQqJfVsVlftO1f4CTYb3NhAQMT2QL6VADBlnjleAXLtBVVhuVHOfwkhQYqQ/exec";

/* =========================================================
 * ✅ 공통 유틸 (기존 방식: POST + URLSearchParams)
 * ======================================================= */
function setStatus(msg){
  document.getElementById('status').textContent = String(msg || '');
}
function gasUrl(){
  return document.getElementById('gas-url').value.trim();
}
async function gasGet(mode, params={}){
  const u = new URL(gasUrl());
  u.searchParams.set('mode', mode);
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  const res = await fetch(u.toString(), { method:'GET' });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(e){ json = { ok:false, message:'JSON parse 실패', raw:text }; }
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
  return json;
}
async function gasPost(mode, params={}){
  const body = new URLSearchParams();
  body.set('mode', mode);
  Object.keys(params).forEach(k => body.set(k, params[k]));
  const res = await fetch(gasUrl(), { method:'POST', body }); // ✅ headers 지정 없음
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(e){ json = { ok:false, message:'JSON parse 실패', raw:text }; }
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
  return json;
}
function escapeHtml(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

/* =========================================================
 * ✅ Tabs
 * ======================================================= */
const tabSections = document.getElementById('tab-sections');
const tabTemplates = document.getElementById('tab-templates');
const panelSections = document.getElementById('panel-sections');
const panelTemplates = document.getElementById('panel-templates');

function showTab(which){
  const isSec = which === 'sections';
  tabSections.setAttribute('aria-selected', String(isSec));
  tabTemplates.setAttribute('aria-selected', String(!isSec));
  panelSections.style.display = isSec ? '' : 'none';
  panelTemplates.style.display = isSec ? 'none' : '';
}
tabSections.addEventListener('click', () => { showTab('sections'); });
tabTemplates.addEventListener('click', () => { showTab('templates'); });

/* =========================================================
 * ✅ Sections UI
 * ======================================================= */
let activeSectionName = '';
let sectionsCache = []; // ✅ builder에서도 재사용

function renderSectionList(items){
  const box = document.getElementById('sec-list');
  box.innerHTML = '';
  if (!items || !items.length){
    box.innerHTML = '<div class="lm-item"><small>섹션이 없습니다.</small></div>';
    return;
  }
  items.forEach(it => {
    const el = document.createElement('div');
    el.className = 'lm-item' + (it.name === activeSectionName ? ' active' : '');
    el.innerHTML = `<div><b>${escapeHtml(it.name)}</b></div><small>${escapeHtml(it.url || '')}</small>`;
    el.addEventListener('click', async () => {
      activeSectionName = it.name;
      document.getElementById('sec-name').value = it.name;
      await loadSection_();
    });
    box.appendChild(el);
  });
}

function renderBuilderSectionList(items){
  const box = document.getElementById('builder-sec-list');
  box.innerHTML = '';
  if (!items || !items.length){
    box.innerHTML = '<div class="lm-item"><small>섹션이 없습니다.</small></div>';
    return;
  }
  items.forEach(it => {
    const el = document.createElement('div');
    el.className = 'lm-item';
    el.innerHTML = `
      <div class="lm-row" style="justify-content:space-between;">
        <div><b>${escapeHtml(it.name)}</b></div>
        <button class="lm-btn" data-add="${escapeHtml(it.name)}">추가</button>
      </div>
      <small>${escapeHtml(it.url || '')}</small>
    `;
    el.querySelector('button[data-add]').addEventListener('click', () => {
      builderAddSection_(it.name);
    });
    box.appendChild(el);
  });
}

async function refreshSections_(){
  setStatus('섹션 목록 불러오는 중...');
  const r = await gasGet('listSections');
  if (!r.ok) throw new Error(r.message || 'listSections 실패');
  sectionsCache = (r.items || []);
  renderSectionList(sectionsCache);
  renderBuilderSectionList(sectionsCache);
  setStatus(`섹션 ${r.total || sectionsCache.length}개 로드 완료`);
}

async function loadSection_(){
  const name = document.getElementById('sec-name').value.trim();
  if (!name){ setStatus('name이 비어있습니다'); return; }

  setStatus('섹션 불러오는 중...');
  const r = await gasGet('getSection', { name });
  if (!r.ok) throw new Error(r.message || 'getSection 실패');
  document.getElementById('sec-html').value = r.html || '';
  activeSectionName = name;
  await refreshSections_();
  setStatus(`섹션 로드 완료: ${name}`);
}

async function saveSection_(){
  let name = document.getElementById('sec-name').value.trim();
  const html = document.getElementById('sec-html').value;

  if (!name){ setStatus('name이 비어있습니다'); return; }
  if (!/\.html$/i.test(name)) name = name + '.html';
  if (!html){ setStatus('html이 비어있습니다'); return; }

  setStatus('섹션 저장 중...');
  const r = await gasPost('sectionUpsert', { name, html });
  if (!r.ok) throw new Error(r.message || 'sectionUpsert 실패');
  activeSectionName = name;
  await refreshSections_();
  setStatus(`섹션 저장 완료: ${name}`);
}

/* =========================================================
 * ✅ Templates UI
 * ======================================================= */
let activeTemplateId = '';

function renderTemplateList(items){
  const box = document.getElementById('tpl-list');
  box.innerHTML = '';
  if (!items || !items.length){
    box.innerHTML = '<div class="lm-item"><small>템플릿이 없습니다.</small></div>';
    return;
  }
  items.forEach(it => {
    const el = document.createElement('div');
    const tid = it.id || (it.name || '').replace(/\.json$/i,'');
    el.className = 'lm-item' + (tid === activeTemplateId ? ' active' : '');
    el.innerHTML = `<div><b>${escapeHtml(tid)}</b></div><small>${escapeHtml(it.url || '')}</small>`;
    el.addEventListener('click', async () => {
      activeTemplateId = tid;
      document.getElementById('tpl-id').value = tid;
      await loadTemplate_();
    });
    box.appendChild(el);
  });
}

async function refreshTemplates_(){
  setStatus('템플릿 목록 불러오는 중...');
  const r = await gasGet('listTemplates');
  if (!r.ok) throw new Error(r.message || 'listTemplates 실패');
  renderTemplateList(r.items || []);
  setStatus(`템플릿 ${r.total || (r.items||[]).length}개 로드 완료`);
}

async function loadTemplate_(){
  const template_id = document.getElementById('tpl-id').value.trim();
  if (!template_id){ setStatus('template_id가 비어있습니다'); return; }

  setStatus('템플릿 불러오는 중...');
  const r = await gasGet('getTemplate', { template_id });
  if (!r.ok) throw new Error(r.message || 'getTemplate 실패');
  document.getElementById('tpl-json').value = r.json || '';
  activeTemplateId = template_id;

  // ✅ 로드한 JSON을 빌더에도 반영
  builderApplyFromJson_();

  await refreshTemplates_();
  setStatus(`템플릿 로드 완료: ${template_id}`);
}

async function saveTemplate_(){
  const template_id = document.getElementById('tpl-id').value.trim();
  const json = document.getElementById('tpl-json').value;

  if (!template_id){ setStatus('template_id가 비어있습니다'); return; }
  if (!json.trim()){ setStatus('json이 비어있습니다'); return; }

  try { JSON.parse(json); } catch(e){
    setStatus('JSON 파싱 실패: ' + e.message);
    return;
  }

  setStatus('템플릿 저장 중...');
  const r = await gasPost('templateUpsert', { template_id, json, name:'' });
  if (!r.ok) throw new Error(r.message || 'templateUpsert 실패');
  activeTemplateId = template_id;
  await refreshTemplates_();
  setStatus(`템플릿 저장 완료: ${template_id}`);
}

function validateJson_(){
  const json = document.getElementById('tpl-json').value;
  try{ JSON.parse(json); setStatus('JSON OK'); }
  catch(e){ setStatus('JSON 오류: ' + e.message); }
}

/* =========================================================
 * ✅ Template Builder (섹션 조합 → JSON)
 * ======================================================= */
let builderSelected = []; // [{name:'year_nav.html', params:{...}}]
let builderActiveIndex = -1;

function builderRenderSelected_(){
  const box = document.getElementById('builder-selected-list');
  box.innerHTML = '';
  if (!builderSelected.length){
    box.innerHTML = '<div class="lm-item"><small>선택된 섹션이 없습니다.</small></div>';
    document.getElementById('builder-params').value = '{}';
    builderActiveIndex = -1;
    return;
  }

  builderSelected.forEach((it, idx) => {
    const el = document.createElement('div');
    el.className = 'lm-item' + (idx === builderActiveIndex ? ' active' : '');
    el.innerHTML = `
      <div class="lm-selected-row">
        <div>
          <b>${escapeHtml(it.name)}</b>
          <div class="lm-mini">${escapeHtml(JSON.stringify(it.params || {}))}</div>
        </div>
        <div class="lm-selected-actions">
          <button class="lm-btn" data-up="${idx}">▲</button>
          <button class="lm-btn" data-down="${idx}">▼</button>
          <button class="lm-btn" data-del="${idx}">삭제</button>
        </div>
      </div>
    `;

    el.addEventListener('click', (ev) => {
      // 버튼 클릭은 따로 처리
      if (ev.target && ev.target.closest('button')) return;
      builderActiveIndex = idx;
      document.getElementById('builder-params').value = JSON.stringify(builderSelected[idx].params || {}, null, 2);
      builderRenderSelected_();
    });

    el.querySelector(`button[data-up="${idx}"]`).addEventListener('click', () => builderMove_(idx, -1));
    el.querySelector(`button[data-down="${idx}"]`).addEventListener('click', () => builderMove_(idx, +1));
    el.querySelector(`button[data-del="${idx}"]`).addEventListener('click', () => builderRemove_(idx));

    box.appendChild(el);
  });
}

function builderAddSection_(name){
  if (!name) return;
  builderSelected.push({ name, params:{} });
  builderActiveIndex = builderSelected.length - 1;
  document.getElementById('builder-params').value = JSON.stringify({}, null, 2);
  builderRenderSelected_();
  builderToJson_();
}

function builderRemove_(idx){
  if (idx < 0 || idx >= builderSelected.length) return;
  builderSelected.splice(idx, 1);
  if (!builderSelected.length){
    builderActiveIndex = -1;
  }else{
    builderActiveIndex = Math.min(idx, builderSelected.length - 1);
  }
  document.getElementById('builder-params').value =
    builderActiveIndex >= 0 ? JSON.stringify(builderSelected[builderActiveIndex].params || {}, null, 2) : '{}';
  builderRenderSelected_();
  builderToJson_();
}

function builderMove_(idx, delta){
  const j = idx + delta;
  if (idx < 0 || idx >= builderSelected.length) return;
  if (j < 0 || j >= builderSelected.length) return;
  const tmp = builderSelected[idx];
  builderSelected[idx] = builderSelected[j];
  builderSelected[j] = tmp;
  builderActiveIndex = j;
  document.getElementById('builder-params').value = JSON.stringify(builderSelected[builderActiveIndex].params || {}, null, 2);
  builderRenderSelected_();
  builderToJson_();
}

function builderValidateParams_(){
  const t = document.getElementById('builder-params').value || '';
  try{
    const o = JSON.parse(t);
    if (typeof o !== 'object' || o === null || Array.isArray(o)){
      setStatus('params는 객체(JSON object)여야 합니다. 예: {"KEY":"VALUE"}');
      return null;
    }
    setStatus('params JSON OK');
    return o;
  }catch(e){
    setStatus('params JSON 오류: ' + e.message);
    return null;
  }
}

function builderApplyParams_(){
  if (builderActiveIndex < 0 || builderActiveIndex >= builderSelected.length){
    setStatus('params를 적용할 섹션이 선택되지 않았습니다.');
    return;
  }
  const o = builderValidateParams_();
  if (!o) return;
  builderSelected[builderActiveIndex].params = o;
  builderRenderSelected_();
  builderToJson_();
}

function builderToJson_(){
  const template_id = document.getElementById('tpl-id').value.trim() || '';
  const manifest = {
    name: template_id || '',
    sections: builderSelected.map(s => ({ name: s.name, params: s.params || {} }))
  };
  document.getElementById('tpl-json').value = JSON.stringify(manifest, null, 2);
}

function builderApplyFromJson_(){
  const t = document.getElementById('tpl-json').value || '';
  let j;
  try{ j = JSON.parse(t); }
  catch(e){ setStatus('JSON → 빌더 반영 실패(파싱): ' + e.message); return; }

  const arr = Array.isArray(j.sections) ? j.sections : [];
  builderSelected = arr.map(x => ({
    name: String(x.name || '').trim(),
    params: (x.params && typeof x.params === 'object' && !Array.isArray(x.params)) ? x.params : {}
  })).filter(x => x.name);

  builderActiveIndex = builderSelected.length ? 0 : -1;
  document.getElementById('builder-params').value =
    builderActiveIndex >= 0 ? JSON.stringify(builderSelected[builderActiveIndex].params || {}, null, 2) : '{}';

  builderRenderSelected_();
  setStatus('JSON → 빌더 반영 완료');
}

/* =========================================================
 * ✅ misc
 * ======================================================= */
async function runDiag_(){
  setStatus('diag 호출 중...');
  const r = await gasGet('diag');
  setStatus(JSON.stringify(r, null, 2));
}

async function reloadCurrent_(){
  const isSec = tabSections.getAttribute('aria-selected') === 'true';
  if (isSec) await refreshSections_();
  else await refreshTemplates_();
}

/* =========================================================
 * ✅ init
 * ======================================================= */
(function init(){
  // header/menu slot 유지
  try{
    if (window.AdminCommon && typeof window.AdminCommon.renderShell === 'function'){
      window.AdminCommon.renderShell({
        headerSlotId: 'admin-header-slot',
        menuSlotId: 'admin-menu-slot',
        activeMenu: 'library_manage'
      });
    }
  }catch(_){}

  document.getElementById('gas-url').value = DEFAULT_GAS_URL;

  // common buttons
  document.getElementById('btn-diag').addEventListener('click', () => runDiag_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('btn-reload').addEventListener('click', () => reloadCurrent_().catch(e => setStatus(String(e.message||e))));

  // sections
  document.getElementById('sec-new').addEventListener('click', () => {
    activeSectionName = '';
    document.getElementById('sec-name').value = '';
    document.getElementById('sec-html').value = '';
    setStatus('새 섹션 작성 준비');
    refreshSections_().catch(e => setStatus(String(e.message||e)));
  });
  document.getElementById('sec-load').addEventListener('click', () => loadSection_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('sec-save').addEventListener('click', () => saveSection_().catch(e => setStatus(String(e.message||e))));

  // templates
  document.getElementById('tpl-new').addEventListener('click', () => {
    activeTemplateId = '';
    document.getElementById('tpl-id').value = '';
    document.getElementById('tpl-json').value = '';
    builderSelected = [];
    builderActiveIndex = -1;
    builderRenderSelected_();
    setStatus('새 템플릿 작성 준비');
    refreshTemplates_().catch(e => setStatus(String(e.message||e)));
  });
  document.getElementById('tpl-load').addEventListener('click', () => loadTemplate_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('tpl-save').addEventListener('click', () => saveTemplate_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('tpl-validate').addEventListener('click', validateJson_);
  document.getElementById('btn-tpl-from-json').addEventListener('click', builderApplyFromJson_);

  // builder
  document.getElementById('btn-refresh-sections-for-builder').addEventListener('click', () => refreshSections_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('btn-builder-clear').addEventListener('click', () => {
    builderSelected = [];
    builderActiveIndex = -1;
    builderRenderSelected_();
    builderToJson_();
    setStatus('빌더 비움 완료');
  });
  document.getElementById('btn-builder-to-json').addEventListener('click', () => {
    builderToJson_();
    setStatus('빌더 → JSON 반영 완료');
  });
  document.getElementById('btn-builder-apply-params').addEventListener('click', builderApplyParams_);
  document.getElementById('btn-builder-params-validate').addEventListener('click', builderValidateParams_);

  // first load
  refreshSections_().catch(e => setStatus(String(e.message||e)));
})();
</script>
</body>
</html>
