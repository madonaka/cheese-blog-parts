<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Manage</title>

  <!-- ✅ 관리자 공통 CSS 유지 -->
  <link rel="stylesheet" href="./admin.css" />
  <!-- ✅ 기존 방식 유지: 헤더/메뉴 슬롯 렌더 -->
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap{ padding:14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab-btn{
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .tab-btn.active{ outline:2px solid rgba(59,130,246,.35); }

    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      margin-bottom:12px;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input, .select, .textarea{
      border:1px solid rgba(15,23,42,0.16);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      min-height:42px;
      outline:none;
    }
    .textarea{ width:100%; min-height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#0f172a;
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.secondary{ background:#fff; color:#0f172a; }
    .mini-btn{
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
    }

    .muted{ color:rgba(15,23,42,0.65); font-size:13px; }
    .hr{ height:1px; background:rgba(15,23,42,0.10); margin:12px 0; }
    .pill{
      font-size:12px;
      background:rgba(15,23,42,0.06);
      border:1px solid rgba(15,23,42,0.10);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(15,23,42,0.12);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .name{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:520px;
    }
    .meta{
      font-size:12px;
      color:rgba(15,23,42,0.55);
      margin-top:2px;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div id="adminHeaderMount"></div>

  <div class="lm-wrap">
    <div class="tabs">
      <button class="tab-btn active" data-tab="library">섹션 라이브러리</button>
      <button class="tab-btn" data-tab="selected">선택된 섹션</button>
      <button class="tab-btn" data-tab="export">내보내기/미리보기</button>
      <span class="pill">LIB</span>
      <span class="muted">섹션(드라이브 파일)을 선택/정렬하고 manifest(JSON)를 생성</span>
    </div>

    <!-- TAB: library -->
    <div id="tab-library" class="card">
      <div class="row">
        <input id="q" class="input" placeholder="검색(파일명)" style="flex:1; min-width:240px;" />
        <button class="btn secondary" id="btnSearch">검색</button>
        <button class="btn secondary" id="btnRefresh">새로고침</button>
        <span class="muted" id="libInfo"></span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="row" style="justify-content:space-between;">
            <div class="muted">라이브러리 목록</div>
            <div class="muted">추가 버튼으로 선택 목록에 담기</div>
          </div>
          <div class="list" id="libList" style="margin-top:10px;"></div>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;">
            <div class="muted">선택된 섹션(미리)</div>
            <div class="muted">총 <b id="selCountMini">0</b>개</div>
          </div>
          <div class="list" id="selListMini" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- TAB: selected -->
    <div id="tab-selected" class="card hidden">
      <div class="row">
        <span class="pill">SELECTED</span>
        <span class="muted">총 <b id="selCount">0</b>개</span>
        <div style="flex:1"></div>
        <button class="btn secondary" id="btnClearSelected">전체 비우기</button>
        <button class="btn secondary" id="btnAutoBodySlots">BODY 슬롯 자동지정</button>
      </div>

      <div class="hr"></div>
      <div class="list" id="selList"></div>

      <div class="hr"></div>
      <div class="muted">
        - <b>SLOT</b>은 섹션 HTML 안에 <code>{{BODY}}</code>가 있을 때 의미가 있습니다(치환 대상).<br>
        - <b>이미지 섹션</b>은 보통 SLOT이 아니라 <b>IMG_* vars</b>(예: IMG_SRC, IMG_HREF)를 사용합니다.
      </div>
    </div>

    <!-- TAB: export -->
    <div id="tab-export" class="card hidden">
      <div class="row">
        <span class="pill">EXPORT</span>
        <span class="muted">선택된 섹션 목록으로 manifest(JSON) 생성</span>
        <div style="flex:1"></div>
        <button class="btn secondary" id="btnCopyJson">JSON 복사</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="muted" style="margin-bottom:6px;">manifest(JSON)</div>
          <textarea id="outJson" class="textarea" spellcheck="false"></textarea>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">렌더 미리보기(섹션 리스트)</div>
          <textarea id="outPreview" class="textarea" spellcheck="false"></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="muted">
        - 생성된 JSON은 post_manage에서 템플릿/manifest로 사용합니다.<br>
        - 각 섹션은 <code>{ name, file_id/url, vars }</code> 형태로 들어가며 vars는 JSON object 입니다.
      </div>
    </div>
  </div>

  <script>
  /*******************************
   * CONFIG / STATE
   *******************************/
  const API_BASE = (window.ADMIN_API_BASE || "").trim(); // admin-common.js에서 세팅될 수 있음
  const SELECTED = []; // [{name, file_id, url, varsText}]
  let LIB_CACHE = [];  // [{name, file_id, url}...]

  function $(id){ return document.getElementById(id); }

  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  /*******************************
   * TAB UI
   *******************************/
  const tabBtns = Array.from(document.querySelectorAll(".tab-btn"));
  tabBtns.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabBtns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.getAttribute("data-tab");
      $("tab-library").classList.toggle("hidden", tab!=="library");
      $("tab-selected").classList.toggle("hidden", tab!=="selected");
      $("tab-export").classList.toggle("hidden", tab!=="export");
      if (tab==="export") updateJsonPreviewSafe_();
      if (tab==="selected") renderSelected();
      if (tab==="library") renderMiniSelected();
    });
  });

  /*******************************
   * API HELPERS
   *******************************/
  async function apiGet_(path){
    if (!API_BASE) throw new Error("API_BASE가 비어있습니다.");
    const url = API_BASE.replace(/\/$/,"") + path;
    const r = await fetch(url, { method:"GET" });
    const j = await r.json();
    if (!j || j.ok===false) throw new Error(j?.error || "API error");
    return j;
  }

  // 섹션 목록 불러오기(Drive)
  async function fetchLibrary_(){
    // 서버는 프로젝트에 따라 다를 수 있음: /sections/list 형태 가정
    // 필요 시 admin-common.js에서 ADMIN_API_BASE를 맞춰야 함
    // 응답 예: {ok:true, items:[{name,file_id,url},...]}
    const j = await apiGet_("/sections/list");
    return Array.isArray(j.items) ? j.items : [];
  }

  // 섹션 파일 내용 불러오기
  async function fetchSectionHtml_(name){
    // 응답 예: {ok:true, html:"..."}
    const q = encodeURIComponent(name);
    const j = await apiGet_(`/sections/get?name=${q}`);
    return String(j.html || "");
  }

  async function isBodySection_(name){
    const html = await fetchSectionHtml_(name);
    return /{{\s*BODY\s*}}/i.test(html);
  }

  /*******************************
   * RENDER: LIBRARY LIST
   *******************************/
  function renderLibraryList(items){
    const list = $("libList");
    list.innerHTML = "";
    $("libInfo").textContent = items.length ? `${items.length}개` : "0개";

    items.forEach(s=>{
      const row = document.createElement("div");
      row.className = "item";

      row.innerHTML = `
        <div style="min-width:0;">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="meta">${escapeHtml(s.url || s.file_id || "")}</div>
        </div>
        <div style="flex:1"></div>
        <button class="mini-btn" data-act="add">추가</button>
      `;
      row.querySelector('[data-act="add"]').addEventListener("click", ()=>{
        SELECTED.push({ name: s.name, varsText: "" });
        renderSelected();
        renderMiniSelected();
        updateJsonPreviewSafe_();
      });
      list.appendChild(row);
    });
  }

  function renderMiniSelected(){
    $("selCountMini").textContent = String(SELECTED.length);
    const list = $("selListMini");
    list.innerHTML = "";

    SELECTED.slice(0, 12).forEach((s, idx)=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div style="min-width:0;">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="meta">#${idx+1}</div>
        </div>
        <div style="flex:1"></div>
        <button class="mini-btn" data-act="rm">제거</button>
      `;
      row.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
        SELECTED.splice(idx,1);
        renderMiniSelected();
        updateJsonPreviewSafe_();
      });
      list.appendChild(row);
    });

    if (SELECTED.length > 12){
      const more = document.createElement("div");
      more.className = "muted";
      more.textContent = `... +${SELECTED.length-12}개 더`;
      list.appendChild(more);
    }
  }

  function filterLibrary_(q){
    const t = String(q||"").trim().toLowerCase();
    if (!t) return LIB_CACHE.slice();
    return LIB_CACHE.filter(x=>String(x.name||"").toLowerCase().includes(t));
  }

  /*******************************
   * vars helpers
   *******************************/
  function varsSummary_(varsText){
    const t = (varsText || "").trim();
    if (!t) return "";
    try{
      const o = JSON.parse(t);
      if (!o || typeof o !== "object") return "";
      const keys = Object.keys(o);
      if (!keys.length) return "";
      const pairs = keys.slice(0,4).map(k=>`${k}=${String(o[k])}`);
      const more = keys.length > 4 ? ` …(+${keys.length-4})` : "";
      return pairs.join(", ") + more;
    }catch(_){
      return "vars(JSON) 오류";
    }
  }

  function parseVarsStrict_(varsText, hint){
    const t = (varsText || "").trim();
    if (!t) return undefined;
    try{
      const v = JSON.parse(t);
      if (!v || typeof v !== "object" || Array.isArray(v)) {
        throw new Error("vars는 객체(JSON object)여야 합니다.");
      }
      return v;
    }catch(e){
      throw new Error(`${hint} vars JSON 파싱 실패: ${e.message || e}`);
    }
  }

  function findMaxBodySlotNumber_(){
    let maxN = 0;
    for (const s of (SELECTED || [])){
      const t = (s.varsText || "").trim();
      if (!t) continue;
      try{
        const v = JSON.parse(t);
        const slot = String(v?.SLOT || "").trim();
        const m = slot.match(/^BODY_(\d+)$/i);
        if (m){
          const n = parseInt(m[1], 10);
          if (!isNaN(n)) maxN = Math.max(maxN, n);
        }
      }catch(_){}
    }
    return maxN;
  }

  function findMaxSlotNumber_(prefix){
    const p = String(prefix || "").trim().toUpperCase();
    if (!p) return 0;

    let maxN = 0;
    for (const s of (SELECTED || [])){
      const t = (s.varsText || "").trim();
      if (!t) continue;
      try{
        const v = JSON.parse(t);
        const slot = String(v?.SLOT || "").trim().toUpperCase();
        const m = slot.match(new RegExp(`^${p}_(\\d+)$`));
        if (m){
          const n = parseInt(m[1], 10);
          if (!isNaN(n)) maxN = Math.max(maxN, n);
        }
      }catch(_){}
    }
    return maxN;
  }

  // ✅ 파일명 규칙으로 "이미지 섹션" 판별(필요하면 규칙 확장)
  function isImageSectionName_(secName){
    const n = String(secName || "").toLowerCase();
    // 프로젝트 기준: cheese_img_... / img / image 같은 이름이면 이미지로 간주
    return n.includes("cheese_img") || n.includes("_img") || n.includes("img_") || n.includes("image") || n.includes("img");
  }

  function setSlotOnItem_(idx, slotName){
    const it = SELECTED[idx];
    if (!it) return;

    let v = {};
    try{ v = it.varsText ? JSON.parse(it.varsText) : {}; }catch(_){ v = {}; }
    if (!v || typeof v !== "object" || Array.isArray(v)) v = {};
    v.SLOT = String(slotName||"").trim();
    it.varsText = JSON.stringify(v, null, 2);
  }

  /*******************************
   * RENDER: SELECTED LIST
   *******************************/
  function renderSelected(){
    const list = $("selList");
    list.innerHTML = "";
    $("selCount").textContent = String(SELECTED.length);

    SELECTED.forEach((s, idx)=>{
      const row = document.createElement("div");
      row.className = "item";

      const isImg = isImageSectionName_(s.name); // ✅ 이미지 섹션이면 IMG vars 버튼 노출
      const vs = varsSummary_(s.varsText);
      const meta = `#${idx+1}` + (vs ? ` · ${vs}` : "");

      row.innerHTML = `
        <div style="min-width:0;">
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="meta">${escapeHtml(meta)}</div>
        </div>
        <div style="flex:1"></div>
        <button class="mini-btn" data-act="up">↑</button>
        <button class="mini-btn" data-act="down">↓</button>
        ${isImg
          ? `<button class="mini-btn" data-act="imgvars">IMG</button>`
          : `<button class="mini-btn" data-act="slot">SLOT</button>`
        }
        <button class="mini-btn" data-act="vars">vars</button>
        <button class="mini-btn" data-act="rm">제거</button>
      `;

      row.querySelector('[data-act="up"]').addEventListener("click", ()=>{
        if (idx<=0) return;
        const t = SELECTED[idx-1]; SELECTED[idx-1]=SELECTED[idx]; SELECTED[idx]=t;
        renderSelected();
        updateJsonPreviewSafe_();
      });
      row.querySelector('[data-act="down"]').addEventListener("click", ()=>{
        if (idx>=SELECTED.length-1) return;
        const t = SELECTED[idx+1]; SELECTED[idx+1]=SELECTED[idx]; SELECTED[idx]=t;
        renderSelected();
        updateJsonPreviewSafe_();
      });
      row.querySelector('[data-act="rm"]').addEventListener("click", ()=>{
        SELECTED.splice(idx,1);
        renderSelected();
        updateJsonPreviewSafe_();
      });

      // ✅ BODY 슬롯만 자동 할당 (BODY_1, BODY_2...)
      if (!isImg){
        row.querySelector('[data-act="slot"]').addEventListener("click", async ()=>{
          // {{BODY}} 없는 섹션에 SLOT 지정하면 post_manage에서 치환이 안 되므로 경고
          const ok = await isBodySection_(s.name);
          if (!ok){
            const go = confirm(`"${s.name}" 섹션 HTML에서 {{BODY}}를 찾지 못했습니다.\n그래도 BODY SLOT을 지정할까요?`);
            if (!go) return;
          }
          const next = findMaxSlotNumber_("BODY") + 1;
          setSlotOnItem_(idx, `BODY_${next}`);
          renderSelected();
          updateJsonPreviewSafe_();
        });
      }

      // ✅ 이미지 섹션은 SLOT이 아니라 "이미지용 vars" 스켈레톤을 생성
      if (isImg){
        row.querySelector('[data-act="imgvars"]').addEventListener("click", ()=>{
          // 기본 스켈레톤(필요한 키만 남기거나 추가해도 됨)
          const skeleton = {
            "IMG_ID":"",
            "IMG_SRC":"",
            "IMG_HREF":"",
            "IMG_OW":"",
            "IMG_OH":"",
            "IMG_ALT":"",
            "IMG_TITLE":"",
            "IMG_SNIPPET":"",
            "ZOOM_LABEL":""
          };

          // 기존 vars가 있으면 유지하면서 빈 키만 보완
          let base = {};
          try{ base = s.varsText ? JSON.parse(s.varsText) : {}; }catch(_){ base = {}; }
          const merged = { ...skeleton, ...base };

          const hint =
`이미지 섹션 vars(JSON)
- 이 vars는 섹션 HTML 안의 {{IMG_SRC}} 같은 토큰을 채우는 용도입니다.
- 비우면 삭제.
예: {"IMG_ID":"IMG000123","IMG_SRC":"https://...","IMG_HREF":"https://..."}`;
          const v = prompt(hint, JSON.stringify(merged, null, 2));
          if (v===null) return;
          s.varsText = v.trim();
          renderSelected();
          updateJsonPreviewSafe_();
        });
      }

      row.querySelector('[data-act="vars"]').addEventListener("click", ()=>{
        const hint = `vars(JSON) 입력. 비우면 삭제.\n예: {"SLOT":"BODY_1"}\n또는: {"SLOT":"BODY_2","YEAR":"2026"}\n\n이미지 섹션은 보통 IMG_* 키(예: IMG_SRC)를 사용합니다.`;
        const v = prompt(hint, s.varsText || "");
        if (v===null) return;
        s.varsText = v.trim();
        renderSelected();
        updateJsonPreviewSafe_();
      });

      list.appendChild(row);
    });
  }

  function renderOutputPreview_(manifest){
    const sec = Array.isArray(manifest?.sections) ? manifest.sections : [];
    const lines = [];
    sec.forEach((s, i)=>{
      if (typeof s === "string") lines.push(`${i+1}. ${s}`);
      else lines.push(`${i+1}. ${s.name}  vars=${JSON.stringify(s.vars||{})}`);
    });
    return lines.join("\n");
  }

  function buildManifest_(){
    // 섹션 이름 + vars를 포함하는 manifest
    const sections = SELECTED.map(s=>{
      const vars = parseVarsStrict_(s.varsText, s.name) || undefined;
      const o = { name: s.name };
      if (vars) o.vars = vars;
      return o;
    });
    return { sections };
  }

  function updateJsonPreviewSafe_(){
    try{
      const man = buildManifest_();
      $("outJson").value = JSON.stringify(man, null, 2);
      $("outPreview").value = renderOutputPreview_(man);
    }catch(e){
      $("outJson").value = `오류: ${e.message || e}`;
      $("outPreview").value = "";
    }
  }

  /*******************************
   * ACTIONS
   *******************************/
  $("btnSearch").addEventListener("click", ()=>{
    const items = filterLibrary_($("q").value);
    renderLibraryList(items);
  });
  $("btnRefresh").addEventListener("click", async ()=>{
    await loadLibrary_();
  });
  $("q").addEventListener("keydown", (e)=>{
    if (e.key==="Enter") $("btnSearch").click();
  });

  $("btnClearSelected").addEventListener("click", ()=>{
    if (!confirm("선택된 섹션을 모두 비울까요?")) return;
    SELECTED.splice(0, SELECTED.length);
    renderSelected();
    renderMiniSelected();
    updateJsonPreviewSafe_();
  });

  $("btnAutoBodySlots").addEventListener("click", async ()=>{
    if (!SELECTED.length) return;
    let n = findMaxBodySlotNumber_();
    for (let i=0; i<SELECTED.length; i++){
      const item = SELECTED[i];
      const t = (item.varsText || "").trim();
      if (t){
        try{
          const v = JSON.parse(t);
          if (v && typeof v === "object" && String(v.SLOT || "").trim()) continue;
        }catch(_){}
      }
      const ok = await isBodySection_(item.name);
      if (!ok) continue;

      n += 1;
      setSlotOnItem_(i, `BODY_${n}`);
    }
    renderSelected();
    updateJsonPreviewSafe_();
    alert("BODY 슬롯 자동지정 완료(가능한 항목만 적용).");
  });

  $("btnCopyJson").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText($("outJson").value || "");
      alert("JSON 복사 완료");
    }catch(e){
      alert("복사 실패: " + (e.message||e));
    }
  });

  /*******************************
   * INIT
   *******************************/
  async function loadLibrary_(){
    try{
      $("libInfo").textContent = "불러오는 중...";
      const items = await fetchLibrary_();
      LIB_CACHE = items;
      renderLibraryList(items);
      renderMiniSelected();
      $("libInfo").textContent = `${items.length}개`;
    }catch(e){
      $("libInfo").textContent = "오류";
      alert("라이브러리 불러오기 실패: " + (e.message||e));
    }
  }

  // header mount (admin-common.js)
  try{
    if (window.renderAdminHeader) window.renderAdminHeader("library");
  }catch(_){}

  loadLibrary_();
  </script>
</body>
</html>
