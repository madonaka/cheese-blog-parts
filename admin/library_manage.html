<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>섹션/템플릿 관리 툴</title>

  <!-- ✅ 기존 관리자 CSS 재사용 -->
  <link rel="stylesheet" href="./admin.css" />
  <script src="./admin-common.js"></script>

  <style>
    .lm-wrap{ padding:14px; }
    .lm-card{
      background:#fff;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .lm-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .lm-col{ display:flex; flex-direction:column; gap:10px; }
    .lm-split{ display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start; }
    @media (max-width: 980px){ .lm-split{ grid-template-columns: 1fr; } }

    .lm-tabs{ display:flex; gap:8px; }
    .lm-tab{
      appearance:none; border:1px solid rgba(15,23,42,0.14);
      background:#fff; padding:10px 12px; border-radius:12px;
      font-weight:800; cursor:pointer;
    }
    .lm-tab[aria-selected="true"]{ border-color: rgba(15,23,42,0.35); box-shadow:0 8px 20px rgba(15,23,42,0.08); }

    .lm-input, .lm-select, .lm-textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      outline:none;
    }
    .lm-textarea{ min-height: 420px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:13px; }

    .lm-list{
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      overflow:hidden;
      max-height: 520px;
      overflow:auto;
    }
    .lm-item{
      display:flex; flex-direction:column; gap:4px;
      padding:10px 12px;
      border-top:1px solid rgba(15,23,42,0.08);
      cursor:pointer;
      background:#fff;
    }
    .lm-item:first-child{ border-top:none; }
    .lm-item:hover{ background:rgba(15,23,42,0.03); }
    .lm-item.active{ background:rgba(15,23,42,0.06); }
    .lm-item small{ opacity:0.7; }

    .lm-btn{
      appearance:none;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    .lm-btn.primary{
      border-color: rgba(15,23,42,0.35);
    }

    .lm-status{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.14);
      background: rgba(15,23,42,0.02);
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .lm-note{ font-size:13px; opacity:0.8; line-height:1.5; }
    .lm-k{ font-weight:900; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main class="admin-content">
        <div class="lm-wrap">

          <div class="lm-card">
            <div class="lm-row" style="justify-content:space-between;">
              <div class="lm-col" style="flex:1;">
                <div class="lm-tabs" role="tablist" aria-label="라이브러리 탭">
                  <button id="tab-sections" class="lm-tab" role="tab" aria-selected="true">섹션 라이브러리</button>
                  <button id="tab-templates" class="lm-tab" role="tab" aria-selected="false">템플릿 매니페스트</button>
                </div>
                <div class="lm-note">
                  <span class="lm-k">중요:</span> 저장/불러오기는 기존 관리자 페이지들과 동일하게
                  <span class="lm-k">POST + URLSearchParams</span>로 호출해서 CORS(OPTIONS) 문제를 최대한 피합니다.
                </div>
              </div>

              <div class="lm-row">
                <button class="lm-btn" id="btn-reload">목록 새로고침</button>
                <button class="lm-btn" id="btn-diag">diag</button>
              </div>
            </div>

            <div style="margin-top:10px;" class="lm-row">
              <label class="lm-label lm-k" style="min-width:64px;">GAS</label>
              <input id="gas-url" class="lm-input" />
            </div>

            <div style="margin-top:10px;" class="lm-status" id="status">대기</div>
          </div>

          <!-- ===== Sections ===== -->
          <section id="panel-sections" class="lm-card" role="tabpanel" aria-labelledby="tab-sections">
            <div class="lm-split">
              <div>
                <div class="lm-row" style="justify-content:space-between;">
                  <div class="lm-k">섹션 목록 (.html)</div>
                  <button class="lm-btn" id="sec-new">새 섹션</button>
                </div>
                <div class="lm-list" id="sec-list" style="margin-top:10px;"></div>
              </div>

              <div>
                <div class="lm-row">
                  <div style="flex:1;">
                    <div class="lm-k">섹션 파일명</div>
                    <input id="sec-name" class="lm-input" placeholder="예: year_nav.html" />
                  </div>
                  <div class="lm-row" style="margin-top:18px;">
                    <button class="lm-btn" id="sec-load">불러오기</button>
                    <button class="lm-btn primary" id="sec-save">저장</button>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <div class="lm-k">HTML</div>
                  <textarea id="sec-html" class="lm-textarea" placeholder="섹션 HTML 조각을 입력하세요"></textarea>
                </div>
              </div>
            </div>
          </section>

          <!-- ===== Templates ===== -->
          <section id="panel-templates" class="lm-card" role="tabpanel" aria-labelledby="tab-templates" style="display:none;">
            <div class="lm-split">
              <div>
                <div class="lm-row" style="justify-content:space-between;">
                  <div class="lm-k">템플릿 목록 (.json)</div>
                  <button class="lm-btn" id="tpl-new">새 템플릿</button>
                </div>
                <div class="lm-list" id="tpl-list" style="margin-top:10px;"></div>
              </div>

              <div>
                <div class="lm-row">
                  <div style="flex:1;">
                    <div class="lm-k">template_id</div>
                    <input id="tpl-id" class="lm-input" placeholder="예: genealogy_v1" />
                    <div class="lm-note" style="margin-top:6px;">실제 파일명은 <b>template_id + .json</b> 으로 저장됩니다.</div>
                  </div>
                  <div class="lm-row" style="margin-top:18px;">
                    <button class="lm-btn" id="tpl-load">불러오기</button>
                    <button class="lm-btn primary" id="tpl-save">저장</button>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <div class="lm-row" style="justify-content:space-between;">
                    <div class="lm-k">JSON</div>
                    <button class="lm-btn" id="tpl-validate">JSON 검증</button>
                  </div>
                  <textarea id="tpl-json" class="lm-textarea" placeholder='{"name":"...","sections":[...]} 형태로 입력'></textarea>
                </div>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

<script>
/* =========================================================
 * ✅ 설정: 너의 배포 /exec 주소
 * ======================================================= */
const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbzj5LUEUKMyQqJfVsVlftO1f4CTYb3NhAQMT2QL6VADBlnjleAXLtBVVhuVHOfwkhQYqQ/exec";

/* =========================================================
 * ✅ 공통 유틸 (기존 방식: POST + URLSearchParams, headers 없음)
 * ======================================================= */
function setStatus(msg){
  document.getElementById('status').textContent = String(msg || '');
}

function gasUrl(){
  return document.getElementById('gas-url').value.trim();
}

async function gasGet(mode, params={}){
  const u = new URL(gasUrl());
  u.searchParams.set('mode', mode);
  Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
  const res = await fetch(u.toString(), { method:'GET' });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(e){ json = { ok:false, message:'JSON parse 실패', raw:text }; }
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
  return json;
}

async function gasPost(mode, params={}){
  const body = new URLSearchParams();
  body.set('mode', mode);
  Object.keys(params).forEach(k => body.set(k, params[k]));
  const res = await fetch(gasUrl(), { method:'POST', body }); // ✅ headers 지정 없음
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(e){ json = { ok:false, message:'JSON parse 실패', raw:text }; }
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
  return json;
}

/* =========================================================
 * ✅ Tabs
 * ======================================================= */
const tabSections = document.getElementById('tab-sections');
const tabTemplates = document.getElementById('tab-templates');
const panelSections = document.getElementById('panel-sections');
const panelTemplates = document.getElementById('panel-templates');

function showTab(which){
  const isSec = which === 'sections';
  tabSections.setAttribute('aria-selected', String(isSec));
  tabTemplates.setAttribute('aria-selected', String(!isSec));
  panelSections.style.display = isSec ? '' : 'none';
  panelTemplates.style.display = isSec ? 'none' : '';
}
tabSections.addEventListener('click', () => { showTab('sections'); });
tabTemplates.addEventListener('click', () => { showTab('templates'); });

/* =========================================================
 * ✅ Sections UI
 * ======================================================= */
let activeSectionName = '';

function renderSectionList(items){
  const box = document.getElementById('sec-list');
  box.innerHTML = '';
  if (!items || !items.length){
    box.innerHTML = '<div class="lm-item"><small>섹션이 없습니다.</small></div>';
    return;
  }

  items.forEach(it => {
    const el = document.createElement('div');
    el.className = 'lm-item' + (it.name === activeSectionName ? ' active' : '');
    el.innerHTML = `<div><b>${escapeHtml(it.name)}</b></div><small>${escapeHtml(it.url || '')}</small>`;
    el.addEventListener('click', async () => {
      activeSectionName = it.name;
      document.getElementById('sec-name').value = it.name;
      await loadSection_();
    });
    box.appendChild(el);
  });
}

async function refreshSections_(){
  setStatus('섹션 목록 불러오는 중...');
  const r = await gasGet('listSections');
  if (!r.ok) throw new Error(r.message || 'listSections 실패');
  renderSectionList(r.items || []);
  setStatus(`섹션 ${r.total || (r.items||[]).length}개 로드 완료`);
}

async function loadSection_(){
  const name = document.getElementById('sec-name').value.trim();
  if (!name){ setStatus('name이 비어있습니다'); return; }

  setStatus('섹션 불러오는 중...');
  const r = await gasGet('getSection', { name });
  if (!r.ok) throw new Error(r.message || 'getSection 실패');
  document.getElementById('sec-html').value = r.html || '';
  activeSectionName = name;
  await refreshSections_();
  setStatus(`섹션 로드 완료: ${name}`);
}

async function saveSection_(){
  let name = document.getElementById('sec-name').value.trim();
  const html = document.getElementById('sec-html').value;

  if (!name){ setStatus('name이 비어있습니다'); return; }
  if (!/\.html$/i.test(name)) name = name + '.html';
  if (!html){ setStatus('html이 비어있습니다'); return; }

  setStatus('섹션 저장 중...');
  // ✅ 핵심: JSON이 아니라 URLSearchParams POST
  const r = await gasPost('sectionUpsert', { name, html });
  if (!r.ok) throw new Error(r.message || 'sectionUpsert 실패');
  activeSectionName = name;
  await refreshSections_();
  setStatus(`섹션 저장 완료: ${name}`);
}

/* =========================================================
 * ✅ Templates UI
 * ======================================================= */
let activeTemplateId = '';

function renderTemplateList(items){
  const box = document.getElementById('tpl-list');
  box.innerHTML = '';
  if (!items || !items.length){
    box.innerHTML = '<div class="lm-item"><small>템플릿이 없습니다.</small></div>';
    return;
  }

  items.forEach(it => {
    const el = document.createElement('div');
    const tid = it.id || (it.name || '').replace(/\.json$/i,'');
    el.className = 'lm-item' + (tid === activeTemplateId ? ' active' : '');
    el.innerHTML = `<div><b>${escapeHtml(tid)}</b></div><small>${escapeHtml(it.url || '')}</small>`;
    el.addEventListener('click', async () => {
      activeTemplateId = tid;
      document.getElementById('tpl-id').value = tid;
      await loadTemplate_();
    });
    box.appendChild(el);
  });
}

async function refreshTemplates_(){
  setStatus('템플릿 목록 불러오는 중...');
  const r = await gasGet('listTemplates');
  if (!r.ok) throw new Error(r.message || 'listTemplates 실패');
  renderTemplateList(r.items || []);
  setStatus(`템플릿 ${r.total || (r.items||[]).length}개 로드 완료`);
}

async function loadTemplate_(){
  const template_id = document.getElementById('tpl-id').value.trim();
  if (!template_id){ setStatus('template_id가 비어있습니다'); return; }

  setStatus('템플릿 불러오는 중...');
  const r = await gasGet('getTemplate', { template_id });
  if (!r.ok) throw new Error(r.message || 'getTemplate 실패');
  document.getElementById('tpl-json').value = r.json || '';
  activeTemplateId = template_id;
  await refreshTemplates_();
  setStatus(`템플릿 로드 완료: ${template_id}`);
}

async function saveTemplate_(){
  const template_id = document.getElementById('tpl-id').value.trim();
  const json = document.getElementById('tpl-json').value;

  if (!template_id){ setStatus('template_id가 비어있습니다'); return; }
  if (!json.trim()){ setStatus('json이 비어있습니다'); return; }

  // JSON 검증(저장 전에)
  try { JSON.parse(json); } catch(e){
    setStatus('JSON 파싱 실패: ' + e.message);
    return;
  }

  setStatus('템플릿 저장 중...');
  const r = await gasPost('templateUpsert', { template_id, json, name:'' });
  if (!r.ok) throw new Error(r.message || 'templateUpsert 실패');
  activeTemplateId = template_id;
  await refreshTemplates_();
  setStatus(`템플릿 저장 완료: ${template_id}`);
}

function validateJson_(){
  const json = document.getElementById('tpl-json').value;
  try{
    JSON.parse(json);
    setStatus('JSON OK');
  }catch(e){
    setStatus('JSON 오류: ' + e.message);
  }
}

/* =========================================================
 * ✅ misc
 * ======================================================= */
function escapeHtml(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

async function runDiag_(){
  setStatus('diag 호출 중...');
  const r = await gasGet('diag');
  setStatus(JSON.stringify(r, null, 2));
}

async function reloadCurrent_(){
  // 현재 탭 기준으로 새로고침
  const isSec = tabSections.getAttribute('aria-selected') === 'true';
  if (isSec) await refreshSections_();
  else await refreshTemplates_();
}

/* =========================================================
 * ✅ init
 * ======================================================= */
(function init(){
  // header/menu slot (admin-common.js가 제공하는 방식 그대로 사용한다고 가정)
  try{
    if (window.AdminCommon && typeof window.AdminCommon.renderShell === 'function'){
      window.AdminCommon.renderShell({
        headerSlotId: 'admin-header-slot',
        menuSlotId: 'admin-menu-slot',
        activeMenu: 'library_manage'
      });
    }
  }catch(_){}

  document.getElementById('gas-url').value = DEFAULT_GAS_URL;

  // buttons
  document.getElementById('btn-diag').addEventListener('click', runDiag_);
  document.getElementById('btn-reload').addEventListener('click', reloadCurrent_);

  // sections
  document.getElementById('sec-new').addEventListener('click', () => {
    activeSectionName = '';
    document.getElementById('sec-name').value = '';
    document.getElementById('sec-html').value = '';
    setStatus('새 섹션 작성 준비');
    refreshSections_().catch(e => setStatus(String(e.message||e)));
  });
  document.getElementById('sec-load').addEventListener('click', () => loadSection_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('sec-save').addEventListener('click', () => saveSection_().catch(e => setStatus(String(e.message||e))));

  // templates
  document.getElementById('tpl-new').addEventListener('click', () => {
    activeTemplateId = '';
    document.getElementById('tpl-id').value = '';
    document.getElementById('tpl-json').value = '';
    setStatus('새 템플릿 작성 준비');
    refreshTemplates_().catch(e => setStatus(String(e.message||e)));
  });
  document.getElementById('tpl-load').addEventListener('click', () => loadTemplate_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('tpl-save').addEventListener('click', () => saveTemplate_().catch(e => setStatus(String(e.message||e))));
  document.getElementById('tpl-validate').addEventListener('click', validateJson_);

  // first load
  refreshSections_().catch(e => setStatus(String(e.message||e)));
})();
</script>
</body>
</html>
