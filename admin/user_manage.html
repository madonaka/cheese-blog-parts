<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¸ì‚¬ ê´€ë¦¬ - Cheese Lab</title>
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* ì¸ì‚¬ ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ */
    .user-list-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .table-responsive { overflow-x: auto; }
    .user-table { width: 100%; border-collapse: collapse; text-align: left; }
    .user-table th { background: #f8fafc; padding: 15px; font-size: 0.8rem; text-transform: uppercase; color: #64748b; border-bottom: 1px solid #e2e8f0; }
    .user-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; color: #1a202c; }
    .user-table tr:last-child td { border-bottom: none; }
    .user-table tr:hover { background: #f1f5f9; }
    
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .status-1 { background: #dcfce7; color: #166534; } /* í™œì„± */
    .status-0 { background: #fee2e2; color: #991b1b; } /* ì°¨ë‹¨ */

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
    .modal-content { background: #fff; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full-width { grid-column: span 2; }
  </style>
  <script>
    // âœ… ìµœì‹  ë°°í¬ëœ ë¡œê·¸ì¸ API ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”!
    window.CHEESE_LOGIN_API = "https://script.google.com/macros/s/ì—¬ê¸°ì—_ë³¸ì¸ì˜_ìŠ¤í¬ë¦½íŠ¸_ID/exec";
  </script>
  <script src="./admin-common.js" defer></script>
</head>
<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <main class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      
      <section class="admin-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
          <div>
            <h2 style="margin:0;">ğŸ‘¤ ì¸ì‚¬ ê´€ë¦¬</h2>
            <p style="color:#718096; font-size:0.9rem; margin-top:5px;">ì‹œìŠ¤í…œì— ë“±ë¡ëœ ì „ì²´ ì‚¬ìš©ì ëª©ë¡ì…ë‹ˆë‹¤.</p>
          </div>
          <button class="btn-bbs" style="background:#1a202c; color:#fff; border:none;" onclick="openModal()">+ ìƒˆ ì§ì› ë“±ë¡</button>
        </div>

        <div class="user-list-card">
          <div class="table-responsive">
            <table class="user-table">
              <thead>
                <tr>
                  <th>ì´ë¦„ / ì‚¬ë²ˆ</th>
                  <th>ì•„ì´ë””</th>
                  <th>ë¶€ì„œ / ì§ê¸‰</th>
                  <th>ì´ë©”ì¼</th>
                  <th>ìƒíƒœ</th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="user-tbody">
                <tr><td colspan="6" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title" style="margin:0;">ì‚¬ìš©ì ì •ë³´</h3>
        <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      <div class="form-grid">
        <div class="full-width">
          <label style="font-size:0.8rem; font-weight:700;">ì´ë¦„</label>
          <input type="text" id="m-name" class="styled-input" placeholder="ì‹¤ëª… ì…ë ¥">
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ì‚¬ë²ˆ</label>
          <input type="text" id="m-empNo" class="styled-input" placeholder="CL25-0000">
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ë¡œê·¸ì¸ ID</label>
          <input type="text" id="m-loginId" class="styled-input" placeholder="ì•„ì´ë””">
        </div>
        <div class="full-width">
          <label style="font-size:0.8rem; font-weight:700;">ì´ë©”ì¼</label>
          <input type="email" id="m-email" class="styled-input" placeholder="user@company.com">
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ë¶€ì„œ</label>
          <input type="text" id="m-dept" class="styled-input" placeholder="ë¶€ì„œëª…">
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ì§ê¸‰</label>
          <input type="text" id="m-pos" class="styled-input" placeholder="ì§ê¸‰">
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ê¶Œí•œ ê·¸ë£¹</label>
          <select id="m-role" class="styled-input">
            <option value="EMP">ì¼ë°˜ ì‚¬ì›(EMP)</option>
            <option value="MGR">ë§¤ë‹ˆì €(MGR)</option>
            <option value="ADMIN">ê´€ë¦¬ì(ADMIN)</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.8rem; font-weight:700;">ê³„ì • ìƒíƒœ</label>
          <select id="m-active" class="styled-input">
            <option value="1">ì •ìƒ(Active)</option>
            <option value="0">ì°¨ë‹¨(Locked)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:30px;">
        <button onclick="saveUser()" class="btn-bbs" style="width:100%; background:#3b82f6; color:#fff; border:none; padding:12px;">ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(fetchUsers);

    async function fetchUsers() {
      try {
        const res = await fetch(`${window.CHEESE_LOGIN_API}?mode=listUsers`);
        const json = await res.json();
        if(!json.ok) return alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

        const html = json.users.map(u => `
          <tr>
            <td>
              <div style="font-weight:700;">${u.displayName}</div>
              <div style="font-size:0.75rem; color:#718096;">${u.empNo}</div>
            </td>
            <td>${u.loginId}</td>
            <td>${u.deptId || '-'} / ${u.positionName || '-'}</td>
            <td>${u.email}</td>
            <td><span class="status-badge status-${u.active}">${u.active == 1 ? 'ì •ìƒ' : 'ì ê¸ˆ'}</span></td>
            <td><button class="btn-action" onclick='openModal(${JSON.stringify(u)})'>ìˆ˜ì •</button></td>
          </tr>
        `).join('');
        document.getElementById('user-tbody').innerHTML = html;
      } catch(e) { console.error(e); }
    }

    function openModal(user = null) {
      const modal = document.getElementById('userModal');
      modal.style.display = 'block';
      
      if(user) {
        document.getElementById('modal-title').textContent = "ì§ì› ì •ë³´ ìˆ˜ì •";
        document.getElementById('m-name').value = user.displayName;
        document.getElementById('m-empNo').value = user.empNo;
        document.getElementById('m-empNo').disabled = true; // ì‚¬ë²ˆì€ ìˆ˜ì • ë¶ˆê°€
        document.getElementById('m-loginId').value = user.loginId;
        document.getElementById('m-email').value = user.email;
        document.getElementById('m-dept').value = user.deptId;
        document.getElementById('m-pos').value = user.positionName;
        document.getElementById('m-role').value = user.role;
        document.getElementById('m-active').value = user.active;
      } else {
        document.getElementById('modal-title').textContent = "ìƒˆ ì§ì› ë“±ë¡";
        // í¼ ì´ˆê¸°í™” ë¡œì§...
      }
    }

    function closeModal() { document.getElementById('userModal').style.display = 'none'; }

    async function saveUser() {
      const payload = {
        mode: 'upsertUser',
        empNo: document.getElementById('m-empNo').value,
        loginId: document.getElementById('m-loginId').value,
        displayName: document.getElementById('m-name').value,
        email: document.getElementById('m-email').value,
        deptId: document.getElementById('m-dept').value,
        positionName: document.getElementById('m-pos').value,
        role: document.getElementById('m-role').value,
        active: document.getElementById('m-active').value
      };

      try {
        const res = await fetch(window.CHEESE_LOGIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        alert(json.message);
        closeModal();
        fetchUsers();
      } catch(e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }
  </script>
</body>
</html>
