<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¸ì‚¬ ê´€ë¦¬ - Cheese Lab</title>
  <link rel="stylesheet" href="./admin.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* ì¸ì‚¬ ê´€ë¦¬ ì „ìš© ìŠ¤íƒ€ì¼ */
    .user-list-card { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .table-responsive { overflow-x: auto; }
    .user-table { width: 100%; border-collapse: collapse; text-align: left; }
    .user-table th { background: #f8fafc; padding: 15px; font-size: 0.8rem; text-transform: uppercase; color: #64748b; border-bottom: 1px solid #e2e8f0; }
    .user-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; color: #1a202c; }
    .user-table tr:last-child td { border-bottom: none; }
    .user-table tr:hover { background: #f1f5f9; }
    
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .status-1 { background: #dcfce7; color: #166534; } /* í™œì„± */
    .status-0 { background: #fee2e2; color: #991b1b; } /* ì°¨ë‹¨ */

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
    .modal-content { background: #fff; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .full-width { grid-column: span 2; }
    /* âœ¨ ì„¸ë ¨ëœ ëª¨ë‹¬ ë””ìì¸ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3); /* ë°°ê²½ì„ ì¡°ê¸ˆ ë” íˆ¬ëª…í•˜ê²Œ */
      backdrop-filter: blur(8px); /* ë°°ê²½ íë¦¼ íš¨ê³¼ (ë§¤ìš° ì¤‘ìš”!) */
      transition: all 0.3s ease;
    }
    
    .modal-content {
      background: #ffffff;
      margin: 7% auto;
      padding: 0; /* ë‚´ë¶€ íŒ¨ë”©ì„ 0ìœ¼ë¡œ í•˜ê³  ì„¹ì…˜ì„ ë‚˜ëˆ•ë‹ˆë‹¤ */
      border-radius: 16px; /* ë” ë‘¥ê¸€ê²Œ */
      width: 90%;
      max-width: 520px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      overflow: hidden;
      animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 24px 30px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 800;
      color: #1e293b;
    }
    
    .modal-body {
      padding: 30px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .field-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .styled-input {
      width: 100%;
      padding: 12px 16px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s;
      box-sizing: border-box;
      background: #f8fafc;
    }
    
    .styled-input:focus {
      background: #fff;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .modal-footer {
      padding: 20px 30px;
      background: #f8fafc;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn-cancel {
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #64748b;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-save {
      padding: 12px 30px;
      border-radius: 10px;
      background: #1e293b;
      color: #fff;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-save:hover { background: #334155; transform: translateY(-1px); }
  </style>
  <script>
    // âœ… ìµœì‹  ë°°í¬ëœ ë¡œê·¸ì¸ API ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”!
    window.CHEESE_LOGIN_API = "https://script.google.com/macros/s/AKfycbwLtN5N5ndt80qRnGPCkVIaus9YbyAFRPWbhfU5tyFOdULUmm8CPrV6ffngEH4r8Z_E/exec";
  </script>
  <script src="./admin-common.js" defer></script>
</head>
<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>
    <main class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
      
      <section class="admin-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
          <div>
            <h2 style="margin:0;">ğŸ‘¤ ì¸ì‚¬ ê´€ë¦¬</h2>
            <p style="color:#718096; font-size:0.9rem; margin-top:5px;">ì‹œìŠ¤í…œì— ë“±ë¡ëœ ì „ì²´ ì‚¬ìš©ì ëª©ë¡ì…ë‹ˆë‹¤.</p>
          </div>
          <button class="btn-bbs" style="background:#1a202c; color:#fff; border:none;" onclick="openModal()">+ ìƒˆ ì§ì› ë“±ë¡</button>
        </div>

        <div class="user-list-card">
          <div class="table-responsive">
            <table class="user-table">
              <thead>
                <tr>
                  <th>ì´ë¦„ / ì‚¬ë²ˆ</th>
                  <th>ì•„ì´ë””</th>
                  <th>ë¶€ì„œ / ì§ê¸‰</th>
                  <th>ì´ë©”ì¼</th>
                  <th>ìƒíƒœ</th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="user-tbody">
                <tr><td colspan="6" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬</h3>
      <button onclick="closeModal()" style="background:none; border:none; cursor:pointer; color:#94a3b8; font-size:1.5rem;">&times;</button>
    </div>
    
    <div class="modal-body">
      <input type="hidden" id="edit-empNo">
      <div class="form-grid">
        <div style="grid-column: span 2;">
          <label class="field-label">ì´ë¦„</label>
          <input type="text" id="edit-name" class="styled-input" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div>
          <label class="field-label">ì‚¬ë²ˆ</label>
          <input type="text" id="edit-empNo-disp" class="styled-input" placeholder="CL25-0000">
        </div>
        <div>
          <label class="field-label">ì•„ì´ë””</label>
          <input type="text" id="edit-id" class="styled-input" placeholder="ë¡œê·¸ì¸ ì•„ì´ë””">
        </div>
        <div style="grid-column: span 2;">
          <label class="field-label">ì´ë©”ì¼</label>
          <input type="email" id="edit-email" class="styled-input" placeholder="example@cheeselab.com">
        </div>
        <div>
          <label class="field-label">ë¶€ì„œ</label>
          <input type="text" id="edit-dept" class="styled-input" placeholder="ë¶€ì„œëª…">
        </div>
        <div>
          <label class="field-label">ì§ê¸‰</label>
          <input type="text" id="edit-pos" class="styled-input" placeholder="ì§ê¸‰">
        </div>
        <div style="grid-column: span 2;">
          <label class="field-label">ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì • ì‹œì—ë§Œ ì…ë ¥)</label>
          <input type="password" id="edit-pw" class="styled-input" placeholder="ë¯¸ì…ë ¥ ì‹œ ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€">
        </div>
        <div style="grid-column: span 2;">
          <label class="field-label">ê³„ì • ìƒíƒœ</label>
          <select id="edit-active" class="styled-input">
            <option value="1">âœ… í™œì„± (ì‹œìŠ¤í…œ ì´ìš© ê°€ëŠ¥)</option>
            <option value="0">ğŸ”’ ë¹„í™œì„± (ê³„ì • ì ê¸ˆ)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveUser()">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
    </div>
  </div>
</div>

  <script>
    $(document).ready(fetchUsers);

    async function fetchUsers() {
      try {
        const res = await fetch(`${window.CHEESE_LOGIN_API}?mode=listUsers`);
        const json = await res.json();
        if(!json.ok) return alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

        const html = json.users.map(u => `
          <tr>
            <td>
              <div style="font-weight:700;">${u.displayName}</div>
              <div style="font-size:0.75rem; color:#718096;">${u.empNo}</div>
            </td>
            <td>${u.loginId}</td>
            <td>${u.deptId || '-'} / ${u.positionName || '-'}</td>
            <td>${u.email}</td>
            <td><span class="status-badge status-${u.active}">${u.active == 1 ? 'ì •ìƒ' : 'ì ê¸ˆ'}</span></td>
            <td><button class="btn-action" onclick='openModal(${JSON.stringify(u)})'>ìˆ˜ì •</button></td>
          </tr>
        `).join('');
        document.getElementById('user-tbody').innerHTML = html;
      } catch(e) { console.error(e); }
    }

    function openModal(user = null) {
      const modal = document.getElementById('userModal');
      modal.style.display = 'block';
    
      if (user) {
        // ğŸ“ ìˆ˜ì • ëª¨ë“œ: ì „ë‹¬ë°›ì€ user ê°ì²´ì˜ ë°ì´í„°ë¥¼ ì…ë ¥ì°½ì— ì±„ì›ë‹ˆë‹¤.
        document.getElementById('modal-title').textContent = "ì§ì› ì •ë³´ ìˆ˜ì •";
        
        document.getElementById('m-name').value = user.displayName || '';
        document.getElementById('m-empNo').value = user.empNo || '';
        document.getElementById('m-empNo').readOnly = true; // ì‚¬ë²ˆì€ ìˆ˜ì • ë¶ˆê°€ ì²˜ë¦¬
        
        document.getElementById('m-loginId').value = user.loginId || '';
        document.getElementById('m-email').value = user.email || '';
        
        // Select ë°•ìŠ¤ë“¤ (IDì™€ ì‹œíŠ¸ì˜ ì»¬ëŸ¼ëª…ì´ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)
        document.getElementById('m-dept').value = user.deptId || '';
        document.getElementById('m-pos').value = user.positionName || '';
        document.getElementById('m-role').value = user.role || '';
        document.getElementById('m-active').value = user.active !== undefined ? user.active : '1';
        
        // ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆìƒ ë¹„ì›Œë‘¡ë‹ˆë‹¤.
        if(document.getElementById('m-password')) {
            document.getElementById('m-password').value = '';
        }
      } else {
        // âœ¨ ì‹ ê·œ ë“±ë¡ ëª¨ë“œ: ëª¨ë“  í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('modal-title').textContent = "ìƒˆ ì§ì› ë“±ë¡";
        document.getElementById('m-empNo').readOnly = false;
        
        // ëª¨ë“  inputê³¼ select ì´ˆê¸°í™”
        const inputs = document.querySelectorAll('#userModal input, #userModal select');
        inputs.forEach(input => input.value = '');
        document.getElementById('m-active').value = '1';
      }
    }

    // 1. ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ (ì´ë¦„ì„ closeModalë¡œ í†µì¼)
    function closeModal() {
      const modal = document.getElementById('userModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // 2. ë°°ê²½(ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­) í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
    window.onclick = function(event) {
      const modal = document.getElementById('userModal');
      // í´ë¦­ëœ ëŒ€ìƒì´ ëª¨ë‹¬ì˜ ê²€ì€ ë°°ê²½(userModal) ìì²´ì¼ ê²½ìš°ì—ë§Œ ë‹«ìŒ
      if (event.target == modal) {
        closeModal();
      }
    }

    // 3. (ì°¸ê³ ) ESC í‚¤ë¥¼ ëˆŒë €ì„ ë•Œë„ ë‹«íˆê²Œ í•˜ë©´ ë” í¸ë¦¬í•©ë‹ˆë‹¤ (ì„ íƒ ì‚¬í•­)
    window.onkeydown = function(event) {
      if (event.key === "Escape") {
        closeModal();
      }
    }
    
    async function saveUser() {
      const payload = {
        mode: 'upsertUser',
        empNo: document.getElementById('m-empNo').value,
        loginId: document.getElementById('m-loginId').value,
        displayName: document.getElementById('m-name').value,
        email: document.getElementById('m-email').value,
        deptId: document.getElementById('m-dept').value,
        positionName: document.getElementById('m-pos').value,
        role: document.getElementById('m-role').value,
        active: document.getElementById('m-active').value
      };

      try {
        const res = await fetch(window.CHEESE_LOGIN_API, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        alert(json.message);
        closeModal();
        fetchUsers();
      } catch(e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }
  </script>
</body>
</html>
