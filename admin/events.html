<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사건 목록 · Knowledge DB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 공통 CSS -->
  <link rel="stylesheet" href="./admin.css" />
  <!-- ✅ 반드시 포함: 공통 헤더/메뉴 주입 스크립트 -->
  <script src="./admin-common.js" defer></script>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:rgba(15,23,42,.12); --shadow:0 10px 28px rgba(15,23,42,.10);
      --r:18px; --primary:#111827; --ok:#16a34a; --bad:#ef4444;
      --soft:#eef2ff;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    .page-wrap{ max-width:1100px; margin:0 auto; padding:18px 18px 40px; box-sizing:border-box; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; }
    .h{ padding:16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .h .title{ font-weight:950; font-size:18px; letter-spacing:-.2px; }
    .h .sub{ font-size:13px; color:var(--muted); margin-top:3px; }
    .b{ padding:16px; }

    /* Filters */
    .filters{ display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr; gap:10px; align-items:end; }
    @media (max-width: 980px){
      .filters{ grid-template-columns: 1fr 1fr; }
    }

    label{ display:block; font-size:13px; font-weight:950; margin:0 0 8px; letter-spacing:-.2px; }
    input[type="text"], select, textarea{
      width:100%; padding:12px 12px; border:1.5px solid var(--line); border-radius:14px;
      background:#fff; color:var(--text); outline:none; font-size:14px; box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus{ border-color: rgba(17,24,39,.35); box-shadow: 0 0 0 4px rgba(17,24,39,.08); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:14px; padding:12px 16px; cursor:pointer; font-weight:950; font-size:14px; min-height:44px;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:rgba(0,0,0,.2); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .status{
      font-size:13px; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-weight:950; min-height:44px; display:inline-flex; align-items:center;
    }
    .status.ok{ border-color: rgba(22,163,74,.35); color: var(--ok); }
    .status.bad{ border-color: rgba(239,68,68,.35); color: var(--bad); }

    /* List cards */
    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{
      background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow);
      padding:14px 14px 12px;
    }
    .item-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .item-title{ font-weight:950; font-size:16px; letter-spacing:-.2px; line-height:1.25; }
    .item-meta{ font-size:12.5px; color:var(--muted); margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12.5px; font-weight:950;
      background:var(--soft);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .item-body{ margin-top:10px; color:var(--text); font-size:13.5px; line-height:1.55; }
    .muted{ color:var(--muted); }

    .item-actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .linklike{
      border:1px solid var(--line); background:#fff; border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer; font-size:13px;
    }

    .pager{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pager .info{ color:var(--muted); font-weight:950; font-size:13px; }
    .empty{
      padding:18px; border:1px dashed var(--line); border-radius:18px; background:#fff; color:var(--muted);
      font-weight:950;
    }

    /* Script editor */
    .two-col{
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .two-col{ grid-template-columns: 1fr; }
    }
    .hint{ font-size:12.5px; color:var(--muted); line-height:1.45; margin-top:8px; }
    .codebox{
      min-height:260px;
      resize:vertical;
      font-size:12.5px;
      line-height:1.45;
      padding:12px;
    }
    .mini{
      width:100%;
      padding:12px;
      border:1.5px solid var(--line);
      border-radius:14px;
      background:#fff;
    }
  </style>

  <script>
    // ✅ API Base는 화면에서 입력/저장 가능
    window.CHEESE_ADMIN_API_BASE = ""; // 초기값(없어도 됨)
  </script>
</head>

<body>
  <!-- ✅ 권한별 접근 제어 -->
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "FIN", "ADMIN"];
  </script>

  <!-- ✅ 공통 헤더/메뉴 슬롯 -->
  <div id="admin-header-slot"></div>
  <div class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <main>
      <div class="page-wrap">

        <!-- ✅ Apps Script 코드 편집기 + API Base 설정 -->
        <div class="card">
          <div class="h">
            <div>
              <div class="title">API 설정 · Apps Script 코드</div>
              <div class="sub">이 화면에서 코드 작성/보관/복사/다운로드</div>
            </div>
            <div class="row">
              <span class="status" id="scriptStatus">대기</span>
              <button class="btn" type="button" id="btnSaveLocal">로컬 저장</button>
              <button class="btn" type="button" id="btnCopyGs">코드 복사</button>
              <button class="btn primary" type="button" id="btnDownloadGs">.gs 다운로드</button>
            </div>
          </div>
          <div class="b">
            <div class="two-col">
              <div>
                <label>Apps Script WebApp exec URL</label>
                <input type="text" id="apiBase" placeholder="예: https://script.google.com/macros/s/.../exec" />

                <div class="row" style="margin-top:10px;">
                  <button class="btn primary" type="button" id="btnApplyApi">API 적용</button>
                  <button class="btn" type="button" id="btnLoadLocal">로컬 불러오기</button>
                  <button class="btn" type="button" id="btnClearLocal">로컬 초기화</button>
                </div>

                <div class="hint">
                  ※ 이 페이지에서 “Apps Script 프로젝트를 자동 수정/배포”까지 하려면
                  OAuth + Apps Script API가 필요해요.<br/>
                  여기서는 <b>코드 작성 → 복사/다운로드 → Apps Script 편집기에 붙여넣기</b> 흐름이 가장 단순합니다.
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn" type="button" id="btnInsertTemplate">EVENTS API 템플릿 넣기</button>
                </div>
              </div>

              <div>
                <label>Apps Script 코드(.gs)</label>
                <textarea id="gsCode" class="mono codebox" spellcheck="false" placeholder="여기에 Apps Script 코드를 직접 작성하세요."></textarea>
                <div class="hint">
                  로컬 저장은 브라우저에만 저장됩니다(PC/브라우저 바뀌면 안 따라감).
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ 검색 카드 -->
        <div class="card">
          <div class="h">
            <div>
              <div class="title">사건 목록</div>
              <div class="sub">세로 카드로 나열 · 조건 검색 · 빠른 이동</div>
            </div>
            <div class="row">
              <span id="uiStatus" class="status">대기</span>
              <button class="btn" type="button" id="btnReset">초기화</button>
              <button class="btn primary" type="button" id="btnSearch">검색</button>
            </div>
          </div>

          <div class="b">
            <div class="filters">
              <div>
                <label>검색어</label>
                <input type="text" id="q" placeholder="제목/요약/본문/태그/국가/당대국가 등" />
              </div>

              <div>
                <label>상태</label>
                <select id="status">
                  <option value="">전체</option>
                  <option value="draft">초안(draft)</option>
                  <option value="published">공개(published)</option>
                </select>
              </div>

              <div>
                <label>관련 국가</label>
                <select id="country">
                  <option value="">전체</option>
                  <option value="KR">KR</option>
                  <option value="JP">JP</option>
                  <option value="CN">CN</option>
                </select>
              </div>

              <div>
                <label>당대 국가/정권</label>
                <input type="text" id="polity" placeholder="예: 고구려, 조선, 청" />
              </div>

              <div>
                <label>분류</label>
                <select id="category">
                  <option value="">전체</option>
                  <option value="politics">정치</option>
                  <option value="war">전쟁/군사</option>
                  <option value="diplomacy">외교</option>
                  <option value="economy">경제</option>
                  <option value="society">사회</option>
                  <option value="culture">문화</option>
                </select>
              </div>

              <div>
                <label>정렬</label>
                <select id="sort">
                  <option value="updated_at_desc" selected>최신 수정</option>
                  <option value="updated_at_asc">오래된 수정</option>
                  <option value="importance_desc">중요도 높은 순</option>
                  <option value="date_start_asc">시작시점(텍스트) 오름</option>
                  <option value="date_start_desc">시작시점(텍스트) 내림</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <div class="row">
                <button class="btn" type="button" id="btnPrev">이전</button>
                <button class="btn" type="button" id="btnNext">다음</button>
                <select id="size" style="width:auto; min-width:140px;">
                  <option value="20">20개씩</option>
                  <option value="50" selected>50개씩</option>
                  <option value="100">100개씩</option>
                </select>
              </div>
              <div class="pager">
                <div class="info" id="pagerInfo">0건</div>
              </div>
            </div>
          </div>
        </div>

        <div id="list" class="list"></div>

      </div>
    </main>
  </div>

  <script>
    const $ = (id)=> document.getElementById(id);

    // -----------------------
    // UI
    // -----------------------
    function setUiStatus(text, kind=""){
      const el = $("uiStatus");
      if (!el) return;
      el.textContent = text;
      el.className = "status" + (kind ? (" " + kind) : "");
    }
    function setScriptStatus(text, kind=""){
      const el = $("scriptStatus");
      if (!el) return;
      el.textContent = text;
      el.className = "status" + (kind ? (" " + kind) : "");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function safePipeToPills(pipeStr){
      const parts = String(pipeStr || "")
        .split("|").map(s=>s.trim()).filter(Boolean)
        .slice(0, 6);
      return parts.map(p=>`<span class="pill">${escapeHtml(p)}</span>`).join("");
    }

    function firstLine(text, max=120){
      const s = String(text || "").replace(/\s+/g, " ").trim();
      if (!s) return "";
      return s.length > max ? (s.slice(0, max) + "…") : s;
    }

    // -----------------------
    // LocalStorage keys
    // -----------------------
    const LS_API  = "KNDB_API_BASE";
    const LS_GS   = "KNDB_GAS_CODE";

    function saveLocal_(){
      localStorage.setItem(LS_API, $("apiBase").value.trim());
      localStorage.setItem(LS_GS, $("gsCode").value);
      setScriptStatus("로컬 저장됨", "ok");
    }
    function loadLocal_(){
      const api = localStorage.getItem(LS_API) || "";
      const gs  = localStorage.getItem(LS_GS) || "";
      $("apiBase").value = api;
      if (gs) $("gsCode").value = gs;
      setScriptStatus("로컬 불러옴", "ok");
    }
    function clearLocal_(){
      localStorage.removeItem(LS_API);
      localStorage.removeItem(LS_GS);
      setScriptStatus("로컬 초기화됨", "ok");
    }

    function applyApiBase_(){
      const v = $("apiBase").value.trim();
      window.CHEESE_ADMIN_API_BASE = v;
      localStorage.setItem(LS_API, v);
      setScriptStatus("API 적용됨", v ? "ok" : "");
    }

    async function copyGs_(){
      const txt = $("gsCode").value || "";
      if (!txt.trim()){
        setScriptStatus("코드가 비어 있습니다", "bad");
        return;
      }
      try{
        await navigator.clipboard.writeText(txt);
        setScriptStatus("코드 복사됨", "ok");
      }catch(_){
        setScriptStatus("복사 실패", "bad");
      }
    }

    function downloadGs_(){
      const txt = $("gsCode").value || "";
      if (!txt.trim()){
        setScriptStatus("코드가 비어 있습니다", "bad");
        return;
      }
      const blob = new Blob([txt], { type:"text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "knowledge_db_events_api.gs";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setScriptStatus(".gs 다운로드됨", "ok");
    }

    // -----------------------
    // Template (EVENTS API v1.1)
    // -----------------------
    const EVENTS_API_TEMPLATE = `\
/************************************************************
 * Knowledge-DB EVENTS Web API (Apps Script) v1.1
 * (템플릿)
 *
 * ✅ 대상 시트: EVENTS
 * ✅ 헤더(1행):
 * event_id\\ttitle_ko\\ttitle_ja\\ttitle_zh\\tdate_start\\tdate_end\\tdate_precision\\tcountries\\tpolities\\tcategory\\timportance\\tstatus\\tsummary\\tbody\\ttags\\tentity_refs\\tsource_refs\\tcreated_at\\tupdated_at
 *
 * ✅ POST JSON
 * - { mode:"events.upsert", payload:{...} }
 * - { mode:"events.get", event_id:"..." }
 * - { mode:"events.list", q:"", page:1, size:50, status:"", country:"", polity:"", category:"", sort:"updated_at_desc" }
 ************************************************************/

const SHEET_EVENTS = "EVENTS";
const EVENTS_HEADERS = [
  "event_id","title_ko","title_ja","title_zh",
  "date_start","date_end","date_precision",
  "countries","polities",
  "category","importance","status",
  "summary","body",
  "tags","entity_refs","source_refs",
  "created_at","updated_at"
];

function doGet(e){
  return jsonOut_({ ok:true, message:"Knowledge-DB EVENTS API v1.1", hint:"POST JSON: events.upsert / events.get / events.list" });
}

function doPost(e){
  try{
    const req = parseJson_(e);
    const mode = String(req.mode || "").trim();
    if (!mode) throw new Error("mode가 없습니다.");

    ensureSheet_(SHEET_EVENTS, EVENTS_HEADERS);

    if (mode === "events.upsert") return jsonOut_(eventsUpsert_(req));
    if (mode === "events.get")    return jsonOut_(eventsGet_(req));
    if (mode === "events.list")   return jsonOut_(eventsList_(req));

    throw new Error("지원하지 않는 mode: " + mode);
  }catch(err){
    return jsonOut_({ ok:false, message: err && err.message ? err.message : String(err) }, 200);
  }
}

function eventsUpsert_(req){
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_EVENTS);
  const payload = req.payload || {};
  if (!payload || typeof payload !== "object") throw new Error("payload가 올바르지 않습니다.");

  const titleKo = String(payload.title_ko || "").trim();
  const dateStart = String(payload.date_start || "").trim();
  if (!titleKo) throw new Error("title_ko(사건 제목)는 필수입니다.");
  if (!dateStart) throw new Error("date_start(시작 시점)은 필수입니다.");

  let eventId = String(payload.event_id || "").trim();
  if (!eventId) eventId = makeEventId_(dateStart);

  const now = nowText_();
  const createdAt = String(payload.created_at || "").trim() || now;
  const updatedAt = now;

  const rowObj = Object.assign({}, payload, {
    event_id: eventId,
    title_ko: titleKo,
    date_start: dateStart,
    importance: toNumber_(payload.importance, 3),
    created_at: createdAt,
    updated_at: updatedAt
  });

  const map = getHeaderMap_(sh);
  const values = sh.getDataRange().getValues();
  const idCol = map["event_id"];
  if (idCol == null) throw new Error("EVENTS 시트에 event_id 헤더가 없습니다.");

  let targetRowIndex = -1;
  for (let r = 1; r < values.length; r++){
    if (String(values[r][idCol]).trim() === eventId){
      targetRowIndex = r;
      break;
    }
  }

  const rowArray = buildRowArray_(EVENTS_HEADERS, rowObj);

  if (targetRowIndex === -1){
    sh.appendRow(rowArray);
    return { ok:true, action:"insert", event_id:eventId };
  }else{
    const sheetRow = targetRowIndex + 1;
    for (let i=0; i<EVENTS_HEADERS.length; i++){
      const key = EVENTS_HEADERS[i];
      const col = map[key];
      if (col == null) continue;
      sh.getRange(sheetRow, col+1).setValue(rowObj[key] ?? "");
    }
    return { ok:true, action:"update", event_id:eventId };
  }
}

function eventsGet_(req){
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_EVENTS);
  const eventId = String(req.event_id || "").trim();
  if (!eventId) throw new Error("event_id가 없습니다.");

  const map = getHeaderMap_(sh);
  const values = sh.getDataRange().getValues();
  const idCol = map["event_id"];

  for (let r=1; r<values.length; r++){
    if (String(values[r][idCol]).trim() === eventId){
      const obj = rowToObj_(EVENTS_HEADERS, map, values[r]);
      return { ok:true, item: obj };
    }
  }
  return { ok:false, message:"해당 event_id를 찾을 수 없습니다.", event_id:eventId };
}

function eventsList_(req){
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_EVENTS);
  const map = getHeaderMap_(sh);
  const values = sh.getDataRange().getValues();

  const q = String(req.q || "").trim().toLowerCase();
  const status = String(req.status || "").trim();
  const country = String(req.country || "").trim();
  const polity = String(req.polity || "").trim();
  const category = String(req.category || "").trim();
  const sort = String(req.sort || "updated_at_desc").trim();

  const page = Math.max(1, toInt_(req.page, 1));
  const size = Math.min(200, Math.max(1, toInt_(req.size, 50)));

  const col = (name)=> map[name];
  const searchCols = [
    col("event_id"), col("title_ko"), col("title_ja"), col("title_zh"),
    col("summary"), col("body"), col("tags"),
    col("countries"), col("polities"),
    col("entity_refs"), col("source_refs"),
  ].filter(v => v != null);

  const matchedRows = [];
  const cStatus = col("status");
  const cCountries = col("countries");
  const cPolities = col("polities");
  const cCategory = col("category");

  for (let r=1; r<values.length; r++){
    const row = values[r];

    if (status && cStatus != null){
      const st = String(row[cStatus] || "").trim();
      if (st !== status) continue;
    }

    if (category && cCategory != null){
      const cat = String(row[cCategory] || "").trim();
      if (cat !== category) continue;
    }

    if (country && cCountries != null){
      const cs = String(row[cCountries] || "");
      if (!pipeHas_(cs, country)) continue;
    }

    if (polity && cPolities != null){
      const ps = String(row[cPolities] || "");
      if (!pipeHas_(ps, polity)) continue;
    }

    if (q){
      let hit = false;
      for (const c of searchCols){
        const v = String(row[c] ?? "").toLowerCase();
        if (v.includes(q)){ hit = true; break; }
      }
      if (!hit) continue;
    }

    matchedRows.push(row);
  }

  sortRows_(matchedRows, map, sort);

  const total = matchedRows.length;
  const start = (page-1)*size;
  const slicedRows = matchedRows.slice(start, start+size);
  const items = slicedRows.map(row => rowToObj_(EVENTS_HEADERS, map, row));

  return { ok:true, total, page, size, items };
}

function sortRows_(rows, map, sort){
  const cUpdated = map["updated_at"];
  const cImportance = map["importance"];
  const cDateStart = map["date_start"];

  const s = (row, col)=> (col==null ? "" : String(row[col] ?? "").trim());
  const n = (row, col)=> toNumber_(col==null ? "" : row[col], 0);

  if (sort === "updated_at_asc"){
    rows.sort((a,b)=> s(a,cUpdated).localeCompare(s(b,cUpdated)));
    return;
  }
  if (sort === "importance_desc"){
    rows.sort((a,b)=>{
      const d = n(b,cImportance) - n(a,cImportance);
      if (d !== 0) return d;
      return s(b,cUpdated).localeCompare(s(a,cUpdated));
    });
    return;
  }
  if (sort === "date_start_asc"){
    rows.sort((a,b)=>{
      const d = s(a,cDateStart).localeCompare(s(b,cDateStart));
      if (d !== 0) return d;
      return s(b,cUpdated).localeCompare(s(a,cUpdated));
    });
    return;
  }
  if (sort === "date_start_desc"){
    rows.sort((a,b)=>{
      const d = s(b,cDateStart).localeCompare(s(a,cDateStart));
      if (d !== 0) return d;
      return s(b,cUpdated).localeCompare(s(a,cUpdated));
    });
    return;
  }

  // default: updated_at_desc
  rows.sort((a,b)=> s(b,cUpdated).localeCompare(s(a,cUpdated)));
}

function parseJson_(e){
  const txt = e && e.postData && e.postData.contents ? e.postData.contents : "";
  if (!txt) return {};
  try{ return JSON.parse(txt); }catch(_){ throw new Error("요청 본문 JSON 파싱 실패"); }
}

function jsonOut_(obj, code){
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function ensureSheet_(sheetName, headers){
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(sheetName);
  if (!sh) sh = ss.insertSheet(sheetName);

  const lastCol = sh.getLastColumn();
  const lastRow = sh.getLastRow();

  if (lastRow === 0){
    sh.getRange(1,1,1,headers.length).setValues([headers]);
    return;
  }

  const existing = sh.getRange(1,1,1,Math.max(lastCol, headers.length)).getValues()[0];
  const existingSet = new Set(existing.map(v=>String(v||"").trim()).filter(Boolean));

  let colPos = lastCol + 1;
  headers.forEach(h=>{
    if (!existingSet.has(h)){
      sh.getRange(1, colPos).setValue(h);
      colPos++;
    }
  });
}

function getHeaderMap_(sh){
  const row = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const map = {};
  row.forEach((name, idx)=>{
    const key = String(name || "").trim();
    if (key) map[key] = idx;
  });
  return map;
}

function buildRowArray_(headers, obj){
  return headers.map(h => obj[h] ?? "");
}

function rowToObj_(headers, map, row){
  const o = {};
  headers.forEach(h=>{
    const c = map[h];
    o[h] = (c == null) ? "" : (row[c] ?? "");
  });
  return o;
}

function pipeHas_(pipeStr, value){
  const v = String(value || "").trim();
  if (!v) return true;
  const parts = String(pipeStr || "").split("|").map(s=>s.trim()).filter(Boolean);
  return parts.includes(v);
}

function toNumber_(v, def){
  const n = Number(v);
  return Number.isFinite(n) ? n : def;
}
function toInt_(v, def){
  const n = parseInt(v, 10);
  return Number.isFinite(n) ? n : def;
}

function nowText_(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())} \${pad(d.getHours())}:\${pad(d.getMinutes())}\`;
}

function makeEventId_(dateStartText){
  const raw = String(dateStartText || "").trim();
  const isBce = /^(bce|bc|기원전)/i.test(raw);
  const rand = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4).padEnd(4,'X');
  const m = raw.match(/(\\d{1,6})/);
  const year = m ? String(m[1]).padStart(4,"0") : "0000";
  return isBce ? \`E_B\${year}_\${rand}\` : \`E_\${year}0000_\${rand}\`;
}
`;

    function insertTemplate_(){
      const cur = $("gsCode").value || "";
      if (cur.trim()){
        const ok = confirm("이미 코드가 있습니다. 템플릿으로 덮어쓸까요?");
        if (!ok) return;
      }
      $("gsCode").value = EVENTS_API_TEMPLATE;
      setScriptStatus("템플릿 입력됨", "ok");
    }

    // -----------------------
    // API
    // -----------------------
    async function apiPost(json){
      const base = (window.CHEESE_ADMIN_API_BASE || "").trim();
      if (!base) throw new Error("API Base가 비어 있습니다. 위에서 exec URL을 입력 후 [API 적용]을 누르세요.");

      // ✅ 프리플라이트(CORS) 회피: 헤더 제거
      const res = await fetch(base, {
        method: "POST",
        body: JSON.stringify(json),
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch(_){ data = { ok: res.ok, raw: text }; }

      if (!res.ok || data?.ok === false){
        throw new Error(data?.message || `HTTP ${res.status}`);
      }
      return data;
    }

    // -----------------------
    // State
    // -----------------------
    const state = {
      page: 1,
      size: 50,
      total: 0,
      items: [],
      loading: false,
    };

    function readFilters(){
      return {
        q: $("q")?.value.trim() || "",
        status: $("status")?.value || "",
        country: $("country")?.value || "",
        polity: $("polity")?.value.trim() || "",
        category: $("category")?.value || "",
        sort: $("sort")?.value || "updated_at_desc",
      };
    }

    // -----------------------
    // Render
    // -----------------------
    function render(){
      const list = $("list");
      if (!list) return;

      $("pagerInfo").textContent = `${state.total}건 · ${state.page}페이지 · ${state.size}개씩`;

      if (!state.items || state.items.length === 0){
        list.innerHTML = `<div class="empty">조건에 맞는 사건이 없습니다.</div>`;
        return;
      }

      list.innerHTML = state.items.map(item=>{
        const title = item.title_ko || "(제목 없음)";
        const date = item.date_start || "";
        const cat  = item.category || "";
        const st   = item.status || "";
        const imp  = item.importance != null ? String(item.importance) : "";
        const countries = item.countries || "";
        const polities  = item.polities || "";
        const tags      = item.tags || "";
        const summary = item.summary || item.body || "";
        const id = item.event_id || "";

        const pills =
          (countries ? safePipeToPills(countries) : "") +
          (polities ? safePipeToPills(polities) : "") +
          (cat ? `<span class="pill">${escapeHtml(cat)}</span>` : "") +
          (st ? `<span class="pill">${escapeHtml(st)}</span>` : "") +
          (imp ? `<span class="pill">★${escapeHtml(imp)}</span>` : "");

        const tagPills = tags ? safePipeToPills(tags) : "";

        return `
          <section class="item">
            <div class="item-top">
              <div>
                <div class="item-title">${escapeHtml(title)}</div>
                <div class="item-meta">
                  <span class="mono muted">${escapeHtml(id)}</span>
                  ${date ? `<span class="muted">· ${escapeHtml(date)}</span>` : ""}
                </div>
              </div>
              <div class="row" style="gap:8px; justify-content:flex-end;">
                ${pills}
              </div>
            </div>

            <div class="item-body">
              ${summary ? escapeHtml(firstLine(summary, 160)) : `<span class="muted">요약/본문이 비어 있습니다.</span>`}
            </div>

            ${tagPills ? `<div class="item-actions">${tagPills}</div>` : ""}

            <div class="item-actions">
              <button class="linklike" type="button" data-action="copyId" data-id="${escapeHtml(id)}">ID 복사</button>
              <button class="linklike" type="button" data-action="openEdit" data-id="${escapeHtml(id)}">편집 열기</button>
            </div>
          </section>
        `;
      }).join("");

      // action bindings (event delegation)
      list.querySelectorAll("[data-action]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id") || "";
          if (!id) return;

          if (act === "copyId"){
            try{
              await navigator.clipboard.writeText(id);
              setUiStatus("ID 복사됨", "ok");
            }catch(_){
              setUiStatus("복사 실패", "bad");
            }
          }

          if (act === "openEdit"){
            const url = `./events_editor.html?event_id=${encodeURIComponent(id)}`;
            window.location.href = url;
          }
        });
      });
    }

    // -----------------------
    // Load
    // -----------------------
    async function load(reset=false){
      if (state.loading) return;
      state.loading = true;

      try{
        setUiStatus("불러오는 중…", "");
        $("btnSearch").disabled = true;

        if (reset) state.page = 1;
        state.size = Number($("size")?.value || 50);

        const f = readFilters();

        // ✅ 서버가 category/sort까지 받는 버전(v1.1) 기준
        const req = {
          mode: "events.list",
          q: f.q,
          status: f.status,
          country: f.country,
          polity: f.polity,
          category: f.category,
          sort: f.sort,
          page: state.page,
          size: state.size,
        };

        const out = await apiPost(req);
        const items = Array.isArray(out.items) ? out.items : [];
        const total = Number(out.total || 0);

        state.items = items;
        state.total = total;

        setUiStatus("완료", "ok");
        render();

      }catch(err){
        setUiStatus(err?.message || "불러오기 실패", "bad");
        $("list").innerHTML = `<div class="empty">불러오기에 실패했습니다. (API Base / 배포 권한 / CORS 등을 확인)</div>`;
      }finally{
        state.loading = false;
        $("btnSearch").disabled = false;
      }
    }

    // -----------------------
    // Bind
    // -----------------------
    window.addEventListener("DOMContentLoaded", ()=>{
      // 초기 로컬 불러오기
      loadLocal_();
      if ($("apiBase").value.trim()){
        applyApiBase_();
      }

      // Script editor buttons
      $("btnApplyApi")?.addEventListener("click", applyApiBase_);
      $("btnSaveLocal")?.addEventListener("click", saveLocal_);
      $("btnLoadLocal")?.addEventListener("click", loadLocal_);
      $("btnClearLocal")?.addEventListener("click", clearLocal_);
      $("btnCopyGs")?.addEventListener("click", copyGs_);
      $("btnDownloadGs")?.addEventListener("click", downloadGs_);
      $("btnInsertTemplate")?.addEventListener("click", insertTemplate_);

      // Search buttons
      $("btnSearch")?.addEventListener("click", ()=> load(true));
      $("btnReset")?.addEventListener("click", ()=>{
        $("q").value = "";
        $("status").value = "";
        $("country").value = "";
        $("polity").value = "";
        $("category").value = "";
        $("sort").value = "updated_at_desc";
        $("size").value = "50";
        state.page = 1;
        load(true);
      });

      // Enter 검색
      ["q","polity"].forEach(id=>{
        $(id)?.addEventListener("keydown", (e)=>{
          if (e.key === "Enter"){ e.preventDefault(); load(true); }
        });
      });

      // paging
      $("btnPrev")?.addEventListener("click", ()=>{
        if (state.page <= 1) return;
        state.page -= 1;
        load(false);
      });
      $("btnNext")?.addEventListener("click", ()=>{
        state.page += 1;
        load(false);
      });

      // size change
      $("size")?.addEventListener("change", ()=> load(true));

      // 초기 렌더/로드
      render();
      load(true);
    });
  </script>
</body>
</html>
