<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>사건 목록 · Knowledge DB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 공통 CSS -->
  <link rel="stylesheet" href="./admin.css" />
  <!-- ✅ 반드시 포함: 공통 헤더/메뉴 주입 스크립트 -->
  <script src="./admin-common.js" defer></script>

  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --line:rgba(15,23,42,.12); --shadow:0 10px 28px rgba(15,23,42,.10);
      --r:18px; --primary:#111827; --ok:#16a34a; --bad:#ef4444;
      --soft:#eef2ff;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    .page-wrap{ max-width:1100px; margin:0 auto; padding:18px 18px 40px; box-sizing:border-box; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; }
    .h{ padding:16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .h .title{ font-weight:950; font-size:18px; letter-spacing:-.2px; }
    .h .sub{ font-size:13px; color:var(--muted); margin-top:3px; }
    .b{ padding:16px; }

    /* Filters */
    .filters{ display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr; gap:10px; align-items:end; }
    @media (max-width: 980px){
      .filters{ grid-template-columns: 1fr 1fr; }
    }

    label{ display:block; font-size:13px; font-weight:950; margin:0 0 8px; letter-spacing:-.2px; }
    input[type="text"], select, textarea{
      width:100%; padding:12px 12px; border:1.5px solid var(--line); border-radius:14px;
      background:#fff; color:var(--text); outline:none; font-size:14px; box-sizing:border-box;
    }
    input:focus, select:focus, textarea:focus{ border-color: rgba(17,24,39,.35); box-shadow: 0 0 0 4px rgba(17,24,39,.08); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--text);
      border-radius:14px; padding:12px 16px; cursor:pointer; font-weight:950; font-size:14px; min-height:44px;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:rgba(0,0,0,.2); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .status{
      font-size:13px; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; color:var(--muted); font-weight:950; min-height:44px; display:inline-flex; align-items:center;
    }
    .status.ok{ border-color: rgba(22,163,74,.35); color: var(--ok); }
    .status.bad{ border-color: rgba(239,68,68,.35); color: var(--bad); }

    /* List cards */
    .list{ display:flex; flex-direction:column; gap:12px; }
    .item{
      background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow);
      padding:14px 14px 12px;
    }
    .item-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .item-title{ font-weight:950; font-size:16px; letter-spacing:-.2px; line-height:1.25; }
    .item-meta{ font-size:12.5px; color:var(--muted); margin-top:6px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12.5px; font-weight:950;
      background:var(--soft);
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .item-body{ margin-top:10px; color:var(--text); font-size:13.5px; line-height:1.55; }
    .muted{ color:var(--muted); }

    .item-actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .linklike{
      border:1px solid var(--line); background:#fff; border-radius:14px; padding:10px 12px;
      font-weight:950; cursor:pointer; font-size:13px;
    }

    .pager{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .pager .info{ color:var(--muted); font-weight:950; font-size:13px; }
    .empty{
      padding:18px; border:1px dashed var(--line); border-radius:18px; background:#fff; color:var(--muted);
      font-weight:950;
    }

    /* Script editor */
    .two-col{
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .two-col{ grid-template-columns: 1fr; }
    }
    .hint{ font-size:12.5px; color:var(--muted); line-height:1.45; margin-top:8px; }
    .codebox{
      min-height:260px;
      resize:vertical;
      font-size:12.5px;
      line-height:1.45;
      padding:12px;
    }
  </style>

  <script>
    // ✅ 기본값으로 네 exec URL을 박아둠
    window.CHEESE_ADMIN_API_BASE =
      "https://script.google.com/macros/s/AKfycbxm0AbCRq2oa6BkNuLFDueE5nts9lomLoxm3_IpXrlb-mft-iTZh9Lz8SYm1MOfCOYXzw/exec";
  </script>
</head>

<body>
  <!-- ✅ 권한별 접근 제어 -->
  <script>
    window.CHEESE_ADMIN_REQUIRED_ROLES = ["EMP", "MGR", "FIN", "ADMIN"];
  </script>

  <!-- ✅ 공통 헤더/메뉴 슬롯 -->
  <div id="admin-header-slot"></div>
  <div class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <main>
      <div class="page-wrap">

        <!-- ✅ Apps Script 코드 편집기 + API Base 설정 -->
        <div class="card">
          <div class="h">
            <div>
              <div class="title">API 설정 · Apps Script 코드</div>
              <div class="sub">이 화면에서 코드 작성/보관/복사/다운로드</div>
            </div>
            <div class="row">
              <span class="status" id="scriptStatus">대기</span>
              <button class="btn" type="button" id="btnSaveLocal">로컬 저장</button>
              <button class="btn" type="button" id="btnCopyGs">코드 복사</button>
              <button class="btn primary" type="button" id="btnDownloadGs">.gs 다운로드</button>
            </div>
          </div>
          <div class="b">
            <div class="two-col">
              <div>
                <label>Apps Script WebApp exec URL</label>
                <input type="text" id="apiBase" placeholder="예: https://script.google.com/macros/s/.../exec" />

                <div class="row" style="margin-top:10px;">
                  <button class="btn primary" type="button" id="btnApplyApi">API 적용</button>
                  <button class="btn" type="button" id="btnLoadLocal">로컬 불러오기</button>
                  <button class="btn" type="button" id="btnClearLocal">로컬 초기화</button>
                </div>

                <div class="hint">
                  기본값은 이미 위 exec URL로 세팅돼 있어요.<br/>
                  로컬 저장값이 있으면 그걸 우선 적용합니다.
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn" type="button" id="btnInsertTemplate">EVENTS API 템플릿 넣기</button>
                </div>
              </div>

              <div>
                <label>Apps Script 코드(.gs)</label>
                <textarea id="gsCode" class="mono codebox" spellcheck="false" placeholder="여기에 Apps Script 코드를 직접 작성하세요."></textarea>
                <div class="hint">
                  로컬 저장은 브라우저에만 저장됩니다(PC/브라우저 바뀌면 안 따라감).
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ 검색 카드 -->
        <div class="card">
          <div class="h">
            <div>
              <div class="title">사건 목록</div>
              <div class="sub">세로 카드로 나열 · 조건 검색 · 빠른 이동</div>
            </div>
            <div class="row">
              <span id="uiStatus" class="status">대기</span>
              <button class="btn" type="button" id="btnReset">초기화</button>
              <button class="btn primary" type="button" id="btnSearch">검색</button>
            </div>
          </div>

          <div class="b">
            <div class="filters">
              <div>
                <label>검색어</label>
                <input type="text" id="q" placeholder="제목/요약/본문/태그/국가/당대국가 등" />
              </div>

              <div>
                <label>상태</label>
                <select id="status">
                  <option value="">전체</option>
                  <option value="draft">초안(draft)</option>
                  <option value="published">공개(published)</option>
                </select>
              </div>

              <div>
                <label>관련 국가</label>
                <select id="country">
                  <option value="">전체</option>
                  <option value="KR">KR</option>
                  <option value="JP">JP</option>
                  <option value="CN">CN</option>
                </select>
              </div>

              <div>
                <label>당대 국가/정권</label>
                <input type="text" id="polity" placeholder="예: 고구려, 조선, 청" />
              </div>

              <div>
                <label>분류</label>
                <select id="category">
                  <option value="">전체</option>
                  <option value="politics">정치</option>
                  <option value="war">전쟁/군사</option>
                  <option value="diplomacy">외교</option>
                  <option value="economy">경제</option>
                  <option value="society">사회</option>
                  <option value="culture">문화</option>
                </select>
              </div>

              <div>
                <label>정렬</label>
                <select id="sort">
                  <option value="updated_at_desc" selected>최신 수정</option>
                  <option value="updated_at_asc">오래된 수정</option>
                  <option value="importance_desc">중요도 높은 순</option>
                  <option value="date_start_asc">시작시점(텍스트) 오름</option>
                  <option value="date_start_desc">시작시점(텍스트) 내림</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <div class="row">
                <button class="btn" type="button" id="btnPrev">이전</button>
                <button class="btn" type="button" id="btnNext">다음</button>
                <select id="size" style="width:auto; min-width:140px;">
                  <option value="20">20개씩</option>
                  <option value="50" selected>50개씩</option>
                  <option value="100">100개씩</option>
                </select>
              </div>
              <div class="pager">
                <div class="info" id="pagerInfo">0건</div>
              </div>
            </div>
          </div>
        </div>

        <div id="list" class="list"></div>

      </div>
    </main>
  </div>

  <script>
    const $ = (id)=> document.getElementById(id);

    // -----------------------
    // UI
    // -----------------------
    function setUiStatus(text, kind=""){
      const el = $("uiStatus");
      if (!el) return;
      el.textContent = text;
      el.className = "status" + (kind ? (" " + kind) : "");
    }
    function setScriptStatus(text, kind=""){
      const el = $("scriptStatus");
      if (!el) return;
      el.textContent = text;
      el.className = "status" + (kind ? (" " + kind) : "");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function safePipeToPills(pipeStr){
      const parts = String(pipeStr || "")
        .split("|").map(s=>s.trim()).filter(Boolean)
        .slice(0, 6);
      return parts.map(p=>`<span class="pill">${escapeHtml(p)}</span>`).join("");
    }

    function firstLine(text, max=120){
      const s = String(text || "").replace(/\s+/g, " ").trim();
      if (!s) return "";
      return s.length > max ? (s.slice(0, max) + "…") : s;
    }

    // -----------------------
    // LocalStorage keys
    // -----------------------
    const LS_API  = "KNDB_API_BASE";
    const LS_GS   = "KNDB_GAS_CODE";

    function saveLocal_(){
      localStorage.setItem(LS_API, $("apiBase").value.trim());
      localStorage.setItem(LS_GS, $("gsCode").value);
      setScriptStatus("로컬 저장됨", "ok");
    }
    function loadLocal_(){
      const api = localStorage.getItem(LS_API) || "";
      const gs  = localStorage.getItem(LS_GS) || "";
      if (api) $("apiBase").value = api;
      if (gs) $("gsCode").value = gs;
      setScriptStatus("로컬 불러옴", "ok");
    }
    function clearLocal_(){
      localStorage.removeItem(LS_API);
      localStorage.removeItem(LS_GS);
      setScriptStatus("로컬 초기화됨", "ok");
    }

    function applyApiBase_(){
      const v = $("apiBase").value.trim();
      window.CHEESE_ADMIN_API_BASE = v;
      localStorage.setItem(LS_API, v);
      setScriptStatus("API 적용됨", v ? "ok" : "");
    }

    async function copyGs_(){
      const txt = $("gsCode").value || "";
      if (!txt.trim()){
        setScriptStatus("코드가 비어 있습니다", "bad");
        return;
      }
      try{
        await navigator.clipboard.writeText(txt);
        setScriptStatus("코드 복사됨", "ok");
      }catch(_){
        setScriptStatus("복사 실패", "bad");
      }
    }

    function downloadGs_(){
      const txt = $("gsCode").value || "";
      if (!txt.trim()){
        setScriptStatus("코드가 비어 있습니다", "bad");
        return;
      }
      const blob = new Blob([txt], { type:"text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "knowledge_db_events_api.gs";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setScriptStatus(".gs 다운로드됨", "ok");
    }

    // -----------------------
    // Template (EVENTS API v1.1)
    // -----------------------
    const EVENTS_API_TEMPLATE = `\
/************************************************************
 * Knowledge-DB EVENTS Web API (Apps Script) v1.1
 * (템플릿)
 ************************************************************/
const SHEET_EVENTS = "EVENTS";
const EVENTS_HEADERS = [
  "event_id","title_ko","title_ja","title_zh",
  "date_start","date_end","date_precision",
  "countries","polities",
  "category","importance","status",
  "summary","body",
  "tags","entity_refs","source_refs",
  "created_at","updated_at"
];

function doGet(e){
  return jsonOut_({ ok:true, message:"Knowledge-DB EVENTS API v1.1", hint:"POST JSON: events.upsert / events.get / events.list" });
}

function doPost(e){
  try{
    const req = parseJson_(e);
    const mode = String(req.mode || "").trim();
    if (!mode) throw new Error("mode가 없습니다.");

    ensureSheet_(SHEET_EVENTS, EVENTS_HEADERS);

    if (mode === "events.upsert") return jsonOut_(eventsUpsert_(req));
    if (mode === "events.get")    return jsonOut_(eventsGet_(req));
    if (mode === "events.list")   return jsonOut_(eventsList_(req));

    throw new Error("지원하지 않는 mode: " + mode);
  }catch(err){
    return jsonOut_({ ok:false, message: err && err.message ? err.message : String(err) }, 200);
  }
}

// ---- (이하 helper/구현은 너가 쓰던 v1.0 코드 붙여넣으면 됨) ----
`;

    function insertTemplate_(){
      const cur = $("gsCode").value || "";
      if (cur.trim()){
        const ok = confirm("이미 코드가 있습니다. 템플릿으로 덮어쓸까요?");
        if (!ok) return;
      }
      $("gsCode").value = EVENTS_API_TEMPLATE;
      setScriptStatus("템플릿 입력됨", "ok");
    }

    // -----------------------
    // API
    // -----------------------
    async function apiPost(json){
      const base = (window.CHEESE_ADMIN_API_BASE || "").trim();
      if (!base) throw new Error("API Base가 비어 있습니다. (기본값이 이미 들어가 있어야 함)");

      // ✅ 프리플라이트(CORS) 회피: 헤더 제거
      const res = await fetch(base, {
        method: "POST",
        body: JSON.stringify(json),
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch(_){ data = { ok: res.ok, raw: text }; }

      if (!res.ok || data?.ok === false){
        throw new Error(data?.message || `HTTP ${res.status}`);
      }
      return data;
    }

    // -----------------------
    // State
    // -----------------------
    const state = {
      page: 1,
      size: 50,
      total: 0,
      items: [],
      loading: false,
    };

    function readFilters(){
      return {
        q: $("q")?.value.trim() || "",
        status: $("status")?.value || "",
        country: $("country")?.value || "",
        polity: $("polity")?.value.trim() || "",
        category: $("category")?.value || "",
        sort: $("sort")?.value || "updated_at_desc",
      };
    }

    // -----------------------
    // Render
    // -----------------------
    function render(){
      const list = $("list");
      if (!list) return;

      $("pagerInfo").textContent = `${state.total}건 · ${state.page}페이지 · ${state.size}개씩`;

      if (!state.items || state.items.length === 0){
        list.innerHTML = `<div class="empty">조건에 맞는 사건이 없습니다.</div>`;
        return;
      }

      list.innerHTML = state.items.map(item=>{
        const title = item.title_ko || "(제목 없음)";
        const date = item.date_start || "";
        const cat  = item.category || "";
        const st   = item.status || "";
        const imp  = item.importance != null ? String(item.importance) : "";
        const countries = item.countries || "";
        const polities  = item.polities || "";
        const tags      = item.tags || "";
        const summary = item.summary || item.body || "";
        const id = item.event_id || "";

        const pills =
          (countries ? safePipeToPills(countries) : "") +
          (polities ? safePipeToPills(polities) : "") +
          (cat ? `<span class="pill">${escapeHtml(cat)}</span>` : "") +
          (st ? `<span class="pill">${escapeHtml(st)}</span>` : "") +
          (imp ? `<span class="pill">★${escapeHtml(imp)}</span>` : "");

        const tagPills = tags ? safePipeToPills(tags) : "";

        return `
          <section class="item">
            <div class="item-top">
              <div>
                <div class="item-title">${escapeHtml(title)}</div>
                <div class="item-meta">
                  <span class="mono muted">${escapeHtml(id)}</span>
                  ${date ? `<span class="muted">· ${escapeHtml(date)}</span>` : ""}
                </div>
              </div>
              <div class="row" style="gap:8px; justify-content:flex-end;">
                ${pills}
              </div>
            </div>

            <div class="item-body">
              ${summary ? escapeHtml(firstLine(summary, 160)) : `<span class="muted">요약/본문이 비어 있습니다.</span>`}
            </div>

            ${tagPills ? `<div class="item-actions">${tagPills}</div>` : ""}

            <div class="item-actions">
              <button class="linklike" type="button" data-action="copyId" data-id="${escapeHtml(id)}">ID 복사</button>
              <button class="linklike" type="button" data-action="openEdit" data-id="${escapeHtml(id)}">편집 열기</button>
            </div>
          </section>
        `;
      }).join("");

      // action bindings
      list.querySelectorAll("[data-action]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const act = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id") || "";
          if (!id) return;

          if (act === "copyId"){
            try{
              await navigator.clipboard.writeText(id);
              setUiStatus("ID 복사됨", "ok");
            }catch(_){
              setUiStatus("복사 실패", "bad");
            }
          }

          if (act === "openEdit"){
            const url = `./events_editor.html?event_id=${encodeURIComponent(id)}`;
            window.location.href = url;
          }
        });
      });
    }

    // -----------------------
    // Load
    // -----------------------
    async function load(reset=false){
      if (state.loading) return;
      state.loading = true;

      try{
        setUiStatus("불러오는 중…", "");
        $("btnSearch").disabled = true;

        if (reset) state.page = 1;
        state.size = Number($("size")?.value || 50);

        const f = readFilters();

        const req = {
          mode: "events.list",
          q: f.q,
          status: f.status,
          country: f.country,
          polity: f.polity,
          category: f.category,
          sort: f.sort,
          page: state.page,
          size: state.size,
        };

        const out = await apiPost(req);
        state.items = Array.isArray(out.items) ? out.items : [];
        state.total = Number(out.total || 0);

        setUiStatus("완료", "ok");
        render();

      }catch(err){
        setUiStatus(err?.message || "불러오기 실패", "bad");
        $("list").innerHTML = `<div class="empty">불러오기에 실패했습니다. (API Base / 배포 권한 / CORS 등을 확인)</div>`;
      }finally{
        state.loading = false;
        $("btnSearch").disabled = false;
      }
    }

    // -----------------------
    // Bind
    // -----------------------
    window.addEventListener("DOMContentLoaded", ()=>{
      // ✅ 기본값을 먼저 input에 넣고
      $("apiBase").value = window.CHEESE_ADMIN_API_BASE;

      // ✅ 로컬에 저장된 API가 있으면 그걸 덮어쓴다(우선권)
      const savedApi = localStorage.getItem(LS_API);
      if (savedApi && savedApi.trim()){
        $("apiBase").value = savedApi.trim();
        window.CHEESE_ADMIN_API_BASE = savedApi.trim();
      }else{
        // 기본값도 로컬에 저장해둠(다음부터 안정적으로 유지)
        localStorage.setItem(LS_API, window.CHEESE_ADMIN_API_BASE);
      }

      // gsCode도 로컬에서 불러오기
      const savedGs = localStorage.getItem(LS_GS);
      if (savedGs) $("gsCode").value = savedGs;

      setScriptStatus("기본 API 세팅 완료", "ok");

      // Script editor buttons
      $("btnApplyApi")?.addEventListener("click", applyApiBase_);
      $("btnSaveLocal")?.addEventListener("click", saveLocal_);
      $("btnLoadLocal")?.addEventListener("click", loadLocal_);
      $("btnClearLocal")?.addEventListener("click", clearLocal_);
      $("btnCopyGs")?.addEventListener("click", copyGs_);
      $("btnDownloadGs")?.addEventListener("click", downloadGs_);
      $("btnInsertTemplate")?.addEventListener("click", insertTemplate_);

      // Search buttons
      $("btnSearch")?.addEventListener("click", ()=> load(true));
      $("btnReset")?.addEventListener("click", ()=>{
        $("q").value = "";
        $("status").value = "";
        $("country").value = "";
        $("polity").value = "";
        $("category").value = "";
        $("sort").value = "updated_at_desc";
        $("size").value = "50";
        state.page = 1;
        load(true);
      });

      // Enter 검색
      ["q","polity"].forEach(id=>{
        $(id)?.addEventListener("keydown", (e)=>{
          if (e.key === "Enter"){ e.preventDefault(); load(true); }
        });
      });

      // paging
      $("btnPrev")?.addEventListener("click", ()=>{
        if (state.page <= 1) return;
        state.page -= 1;
        load(false);
      });
      $("btnNext")?.addEventListener("click", ()=>{
        state.page += 1;
        load(false);
      });

      // size change
      $("size")?.addEventListener("change", ()=> load(true));

      // 초기 렌더/로드
      render();
      load(true);
    });
  </script>
</body>
</html>
