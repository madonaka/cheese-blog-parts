<!-- post_builder.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„° Â· Cheese Lab Admin</title>

  <!-- âœ… í˜ì´ì§€ ë©”íƒ€(ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ê°€ ì½ìŒ) -->
  <script>
    window.CHEESE_ADMIN_ACTIVE_PAGE  = "post_builder";
    window.CHEESE_ADMIN_PAGE_SUBTITLE = "ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„°";
    window.CHEESE_ADMIN_PAGE_BADGE    = "v0.1";
  </script>

  <!-- Drag & Drop (ë¸”ë¡ ëª©ë¡ ì •ë ¬) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <!-- ë©”ì¸ ê´€ë¦¬ì CSS ì¬ì‚¬ìš© -->
  <link rel="stylesheet" href="./admin.css" />

  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 28px rgba(15,23,42,.10);
      --primary:#111827;
      --soft:#e0f2fe;
      --radius:18px;

      --headerH:56px;
      --sidebarW:280px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    a{ color:inherit; text-decoration:none; }

    /* =========================
       âœ… Admin Shell (slot ê¸°ë°˜)
       ========================= */
    .admin-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    #admin-header-slot{
      position:sticky;
      top:0;
      z-index:50;
      min-height:var(--headerH);
    }

    .admin-main{
      display:flex;
      flex:1 1 auto;
      min-height:calc(100vh - var(--headerH));
    }

    /* âœ… ë©”ë‰´ ìŠ¬ë¡¯(ì¢Œì¸¡ ì‚¬ì´ë“œë°”) */
    .admin-sidebar{
      width:var(--sidebarW);
      flex:0 0 var(--sidebarW);
      background:#fff;
      border-right:1px solid var(--line);
      padding:12px;
      position:sticky;
      top:var(--headerH);
      height:calc(100vh - var(--headerH));
      overflow:auto;
    }

    /* âœ… ë³¸ë¬¸ */
    .admin-content{
      flex:1 1 auto;
      min-width:0;
      padding:14px 14px 28px;
    }

    @media (max-width: 980px){
      .admin-sidebar{ display:none; }
      .admin-content{ padding:12px 12px 24px; }
    }

    /* =========================
       âœ… Page UI (Editor)
       ========================= */
    .wrap{ max-width:1200px; margin:0 auto; }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .page-title{ font-size:18px; font-weight:900; letter-spacing:-.02em; }
    .sub{ color:var(--muted); font-size:12px; }

    .grid{
      display:grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap:12px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .card-h .h1{ font-weight:900; font-size:14px; }
    .card-h .hint{ font-size:12px; color:var(--muted); }
    .card-b{ padding:14px; }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{ border-color:rgba(15,23,42,.28); }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
    .btn.small{ padding:7px 9px; border-radius:11px; }
    .btn.danger{ border-color:rgba(239,68,68,.35); color:#991b1b; }

    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row.right{ justify-content:flex-end; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size:12px; color:var(--muted); font-weight:900; }
    input[type="text"], textarea, select, input[type="number"]{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; line-height:1.45; }
    .mini{ font-size:12px; color:var(--muted); }

    /* ì˜¤ë¥¸ìª½ ë¸”ë¡ ë¦¬ìŠ¤íŠ¸ */
    .block-list{ display:flex; flex-direction:column; gap:8px; padding:12px; }
    .block-item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:grab;
      background:#fff;
    }
    .block-item:active{ cursor:grabbing; }
    .block-item.selected{
      border-color: rgba(17,24,39,.55);
      box-shadow:0 8px 22px rgba(17,24,39,.12);
    }
    .block-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      background:var(--soft);
      border:1px solid rgba(15,23,42,.08);
      flex:0 0 auto;
    }
    .btitle{
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:240px;
    }
    .bmeta{ font-size:11px; color:var(--muted); }
    .block-actions{ display:flex; gap:6px; flex:0 0 auto; }
    .icon-btn{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }
    .icon-btn:hover{ border-color:rgba(15,23,42,.28); }

    /* ì™¼ìª½ ë¯¸ë¦¬ë³´ê¸° */
    .preview .frame{
      border:1px dashed rgba(15,23,42,.20);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .preview .frame .p-title{
      font-size:18px;
      font-weight:900;
      letter-spacing:-.02em;
      margin:0 0 10px;
    }
    .preview .frame .p-meta{
      margin:0 0 14px;
      color:var(--muted);
      font-size:12px;
    }
    .preview article{ line-height:1.62; font-size:14px; }
    .preview h2{ margin:18px 0 8px; font-size:16px; letter-spacing:-.01em; }
    .preview h3{ margin:14px 0 6px; font-size:14px; }

    .summary-box{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(224,242,254,.55);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
    }
    .ad-box{
      border:1px dashed rgba(123,44,57,.40);
      border-radius:16px;
      padding:12px;
      margin:12px 0;
      background:rgba(123,44,57,.03);
      color:#6b0f22;
      font-weight:900;
      font-size:12px;
    }
    .divider{ height:1px; background:rgba(15,23,42,.10); margin:16px 0; }
    .img-wrap img{ max-width:100%; border-radius:14px; border:1px solid rgba(15,23,42,.10); }
    .toc{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px 12px;
      margin:10px 0 14px;
      background:#fff;
    }
    .toc .t{ font-weight:900; font-size:12px; margin-bottom:6px; }
    .toc a{ color:var(--text); text-decoration:none; }
    .toc a:hover{ text-decoration:underline; }
    .sources{
      margin-top:18px; padding-top:14px;
      border-top:1px solid rgba(15,23,42,.10);
      color:var(--muted);
      font-size:12px;
    }
    .sources ul{ margin:8px 0 0; padding-left:18px; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
    }

    /* ì¸í„°ë™í‹°ë¸Œ ë¯¸ë¦¬ë³´ê¸° iframe */
    .pv-embed-wrap{
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      padding:10px;
      background:#fff;
      margin:12px 0;
    }
    .pv-embed-caption{
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
      font-weight:900;
    }
    .pv-iframe{
      width:100%;
      border:0;
      border-radius:14px;
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="admin-shell">
    <!-- âœ… í—¤ë” ìŠ¬ë¡¯ -->
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <!-- âœ… ë©”ë‰´ ìŠ¬ë¡¯ -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <!-- âœ… ë³¸ë¬¸ -->
      <main class="admin-content">
        <div class="wrap">

          <div class="topbar">
            <div>
              <div class="page-title">ê²Œì‹œê¸€ ë¸”ë¡ ì—ë””í„°</div>
              <div class="sub">ì˜¤ë¥¸ìª½ ë¸”ë¡ì„ ë“œë˜ê·¸ë¡œ ì¬ì •ë ¬í•˜ë©´, ì™¼ìª½ ìµœì¢… HTMLì´ ì¦‰ì‹œ ì¬ìƒì„±ë©ë‹ˆë‹¤. (ì¸í„°ë™í‹°ë¸Œ ë¸”ë¡ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì‹¤ì œë¡œ ë™ì‘)</div>
            </div>
            <div class="row right">
              <button class="btn small" id="btnReset">ì´ˆê¸°í™”</button>
              <button class="btn small" id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
              <button class="btn small primary" id="btnSave">ì €ì¥</button>
            </div>
          </div>

          <div class="grid">
            <!-- LEFT: Preview -->
            <div class="card">
              <div class="card-h">
                <div>
                  <div class="h1">ë¯¸ë¦¬ë³´ê¸°(ìµœì¢… HTML ë Œë”)</div>
                  <div class="hint">DBì—ëŠ” ì´ HTMLì„ content_htmlë¡œ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¥¼ ê¶Œì¥</div>
                </div>
                <div class="row">
                  <button class="btn small" id="btnCopyHtml">HTML ë³µì‚¬</button>
                  <button class="btn small" id="btnDownloadHtml">HTML ì €ì¥</button>
                </div>
              </div>

              <div class="card-b preview">
                <div class="field">
                  <label>ê¸€ ì œëª©</label>
                  <input id="postTitle" type="text" placeholder="ì˜ˆ: ê¹€êµ¬, ì„ì‹œì •ë¶€ì˜ ì¤‘ì‹¬ì— ì„  ì´ìœ " />
                </div>

                <div class="field">
                  <label>í…œí”Œë¦¿</label>
                  <select id="templateSelect">
                    <option value="default">ê¸°ë³¸(ì‹¬í”Œ)</option>
                    <option value="profile">ì¸ë¬¼ í”„ë¡œí•„í˜•</option>
                    <option value="timeline">ì—°í‘œí˜•</option>
                  </select>
                </div>

                <div class="field">
                  <label>ì˜µì…˜</label>
                  <div class="row">
                    <label class="mini"><input type="checkbox" id="optTOC" checked /> ëª©ì°¨(TOC)</label>
                    <label class="mini"><input type="checkbox" id="optSources" checked /> ì¶œì²˜ ì„¹ì…˜</label>
                  </div>
                </div>

                <div class="field">
                  <label>ë¯¸ë¦¬ë³´ê¸°</label>
                  <div class="frame">
                    <div class="p-title" id="pvTitle">ì œëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                    <div class="p-meta">
                      <span class="mono">blocks:</span> <span id="pvCount">0</span>
                      &nbsp;Â·&nbsp; <span class="mono">template:</span> <span id="pvTemplate">default</span>
                    </div>
                    <div id="pvBody"></div>
                  </div>
                </div>

                <div class="field">
                  <label>ìµœì¢… HTML(ì½ê¸°ì „ìš©)</label>
                  <textarea id="finalHtml" class="mono" readonly></textarea>
                </div>
              </div>
            </div>

            <!-- RIGHT: Blocks -->
            <div class="card">
              <div class="card-h">
                <div>
                  <div class="h1">ë¸”ë¡(ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)</div>
                  <div class="hint">ë¸”ë¡ í´ë¦­ â†’ ì•„ë˜ í¸ì§‘ íŒ¨ë„ì—ì„œ ë‚´ìš© ìˆ˜ì •</div>
                </div>
                <div class="row">
                  <button class="btn small" id="btnAddSection">ì„¹ì…˜</button>
                  <button class="btn small" id="btnAddSummary">ìš”ì•½</button>
                  <button class="btn small" id="btnAddImage">ì´ë¯¸ì§€</button>
                  <button class="btn small" id="btnAddAd">ê´‘ê³ </button>

                  <button class="btn small" id="btnAddFlash">í”Œë˜ì‹œì¹´ë“œ</button>
                  <button class="btn small" id="btnAddOrder">ë“œë˜ê·¸ ìˆœì„œ</button>
                  <button class="btn small" id="btnAddQuiz">ëœë¤ í€´ì¦ˆ</button>
                </div>
              </div>

              <div class="block-list" id="blockList"></div>

              <div class="card-b">
                <div class="field">
                  <label>ì„ íƒ ë¸”ë¡ í¸ì§‘</label>
                  <div class="mini">ì˜¤ë¥¸ìª½ ëª©ë¡ì—ì„œ ë¸”ë¡ì„ í´ë¦­í•˜ì„¸ìš”.</div>
                </div>

                <div id="editorEmpty" class="mini" style="padding:12px; border:1px dashed rgba(15,23,42,.18); border-radius:14px;">
                  ì•„ì§ ì„ íƒëœ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div id="editorPanel" style="display:none;">
                  <div class="field">
                    <label>ë¸”ë¡ íƒ€ì… / ID</label>
                    <div class="row">
                      <input id="edType" type="text" readonly class="mono" style="max-width:170px;" />
                      <input id="edId" type="text" readonly class="mono" />
                    </div>
                  </div>

                  <div class="field" id="edTitleWrap">
                    <label>ì œëª©</label>
                    <input id="edTitle" type="text" placeholder="ì˜ˆ: ë³¸ë¡  1. ì„ì‹œì •ë¶€" />
                  </div>

                  <div class="field" id="edBodyWrap">
                    <label>ë‚´ìš©</label>
                    <textarea id="edBody" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì¤„ë°”ê¿ˆì€ ìë™ìœ¼ë¡œ <p> ì²˜ë¦¬)"></textarea>
                  </div>

                  <div class="field" id="edUrlWrap" style="display:none;">
                    <label>ì´ë¯¸ì§€ URL</label>
                    <input id="edUrl" type="text" placeholder="https://..." />
                  </div>

                  <div class="field" id="edAdWrap" style="display:none;">
                    <label>ê´‘ê³  ë¬¸êµ¬(í‘œì‹œìš©)</label>
                    <input id="edAdLabel" type="text" placeholder="ì˜ˆ: ë°°ë„ˆ A / ìŠ¬ë¡¯ A" />
                  </div>

                  <!-- í”Œë˜ì‹œì¹´ë“œ -->
                  <div id="edFlashWrap" style="display:none;">
                    <div class="field">
                      <label>ì¹´ë“œ(ì¼ê´„ ì…ë ¥)</label>
                      <div class="mini">í•œ ì¤„ì— 1ì¥: <span class="mono">ì•ë©´[TAB]ë’·ë©´</span> ë˜ëŠ” <span class="mono">ì•ë©´ | ë’·ë©´</span></div>
                      <textarea id="edFlashBulk" placeholder="ì˜ˆ)&#10;ì„ì‚¬ëŠ‘ì•½	1905ë…„ ì²´ê²°&#10;í•œì„±ì¡°ì•½ | 1882ë…„(ì„ì˜¤êµ°ë€)"></textarea>
                    </div>
                    <div class="row">
                      <button class="btn small" id="btnFlashFromBlock">ë¸”ë¡ â†’ í…ìŠ¤íŠ¸</button>
                      <button class="btn small" id="btnFlashToBlock">í…ìŠ¤íŠ¸ â†’ ë¸”ë¡</button>
                    </div>
                  </div>

                  <!-- ë“œë˜ê·¸ ìˆœì„œ -->
                  <div id="edOrderWrap" style="display:none;">
                    <div class="field">
                      <label>ë¬¸ì œ ì œëª©</label>
                      <input id="edOrderTitle" type="text" placeholder="ì˜ˆ: ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!" />
                    </div>
                    <div class="field">
                      <label>ë³´ì¡° ë¬¸êµ¬(ì˜µì…˜)</label>
                      <input id="edOrderSub" type="text" placeholder="ì˜ˆ: ì•„ë˜ í•­ëª©ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì¹˜í•˜ì„¸ìš”." />
                    </div>
                    <div class="field">
                      <label>ì˜µì…˜</label>
                      <div class="row">
                        <label class="mini"><input type="checkbox" id="edOrderShuffle" checked /> ë³´ê¸° ì„ê¸°</label>
                      </div>
                    </div>
                    <div class="field">
                      <label>í•­ëª©(ì¼ê´„ ì…ë ¥)</label>
                      <div class="mini">í•œ ì¤„ì— 1ê°œ í•­ëª©(ìµœì†Œ 2ê°œ)</div>
                      <textarea id="edOrderItems" placeholder="ì˜ˆ)&#10;ëŒ€í•œì œêµ­ ì„ í¬&#10;ì„ì‚¬ëŠ‘ì•½&#10;í•œì¼ë³‘í•©"></textarea>
                    </div>
                    <div class="field">
                      <label>ì •ë‹µ ìˆœì„œ(ì˜µì…˜)</label>
                      <div class="mini">ë¯¸ì…ë ¥ ì‹œ â€œì…ë ¥í•œ í•­ëª© ìˆœì„œâ€ê°€ ì •ë‹µ. ìˆ«ì ì½¤ë§ˆ: <span class="mono">1,3,2</span></div>
                      <input id="edOrderAnswer" type="text" placeholder="ì˜ˆ: 1,2,3" />
                    </div>
                  </div>

                  <!-- ëœë¤ í€´ì¦ˆ ì„ë² ë“œ -->
                  <div id="edQuizWrap" style="display:none;">
                    <div class="field">
                      <label>examKey</label>
                      <input id="edQuizKey" type="text" class="mono" placeholder="ì˜ˆ: khs-era-01" />
                      <div class="mini">questions.html / exam_sets ì‹œíŠ¸ì—ì„œ ì“°ëŠ” í‚¤(ë¸”ë¡œê·¸ì—ì„  data-exam-keyë¡œ ì‚¬ìš©)</div>
                    </div>
                    <div class="field">
                      <label>í‘œì‹œ ì œëª©</label>
                      <input id="edQuizTitle" type="text" placeholder="ì˜ˆ: í•œêµ­ì‚¬ ì‹œëŒ€ ìˆœì„œ ì—°ìŠµë¬¸ì œ â‘ " />
                    </div>
                    <div class="row">
                      <div class="field" style="flex:1 1 120px; min-width:120px;">
                        <label>limit</label>
                        <input id="edQuizLimit" type="number" min="1" max="50" value="5" />
                      </div>
                      <div class="field" style="flex:1 1 160px; min-width:160px;">
                        <label>period(ì˜µì…˜)</label>
                        <input id="edQuizPeriod" type="text" placeholder="ì˜ˆ: í•œêµ­ì‚¬-í†µì‚¬" />
                      </div>
                    </div>
                    <div class="field">
                      <label>topic(ì˜µì…˜)</label>
                      <input id="edQuizTopic" type="text" placeholder="ì˜ˆ: ì‹œëŒ€ìˆœì„œ" />
                    </div>
                    <div class="mini">â€» ì´ ë¸”ë¡ì€ ë¸”ë¡œê·¸ì—ì„œ ì¹˜ì¦ˆ í€´ì¦ˆ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ ë™ì‘í•©ë‹ˆë‹¤.</div>
                  </div>

                  <div class="row right" style="margin-top:10px;">
                    <button class="btn small danger" id="btnDeleteBlock">ì‚­ì œ</button>
                    <button class="btn small primary" id="btnApplyBlock">ì ìš©</button>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- grid -->

        </div><!-- wrap -->
      </main>
    </div>
  </div>

  <!-- âœ… ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./admin-common.js"></script>

  <script>
    /************************************************************
     * âœ… Block Editor (post_builder)
     ************************************************************/

    const $ = (id) => document.getElementById(id);

    const state = { blocks: [], selectedId: null };
    const uid = () => 'b' + Math.random().toString(36).slice(2, 9) + Date.now().toString(36).slice(2,6);

    // âœ… ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œíƒœê·¸ ë¬¸ìì—´ì€ "ìª¼ê°œì„œ" ë§Œë“ ë‹¤ (HTML íŒŒì„œ ë³´í˜¸)
    const CLOSE_SCRIPT = '</scr' + 'ipt>';

    const makeSection = () => ({ id: uid(), type:'section', data:{ title:'ì†Œì œëª©', body:'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\në‘ë²ˆì§¸ ì¤„ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.' } });
    const makeSummary = () => ({ id: uid(), type:'summary', data:{ title:'í•µì‹¬ ìš”ì•½', body:'- ìš”ì•½ 1\n- ìš”ì•½ 2\n- ìš”ì•½ 3' } });
    const makeImage   = () => ({ id: uid(), type:'image',   data:{ title:'ì´ë¯¸ì§€', url:'https://picsum.photos/800/420', alt:'ì´ë¯¸ì§€' } });
    const makeAd      = () => ({ id: uid(), type:'ad',      data:{ label:'ê´‘ê³  ìŠ¬ë¡¯ A' } });

    const makeFlash   = () => ({
      id: uid(),
      type:'flashcard',
      data:{
        title:'í”Œë˜ì‹œì¹´ë“œ',
        cards:[
          { front:'ì„ì‚¬ëŠ‘ì•½', back:'1905ë…„ ì²´ê²°' },
          { front:'í•œì¼ë³‘í•©', back:'1910ë…„' },
        ]
      }
    });

    const makeOrder   = () => ({
      id: uid(),
      type:'order_quiz',
      data:{
        title:'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!',
        sub:'ì•„ë˜ í•­ëª©ì„ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì¹˜í•˜ì„¸ìš”.',
        shuffle:true,
        items:['ëŒ€í•œì œêµ­ ì„ í¬','ì„ì‚¬ëŠ‘ì•½','í•œì¼ë³‘í•©'],
        answerNums:''
      }
    });

    const makeQuiz    = () => ({
      id: uid(),
      type:'quiz_embed',
      data:{
        examKey:'khs-era-01',
        title:'í•œêµ­ì‚¬ ì‹œëŒ€ ìˆœì„œ ì—°ìŠµë¬¸ì œ â‘ ',
        limit:5,
        period:'í•œêµ­ì‚¬-í†µì‚¬',
        topic:'ì‹œëŒ€ìˆœì„œ'
      }
    });

    const blockList = $('blockList');
    let sortable = null;

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('\n',' '); }

    function blockLabel(type){
      if (type==='section') return 'SECTION';
      if (type==='summary') return 'SUMMARY';
      if (type==='image') return 'IMAGE';
      if (type==='ad') return 'AD';
      if (type==='flashcard') return 'FLASH';
      if (type==='order_quiz') return 'ORDER';
      if (type==='quiz_embed') return 'QUIZ';
      return 'BLOCK';
    }
    function blockTitle(b){
      if (b.type==='section') return b.data?.title || 'ì„¹ì…˜';
      if (b.type==='summary') return b.data?.title || 'ìš”ì•½';
      if (b.type==='image') return b.data?.title || 'ì´ë¯¸ì§€';
      if (b.type==='ad') return b.data?.label || 'ê´‘ê³ ';
      if (b.type==='flashcard') return (b.data?.title || 'í”Œë˜ì‹œì¹´ë“œ') + ` (${(b.data?.cards||[]).length}ì¥)`;
      if (b.type==='order_quiz') return (b.data?.title || 'ë“œë˜ê·¸ ìˆœì„œ') + ` (${(b.data?.items||[]).length}ê°œ)`;
      if (b.type==='quiz_embed') return (b.data?.title || 'ëœë¤ í€´ì¦ˆ') + ` (${b.data?.examKey||''})`;
      return b.type;
    }
    function currentBlock(){
      return state.blocks.find(b => b.id===state.selectedId) || null;
    }

    function parasFromText(text){
      const lines = String(text || '').split(/\r?\n/);
      const ps = [];
      let buf = [];
      for (const line of lines){
        const trimmed = line.trim();
        if (!trimmed){
          if (buf.length){
            ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');
            buf = [];
          }
          continue;
        }
        if (trimmed.startsWith('- ')){
          if (buf.length){
            ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');
            buf = [];
          }
          ps.push('__UL_START__');
          ps.push('<li>' + escapeHtml(trimmed.slice(2)) + '</li>');
          ps.push('__UL_END__');
          continue;
        }
        buf.push(trimmed);
      }
      if (buf.length) ps.push('<p>' + escapeHtml(buf.join(' ')) + '</p>');

      const out = [];
      let inUl = false;
      for (const item of ps){
        if (item === '__UL_START__'){
          if (!inUl){ out.push('<ul>'); inUl = true; }
          continue;
        }
        if (item === '__UL_END__'){ continue; }
        if (item.startsWith('<li')){ out.push(item); continue; }
        if (inUl){ out.push('</ul>'); inUl = false; }
        out.push(item);
      }
      if (inUl) out.push('</ul>');
      return out.join('\n');
    }

    function shuffleCopy(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        const t=a[i]; a[i]=a[j]; a[j]=t;
      }
      return a;
    }

    function parseOrderNums(text, n){
      const raw = String(text||'').trim();
      if(!raw) return null;
      const nums = raw.split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => Number(s));

      if(nums.length !== n) return { ok:false, msg:`ì •ë‹µ ìˆœì„œ ìˆ«ì ê°œìˆ˜(${nums.length})ê°€ í•­ëª©(${n})ê³¼ ë‹¬ë¼ìš”.` };
      const seen = new Set();
      for(const x of nums){
        if(!Number.isInteger(x) || x<1 || x>n) return { ok:false, msg:`ì •ë‹µ ìˆœì„œì— 1~${n} ë²”ìœ„ ë°– ìˆ«ìê°€ ìˆì–´ìš”: ${x}` };
        if(seen.has(x)) return { ok:false, msg:'ì •ë‹µ ìˆœì„œì— ì¤‘ë³µ ìˆ«ìê°€ ìˆì–´ìš”.' };
        seen.add(x);
      }
      return { ok:true, nums };
    }

    /* ===========================
       âœ… ì¸í„°ë™í‹°ë¸Œ ìŠ¤ë‹ˆí« ìƒì„±
       =========================== */
    function buildFlashcardSnippet(b){
      const id = `cheese-fc-${b.id}`;
      const cards = Array.isArray(b.data?.cards) ? b.data.cards : [];
      const data = JSON.stringify(cards);

      return [
`<!-- â–¼ í”Œë˜ì‹œì¹´ë“œ -->
<div id="${id}" class="cheese-flashcard-wrapper"></div>

<style>
  .cheese-flashcard-wrapper{display:flex;flex-direction:column;align-items:center;gap:1.2rem;margin:1.5rem 0;}
  .cheese-flashcard{background:none;border:none;padding:0;width:380px;height:230px;perspective:1000px;cursor:pointer;position:relative;border-radius:22px;overflow:hidden;box-shadow:0 14px 30px rgba(15,23,42,.2);}
  .cheese-flashcard.is-flipped .cheese-flashcard-inner{transform:rotateY(180deg);}
  .cheese-flashcard-inner{width:100%;height:100%;position:relative;border-radius:22px;background:#fff;transform-style:preserve-3d;transition:transform .35s ease;}
  .cheese-flashcard-face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:1.2rem 1.4rem;box-sizing:border-box;backface-visibility:hidden;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:1.15rem;text-align:center;line-height:1.5;border-radius:22px;}
  .cheese-flashcard-front{background:#111827;color:#f9fafb;font-weight:800;}
  .cheese-flashcard-back{background:#e0f2fe;color:#111827;transform:rotateY(180deg);font-weight:800;}
  .cheese-flashcard-hint{position:absolute;right:.9rem;bottom:.6rem;font-size:.75rem;opacity:.85;pointer-events:none;}
  @media(max-width:600px){
    .cheese-flashcard{width:84vw;max-width:340px;height:210px;}
  }
</style>

<script>
(function(){
  var root = document.getElementById(${JSON.stringify(id)});
  if(!root) return;

  var cards = ${data};

  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  cards.forEach(function(item, idx){
    var btn = document.createElement("button");
    btn.type = "button";
    btn.className = "cheese-flashcard";
    btn.setAttribute("aria-label", "ì¹´ë“œ " + (idx+1));
    btn.setAttribute("aria-pressed","false");

    btn.innerHTML =
      '<div class="cheese-flashcard-inner">' +
        '<div class="cheese-flashcard-face cheese-flashcard-front">' +
          '<div>' + esc(item.front) + '</div>' +
          '<div class="cheese-flashcard-hint">ğŸ‘‰ ë’¤ì§‘ê¸°</div>' +
        '</div>' +
        '<div class="cheese-flashcard-face cheese-flashcard-back">' +
          '<div>' + esc(item.back) + '</div>' +
          '<div class="cheese-flashcard-hint">ğŸ‘‰ ë’¤ì§‘ê¸°</div>' +
        '</div>' +
      '</div>';

    btn.addEventListener("click", function(){
      btn.classList.toggle("is-flipped");
      btn.setAttribute("aria-pressed", btn.classList.contains("is-flipped") ? "true" : "false");
    });

    root.appendChild(btn);
  });
})();
` + CLOSE_SCRIPT
      ].join('\n');
    }

    function buildOrderQuizSnippet(b){
      const id = `cheese-oq-${b.id}`;
      const title = String(b.data?.title || 'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!').trim();
      const sub   = String(b.data?.sub || '').trim();
      const items = Array.isArray(b.data?.items) ? b.data.items.filter(x => String(x||'').trim()) : [];
      const shuffle = !!b.data?.shuffle;

      const n = items.length;
      const parsed = parseOrderNums(b.data?.answerNums || '', n);
      const correctNums = (parsed && parsed.ok && parsed.nums) ? parsed.nums : null;

      const baseItems = items.map((label, i) => ({ id:`i${i+1}`, label }));
      const correctOrder = correctNums ? correctNums.map(x => `i${x}`) : baseItems.map(x => x.id);
      const viewItems = shuffle ? shuffleCopy(baseItems) : baseItems;

      const viewJson = JSON.stringify(viewItems);
      const correctJson = JSON.stringify(correctOrder);

      return [
`<!-- â–¼ ë“œë˜ê·¸ ìˆœì„œ í€´ì¦ˆ -->
<div id="${id}" class="cheese-order-quiz"></div>

<style>
  .cheese-order-quiz{max-width:720px;margin:1.8rem auto;padding:1.2rem 1.1rem;border-radius:16px;background:#f9fafb;box-shadow:0 8px 22px rgba(15,23,42,.10);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;box-sizing:border-box;}
  .cheese-order-title{font-size:1.35rem;font-weight:900;margin:0 0 .6rem;}
  .cheese-order-sub{font-size:.95rem;color:#6b7280;margin:0 0 1rem;}
  .cheese-order-top{display:flex;flex-wrap:wrap;gap:.6rem;padding:.6rem;border:1px dashed rgba(15,23,42,.18);border-radius:14px;background:#fff;}
  .cheese-order-bottom{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem;margin-top:.9rem;}
  @media(min-width:720px){ .cheese-order-bottom{grid-template-columns:repeat(4,1fr);} }
  .cheese-order-slot{min-height:44px;border-radius:999px;border:2px dashed #d1d5db;background:#fff;display:flex;align-items:center;justify-content:center;font-size:.95rem;color:#9ca3af;box-sizing:border-box;transition:.12s ease;}
  .cheese-order-slot.is-over{border-color:#6366f1;background:#e0e7ff;transform:translateY(-1px);}
  .cheese-order-card{border:2px solid #7B2C39;border-radius:999px;padding:.55rem .9rem;background:#111827;color:#f9fafb;font-weight:900;font-size:.95rem;cursor:grab;user-select:none;box-shadow:0 3px 8px rgba(15,23,42,.20);}
  .cheese-order-card:active{cursor:grabbing;}
  .cheese-order-controls{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;align-items:center;margin-top:1rem;}
  .cheese-order-btn{border:0;border-radius:999px;padding:.7rem 1.1rem;font-weight:900;cursor:pointer;box-shadow:0 4px 10px rgba(15,23,42,.12);}
  .cheese-order-btn.check{background:#dc2626;color:#fff;}
  .cheese-order-btn.reset{background:#e5e7eb;color:#111827;}
  .cheese-order-result{flex:1;color:#4b5563;font-weight:900;}
  .cheese-order-result.ok{color:#15803d;}
  .cheese-order-result.bad{color:#b91c1c;}
  .cheese-order-help{color:#6b7280;font-size:.85rem;margin-top:.7rem;line-height:1.45;}
</style>

<script>
(function(){
  var root = document.getElementById(${JSON.stringify(id)});
  if(!root) return;

  var items = ${viewJson};
  var correct = ${correctJson};

  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  root.innerHTML =
    '<div class="cheese-order-title">' + esc(${JSON.stringify(title)}) + '</div>' +
    (${JSON.stringify(sub)} ? '<div class="cheese-order-sub">' + esc(${JSON.stringify(sub)}) + '</div>' : '') +
    '<div class="cheese-order-top" data-top="1"></div>' +
    '<div class="cheese-order-bottom" data-bottom="1"></div>' +
    '<div class="cheese-order-controls">' +
      '<div class="cheese-order-result"></div>' +
      '<button type="button" class="cheese-order-btn reset">ì´ˆê¸°í™”</button>' +
      '<button type="button" class="cheese-order-btn check">ì±„ì í•˜ê¸°</button>' +
    '</div>' +
    '<div class="cheese-order-help">ğŸ’¡ PCëŠ” ë“œë˜ê·¸&ë“œë¡­, ëª¨ë°”ì¼ì€ â€œì¹´ë“œ íƒ­ â†’ ë¹ˆ ìŠ¬ë¡¯ ìë™ ë°°ì¹˜â€ ë°©ì‹ìœ¼ë¡œë„ í’€ ìˆ˜ ìˆì–´ìš”.</div>';

  var top = root.querySelector(".cheese-order-top");
  var bottom = root.querySelector(".cheese-order-bottom");
  var resultEl = root.querySelector(".cheese-order-result");
  var btnReset = root.querySelector(".cheese-order-btn.reset");
  var btnCheck = root.querySelector(".cheese-order-btn.check");

  function makeSlots(n){
    bottom.innerHTML = "";
    for(var i=0;i<n;i++){
      var s=document.createElement("div");
      s.className="cheese-order-slot";
      s.dataset.slotIndex=String(i);
      s.textContent=(i+1) + "ë²ˆ";
      bottom.appendChild(s);
    }
  }

  function placeToTop(cardEl){
    if(!cardEl) return;
    top.appendChild(cardEl);
  }

  function placeToFirstEmpty(cardEl){
    var slots = Array.from(bottom.querySelectorAll(".cheese-order-slot"));
    for(var i=0;i<slots.length;i++){
      if(!slots[i].querySelector(".cheese-order-card")){
        slots[i].textContent="";
        slots[i].appendChild(cardEl);
        return true;
      }
    }
    return false;
  }

  function resetAll(){
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
    top.innerHTML="";
    makeSlots(items.length);

    items.forEach(function(it){
      var c=document.createElement("div");
      c.className="cheese-order-card";
      c.draggable=true;
      c.dataset.itemId=it.id;
      c.textContent=it.label;
      top.appendChild(c);
    });
  }

  var dragging=null;

  root.addEventListener("dragstart", function(e){
    var card = e.target.closest(".cheese-order-card");
    if(!card) return;
    dragging = card;
    if(e.dataTransfer){
      e.dataTransfer.effectAllowed = "move";
      try{ e.dataTransfer.setData("text/plain", card.dataset.itemId||""); }catch(_){}
    }
  });

  root.addEventListener("dragover", function(e){
    if(!dragging) return;
    var slot = e.target.closest(".cheese-order-slot");
    var isTop = e.target.closest("[data-top]");
    if(!slot && !isTop) return;
    e.preventDefault();
    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });
    if(slot) slot.classList.add("is-over");
  });

  root.addEventListener("drop", function(e){
    if(!dragging) return;
    var slot = e.target.closest(".cheese-order-slot");
    var isTop = e.target.closest("[data-top]");
    if(!slot && !isTop) return;
    e.preventDefault();

    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });

    if(isTop){
      placeToTop(dragging);
    }else{
      var existing = slot.querySelector(".cheese-order-card");
      if(existing) placeToTop(existing);
      slot.textContent="";
      slot.appendChild(dragging);
    }
    dragging=null;
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
  });

  root.addEventListener("dragend", function(){
    dragging=null;
    Array.from(root.querySelectorAll(".cheese-order-slot")).forEach(function(x){ x.classList.remove("is-over"); });
  });

  root.addEventListener("click", function(e){
    var card = e.target.closest(".cheese-order-card");
    if(!card) return;

    var inSlot = card.parentElement && card.parentElement.classList.contains("cheese-order-slot");
    if(inSlot){
      placeToTop(card);
      resultEl.textContent="";
      resultEl.className="cheese-order-result";
      Array.from(bottom.querySelectorAll(".cheese-order-slot")).forEach(function(s){
        if(!s.querySelector(".cheese-order-card")){
          s.textContent=(Number(s.dataset.slotIndex)+1)+"ë²ˆ";
        }
      });
      return;
    }

    var ok = placeToFirstEmpty(card);
    if(!ok) return;
    resultEl.textContent="";
    resultEl.className="cheese-order-result";
  });

  btnCheck.addEventListener("click", function(){
    var slots = Array.from(bottom.querySelectorAll(".cheese-order-slot"));
    var user = slots.map(function(s){
      var c = s.querySelector(".cheese-order-card");
      return c ? (c.dataset.itemId||null) : null;
    });

    if(user.some(function(x){ return !x; })){
      resultEl.textContent="ì•„ì§ ë¹ˆ ì¹¸ì´ ìˆì–´ìš”. ëª¨ë“  ì¹¸ì— ë°°ì¹˜í•´ ì£¼ì„¸ìš”.";
      resultEl.className="cheese-order-result bad";
      return;
    }

    var ok=true;
    for(var i=0;i<correct.length;i++){
      if(user[i] !== correct[i]){ ok=false; break; }
    }

    if(ok){
      resultEl.textContent="ì •ë‹µ! ì•„ì£¼ ì˜í–ˆìŠµë‹ˆë‹¤ ğŸ‘";
      resultEl.className="cheese-order-result ok";
    }else{
      resultEl.textContent="ìˆœì„œê°€ ì¼ë¶€ ë‹¤ë¦…ë‹ˆë‹¤. ë‹¤ì‹œ í’€ì–´ë³´ì„¸ìš”.";
      resultEl.className="cheese-order-result bad";
    }
  });

  btnReset.addEventListener("click", resetAll);

  resetAll();
})();
` + CLOSE_SCRIPT
      ].join('\n');
    }

    function buildQuizEmbedSnippet(b){
      const d = b.data || {};
      const examKey = String(d.examKey||'').trim();
      const title = String(d.title||'ì—°ìŠµë¬¸ì œ').trim();
      const limit = Number(d.limit||5) || 5;
      const period = String(d.period||'').trim();
      const topic = String(d.topic||'').trim();

      const lines = [
        '<div',
        '  class="cheese-quiz"',
        `  data-exam-key="${escapeAttr(examKey)}"`,
        '  data-source="sheet"',
        `  data-limit="${escapeAttr(String(limit))}"`,
        period ? `  data-period="${escapeAttr(period)}"` : '',
        topic ? `  data-topic="${escapeAttr(topic)}"` : '',
        '>',
        `  <h3>${escapeHtml(title)}</h3>`,
        '  <ol class="cheese-quiz-list"></ol>',
        '  <div class="cheese-quiz-buttons">',
        '    <button type="button" class="cheese-quiz-check">ì±„ì í•˜ê¸°</button>',
        '    <button type="button" class="cheese-quiz-reset">ë‹¤ì‹œ í’€ê¸°</button>',
        '  </div>',
        '  <div class="cheese-quiz-result"></div>',
        '</div>',
      ].filter(Boolean);

      return `<!-- â–¼ ëœë¤ í€´ì¦ˆ(ì¹˜ì¦ˆ í€´ì¦ˆ) -->\n` + lines.join('\n');
    }

    function renderBlockToFinalHtml(b){
      if (b.type==='section'){
        const id = 'sec-' + b.id;
        return `
<section class="blk blk--section" id="${escapeAttr(id)}">
  <h2>${escapeHtml(b.data?.title || 'ì†Œì œëª©')}</h2>
  ${parasFromText(b.data?.body || '')}
</section>`.trim();
      }
      if (b.type==='summary'){
        return `
<div class="summary-box blk blk--summary">
  <h3>${escapeHtml(b.data?.title || 'í•µì‹¬ ìš”ì•½')}</h3>
  ${parasFromText(b.data?.body || '')}
</div>`.trim();
      }
      if (b.type==='image'){
        const url = b.data?.url || '';
        const alt = b.data?.alt || 'ì´ë¯¸ì§€';
        return `
<div class="img-wrap blk blk--image">
  <div class="mini" style="margin:0 0 8px; font-weight:900;">${escapeHtml(b.data?.title || 'ì´ë¯¸ì§€')}</div>
  <img src="${escapeAttr(url)}" alt="${escapeAttr(alt)}" />
</div>`.trim();
      }
      if (b.type==='ad'){
        return `
<div class="ad-box blk blk--ad">
  ê´‘ê³  ë¸”ë¡ Â· ${escapeHtml(b.data?.label || 'ê´‘ê³ ')}
  <div class="mini" style="margin-top:6px; color:#6b0f22;">(ìš´ì˜ í™˜ê²½ì— ë§ì¶° ë°°ë„ˆ/ìŠ¬ë¡¯ HTMLë¡œ êµì²´)</div>
</div>`.trim();
      }
      if (b.type==='flashcard') return buildFlashcardSnippet(b).trim();
      if (b.type==='order_quiz') return buildOrderQuizSnippet(b).trim();
      if (b.type==='quiz_embed') return buildQuizEmbedSnippet(b).trim();

      return `<div class="blk">Unknown block</div>`;
    }

    function buildTOC(blocks){
      const items = blocks
        .filter(b => b.type==='section')
        .map(b => {
          const id = 'sec-' + b.id;
          const t = b.data?.title || 'ì†Œì œëª©';
          return `<li><a href="#${escapeAttr(id)}">${escapeHtml(t)}</a></li>`;
        });
      if (!items.length) return '';
      return `
<nav class="toc">
  <div class="t">ëª©ì°¨</div>
  <ul style="margin:0; padding-left:18px;">${items.join('\n')}</ul>
</nav>`.trim();
    }

    function wrapTemplate(templateId, title, innerHtml){
      if (templateId === 'profile'){
        return `
<article class="post post--profile">
  <header class="post__head">
    <h1 style="margin:0 0 6px; font-size:20px; letter-spacing:-.02em;">${escapeHtml(title || '')}</h1>
    <div style="color:rgba(100,116,139,1); font-size:12px;">ì¸ë¬¼ í”„ë¡œí•„ í…œí”Œë¦¿</div>
  </header>
  <div class="divider"></div>
  ${innerHtml}
</article>`.trim();
      }
      if (templateId === 'timeline'){
        return `
<article class="post post--timeline">
  <header class="post__head">
    <h1 style="margin:0 0 6px; font-size:20px; letter-spacing:-.02em;">${escapeHtml(title || '')}</h1>
    <div style="color:rgba(100,116,139,1); font-size:12px;">ì—°í‘œ í…œí”Œë¦¿</div>
  </header>
  <div class="divider"></div>
  ${innerHtml}
</article>`.trim();
      }
      return `<article class="post post--default">${innerHtml}</article>`;
    }

    function buildFinalHtml(){
      const title = $('postTitle').value.trim();
      const templateId = $('templateSelect').value;
      const optTOC = $('optTOC').checked;
      const optSources = $('optSources').checked;

      const bodyParts = [];
      if (optTOC) bodyParts.push(buildTOC(state.blocks));
      bodyParts.push(...state.blocks.map(renderBlockToFinalHtml));

      if (optSources){
        bodyParts.push(`
<div class="sources">
  <div style="font-weight:900;">ì¶œì²˜</div>
  <ul>
    <li>ì˜ˆì‹œ ì¶œì²˜ 1</li>
    <li>ì˜ˆì‹œ ì¶œì²˜ 2</li>
  </ul>
</div>`.trim());
      }

      return wrapTemplate(templateId, title, bodyParts.filter(Boolean).join('\n\n')).trim();
    }

    function renderPreview(){
      const title = $('postTitle').value.trim() || 'ì œëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
      $('pvTitle').textContent = title;
      $('pvCount').textContent = String(state.blocks.length);
      $('pvTemplate').textContent = $('templateSelect').value;

      const final = buildFinalHtml();
      $('finalHtml').value = final;

      const templateId = $('templateSelect').value;
      const optTOC = $('optTOC').checked;
      const optSources = $('optSources').checked;

      const parts = [];
      if (optTOC) parts.push(buildTOC(state.blocks));

      state.blocks.forEach((b) => {
        if (b.type === 'flashcard' || b.type === 'order_quiz'){
          const caption = (b.type==='flashcard') ? 'í”Œë˜ì‹œì¹´ë“œ(ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰)' : 'ë“œë˜ê·¸ ìˆœì„œ í€´ì¦ˆ(ë¯¸ë¦¬ë³´ê¸° ì‹¤í–‰)';
          const h = (b.type==='flashcard') ? 320 : 520;

          parts.push(`
<div class="pv-embed-wrap" data-embed-id="${escapeAttr(b.id)}" data-embed-type="${escapeAttr(b.type)}" data-embed-height="${h}">
  <div class="pv-embed-caption">${escapeHtml(caption)}</div>
  <iframe class="pv-iframe" title="${escapeAttr(caption)}"></iframe>
</div>`.trim());
          return;
        }

        if (b.type==='quiz_embed'){
          const d = b.data || {};
          parts.push(`
<div class="summary-box">
  <div style="font-weight:900; margin-bottom:6px;">ëœë¤ í€´ì¦ˆ(ì„ë² ë“œ)</div>
  <div class="mini mono">examKey: ${escapeHtml(d.examKey||'')}</div>
  <div class="mini">â€» ë¸”ë¡œê·¸ì—ì„œ ì¹˜ì¦ˆ í€´ì¦ˆ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ë©´ ë™ì‘í•©ë‹ˆë‹¤.</div>
</div>`.trim());
          return;
        }

        parts.push(renderBlockToFinalHtml(b));
      });

      if (optSources){
        parts.push(`
<div class="sources">
  <div style="font-weight:900;">ì¶œì²˜</div>
  <ul>
    <li>ì˜ˆì‹œ ì¶œì²˜ 1</li>
    <li>ì˜ˆì‹œ ì¶œì²˜ 2</li>
  </ul>
</div>`.trim());
      }

      $('pvBody').innerHTML = wrapTemplate(templateId, title, parts.filter(Boolean).join('\n\n'));
      hydrateEmbeds();
    Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€Ğº;
    }

    function hydrateEmbeds(){
      const wraps = Array.from(document.querySelectorAll('[data-embed-id]'));
      wraps.forEach((wrap) => {
        const id = wrap.getAttribute('data-embed-id');
        const type = wrap.getAttribute('data-embed-type');
        const h = Number(wrap.getAttribute('data-embed-height')||320);
        const iframe = wrap.querySelector('iframe');
        if(!iframe) return;

        const b = state.blocks.find(x => x.id === id);
        if(!b) return;

        let snippet = '';
        if(type === 'flashcard') snippet = buildFlashcardSnippet(b);
        if(type === 'order_quiz') snippet = buildOrderQuizSnippet(b);

        iframe.style.height = h + 'px';
        iframe.srcdoc = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>body{margin:0;padding:10px;background:#fff;}</style>
</head>
<body>
${snippet}
</body>
</html>`.trim();
      });
    }

    function ensureSortable(){
      if (sortable) return;
    
      // âœ… ë“œë˜ê·¸ ì•ˆì •ì„± ê°•í™”
      // - handle: ë²„íŠ¼ ì˜ì—­(â†‘â†“)ì€ í´ë¦­ìš©ìœ¼ë¡œ ë‚¨ê¸°ê³ , ì™¼ìª½ ì˜ì—­ì—ì„œë§Œ ë“œë˜ê·¸
      // - forceFallback: HTML5 drag ì¶©ëŒ/ì œì•½ì´ ìˆëŠ” í™˜ê²½ì—ì„œë„ ë™ì‘(íŠ¹íˆ ëª¨ë°”ì¼)
      // - delayOnTouchOnly: ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ê³¼ ì¶©ëŒ ì¤„ì´ê¸°
      sortable = new Sortable(blockList, {
        animation: 150,
        draggable: '.block-item',
        handle: '.block-left',
        filter: '.icon-btn, button, a, input, textarea, select, label',
        preventOnFilter: false,
        forceFallback: true,
        fallbackOnBody: true,
        fallbackTolerance: 5,
        delayOnTouchOnly: true,
        delay: 150,
        touchStartThreshold: 5,
        onEnd: () => {
          const ids = Array.from(blockList.querySelectorAll('.block-item')).map(n => n.dataset.id);
          state.blocks = ids.map(id => state.blocks.find(b => b.id===id)).filter(Boolean);
          renderAll();
        }
      });
    }

    function renderBlockList(){
      blockList.innerHTML = '';
      state.blocks.forEach((b, idx) => {
        const el = document.createElement('div');
        el.className = 'block-item' + (state.selectedId===b.id ? ' selected':'');
        el.dataset.id = b.id;

        el.innerHTML = `
<div class="block-left">
  <span class="badge">${blockLabel(b.type)}</span>
  <div style="min-width:0;">
    <div class="btitle" title="${escapeAttr(blockTitle(b))}">${escapeHtml(blockTitle(b))}</div>
    <div class="bmeta">#${idx+1} Â· ${escapeHtml(b.type)}</div>
  </div>
</div>
<div class="block-actions">
  <button class="icon-btn" data-act="up" title="ìœ„ë¡œ">â†‘</button>
  <button class="icon-btn" data-act="down" title="ì•„ë˜ë¡œ">â†“</button>
</div>`;

        el.addEventListener('click', (e) => {
          const act = e.target?.dataset?.act;
          if (act === 'up' || act === 'down'){
            e.stopPropagation();
            moveBlock(b.id, act==='up' ? -1 : 1);
            return;
          }
          selectBlock(b.id);
        });

        blockList.appendChild(el);
      });

      ensureSortable();
    }

    function moveBlock(id, delta){
      const i = state.blocks.findIndex(b => b.id===id);
      if (i < 0) return;
      const j = i + delta;
      if (j < 0 || j >= state.blocks.length) return;
      const tmp = state.blocks[i];
      state.blocks[i] = state.blocks[j];
      state.blocks[j] = tmp;
      renderAll();
    }

    function selectBlock(id){
      state.selectedId = id;
      renderBlockList();
      fillEditor();
      renderPreview();
    }

    function show(el, on){
      if(!el) return;
      el.style.display = on ? '' : 'none';
    }

    function fillEditor(){
      const b = currentBlock();
      show($('editorEmpty'), !b);
      show($('editorPanel'), !!b);
      if (!b) return;

      $('edType').value = b.type;
      $('edId').value = b.id;

      show($('edTitleWrap'), false);
      show($('edBodyWrap'), false);
      show($('edUrlWrap'), false);
      show($('edAdWrap'), false);
      show($('edFlashWrap'), false);
      show($('edOrderWrap'), false);
      show($('edQuizWrap'), false);

      if (b.type==='section' || b.type==='summary'){
        show($('edTitleWrap'), true);
        show($('edBodyWrap'), true);
        $('edTitle').value = b.data?.title || '';
        $('edBody').value  = b.data?.body || '';
      } else if (b.type==='image'){
        show($('edTitleWrap'), true);
        show($('edUrlWrap'), true);
        $('edTitle').value = b.data?.title || '';
        $('edUrl').value   = b.data?.url || '';
      } else if (b.type==='ad'){
        show($('edAdWrap'), true);
        $('edAdLabel').value = b.data?.label || '';
      } else if (b.type==='flashcard'){
        show($('edTitleWrap'), true);
        show($('edFlashWrap'), true);
        $('edTitle').value = b.data?.title || 'í”Œë˜ì‹œì¹´ë“œ';
      } else if (b.type==='order_quiz'){
        show($('edOrderWrap'), true);
        $('edOrderTitle').value = b.data?.title || '';
        $('edOrderSub').value = b.data?.sub || '';
        $('edOrderShuffle').checked = !!b.data?.shuffle;
        $('edOrderItems').value = (Array.isArray(b.data?.items) ? b.data.items : []).join('\n');
        $('edOrderAnswer').value = b.data?.answerNums || '';
      } else if (b.type==='quiz_embed'){
        show($('edQuizWrap'), true);
        $('edQuizKey').value = b.data?.examKey || '';
        $('edQuizTitle').value = b.data?.title || '';
        $('edQuizLimit').value = String(b.data?.limit || 5);
        $('edQuizPeriod').value = b.data?.period || '';
        $('edQuizTopic').value = b.data?.topic || '';
      }
    }

    function flashBlockToBulk(){
      const b = currentBlock();
      if(!b || b.type!=='flashcard') return;
      const cards = Array.isArray(b.data?.cards) ? b.data.cards : [];
      $('edFlashBulk').value = cards.map(c => `${c.front}\t${c.back}`).join('\n');
    }
    function flashBulkToBlock(){
      const b = currentBlock();
      if(!b || b.type!=='flashcard') return;

      const lines = String($('edFlashBulk').value||'').split(/\r?\n/);
      const cards = [];
      lines.forEach(line => {
        const t = line.trim();
        if(!t) return;

        let front='', back='';
        if(t.includes('\t')){
          const parts = t.split('\t');
          front = (parts[0]||'').trim();
          back  = parts.slice(1).join('\t').trim();
        }else if(t.includes('|')){
          const parts = t.split('|');
          front = (parts[0]||'').trim();
          back  = parts.slice(1).join('|').trim();
        }else{
          front = t;
          back = '';
        }
        if(front) cards.push({ front, back });
      });

      b.data.cards = cards.length ? cards : [{front:'ì•ë©´', back:'ë’·ë©´'}];
    }

    function renderAll(){
      renderBlockList();
      fillEditor();
      renderPreview();
    }

    function addBlock(b){
      state.blocks.push(b);
      state.selectedId = b.id;
      renderAll();
    }

    $('btnAddSection').addEventListener('click', () => addBlock(makeSection()));
    $('btnAddSummary').addEventListener('click', () => addBlock(makeSummary()));
    $('btnAddImage').addEventListener('click', () => addBlock(makeImage()));
    $('btnAddAd').addEventListener('click', () => addBlock(makeAd()));
    $('btnAddFlash').addEventListener('click', () => addBlock(makeFlash()));
    $('btnAddOrder').addEventListener('click', () => addBlock(makeOrder()));
    $('btnAddQuiz').addEventListener('click', () => addBlock(makeQuiz()));

    $('btnFlashFromBlock').addEventListener('click', flashBlockToBulk);
    $('btnFlashToBlock').addEventListener('click', () => { flashBulkToBlock(); renderAll(); });

    $('btnApplyBlock').addEventListener('click', () => {
      const b = currentBlock();
      if (!b) return;

      if (b.type==='section' || b.type==='summary'){
        b.data.title = $('edTitle').value.trim() || (b.type==='section' ? 'ì†Œì œëª©' : 'í•µì‹¬ ìš”ì•½');
        b.data.body  = $('edBody').value || '';
      } else if (b.type==='image'){
        b.data.title = $('edTitle').value.trim() || 'ì´ë¯¸ì§€';
        b.data.url   = $('edUrl').value.trim() || 'https://picsum.photos/800/420';
        b.data.alt   = b.data.title;
      } else if (b.type==='ad'){
        b.data.label = $('edAdLabel').value.trim() || 'ê´‘ê³ ';
      } else if (b.type==='flashcard'){
        b.data.title = $('edTitle').value.trim() || 'í”Œë˜ì‹œì¹´ë“œ';
        flashBulkToBlock();
      } else if (b.type==='order_quiz'){
        const items = String($('edOrderItems').value||'')
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean);

        if(items.length < 2){
          alert('ë“œë˜ê·¸ ìˆœì„œ í•­ëª©ì€ ìµœì†Œ 2ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }

        const parsed = parseOrderNums($('edOrderAnswer').value, items.length);
        if(parsed && parsed.ok === false){
          alert(parsed.msg);
          return;
        }

        b.data.title = $('edOrderTitle').value.trim() || 'ì˜ ì•Œê³  ìˆë‚˜ í™•ì¸í•´ë³´ê¸°!';
        b.data.sub = $('edOrderSub').value.trim();
        b.data.shuffle = $('edOrderShuffle').checked;
        b.data.items = items;
        b.data.answerNums = $('edOrderAnswer').value.trim();
      } else if (b.type==='quiz_embed'){
        const examKey = $('edQuizKey').value.trim();
        if(!examKey){
          alert('examKeyëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
          return;
        }
        b.data.examKey = examKey;
        b.data.title = $('edQuizTitle').value.trim() || 'ì—°ìŠµë¬¸ì œ';
        b.data.limit = Math.max(1, Number($('edQuizLimit').value||5) || 5);
        b.data.period = $('edQuizPeriod').value.trim();
        b.data.topic = $('edQuizTopic').value.trim();
      }

      renderAll();
    });

    $('btnDeleteBlock').addEventListener('click', () => {
      const b = currentBlock();
      if (!b) return;
      state.blocks = state.blocks.filter(x => x.id !== b.id);
      state.selectedId = null;
      renderAll();
    });

    $('templateSelect').addEventListener('change', renderPreview);
    $('optTOC').addEventListener('change', renderPreview);
    $('optSources').addEventListener('change', renderPreview);
    $('postTitle').addEventListener('input', renderPreview);

    $('btnSave').addEventListener('click', () => {
      const payload = {
        title: $('postTitle').value.trim(),
        template_id: $('templateSelect').value,
        options: { toc: $('optTOC').checked, sources: $('optSources').checked },
        blocks_json: JSON.parse(JSON.stringify(state.blocks)),
        content_html: $('finalHtml').value
      };
      localStorage.setItem('post_builder_draft', JSON.stringify(payload));
      alert('ì €ì¥ë¨(localStorage). ë‹¤ìŒ ë‹¨ê³„ì—ì„œ Apps Script ì €ì¥ APIë¡œ êµì²´í•˜ë©´ ë©ë‹ˆë‹¤.');
    });

    $('btnLoad').addEventListener('click', () => {
      const raw = localStorage.getItem('post_builder_draft');
      if (!raw){ alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
      const p = JSON.parse(raw);
      $('postTitle').value = p.title || '';
      $('templateSelect').value = p.template_id || 'default';
      $('optTOC').checked = !!p.options?.toc;
      $('optSources').checked = !!p.options?.sources;
      state.blocks = Array.isArray(p.blocks_json) ? p.blocks_json : [];
      state.selectedId = state.blocks[0]?.id || null;
      renderAll();
    });

    $('btnCopyHtml').addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText($('finalHtml').value || '');
        alert('HTML ë³µì‚¬ ì™„ë£Œ');
      }catch(e){
        alert('ë³µì‚¬ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)');
      }
    });

    $('btnDownloadHtml').addEventListener('click', () => {
      const html = $('finalHtml').value || '';
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'post_content_html.html';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    $('btnReset').addEventListener('click', initDemo);

    function initDemo(){
      $('postTitle').value = 'ê¹€êµ¬, ì„ì‹œì •ë¶€ì˜ ì¤‘ì‹¬ì— ì„  ì´ìœ ';
      $('templateSelect').value = 'profile';
      $('optTOC').checked = true;
      $('optSources').checked = true;

      state.blocks = [
        { id: uid(), type:'summary', data:{ title:'í•µì‹¬ ìš”ì•½', body:'- ê¹€êµ¬ì˜ ì •ì¹˜ì  ì¤‘ì‹¬ì„±\n- ì„ì‹œì •ë¶€ì˜ ì •í†µì„± ë…¼ìŸ\n- í•´ë°© ì´í›„ì˜ ì—­í• ê³¼ í•œê³„' } },
        { id: uid(), type:'section', data:{ title:'1. ìƒí•´ ì„ì‹œì •ë¶€ì˜ êµ¬ì‹¬ì ', body:'ê¹€êµ¬ëŠ” ì„ì‹œì •ë¶€ ë‚´ì—ì„œ ì¡°ì§ ìš´ì˜ê³¼ ëŒ€ì™¸ í™œë™ì„ ì¡°ìœ¨í–ˆë‹¤.\n\níŠ¹íˆ ë…ë¦½ìš´ë™ ë…¸ì„ ê³¼ ìê¸ˆ ë¬¸ì œì—ì„œ ì˜í–¥ë ¥ì„ ê°€ì¡Œë‹¤.' } },
        makeFlash(),
        { id: uid(), type:'ad', data:{ label:'ë°°ë„ˆ A' } },
        makeOrder(),
        { id: uid(), type:'image', data:{ title:'ê´€ë ¨ ì´ë¯¸ì§€', url:'https://picsum.photos/900/480', alt:'ê´€ë ¨ ì´ë¯¸ì§€' } },
        makeQuiz(),
        { id: uid(), type:'section', data:{ title:'2. ë…ë¦½ìš´ë™ ë…¸ì„ ê³¼ ì •í†µì„±', body:'ë¬´ì¥ íˆ¬ìŸÂ·ì™¸êµ ë…¸ì„ ì˜ ê· í˜• ì†ì—ì„œ ë‚´ë¶€ ê°ˆë“±ì´ ë°˜ë³µëë‹¤.\nê¹€êµ¬ëŠ” í†µí•©ì„ ê°•ì¡°í–ˆì§€ë§Œ, ë…¸ì„  ì°¨ì´ëŠ” ì§€ì†ëë‹¤.' } },
      ];

      state.selectedId = state.blocks[0]?.id || null;
      renderAll();

      const fc = state.blocks.find(x => x.type==='flashcard');
      if(fc){
        state.selectedId = fc.id;
        renderAll();
        flashBlockToBulk();
      }
    }

    initDemo();
  </script>
</body>
</html>
