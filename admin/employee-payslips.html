<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>급여명세서 · 직원 포털</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --shadow:0 10px 28px rgba(15,23,42,.10);
      --primary:#111827;
      --accent:#7B2C39;
      --ok:#16a34a;
      --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 18px 40px;}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:14px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:-.02em;}
    .brand .sub{font-size:13px;color:var(--muted);}
    .right{display:flex;gap:10px;align-items:center;}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:600;
      color:var(--primary);
    }
    .btn:active{transform:translateY(1px);}
    .btn.accent{background:var(--primary); color:#fff; border-color:transparent;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-top:12px;
    }
    .card-h{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .card-h .title{font-size:15px;font-weight:700;margin:0;}
    .card-h .hint{font-size:12px;color:var(--muted);}
    .card-b{padding:14px;}
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 0;
      border-bottom:1px dashed var(--line);
    }
    .row:last-child{border-bottom:none;}
    .meta{display:flex;flex-direction:column;gap:4px;min-width:0;}
    .meta .run{font-weight:800;letter-spacing:-.01em;}
    .meta .desc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .actions{display:flex;gap:8px;flex-shrink:0;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:700;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
    }
    .chip.ok{color:var(--ok); border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.06);}
    .chip.bad{color:var(--bad); border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.06);}
    .empty{
      padding:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111827; color:#fff; padding:10px 12px; border-radius:12px;
      font-size:13px; box-shadow:0 10px 26px rgba(0,0,0,.18);
      opacity:0; pointer-events:none; transition:.18s ease;
      max-width:92vw;
    }
    .toast.show{opacity:1;}
    .muted{color:var(--muted);}
    .small{font-size:12px;}
    .loading{padding:18px;color:var(--muted);font-size:13px;}
  
  .more{display:flex; justify-content:center; padding:10px 0 0;}
</style>
</head>


<body>
  <div class="admin-shell">
    <!-- ✅ 헤더 슬롯 -->
    <div id="admin-header-slot"></div>
  
    <div class="admin-main">
      <!-- ✅ 메뉴 슬롯 -->
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>
  
      <!-- ✅ 본문 -->
      <main class="admin-content">
        <div class="wrap">
  
          <div class="top">
            <div class="brand">
              <h1>급여명세서</h1>
              <div class="sub" id="meLine">로그인 확인 중…</div>
            </div>
            <div class="right">
              <button class="btn" id="btn-refresh" type="button">새로고침</button>
              <button class="btn accent" id="btn-logout" type="button">로그아웃</button>
            </div>
          </div>
      
          <div class="card">
            <div class="card-h">
              <div>
                <p class="title">내 급여명세서 목록</p>
                <div class="hint">내 계정(사번) 기준으로 접근 가능한 명세서만 표시됩니다.</div>
              </div>
              <div class="chip" id="countChip">0건</div>
            </div>
            <div class="card-b" id="listArea">
              <div class="loading">목록을 불러오는 중…</div>
            </div>
          </div>
      
          <div class="card">
            <div class="card-h">
              <p class="title">안내</p>
              <div class="hint">보안/열람 관련</div>
            </div>
            <div class="card-b">
              <div class="small muted">
                - “열람” 버튼은 (1) Drive 공유 링크로 열거나, (2) 서버에서 PDF를 받아 새 창으로 띄우는 방식 중 하나로 동작합니다.<br/>
                - 현재 페이지는 직원 공용 1장이며, 로그인한 사람의 사번으로 서버가 권한 체크를 합니다.
              </div>
            </div>
          </div>
        </div>
      
        <div class="toast" id="toast"></div>
      </main>
<script>
/* =========================================================
 * 급여명세서(직원) 화면 — API.txt 스펙 기준
 *
 * ✅ 사용 API (GAS Web App)
 *  - GET  : mode=myPayslips&actor=...&limit=...&cursor=...
 *  - POST : mode=generatePayslip (actor + payslipId)
 *
 * ⚠️ actor는 "사번/이메일/로그인토큰" 중, 백엔드가 식별 가능한 값이어야 합니다.
 *    이 화면은 우선 session/localStorage에 저장된 값(EMPNO → token 순)으로 전송합니다.
 * ========================================================= */

const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzPwih6oigD9Wdvv2rw4YBC0iZwEoQ2lc1Kk2kD1_K89Edv2SQimG_9gXG5YjGKJCw/exec";
const LOGIN_PAGE = "./login.html"; // 필요 시 경로 수정

// 스토리지 키 (기존 페이지들과 호환)
const TOKEN_KEY  = "cheese_admin_token";     // 로그인 토큰(또는 이메일 등)
const EMPNO_KEY  = "cheese_admin_empNo";     // 사번(가능하면 이 값을 actor로 사용)
const NAME_KEY   = "cheese_admin_name";
const ROLE_KEY   = "cheese_admin_role";

const PAGE_SIZE = 30;

const qs = (sel, el=document) => el.querySelector(sel);

function setStatus(msg){
  const el = qs("#statusLine");
  if (el) el.textContent = msg || "";
}

function showToast(msg){
  const t = qs("#toast");
  if (!t) return;
  t.textContent = msg || "";
  t.classList.add("show");
  clearTimeout(showToast._tm);
  showToast._tm = setTimeout(()=>t.classList.remove("show"), 2200);
}

function getActor(){
  const empNo = (sessionStorage.getItem(EMPNO_KEY) || localStorage.getItem(EMPNO_KEY) || "").trim();
  if (empNo) return empNo;

  const token = (sessionStorage.getItem(TOKEN_KEY) || localStorage.getItem(TOKEN_KEY) || "").trim();
  return token;
}

function getMeLabel(){
  const name = (sessionStorage.getItem(NAME_KEY) || localStorage.getItem(NAME_KEY) || "").trim();
  const role = (sessionStorage.getItem(ROLE_KEY) || localStorage.getItem(ROLE_KEY) || "").trim();
  const actor = getActor();
  return [
    name ? `이름: ${name}` : "",
    role ? `역할: ${role}` : "",
    actor ? `actor: ${actor}` : ""
  ].filter(Boolean).join(" · ");
}

function logout(){
  [TOKEN_KEY, EMPNO_KEY, NAME_KEY, ROLE_KEY].forEach(k=>{
    sessionStorage.removeItem(k);
    localStorage.removeItem(k);
  });
  location.href = LOGIN_PAGE;
}

async function apiGet(params){
  const url = GAS_WEBAPP_URL + "?" + new URLSearchParams(params).toString();
  const res = await fetch(url, { method: "GET" });
  const json = await res.json().catch(()=>null);
  if (!json) throw new Error("서버 응답을 JSON으로 해석할 수 없습니다.");
  if (json.ok === false) throw new Error(json.message || "요청 실패");
  // {ok:true, data:{...}} 형태를 우선 지원
  return json.data ?? json.result ?? json;
}

async function apiPost(params){
  const body = new URLSearchParams(params);
  const res = await fetch(GAS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body
  });
  const json = await res.json().catch(()=>null);
  if (!json) throw new Error("서버 응답을 JSON으로 해석할 수 없습니다.");
  if (json.ok === false) throw new Error(json.message || "요청 실패");
  return json.data ?? json.result ?? json;
}

function fmtYmd(dt){
  if (!dt) return "";
  const d = new Date(dt);
  if (isNaN(d.getTime())) return String(dt);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function numberOrDash(v){
  if (v === null || v === undefined || v === "") return "—";
  const n = Number(v);
  if (Number.isFinite(n)) return n.toLocaleString("ko-KR");
  return String(v);
}

let state = {
  items: [],
  nextCursor: null,
  loading: false
};

function normalizeListPayload(payload){
  // payload 자체가 배열인 경우도 대비
  if (Array.isArray(payload)) return { items: payload, nextCursor: null };

  const items =
    payload.items ||
    payload.payslips ||
    payload.list ||
    payload.rows ||
    payload.data ||
    [];

  const nextCursor =
    payload.nextCursor ??
    payload.cursor ??
    payload.next ??
    null;

  return { items: Array.isArray(items) ? items : [], nextCursor };
}

function renderList(){
  const area = qs("#listArea");
  const chip = qs("#countChip");
  const items = state.items;

  if (chip) chip.textContent = `${items.length}건`;

  if (!items.length){
    area.innerHTML = `
      <div class="empty">
        표시할 급여명세서가 없습니다.<br/>
        <span class="small">- 아직 RUN이 생성되지 않았거나, 권한/공유 설정이 되어있지 않을 수 있습니다.</span>
      </div>
    `;
    return;
  }

  area.innerHTML = "";

  items.forEach((item, idx)=>{
    const payslipId = item.payslipId || item.payslip_id || item.id || item.payslipIdStr || "";
    const runId = item.runId || item.run_id || item.payrollRunId || "";
    const period = item.periodLabel || item.period || item.payPeriod || "";
    const createdAt = fmtYmd(item.createdAt || item.created_at || item.created || "");
    const statusRaw = item.status || item.state || "READY";
    const status = String(statusRaw).toUpperCase();

    const netPay = item.netPay ?? item.net_pay ?? item.amountNet ?? item.net ?? null;

    const url = item.payslipFileUrl || item.fileUrl || item.url || item.pdfUrl || "";

    const okStatuses = new Set(["READY","PUBLISHED","PUBLISH","OK","DONE","SUCCESS"]);
    const badStatuses = new Set(["ERROR","FAILED","FAIL"]);
    const chipClass = okStatuses.has(status) ? "ok" : (badStatuses.has(status) ? "bad" : "");
    const chipText = status || "—";

    const desc = [
      period ? `기간: ${period}` : "",
      createdAt ? `생성: ${createdAt}` : "",
      (netPay !== null && netPay !== undefined) ? `실수령: ${numberOrDash(netPay)}원` : "",
      runId ? `run: ${runId}` : ""
    ].filter(Boolean).join(" · ");

    const card = document.createElement("div");
    card.className = "row";
    card.innerHTML = `
      <div class="row-top">
        <div class="row-title">${period || ("급여명세서 #" + (idx+1))}</div>
        <div class="chip ${chipClass}">${chipText}</div>
      </div>
      <div class="row-desc">${desc || "—"}</div>
      <div class="row-actions">
        <button class="btn btn-soft" data-action="open" ${url ? "" : "data-gen='1'"}>열기</button>
        ${url ? `<a class="btn btn-ghost" href="${url}" target="_blank" rel="noopener">링크</a>` : ""}
        <div class="small mono">${payslipId ? "payslipId: "+payslipId : ""}</div>
      </div>
    `;

    card.querySelector('[data-action="open"]').addEventListener("click", ()=>openPayslip(item));
    area.appendChild(card);
  });

  // Load more
  if (state.nextCursor){
    const more = document.createElement("div");
    more.className = "more";
    more.innerHTML = `<button class="btn" id="btn-more">더 보기</button>`;
    area.appendChild(more);
    qs("#btn-more").addEventListener("click", ()=>loadPayslips({ append:true }));
  }
}

async function openPayslip(item){
  const actor = getActor();
  if (!actor){
    showToast("로그인이 필요합니다.");
    location.href = LOGIN_PAGE;
    return;
  }

  const directUrl = item.payslipFileUrl || item.fileUrl || item.url || item.pdfUrl || "";
  if (directUrl){
    window.open(directUrl, "_blank", "noopener");
    return;
  }

  const payslipId = item.payslipId || item.payslip_id || item.id || "";
  const runId = item.runId || item.run_id || item.payrollRunId || "";

  if (!payslipId && !runId){
    showToast("payslipId/runId가 없어 생성 요청을 할 수 없습니다.");
    return;
  }

  try{
    setStatus("PDF 생성 중…");
    const payload = {
      mode: "generatePayslip",
      actor,
      // 백엔드가 payslipId를 요구하는 스펙이므로 우선 payslipId 중심으로 보냄
      payslipId: payslipId || "",
      // 혹시 runId 기반으로 구현된 경우 대비 (백엔드에서 무시해도 무방)
      runId: runId || ""
    };

    const data = await apiPost(payload);

    const url =
      data.payslipFileUrl ||
      data.fileUrl ||
      data.url ||
      data.pdfUrl ||
      "";

    if (!url){
      console.error("generatePayslip response:", data);
      showToast("생성 결과에 URL이 없습니다.");
      setStatus("");
      return;
    }

    window.open(url, "_blank", "noopener");
    setStatus("");
  }catch(err){
    console.error(err);
    showToast(err.message || String(err));
    setStatus("");
  }
}

async function loadPayslips(opts={ reset:true, append:false }){
  if (state.loading) return;
  state.loading = true;

  const actor = getActor();
  if (!actor){
    showToast("로그인이 필요합니다.");
    location.href = LOGIN_PAGE;
    return;
  }

  const reset = !!opts.reset && !opts.append;
  if (reset){
    state.items = [];
    state.nextCursor = null;
  }

  try{
    setStatus("급여명세서 불러오는 중…");
    const params = {
      mode: "myPayslips",
      actor,
      limit: String(PAGE_SIZE)
    };
    if (opts.append && state.nextCursor){
      params.cursor = String(state.nextCursor);
    }
    const payload = await apiGet(params);
    const norm = normalizeListPayload(payload);

    state.items = opts.append ? state.items.concat(norm.items) : norm.items;
    state.nextCursor = norm.nextCursor;

    renderList();
    qs("#meLine").textContent = getMeLabel();
    setStatus("");
  }catch(err){
    console.error(err);
    showToast(err.message || String(err));
    setStatus("");
  }finally{
    state.loading = false;
  }
}

// 초기화
(function init(){
  // 버튼
  qs("#btn-refresh")?.addEventListener("click", ()=>loadPayslips({ reset:true }));
  qs("#btn-logout")?.addEventListener("click", logout);

  // 로그인 체크
  if (!getActor()){
    location.href = LOGIN_PAGE;
    return;
  }

  qs("#meLine").textContent = getMeLabel();
  loadPayslips({ reset:true });
})();
</script>
</body>
</html>
