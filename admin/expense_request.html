<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>지출 정산 신청 · Cheese Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- 공통 CSS -->
    <link rel="stylesheet" href="./admin.css" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
      }

      .expense-shell {
        max-width: 720px;
        margin: 1.5rem auto 2.5rem;
        padding: 1.75rem 1.5rem;
        border-radius: 1.25rem;
        background: #ffffff;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
        box-sizing: border-box;
      }

      .expense-title {
        font-size: 1.35rem;
        font-weight: 600;
        margin: 0 0 0.25rem;
        letter-spacing: -0.03em;
      }

      .expense-sub {
        margin: 0 0 1.25rem;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .expense-field {
        margin-bottom: 0.9rem;
      }

      .expense-label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #374151;
      }

      .expense-input,
      .expense-textarea {
        width: 100%;
        box-sizing: border-box;
        border-radius: 0.7rem;
        border: 1px solid #d1d5db;
        padding: 0.55rem 0.7rem;
        font-size: 0.85rem;
        outline: none;
        background: #f9fafb;
      }

      .expense-input:focus,
      .expense-textarea:focus {
        border-color: #2563eb;
        background: #ffffff;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      }

      .expense-textarea {
        min-height: 70px;
        resize: vertical;
      }

      .expense-hint {
        font-size: 0.73rem;
        color: #9ca3af;
        margin-top: 0.2rem;
      }

      .expense-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .expense-status {
        font-size: 0.8rem;
        color: #6b7280;
        min-width: 0;
        flex: 1 1 180px;
      }

      .expense-btns {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        border-radius: 999px;
        border: 0;
        padding: 0.45rem 1.2rem;
        font-size: 0.82rem;
        cursor: pointer;
        font-weight: 500;
      }

      .btn-primary {
        background: #2563eb;
        color: #f9fafb;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-ghost {
        background: transparent;
        color: #4b5563;
      }

      .budget-info {
        margin-top: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.7rem;
        background: #f9fafb;
        font-size: 0.78rem;
        color: #4b5563;
        border: 1px dashed #e5e7eb;
      }

      .budget-info strong {
        font-weight: 600;
      }

      .budget-info.over {
        border-color: #f97316;
        background: #fff7ed;
        color: #9a3412;
      }

      @media (max-width: 640px) {
        .expense-shell {
          margin: 1rem 0.75rem 2rem;
          padding: 1.25rem 1rem;
        }

        .expense-footer {
          flex-direction: column-reverse;
          align-items: stretch;
        }

        .expense-btns {
          justify-content: flex-end;
        }

        .expense-footer .btn {
          /* 필요하면 width: 100%; 로 풀폭 버튼도 가능 */
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-shell">
      <!-- 헤더 슬롯 -->
      <div id="admin-header-slot"></div>

      <div class="admin-main">
        <!-- 왼쪽 메뉴 -->
        <aside id="admin-menu-slot" class="admin-sidebar"></aside>

        <!-- 본문 -->
        <main class="admin-content">
          <div class="expense-shell">
            <h1 class="expense-title">지출 정산 신청</h1>
            <p class="expense-sub">
              승인된 예산요청(request_id)에 대해 실제 지출 내용을 등록합니다.
              영수증/증빙 링크를 함께 남겨 주세요.
            </p>

            <div class="expense-field">
              <label class="expense-label" for="requestId">request_id</label>
              <input
                id="requestId"
                class="expense-input"
                placeholder="예: R2025-12-002"
              />
              <div class="expense-hint">
                BUDGET_REQUESTS 시트에서 승인된 예산요청의 request_id를 입력합니다.
              </div>
              <div id="budget-info" class="budget-info" style="display:none;"></div>
            </div>
            
            <!-- 지출 사용 등록 화면 예시 -->
            <div class="form-row approval-line-row">
              <label for="expense-approval-line-name" class="form-label">결재선</label>
            
              <div class="approval-line-input-group">
                <input
                  type="text"
                  id="expense-approval-line-name"
                  name="approvalLineName"
                  class="form-control"
                  placeholder="결재선을 선택해주세요"
                  readonly
                />
                <input
                  type="hidden"
                  id="expense-approval-line-id"
                  name="approvalLineId"
                />
                <button
                  type="button"
                  class="btn btn-outline"
                  data-approval-line-id="expense-approval-line-id"
                  data-approval-line-name="expense-approval-line-name"
                >
                  결재선 선택
                </button>
              </div>
            </div>

            <div class="expense-field">
              <label class="expense-label" for="date">지출일</label>
              <input id="date" class="expense-input" type="date" />
            </div>

            <div class="expense-field">
              <label class="expense-label" for="vendor">거래처 / 상호</label>
              <input
                id="vendor"
                class="expense-input"
                placeholder="예: 구글코리아, 네이버파이낸셜 등"
              />
            </div>

            <div class="expense-field">
              <label class="expense-label" for="amount">지출 금액 (원)</label>
              <input
                id="amount"
                class="expense-input"
                inputmode="numeric"
                placeholder="예: 150000"
              />
              <div class="expense-hint">
                쉼표 없이 숫자만 입력 (예: 150000)
              </div>
            </div>

            <div class="expense-field">
              <label class="expense-label" for="requester">요청자 이메일</label>
              <input
                id="requester"
                class="expense-input"
                type="email"
                placeholder="예: kim@company.com"
              />
            </div>

            <div class="expense-field">
              <label class="expense-label" for="receiptUrl">영수증 / 증빙 링크</label>
              <input
                id="receiptUrl"
                class="expense-input"
                type="url"
                placeholder="예: Google Drive 공유 링크, 카드사 영수증 URL 등"
              />
              <div class="expense-hint">
                실제 영수증 파일은 별도로 업로드한 후, 확인 가능한 링크를 붙여 주세요.
              </div>
            </div>

            <div class="expense-field">
              <label class="expense-label" for="note">비고 / 상세 내용</label>
              <textarea
                id="note"
                class="expense-textarea"
                placeholder="예: 12월 구글 광고비 중 리마케팅 캠페인 집행분"
              ></textarea>
            </div>

            <div class="expense-footer">
              <div id="exp-status" class="expense-status"></div>
              <div class="expense-btns">
                <button class="btn btn-ghost" type="button" onclick="resetExpenseForm()">
                  초기화
                </button>
                <button
                  class="btn btn-primary"
                  type="button"
                  onclick="submitExpenseForm()"
                >
                  지출 정산 제출
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- 공통 헤더/메뉴 스크립트 -->
    <script src="./admin-common.js" defer></script>

    <script>
      // ★ Apps Script Web App URL (/exec 까지)
      const API_BASE =
        "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";

      function setExpStatus(msg, isError) {
        const el = document.getElementById("exp-status");
        el.textContent = msg || "";
        el.style.color = isError ? "#dc2626" : "#6b7280";
      }

      function showBudgetInfo(data, extraAmount) {
        const box = document.getElementById("budget-info");
        if (!data) {
          box.style.display = "none";
          return;
        }

        const approved = Number(data.approvedAmount || 0);
        const used = Number(data.usedAmountBefore || data.usedAmount || 0);
        const remainBefore = approved - used;
        const usedAfter = used + (extraAmount ? Number(extraAmount) || 0 : 0);
        const remainAfter = approved - usedAfter;
        const over = remainAfter < 0;

        let html = "";
        html += `<div><strong>예산 ID</strong> : ${data.budget_id || "-"}</div>`;
        html += `<div><strong>승인 금액</strong> : ${approved.toLocaleString()}원</div>`;
        html += `<div><strong>지출(기존)</strong> : ${used.toLocaleString()}원</div>`;

        if (extraAmount) {
          html += `<div><strong>이번 지출 포함 후</strong></div>`;
          html += `<div>· 총 지출 : ${usedAfter.toLocaleString()}원</div>`;
          html += `<div>· 남은 금액 : ${remainAfter.toLocaleString()}원</div>`;
        } else {
          html += `<div><strong>현재 남은 금액</strong> : ${remainBefore.toLocaleString()}원</div>`;
        }

        box.innerHTML = html;
        box.classList.toggle("over", over);
        box.style.display = "block";
      }

      function resetExpenseForm() {
        document.getElementById("requestId").value = "";
        document.getElementById("date").value = "";
        document.getElementById("vendor").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("requester").value = "";
        document.getElementById("receiptUrl").value = "";
        document.getElementById("note").value = "";
        setExpStatus("");
        showBudgetInfo(null);
      }

      async function submitExpenseForm() {
        const requestId = document.getElementById("requestId").value.trim();
        const date = document.getElementById("date").value;
        const vendor = document.getElementById("vendor").value.trim();
        const amount = document.getElementById("amount").value.trim();
        const requester = document.getElementById("requester").value.trim();
        const receiptUrl = document.getElementById("receiptUrl").value.trim();
        const note = document.getElementById("note").value.trim();

        if (!requestId || !amount || !requester) {
          setExpStatus("request_id, 금액, 요청자는 필수입니다.", true);
          return;
        }

        if (isNaN(Number(amount)) || Number(amount) <= 0) {
          setExpStatus("금액은 0보다 큰 숫자로 입력해 주세요.", true);
          return;
        }

        setExpStatus("지출 정산을 제출하는 중입니다...", false);

        try {
          const params = new URLSearchParams();
          params.set("mode", "submitExpense");
          params.set("requestId", requestId);
          params.set("date", date);
          params.set("vendor", vendor);
          params.set("amount", amount);
          params.set("requester", requester);
          params.set("receiptUrl", receiptUrl);
          params.set("note", note);

          const res = await fetch(API_BASE + "?" + params.toString(), {
            method: "GET",
          });

          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const d = json.data || {};
          const expenseId =
            d.expense_id ? d.expense_id : "(expense_id 미확인)";

          // 예산 사용 정보 표시
          showBudgetInfo(d, amount);

          let msg = "지출 정산이 제출되었습니다.\nexpense_id: " + expenseId;
          if (d.overBudget) {
            msg +=
              "\n\n※ 이번 지출까지 포함하면 예산을 초과합니다. (승인자 검토 필요)";
          }
          alert(msg);

          setExpStatus("제출 완료: expense_id = " + expenseId, false);
        } catch (err) {
          console.error("submitExpenseForm ERROR:", err);
          setExpStatus("제출 실패: " + err.message, true);
        }
      }
    </script>
  </body>
</html>
