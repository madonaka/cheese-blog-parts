<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>지출 정산 신청 · Cheese Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- 공통 CSS -->
    <link rel="stylesheet" href="./admin.css" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
      }

      .expense-shell {
        max-width: 720px;
        margin: 1.5rem auto 2.5rem;
        padding: 1.75rem 1.5rem;
        border-radius: 1.25rem;
        background: #ffffff;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
        box-sizing: border-box;
      }

      .expense-title {
        font-size: 1.35rem;
        font-weight: 600;
        margin: 0 0 0.25rem;
        letter-spacing: -0.03em;
      }

      .expense-sub {
        margin: 0 0 1.25rem;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .expense-field {
        margin-bottom: 0.9rem;
      }

      .expense-label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #374151;
      }

      .expense-input,
      .expense-textarea {
        width: 100%;
        box-sizing: border-box;
        border-radius: 0.7rem;
        border: 1px solid #d1d5db;
        padding: 0.55rem 0.7rem;
        font-size: 0.85rem;
        outline: none;
        background: #f9fafb;
      }

      .expense-input:focus,
      .expense-textarea:focus {
        border-color: #2563eb;
        background: #ffffff;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
      }

      .expense-textarea {
        min-height: 70px;
        resize: vertical;
      }

      .expense-hint {
        font-size: 0.73rem;
        color: #9ca3af;
        margin-top: 0.2rem;
      }

      .expense-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .expense-status {
        font-size: 0.8rem;
        color: #6b7280;
        min-width: 0;
        flex: 1 1 180px;
      }

      .expense-btns {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .btn {
        border-radius: 999px;
        border: 0;
        padding: 0.45rem 1.2rem;
        font-size: 0.82rem;
        cursor: pointer;
        font-weight: 500;
      }

      .btn-primary {
        background: #2563eb;
        color: #f9fafb;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .btn-ghost {
        background: transparent;
        color: #4b5563;
      }

      .budget-info {
        margin-top: 0.75rem;
        padding: 0.6rem 0.75rem;
        border-radius: 0.7rem;
        background: #f9fafb;
        font-size: 0.78rem;
        color: #4b5563;
        border: 1px dashed #e5e7eb;
      }

      .budget-info strong {
        font-weight: 600;
      }

      .budget-info.over {
        border-color: #f97316;
        background: #fff7ed;
        color: #9a3412;
      }

      @media (max-width: 640px) {
        .expense-shell {
          margin: 1rem 0.75rem 2rem;
          padding: 1.25rem 1rem;
        }

        .expense-footer {
          flex-direction: column-reverse;
          align-items: stretch;
        }

        .expense-btns {
          justify-content: flex-end;
        }

        .expense-footer .btn {
          /* 필요하면 width: 100%; 로 풀폭 버튼도 가능 */
        }
      }

      /* request_id 추천 리스트(자동완성) */
      .request-autocomplete {
        position: relative;
      }
      
      .request-suggest {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 6px);
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
        z-index: 50;
        overflow: hidden;
      }
      
      .request-suggest .item {
        padding: 0.6rem 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
      }
      
      .request-suggest .item:hover {
        background: #f3f4f6;
      }
      
      .request-suggest .left {
        min-width: 0;
      }
      
      .request-suggest .rid {
        font-weight: 700;
        font-size: 0.82rem;
        color: #111827;
      }
      
      .request-suggest .title {
        margin-top: 2px;
        font-size: 0.78rem;
        color: #374151;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 420px;
      }
      
      .request-suggest .right {
        text-align: right;
        flex: 0 0 auto;
      }
      
      .request-suggest .amt {
        font-weight: 700;
        font-size: 0.8rem;
        color: #111827;
      }
      
      .request-suggest .date {
        margin-top: 2px;
        font-size: 0.72rem;
        color: #6b7280;
      }
      
      .request-suggest .empty {
        padding: 0.65rem 0.75rem;
        font-size: 0.78rem;
        color: #6b7280;
      }
      
    </style>
  </head>
  <body>
    <div class="admin-shell">
      <!-- 헤더 슬롯 -->
      <div id="admin-header-slot"></div>

      <div class="admin-main">
        <!-- 왼쪽 메뉴 -->
        <aside id="admin-menu-slot" class="admin-sidebar"></aside>

        <!-- 본문 -->
        <main class="admin-content">
          <div class="expense-shell">
            <h1 class="expense-title">지출 정산 신청</h1>
            <p class="expense-sub">
              승인된 예산요청(request_id)에 대해 실제 지출 내용을 등록합니다.
              영수증/증빙 링크를 함께 남겨 주세요.
            </p>
            
            <div class="expense-field">
              <label class="expense-label" for="requestId">request_id</label>
              <div class="request-autocomplete">
              <input
                id="requestId"
                class="expense-input"
                placeholder="예: R2025-12-011"
                autocomplete="off"
              />
              <div id="request-suggest" class="request-suggest" style="display:none;"></div>
            </div>
              <div class="expense-hint">
                BUDGET_REQUESTS 시트에서 승인된 예산요청의 request_id를 입력합니다.
              </div>
              <div id="budget-info" class="budget-info" style="display:none;"></div>
            </div>
            
            <input type="hidden" id="approvalLineJson" name="approvalLineJson" value="" />
            <input type="hidden" id="drafterId" name="drafterId" value="" />

            <!-- 결재선 -->
            <div class="form-row approval-line-row">
              <label for="budget-approval-line-name" class="form-label">결재선</label>
              <div id="approval-line-preview" class="approval-line-preview" style="margin-top:10px;"></div>
            
              <div class="approval-line-input-group">
                <input
                  type="text"
                  id="budget-approval-line-name"
                  name="approvalLineName"
                  class="form-control"
                  placeholder="결재선을 선택해주세요"
                  readonly
                />
                <input
                  type="hidden"
                  id="budget-approval-line-id"
                  name="approvalLineId"
                />
              <button
                type="button"
                class="btn btn-outline approval-line-open-btn"
                data-approval-line-id="budget-approval-line-id"
                data-approval-line-name="budget-approval-line-name"
                data-approval-line-preview="approval-line-preview"
              >
                결재선 선택
              </button>
              </div>
            </div>
            <div id="approval-line-modal-root"></div>



            <div class="expense-field">
              <label class="expense-label" for="date">지출일</label>
              <input id="date" class="expense-input" type="date" />
            </div>

            <div class="expense-field">
              <label class="expense-label" for="vendor">거래처 / 상호</label>
              <input
                id="vendor"
                class="expense-input"
                placeholder="예: 구글코리아, 네이버파이낸셜 등"
              />
            </div>

            <div class="expense-field">
              <label class="expense-label" for="amount">지출 금액 (원)</label>
              <input
                id="amount"
                class="expense-input"
                inputmode="numeric"
                placeholder="예: 150000"
              />
              <div class="expense-hint">
                쉼표 없이 숫자만 입력 (예: 150000)
              </div>
            </div>

            <div class="expense-field">
              <label class="expense-label" for="receiptUrl">영수증 / 증빙 링크</label>
              <input
                id="receiptUrl"
                class="expense-input"
                type="url"
                placeholder="예: Google Drive 공유 링크, 카드사 영수증 URL 등"
              />
              <div class="expense-hint">
                실제 영수증 파일은 별도로 업로드한 후, 확인 가능한 링크를 붙여 주세요.
              </div>
            </div>

            <div class="expense-field">
              <label class="expense-label" for="note">비고 / 상세 내용</label>
              <textarea
                id="note"
                class="expense-textarea"
                placeholder="예: 12월 구글 광고비 중 리마케팅 캠페인 집행분"
              ></textarea>
            </div>

            <div class="expense-footer">
              <div id="exp-status" class="expense-status"></div>
              <div class="expense-btns">
                <button class="btn btn-ghost" type="button" onclick="resetExpenseForm()">
                  초기화
                </button>
                <button
                  class="btn btn-primary"
                  type="button"
                  onclick="submitExpenseForm()"
                >
                  지출 정산 제출
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- 공통 헤더/메뉴 스크립트 -->
    <script src="./admin-common.js" defer></script>

    <script>
      // ★ Apps Script Web App URL (/exec 까지)
      const API_BASE =
        "https://script.google.com/macros/s/AKfycbxmKUfIbHUkrX5SdQXeELy4mKB3iydXlQiuKJ0Iyt1EAZATg8UV2KvIO1jXeL7xqMzf/exec";
      window.CHEESE_ADMIN_API_BASE = API_BASE;

      function setExpStatus(msg, isError) {
        const el = document.getElementById("exp-status");
        el.textContent = msg || "";
        el.style.color = isError ? "#dc2626" : "#6b7280";
      }

      function showBudgetInfo(data, extraAmount) {
        const box = document.getElementById("budget-info");
        if (!data) {
          box.style.display = "none";
          return;
        }

        const approved = Number(data.approvedAmount || 0);
        const used = Number(data.usedAmountBefore || data.usedAmount || 0);
        const remainBefore = approved - used;
        const usedAfter = used + (extraAmount ? Number(extraAmount) || 0 : 0);
        const remainAfter = approved - usedAfter;
        const over = remainAfter < 0;

        let html = "";
        html += `<div><strong>예산 ID</strong> : ${data.budget_id || "-"}</div>`;
        html += `<div><strong>승인 금액</strong> : ${approved.toLocaleString()}원</div>`;
        html += `<div><strong>지출(기존)</strong> : ${used.toLocaleString()}원</div>`;

        if (extraAmount) {
          html += `<div><strong>이번 지출 포함 후</strong></div>`;
          html += `<div>· 총 지출 : ${usedAfter.toLocaleString()}원</div>`;
          html += `<div>· 남은 금액 : ${remainAfter.toLocaleString()}원</div>`;
        } else {
          html += `<div><strong>현재 남은 금액</strong> : ${remainBefore.toLocaleString()}원</div>`;
        }

        box.innerHTML = html;
        box.classList.toggle("over", over);
        box.style.display = "block";
      }

      function resetExpenseForm() {
        document.getElementById("requestId").value = "";
        document.getElementById("date").value = "";
        document.getElementById("vendor").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("receiptUrl").value = "";
        document.getElementById("note").value = "";
        setExpStatus("");
        showBudgetInfo(null);

        // ✅ 결재선 초기화
        document.getElementById("budget-approval-line-id").value = "";
        document.getElementById("budget-approval-line-name").value = "";
        const jsonEl = document.getElementById("approvalLineJson");
        if (jsonEl) jsonEl.value = "";
        const pv = document.getElementById("approval-line-preview");
        if (pv) pv.innerHTML = "";

        
      }

      async function submitExpenseForm() {
        const requestId = document.getElementById("requestId").value.trim();
        const date = document.getElementById("date").value;
        const vendor = document.getElementById("vendor").value.trim();
        const amount = document.getElementById("amount").value.trim();
        const receiptUrl = document.getElementById("receiptUrl").value.trim();
        const note = document.getElementById("note").value.trim();
        const approvalLineId = document.getElementById("budget-approval-line-id").value.trim();
        const approvalLineName = document.getElementById("budget-approval-line-name").value.trim();
        const approvalLineJson = (document.getElementById("approvalLineJson")?.value || "").trim();
        const drafterId = (document.getElementById("drafterId")?.value || "").trim();
        const actor = (window.CHEESE_ADMIN_EMP_NO || drafterId || window.CHEESE_ADMIN_LOGIN_ID || "").trim();


        if (!actor) {
          setExpStatus("로그인 정보(기안자)를 찾을 수 없습니다. 다시 로그인해 주세요.", true);
          return;
        }

        
        // ✅ 여기(필수 체크 바로 아래)에 결재선 체크 추가
        if (!requestId || !amount) {
          setExpStatus("request_id, 금액은 필수입니다.", true);
          return;
        }

        if (!approvalLineId || !approvalLineName) {
          setExpStatus("결재선을 선택해 주세요.", true);
          return;
        }
        if (!approvalLineJson) {
          setExpStatus("결재선 JSON이 비어있습니다. 결재선 선택 모달 저장을 확인해주세요.", true);
          return;
        }
                
        if (isNaN(Number(amount)) || Number(amount) <= 0) {
          setExpStatus("금액은 0보다 큰 숫자로 입력해 주세요.", true);
          return;
        }

        setExpStatus("지출 정산을 제출하는 중입니다...", false);

        try {
          const params = new URLSearchParams();
          params.set("mode", "submitExpense");
          
          // ✅ Apps Script가 요구하는 actor(기안자)
          // 지금 화면에 requester 입력칸을 쓰고 있으니, 그 값을 actor로도 보냄
          params.set("actor", actor);
    
          // ✅ request_id는 requestId도 허용하지만, 명확히 requestId로 유지해도 OK
          params.set("requestId", requestId);
          
          params.set("date", date);
          params.set("vendor", vendor);
          
          // ✅ 금액 키 이름: amount_total (또는 amountTotal)
          params.set("amount_total", amount);
          
          // ✅ 영수증/증빙 링크 키 이름: evidence_link
          params.set("evidence_link", receiptUrl);
          
          // ✅ 비고/상세 키 이름: description
          params.set("description", note);
          
          // ✅ 결재선 3종은 그대로
          params.set("approvalLineId", approvalLineId);
          params.set("approvalLineName", approvalLineName);
          params.set("approvalLineJson", approvalLineJson);
          
          // ✅ POST로 전송 (doPost가 받음)
          const res = await fetch(API_BASE, {
            method: "POST",
            body: params,
          });

          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");

          const d = json.data || {};
          const expenseId =
            d.expense_id ? d.expense_id : "(expense_id 미확인)";

          // 예산 사용 정보 표시
          showBudgetInfo(d, amount);

          let msg = "지출 정산이 제출되었습니다.\nexpense_id: " + expenseId;
          if (d.overBudget) {
            msg +=
              "\n\n※ 이번 지출까지 포함하면 예산을 초과합니다. (승인자 검토 필요)";
          }
          alert(msg);

          setExpStatus("제출 완료: expense_id = " + expenseId, false);
        } catch (err) {
          console.error("submitExpenseForm ERROR:", err);
          setExpStatus("제출 실패: " + err.message, true);
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        const drafterIdEl = document.getElementById("drafterId");
        if (drafterIdEl) drafterIdEl.value = (window.CHEESE_ADMIN_EMP_NO || "").trim();
      });

      // ===== request_id 자동완성(내 승인 완료 예산요청 목록) =====
      let reqSuggestTimer = null;
      let lastReqSuggestItems = [];
      
      function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, (m) => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
      }
      
      function fmtAmt(v) {
        const n = Number(String(v ?? '').replace(/,/g, ''));
        return Number.isFinite(n) ? n.toLocaleString() : "-";
      }
      
      function fmtDate(v) {
        if (!v) return "-";
        const d = new Date(v);
        if (isNaN(d)) return String(v);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}. ${m}. ${dd}.`;
      }
      
      function openSuggest(items) {
        const box = document.getElementById("request-suggest");
        if (!box) return;
      
        lastReqSuggestItems = items || [];
      
        if (!items || items.length === 0) {
          box.innerHTML = `<div class="empty">승인 완료된 예산요청이 없습니다.</div>`;
          box.style.display = "block";
          return;
        }
      
        box.innerHTML = items.map((it, idx) => `
          <div class="item" data-idx="${idx}">
            <div class="left">
              <div class="rid">${escapeHtml(it.request_id || "")}</div>
              <div class="title">${escapeHtml(it.title || "")}</div>
            </div>
            <div class="right">
              <div class="amt">${fmtAmt(it.requested_amount)}원</div>
              <div class="date">${escapeHtml(fmtDate(it.approved_at))}</div>
            </div>
          </div>
        `).join("");
      
        box.style.display = "block";
      }
      
      function closeSuggest() {
        const box = document.getElementById("request-suggest");
        if (box) box.style.display = "none";
      }
      
      async function loadMyApprovedRequests(q) {
        const actor = (window.CHEESE_ADMIN_LOGIN_ID || "").trim();
        if (!actor) return;
      
        const query = String(q || "").trim();
      
        const url =
          `${API_BASE}?mode=myApprovedBudgetRequests` +
          `&requester=${encodeURIComponent(actor)}` +
          `&q=${encodeURIComponent(query)}` +
          `&limit=10`;
      
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "API 에러");
          openSuggest(json.data || []);
        } catch (e) {
          // 실패해도 입력은 그대로 가능해야 하니까, UI만 닫거나 빈 상태 표시
          openSuggest([]);
        }
      }
      
      function scheduleSuggest(q) {
        if (reqSuggestTimer) clearTimeout(reqSuggestTimer);
        reqSuggestTimer = setTimeout(() => loadMyApprovedRequests(q), 180);
      }
      
      function initRequestIdSuggest() {
        const input = document.getElementById("requestId");
        const box = document.getElementById("request-suggest");
        if (!input || !box) return;
      
        input.addEventListener("input", () => scheduleSuggest(input.value));
        input.addEventListener("focus", () => scheduleSuggest(input.value));
      
        input.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeSuggest();
        });
      
        box.addEventListener("click", (e) => {
          const item = e.target.closest(".item");
          if (!item) return;
          const idx = Number(item.dataset.idx);
          const it = lastReqSuggestItems[idx];
          if (!it) return;
      
          // ✅ 선택하면 request_id 채워줌 (직접 입력도 가능하게 유지)
          input.value = it.request_id || "";
          closeSuggest();
        });
      
        document.addEventListener("click", (e) => {
          // input/box 밖 클릭하면 닫기
          const wrap = input.closest(".request-autocomplete");
          if (wrap && wrap.contains(e.target)) return;
          closeSuggest();
        });
      }
      
      initRequestIdSuggest();

    </script>
  </body>
</html>
