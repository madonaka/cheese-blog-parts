<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>E-Book ë·°ì–´ Â· Cheese Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./admin.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <style>
    /* =========================================
       E-Book Viewer Specific Styles
    ========================================= */
    .dash-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .dash-title .t { font-size: 1.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em; line-height: 1.2; }
    .dash-title .s { font-size: 0.85rem; color: var(--text-sub); margin-top: 0.25rem; font-weight: 500; }
    
    .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #fff; border: 1px solid var(--border); color: var(--text-sub); box-shadow: 0 1px 2px rgba(0,0,0,0.02); }

    /* ë·°ì–´ ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒ */
    .ebook-layout { display: flex; flex-direction: column; height: calc(100vh - 180px); min-height: 600px; background: #fff; border-radius: 1rem; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); overflow: hidden; }
    
    /* ìƒë‹¨ íˆ´ë°” */
    .ebook-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid var(--border); }
    .toolbar-group { display: flex; align-items: center; gap: 0.75rem; }
    
    .tool-btn { padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background: #fff; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #475569; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
    .tool-btn:hover { background: #f1f5f9; border-color: #94a3b8; }
    .tool-btn.active { background: var(--primary, #3b82f6); color: #fff; border-color: var(--primary, #3b82f6); }
    
    /* íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì»¤ìŠ¤í…€ */
    .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; }
    
    /* ì±… ì •ë³´ í‘œì‹œ */
    .book-meta { display: flex; flex-direction: column; }
    .book-title { font-size: 1rem; font-weight: 700; color: #0f172a; margin: 0; }
    .book-author { font-size: 0.8rem; color: #64748b; margin: 0; }

    /* ë©”ì¸ ë·°ì–´ ì˜ì—­ */
    .ebook-body { flex: 1; display: flex; position: relative; background: #f1f5f9; transition: background 0.3s; }
    .nav-btn { width: 50px; background: transparent; border: none; font-size: 2rem; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: color 0.2s, background 0.2s; z-index: 10; }
    .nav-btn:hover { color: var(--primary, #3b82f6); background: rgba(0,0,0,0.02); }
    
    #viewer { flex: 1; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; padding: 1rem 0; box-sizing: border-box; }
    
    /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
    #loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: #64748b; display: none; }

    /* ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .ebook-body.dark-theme { background: #1e293b; }
    .ebook-body.dark-theme .nav-btn { color: #64748b; }
    .ebook-body.dark-theme .nav-btn:hover { color: #cbd5e1; background: rgba(255,255,255,0.05); }

    /* EPUB ë Œë”ë§ ì˜ì—­ ê°•ì œ ê°€ìš´ë° ì •ë ¬ìš© (ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ë¶€ iframe ê°ì‹¸ê¸°) */
    .epub-container { width: 100%; max-width: 800px; height: 100%; margin: 0 auto; background: #fff; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); transition: background 0.3s; }
    .ebook-body.dark-theme .epub-container { background: #0f172a; box-shadow: none; border-left: 1px solid #334155; border-right: 1px solid #334155; }
  </style>
</head>

<body>
  <div class="admin-shell">
    <div id="admin-header-slot"></div>

    <div class="admin-main">
      <aside id="admin-menu-slot" class="admin-sidebar"></aside>

      <main style="position: relative;">
        <header class="dash-header">
          <div class="dash-title">
            <h1 class="t">E-Book ë·°ì–´</h1>
            <p class="s">EPUB í‘œì¤€ ê·œê²©ì˜ ì „ìì±… ë°ì´í„°ë¥¼ ì½ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
          </div>
          <div class="status-pill">
            <span style="display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%;"></span>
            <span id="nowPill">ìµœê·¼ ë™ê¸°í™”: -</span>
          </div>
        </header>

        <section class="ebook-layout">
          
          <div class="ebook-toolbar">
            <div class="toolbar-group">
              <div class="file-upload-wrapper">
                <button class="tool-btn">ğŸ“‚ EPUB íŒŒì¼ ì—´ê¸°</button>
                <input type="file" id="file-input" accept=".epub" />
              </div>
              <div class="book-meta">
                <div class="book-title" id="meta-title">ì„ íƒëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="book-author" id="meta-author">-</div>
              </div>
            </div>

            <div class="toolbar-group">
              <button class="tool-btn" id="btn-zoom-out" title="ê¸€ì ì‘ê²Œ">A-</button>
              <button class="tool-btn" id="btn-zoom-in" title="ê¸€ì í¬ê²Œ">A+</button>
              <div style="width: 1px; height: 20px; background: #cbd5e1; margin: 0 0.5rem;"></div>
              <button class="tool-btn" id="btn-theme" title="ë‹¤í¬ ëª¨ë“œ ì „í™˜">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
            </div>
          </div>

          <div class="ebook-body" id="ebook-body">
            <button class="nav-btn" id="prev-btn">â€¹</button>
            <div id="viewer">
                <div id="loading-indicator">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
            <button class="nav-btn" id="next-btn">â€º</button>
          </div>

        </section>
      </main>
    </div>
  </div>

  <script src="./admin-common.js"></script>
  <script>
    // --- 1. ì‹œìŠ¤í…œ ê³µí†µ ìœ í‹¸ë¦¬í‹° ---
    function pad2(n){ return String(n).padStart(2,'0'); }
    function hm(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
    
    function setNow(){ 
        const now = new Date(); 
        document.getElementById('nowPill').innerHTML = `ìµœê·¼ ë™ê¸°í™”: ${hm(now)}`; 
    }

    function mountShell(){
      if(window.renderAdminHeader) window.renderAdminHeader({ mountId:'admin-header-slot', badgeText:'E-Book', subtitle:'ë„ì„œ ì—´ëŒ' });
      if(window.renderAdminMenu) window.renderAdminMenu({ mountId:'admin-menu-slot', active:'ebook' }); // active í‚¤ëŠ” ë©”ë‰´ ì„¤ì •ì— ë§ê²Œ ë³€ê²½
    }

    // --- 2. Epub.js ì œì–´ ë¡œì§ ---
    let book = null;
    let rendition = null;
    let currentTheme = 'light';
    let currentFontSize = 100;

    // ë·°ì–´ ì´ˆê¸°í™” í•¨ìˆ˜
    function initViewer() {
        // ì´ì „ ì±…ì´ ìˆë‹¤ë©´ ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ
        if (book) { book.destroy(); }
        document.getElementById('viewer').innerHTML = '<div id="loading-indicator">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
        document.getElementById('loading-indicator').style.display = 'block';
    }

    // ArrayBuffer í˜•ì‹ì˜ íŒŒì¼ì„ ë°›ì•„ ë Œë”ë§
    function loadEpubFromArrayBuffer(arrayBuffer) {
        initViewer();

        book = ePub(arrayBuffer);
        
        // ë©”íƒ€ë°ì´í„°(ì œëª©, ì €ì) ì¶”ì¶œ
        book.loaded.metadata.then(function(meta){
            document.getElementById('meta-title').textContent = meta.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('meta-author').textContent = meta.creator || 'ì‘ì ë¯¸ìƒ';
        });

        // ë Œë”ë§ ì„¤ì •
        rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            spread: "none", // ê¸°ë³¸ì ìœ¼ë¡œ 1ë‹¨ ë³´ê¸° (ëª¨ë°”ì¼/ì›¹ í‘œì¤€)
            manager: "continuous",
            flow: "paginated"
        });

        // ì»¤ìŠ¤í…€ í…Œë§ˆ ë“±ë¡
        rendition.themes.register("light", { "body": { "background": "#fff", "color": "#333" }});
        rendition.themes.register("dark", { "body": { "background": "#0f172a", "color": "#cbd5e1" }});
        
        // í˜„ì¬ ì„¤ì • ì ìš©
        rendition.themes.select(currentTheme);
        rendition.themes.fontSize(`${currentFontSize}%`);

        rendition.display().then(() => {
            document.getElementById('loading-indicator').style.display = 'none';
        });

        // í‚¤ë³´ë“œ ë°©í–¥í‚¤ ë„˜ê¹€ ì§€ì›
        rendition.on("keyup", function(e) {
            if(e.keyCode == 37) rendition.prev();
            if(e.keyCode == 39) rendition.next();
        });
    }

    // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
    
    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    document.getElementById("file-input").addEventListener("change", function(e) {
        let file = e.target.files[0];
        if (!file) return;

        if (window.FileReader) {
            let reader = new FileReader();
            reader.onload = function(e) {
                loadEpubFromArrayBuffer(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        }
    });

    // í˜ì´ì§€ ë„˜ê¹€ ë²„íŠ¼
    document.getElementById("prev-btn").addEventListener("click", () => {
        if(rendition) rendition.prev();
    });
    
    document.getElementById("next-btn").addEventListener("click", () => {
        if(rendition) rendition.next();
    });

    // ê¸€ì í¬ê¸° ì¡°ì ˆ
    document.getElementById("btn-zoom-in").addEventListener("click", () => {
        if(!rendition) return;
        currentFontSize += 10;
        rendition.themes.fontSize(`${currentFontSize}%`);
    });

    document.getElementById("btn-zoom-out").addEventListener("click", () => {
        if(!rendition) return;
        currentFontSize = Math.max(50, currentFontSize - 10);
        rendition.themes.fontSize(`${currentFontSize}%`);
    });

    // ë‹¤í¬ ëª¨ë“œ í† ê¸€
    document.getElementById("btn-theme").addEventListener("click", function() {
        const bodyEl = document.getElementById("ebook-body");
        
        if (currentTheme === 'light') {
            currentTheme = 'dark';
            this.innerHTML = 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ';
            this.classList.add('active');
            bodyEl.classList.add('dark-theme');
        } else {
            currentTheme = 'light';
            this.innerHTML = 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
            this.classList.remove('active');
            bodyEl.classList.remove('dark-theme');
        }

        if(rendition) rendition.themes.select(currentTheme);
    });

    // --- 4. ì´ˆê¸° ì‹¤í–‰ ---
    (function init(){
      setNow(); 
      setInterval(setNow, 1000*60);
      mountShell();
    })();
  </script>
</body>
</html>
