<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Cheese Lab í†µí•© í•  ì¼ ê´€ë¦¬</title>
  <link rel="stylesheet" href="./admin.css">

  <script>
    // âœ… ì‚¬ìš©ìë‹˜ì´ ì•Œë ¤ì£¼ì‹  ë°°í¬ ì£¼ì†Œ ì ìš© ì™„ë£Œ
    window.CHEESE_ADMIN_API_BASE = "https://script.google.com/macros/s/AKfycbwn1TrLeSIAe570LRWMJxRzx88u3LQYF38Kme9WhMd-YQsrMsSggrNy3I_2SGKGXTpS/exec";
  </script>
  <script src="./admin-common.js" defer></script>

  <style>
    /* === 1. ì „ì²´ ë ˆì´ì•„ì›ƒ (ë°˜ì‘í˜• ê·¸ë¦¬ë“œ) === */
    .dashboard-layout {
      display: grid;
      grid-template-columns: 2fr 1fr; /* ëª©í‘œ(ë„“ê²Œ) : ë¡œê·¸(ì¢ê²Œ) */
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .dashboard-layout { grid-template-columns: 1fr; } /* ëª¨ë°”ì¼ ì¼ë ¬ ë°°ì¹˜ */
    }

    /* === 2. ëª©í‘œ ì¹´ë“œ (Goal Card) ë””ìì¸ === */
    .goal-card {
      background: #fff;
      border-radius: 16px;
      margin-bottom: 24px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .goal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
    }

    .goal-card-header {
      /* ğŸ”¥ ì‹œì›í•œ ê·¸ë¼ë””ì–¸íŠ¸ í—¤ë” */
      background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
      color: white;
      padding: 16px 24px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .goal-card-title { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.01em; }
    .goal-card-status {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px; border-radius: 20px;
      font-size: 0.8rem; font-weight: 600;
      backdrop-filter: blur(4px);
    }

    /* === 3. ì¤‘ê°„ ëª©í‘œ & í•  ì¼ ë¦¬ìŠ¤íŠ¸ === */
    .goal-body { padding: 10px 20px 20px; }

    .mid-goal-group { margin-top: 16px; }
    .mid-goal-item {
      border-left: 4px solid #10b981; /* ì´ˆë¡ìƒ‰ í¬ì¸íŠ¸ ë°” */
      background: #f9fafb;
      border-radius: 0 8px 8px 0;
      overflow: hidden;
    }
    
    /* ì¤‘ê°„ ëª©í‘œ í—¤ë” (ì ‘ê¸°/í¼ì¹˜ê¸°) */
    .mid-goal-header {
      padding: 12px 16px;
      font-weight: 700; color: #374151;
      cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.1s;
    }
    .mid-goal-header:hover { background: #f3f4f6; }
    
    /* í•  ì¼(Task) í–‰ */
    .task-list { background: #fff; border-top: 1px solid #f3f4f6; }
    .task-row {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.95rem;
      transition: background 0.1s;
    }
    .task-row:last-child { border-bottom: none; }
    .task-row:hover { background: #fdfdfd; }

    /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
    .check-circle {
      width: 22px; height: 22px;
      border: 2px solid #d1d5db; border-radius: 50%;
      cursor: pointer; flex-shrink: 0;
      position: relative; transition: all 0.2s;
    }
    .check-circle.checked {
      background: #10b981; border-color: #10b981;
    }
    .check-circle.checked::after {
      content: 'âœ”'; position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 14px;
    }

    /* === 4. ì‘ì—… ë¡œê·¸ (íƒ€ì„ë¼ì¸) === */
    .log-container {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #e5e7eb;
      position: sticky; top: 80px; /* ìŠ¤í¬ë¡¤ ë”°ë¼ì˜¤ê¸° */
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    
    .timeline {
      position: relative;
      padding-left: 24px; margin-top: 24px;
      border-left: 2px solid #e5e7eb;
    }
    .timeline-item { position: relative; margin-bottom: 30px; }
    
    /* íƒ€ì„ë¼ì¸ ì  */
    .timeline-dot {
      position: absolute; left: -31px; top: 5px;
      width: 12px; height: 12px;
      background: #3b82f6; border: 3px solid #fff; border-radius: 50%;
      box-shadow: 0 0 0 2px #dbeafe;
    }
    
    .timeline-header { margin-bottom: 8px; line-height: 1.4; }
    .timeline-date { font-size: 0.75rem; color: #6b7280; font-weight: 600; display: block; }
    .timeline-title { font-size: 1rem; font-weight: 700; color: #111827; }
    
    .timeline-content {
      background: #f9fafb; padding: 12px 14px;
      border-radius: 8px;
      font-size: 0.9rem; line-height: 1.6; color: #374151;
      white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
    }
    .timeline-tag {
      display: inline-block; font-size: 0.75rem; font-weight: 600;
      color: #d946ef; background: #fae8ff;
      padding: 2px 8px; border-radius: 4px; margin-top: 8px;
    }

    /* === 5. í”Œë¡œíŒ… ë²„íŠ¼ (FAB) === */
    .fab-menu {
      position: fixed; bottom: 30px; right: 30px;
      display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
      z-index: 1000;
    }
    .fab-btn {
      width: 56px; height: 56px; border-radius: 50%; border: none;
      color: white; font-size: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s;
    }
    .fab-main { background: #2563eb; }
    .fab-sub { width: 48px; height: 48px; background: #4b5563; font-size: 20px; display: none; }
    
    /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì„œë¸Œ ë©”ë‰´ ë“±ì¥ */
    .fab-menu:hover .fab-sub { display: flex; }
    .fab-label {
      position: absolute; right: 60px; top: 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      font-size: 12px; padding: 4px 8px; border-radius: 4px;
      white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    .fab-menu:hover .fab-label { opacity: 1; }

    /* === 6. ëª¨ë‹¬ ìŠ¤íƒ€ì¼ === */
    .custom-modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 2000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(2px);
    }
    .custom-modal.open { display: flex; }
    .modal-box {
      background: #fff; padding: 28px; border-radius: 16px;
      width: 90%; max-width: 500px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      max-height: 90vh; overflow-y: auto;
    }
    .modal-title { font-size: 1.25rem; font-weight: 800; margin-top: 0; margin-bottom: 20px; }

  </style>
</head>
<body>

<div class="admin-shell">
  <div id="admin-header-slot"></div>
  
  <main class="admin-main">
    <aside id="admin-menu-slot" class="admin-sidebar"></aside>

    <section class="admin-content">
      
      <div style="margin-bottom: 24px;">
        <h2 style="font-size: 1.8rem; font-weight: 800; color: #111827; margin: 0;">Dashboard</h2>
        <p style="color: #6b7280; margin-top: 4px;">ë‚˜ì˜ í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ê³¼ í•˜ë£¨ ê¸°ë¡ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>

      <div class="dashboard-layout">
        
        <div id="goal-tree-root">
          <div class="card" style="padding:40px; text-align:center; color:#999;">
            <div class="cheese-quiz-loading-ring" style="margin:0 auto 10px;"></div>
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
          </div>
        </div>

        <div class="log-container">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700;">ğŸ“ ì‘ì—… ë¡œê·¸</h3>
            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="openLogModal()">+ ê¸°ë¡í•˜ê¸°</button>
          </div>
          
          <div class="timeline" id="log-timeline-root">
            </div>
        </div>

      </div>
    </section>
  </main>
</div>

<div class="fab-menu">
  <div style="position:relative;">
    <button class="fab-btn fab-sub" onclick="openLogModal()">ğŸ“</button>
    <span class="fab-label">ì‘ì—… ë¡œê·¸ ì‘ì„±</span>
  </div>
  <div style="position:relative;">
    <button class="fab-btn fab-main" onclick="openModal('í• ì¼')">+</button>
  </div>
</div>

<div id="input-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title">ìƒˆ í•­ëª© ë“±ë¡</h3>
    <form id="todo-form" class="admin-form-grid">
      
      <div class="field admin-field-full">
        <label>ìœ í˜•</label>
        <div style="display:flex; gap:12px; background:#f9fafb; padding:10px; border-radius:8px;">
          <label><input type="radio" name="type" value="í• ì¼" checked onclick="toggleFormFields()"> í•  ì¼</label>
          <label><input type="radio" name="type" value="ì•„ì´ë””ì–´" onclick="toggleFormFields()"> ì•„ì´ë””ì–´</label>
          <label><input type="radio" name="type" value="ì¤‘ê°„ ëª©í‘œ" onclick="toggleFormFields()"> ì¤‘ê°„ ëª©í‘œ</label>
          <label><input type="radio" name="type" value="í° ëª©í‘œ" onclick="toggleFormFields()"> í° ëª©í‘œ</label>
        </div>
      </div>

      <div class="field admin-field-full" id="field-parent">
        <label>ì—°ê²°ëœ ëª©í‘œ</label>
        <select id="input-connected-id" style="width:100%;"><option value="">(ì„ íƒ ì—†ìŒ)</option></select>
      </div>

      <div class="field admin-field-full">
        <label>ì œëª©</label>
        <input type="text" id="input-title" required placeholder="ë¬´ì—‡ì„ í•´ì•¼ í•˜ë‚˜ìš”?">
      </div>

      <div class="field admin-field-full" id="field-detail" style="display:none;">
        <label>ìƒì„¸ ë‚´ìš©</label>
        <textarea id="input-detail" placeholder="ë©”ëª¨ë‚˜ ì°¸ì¡° ë§í¬ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      </div>

      <div class="field" id="field-date">
         <label>ë§ˆê° ê¸°í•œ</label>
         <input type="date" id="input-due">
      </div>

      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content: center; padding:10px;">ì €ì¥í•˜ê¸°</button>
        <button type="button" class="btn" onclick="closeModal('input-modal')" style="flex:1; justify-content: center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<div id="log-modal" class="custom-modal">
  <div class="modal-box">
    <h3 class="modal-title">ì˜¤ëŠ˜ì˜ ì‘ì—… ê¸°ë¡</h3>
    <form id="log-form" class="admin-form-grid">
      
      <div class="field admin-field-full">
        <label>ë‚ ì§œ</label>
        <input type="date" id="log-date" required>
      </div>
      
      <div class="field admin-field-full">
        <label>ì œëª© (ì„ íƒì‚¬í•­)</label>
        <input type="text" id="log-title" placeholder="ì˜ˆ: ë©”ì¸ ë°°ë„ˆ êµì²´ ì‘ì—… (ë¹„ì›Œë‘ë©´ ë‚ ì§œë¡œ í‘œì‹œ)">
      </div>

      <div class="field admin-field-full">
        <label>ì‘ì—… ë‚´ìš©</label>
        <textarea id="log-content" required placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ì‘ì—…ì„ í–ˆë‚˜ìš”? ì„±ê³¼ ìœ„ì£¼ë¡œ ê¸°ë¡í•´ ì£¼ì„¸ìš”." style="min-height:100px;"></textarea>
      </div>

      <div class="field admin-field-full" style="background:#f5f3ff; padding:16px; border-radius:12px; border:1px dashed #8b5cf6;">
        <label style="color:#6d28d9; font-weight:700; margin-bottom:8px; display:block;">ğŸ’¡ ì‘ì—… ì¤‘ ë– ì˜¤ë¥¸ ì•„ì´ë””ì–´ (ì„ íƒ)</label>
        <input type="text" id="log-idea-input" placeholder="ì—¬ê¸°ì— ì ìœ¼ë©´ 'ì•„ì´ë””ì–´ ëª©ë¡'ì—ë„ ìë™ ì €ì¥ë©ë‹ˆë‹¤!" style="background:#fff; border-color:#ddd6fe;">
        <p style="font-size:0.8rem; color:#7c3aed; margin-top:6px; margin-bottom:0;">
          * ë‚˜ì¤‘ì— í•  ì¼ë¡œ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      </div>

      <div class="field">
        <label>ì†Œìš”ì‹œê°„</label>
        <input type="text" id="log-duration" placeholder="ì˜ˆ: 2h">
      </div>
      <div class="field">
        <label>íƒœê·¸</label>
        <input type="text" id="log-tags" placeholder="#íƒœê·¸ #ê°œë°œ">
      </div>

      <div class="field admin-field-full" style="margin-top:16px; display:flex; gap:10px;">
        <button type="submit" class="btn btn-primary" style="flex:1; justify-content: center; padding:10px;">ê¸°ë¡ ì €ì¥</button>
        <button type="button" class="btn" onclick="closeModal('log-modal')" style="flex:1; justify-content: center;">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<script>
  // 1. í˜ì´ì§€ í™œì„±í™” ì„¤ì •
  window.CHEESE_ADMIN_ACTIVE_PAGE = "todo_manage";
  
  // 2. ì „ì—­ ë°ì´í„°
  let g_goals = [], g_tasks = [], g_logs = [];

  // 3. ì´ˆê¸° ë¡œë”©
  document.addEventListener('DOMContentLoaded', () => {
    loadAllData();
  });

  async function loadAllData() {
    // admin-common.jsì˜ ë¡œë”© í•¨ìˆ˜ ì‚¬ìš© (ì—†ìœ¼ë©´ ì—ëŸ¬ ì•ˆë‚˜ê²Œ ì²´í¬)
    if(typeof showAdminLoading === 'function') showAdminLoading("ë°ì´í„° ë™ê¸°í™” ì¤‘...");
    
    try {
      const res = await fetch(window.CHEESE_ADMIN_API_BASE + "?mode=getAllData");
      const json = await res.json();
      
      if(json.result === "success") {
        g_goals = json.goals;
        g_tasks = json.tasks;
        g_logs  = json.logs || [];
        
        renderGoalTree();
        renderLogs();
        updateParentOptions(); // ëª¨ë‹¬ ì˜µì…˜ ê°±ì‹ 
      } else {
        alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + json.msg);
      }
    } catch(e) {
      console.error(e);
      // alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    } finally {
      if(typeof hideAdminLoading === 'function') hideAdminLoading();
    }
  }

  // ===========================================
  // ë Œë”ë§ ë¡œì§: ëª©í‘œ íŠ¸ë¦¬ (ì¹´ë“œí˜•)
  // ===========================================
  function renderGoalTree() {
    const root = document.getElementById('goal-tree-root');
    root.innerHTML = "";
    
    // í° ëª©í‘œë§Œ í•„í„°ë§
    const bigGoals = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
    
    if(bigGoals.length === 0) {
      root.innerHTML = `<div style="padding:40px; text-align:center; color:#999; background:#fff; border-radius:16px;">
        ë“±ë¡ëœ í° ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.<br>ìš°ì¸¡ í•˜ë‹¨ + ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©í‘œë¥¼ ì„¸ì›Œë³´ì„¸ìš”!
      </div>`;
      return;
    }

    bigGoals.forEach(bg => {
      // ì¹´ë“œ ìƒì„±
      const card = document.createElement('div');
      card.className = "goal-card";
      
      const header = document.createElement('div');
      header.className = "goal-card-header";
      header.innerHTML = `
        <div class="goal-card-title">${bg['ì œëª©']}</div>
        <div class="goal-card-status">${bg['ìƒíƒœ']}</div>
      `;
      card.appendChild(header);

      const body = document.createElement('div');
      body.className = "goal-body";

      // ì¤‘ê°„ ëª©í‘œ ì°¾ê¸°
      const midGoals = g_goals.filter(m => m['ìƒìœ„ID'] === bg.ID);
      
      if(midGoals.length === 0) {
        body.innerHTML = `<div style="padding:20px 0; font-size:0.9rem; color:#999; text-align:center;">í•˜ìœ„ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      } else {
        midGoals.forEach(mg => {
          const midGroup = document.createElement('div');
          midGroup.className = "mid-goal-group";
          
          const midItem = document.createElement('div');
          midItem.className = "mid-goal-item";

          // ì¤‘ê°„ ëª©í‘œ í—¤ë”
          midItem.innerHTML = `
            <div class="mid-goal-header" onclick="toggleDisplay(this)">
               <span style="display:flex; align-items:center; gap:8px;">
                 <span style="font-size:1.1rem;">ğŸš©</span> ${mg['ì œëª©']}
               </span>
               <span style="font-size:0.8rem; color:#888;">â–¼</span>
            </div>
          `;

          // í•  ì¼ ëª©ë¡ (Task List)
          const taskList = document.createElement('div');
          taskList.className = "task-list";
          // taskList.style.display = "none"; // ê¸°ë³¸ í¼ì¹¨ ìƒíƒœ (ì›í•˜ë©´ ì£¼ì„ í•´ì œí•˜ì—¬ ì ‘ìŒ)

          // ì´ ì¤‘ê°„ ëª©í‘œì— ì—°ê²°ëœ í•  ì¼ë“¤
          const tasks = g_tasks.filter(t => String(t['ì—°ê²°_ì¤‘ê°„ëª©í‘œID']||"").includes(mg.ID));
          
          if(tasks.length === 0) {
             taskList.innerHTML = `<div style="padding:15px; font-size:0.85rem; color:#aaa;">ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
          } else {
             tasks.forEach(t => {
               const row = document.createElement('div');
               row.className = "task-row";
               const isDone = t['ìƒíƒœ'] === 'ì™„ë£Œ';
               
               row.innerHTML = `
                 <div class="check-circle ${isDone?'checked':''}" 
                      onclick="toggleTaskStatus('${t.ID}', '${isDone?'ëŒ€ê¸°':'ì™„ë£Œ'}')"
                      title="${isDone?'ì™„ë£Œ ì·¨ì†Œ':'ì™„ë£Œí•˜ê¸°'}"></div>
                 <div style="flex:1; line-height:1.4;">
                   <div style="text-decoration:${isDone?'line-through':''}; color:${isDone?'#9ca3af':'#374151'}; font-weight:500;">
                     ${t['ì œëª©']} ${t['ìš°ì„ ìˆœìœ„'] === 'ë†’ìŒ' ? 'ğŸ”¥' : ''}
                   </div>
                   ${t['ê¸°í•œ'] ? `<div style="font-size:0.75rem; color:#9ca3af; margin-top:2px;">ğŸ“… ${t['ê¸°í•œ'].slice(5)} ë§ˆê°</div>` : ''}
                 </div>
               `;
               taskList.appendChild(row);
             });
          }

          midItem.appendChild(taskList);
          midGroup.appendChild(midItem);
          body.appendChild(midGroup);
        });
      }

      card.appendChild(body);
      root.appendChild(card);
    });
  }

  // ===========================================
  // ë Œë”ë§ ë¡œì§: ë¡œê·¸ íƒ€ì„ë¼ì¸ (ì œëª©/ë‚ ì§œ ì²˜ë¦¬)
  // ===========================================
  function renderLogs() {
    const root = document.getElementById('log-timeline-root');
    root.innerHTML = "";
    
    if(g_logs.length === 0) {
      root.innerHTML = `<div style="color:#999; font-size:0.9rem; padding:10px;">
        ì•„ì§ ì‘ì„±ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì˜¤ëŠ˜ì˜ ì‘ì—…ì„ ê¸°ë¡í•´ ë³´ì„¸ìš”!
      </div>`;
      return;
    }

    // ìµœê·¼ 20ê°œë§Œ í‘œì‹œ
    g_logs.slice(0, 20).forEach(log => {
      const item = document.createElement('div');
      item.className = "timeline-item";
      
      const dateStr = log['ë‚ ì§œ'] ? log['ë‚ ì§œ'].split('T')[0] : '';
      const title = log['ì œëª©'] || ""; // ì œëª© ì—†ì„ ìˆ˜ ìˆìŒ
      
      // í—¤ë” êµ¬ì„±: ì œëª©ì´ ìˆìœ¼ë©´ í¬ê²Œ, ì—†ìœ¼ë©´ ë‚ ì§œë¥¼ ê°•ì¡°
      let headerHtml = "";
      if (title) {
        // ì œëª©ì´ ìˆëŠ” ê²½ìš°
        headerHtml = `
          <div class="timeline-date">${dateStr}</div>
          <div class="timeline-title">${title} ${log['ì†Œìš”ì‹œê°„'] ? `<span style="font-size:0.8rem; color:#999; font-weight:normal;">(${log['ì†Œìš”ì‹œê°„']})</span>` : ''}</div>
        `;
      } else {
        // ì œëª©ì´ ì—†ëŠ” ê²½ìš° (ë‚ ì§œê°€ ì œëª© ì—­í• )
        headerHtml = `
          <div class="timeline-title" style="font-size:0.95rem;">${dateStr} ê¸°ë¡ ${log['ì†Œìš”ì‹œê°„'] ? `<span style="font-size:0.8rem; color:#999; font-weight:normal;">(${log['ì†Œìš”ì‹œê°„']})</span>` : ''}</div>
        `;
      }

      item.innerHTML = `
        <div class="timeline-dot"></div>
        <div class="timeline-header">${headerHtml}</div>
        <div class="timeline-content">
          ${log['ë‚´ìš©']}
          ${log['íƒœê·¸'] ? `<div><span class="timeline-tag">${log['íƒœê·¸']}</span></div>` : ''}
        </div>
      `;
      root.appendChild(item);
    });
  }

  // ===========================================
  // UI í•¸ë“¤ëŸ¬
  // ===========================================
  
  // ìš”ì†Œ ì ‘ê¸°/í¼ì¹˜ê¸° (Next Sibling íƒ€ê²Ÿ)
  function toggleDisplay(el) {
    const next = el.nextElementSibling;
    if(next) {
      next.style.display = (next.style.display === "none") ? "block" : "none";
    }
  }

  // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  function openLogModal() {
    document.getElementById('log-modal').classList.add('open');
    document.getElementById('log-date').valueAsDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸
  }
  function openModal(type) {
    document.getElementById('input-modal').classList.add('open');
    if(type) document.querySelector(`input[name="type"][value="${type}"]`).click();
  }
  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
    // í¼ ë¦¬ì…‹ì€ ì„ íƒì‚¬í•­
  }

  // ëª©í‘œ/í• ì¼ í¼ í† ê¸€ (ìœ í˜•ì— ë”°ë¼ í•„ë“œ ìˆ¨ê¹€/í‘œì‹œ)
  function toggleFormFields() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const isGoal = type.includes("ëª©í‘œ"); // í° ëª©í‘œ, ì¤‘ê°„ ëª©í‘œ
    
    // ëª©í‘œì¸ ê²½ìš°: ê¸°í•œ, ìƒì„¸ë‚´ìš© ìˆ¨ê¹€ (í•„ìš”í•˜ë©´ ì¼œë„ ë¨)
    document.getElementById('field-date').style.display = isGoal ? "none" : "block";
    document.getElementById('field-detail').style.display = isGoal ? "none" : "block";
    
    // ë¶€ëª¨ ì—°ê²° ì˜µì…˜ ì—…ë°ì´íŠ¸
    updateParentOptions(type);
  }

  // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì˜µì…˜ ê°±ì‹ 
  function updateParentOptions(type) {
    const select = document.getElementById('input-connected-id');
    select.innerHTML = '<option value="">(ì„ íƒ ì—†ìŒ)</option>';
    
    let opts = [];
    // í• ì¼/ì•„ì´ë””ì–´ -> ì¤‘ê°„ ëª©í‘œì— ì—°ê²°
    if(!type || type==='í• ì¼' || type==='ì•„ì´ë””ì–´') {
      opts = g_goals.filter(g => g['ìœ í˜•'] === 'ì¤‘ê°„ ëª©í‘œ');
      document.getElementById('field-parent').style.display = "block";
    }
    // ì¤‘ê°„ ëª©í‘œ -> í° ëª©í‘œì— ì—°ê²°
    else if(type==='ì¤‘ê°„ ëª©í‘œ') {
      opts = g_goals.filter(g => g['ìœ í˜•'] === 'í° ëª©í‘œ');
      document.getElementById('field-parent').style.display = "block";
    }
    // í° ëª©í‘œ -> ìƒìœ„ ì—†ìŒ
    else if(type==='í° ëª©í‘œ') {
      document.getElementById('field-parent').style.display = "none";
    }

    opts.forEach(o => {
      const op = document.createElement('option');
      op.value = o.ID;
      op.textContent = o['ì œëª©'];
      select.appendChild(op);
    });
  }

  // í•  ì¼ ì™„ë£Œ ìƒíƒœ ë³€ê²½
  async function toggleTaskStatus(id, newStatus) {
    if(!confirm(`ìƒíƒœë¥¼ '${newStatus}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    if(typeof showAdminLoading === 'function') showAdminLoading("ìƒíƒœ ë³€ê²½ ì¤‘...");
    
    try {
      await fetch(window.CHEESE_ADMIN_API_BASE, {
        method: "POST",
        body: JSON.stringify({
          mode: "updateStatus",
          id: id,
          status: newStatus
        })
      });
      loadAllData(); // ìƒˆë¡œê³ ì¹¨
    } catch(e) {
      alert("ë³€ê²½ ì‹¤íŒ¨");
    } finally {
      if(typeof hideAdminLoading === 'function') hideAdminLoading();
    }
  }

  // ===========================================
  // í¼ ì œì¶œ (ë°ì´í„° ì €ì¥)
  // ===========================================

  // 1. í•  ì¼ / ëª©í‘œ ë“±ë¡
  document.getElementById('todo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const type = document.querySelector('input[name="type"]:checked').value;
    const parentId = document.getElementById('input-connected-id').value;
    
    const payload = {
        mode: "addItem",
        type: type,
        title: document.getElementById('input-title').value,
        parentId: parentId,     // ëª©í‘œì¼ ë•Œ ì‚¬ìš©
        connectedId: parentId,  // í• ì¼ì¼ ë•Œ ì‚¬ìš©
        detail: document.getElementById('input-detail').value,
        dueDate: document.getElementById('input-due').value
    };

    if(typeof showAdminLoading === 'function') showAdminLoading("ì €ì¥ ì¤‘...");
    await fetch(window.CHEESE_ADMIN_API_BASE, { method: "POST", body: JSON.stringify(payload) });
    closeModal('input-modal');
    loadAllData();
    if(typeof hideAdminLoading === 'function') hideAdminLoading();
  });

  // 2. ë¡œê·¸ ì €ì¥ (+ ì•„ì´ë””ì–´ ë™ì‹œ ë“±ë¡)
  document.getElementById('log-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const dateVal = document.getElementById('log-date').value;
    const logTitle = document.getElementById('log-title').value;
    const contentVal = document.getElementById('log-content').value;
    const ideaVal = document.getElementById('log-idea-input').value; // ì•„ì´ë””ì–´ ê°’
    
    if(typeof showAdminLoading === 'function') showAdminLoading("ê¸°ë¡ ì €ì¥ ì¤‘...");

    try {
      const requests = [];

      // [ìš”ì²­ A] ì‘ì—… ë¡œê·¸ ì €ì¥
      requests.push(fetch(window.CHEESE_ADMIN_API_BASE, {
        method: "POST",
        body: JSON.stringify({
          mode: "addLog",
          date: dateVal,
          title: logTitle,
          content: contentVal,
          duration: document.getElementById('log-duration').value,
          tags: document.getElementById('log-tags').value
        })
      }));

      // [ìš”ì²­ B] ì•„ì´ë””ì–´ ìë™ ë“±ë¡ (ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ)
      if (ideaVal.trim() !== "") {
        requests.push(fetch(window.CHEESE_ADMIN_API_BASE, {
          method: "POST",
          body: JSON.stringify({
            mode: "addItem",
            type: "ì•„ì´ë””ì–´",
            title: ideaVal,
            detail: "ì‘ì—… ë³´ê³  ì¤‘ íŒŒìƒë¨: " + (logTitle || contentVal.slice(0, 20) + "..."),
            priority: "ë³´í†µ",
            parentId: "", connectedId: ""
          })
        }));
      }

      await Promise.all(requests); // ë™ì‹œ ì‹¤í–‰

      closeModal('log-modal');
      document.getElementById('log-form').reset(); // ì´ˆê¸°í™”
      loadAllData();
      
      if(ideaVal.trim() !== "") alert("âœ… ë¡œê·¸ì™€ ì•„ì´ë””ì–´ê°€ í•¨ê»˜ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");

    } catch(err) {
      console.error(err);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    } finally {
      if(typeof hideAdminLoading === 'function') hideAdminLoading();
    }
  });

</script>
</body>
</html>
